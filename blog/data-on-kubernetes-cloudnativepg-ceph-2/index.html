<!DOCTYPE html><html lang="en" class="blogpost-view-page"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="description" property="og:description" content="EKS, Databases, Cloud Native DB, CloudNative-PG, PostgreSQL, Ceph Rook"/><meta data-react-helmet="true" name="keywords" content="Ceph Rook,Kubernetes,PostgreSQL,AWS EKS,CloudNative-PG"/><meta data-react-helmet="true" name="author" content="@RajhiSaifeddine"/><meta data-react-helmet="true" property="og:title" content="Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS - Blog"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="@RajhiSaifeddine"/><meta data-react-helmet="true" name="twitter:title" content="Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS - Blog"/><meta data-react-helmet="true" name="twitter:description" content="EKS, Databases, Cloud Native DB, CloudNative-PG, PostgreSQL, Ceph Rook"/><meta data-react-helmet="true" name="image" property="og:image" content="https://seifrajhi.github.io/static/03e3b164103eddf566043988de083244/e5567/dok2.png"/><meta data-react-helmet="true" name="twitter:image" content="https://seifrajhi.github.io/static/03e3b164103eddf566043988de083244/e5567/dok2.png"/><meta data-react-helmet="true" property="og:url" content="https://seifrajhi.github.io/blog/data-on-kubernetes-cloudnativepg-ceph-2/"/><meta name="theme-color" content="#ffffff"/><link rel="stylesheet" href="/styles.19780313cdbeec1e4ef5.css"/><link rel="stylesheet"/><link rel="alternate" type="application/rss+xml" title="Saifeddine Rajhi&#x27;s Blog RSS Feed" href="/rss.xml"/><title data-react-helmet="true">Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS - Blog by Saifeddine Rajhi</title><script data-react-helmet="true" type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","image":"/static/03e3b164103eddf566043988de083244/e5567/dok2.png","headline":"Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS","dateCreated":"2024-10-25","datePublished":"2024-10-25","dateModified":"2024-10-25","inLanguage":"en-US","isFamilyFriendly":true,"isAccessibleForFree":true,"author":{"@type":"Person","name":"Saifeddine Rajhi","url":"https://seifrajhi.github.io"},"publisher":{"@type":"Organization","name":"Saifeddine Rajhi's Website"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://seifrajhi.github.io/blog/data-on-kubernetes-cloudnativepg-ceph-2/"},"keywords":["Ceph Rook","Kubernetes","PostgreSQL","AWS EKS","CloudNative-PG"],"genre":["Platform engineer","software engineering","science","deep learning","statistics"],"articleSection":"Technical Blog","articleBody":"\n> **Data persistence: running PostgreSQL on Amazon¬†EKS**\n\n## üéÜ Introduction\n\n[PostgreSQL](https://www.postgresql.org/), the well-known open-source [relational database](https://en.wikipedia.org/wiki/Relational_database), is a popular choice for applications demanding scalability, reliability, and ease of management.\n\nBut how can we deploy and run PostgreSQL in a Kubernetes environment to handle the stored data? ü§î\n\nIn this blog post, we'll explore how to combine [CloudNative-PG](https://github.com/cloudnative-pg/cloudnative-pg) (a PostgreSQL operator) and [Ceph Rook](https://rook.io/) (a storage orchestrator) to create a PostgreSQL cluster that scales easily, recovers from failures, and ensures data persistence‚Ää‚Äî‚Ääall within an [Amazon Elastic Kubernetes Service EKS cluster](https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html).\n\n## üí• Databases on K8S/EKS\n\nRunning databases and query engines on Kubernetes can offer benefits, but it's important to consider the trade-offs.\n\n### ‚òëÔ∏è Benefits of Running Databases on Kubernetes\n\n- **Automated deployment**: Kubernetes simplifies deploying databases by automating the process and it aligns with DevOps practices and infrastructure as code.\n- **Scaling**: Kubernetes allows automatic scaling based on workload demands.\n- **Rolling updates**: It supports seamless updates without downtime.\n- **Self-healing**: Kubernetes ensures high availability by automatically recovering from failures.\n- **Portability**: Kubernetes provides a consistent environment across different clusters and cloud providers.\n- **Cost-effectiveness**: Kubernetes optimizes resource utilization.\n\n### ‚òëÔ∏è Challenges and Considerations\n\n- **Statefulness**: Databases are stateful, and managing state in a transient environment (like Kubernetes pods) can be complex.\n- **Transient pods**: Pods can restart or fail over, affecting database availability.\n- **Abstractions**: Containerization introduces abstractions that impact database-specific tasks (e.g., backups, scaling).\n- **DIY on VM**: Full control but more operational overhead.\n- [Kubernetes: Closer to full control, but still requires careful planning](https://cloud.google.com/blog/products/databases/to-run-or-not-to-run-a-database-on-kubernetes-what-to-consider).\n\n### ‚òëÔ∏è Popular Databases on Kubernetes\n\n- **Apache Cassandra**: Scalable, distributed NoSQL database.\n- **PostgreSQL**: Supports Kubernetes through operators (e.g., cnpg).\n- **MySQL, MongoDB, and others**.\n\n> [Many teams successfully run databases on Kubernetes in production, but it requires thoughtful planning and understanding of trade-offs](https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes).\n\n## üöÄ Deploying CloudNative-PG with Ceph Rook on AWS EKS\n\n**CloudNativePG** is an open-source [Level 5 operator](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/) designed to manage PostgreSQL workloads on any Kubernetes cluster. It simplifies the deployment, management, and recovery of PostgreSQL instances within Kubernetes. Here are some key features:\n\n- **High availability**: CloudNativePG covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication.\n- **Automated failover**: It automates tasks that a human operator would perform, including failover.\n- **Data persistence**: Unlike relying on stateful sets, CloudNativePG manages persistent volume claims for storing PGDATA.\n- **Declarative configuration**: It directly integrates with the Kubernetes API server, eliminating the need for an external failover management tool.\n- **Cloud Native**: Built on DevOps concepts like immutable infrastructure and declarative configuration, it leverages Kubernetes for self-healing, high availability, and more.\n- **Security & TLS**: Supports security contexts, encrypted TLS connections, and client authentication.\n- **Monitoring**: Includes a Prometheus exporter for metrics and transparent log integration.\n- **Advanced architectures**: Extend the architecture with PgBouncer or create disaster recovery clusters.\n\n> CloudNativePG was originally developed by [EDB](https://www.enterprisedb.com/), released under the Apache License 2.0, and submitted to CNCF Sandbox in April 2022.\n\n**Rook** is an open-source cloud-native storage orchestrator designed for Kubernetes. Its purpose is to provide a platform, framework, and support for [Ceph storage](https://docs.ceph.com/en/latest/rados/) to seamlessly integrate with Kubernetes. Here are some key points about Rook:\n\n- **Ceph integration**: Rook enables Ceph, a distributed storage system that offers file, block, and object storage, to be deployed and managed within Kubernetes clusters.\n- **Automation and management**: Rook automates the deployment, configuration, provisioning, scaling, upgrading, and monitoring of Ceph. It ensures self-managing, self-scaling, and self-healing storage services.\n- **Stability and compatibility**: The status of the Ceph storage provider in Rook is stable. Upgrades between versions maintain backward compatibility.\n- **CNCF project**: Rook is hosted by the Cloud Native Computing Foundation (CNCF) as a graduated-level project.\n\nNow let's start the deployment process.\n\n##  Hands-on Demo\n\nFirst, you can get the code and clone the repo:\n\n```shell\ngit clone git@github.com:seifrajhi/data-on-eks.git\n```\n\nAfter that, run the `deploy.sh` script which deploys an **EKS cluster** to the `eu-west-1` region.\n\n```shell\ncd distributed-databases/cloudnative-postgres/\n\nchmod +x install.sh\n\n./install.sh\n```\n\nOnce the script ends, you can run the below command to update the local kubeconfig so we can access the Kubernetes cluster:\n\n```shell\naws eks update-kubeconfig --name cnpg-on-eks --region eu-west-1\n```\n\nNext, you can verify if all the pods are running:\n\n```shell\nkubectl get pods -n=cnpg-system\nNAME                                          READY   STATUS    RESTARTS   AGE\ncnpg-on-eks-cloudnative-pg-412d5a5fd8-amuz   1/1     Running   0          11m\n```\n\n### üèóÔ∏è Setup Rook for Storage\n\nRook has published the following Helm charts for the Ceph storage provider:\n\n- [Rook Ceph Operator](https://rook.io/docs/rook/latest-release/Helm-Charts/operator-chart/): Starts the Ceph Operator, which will watch for Ceph CRs (custom resources).\n- [Rook Ceph Cluster](https://rook.io/docs/rook/latest-release/Helm-Charts/ceph-cluster-chart/): Creates Ceph CRs that the operator will use to configure the cluster.\n\n#### üì¶ Rook Ceph Operator\n\nInstalls Rook to create, configure, and manage Ceph clusters on Kubernetes.\n\nThis chart bootstraps a [rook-ceph-operator](https://github.com/rook/rook) deployment on a Kubernetes cluster using the Helm package manager.\n\n```shell\nhelm repo add rook-release https://charts.rook.io/release\nhelm install --create-namespace --namespace rook-ceph rook-ceph rook-release/rook-ceph -f values.yaml\n```\n\nFor customized settings, you can check the [values.yaml](https://github.com/rook/rook/tree/release-1.14/deploy/charts/rook-ceph/values.yaml) file.\n\n#### üèóÔ∏è Ceph Cluster\n\nCreates Rook resources to configure a Ceph cluster using the Helm package manager.\n\nBefore installing, review the `values.yaml` to confirm if the default settings need to be updated.\n\n- If the operator was installed in a namespace other than `rook-ceph`, the namespace must be set in the `operatorNamespace` variable.\n- Set the desired settings in the `cephClusterSpec`. [The defaults](https://github.com/rook/rook/tree/release-1.14/deploy/charts/rook-ceph-cluster/values.yaml) are only an example and not likely to apply to your cluster.\n- The monitoring section should be removed from the `cephClusterSpec`, as it is specified separately in the Helm settings.\n- The default values for `cephBlockPools`, `cephFileSystems`, and `CephObjectStores` will create one of each, and their corresponding storage classes.\n\nAll Ceph components now have default values for the pod resources. The resources may need to be adjusted in production clusters depending on the load. The resources can also be disabled if Ceph should not be limited (e.g., test clusters).\n\nThe below command assumes you have first created a customized `values.yaml` file:\n\n```shell\nhelm install --create-namespace --namespace rook-ceph rook-ceph-cluster \\\n    --set operatorNamespace=rook-ceph rook-release/rook-ceph-cluster -f values.yaml\n```\n\n#### üì¶ Provision Storage\n\nBefore Rook can provision storage, a [StorageClass](https://kubernetes.io/docs/concepts/storage/storage-classes) and [CephBlockPool](https://rook.io/docs/rook/latest-release/CRDs/Block-Storage/ceph-block-pool-crd/) CR need to be created. This will allow Kubernetes to interoperate with Rook when provisioning persistent volumes.\n\nSave this StorageClass definition as **storageclass.yaml**:\n\n```yaml\n---\napiVersion: ceph.rook.io/v1\nkind: CephBlockPool\nmetadata:\n  name: replicapool\n  namespace: rook-ceph # namespace:cluster\nspec:\n  failureDomain: host\n  replicated:\n    size: 3\n    requireSafeReplicaSize: true\n---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: rook-ceph-block\nprovisioner: rook-ceph.rbd.csi.ceph.com # csi-provisioner-name\nparameters:\n  clusterID: rook-ceph \n  pool: replicapool\n  imageFormat: \"2\"\n  imageFeatures: layering\n  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner\n  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph # namespace:cluster\n  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner\n  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph # namespace:cluster\n  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node\n  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph # namespace:cluster\n  csi.storage.k8s.io/fstype: ext4\nallowVolumeExpansion: true\nreclaimPolicy: Delete\n```\n\nThen apply it\n\n```shell\nkubectl apply -f storageclass.yaml\n```\n### üöÄ Deploy a PostgreSQL Cluster\n\nAs with any other deployment in Kubernetes, to deploy a PostgreSQL cluster you need to apply a configuration file that defines your desired Cluster. The CloudNativePG operator offers two types of bootstrapping a new database:\n\n1. **Bootstrap an empty cluster**\n2. **Bootstrap from another cluster**\n\nIn this demo, we are going to create a new empty database cluster using `initdb` flags. We will use the template below by modifying the IAM role for IRSA configuration and the S3 bucket for the backup restore process and WAL archiving.\n\nThe Terraform script has already created these resources. Use the Terraform output to extract these parameters:\n\n```shell\nterraform output\ndemo_backup_irsa = \"arn:aws:iam::<your_account_id>:role/cnpg-on-eks-prod-irsa\"\ndemo_s3_bucket = \"xyz-cnpg-demo-bucket\"\nconfigure_kubectl = \"aws eks --region eu-west-1 update-kubeconfig --name cnpg-on-eks\"\n```\n\n- **IRSA Configuration**: `arn:aws:iam::<your_account_id>:role/cnpg-on-eks-prod-irsa`\n- **S3 Bucket**: `xyz-cnpg-demo-bucket`\n\nFor more information on configuring IAM roles for service accounts (IRSA), refer to the [AWS documentation](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html).\n\nFor details on setting up S3 buckets for backups, check the [AWS S3 documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html).\n\nNow, we are ready to deploy a CloudNativePG database cluster.\n\n**demo-cnpg-cluster.yaml**:\n\n```yaml\napiVersion: postgresql.cnpg.io/v1\nkind: Cluster\nmetadata:\n  name: demo-cnpg\n  namespace: demo\nspec:\n  description: \"Cluster Demo for DoEKS\"\n  # Choose your PostGres Database Version\n  imageName: ghcr.io/cloudnative-pg/postgresql:15.2\n  # Number of Replicas\n  instances: 3\n  startDelay: 300\n  stopDelay: 300\n  replicationSlots:\n    highAvailability:\n      enabled: true\n    updateInterval: 300\n  primaryUpdateStrategy: unsupervised\n  serviceAccountTemplate:\n    # For backup and restore, we use IRSA for demo tool.\n    # You will find this IAM role on terraform outputs.\n    metadata:\n      annotations:\n        eks.amazonaws.com/role-arn: arn:aws:iam::<<account_id>>:role/cnpg-on-eks-prod-irsa #1\n  postgresql:\n    parameters:\n      shared_buffers: 256MB\n      pg_stat_statements.max: '10000'\n      pg_stat_statements.track: all\n      auto_explain.log_min_duration: '10s'\n    pg_hba:\n      # - hostssl app all all cert\n      - host app app all password\n  logLevel: debug\n  storage:\n    storageClass: rook-ceph-block\n    size: 1Gi\n  walStorage:\n    storageClass: rook-ceph-block\n    size: 1Gi\n  monitoring:\n    enablePodMonitor: true\n  bootstrap:\n    initdb: # Deploying a new cluster\n      database: WorldDB\n      owner: app\n      secret:\n        name: app-auth\n  backup:\n    barmanObjectStore:\n    # For backup, we S3 bucket to store data.\n    # On this Blueprint, we create an S3 check the terraform output for it.\n      destinationPath: s3://<your-s3-demo-bucket> #2\n      s3Credentials:\n        inheritFromIAMRole: true\n      wal:\n        compression: gzip\n        maxParallel: 8\n    retentionPolicy: \"30d\"\n\n  resources: # m5large: m5xlarge 2vCPU, 8GI RAM\n    requests:\n      memory: \"512Mi\"\n      cpu: \"1\"\n    limits:\n      memory: \"1Gi\"\n      cpu: \"2\"\n\n  affinity:\n    enablePodAntiAffinity: true\n    topologyKey: failure-domain.beta.kubernetes.io/zone\n\n  nodeMaintenanceWindow:\n    inProgress: false\n    reusePVC: false\n```\n\nOnce updated, you can apply your template.\n\n```shell\nkubectl apply -f demo-cnpg-cluster.yaml\n```\n\nNow you can check Cluster status is by using cloudnative-pg kubectl plugin offered by the CloudNativePG community.\n\n```shell\n$ kubectl cnpg status demo-cnpg\nCluster Summary\nName:               demo-cnpg\nNamespace:          demo\nSystem ID:          7214866198623563798\nPostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:15.2\nPrimary instance:   demo-cnpg-1\nStatus:             Cluster in healthy state\nInstances:          3\nReady instances:    3\nCurrent Write LSN:  0/6000000 (Timeline: 1 - WAL File: 000000010000000000000005)\nCertificates Status\nCertificate Name  Expiration Date                Days Left Until Expiration\n----------------  ---------------                --------------------------\ndemo-cnpg-ca           2024-07-14 14:40:27 +0000 UTC  89.96\ndemo-cnpg-replication  2024-07-14 14:40:27 +0000 UTC  89.96\ndemo-cnpg-server       2024-07-14 14:40:27 +0000 UTC  89.96\n\nContinuous Backup status\nFirst Point of Recoverability:  Not Available\nWorking WAL archiving:          OK\nWALs waiting to be archived:    0\nLast Archived WAL:              000000010000000000000005   @   2024-07-01T14:52:09.24307Z\nLast Failed WAL:                -\n\nStreaming Replication status\nReplication Slots Enabled\nName    Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag  Flush Lag  Replay Lag  State      Sync State  Sync Priority  Replication Slot\n----    --------   ---------  ---------  ----------  ---------  ---------  ----------  -----      ----------  -------------  ----------------\ndemo-cnpg-2  0/6000000  0/6000000  0/6000000  0/6000000   00:00:00   00:00:00   00:00:00    streaming  async       0              active\ndemo-cnpg-3  0/6000000  0/6000000  0/6000000  0/6000000   00:00:00   00:00:00   00:00:00    streaming  async       0              active\n\nUnmanaged Replication Slot Status\nNo unmanaged replication slots found\n\nInstances status\nName    Database Size  Current LSN  Replication role  Status  QoS         Manager Version  Node\n----    -------------  -----------  ----------------  ------  ---         ---------------  ----\ndemo-cnpg-1  29 MB          0/6000000    Primary           OK      BestEffort  1.19.0           ip-10-1-10-111.eu-west-1.compute.internal\ndemo-cnpg-2  29 MB          0/6000000    Standby (async)   OK      BestEffort  1.19.0           ip-10-1-12-144.eu-west-1.compute.internal\ndemo-cnpg-3  29 MB          0/6000000    Standby (async)   OK      BestEffort  1.19.0           ip-10-1-11-78.eu-west-1.compute.internal\n```\n\nAnd there are more to discover like backup, monitoring, etc.\n\n## Key takeaways\n\nWhen running PostgreSQL on Amazon EKS, it's important to ensure data persistence in Kubernetes. Tools like CloudNativePG help manage highly available PostgreSQL clusters with native streaming replication, ensuring data durability and seamless failover.\n\n**Stay tuned for next blogs in this¬†seriesüéâ**\n\n**References:**\n\n- https://dok.community/blog/the-future-of-data-on-kubernetes\n- https://www.reddit.com/r/kubernetes/comments/1dp062w/are_you_running_stateful_data_workloads_or/?sort=old\n- https://www.youtube.com/watch?v=99uSJXkKpeI\n- https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres\n- https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes\n- https://rook.io/docs/rook/latest-release/Getting-Started/intro/\n- https://cloudnative-pg.io/documentation/1.22/\n\n**Thank You üñ§**\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordcount":1256}</script><script data-react-helmet="true" type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://seifrajhi.github.io/"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://seifrajhi.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS","item":"https://seifrajhi.github.io/blog/data-on-kubernetes-cloudnativepg-ceph-2/"}]}</script><link crossorigin="" href="https://utteranc.es" rel="preconnect"/><link crossorigin="" href="https://www.google-analytics.com" rel="preconnect"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=47ae28bb567c9025f1fee24afb2d20c9" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup8.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7B1i03Sup8.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/ledger/v16/j8_q6-HK1L3if_sBnMrx.woff2"/><style>@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:400;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup8.woff2) format("woff2")}@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:700;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7B1i03Sup8.woff2) format("woff2")}@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:400;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup6.woff) format("woff")}@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:700;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7B1i03Sup6.woff) format("woff")}@font-face{font-display:swap;font-family:Ledger;font-style:normal;font-weight:400;src:url(/static/webfonts/s/ledger/v16/j8_q6-HK1L3if_sBnMrx.woff2) format("woff2")}@font-face{font-display:swap;font-family:Ledger;font-style:normal;font-weight:400;src:url(/static/webfonts/s/ledger/v16/j8_q6-HK1L3if_sBnMr3.woff) format("woff")}</style><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-LLPCCGNLH7',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'G-LLPCCGNLH7', 'auto', {"alwaysSendReferrer":true});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LLPCCGNLH7"></script><script>
      
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-LLPCCGNLH7',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-LLPCCGNLH7', {"anonymize_ip":true,"send_page_view":false});gtag('config', 'GTM-5V895PDS', {"anonymize_ip":true,"send_page_view":false});
      }
      </script><link rel="stylesheet"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://seifrajhi.github.io/blog/data-on-kubernetes-cloudnativepg-ceph-2/" data-baseprotocol="https:" data-basehost="seifrajhi.github.io"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="blogpost-header"><div class="view-page-header"><div class="view-page-header-wrapper"><div class="logo-wrapper"><div class="logo"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained logo-img"><div style="max-width:150px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg%20height=&#x27;174&#x27;%20width=&#x27;150&#x27;%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/avif" data-srcset="/static/a1a51351bdf7de55eaaa515eb15ce2da/2e0ee/saifeddine-rajhi.avif 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/81dba/saifeddine-rajhi.avif 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/20c67/saifeddine-rajhi.avif 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/94b9f/saifeddine-rajhi.avif 300w" sizes="(min-width: 150px) 150px, 100vw"/><source type="image/webp" data-srcset="/static/a1a51351bdf7de55eaaa515eb15ce2da/92aab/saifeddine-rajhi.webp 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/359cc/saifeddine-rajhi.webp 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/aac41/saifeddine-rajhi.webp 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/a15c6/saifeddine-rajhi.webp 300w" sizes="(min-width: 150px) 150px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 150px) 150px, 100vw" decoding="async" loading="lazy" data-src="/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png" data-srcset="/static/a1a51351bdf7de55eaaa515eb15ce2da/9c61d/saifeddine-rajhi.png 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/d405f/saifeddine-rajhi.png 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/4aeea/saifeddine-rajhi.png 300w" alt="Saifeddine Rajhi"/></picture><noscript><picture><source type="image/avif" srcSet="/static/a1a51351bdf7de55eaaa515eb15ce2da/2e0ee/saifeddine-rajhi.avif 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/81dba/saifeddine-rajhi.avif 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/20c67/saifeddine-rajhi.avif 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/94b9f/saifeddine-rajhi.avif 300w" sizes="(min-width: 150px) 150px, 100vw"/><source type="image/webp" srcSet="/static/a1a51351bdf7de55eaaa515eb15ce2da/92aab/saifeddine-rajhi.webp 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/359cc/saifeddine-rajhi.webp 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/aac41/saifeddine-rajhi.webp 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/a15c6/saifeddine-rajhi.webp 300w" sizes="(min-width: 150px) 150px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 150px) 150px, 100vw" decoding="async" loading="lazy" src="/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png" srcSet="/static/a1a51351bdf7de55eaaa515eb15ce2da/9c61d/saifeddine-rajhi.png 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/d405f/saifeddine-rajhi.png 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/4aeea/saifeddine-rajhi.png 300w" alt="Saifeddine Rajhi"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div><div class="name"><a href="/blog/" title="back to blog">Saifeddine <br/> Rajhi</a></div></div><h2 class="blog-title"><a href="/blog/" title="back to the homepage">Blog</a></h2></div></div><nav class="main-navigation"><ul><li><a rel="home" title="Go Home" href="/">Home</a></li><li><a title="Go to my Technical Blog" href="/blog/">Blog</a></li><li><a title="Go to my Thoughts" href="/thoughts/">Thoughts</a></li><li><a title="My public talks" href="/talks/">talks</a></li><li><a title="Review My Resume" href="/cv/platform-engineer/">cv</a></li></ul></nav></div><main><article class="blog-wrapper"><header><figure class="cover"><div class="cover-filter"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper cover cover-image"><div aria-hidden="true" style="padding-top:55.375%"></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;object-fit:fill;object-position:center" decoding="async" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC5klEQVR42i2T20/TZxjHe+sf4F/gjUu8MMa4ZBdL9NbEay+MJnLjWKIiBhEHApsFEUTogVPbYS2lLT0xoIMW2pV2gOF8KMeonFRCjbIN29KWfvb0t128eX/vk+/heb/P+1OZJw54ap9AM7BKe3CbtpFtWoc30f6+RnP/irLrBtdpCbyj0TOPIfwBU2SP2u4J9ENvMI5+EM4WttkUtrk0KsdChgqDn3sNdh619vHEEqFGwI+NASo6Bnmg8VL1a5Di5w4e6vuUet4oj6l3zfBYuPlatwja84Km0T2qO4OKUKm2VyHnQaVar3QxTnGjg/KOIZr6llF3hSnVeaixiaFhiF/MISpNw8KN0hrYFMGMCEb2+anNR0mzE2P4vQiGKGly/t+hX6k/sYSptY3JTYYUgZ/NYao6Q0rHRXVdYvKbxLWDfV4EXbEc5okvco012T8rGer9b+kc21dyqxZimRDLWvqlyyUlP+Nofn1UvnWDb2gRvH3u6L8Oe5ay9G3BgKx8nk45O2PH4pbGvYJiovGt0RnZkXNWMFl6FrN4Y1l6BeddzuFcPqZ76RibcFTGkU+UVkeobJ7EOp2USR3hkNWzkMYxf4R7KYNnJUdjKM2r10ncsTTWmRRtr/9BM/4XpumEcJK4/jwQwRSqivpJvjlxm3OnijGE4rjE1TyZpMi6T63vAMt0mkutWW62f+XG/W1e9H/FNHvIVc86hb5NCvy7ROv/YOtiFdGnQVRldVFOnyzk/NkiGt0beFfBOJbgun6XSk+cqkCWKx1Z4h8TdNs/UaiO07WS5AfJ6MeBTUrC+4yrA+xefsaUehjVtQIz587c4cK3t3lmX1Ry64j+TYP/C22jB9QFU3zXlEMXynDXmkLtOqRrIcGt/rdc965THtyjfXibl8YxdL4NVOX6CI+0IR688FNjnZOh5LBMJZSHaplKKTnWjKT5XnfMLbcMLZbBMnmIdmQHXXAXQzROg/xBas8c9Z55/gVW96hTD1rWiwAAAABJRU5ErkJggg==" alt=""/><picture><source type="image/webp" data-srcset="/static/03e3b164103eddf566043988de083244/5436b/dok2.webp 750w,/static/03e3b164103eddf566043988de083244/25d47/dok2.webp 1080w,/static/03e3b164103eddf566043988de083244/906fd/dok2.webp 1366w,/static/03e3b164103eddf566043988de083244/bbc11/dok2.webp 1600w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="object-fit:fill;object-position:center;opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/03e3b164103eddf566043988de083244/e5567/dok2.png" data-srcset="/static/03e3b164103eddf566043988de083244/ba276/dok2.png 750w,/static/03e3b164103eddf566043988de083244/f0fea/dok2.png 1080w,/static/03e3b164103eddf566043988de083244/dc894/dok2.png 1366w,/static/03e3b164103eddf566043988de083244/e5567/dok2.png 1600w" alt="Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS"/></picture><noscript><picture><source type="image/webp" srcSet="/static/03e3b164103eddf566043988de083244/5436b/dok2.webp 750w,/static/03e3b164103eddf566043988de083244/25d47/dok2.webp 1080w,/static/03e3b164103eddf566043988de083244/906fd/dok2.webp 1366w,/static/03e3b164103eddf566043988de083244/bbc11/dok2.webp 1600w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="object-fit:fill;object-position:center;opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/03e3b164103eddf566043988de083244/e5567/dok2.png" srcSet="/static/03e3b164103eddf566043988de083244/ba276/dok2.png 750w,/static/03e3b164103eddf566043988de083244/f0fea/dok2.png 1080w,/static/03e3b164103eddf566043988de083244/dc894/dok2.png 1366w,/static/03e3b164103eddf566043988de083244/e5567/dok2.png 1600w" alt="Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div><figcaption data-nosnippet="" class="image-title">Photo by Saifeddine Rajhi</figcaption></figure><h1>Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS</h1><div data-nosnippet="" class="blog-details"><time class="blog-createdat" dateTime="2024-10-25">Oct 25, 2024</time><span> ‚Ä¢ </span><span class="blog-time2read">9<!-- -->mins<!-- --> read</span><div class="theme-switcher"><div class="theme-switcher-toggler"><div class="theme-switcher-track"></div><div class="theme-switcher-thumb"></div><input class="theme-switcher-input" type="checkbox" readonly="" aria-label="Switch between Dark and Light modes"/></div></div></div><ul data-nosnippet="" class="blog-tags"><li>Ceph Rook</li><li>Kubernetes</li><li>PostgreSQL</li><li>AWS EKS</li><li>CloudNative-PG</li></ul></header><div class="blog-divider"></div><div id="intro"></div><div class="content-wrapper"><div data-nosnippet="" class="blog-content-nav-wrapper"><ul class="blog-content-nav"><h2>Content</h2><ul class="toc-list"></ul></ul></div><div class="content blog-content"><blockquote>
<p><strong>Data persistence: running PostgreSQL on Amazon¬†EKS</strong></p>
</blockquote>
<h2 id="-introduction" style="position:relative;"><a href="#-introduction" aria-label=" introduction permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üéÜ Introduction</h2>
<p><a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL</a>, the well-known open-source <a href="https://en.wikipedia.org/wiki/Relational_database" target="_blank" rel="noopener noreferrer">relational database</a>, is a popular choice for applications demanding scalability, reliability, and ease of management.</p>
<p>But how can we deploy and run PostgreSQL in a Kubernetes environment to handle the stored data? ü§î</p>
<p>In this blog post, we'll explore how to combine <a href="https://github.com/cloudnative-pg/cloudnative-pg" target="_blank" rel="noopener noreferrer">CloudNative-PG</a> (a PostgreSQL operator) and <a href="https://rook.io/" target="_blank" rel="noopener noreferrer">Ceph Rook</a> (a storage orchestrator) to create a PostgreSQL cluster that scales easily, recovers from failures, and ensures data persistence‚Ää‚Äî‚Ääall within an <a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Service EKS cluster</a>.</p>
<h2 id="-databases-on-k8seks" style="position:relative;"><a href="#-databases-on-k8seks" aria-label=" databases on k8seks permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üí• Databases on K8S/EKS</h2>
<p>Running databases and query engines on Kubernetes can offer benefits, but it's important to consider the trade-offs.</p>
<h3 id="Ô∏è-benefits-of-running-databases-on-kubernetes" style="position:relative;"><a href="#%EF%B8%8F-benefits-of-running-databases-on-kubernetes" aria-label="Ô∏è benefits of running databases on kubernetes permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>‚òëÔ∏è Benefits of Running Databases on Kubernetes</h3>
<ul>
<li><strong>Automated deployment</strong>: Kubernetes simplifies deploying databases by automating the process and it aligns with DevOps practices and infrastructure as code.</li>
<li><strong>Scaling</strong>: Kubernetes allows automatic scaling based on workload demands.</li>
<li><strong>Rolling updates</strong>: It supports seamless updates without downtime.</li>
<li><strong>Self-healing</strong>: Kubernetes ensures high availability by automatically recovering from failures.</li>
<li><strong>Portability</strong>: Kubernetes provides a consistent environment across different clusters and cloud providers.</li>
<li><strong>Cost-effectiveness</strong>: Kubernetes optimizes resource utilization.</li>
</ul>
<h3 id="Ô∏è-challenges-and-considerations" style="position:relative;"><a href="#%EF%B8%8F-challenges-and-considerations" aria-label="Ô∏è challenges and considerations permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>‚òëÔ∏è Challenges and Considerations</h3>
<ul>
<li><strong>Statefulness</strong>: Databases are stateful, and managing state in a transient environment (like Kubernetes pods) can be complex.</li>
<li><strong>Transient pods</strong>: Pods can restart or fail over, affecting database availability.</li>
<li><strong>Abstractions</strong>: Containerization introduces abstractions that impact database-specific tasks (e.g., backups, scaling).</li>
<li><strong>DIY on VM</strong>: Full control but more operational overhead.</li>
<li><a href="https://cloud.google.com/blog/products/databases/to-run-or-not-to-run-a-database-on-kubernetes-what-to-consider" target="_blank" rel="noopener noreferrer">Kubernetes: Closer to full control, but still requires careful planning</a>.</li>
</ul>
<h3 id="Ô∏è-popular-databases-on-kubernetes" style="position:relative;"><a href="#%EF%B8%8F-popular-databases-on-kubernetes" aria-label="Ô∏è popular databases on kubernetes permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>‚òëÔ∏è Popular Databases on Kubernetes</h3>
<ul>
<li><strong>Apache Cassandra</strong>: Scalable, distributed NoSQL database.</li>
<li><strong>PostgreSQL</strong>: Supports Kubernetes through operators (e.g., cnpg).</li>
<li><strong>MySQL, MongoDB, and others</strong>.</li>
</ul>
<blockquote>
<p><a href="https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes" target="_blank" rel="noopener noreferrer">Many teams successfully run databases on Kubernetes in production, but it requires thoughtful planning and understanding of trade-offs</a>.</p>
</blockquote>
<h2 id="-deploying-cloudnative-pg-with-ceph-rook-on-aws-eks" style="position:relative;"><a href="#-deploying-cloudnative-pg-with-ceph-rook-on-aws-eks" aria-label=" deploying cloudnative pg with ceph rook on aws eks permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üöÄ Deploying CloudNative-PG with Ceph Rook on AWS EKS</h2>
<p><strong>CloudNativePG</strong> is an open-source <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" target="_blank" rel="noopener noreferrer">Level 5 operator</a> designed to manage PostgreSQL workloads on any Kubernetes cluster. It simplifies the deployment, management, and recovery of PostgreSQL instances within Kubernetes. Here are some key features:</p>
<ul>
<li><strong>High availability</strong>: CloudNativePG covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication.</li>
<li><strong>Automated failover</strong>: It automates tasks that a human operator would perform, including failover.</li>
<li><strong>Data persistence</strong>: Unlike relying on stateful sets, CloudNativePG manages persistent volume claims for storing PGDATA.</li>
<li><strong>Declarative configuration</strong>: It directly integrates with the Kubernetes API server, eliminating the need for an external failover management tool.</li>
<li><strong>Cloud Native</strong>: Built on DevOps concepts like immutable infrastructure and declarative configuration, it leverages Kubernetes for self-healing, high availability, and more.</li>
<li><strong>Security &#x26; TLS</strong>: Supports security contexts, encrypted TLS connections, and client authentication.</li>
<li><strong>Monitoring</strong>: Includes a Prometheus exporter for metrics and transparent log integration.</li>
<li><strong>Advanced architectures</strong>: Extend the architecture with PgBouncer or create disaster recovery clusters.</li>
</ul>
<blockquote>
<p>CloudNativePG was originally developed by <a href="https://www.enterprisedb.com/" target="_blank" rel="noopener noreferrer">EDB</a>, released under the Apache License 2.0, and submitted to CNCF Sandbox in April 2022.</p>
</blockquote>
<p><strong>Rook</strong> is an open-source cloud-native storage orchestrator designed for Kubernetes. Its purpose is to provide a platform, framework, and support for <a href="https://docs.ceph.com/en/latest/rados/" target="_blank" rel="noopener noreferrer">Ceph storage</a> to seamlessly integrate with Kubernetes. Here are some key points about Rook:</p>
<ul>
<li><strong>Ceph integration</strong>: Rook enables Ceph, a distributed storage system that offers file, block, and object storage, to be deployed and managed within Kubernetes clusters.</li>
<li><strong>Automation and management</strong>: Rook automates the deployment, configuration, provisioning, scaling, upgrading, and monitoring of Ceph. It ensures self-managing, self-scaling, and self-healing storage services.</li>
<li><strong>Stability and compatibility</strong>: The status of the Ceph storage provider in Rook is stable. Upgrades between versions maintain backward compatibility.</li>
<li><strong>CNCF project</strong>: Rook is hosted by the Cloud Native Computing Foundation (CNCF) as a graduated-level project.</li>
</ul>
<p>Now let's start the deployment process.</p>
<h2 id="hands-on-demo" style="position:relative;"><a href="#hands-on-demo" aria-label="hands on demo permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Hands-on Demo</h2>
<p>First, you can get the code and clone the repo:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token function">git</span> clone git@github.com:seifrajhi/data-on-eks.git</code></pre></div>
<p>After that, run the <code class="language-text">deploy.sh</code> script which deploys an <strong>EKS cluster</strong> to the <code class="language-text">eu-west-1</code> region.</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">cd</span> distributed-databases/cloudnative-postgres/

<span class="token function">chmod</span> +x install.sh

./install.sh</code></pre></div>
<p>Once the script ends, you can run the below command to update the local kubeconfig so we can access the Kubernetes cluster:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">aws eks update-kubeconfig <span class="token parameter variable">--name</span> cnpg-on-eks <span class="token parameter variable">--region</span> eu-west-1</code></pre></div>
<p>Next, you can verify if all the pods are running:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">kubectl get pods <span class="token parameter variable">-n</span><span class="token operator">=</span>cnpg-system
NAME                                          READY   STATUS    RESTARTS   AGE
cnpg-on-eks-cloudnative-pg-412d5a5fd8-amuz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m</code></pre></div>
<h3 id="Ô∏è-setup-rook-for-storage" style="position:relative;"><a href="#%EF%B8%8F-setup-rook-for-storage" aria-label="Ô∏è setup rook for storage permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üèóÔ∏è Setup Rook for Storage</h3>
<p>Rook has published the following Helm charts for the Ceph storage provider:</p>
<ul>
<li><a href="https://rook.io/docs/rook/latest-release/Helm-Charts/operator-chart/" target="_blank" rel="noopener noreferrer">Rook Ceph Operator</a>: Starts the Ceph Operator, which will watch for Ceph CRs (custom resources).</li>
<li><a href="https://rook.io/docs/rook/latest-release/Helm-Charts/ceph-cluster-chart/" target="_blank" rel="noopener noreferrer">Rook Ceph Cluster</a>: Creates Ceph CRs that the operator will use to configure the cluster.</li>
</ul>
<h4 id="-rook-ceph-operator" style="position:relative;"><a href="#-rook-ceph-operator" aria-label=" rook ceph operator permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üì¶ Rook Ceph Operator</h4>
<p>Installs Rook to create, configure, and manage Ceph clusters on Kubernetes.</p>
<p>This chart bootstraps a <a href="https://github.com/rook/rook" target="_blank" rel="noopener noreferrer">rook-ceph-operator</a> deployment on a Kubernetes cluster using the Helm package manager.</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">helm repo <span class="token function">add</span> rook-release https://charts.rook.io/release
helm <span class="token function">install</span> --create-namespace <span class="token parameter variable">--namespace</span> rook-ceph rook-ceph rook-release/rook-ceph <span class="token parameter variable">-f</span> values.yaml</code></pre></div>
<p>For customized settings, you can check the <a href="https://github.com/rook/rook/tree/release-1.14/deploy/charts/rook-ceph/values.yaml" target="_blank" rel="noopener noreferrer">values.yaml</a> file.</p>
<h4 id="Ô∏è-ceph-cluster" style="position:relative;"><a href="#%EF%B8%8F-ceph-cluster" aria-label="Ô∏è ceph cluster permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üèóÔ∏è Ceph Cluster</h4>
<p>Creates Rook resources to configure a Ceph cluster using the Helm package manager.</p>
<p>Before installing, review the <code class="language-text">values.yaml</code> to confirm if the default settings need to be updated.</p>
<ul>
<li>If the operator was installed in a namespace other than <code class="language-text">rook-ceph</code>, the namespace must be set in the <code class="language-text">operatorNamespace</code> variable.</li>
<li>Set the desired settings in the <code class="language-text">cephClusterSpec</code>. <a href="https://github.com/rook/rook/tree/release-1.14/deploy/charts/rook-ceph-cluster/values.yaml" target="_blank" rel="noopener noreferrer">The defaults</a> are only an example and not likely to apply to your cluster.</li>
<li>The monitoring section should be removed from the <code class="language-text">cephClusterSpec</code>, as it is specified separately in the Helm settings.</li>
<li>The default values for <code class="language-text">cephBlockPools</code>, <code class="language-text">cephFileSystems</code>, and <code class="language-text">CephObjectStores</code> will create one of each, and their corresponding storage classes.</li>
</ul>
<p>All Ceph components now have default values for the pod resources. The resources may need to be adjusted in production clusters depending on the load. The resources can also be disabled if Ceph should not be limited (e.g., test clusters).</p>
<p>The below command assumes you have first created a customized <code class="language-text">values.yaml</code> file:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">helm <span class="token function">install</span> --create-namespace <span class="token parameter variable">--namespace</span> rook-ceph rook-ceph-cluster <span class="token punctuation">\</span>
    <span class="token parameter variable">--set</span> <span class="token assign-left variable">operatorNamespace</span><span class="token operator">=</span>rook-ceph rook-release/rook-ceph-cluster <span class="token parameter variable">-f</span> values.yaml</code></pre></div>
<h4 id="-provision-storage" style="position:relative;"><a href="#-provision-storage" aria-label=" provision storage permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üì¶ Provision Storage</h4>
<p>Before Rook can provision storage, a <a href="https://kubernetes.io/docs/concepts/storage/storage-classes" target="_blank" rel="noopener noreferrer">StorageClass</a> and <a href="https://rook.io/docs/rook/latest-release/CRDs/Block-Storage/ceph-block-pool-crd/" target="_blank" rel="noopener noreferrer">CephBlockPool</a> CR need to be created. This will allow Kubernetes to interoperate with Rook when provisioning persistent volumes.</p>
<p>Save this StorageClass definition as <strong>storageclass.yaml</strong>:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CephBlockPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph <span class="token comment"># namespace:cluster</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">failureDomain</span><span class="token punctuation">:</span> host
  <span class="token key atrule">replicated</span><span class="token punctuation">:</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token key atrule">requireSafeReplicaSize</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com <span class="token comment"># csi-provisioner-name</span>
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterID</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph 
  <span class="token key atrule">pool</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">imageFormat</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
  <span class="token key atrule">imageFeatures</span><span class="token punctuation">:</span> layering
  <span class="token key atrule">csi.storage.k8s.io/provisioner-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">csi.storage.k8s.io/provisioner-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph <span class="token comment"># namespace:cluster</span>
  <span class="token key atrule">csi.storage.k8s.io/controller-expand-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">csi.storage.k8s.io/controller-expand-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph <span class="token comment"># namespace:cluster</span>
  <span class="token key atrule">csi.storage.k8s.io/node-stage-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>node
  <span class="token key atrule">csi.storage.k8s.io/node-stage-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph <span class="token comment"># namespace:cluster</span>
  <span class="token key atrule">csi.storage.k8s.io/fstype</span><span class="token punctuation">:</span> ext4
<span class="token key atrule">allowVolumeExpansion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Delete</code></pre></div>
<p>Then apply it</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">kubectl apply <span class="token parameter variable">-f</span> storageclass.yaml</code></pre></div>
<h3 id="-deploy-a-postgresql-cluster" style="position:relative;"><a href="#-deploy-a-postgresql-cluster" aria-label=" deploy a postgresql cluster permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üöÄ Deploy a PostgreSQL Cluster</h3>
<p>As with any other deployment in Kubernetes, to deploy a PostgreSQL cluster you need to apply a configuration file that defines your desired Cluster. The CloudNativePG operator offers two types of bootstrapping a new database:</p>
<ol>
<li><strong>Bootstrap an empty cluster</strong></li>
<li><strong>Bootstrap from another cluster</strong></li>
</ol>
<p>In this demo, we are going to create a new empty database cluster using <code class="language-text">initdb</code> flags. We will use the template below by modifying the IAM role for IRSA configuration and the S3 bucket for the backup restore process and WAL archiving.</p>
<p>The Terraform script has already created these resources. Use the Terraform output to extract these parameters:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">terraform output
demo_backup_irsa <span class="token operator">=</span> <span class="token string">"arn:aws:iam::&lt;your_account_id>:role/cnpg-on-eks-prod-irsa"</span>
demo_s3_bucket <span class="token operator">=</span> <span class="token string">"xyz-cnpg-demo-bucket"</span>
configure_kubectl <span class="token operator">=</span> <span class="token string">"aws eks --region eu-west-1 update-kubeconfig --name cnpg-on-eks"</span></code></pre></div>
<ul>
<li><strong>IRSA Configuration</strong>: <code class="language-text">arn:aws:iam::&lt;your_account_id>:role/cnpg-on-eks-prod-irsa</code></li>
<li><strong>S3 Bucket</strong>: <code class="language-text">xyz-cnpg-demo-bucket</code></li>
</ul>
<p>For more information on configuring IAM roles for service accounts (IRSA), refer to the <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="noopener noreferrer">AWS documentation</a>.</p>
<p>For details on setting up S3 buckets for backups, check the <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" target="_blank" rel="noopener noreferrer">AWS S3 documentation</a>.</p>
<p>Now, we are ready to deploy a CloudNativePG database cluster.</p>
<p><strong>demo-cnpg-cluster.yaml</strong>:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> postgresql.cnpg.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>cnpg
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Cluster Demo for DoEKS"</span>
  <span class="token comment"># Choose your PostGres Database Version</span>
  <span class="token key atrule">imageName</span><span class="token punctuation">:</span> ghcr.io/cloudnative<span class="token punctuation">-</span>pg/postgresql<span class="token punctuation">:</span><span class="token number">15.2</span>
  <span class="token comment"># Number of Replicas</span>
  <span class="token key atrule">instances</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">startDelay</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token key atrule">stopDelay</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token key atrule">replicationSlots</span><span class="token punctuation">:</span>
    <span class="token key atrule">highAvailability</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">updateInterval</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token key atrule">primaryUpdateStrategy</span><span class="token punctuation">:</span> unsupervised
  <span class="token key atrule">serviceAccountTemplate</span><span class="token punctuation">:</span>
    <span class="token comment"># For backup and restore, we use IRSA for demo tool.</span>
    <span class="token comment"># You will find this IAM role on terraform outputs.</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">eks.amazonaws.com/role-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>&lt;&lt;account_id<span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">:</span>role/cnpg<span class="token punctuation">-</span>on<span class="token punctuation">-</span>eks<span class="token punctuation">-</span>prod<span class="token punctuation">-</span>irsa <span class="token comment">#1</span>
  <span class="token key atrule">postgresql</span><span class="token punctuation">:</span>
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token key atrule">shared_buffers</span><span class="token punctuation">:</span> 256MB
      <span class="token key atrule">pg_stat_statements.max</span><span class="token punctuation">:</span> <span class="token string">'10000'</span>
      <span class="token key atrule">pg_stat_statements.track</span><span class="token punctuation">:</span> all
      <span class="token key atrule">auto_explain.log_min_duration</span><span class="token punctuation">:</span> <span class="token string">'10s'</span>
    <span class="token key atrule">pg_hba</span><span class="token punctuation">:</span>
      <span class="token comment"># - hostssl app all all cert</span>
      <span class="token punctuation">-</span> host app app all password
  <span class="token key atrule">logLevel</span><span class="token punctuation">:</span> debug
  <span class="token key atrule">storage</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
    <span class="token key atrule">size</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">walStorage</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
    <span class="token key atrule">size</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">monitoring</span><span class="token punctuation">:</span>
    <span class="token key atrule">enablePodMonitor</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">bootstrap</span><span class="token punctuation">:</span>
    <span class="token key atrule">initdb</span><span class="token punctuation">:</span> <span class="token comment"># Deploying a new cluster</span>
      <span class="token key atrule">database</span><span class="token punctuation">:</span> WorldDB
      <span class="token key atrule">owner</span><span class="token punctuation">:</span> app
      <span class="token key atrule">secret</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>auth
  <span class="token key atrule">backup</span><span class="token punctuation">:</span>
    <span class="token key atrule">barmanObjectStore</span><span class="token punctuation">:</span>
    <span class="token comment"># For backup, we S3 bucket to store data.</span>
    <span class="token comment"># On this Blueprint, we create an S3 check the terraform output for it.</span>
      <span class="token key atrule">destinationPath</span><span class="token punctuation">:</span> s3<span class="token punctuation">:</span>//&lt;your<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>bucket<span class="token punctuation">></span> <span class="token comment">#2</span>
      <span class="token key atrule">s3Credentials</span><span class="token punctuation">:</span>
        <span class="token key atrule">inheritFromIAMRole</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">wal</span><span class="token punctuation">:</span>
        <span class="token key atrule">compression</span><span class="token punctuation">:</span> gzip
        <span class="token key atrule">maxParallel</span><span class="token punctuation">:</span> <span class="token number">8</span>
    <span class="token key atrule">retentionPolicy</span><span class="token punctuation">:</span> <span class="token string">"30d"</span>

  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># m5large: m5xlarge 2vCPU, 8GI RAM</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"512Mi"</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">limits</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"1Gi"</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>

  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">enablePodAntiAffinity</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> failure<span class="token punctuation">-</span>domain.beta.kubernetes.io/zone

  <span class="token key atrule">nodeMaintenanceWindow</span><span class="token punctuation">:</span>
    <span class="token key atrule">inProgress</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">reusePVC</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre></div>
<p>Once updated, you can apply your template.</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">kubectl apply <span class="token parameter variable">-f</span> demo-cnpg-cluster.yaml</code></pre></div>
<p>Now you can check Cluster status is by using cloudnative-pg kubectl plugin offered by the CloudNativePG community.</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ kubectl cnpg status demo-cnpg
Cluster Summary
Name:               demo-cnpg
Namespace:          demo
System ID:          <span class="token number">7214866198623563798</span>
PostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:15.2
Primary instance:   demo-cnpg-1
Status:             Cluster <span class="token keyword">in</span> healthy state
Instances:          <span class="token number">3</span>
Ready instances:    <span class="token number">3</span>
Current Write LSN:  <span class="token number">0</span>/6000000 <span class="token punctuation">(</span>Timeline: <span class="token number">1</span> - WAL File: 000000010000000000000005<span class="token punctuation">)</span>
Certificates Status
Certificate Name  Expiration Date                Days Left Until Expiration
----------------  ---------------                --------------------------
demo-cnpg-ca           <span class="token number">2024</span>-07-14 <span class="token number">14</span>:40:27 +0000 UTC  <span class="token number">89.96</span>
demo-cnpg-replication  <span class="token number">2024</span>-07-14 <span class="token number">14</span>:40:27 +0000 UTC  <span class="token number">89.96</span>
demo-cnpg-server       <span class="token number">2024</span>-07-14 <span class="token number">14</span>:40:27 +0000 UTC  <span class="token number">89.96</span>

Continuous Backup status
First Point of Recoverability:  Not Available
Working WAL archiving:          OK
WALs waiting to be archived:    <span class="token number">0</span>
Last Archived WAL:              000000010000000000000005   @   <span class="token number">2024</span>-07-01T14:52:09.24307Z
Last Failed WAL:                -

Streaming Replication status
Replication Slots Enabled
Name    Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag  Flush Lag  Replay Lag  State      Sync State  Sync Priority  Replication Slot
----    --------   ---------  ---------  ----------  ---------  ---------  ----------  -----      ----------  -------------  ----------------
demo-cnpg-2  <span class="token number">0</span>/6000000  <span class="token number">0</span>/6000000  <span class="token number">0</span>/6000000  <span class="token number">0</span>/6000000   00:00:00   00:00:00   00:00:00    streaming  async       <span class="token number">0</span>              active
demo-cnpg-3  <span class="token number">0</span>/6000000  <span class="token number">0</span>/6000000  <span class="token number">0</span>/6000000  <span class="token number">0</span>/6000000   00:00:00   00:00:00   00:00:00    streaming  async       <span class="token number">0</span>              active

Unmanaged Replication Slot Status
No unmanaged replication slots found

Instances status
Name    Database Size  Current LSN  Replication role  Status  QoS         Manager Version  Node
----    -------------  -----------  ----------------  ------  ---         ---------------  ----
demo-cnpg-1  <span class="token number">29</span> MB          <span class="token number">0</span>/6000000    Primary           OK      BestEffort  <span class="token number">1.19</span>.0           ip-10-1-10-111.eu-west-1.compute.internal
demo-cnpg-2  <span class="token number">29</span> MB          <span class="token number">0</span>/6000000    Standby <span class="token punctuation">(</span>async<span class="token punctuation">)</span>   OK      BestEffort  <span class="token number">1.19</span>.0           ip-10-1-12-144.eu-west-1.compute.internal
demo-cnpg-3  <span class="token number">29</span> MB          <span class="token number">0</span>/6000000    Standby <span class="token punctuation">(</span>async<span class="token punctuation">)</span>   OK      BestEffort  <span class="token number">1.19</span>.0           ip-10-1-11-78.eu-west-1.compute.internal</code></pre></div>
<p>And there are more to discover like backup, monitoring, etc.</p>
<h2 id="key-takeaways" style="position:relative;"><a href="#key-takeaways" aria-label="key takeaways permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Key takeaways</h2>
<p>When running PostgreSQL on Amazon EKS, it's important to ensure data persistence in Kubernetes. Tools like CloudNativePG help manage highly available PostgreSQL clusters with native streaming replication, ensuring data durability and seamless failover.</p>
<p><strong>Stay tuned for next blogs in this¬†seriesüéâ</strong></p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://dok.community/blog/the-future-of-data-on-kubernetes" target="_blank" rel="noopener noreferrer">https://dok.community/blog/the-future-of-data-on-kubernetes</a></li>
<li><a href="https://www.reddit.com/r/kubernetes/comments/1dp062w/are_you_running_stateful_data_workloads_or/?sort=old" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/kubernetes/comments/1dp062w/are_you_running_stateful_data_workloads_or/?sort=old</a></li>
<li>
<iframe width="100%" height="315" src="https://www.youtube-nocookie.com/embed/99uSJXkKpeI?rel=0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</li>
<li><a href="https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres" target="_blank" rel="noopener noreferrer">https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres</a></li>
<li><a href="https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes" target="_blank" rel="noopener noreferrer">https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes</a></li>
<li><a href="https://rook.io/docs/rook/latest-release/Getting-Started/intro/" target="_blank" rel="noopener noreferrer">https://rook.io/docs/rook/latest-release/Getting-Started/intro/</a></li>
<li><a href="https://cloudnative-pg.io/documentation/1.22/" target="_blank" rel="noopener noreferrer">https://cloudnative-pg.io/documentation/1.22/</a></li>
</ul>
<p><strong>Thank You üñ§</strong></p>
<br>
<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>
<blockquote>
<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>
</blockquote>
<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>
<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href="https://www.linkedin.com/in/rajhi-saif/" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/in/rajhi-saif/</a></p>
<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href="https://x.com/rajhisaifeddine" target="_blank" rel="noopener noreferrer">https://x.com/rajhisaifeddine</a></p>
<p><strong>The end ‚úåüèª</strong></p>
<h1 align="center">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>
<p><strong>üìÖ Stay updated</strong></p>
<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p></div></div><div id="content-end"></div></article><div data-nosnippet="" class="social-share-wrapper"><h3>Share Your Love</h3><button keywords="" aria-label="Share Via Facebook" class="react-share__ShareButton social-share-item facebook" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256C0 376 82.7 476.8 194.2 504.5V334.2H141.4V256h52.8V222.3c0-87.1 39.4-127.5 125-127.5c16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1c-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287V510.1C413.8 494.8 512 386.9 512 256h0z"></path></svg></button><button keywords="" aria-label="Share Via Twitter" class="react-share__ShareButton social-share-item twitter" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="x-twitter" class="svg-inline--fa fa-x-twitter " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></svg></button><button aria-label="Share Via LinkedIn" keywords="" class="react-share__ShareButton social-share-item linkedin" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></button><button keywords="" aria-label="Share Via Reddit" class="react-share__ShareButton social-share-item reddit" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="reddit" class="svg-inline--fa fa-reddit " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 256C0 114.6 114.6 0 256 0S512 114.6 512 256s-114.6 256-256 256L37.1 512c-13.7 0-20.5-16.5-10.9-26.2L75 437C28.7 390.7 0 326.7 0 256zM349.6 153.6c23.6 0 42.7-19.1 42.7-42.7s-19.1-42.7-42.7-42.7c-20.6 0-37.8 14.6-41.8 34c-34.5 3.7-61.4 33-61.4 68.4l0 .2c-37.5 1.6-71.8 12.3-99 29.1c-10.1-7.8-22.8-12.5-36.5-12.5c-33 0-59.8 26.8-59.8 59.8c0 24 14.1 44.6 34.4 54.1c2 69.4 77.6 125.2 170.6 125.2s168.7-55.9 170.6-125.3c20.2-9.6 34.1-30.2 34.1-54c0-33-26.8-59.8-59.8-59.8c-13.7 0-26.3 4.6-36.4 12.4c-27.4-17-62.1-27.7-100-29.1l0-.2c0-25.4 18.9-46.5 43.4-49.9l0 0c4.4 18.8 21.3 32.8 41.5 32.8zM177.1 246.9c16.7 0 29.5 17.6 28.5 39.3s-13.5 29.6-30.3 29.6s-31.4-8.8-30.4-30.5s15.4-38.3 32.1-38.3zm190.1 38.3c1 21.7-13.7 30.5-30.4 30.5s-29.3-7.9-30.3-29.6c-1-21.7 11.8-39.3 28.5-39.3s31.2 16.6 32.1 38.3zm-48.1 56.7c-10.3 24.6-34.6 41.9-63 41.9s-52.7-17.3-63-41.9c-1.2-2.9 .8-6.2 3.9-6.5c18.4-1.9 38.3-2.9 59.1-2.9s40.7 1 59.1 2.9c3.1 .3 5.1 3.6 3.9 6.5z"></path></svg></button><button keywords="" aria-label="Add to Pocket" class="react-share__ShareButton social-share-item pocket" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="get-pocket" class="svg-inline--fa fa-get-pocket " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M407.6 64h-367C18.5 64 0 82.5 0 104.6v135.2C0 364.5 99.7 464 224.2 464c124 0 223.8-99.5 223.8-224.2V104.6c0-22.4-17.7-40.6-40.4-40.6zm-162 268.5c-12.4 11.8-31.4 11.1-42.4 0C89.5 223.6 88.3 227.4 88.3 209.3c0-16.9 13.8-30.7 30.7-30.7 17 0 16.1 3.8 105.2 89.3 90.6-86.9 88.6-89.3 105.5-89.3 16.9 0 30.7 13.8 30.7 30.7 0 17.8-2.9 15.7-114.8 123.2z"></path></svg></button></div><br/><br/><br/></main><aside class="blogpost-sidebar"><div data-nosnippet="" class="blog-navigation-wrapper"><h3>Read Other Posts</h3><nav class="blog-navigation"><div class="nav-links"><a rel="next" class="next-post" href="/blog/unsung-kubernetes-features-reliable-resilient/">Unsung Kubernetes Features that Keep Kubernetes Clusters Reliable and Resilient<!-- --> ‚Üí</a><a rel="prev" class="prev-post" href="/blog/data-on-kubernetes-ai-ml-5/">‚Üê <!-- -->Data on Kubernetes: Part 5‚Ää-‚ÄäMaking AI/ML simpler</a><a class="all-posts" href="/blog/">All Posts</a></div></nav></div></aside><footer data-nosnippet=""><div class="footer-wrapper"><div data-nosnippet="" class="social"><ul class="social-list"><li class="social-item social-linkedin"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="linkedin" href="https://www.linkedin.com/in/rajhi-saif/" title="Saifeddine Rajhi on LinkedIn" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin-in" class="svg-inline--fa fa-linkedin-in fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg><span>LinkedIn</span></a></li><li class="social-item social-github"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="github" href="https://github.com/seifrajhi" title="Saifeddine Rajhi on Github" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><span>GitHub</span></a></li><li class="social-item social-email"><a itemProp="email" eventCategory="social" eventAction="click" eventLabel="email" href="mailto:rajhiseif@gmail.com" title="Saifeddine Rajhi&#x27;s Email"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope" class="svg-inline--fa fa-envelope fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"></path></svg><span>Email</span></a></li><li class="social-item social-bluesky"><a rel="me" itemProp="url" eventCategory="bluesky" eventAction="click" eventLabel="social" href="https://bsky.app/profile/saifrajhi.bsky.social" title="Saifeddine Rajhi on Bluesky Social" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bluesky" class="svg-inline--fa fa-bluesky fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2c42.1-31.6 110.3-56 110.3 21.8c0 15.5-8.9 130.5-14.1 149.2C478.2 298 412 314.6 353.1 304.5c102.9 17.5 129.1 75.5 72.5 133.5c-107.4 110.2-154.3-27.6-166.3-62.9l0 0c-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8l0 0c-12 35.3-59 173.1-166.3 62.9c-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1C10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z"></path></svg><span>Bluesky Social</span></a></li><li class="social-item social-X/Twitter"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="X/Twitter" href="https://x.com/RajhiSaifeddine" title="Saifeddine Rajhi on X/Twitter" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="x-twitter" class="svg-inline--fa fa-x-twitter fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></svg><span>X/Twitter</span></a></li><li class="social-item social-reddit"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="reddit" href="https://www.reddit.com/user/ScoreApprehensive992/" title="Saifeddine Rajhi on Reddit" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="reddit-alien" class="svg-inline--fa fa-reddit-alien fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M373 138.6c-25.2 0-46.3-17.5-51.9-41l0 0c-30.6 4.3-54.2 30.7-54.2 62.4l0 .2c47.4 1.8 90.6 15.1 124.9 36.3c12.6-9.7 28.4-15.5 45.5-15.5c41.3 0 74.7 33.4 74.7 74.7c0 29.8-17.4 55.5-42.7 67.5c-2.4 86.8-97 156.6-213.2 156.6S45.5 410.1 43 323.4C17.6 311.5 0 285.7 0 255.7c0-41.3 33.4-74.7 74.7-74.7c17.2 0 33 5.8 45.7 15.6c34-21.1 76.8-34.4 123.7-36.4l0-.3c0-44.3 33.7-80.9 76.8-85.5C325.8 50.2 347.2 32 373 32c29.4 0 53.3 23.9 53.3 53.3s-23.9 53.3-53.3 53.3zM157.5 255.3c-20.9 0-38.9 20.8-40.2 47.9s17.1 38.1 38 38.1s36.6-9.8 37.8-36.9s-14.7-49.1-35.7-49.1zM395 303.1c-1.2-27.1-19.2-47.9-40.2-47.9s-36.9 22-35.7 49.1c1.2 27.1 16.9 36.9 37.8 36.9s39.3-11 38-38.1zm-60.1 70.8c1.5-3.6-1-7.7-4.9-8.1c-23-2.3-47.9-3.6-73.8-3.6s-50.8 1.3-73.8 3.6c-3.9 .4-6.4 4.5-4.9 8.1c12.9 30.8 43.3 52.4 78.7 52.4s65.8-21.6 78.7-52.4z"></path></svg><span>Reddit</span></a></li><li class="social-item social-stackoverflow"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="StackOverflow" href="https://stackoverflow.com/users/21897244/saifeddine-rajhi" title="Saifeddine Rajhi on StackOverflow" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="stack-overflow" class="svg-inline--fa fa-stack-overflow fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M290.7 311L95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"></path></svg><span>StackOverflow</span></a></li><li class="social-item social-Goodreads"><a rel="me" eventLabel="StackOverflow" href="https://www.goodreads.com/user/show/176103378-saifeddine" title="Saifeddine Rajhi on Goodreads" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="goodreads" class="svg-inline--fa fa-goodreads fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M299.9 191.2c5.1 37.3-4.7 79-35.9 100.7-22.3 15.5-52.8 14.1-70.8 5.7-37.1-17.3-49.5-58.6-46.8-97.2 4.3-60.9 40.9-87.9 75.3-87.5 46.9-.2 71.8 31.8 78.2 78.3zM448 88v336c0 30.9-25.1 56-56 56H56c-30.9 0-56-25.1-56-56V88c0-30.9 25.1-56 56-56h336c30.9 0 56 25.1 56 56zM330 313.2s-.1-34-.1-217.3h-29v40.3c-.8.3-1.2-.5-1.6-1.2-9.6-20.7-35.9-46.3-76-46-51.9.4-87.2 31.2-100.6 77.8-4.3 14.9-5.8 30.1-5.5 45.6 1.7 77.9 45.1 117.8 112.4 115.2 28.9-1.1 54.5-17 69-45.2.5-1 1.1-1.9 1.7-2.9.2.1.4.1.6.2.3 3.8.2 30.7.1 34.5-.2 14.8-2 29.5-7.2 43.5-7.8 21-22.3 34.7-44.5 39.5-17.8 3.9-35.6 3.8-53.2-1.2-21.5-6.1-36.5-19-41.1-41.8-.3-1.6-1.3-1.3-2.3-1.3h-26.8c.8 10.6 3.2 20.3 8.5 29.2 24.2 40.5 82.7 48.5 128.2 37.4 49.9-12.3 67.3-54.9 67.4-106.3z"></path></svg><span>Goodreads</span></a></li><li class="social-item social-osi"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="StackOverflow" href="https://ossinsight.io/analyze/seifrajhi" title="Saifeddine Rajhi on OSSInsights" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="osi" class="svg-inline--fa fa-osi fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M8 266.44C10.3 130.64 105.4 34 221.8 18.34c138.8-18.6 255.6 75.8 278 201.1 21.3 118.8-44 230-151.6 274-9.3 3.8-14.4 1.7-18-7.7q-26.7-69.45-53.4-139c-3.1-8.1-1-13.2 7-16.8 24.2-11 39.3-29.4 43.3-55.8a71.47 71.47 0 0 0-64.5-82.2c-39-3.4-71.8 23.7-77.5 59.7-5.2 33 11.1 63.7 41.9 77.7 9.6 4.4 11.5 8.6 7.8 18.4q-26.85 69.9-53.7 139.9c-2.6 6.9-8.3 9.3-15.5 6.5-52.6-20.3-101.4-61-130.8-119-24.9-49.2-25.2-87.7-26.8-108.7zm20.9-1.9c.4 6.6.6 14.3 1.3 22.1 6.3 71.9 49.6 143.5 131 183.1 3.2 1.5 4.4.8 5.6-2.3q22.35-58.65 45-117.3c1.3-3.3.6-4.8-2.4-6.7-31.6-19.9-47.3-48.5-45.6-86 1-21.6 9.3-40.5 23.8-56.3 30-32.7 77-39.8 115.5-17.6a91.64 91.64 0 0 1 45.2 90.4c-3.6 30.6-19.3 53.9-45.7 69.8-2.7 1.6-3.5 2.9-2.3 6q22.8 58.8 45.2 117.7c1.2 3.1 2.4 3.8 5.6 2.3 35.5-16.6 65.2-40.3 88.1-72 34.8-48.2 49.1-101.9 42.3-161-13.7-117.5-119.4-214.8-255.5-198-106.1 13-195.3 102.5-197.1 225.8z"></path></svg><span>OSSInsights</span></a></li><li class="social-item social-devstats"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="StackOverflow" href="https://devstats.cluster.fun/?user=seifrajhi" title="Saifeddine Rajhi on DevStats" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chart-line" class="svg-inline--fa fa-chart-line fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M64 64c0-17.7-14.3-32-32-32S0 46.3 0 64L0 400c0 44.2 35.8 80 80 80l400 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 416c-8.8 0-16-7.2-16-16L64 64zm406.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L320 210.7l-57.4-57.4c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L240 221.3l57.4 57.4c12.5 12.5 32.8 12.5 45.3 0l128-128z"></path></svg><span>DevStats</span></a></li><li class="social-item social-RSS"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="RSS" href="https://seifrajhi.github.io/rss.xml" title="Subscribe to my blog post" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" class="svg-inline--fa fa-rss fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM0 416a64 64 0 1 1 128 0A64 64 0 1 1 0 416zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg><span>RSS</span></a></li></ul></div><div class="copyright">Saifeddine Rajhi ¬© 1994 - <!-- -->2025<!-- --> <br/><a rel="license" href="https://creativecommons.org/licenses/by/4.0/" title="Content is published under CC BY 4.0 license">CC BY 4.0</a></div><div class="pgp"><a href="https://keybase.io/saifrajhi">0C3B BABB 8BC1 EA2B</a></div></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/data-on-kubernetes-cloudnativepg-ceph-2/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-841ae7833f9baaa41e35.js\"],\"component---cache-caches-gatsby-plugin-offline-app-shell-js\":[\"/component---cache-caches-gatsby-plugin-offline-app-shell-js-88fb5c28d68e831e730a.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-83bdb4e48c18bf191297.js\"],\"component---src-pages-blog-js\":[\"/component---src-pages-blog-js-ecde77d98197d52cb813.js\"],\"component---src-pages-cv-platform-engineer-js\":[\"/component---src-pages-cv-platform-engineer-js-b123892ec44b2247c14c.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-ea9268b02241eb42b7ab.js\"],\"component---src-pages-talks-js\":[\"/component---src-pages-talks-js-be8ac3db9e3c2f2f5cd6.js\"],\"component---src-pages-thoughts-js\":[\"/component---src-pages-thoughts-js-54f56c1476e2dcbf7fc4.js\"],\"component---src-templates-blog-template-js\":[\"/component---src-templates-blog-template-js-36418f189bad33f744db.js\"],\"component---src-templates-talk-template-js\":[\"/component---src-templates-talk-template-js-7623845caf43043e0341.js\"],\"component---src-templates-thought-template-js\":[\"/component---src-templates-thought-template-js-4e873e19a182fe3c30b3.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="9600e2f7479c4625ce7f";</script><script src="/webpack-runtime-f12c1039389262de0401.js" async></script><script src="/framework-c989293af61a95023f7f.js" async></script><script src="/app-841ae7833f9baaa41e35.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>