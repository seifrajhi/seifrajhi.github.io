<!DOCTYPE html><html lang="en" class="blogpost-view-page"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="description" property="og:description" content="Discover effective practices to avoid IPv4 address exhaustion in Amazon EKS clusters."/><meta data-react-helmet="true" name="keywords" content="AWS EKS,IPv4 exhaustion,Cloud networking,Kubernetes,Best practices"/><meta data-react-helmet="true" name="author" content="@RajhiSaifeddine"/><meta data-react-helmet="true" property="og:title" content="Tackling IPv4 Address Exhaustion in Amazon EKS Clusters - Blog"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="@RajhiSaifeddine"/><meta data-react-helmet="true" name="twitter:title" content="Tackling IPv4 Address Exhaustion in Amazon EKS Clusters - Blog"/><meta data-react-helmet="true" name="twitter:description" content="Discover effective practices to avoid IPv4 address exhaustion in Amazon EKS clusters."/><meta data-react-helmet="true" name="image" property="og:image" content="https://seifrajhi.github.io/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png"/><meta data-react-helmet="true" name="twitter:image" content="https://seifrajhi.github.io/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png"/><meta data-react-helmet="true" property="og:url" content="https://seifrajhi.github.io/blog/eks-avoid-ip-exhaustion-practices/"/><meta name="theme-color" content="#ffffff"/><link rel="stylesheet" href="/styles.56b75c4a5e398070a25b.css"/><link rel="stylesheet"/><link rel="alternate" type="application/rss+xml" title="Saifeddine Rajhi&#x27;s Blog RSS Feed" href="/rss.xml"/><title data-react-helmet="true">Tackling IPv4 Address Exhaustion in Amazon EKS Clusters - Blog by Saifeddine Rajhi</title><script data-react-helmet="true" type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","image":"/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png","headline":"Tackling IPv4 Address Exhaustion in Amazon EKS Clusters","dateCreated":"2024-10-20","datePublished":"2024-10-20","dateModified":"2024-10-20","inLanguage":"en-US","isFamilyFriendly":true,"isAccessibleForFree":true,"author":{"@type":"Person","name":"Saifeddine Rajhi","url":"https://seifrajhi.github.io"},"publisher":{"@type":"Organization","name":"Saifeddine Rajhi's Website"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://seifrajhi.github.io/blog/eks-avoid-ip-exhaustion-practices/"},"keywords":["AWS EKS","IPv4 exhaustion","Cloud networking","Kubernetes","Best practices"],"genre":["Platform engineer","software engineering","science","deep learning","statistics"],"articleSection":"Technical Blog","articleBody":"\n> **Avoid IP Exhaustion Problem with few practices**\n\n## üï∏ Introduction\n\nEach Amazon EC2 instance supports a maximum number of elastic network interfaces and a maximum number of IP addresses that can be assigned to each network interface. Each node requires one IP address for each network interface. All other available IP addresses can be assigned to Pods.\n\nEach Pod requires its own IP address. As a result, you might have nodes that have available compute and memory resources, but can't accommodate additional Pods because the node has run out of IP addresses to assign to Pods. This issue is exacerbated by the limited number of IPv4 addresses available in VPCs.\n\nIn this blog post, we will explore a few solutions to this problem and how to significantly increase the number of IP addresses that nodes can assign to Pods.\n\n### EKS VPC CNI Basics\n\nPods are the smallest deployable units of computing that can be created and managed in Kubernetes. A pod requires a unique IP address to communicate in the Kubernetes cluster (host networking pods being an exception).\n\n[Amazon Elastic Kubernetes Services (EKS)](https://docs.aws.amazon.com/eks/index.html) by default runs the [VPC Container Networking Interface (CNI) Plugin](https://github.com/aws/amazon-vpc-cni-k8s) to assign IP addresses to a pod by managing network interfaces and IP addresses on EC2 instances.\n\nThe VPC CNI plugin integrates directly with EC2 networking to provide high performance, low latency container networking in Kubernetes clusters running on AWS. This plugin assigns an IP address from the cluster's VPC to each pod.\n\nBy default, the number of IP addresses available to assign to pods is based on the [maximum number](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI) of elastic network interfaces and secondary IPs per interface that can be attached to an EC2 instance type.\n\nWhen the [Amazon VPC Container Network Interface (CNI) plugin](https://github.com/aws/amazon-vpc-cni-k8s) assigns IPv4 addresses to Pods, it allocates them from the VPC CIDR range assigned to the cluster.\n\nWhile it makes Pods first-class citizens within the VPC network, it often leads to exhaustion of the limited number of IPv4 addresses available in the VPCs. The long-term solution for addressing this issue is the adoption of IPv6; however, many customers aren't ready to make these types of decisions at the organization level.\n\nWhen an instance is created, EC2 creates and attaches a primary ENI associated with a primary subnet. The primary subnet may be public or private. The Pods that run in hostNetwork mode use the primary IP address assigned to the node primary ENI and share the same network namespace as the host.\n\nThe CNI plugin manages [Elastic Network Interfaces (ENI)](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html) on the node. When a node is provisioned, the CNI plugin automatically allocates a pool of slots (IPs or Prefixes) from the node's subnet to the primary ENI. This pool is known as the warm pool, and its size is determined by the node's instance type.\n\nDepending on CNI settings, a slot may be an IP address or a prefix. When a slot on an ENI has been assigned, the CNI may attach additional ENIs with a warm pool of slots to the nodes.\n\nThese additional ENIs are called Secondary ENIs. Each ENI can only support a certain number of slots, based on instance type. The CNI attaches more ENIs to instances based on the number of slots needed, which usually corresponds to the number of Pods.\n\nThis process continues until the node can no longer support additional ENIs. The CNI also pre-allocates \"warm\" ENIs and slots for faster Pod startup. Note each instance type has a maximum number of ENIs that may be attached. This is one constraint on Pod density (number of Pods per node), in addition to compute resources.\n\n![Warm Pool](warm.png)\n### üìä EC2 Instance Limits\n\nThe maximum number of network interfaces, and the maximum number of slots that you can use varies by the type of EC2 Instance.\n\nSince each Pod consumes an IP address on a slot, the number of Pods you can run on a particular EC2 Instance depends on how many ENIs can be attached to it and how many slots each ENI supports. We suggest setting the maximum Pods per [EKS user guide](https://docs.aws.amazon.com/eks/latest/userguide/pod-configuration.html) to avoid exhaustion of the instance's CPU and memory resources. Pods using hostNetwork are excluded from this calculation. You may consider using a script called [max-pod-calculator.sh](https://github.com/awslabs/amazon-eks-ami/blob/master/files/max-pods-calculator.sh) to calculate EKS's recommended maximum Pods for a given instance type.\n\n### üîÑ Consider Another CNI?\n\nYou can disable native AWS IPs provisioning by using another CNI. IPv4 management will work in the following way:\n- IP addresses of pods are scoped to the internal network.\n- Pods are not directly reachable from outside the cluster.\n- Every pod uses the primary node ENI.\n\nHowever, there are many benefits you lose by dropping the VPC CNI:\n- [Security group for pods](https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html)\n- Pod identification in [VPC flow logs](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html)\n- [Pod readiness gate](https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.6/deploy/pod_readiness_gate/) with load balancer controller\n- Simpler networking: no overlay network, you use the network provided by Amazon VPC\n\nWe will focus in this article on keeping the usage of VPC CNI.\n\n## Optimize IP Address Utilization\n\nWhen designing your AWS networking architecture, it is important to optimize Amazon EKS IP consumption at the VPC and at the node level. This will help you mitigate IP exhaustion issues and increase the pod density per node. In this section, we will discuss techniques that can help you achieve these goals.\n\n### Optimize Node-Level IP Consumption\n\n[Prefix delegation](https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html) is a feature that allocates a prefix (/28 for IPv4 and /80 for IPv6) instead of a secondary IP in the ENIs subnet. The total number of prefixes and private IP addresses will be less than the limit on private IPs allowed by your instance. Setting or resetting of `ENABLE_PREFIX_DELEGATION` while pods are running or if ENIs are attached is supported and the new pods allocated will get IPs based on the mode of IPAMD but the max pods of kubelet should be updated which would need either kubelet restart or node recycle.\n\nSetting `ENABLE_PREFIX_DELEGATION` to true will not increase the density of branch ENI pods. The limit on the number of branch [network interfaces per instance type will remain the same](https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html#supported-instance-types). Each branch network will be allocated a primary IP and this IP will be allocated for the branch ENI pods.\n\nPlease refer to the [VPC CNI Feature Matrix section](https://github.com/aws/amazon-vpc-cni-k8s#vpc-cni-feature-matrix) below for additional information around using Prefix delegation with Custom Networking and Security Groups Per Pod features.\n\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>It is highly recommended that you create new node groups to increase the number of available IP addresses rather than doing rolling replacement of existing worker nodes. Cordon and drain all the existing nodes to safely evict all of your existing Pods. To prevent service disruptions, we suggest implementing <a href=\"https://kubernetes.io/docs/tasks/run-application/configure-pdb\">Pod Disruption Budgets</a> on your production clusters for critical workloads. Pods on new nodes will be assigned an IP from a prefix assigned to an ENI.</p>\n</div>\n\n### üåê Custom Networking\n\n`AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true`\n\nCustom networking provides a solution to the IP exhaustion issue by assigning the Pod IPs from secondary VPC address spaces (e.g., CIDR). When custom networking is enabled in VPC CNI, it creates secondary ENIs in the subnet defined under a custom resource named ENIConfig that includes an alternate subnet CIDR range created from a secondary VPC CIDR. The VPC CNI assigns Pods IP addresses from the CIDR range defined in the ENIConfig custom resource.\n\nThe diagram below shows an overview of the solution:\n\n![Custom Networking with Internal SNAT](./custom.png \"Custom Networking with Internal SNAT\")\n<div class=\"image-title\">Custom networking with internal SNAT</div>\n\nWe create dedicated subnets for the pods. These ones should not be routable from outside the VPC (we can call these subnets internal). New subnets can have any CIDR block, but a good choice is to use [CG-NAT space](https://en.wikipedia.org/wiki/Carrier-grade_NAT) because companies don't usually use these ranges for private networks.\n\nUse custom networking to use the new subnets for pods ENIs (more information on [EKS best practices guide](https://aws.github.io/aws-eks-best-practices/networking/custom-networking/#example-configuration)). Internal SNAT is enabled by default when using custom networking (see [AWS documentation](https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html)).\n\nWith this configuration:\n\n- Network flow from pod to pod will not be NAT-ed. You will see pods IPs in the VPC flow logs.\n- Network flow from a load balancer in the same VPC to any pod is possible without any NAT.\n- Network flow from a pod to an address IP not associated with a pod is NAT-ed through the primary node ENI.\n- Ingress traffic from outside the VPC to the pods should pass through a load balancer (a.k.a layer 4 proxy) located in non-internal subnets.\n- You can create as many subnets with overlapping CIDR in different VPCs as you want.\n  \n### VPC CNI Tweaking\n\nWith the default configuration, the VPC CNI keeps an entire ENI (and associated IPs) in the warm pool. This may consume a large number of IPs, especially on larger instance types. If your cluster subnet has a limited number of IP addresses available, scrutinize these VPC CNI configuration environment variables:\n\n- `WARM_IP_TARGET`\n- `MINIMUM_IP_TARGET`\n- `WARM_ENI_TARGET`\n\nYou can configure the value of `MINIMUM_IP_TARGET` to closely match the number of Pods you expect to run on your nodes. Doing so will ensure that as Pods get created, the CNI can assign IP addresses from the warm pool without calling the EC2 API.\n\n> **Note:** Setting the value of `WARM_IP_TARGET` too low will cause additional calls to the EC2 API, which might cause throttling of the requests. For large clusters, use it along with `MINIMUM_IP_TARGET` to avoid throttling of the requests.\n\nTo configure these options, you can download the [aws-k8s-cni.yaml](https://github.com/aws/amazon-vpc-cni-k8s/releases) manifest and set the environment variables. Ensure the version of the configuration value matches the installed VPC CNI version.\n\n### üåê Adopt IPv6\n\nAdopting IPv6 is the easiest way to work around the [RFC1918](https://tools.ietf.org/html/rfc1918) limitations. We strongly recommend you consider adopting IPv6 as your first option when choosing a network architecture. IPv6 provides a significantly larger total IP address space, allowing cluster administrators to focus on migrating and scaling applications without devoting effort towards working around IPv4 limits.\n\nAmazon EKS clusters support both IPv4 and IPv6. By default, EKS clusters use IPv4 address space. Specifying an IPv6-based address space at cluster creation time will enable the use of IPv6. In an IPv6 EKS cluster, Pods and services receive IPv6 addresses while maintaining the ability for legacy IPv4 endpoints to connect to services running on IPv6 clusters and vice versa. All the pod-to-pod communication within a cluster always occurs over IPv6. Within a VPC (/56), the IPv6 CIDR block size for IPv6 subnets is fixed at /64. This provides 2‚Å∂‚Å¥ (approximately 18 quintillion) IPv6 addresses, allowing you to scale your deployments on EKS.\n\nFor detailed information, please see the [Running IPv6 EKS Clusters](https://docs.aws.amazon.com/eks/latest/userguide/cni-ipv6.html) section and for hands-on experience, please see the [Understanding IPv6 on Amazon EKS](https://eksworkshop.com/beginner/170_ipv6/) section of the Get hands-on with IPv6 workshop.\n\n![IPv6](./ipv6.gif)\n\n## üèÅ Conclusion\n\nIn this blog, we discussed strategies to tackle IPv4 address exhaustion in Amazon EKS clusters. We explored the use of custom networking, minimizing private address space consumption, optimizing IP address utilization, and considering the adoption of IPv6 as long-term solutions. These approaches can effectively mitigate the challenges posed by IPv4 address exhaustion in Amazon EKS clusters, ensuring efficient address allocation and usage.\n\n**References:**\n\n- https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/\n- https://aws.amazon.com/blogs/containers/automating-custom-networking-to-solve-ipv4-exhaustion-in-amazon-eks\n- https://aws.github.io/aws-eks-best-practices/networking/vpc-cni\n- https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html\n- https://medium.com/ekino-france/kubernetes-addressing-private-ipv4-shortage-5-strategies-for-amazon-eks-1dc3df270ed8\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  _**Until next time üéâ**_\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordcount":1827}</script><script data-react-helmet="true" type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://seifrajhi.github.io/"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://seifrajhi.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Tackling IPv4 Address Exhaustion in Amazon EKS Clusters","item":"https://seifrajhi.github.io/blog/eks-avoid-ip-exhaustion-practices/"}]}</script><link crossorigin="" href="https://utteranc.es" rel="preconnect"/><link crossorigin="" href="https://www.google-analytics.com" rel="preconnect"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=47ae28bb567c9025f1fee24afb2d20c9" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=47ae28bb567c9025f1fee24afb2d20c9"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup8.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7B1i03Sup8.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/ledger/v16/j8_q6-HK1L3if_sBnMrx.woff2"/><style>@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:400;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup8.woff2) format("woff2")}@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:700;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7B1i03Sup8.woff2) format("woff2")}@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:400;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup6.woff) format("woff")}@font-face{font-display:swap;font-family:Dancing Script;font-style:normal;font-weight:700;src:url(/static/webfonts/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7B1i03Sup6.woff) format("woff")}@font-face{font-display:swap;font-family:Ledger;font-style:normal;font-weight:400;src:url(/static/webfonts/s/ledger/v16/j8_q6-HK1L3if_sBnMrx.woff2) format("woff2")}@font-face{font-display:swap;font-family:Ledger;font-style:normal;font-weight:400;src:url(/static/webfonts/s/ledger/v16/j8_q6-HK1L3if_sBnMr3.woff) format("woff")}</style><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-LLPCCGNLH7',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'G-LLPCCGNLH7', 'auto', {"alwaysSendReferrer":true});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LLPCCGNLH7"></script><script>
      
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-LLPCCGNLH7',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-LLPCCGNLH7', {"anonymize_ip":true,"send_page_view":false});gtag('config', 'GTM-5V895PDS', {"anonymize_ip":true,"send_page_view":false});
      }
      </script><link rel="stylesheet"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://seifrajhi.github.io/blog/eks-avoid-ip-exhaustion-practices/" data-baseprotocol="https:" data-basehost="seifrajhi.github.io"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="blogpost-header"><div class="view-page-header"><div class="view-page-header-wrapper"><div class="logo-wrapper"><div class="logo"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained logo-img"><div style="max-width:150px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg%20height=&#x27;174&#x27;%20width=&#x27;150&#x27;%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/avif" data-srcset="/static/a1a51351bdf7de55eaaa515eb15ce2da/2e0ee/saifeddine-rajhi.avif 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/81dba/saifeddine-rajhi.avif 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/20c67/saifeddine-rajhi.avif 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/94b9f/saifeddine-rajhi.avif 300w" sizes="(min-width: 150px) 150px, 100vw"/><source type="image/webp" data-srcset="/static/a1a51351bdf7de55eaaa515eb15ce2da/92aab/saifeddine-rajhi.webp 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/359cc/saifeddine-rajhi.webp 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/aac41/saifeddine-rajhi.webp 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/a15c6/saifeddine-rajhi.webp 300w" sizes="(min-width: 150px) 150px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 150px) 150px, 100vw" decoding="async" loading="lazy" data-src="/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png" data-srcset="/static/a1a51351bdf7de55eaaa515eb15ce2da/9c61d/saifeddine-rajhi.png 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/d405f/saifeddine-rajhi.png 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/4aeea/saifeddine-rajhi.png 300w" alt="Saifeddine Rajhi"/></picture><noscript><picture><source type="image/avif" srcSet="/static/a1a51351bdf7de55eaaa515eb15ce2da/2e0ee/saifeddine-rajhi.avif 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/81dba/saifeddine-rajhi.avif 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/20c67/saifeddine-rajhi.avif 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/94b9f/saifeddine-rajhi.avif 300w" sizes="(min-width: 150px) 150px, 100vw"/><source type="image/webp" srcSet="/static/a1a51351bdf7de55eaaa515eb15ce2da/92aab/saifeddine-rajhi.webp 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/359cc/saifeddine-rajhi.webp 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/aac41/saifeddine-rajhi.webp 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/a15c6/saifeddine-rajhi.webp 300w" sizes="(min-width: 150px) 150px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 150px) 150px, 100vw" decoding="async" loading="lazy" src="/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png" srcSet="/static/a1a51351bdf7de55eaaa515eb15ce2da/9c61d/saifeddine-rajhi.png 38w,/static/a1a51351bdf7de55eaaa515eb15ce2da/d405f/saifeddine-rajhi.png 75w,/static/a1a51351bdf7de55eaaa515eb15ce2da/885b3/saifeddine-rajhi.png 150w,/static/a1a51351bdf7de55eaaa515eb15ce2da/4aeea/saifeddine-rajhi.png 300w" alt="Saifeddine Rajhi"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div><div class="name"><a href="/blog/" title="back to blog">Saifeddine <br/> Rajhi</a></div></div><h2 class="blog-title"><a href="/blog/" title="back to the homepage">Blog</a></h2></div></div><nav class="main-navigation"><ul><li><a rel="home" title="Go Home" href="/">Home</a></li><li><a title="Go to my Technical Blog" href="/blog/">Blog</a></li><li><a title="Go to my Thoughts" href="/thoughts/">Thoughts</a></li><li><a title="Review My Resume" href="/cv/platform-engineer/">cv</a></li><li><a title="My public talks" href="/talks/">talks</a></li></ul></nav></div><main><article class="blog-wrapper"><header><figure class="cover"><div class="cover-filter"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper cover cover-image"><div aria-hidden="true" style="padding-top:48.12500000000001%"></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear" decoding="async" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHUlEQVR42oWSvWtTURiHT5LrvbFJyW2aNLV+FBGhQh0qojVpLRHbJEaapgkI+YBUCAnoIOiikk3pYJMlH4UudZBAEgRNoWRxytDo5uAfoIuDa0G3x3tvSGil4PBw7nnveX/nd973FSaTCQOzhFnDZDIzjJ2A2Ww2+Dc2+BYmi6UvIgRCo39AOnZQkiRkWTZWHT1u0fIG4kcvEYaQtpGnfahTPi3BZgjrifoaCARot9vs7OxQLBZZW1sjm81SKpWGBo5eLk5NzuLId1FffmMu9J6F9c+MT93u/zQEgxQKBTKZDKlUCr/fTy6XIxgM4nK5cDgcjI6OYrPZUBQF4Xp9iHvzN9YbWVxn77AQ/8K93CHK2BLPnj7iw8c2lUqFer1OuVym0Wiwvb1Ns9lkd3eXVqtFp9Oh1+vh8/kQ7iIoc0k8E17GPDcZcVxi+eEvzlzOcP3ajPa8HIlEgnQ6zcbGBvl8nmQySSQSYXFx0ShBNBpldXUVVVU1wTcgz65z/mKMiQsBrfgqy6nvnJvJYpWF5qxBt9tlb2/PcKM7qdVqVKtVDg4O2N/fN56tl0evo3BvgZr9hOK5yoh7Fntwk+n7b3FOLmG3SczPe/F6vYTDYVZWVojH44a7WCxmuAqFQse6L07feozzxU+cz3+gPvnK+Ks/WO8WtKaIYWP+x3AG+3uBxe7BHt7C8eAd0sQVYyb12RzMm87AxUkMxGTFzl8DYUHBbV94RAAAAABJRU5ErkJggg==" alt=""/><picture><source type="image/webp" data-srcset="/static/bf08e50f4212e5674c7df214e1b033c7/58527/ip-eks-cover.webp 750w,/static/bf08e50f4212e5674c7df214e1b033c7/5ceac/ip-eks-cover.webp 800w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png" data-srcset="/static/bf08e50f4212e5674c7df214e1b033c7/ad69c/ip-eks-cover.png 750w,/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png 800w" alt="Tackling IPv4 Address Exhaustion in Amazon EKS Clusters"/></picture><noscript><picture><source type="image/webp" srcSet="/static/bf08e50f4212e5674c7df214e1b033c7/58527/ip-eks-cover.webp 750w,/static/bf08e50f4212e5674c7df214e1b033c7/5ceac/ip-eks-cover.webp 800w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png" srcSet="/static/bf08e50f4212e5674c7df214e1b033c7/ad69c/ip-eks-cover.png 750w,/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png 800w" alt="Tackling IPv4 Address Exhaustion in Amazon EKS Clusters"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div><figcaption data-nosnippet="" class="image-title">Photo by Saifeddine Rajhi</figcaption></figure><h1>Tackling IPv4 Address Exhaustion in Amazon EKS Clusters</h1><div data-nosnippet="" class="blog-details"><time class="blog-createdat" dateTime="2024-10-20">Oct 20, 2024</time><span> ‚Ä¢ </span><span class="blog-time2read">8<!-- -->mins<!-- --> read</span><div class="theme-switcher"><div class="theme-switcher-toggler"><div class="theme-switcher-track"></div><div class="theme-switcher-thumb"></div><input class="theme-switcher-input" type="checkbox" readonly="" aria-label="Switch between Dark and Light modes"/></div></div></div><ul data-nosnippet="" class="blog-tags"><li>AWS EKS</li><li>IPv4 exhaustion</li><li>Cloud networking</li><li>Kubernetes</li><li>Best practices</li></ul></header><div class="blog-divider"></div><div id="intro"></div><div class="content-wrapper"><div data-nosnippet="" class="blog-content-nav-wrapper"><ul class="blog-content-nav"><h2>Content</h2><ul class="toc-list"></ul></ul></div><div class="content blog-content"><blockquote>
<p><strong>Avoid IP Exhaustion Problem with few practices</strong></p>
</blockquote>
<h2 id="-introduction" style="position:relative;"><a href="#-introduction" aria-label=" introduction permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üï∏ Introduction</h2>
<p>Each Amazon EC2 instance supports a maximum number of elastic network interfaces and a maximum number of IP addresses that can be assigned to each network interface. Each node requires one IP address for each network interface. All other available IP addresses can be assigned to Pods.</p>
<p>Each Pod requires its own IP address. As a result, you might have nodes that have available compute and memory resources, but can't accommodate additional Pods because the node has run out of IP addresses to assign to Pods. This issue is exacerbated by the limited number of IPv4 addresses available in VPCs.</p>
<p>In this blog post, we will explore a few solutions to this problem and how to significantly increase the number of IP addresses that nodes can assign to Pods.</p>
<h3 id="eks-vpc-cni-basics" style="position:relative;"><a href="#eks-vpc-cni-basics" aria-label="eks vpc cni basics permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>EKS VPC CNI Basics</h3>
<p>Pods are the smallest deployable units of computing that can be created and managed in Kubernetes. A pod requires a unique IP address to communicate in the Kubernetes cluster (host networking pods being an exception).</p>
<p><a href="https://docs.aws.amazon.com/eks/index.html" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Services (EKS)</a> by default runs the <a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="noopener noreferrer">VPC Container Networking Interface (CNI) Plugin</a> to assign IP addresses to a pod by managing network interfaces and IP addresses on EC2 instances.</p>
<p>The VPC CNI plugin integrates directly with EC2 networking to provide high performance, low latency container networking in Kubernetes clusters running on AWS. This plugin assigns an IP address from the cluster's VPC to each pod.</p>
<p>By default, the number of IP addresses available to assign to pods is based on the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI" target="_blank" rel="noopener noreferrer">maximum number</a> of elastic network interfaces and secondary IPs per interface that can be attached to an EC2 instance type.</p>
<p>When the <a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="noopener noreferrer">Amazon VPC Container Network Interface (CNI) plugin</a> assigns IPv4 addresses to Pods, it allocates them from the VPC CIDR range assigned to the cluster.</p>
<p>While it makes Pods first-class citizens within the VPC network, it often leads to exhaustion of the limited number of IPv4 addresses available in the VPCs. The long-term solution for addressing this issue is the adoption of IPv6; however, many customers aren't ready to make these types of decisions at the organization level.</p>
<p>When an instance is created, EC2 creates and attaches a primary ENI associated with a primary subnet. The primary subnet may be public or private. The Pods that run in hostNetwork mode use the primary IP address assigned to the node primary ENI and share the same network namespace as the host.</p>
<p>The CNI plugin manages <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html" target="_blank" rel="noopener noreferrer">Elastic Network Interfaces (ENI)</a> on the node. When a node is provisioned, the CNI plugin automatically allocates a pool of slots (IPs or Prefixes) from the node's subnet to the primary ENI. This pool is known as the warm pool, and its size is determined by the node's instance type.</p>
<p>Depending on CNI settings, a slot may be an IP address or a prefix. When a slot on an ENI has been assigned, the CNI may attach additional ENIs with a warm pool of slots to the nodes.</p>
<p>These additional ENIs are called Secondary ENIs. Each ENI can only support a certain number of slots, based on instance type. The CNI attaches more ENIs to instances based on the number of slots needed, which usually corresponds to the number of Pods.</p>
<p>This process continues until the node can no longer support additional ENIs. The CNI also pre-allocates "warm" ENIs and slots for faster Pod startup. Note each instance type has a maximum number of ENIs that may be attached. This is one constraint on Pod density (number of Pods per node), in addition to compute resources.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkElEQVR42mNgaL09nQEIhEXFW6SlpR+IiIis////P5OKioqoqqrqZjMzs3OGhobXxcXFG4DijPX19SyCgoKTlZSUngrw8c0FamUCYuYP7OzZnzk58xiABm4CGSgoLDoXaOB/ISGhM4sWLeJ2d3dX19LSumhtbf3e2Nj4F9DAadu2beMDGsgHNHCpvLz8bwEBgfVAraxAzPFOQKj6g5BQHQMD0FYGCADZLpebm8vOgARaW1vFOzs7eZHF0tLSWLu7uxVnzpzJyoADgA0FGiixatUqZhD7P9QioEYxoEYuZDGQN5OTk4WQ+Az/GRhYQJgBZsC9e/fS7ty9s+H+/fvdHh4eYFdeu3bN586dO+uBeO769etlYYYB1RQC1a8H4nKYY+AAaAsLiH778u3Et8/efnv36t0RYJiBXXTx4sWs69evfwEafHfDhg3qMAOfPXu29O3bt/+fP3++HskcRhTvSk2WEhZuF3YS7xZXRFYEinEQRnbE/v37WYARxI49DOsZIIp7GSwYOhmOAnEKijiJAAB9Uq3P4H+V6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="Warm Pool" title="" src="/static/191eaf733938e9a7cb706de71dbff78f/c5bb3/warm.png" srcset="/static/191eaf733938e9a7cb706de71dbff78f/04472/warm.png 170w,
/static/191eaf733938e9a7cb706de71dbff78f/9f933/warm.png 340w,
/static/191eaf733938e9a7cb706de71dbff78f/c5bb3/warm.png 680w,
/static/191eaf733938e9a7cb706de71dbff78f/5a190/warm.png 800w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async">
    </span>
          </p>
<h3 id="-ec2-instance-limits" style="position:relative;"><a href="#-ec2-instance-limits" aria-label=" ec2 instance limits permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üìä EC2 Instance Limits</h3>
<p>The maximum number of network interfaces, and the maximum number of slots that you can use varies by the type of EC2 Instance.</p>
<p>Since each Pod consumes an IP address on a slot, the number of Pods you can run on a particular EC2 Instance depends on how many ENIs can be attached to it and how many slots each ENI supports. We suggest setting the maximum Pods per <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-configuration.html" target="_blank" rel="noopener noreferrer">EKS user guide</a> to avoid exhaustion of the instance's CPU and memory resources. Pods using hostNetwork are excluded from this calculation. You may consider using a script called <a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/max-pods-calculator.sh" target="_blank" rel="noopener noreferrer">max-pod-calculator.sh</a> to calculate EKS's recommended maximum Pods for a given instance type.</p>
<h3 id="-consider-another-cni" style="position:relative;"><a href="#-consider-another-cni" aria-label=" consider another cni permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üîÑ Consider Another CNI?</h3>
<p>You can disable native AWS IPs provisioning by using another CNI. IPv4 management will work in the following way:</p>
<ul>
<li>IP addresses of pods are scoped to the internal network.</li>
<li>Pods are not directly reachable from outside the cluster.</li>
<li>Every pod uses the primary node ENI.</li>
</ul>
<p>However, there are many benefits you lose by dropping the VPC CNI:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html" target="_blank" rel="noopener noreferrer">Security group for pods</a></li>
<li>Pod identification in <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html" target="_blank" rel="noopener noreferrer">VPC flow logs</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.6/deploy/pod_readiness_gate/" target="_blank" rel="noopener noreferrer">Pod readiness gate</a> with load balancer controller</li>
<li>Simpler networking: no overlay network, you use the network provided by Amazon VPC</li>
</ul>
<p>We will focus in this article on keeping the usage of VPC CNI.</p>
<h2 id="optimize-ip-address-utilization" style="position:relative;"><a href="#optimize-ip-address-utilization" aria-label="optimize ip address utilization permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Optimize IP Address Utilization</h2>
<p>When designing your AWS networking architecture, it is important to optimize Amazon EKS IP consumption at the VPC and at the node level. This will help you mitigate IP exhaustion issues and increase the pod density per node. In this section, we will discuss techniques that can help you achieve these goals.</p>
<h3 id="optimize-node-level-ip-consumption" style="position:relative;"><a href="#optimize-node-level-ip-consumption" aria-label="optimize node level ip consumption permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Optimize Node-Level IP Consumption</h3>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html" target="_blank" rel="noopener noreferrer">Prefix delegation</a> is a feature that allocates a prefix (/28 for IPv4 and /80 for IPv6) instead of a secondary IP in the ENIs subnet. The total number of prefixes and private IP addresses will be less than the limit on private IPs allowed by your instance. Setting or resetting of <code class="language-text">ENABLE_PREFIX_DELEGATION</code> while pods are running or if ENIs are attached is supported and the new pods allocated will get IPs based on the mode of IPAMD but the max pods of kubelet should be updated which would need either kubelet restart or node recycle.</p>
<p>Setting <code class="language-text">ENABLE_PREFIX_DELEGATION</code> to true will not increase the density of branch ENI pods. The limit on the number of branch <a href="https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html#supported-instance-types" target="_blank" rel="noopener noreferrer">network interfaces per instance type will remain the same</a>. Each branch network will be allocated a primary IP and this IP will be allocated for the branch ENI pods.</p>
<p>Please refer to the <a href="https://github.com/aws/amazon-vpc-cni-k8s#vpc-cni-feature-matrix" target="_blank" rel="noopener noreferrer">VPC CNI Feature Matrix section</a> below for additional information around using Prefix delegation with Custom Networking and Security Groups Per Pod features.</p>
<div class="note">
    <p><strong>üîµ Note:</strong></p>
    <p>It is highly recommended that you create new node groups to increase the number of available IP addresses rather than doing rolling replacement of existing worker nodes. Cordon and drain all the existing nodes to safely evict all of your existing Pods. To prevent service disruptions, we suggest implementing <a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb">Pod Disruption Budgets</a> on your production clusters for critical workloads. Pods on new nodes will be assigned an IP from a prefix assigned to an ENI.</p>
</div>
<h3 id="-custom-networking" style="position:relative;"><a href="#-custom-networking" aria-label=" custom networking permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üåê Custom Networking</h3>
<p><code class="language-text">AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true</code></p>
<p>Custom networking provides a solution to the IP exhaustion issue by assigning the Pod IPs from secondary VPC address spaces (e.g., CIDR). When custom networking is enabled in VPC CNI, it creates secondary ENIs in the subnet defined under a custom resource named ENIConfig that includes an alternate subnet CIDR range created from a secondary VPC CIDR. The VPC CNI assigns Pods IP addresses from the CIDR range defined in the ENIConfig custom resource.</p>
<p>The diagram below shows an overview of the solution:</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFUlEQVR42mNggABGMFnPwGc6xdVu497DQfM3LrEunF0vlNSZLVWyaopE17blylHTKgQ9Jqqwe0z0YLevD+WRrJfkguuFgSdPX6x5+uL11mevP2SA+Auq45TPdmfZXbp0x+vomqUaLQVVksfWz9S9tGN9wP+Juew+kWdE0qoOSv4PZWD2menDxSCux82gG6QExiD2x0+f/4PA87efFwDNY2NI28T1eaJz7q85AfUMof/ZGBj+M/2fZj391TTLUJCFPu1vNjo0fCsGsUM7yvmBFDNDzCIxhgwgZqhnYnjx8vX/Hz9+/r9858liBhUPPoak/7z3p8YkPpwV281g9Zp3QnerztvZkf0Wq/x1GXrCZX2an/R7VD9UBhno1+nHi+Hlm/cezrl55/6Sy9dux4H4h6MYBF/3hPq9PbTG+n+oFs82j1z2N/2+QXd7zG0YljII+mSddY7KXq8L9DIb2EBxPTEGH0sNMJYwEEUxPL7engNE/5lkX/h7ptt8EPtRr4XQ31nOB/8vsFJm6J0tFDjh0x3H+l9WILno+mg+IMXEMDOUn2GxBx/YtatWrWIGYWAwMmrVA8MQCB7OTLS5NzcrDMQ+O7te5cbyhlgQu6N8N79P/dOUiR4T2UEuDK2358HwMgqoZ2DR63blDl1Vz5aWlsaa1GnFmzbTmAuIWesnevBlTQnl+f+/nqkU6FUQWxIoBzUQhhkAoaXRiUUKpQwAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="Custom Networking with Internal SNAT" title="" src="/static/96ea621963d34c752beb018db323eed5/c5bb3/custom.png" srcset="/static/96ea621963d34c752beb018db323eed5/04472/custom.png 170w,
/static/96ea621963d34c752beb018db323eed5/9f933/custom.png 340w,
/static/96ea621963d34c752beb018db323eed5/c5bb3/custom.png 680w,
/static/96ea621963d34c752beb018db323eed5/5a190/custom.png 800w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async">
    </span>
          </p>
<div class="image-title">Custom networking with internal SNAT</div>
<p>We create dedicated subnets for the pods. These ones should not be routable from outside the VPC (we can call these subnets internal). New subnets can have any CIDR block, but a good choice is to use <a href="https://en.wikipedia.org/wiki/Carrier-grade_NAT" target="_blank" rel="noopener noreferrer">CG-NAT space</a> because companies don't usually use these ranges for private networks.</p>
<p>Use custom networking to use the new subnets for pods ENIs (more information on <a href="https://aws.github.io/aws-eks-best-practices/networking/custom-networking/#example-configuration" target="_blank" rel="noopener noreferrer">EKS best practices guide</a>). Internal SNAT is enabled by default when using custom networking (see <a href="https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html" target="_blank" rel="noopener noreferrer">AWS documentation</a>).</p>
<p>With this configuration:</p>
<ul>
<li>Network flow from pod to pod will not be NAT-ed. You will see pods IPs in the VPC flow logs.</li>
<li>Network flow from a load balancer in the same VPC to any pod is possible without any NAT.</li>
<li>Network flow from a pod to an address IP not associated with a pod is NAT-ed through the primary node ENI.</li>
<li>Ingress traffic from outside the VPC to the pods should pass through a load balancer (a.k.a layer 4 proxy) located in non-internal subnets.</li>
<li>You can create as many subnets with overlapping CIDR in different VPCs as you want.</li>
</ul>
<h3 id="vpc-cni-tweaking" style="position:relative;"><a href="#vpc-cni-tweaking" aria-label="vpc cni tweaking permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>VPC CNI Tweaking</h3>
<p>With the default configuration, the VPC CNI keeps an entire ENI (and associated IPs) in the warm pool. This may consume a large number of IPs, especially on larger instance types. If your cluster subnet has a limited number of IP addresses available, scrutinize these VPC CNI configuration environment variables:</p>
<ul>
<li><code class="language-text">WARM_IP_TARGET</code></li>
<li><code class="language-text">MINIMUM_IP_TARGET</code></li>
<li><code class="language-text">WARM_ENI_TARGET</code></li>
</ul>
<p>You can configure the value of <code class="language-text">MINIMUM_IP_TARGET</code> to closely match the number of Pods you expect to run on your nodes. Doing so will ensure that as Pods get created, the CNI can assign IP addresses from the warm pool without calling the EC2 API.</p>
<blockquote>
<p><strong>Note:</strong> Setting the value of <code class="language-text">WARM_IP_TARGET</code> too low will cause additional calls to the EC2 API, which might cause throttling of the requests. For large clusters, use it along with <code class="language-text">MINIMUM_IP_TARGET</code> to avoid throttling of the requests.</p>
</blockquote>
<p>To configure these options, you can download the <a href="https://github.com/aws/amazon-vpc-cni-k8s/releases" target="_blank" rel="noopener noreferrer">aws-k8s-cni.yaml</a> manifest and set the environment variables. Ensure the version of the configuration value matches the installed VPC CNI version.</p>
<h3 id="-adopt-ipv6" style="position:relative;"><a href="#-adopt-ipv6" aria-label=" adopt ipv6 permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üåê Adopt IPv6</h3>
<p>Adopting IPv6 is the easiest way to work around the <a href="https://tools.ietf.org/html/rfc1918" target="_blank" rel="noopener noreferrer">RFC1918</a> limitations. We strongly recommend you consider adopting IPv6 as your first option when choosing a network architecture. IPv6 provides a significantly larger total IP address space, allowing cluster administrators to focus on migrating and scaling applications without devoting effort towards working around IPv4 limits.</p>
<p>Amazon EKS clusters support both IPv4 and IPv6. By default, EKS clusters use IPv4 address space. Specifying an IPv6-based address space at cluster creation time will enable the use of IPv6. In an IPv6 EKS cluster, Pods and services receive IPv6 addresses while maintaining the ability for legacy IPv4 endpoints to connect to services running on IPv6 clusters and vice versa. All the pod-to-pod communication within a cluster always occurs over IPv6. Within a VPC (/56), the IPv6 CIDR block size for IPv6 subnets is fixed at /64. This provides 2‚Å∂‚Å¥ (approximately 18 quintillion) IPv6 addresses, allowing you to scale your deployments on EKS.</p>
<p>For detailed information, please see the <a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-ipv6.html" target="_blank" rel="noopener noreferrer">Running IPv6 EKS Clusters</a> section and for hands-on experience, please see the <a href="https://eksworkshop.com/beginner/170_ipv6/" target="_blank" rel="noopener noreferrer">Understanding IPv6 on Amazon EKS</a> section of the Get hands-on with IPv6 workshop.</p>
<p><img src="/122ab66ed95c184d7d525fedd0b02a7b/ipv6.gif" alt="IPv6" loading="lazy">
          </p>
<h2 id="-conclusion" style="position:relative;"><a href="#-conclusion" aria-label=" conclusion permalink" class="anchor before"><svg class="anchor-icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>üèÅ Conclusion</h2>
<p>In this blog, we discussed strategies to tackle IPv4 address exhaustion in Amazon EKS clusters. We explored the use of custom networking, minimizing private address space consumption, optimizing IP address utilization, and considering the adoption of IPv6 as long-term solutions. These approaches can effectively mitigate the challenges posed by IPv4 address exhaustion in Amazon EKS clusters, ensuring efficient address allocation and usage.</p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/</a></li>
<li><a href="https://aws.amazon.com/blogs/containers/automating-custom-networking-to-solve-ipv4-exhaustion-in-amazon-eks" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/containers/automating-custom-networking-to-solve-ipv4-exhaustion-in-amazon-eks</a></li>
<li><a href="https://aws.github.io/aws-eks-best-practices/networking/vpc-cni" target="_blank" rel="noopener noreferrer">https://aws.github.io/aws-eks-best-practices/networking/vpc-cni</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html</a></li>
<li><a href="https://medium.com/ekino-france/kubernetes-addressing-private-ipv4-shortage-5-strategies-for-amazon-eks-1dc3df270ed8" target="_blank" rel="noopener noreferrer">https://medium.com/ekino-france/kubernetes-addressing-private-ipv4-shortage-5-strategies-for-amazon-eks-1dc3df270ed8</a></li>
</ul>
<br>
<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>
<blockquote>
<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>
</blockquote>
<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>
<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href="https://www.linkedin.com/in/rajhi-saif/" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/in/rajhi-saif/</a></p>
<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href="https://x.com/rajhisaifeddine" target="_blank" rel="noopener noreferrer">https://x.com/rajhisaifeddine</a></p>
<p><strong>The end ‚úåüèª</strong></p>
<h1 align="center">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>
<p><strong>üìÖ Stay updated</strong></p>
<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p></div></div><div id="content-end"></div></article><div data-nosnippet="" class="social-share-wrapper"><h3>Share Your Love</h3><button keywords="" aria-label="Share Via Facebook" class="react-share__ShareButton social-share-item facebook" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256C0 376 82.7 476.8 194.2 504.5V334.2H141.4V256h52.8V222.3c0-87.1 39.4-127.5 125-127.5c16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1c-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287V510.1C413.8 494.8 512 386.9 512 256h0z"></path></svg></button><button keywords="" aria-label="Share Via Twitter" class="react-share__ShareButton social-share-item twitter" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="x-twitter" class="svg-inline--fa fa-x-twitter " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></svg></button><button aria-label="Share Via LinkedIn" keywords="" class="react-share__ShareButton social-share-item linkedin" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></button><button keywords="" aria-label="Share Via Reddit" class="react-share__ShareButton social-share-item reddit" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="reddit" class="svg-inline--fa fa-reddit " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 256C0 114.6 114.6 0 256 0S512 114.6 512 256s-114.6 256-256 256L37.1 512c-13.7 0-20.5-16.5-10.9-26.2L75 437C28.7 390.7 0 326.7 0 256zM349.6 153.6c23.6 0 42.7-19.1 42.7-42.7s-19.1-42.7-42.7-42.7c-20.6 0-37.8 14.6-41.8 34c-34.5 3.7-61.4 33-61.4 68.4l0 .2c-37.5 1.6-71.8 12.3-99 29.1c-10.1-7.8-22.8-12.5-36.5-12.5c-33 0-59.8 26.8-59.8 59.8c0 24 14.1 44.6 34.4 54.1c2 69.4 77.6 125.2 170.6 125.2s168.7-55.9 170.6-125.3c20.2-9.6 34.1-30.2 34.1-54c0-33-26.8-59.8-59.8-59.8c-13.7 0-26.3 4.6-36.4 12.4c-27.4-17-62.1-27.7-100-29.1l0-.2c0-25.4 18.9-46.5 43.4-49.9l0 0c4.4 18.8 21.3 32.8 41.5 32.8zM177.1 246.9c16.7 0 29.5 17.6 28.5 39.3s-13.5 29.6-30.3 29.6s-31.4-8.8-30.4-30.5s15.4-38.3 32.1-38.3zm190.1 38.3c1 21.7-13.7 30.5-30.4 30.5s-29.3-7.9-30.3-29.6c-1-21.7 11.8-39.3 28.5-39.3s31.2 16.6 32.1 38.3zm-48.1 56.7c-10.3 24.6-34.6 41.9-63 41.9s-52.7-17.3-63-41.9c-1.2-2.9 .8-6.2 3.9-6.5c18.4-1.9 38.3-2.9 59.1-2.9s40.7 1 59.1 2.9c3.1 .3 5.1 3.6 3.9 6.5z"></path></svg></button><button keywords="" aria-label="Add to Pocket" class="react-share__ShareButton social-share-item pocket" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="get-pocket" class="svg-inline--fa fa-get-pocket " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M407.6 64h-367C18.5 64 0 82.5 0 104.6v135.2C0 364.5 99.7 464 224.2 464c124 0 223.8-99.5 223.8-224.2V104.6c0-22.4-17.7-40.6-40.4-40.6zm-162 268.5c-12.4 11.8-31.4 11.1-42.4 0C89.5 223.6 88.3 227.4 88.3 209.3c0-16.9 13.8-30.7 30.7-30.7 17 0 16.1 3.8 105.2 89.3 90.6-86.9 88.6-89.3 105.5-89.3 16.9 0 30.7 13.8 30.7 30.7 0 17.8-2.9 15.7-114.8 123.2z"></path></svg></button></div><br/><br/><br/></main><aside class="blogpost-sidebar"><div data-nosnippet="" class="blog-navigation-wrapper"><h3>Read Other Posts</h3><nav class="blog-navigation"><div class="nav-links"><a rel="next" class="next-post" href="/blog/k8s-wasm-runtimes-part1/">Wasm and Kubernetes: A new era of cloud-native application deployment; Part1<!-- --> ‚Üí</a><a rel="prev" class="prev-post" href="/blog/dapr-kubernetes-event-driven-runtime-part1/">‚Üê <!-- -->Dapr: A portable, Event-Driven runtime for building distributed applications; Part1</a><a class="all-posts" href="/blog/">All Posts</a></div></nav></div></aside><footer data-nosnippet=""><div class="footer-wrapper"><div data-nosnippet="" class="social"><ul class="social-list"><li class="social-item social-linkedin"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="linkedin" href="https://www.linkedin.com/in/rajhi-saif/" title="Saifeddine Rajhi on LinkedIn" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin-in" class="svg-inline--fa fa-linkedin-in fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg><span>LinkedIn</span></a></li><li class="social-item social-github"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="github" href="https://github.com/seifrajhi" title="Saifeddine Rajhi on Github" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><span>GitHub</span></a></li><li class="social-item social-email"><a itemProp="email" eventCategory="social" eventAction="click" eventLabel="email" href="mailto:rajhiseif@gmail.com" title="Saifeddine Rajhi&#x27;s Email"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope" class="svg-inline--fa fa-envelope fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"></path></svg><span>Email</span></a></li><li class="social-item social-X/Twitter"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="X/Twitter" href="https://x.com/RajhiSaifeddine" title="Saifeddine Rajhi on X/X/Twitter" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="x-twitter" class="svg-inline--fa fa-x-twitter fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></svg><span>X/Twitter</span></a></li><li class="social-item social-reddit"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="reddit" href="https://www.reddit.com/user/ScoreApprehensive992/" title="Saifeddine Rajhi on Reddit" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="reddit-alien" class="svg-inline--fa fa-reddit-alien fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M373 138.6c-25.2 0-46.3-17.5-51.9-41l0 0c-30.6 4.3-54.2 30.7-54.2 62.4l0 .2c47.4 1.8 90.6 15.1 124.9 36.3c12.6-9.7 28.4-15.5 45.5-15.5c41.3 0 74.7 33.4 74.7 74.7c0 29.8-17.4 55.5-42.7 67.5c-2.4 86.8-97 156.6-213.2 156.6S45.5 410.1 43 323.4C17.6 311.5 0 285.7 0 255.7c0-41.3 33.4-74.7 74.7-74.7c17.2 0 33 5.8 45.7 15.6c34-21.1 76.8-34.4 123.7-36.4l0-.3c0-44.3 33.7-80.9 76.8-85.5C325.8 50.2 347.2 32 373 32c29.4 0 53.3 23.9 53.3 53.3s-23.9 53.3-53.3 53.3zM157.5 255.3c-20.9 0-38.9 20.8-40.2 47.9s17.1 38.1 38 38.1s36.6-9.8 37.8-36.9s-14.7-49.1-35.7-49.1zM395 303.1c-1.2-27.1-19.2-47.9-40.2-47.9s-36.9 22-35.7 49.1c1.2 27.1 16.9 36.9 37.8 36.9s39.3-11 38-38.1zm-60.1 70.8c1.5-3.6-1-7.7-4.9-8.1c-23-2.3-47.9-3.6-73.8-3.6s-50.8 1.3-73.8 3.6c-3.9 .4-6.4 4.5-4.9 8.1c12.9 30.8 43.3 52.4 78.7 52.4s65.8-21.6 78.7-52.4z"></path></svg><span>Reddit</span></a></li><li class="social-item social-stackoverflow"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="StackOverflow" href="https://stackoverflow.com/users/21897244/saifeddine-rajhi" title="Saifeddine Rajhi on StackOverflow" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="stack-overflow" class="svg-inline--fa fa-stack-overflow fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M290.7 311L95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"></path></svg><span>StackOverflow</span></a></li><li class="social-item social-Goodreads"><a rel="me" eventLabel="StackOverflow" href="https://www.goodreads.com/user/show/176103378-saifeddine" title="Saifeddine Rajhi on Goodreads" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="goodreads" class="svg-inline--fa fa-goodreads fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M299.9 191.2c5.1 37.3-4.7 79-35.9 100.7-22.3 15.5-52.8 14.1-70.8 5.7-37.1-17.3-49.5-58.6-46.8-97.2 4.3-60.9 40.9-87.9 75.3-87.5 46.9-.2 71.8 31.8 78.2 78.3zM448 88v336c0 30.9-25.1 56-56 56H56c-30.9 0-56-25.1-56-56V88c0-30.9 25.1-56 56-56h336c30.9 0 56 25.1 56 56zM330 313.2s-.1-34-.1-217.3h-29v40.3c-.8.3-1.2-.5-1.6-1.2-9.6-20.7-35.9-46.3-76-46-51.9.4-87.2 31.2-100.6 77.8-4.3 14.9-5.8 30.1-5.5 45.6 1.7 77.9 45.1 117.8 112.4 115.2 28.9-1.1 54.5-17 69-45.2.5-1 1.1-1.9 1.7-2.9.2.1.4.1.6.2.3 3.8.2 30.7.1 34.5-.2 14.8-2 29.5-7.2 43.5-7.8 21-22.3 34.7-44.5 39.5-17.8 3.9-35.6 3.8-53.2-1.2-21.5-6.1-36.5-19-41.1-41.8-.3-1.6-1.3-1.3-2.3-1.3h-26.8c.8 10.6 3.2 20.3 8.5 29.2 24.2 40.5 82.7 48.5 128.2 37.4 49.9-12.3 67.3-54.9 67.4-106.3z"></path></svg><span>Goodreads</span></a></li><li class="social-item social-osi"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="StackOverflow" href="https://ossinsight.io/analyze/seifrajhi" title="Saifeddine Rajhi on OSSInsights" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="osi" class="svg-inline--fa fa-osi fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M8 266.44C10.3 130.64 105.4 34 221.8 18.34c138.8-18.6 255.6 75.8 278 201.1 21.3 118.8-44 230-151.6 274-9.3 3.8-14.4 1.7-18-7.7q-26.7-69.45-53.4-139c-3.1-8.1-1-13.2 7-16.8 24.2-11 39.3-29.4 43.3-55.8a71.47 71.47 0 0 0-64.5-82.2c-39-3.4-71.8 23.7-77.5 59.7-5.2 33 11.1 63.7 41.9 77.7 9.6 4.4 11.5 8.6 7.8 18.4q-26.85 69.9-53.7 139.9c-2.6 6.9-8.3 9.3-15.5 6.5-52.6-20.3-101.4-61-130.8-119-24.9-49.2-25.2-87.7-26.8-108.7zm20.9-1.9c.4 6.6.6 14.3 1.3 22.1 6.3 71.9 49.6 143.5 131 183.1 3.2 1.5 4.4.8 5.6-2.3q22.35-58.65 45-117.3c1.3-3.3.6-4.8-2.4-6.7-31.6-19.9-47.3-48.5-45.6-86 1-21.6 9.3-40.5 23.8-56.3 30-32.7 77-39.8 115.5-17.6a91.64 91.64 0 0 1 45.2 90.4c-3.6 30.6-19.3 53.9-45.7 69.8-2.7 1.6-3.5 2.9-2.3 6q22.8 58.8 45.2 117.7c1.2 3.1 2.4 3.8 5.6 2.3 35.5-16.6 65.2-40.3 88.1-72 34.8-48.2 49.1-101.9 42.3-161-13.7-117.5-119.4-214.8-255.5-198-106.1 13-195.3 102.5-197.1 225.8z"></path></svg><span>OSSInsights</span></a></li><li class="social-item social-devstats"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="StackOverflow" href="https://devstats.cluster.fun/?user=seifrajhi" title="Saifeddine Rajhi on DevStats" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chart-line" class="svg-inline--fa fa-chart-line fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M64 64c0-17.7-14.3-32-32-32S0 46.3 0 64L0 400c0 44.2 35.8 80 80 80l400 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 416c-8.8 0-16-7.2-16-16L64 64zm406.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L320 210.7l-57.4-57.4c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L240 221.3l57.4 57.4c12.5 12.5 32.8 12.5 45.3 0l128-128z"></path></svg><span>DevStats</span></a></li><li class="social-item social-RSS"><a rel="me" itemProp="url" eventCategory="social" eventAction="click" eventLabel="RSS" href="https://seifrajhi.github.io/rss.xml" title="Subscribe to my blog post" target="blank"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" class="svg-inline--fa fa-rss fa-beat fa-2x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM0 416a64 64 0 1 1 128 0A64 64 0 1 1 0 416zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg><span>RSS</span></a></li></ul></div><div class="copyright">Saifeddine Rajhi ¬© 1994 - <!-- -->2024<!-- --> <br/><a rel="license" href="https://creativecommons.org/licenses/by/4.0/" title="Content is published under CC BY 4.0 license">CC BY 4.0</a></div><div class="pgp"><a href="https://keybase.io/saifrajhi">0C3B BABB 8BC1 EA2B</a></div></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/eks-avoid-ip-exhaustion-practices/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-5c8926d86913c79c4dbb.js\"],\"component---cache-caches-gatsby-plugin-offline-app-shell-js\":[\"/component---cache-caches-gatsby-plugin-offline-app-shell-js-88fb5c28d68e831e730a.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-83bdb4e48c18bf191297.js\"],\"component---src-pages-blog-js\":[\"/component---src-pages-blog-js-c30054b9e13d83b88b5e.js\"],\"component---src-pages-cv-platform-engineer-js\":[\"/component---src-pages-cv-platform-engineer-js-13625961a6abec0cbdf1.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-391336a56f413aaa34c1.js\"],\"component---src-pages-talks-js\":[\"/component---src-pages-talks-js-cc5a934ffcf874b77579.js\"],\"component---src-pages-thoughts-js\":[\"/component---src-pages-thoughts-js-1d43cbe28697ce8b330b.js\"],\"component---src-templates-blog-template-js\":[\"/component---src-templates-blog-template-js-b3ac88add71785f6b22b.js\"],\"component---src-templates-talk-template-js\":[\"/component---src-templates-talk-template-js-f960de7e8a0d21f392e0.js\"],\"component---src-templates-thought-template-js\":[\"/component---src-templates-thought-template-js-4e873e19a182fe3c30b3.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="8585efe6ca0382d5f7aa";</script><script src="/webpack-runtime-997ea8b0ad9f8f2ae5c4.js" async></script><script src="/framework-c989293af61a95023f7f.js" async></script><script src="/app-5c8926d86913c79c4dbb.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>