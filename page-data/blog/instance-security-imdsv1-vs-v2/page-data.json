{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/instance-security-imdsv1-vs-v2/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Securing Your AWS Environment</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>In this blog post, we will dive into the security aspects of AWS, specifically focusing on the Instance Metadata Service (IMDS) v1 and v2, as well as the security considerations for running applications within Kubernetes Pods and Docker containers.</p>\n<div style=\"width:100%;height:0;padding-bottom:56%;position:relative;\"><iframe src=\"https://giphy.com/embed/JykvbWfXtAHSM\" width=\"100%\" height=\"100%\" style=\"position:absolute\" frameborder=\"0\" class=\"giphy-embed\" allowfullscreen></iframe></div>\n<h2 id=\"-understanding-aws-instance-metadata-service-imds\" style=\"position:relative;\"><a href=\"#-understanding-aws-instance-metadata-service-imds\" aria-label=\" understanding aws instance metadata service imds permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Understanding AWS Instance Metadata Service (IMDS)</h2>\n<p>Instance metadata (IMDS), also known as the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">Instance Metadata Service</a>, contains important information about an EC2 instance within the Amazon Web Services (AWS) environment. This data includes details such as the Amazon Machine Image (AMI) used to launch the instance, its IP address, hostname, and other essential parameters. Additionally, users have the option to include User Data in the Instance Metadata, enabling them to store custom parameters that can be retrieved from within the instance.</p>\n<p>Throughout its development, AWS implemented different access models for IMDS. Initially, a request/response access model allowed access to IMDS by making a simple HTTP request from the host. However, to enhance security, a session-oriented system was later introduced, requiring a token for access. This update led to the introduction of IMDSv2, marked by the implementation of a token-based authentication mechanism.</p>\n<p>To strengthen security and defend against potential vulnerabilities like open <a href=\"https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/\" target=\"_blank\" rel=\"noopener noreferrer\">firewalls, reverse proxies, and Server-Side Request Forgery (SSRF)</a>, AWS made significant enhancements to the EC2 Instance Metadata Service. These improvements are aimed at bolstering defense-in-depth strategies, providing a more robust and secure environment for EC2 instances.</p>\n<p>For more details, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h3 id=\"-an-example-of-working-with-imdsv1\" style=\"position:relative;\"><a href=\"#-an-example-of-working-with-imdsv1\" aria-label=\" an example of working with imdsv1 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê An Example of Working with IMDSv1</h3>\n<p>For example, let's start an EC2 instance and add some value to User Data:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 616px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 122.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVR42u1U2a6DIBTs/39nK6ssyiJo4Q7UvjTV9j7e5E5OQGOGOQvjxftwvQ0DoZQyQhmf4rrdz7F11FovMS6EMcrYCmzb+gmgLcvivG9kH8JAIMkoIYM0NmSckL84oisvizZGSMEYZ1wgca0NUjuhIVnnunKIUUoppGScY+VtG03I5UPh951MuTDGeO+dDzhyds7FD4njcynlklJC2UtKOWd0om3bvTxbeohdOYTbrU1KypGgc3JUPrV5HEdr6aNhEJPjCPFSKzLpki2rowAtxOeo2tCcm2c3TbM21kYUU79EmzPGQ/r1ug6E63ntWZ3HXjOGprTGgEalsE7W1p7/OdZHt3FJXj58kzDEd3L9Pf7Jf40MY8BD7+9RLTDnW0fCyI2c8wpjjA1KKS2ExIpnBNxm7dStdvAnATnlFEJEAPAa9scrrA6FE1f9ACi9gv3YgBekAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"IMDS Example\" title=\"\" src=\"/static/c702021c6a3b6714ad765c45b32fab61/40040/imds.png\" srcset=\"/static/c702021c6a3b6714ad765c45b32fab61/04472/imds.png 170w,\n/static/c702021c6a3b6714ad765c45b32fab61/9f933/imds.png 340w,\n/static/c702021c6a3b6714ad765c45b32fab61/40040/imds.png 616w\" sizes=\"(max-width: 616px) 100vw, 616px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Now, try curling the address <code class=\"language-text\">169.254.169.254</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://169.254.169.254/latest/user-data\nsomedata: somevalue</code></pre></div>\n<p>Or get the metadata of the instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data\nami-id\nami-launch-index\nami-manifest-path\nblock-device-mapping/\nevents/\n<span class=\"token function\">hostname</span>\nidentity-credentials/\ninstance-action\ninstance-id\ninstance-life-cycle\ninstance-type\nlocal-hostname\nlocal-ipv4\nmac\nmetrics/\nnetwork/\nplacement/\nprofile\npublic-hostname\npublic-ipv4\npublic-keys/\nreservation-id\nsecurity-groups\nservices/</code></pre></div>\n<h3 id=\"-accessing-imds-from-a-docker-container\" style=\"position:relative;\"><a href=\"#-accessing-imds-from-a-docker-container\" aria-label=\" accessing imds from a docker container permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üê≥ Accessing IMDS from a Docker Container</h3>\n<p>Run the same request from a Docker container:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-172-31-30-97:/<span class=\"token comment\"># docker run -ti alpine/curl curl http://169.254.169.254/latest/meta-data/</span>\nUnable to <span class=\"token function\">find</span> image <span class=\"token string\">'alpine/curl:latest'</span> locally\nlatest: Pulling from alpine/curl\n59bf1c3509f3: Pull complete\nda353f38084f: Pull complete\n05df90dbd213: Pull complete\nDigest: sha256:81372de8c566f2d731bde924bed45230018e6d7c21d051c15e283eb8e06dfa2d\nStatus: Downloaded newer image <span class=\"token keyword\">for</span> alpine/curl:latest\nami-id\nami-launch-index\nami-manifest-path\nblock-device-mapping/\nevents/\n<span class=\"token function\">hostname</span></code></pre></div>\n<h3 id=\"Ô∏è-accessing-imds-from-a-kubernetes-pod\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-accessing-imds-from-a-kubernetes-pod\" aria-label=\"Ô∏è accessing imds from a kubernetes pod permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ò∏Ô∏è Accessing IMDS from a Kubernetes Pod</h3>\n<p>In the case of Kubernetes, any Pod can also get this data. To check, let's create a pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>imds\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>imds\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alpine/curl<span class=\"token punctuation\">:</span>latest\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> sleep\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3600\"</span>\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n    <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Always</code></pre></div>\n<p>Apply it now:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl apply <span class=\"token parameter variable\">-f</span> pod-imds.yaml</code></pre></div>\n<p>And run the same request with curl from this Pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-ti</span> test-imds -- <span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data/\nami-id\nami-launch-index\nami-manifest-path\nautoscaling/\nblock-device-mapping/\nevents/\n<span class=\"token function\">hostname</span>\niam/\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>For more information, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h2 id=\"-imds-security-credentials-the-issue\" style=\"position:relative;\"><a href=\"#-imds-security-credentials-the-issue\" aria-label=\" imds security credentials the issue permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîí IMDS Security Credentials: The Issue</h2>\n<p>Among other data, IMDS can return the Access/Secret keys and token used to access the Instance IAM Role.</p>\n<h3 id=\"-lets-get-security-credentials\" style=\"position:relative;\"><a href=\"#-lets-get-security-credentials\" aria-label=\" lets get security credentials permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîë Let's Get Security Credentials</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T12:48:33Z\"</span>,\n    <span class=\"token string\">\"Type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AWS-HMAC\"</span>,\n    <span class=\"token string\">\"AccessKeyId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"******BND\"</span>,\n    <span class=\"token string\">\"SecretAccessKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"******8Bx\"</span>,\n    <span class=\"token string\">\"Token\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"******GaQ=\"</span>,\n    <span class=\"token string\">\"Expiration\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T18:51:13Z\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>By utilizing the Access and Secret keys, we gain full permission to perform actions that are allowed for the instance. For instance, if the IAM role associated with the instance possesses AdminAccess permissions, we can inherit these extensive rights.</p>\n<h3 id=\"-verify-and-attach-a-new-role\" style=\"position:relative;\"><a href=\"#-verify-and-attach-a-new-role\" aria-label=\" verify and attach a new role permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Verify and Attach a New Role</h3>\n<p>To verify this, let's proceed by attaching a new role that grants access to S3 buckets to the instance.</p>\n<h4 id=\"-check-the-role-in-the-metadata\" style=\"position:relative;\"><a href=\"#-check-the-role-in-the-metadata\" aria-label=\" check the role in the metadata permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Check the Role in the Metadata</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T13:34:51Z\"</span>,\n    <span class=\"token string\">\"InstanceProfileArn\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::********:instance-profile/IMDSTestS3ReadOnlyAccess\"</span>,\n    <span class=\"token string\">\"InstanceProfileId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AIPAXPNJUS3H7XEB7UT24\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"-get-the-keys-and-token\" style=\"position:relative;\"><a href=\"#-get-the-keys-and-token\" aria-label=\" get the keys and token permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Get the Keys and Token</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/security-credentials/IMDSTestS3ReadOnlyAccess</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T13:35:16Z\"</span>,\n    <span class=\"token string\">\"Type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AWS-HMAC\"</span>,\n    <span class=\"token string\">\"AccessKeyId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*******PJ\"</span>,\n    <span class=\"token string\">\"SecretAccessKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*******2n\"</span>,\n    <span class=\"token string\">\"Token\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*******4a\"</span>,\n    <span class=\"token string\">\"Expiration\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T20:09:51Z\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Add them to our working machine in <code class=\"language-text\">~/.aws/credentials</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">testimds</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">aws_access_key_id</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">*******PJ</span>\n<span class=\"token key attr-name\">aws_secret_access_key</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">*******2n</span>\n<span class=\"token key attr-name\">aws_session_token</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">*******4a</span></code></pre></div>\n<p>And create a profile in the <code class=\"language-text\">~/.aws/config</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">profile testimds</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">region</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">eu-west-1</span>\n<span class=\"token key attr-name\">output</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">json</span></code></pre></div>\n<h4 id=\"-check-the-access-now\" style=\"position:relative;\"><a href=\"#-check-the-access-now\" aria-label=\" check the access now permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Check the Access Now</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> testimds s3 <span class=\"token function\">ls</span>\n<span class=\"token number\">2023</span>-12-12 <span class=\"token number\">14</span>:20:01 imdsbucket-test</code></pre></div>\n<p>Access permissions to IMDS can lead to potential security risks. To mitigate these risks, there are two primary options: completely disabling IMDS or transitioning to IMDS version 2.</p>\n<h3 id=\"-disabling-imds\" style=\"position:relative;\"><a href=\"#-disabling-imds\" aria-label=\" disabling imds permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üö´ Disabling IMDS</h3>\n<p>Disabling IMDS can be achieved for EC2 instances using the AWS CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> prod ec2 modify-instance-metadata-options --instance-id i-1d4c0e351255ba2b4 --http-endpoint disabled\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-1d4c0e351255ba2b4\"</span>,\n    <span class=\"token string\">\"InstanceMetadataOptions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"State\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pending\"</span>,\n        <span class=\"token string\">\"HttpTokens\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"optional\"</span>,\n        <span class=\"token string\">\"HttpPutResponseHopLimit\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n        <span class=\"token string\">\"HttpEndpoint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>,\n        <span class=\"token string\">\"HttpProtocolIpv6\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>,\n        <span class=\"token string\">\"InstanceMetadataTags\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"Ô∏è-modifying-instance-metadata-options-via-aws-console\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-modifying-instance-metadata-options-via-aws-console\" aria-label=\"Ô∏è modifying instance metadata options via aws console permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Modifying Instance Metadata Options via AWS Console</h2>\n<p>You can also modify the instance metadata options through the AWS Console:</p>\n<ol>\n<li>Navigate to <strong>EC2</strong>.</li>\n<li>Go to <strong>Instance Settings</strong>.</li>\n<li>Select <strong>Modify instance metadata options</strong>.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 510px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 98.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDUlEQVR42o2U647aMBCFef+X6Y9KfYWq0rZbqaVdbSksggRycQJOfMNJ6GeHoK26iI5GjnF8Zs6cmTBTSsmmPcqmadVBSuvcOdowDHmeJ0mS3raZqCpR10UpSlHlRUmQk/fudMKbVyabN2y2XK1+r17Wm83yZf30/Csvy6OU+D7LW23cFAg3zoWN98NEbaaN2WyTbZpuk53Smtdkxlul8KquD8djfTjEp2SFIDEA94AJlxdYaYwl2HkyzrU2FThoyAY5QHOn67q+7y9g730db3gfTvk5hoCAUjpDBlGzlKUoCoGuI/JCG4ZJuuPSPsu26W692UKed9ZaMgeuspFBrpaFLCQHeAFTWLrbEboQIiuKdJ8Ri9sU3yrNOe2AGOyqKABMrHWTYNr4roMzhNmc/PjsqYE9bUceVhulPr8SJYDPtw2wMoZ2GGtxHRWNNoGH1wd/GwRAkvMCRgbnrjfvZIYok9tqVNdj2xnhQAQ6WlPcrBRiv8/o579geCIPr2K3jwiHYFcnLIKFyAR7k7aNg0nPXfAwfP1EG0XvCNYS2xhoj8rFjR4P79QMozjREtLXwfrfVpFgnNzwncUJx9GAvPfBSCtEjVph4NzJxYGhd+gciupu14wswPha4+Tn9CmkbkPL2rbhqyXSbfAwbJJk/vPpebHgT2KxXH2bzx++fP34+P3hx+Ld+w+fPj/+AaQ+gmBnsUy6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Modify Instance Metadata Options\" title=\"\" src=\"/static/5e46b45e92c1014defc134c093a1fdf5/0abdd/metadata.png\" srcset=\"/static/5e46b45e92c1014defc134c093a1fdf5/04472/metadata.png 170w,\n/static/5e46b45e92c1014defc134c093a1fdf5/9f933/metadata.png 340w,\n/static/5e46b45e92c1014defc134c093a1fdf5/0abdd/metadata.png 510w\" sizes=\"(max-width: 510px) 100vw, 510px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Now, when requesting metadata, you will encounter a <code class=\"language-text\">403 - Forbidden</code> error:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"iso-8859-1\"</span>?<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html PUBLIC <span class=\"token string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span>\n<span class=\"token string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html <span class=\"token assign-left variable\">xmlns</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://www.w3.org/1999/xhtml\"</span> xml:lang<span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span> <span class=\"token assign-left variable\">lang</span><span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">403</span> - Forbidden<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></code></pre></div>\n<h2 id=\"-transitioning-to-imdsv2\" style=\"position:relative;\"><a href=\"#-transitioning-to-imdsv2\" aria-label=\" transitioning to imdsv2 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Transitioning to IMDSv2</h2>\n<p>To enhance security, consider transitioning from IMDSv1 to IMDSv2. By disabling IMDSv1 and exclusively utilizing IMDSv2, you can ensure improved protection through the mandatory use of tokens. To achieve this, add the <code class=\"language-text\">--http-tokens</code> parameter when accessing the IMDS:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ aws <span class=\"token parameter variable\">--profile</span> internal ec2 modify-instance-metadata-options --instance-id i-1d4c0e351255ba2b4 --http-endpoint enabled --http-tokens required\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-1d4c0e351255ba2b4\"</span>,\n    <span class=\"token string\">\"InstanceMetadataOptions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"State\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pending\"</span>,\n        <span class=\"token string\">\"HttpTokens\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"required\"</span>,\n        <span class=\"token string\">\"HttpPutResponseHopLimit\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n        <span class=\"token string\">\"HttpEndpoint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"enabled\"</span>,\n        <span class=\"token string\">\"HttpProtocolIpv6\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>,\n        <span class=\"token string\">\"InstanceMetadataTags\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, you will encounter a <code class=\"language-text\">401 - Unauthorized</code> error:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"iso-8859-1\"</span>?<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html PUBLIC <span class=\"token string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span>\n<span class=\"token string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html <span class=\"token assign-left variable\">xmlns</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://www.w3.org/1999/xhtml\"</span> xml:lang<span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span> <span class=\"token assign-left variable\">lang</span><span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">401</span> - Unauthorized<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></code></pre></div>\n<p>By introducing the token, all functionalities will continue to operate smoothly. Now, let's proceed to obtain the token:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">TOKEN</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> PUT <span class=\"token string\">\"http://169.254.169.254/latest/api/token\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-aws-ec2-metadata-token-ttl-seconds: 21600\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$TOKEN</span>\"</span></code></pre></div>\n<p>Subsequently, execute the curl command once more, this time including the <code class=\"language-text\">X-aws-ec2-metadata-token</code> header:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-08-06T13:34:51Z\"</span>,\n    <span class=\"token string\">\"InstanceProfileArn\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::******799:instance-profile/IMDSTestS3ReadOnlyAccess\"</span>,\n    <span class=\"token string\">\"InstanceProfileId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"XXXXXXXXXXXXXXXXXXXXXXXXXX\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"-using-terraform-modules\" style=\"position:relative;\"><a href=\"#-using-terraform-modules\" aria-label=\" using terraform modules permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì¶ Using Terraform Modules</h2>\n<p>When employing Terraform modules to establish Node Groups, it's essential to carefully consider the provided choices. For instance, the module <a href=\"https://registry.terraform.io/modules/cloudposse/eks-node-group/aws/latest\" target=\"_blank\" rel=\"noopener noreferrer\">cloudposse/terraform-aws-eks-node-group</a> enables IMDSv2 by default. Refer to the <a href=\"https://github.com/cloudposse/terraform-aws-eks-node-group/blob/main/docs/migration-v1-v2.md#behavior-changes\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Behavior changes</strong></a> section for further details.</p>\n<p>For more information, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h2 id=\"-working-with-imdsv2-and-docker-integration\" style=\"position:relative;\"><a href=\"#-working-with-imdsv2-and-docker-integration\" aria-label=\" working with imdsv2 and docker integration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üê≥ Working with IMDSv2 and Docker Integration</h2>\n<p>When employing containers alongside IMDSv2 activation, complications might arise when attempting to obtain the token. For instance:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 21.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtklEQVR42n2P3Q6CMAyFB2NjgzFgyACj4v/7PyDm2II3JsaLL2c9bXM6cQn5sutzVFqjLlgzVCpBmQk4otIJKUEe+55qn29a5+nXu6Q5EZxZ5iFgHgPOU4dj9Ni3CrHKMHiFQyA6vXKfLKZGkU+9WmH8wDUrh4qxdcvtEPE8RTyOEZepwUwXXweDrpRorcTOSTQ2RU8hhRSw6W+4J7rCvhpr4A192Wo4LdckhgdMusELJtmW/vEGG5JZxxVy+L8AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/c5bb3/docker.png\" srcset=\"/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/04472/docker.png 170w,\n/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/9f933/docker.png 340w,\n/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/c5bb3/docker.png 680w,\n/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/5a190/docker.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>To mitigate this issue, introduce a parameter named <code class=\"language-text\">http-put-response-hop-limit</code>, assigning it a value exceeding 1. This precaution is necessary due to an additional network hop introduced by containerized calls when relaying a request from a client to IMDS. The initial hop originates from the host, while the subsequent one emerges from a container residing on the same host.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> internal ec2 modify-instance-metadata-options --http-endpoint enabled --http-tokens required --http-put-response-hop-limit <span class=\"token number\">2</span> --instance-id i-1c3c0e351255ba1c3\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-1c3c0e351255ba1c3\"</span>,\n    <span class=\"token string\">\"InstanceMetadataOptions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"State\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pending\"</span>,\n        <span class=\"token string\">\"HttpTokens\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"required\"</span>,\n        <span class=\"token string\">\"HttpPutResponseHopLimit\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,\n        <span class=\"token string\">\"HttpEndpoint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"enabled\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And run again:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdklEQVR42oWS627bMAxGKUvx3ZHjKJbjOHHSLOtlQIG9/6vF+EbKNdBsLfbjQBfQhxRNujTxvXEahdaoYo3cRChWCiWTa0IWUVjlLPuvSCWGKYwCuSq/j53Dee9w6Xc4OIvjNsaTT7GvV2grE1ZvV0Fqk4hRqNPogSqeC6CjS++vpwq3ocT7tUbfJPyxQbueRR3TM9tCw5V6vmO5JB0YifOMZWkQeltMUtmPY4vbyYcKh2auTMSHDQuZk0sw7pJwL3KR7kqDRPGTmUzPraGuTqZ2rbHl7N4yss9NCF7w61WoRGRLb0N/meKD5Y78hqaxI3QbhcOO0FruSU5oSkKdETa8zwwhJuajGiHXX0O9o+n9hfD7F+E2Kvw8E65Hhbcr4fWJ8HxW8LXihISBE0rSfit/9BshB023E80C5uVCGPcK10ESUJBJYBU/8m2FNjNTU/DTmHVKsJnMlczhfJZ1mcVlLj+f/xEWJpoeBvVTk//38d/IYP8Bqw/gBWnKPo0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/8dfbb46836edf17adef133e5d7a3733e/c5bb3/docker2.png\" srcset=\"/static/8dfbb46836edf17adef133e5d7a3733e/04472/docker2.png 170w,\n/static/8dfbb46836edf17adef133e5d7a3733e/9f933/docker2.png 340w,\n/static/8dfbb46836edf17adef133e5d7a3733e/c5bb3/docker2.png 680w,\n/static/8dfbb46836edf17adef133e5d7a3733e/5a190/docker2.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-recommendations\" style=\"position:relative;\"><a href=\"#-recommendations\" aria-label=\" recommendations permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Recommendations</h2>\n<p>Below are other key steps and measures to enhance security and optimize the usage of AWS EKS cluster:</p>\n<h3 id=\"-update-the-aws-node-daemonset-to-utilize-irsa\" style=\"position:relative;\"><a href=\"#-update-the-aws-node-daemonset-to-utilize-irsa\" aria-label=\" update the aws node daemonset to utilize irsa permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìà Update the aws-node Daemonset to Utilize IRSA</h3>\n<p>Currently, the aws-node daemonset employs an EC2 instance-assigned role for IP assignment to pods. This role includes various AWS managed policies, e.g., <code class=\"language-text\">AmazonEKS_CNI_Policy</code> and <code class=\"language-text\">EC2ContainerRegistryReadOnly</code>, posing a security risk. To mitigate this, consider updating the aws-node daemonset to use IRSA, following the script in the repository for this guide, to update the aws-node daemonset to use IRSA.</p>\n<h3 id=\"-limit-access-to-the-worker-nodes-instance-profile\" style=\"position:relative;\"><a href=\"#-limit-access-to-the-worker-nodes-instance-profile\" aria-label=\" limit access to the worker nodes instance profile permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîí Limit Access to the Worker Node's Instance Profile</h3>\n<p>When you use IRSA, it updates the credential chain of the pod to use the IRSA token. However, the pod can still inherit the rights of the instance profile assigned to the worker node. When using IRSA, it is strongly recommended that you block access to instance metadata to minimize the blast radius of a breach.</p>\n<p>You can block access to instance metadata by requiring the instance to use IMDSv2 only and updating the hop count to 1 as in the example below. You can also include these settings in the node group's launch template. Do not disable instance metadata as this will prevent components like the node termination handler and other things that rely on instance metadata from working properly.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws ec2 modify-instance-metadata-options --instance-id <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span> --http-tokens required --http-put-response-hop-limit <span class=\"token number\">1</span></code></pre></div>\n<p>If you are using Terraform to create launch templates for use with Managed Node Groups, add the metadata block to configure the hop count as seen in this code snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_launch_template\"</span></span> <span class=\"token string\">\"foo\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"foo\"</span>\n  ...\n  <span class=\"token keyword\">metadata_options</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">http_endpoint</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"enabled\"</span>\n    <span class=\"token property\">http_tokens</span>                 <span class=\"token punctuation\">=</span> <span class=\"token string\">\"required\"</span>\n    <span class=\"token property\">http_put_response_hop_limit</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">1</span>\n    <span class=\"token property\">instance_metadata_tags</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"enabled\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can also block a pod's access to EC2 metadata by manipulating iptables on the node. For further information about this method, see <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html\" target=\"_blank\" rel=\"noopener noreferrer\">Limiting access to the instance metadata service</a>.</p>\n<h3 id=\"-update-the-aws-sdk-version\" style=\"position:relative;\"><a href=\"#-update-the-aws-sdk-version\" aria-label=\" update the aws sdk version permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Update the AWS SDK Version</h3>\n<p>If you have an application that is using an older version of the AWS SDK that doesn't support IRSA, you should update the SDK version.</p>\n<h3 id=\"-scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name\" style=\"position:relative;\"><a href=\"#-scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name\" aria-label=\" scope the iam role trust policy for irsa to the service account name permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Scope the IAM Role Trust Policy for IRSA to the Service Account Name</h3>\n<p>The trust policy can be scoped to a Namespace or a specific service account within a Namespace. When using IRSA, it's best to make the role trust policy as explicit as possible by including the service account name. This will effectively prevent other Pods within the same Namespace from assuming the role. The CLI <code class=\"language-text\">eksctl</code> will do this automatically when you use it to create service accounts/IAM roles. See <a href=\"https://eksctl.io/usage/iamserviceaccounts/\" target=\"_blank\" rel=\"noopener noreferrer\">eksctl documentation</a> for further information.</p>\n<h3 id=\"Ô∏è-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2\" aria-label=\"Ô∏è use imdsv2 and increase the hop limit on ec2 instances to 2 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Use IMDSv2 and Increase the Hop Limit on EC2 Instances to 2</h3>\n<p>IMDSv2 requires you to use a PUT request to get a session token. The initial PUT request has to include a TTL for the session token. Newer versions of the AWS SDKs will handle this and the renewal of said token automatically. It's also important to be aware that the default hop limit on EC2 instances is intentionally set to 1 to prevent IP forwarding. As a consequence, Pods that request a session token that are run on EC2 instances may eventually time out and fallback to using the IMDSv1 data flow. EKS adds support for IMDSv2 by enabling both v1 and v2 and changing the hop limit to 2 on nodes provisioned by <code class=\"language-text\">eksctl</code> or with the official CloudFormation templates.</p>\n<p>For more information, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h2 id=\"Ô∏è-conclusion\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-conclusion\" aria-label=\"Ô∏è conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚≠êÔ∏è Conclusion</h2>\n<p>In this blog post, we have conducted a comprehensive analysis of the security considerations of AWS Instance Metadata Service (IMDS) v1 and IMDS v2, as well as their interactions with Kubernetes Pods and Docker Containers. By understanding the strengths and limitations of each version, and by incorporating best practices such as using <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html\" target=\"_blank\" rel=\"noopener noreferrer\">IAM Roles for Service Accounts (IRSA)</a>, restricting access to instance profiles, and leveraging IMDSv2, you can effectively secure your AWS environment and ensure its robust security posture. Protecting your assets and data is essential, and this comparative exploration provides you with the insights you need to navigate the complexities of securing your AWS infrastructure.</p>\n<p>We hope that you have found this blog post helpful. If you have any other tips or tricks that you would like to share, please leave a comment below. üí¨</p>\n<p>üîó <strong>Useful Links:</strong></p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Instance Metadata Service</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/security/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Security Blog</a></li>\n<li><a href=\"https://kubernetes.io/docs/home/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Documentation</a></li>\n<li><a href=\"https://docs.docker.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Docker Documentation</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":10,"rawMarkdownBody":"\n> **Securing Your AWS Environment**\n\n## üìå Introduction\n\nIn this blog post, we will dive into the security aspects of AWS, specifically focusing on the Instance Metadata Service (IMDS) v1 and v2, as well as the security considerations for running applications within Kubernetes Pods and Docker containers.\n\nhttps://giphy.com/gifs/natgeochannel-startalk-JykvbWfXtAHSM\n\n## üîç Understanding AWS Instance Metadata Service (IMDS)\n\nInstance metadata (IMDS), also known as the [Instance Metadata Service](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), contains important information about an EC2 instance within the Amazon Web Services (AWS) environment. This data includes details such as the Amazon Machine Image (AMI) used to launch the instance, its IP address, hostname, and other essential parameters. Additionally, users have the option to include User Data in the Instance Metadata, enabling them to store custom parameters that can be retrieved from within the instance.\n\nThroughout its development, AWS implemented different access models for IMDS. Initially, a request/response access model allowed access to IMDS by making a simple HTTP request from the host. However, to enhance security, a session-oriented system was later introduced, requiring a token for access. This update led to the introduction of IMDSv2, marked by the implementation of a token-based authentication mechanism.\n\nTo strengthen security and defend against potential vulnerabilities like open [firewalls, reverse proxies, and Server-Side Request Forgery (SSRF)](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/), AWS made significant enhancements to the EC2 Instance Metadata Service. These improvements are aimed at bolstering defense-in-depth strategies, providing a more robust and secure environment for EC2 instances.\n\nFor more details, refer to the [AWS Documentation on IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html).\n### üåê An Example of Working with IMDSv1\n\nFor example, let's start an EC2 instance and add some value to User Data:\n\n![IMDS Example](./imds.png)\n\nNow, try curling the address `169.254.169.254`:\n\n```bash\n$ curl http://169.254.169.254/latest/user-data\nsomedata: somevalue\n```\n\nOr get the metadata of the instance:\n\n```bash\n$ curl http://169.254.169.254/latest/meta-data\nami-id\nami-launch-index\nami-manifest-path\nblock-device-mapping/\nevents/\nhostname\nidentity-credentials/\ninstance-action\ninstance-id\ninstance-life-cycle\ninstance-type\nlocal-hostname\nlocal-ipv4\nmac\nmetrics/\nnetwork/\nplacement/\nprofile\npublic-hostname\npublic-ipv4\npublic-keys/\nreservation-id\nsecurity-groups\nservices/\n```\n\n### üê≥ Accessing IMDS from a Docker Container\n\nRun the same request from a Docker container:\n\n```bash\nroot@ip-172-31-30-97:/# docker run -ti alpine/curl curl http://169.254.169.254/latest/meta-data/\nUnable to find image 'alpine/curl:latest' locally\nlatest: Pulling from alpine/curl\n59bf1c3509f3: Pull complete\nda353f38084f: Pull complete\n05df90dbd213: Pull complete\nDigest: sha256:81372de8c566f2d731bde924bed45230018e6d7c21d051c15e283eb8e06dfa2d\nStatus: Downloaded newer image for alpine/curl:latest\nami-id\nami-launch-index\nami-manifest-path\nblock-device-mapping/\nevents/\nhostname\n```\n\n### ‚ò∏Ô∏è Accessing IMDS from a Kubernetes Pod\n\nIn the case of Kubernetes, any Pod can also get this data. To check, let's create a pod:\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n    name: test-imds\n    namespace: default\nspec:\n    containers:\n    - name: test-imds\n        image: alpine/curl:latest\n        command:\n            - sleep\n            - \"3600\"\n        imagePullPolicy: IfNotPresent\n    restartPolicy: Always\n```\n\nApply it now:\n\n```bash\n$ kubectl apply -f pod-imds.yaml\n```\n\nAnd run the same request with curl from this Pod:\n\n```bash\n$ kubectl exec -ti test-imds -- curl http://169.254.169.254/latest/meta-data/\nami-id\nami-launch-index\nami-manifest-path\nautoscaling/\nblock-device-mapping/\nevents/\nhostname\niam/\n...\n```\n\nFor more information, refer to the [AWS Documentation on IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html).\n\n\n## üîí IMDS Security Credentials: The Issue\n\nAmong other data, IMDS can return the Access/Secret keys and token used to access the Instance IAM Role.\n\n### üîë Let's Get Security Credentials\n\n```bash\n$ curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance\n{\n    \"Code\" : \"Success\",\n    \"LastUpdated\" : \"2023-12-12T12:48:33Z\",\n    \"Type\" : \"AWS-HMAC\",\n    \"AccessKeyId\" : \"******BND\",\n    \"SecretAccessKey\" : \"******8Bx\",\n    \"Token\" : \"******GaQ=\",\n    \"Expiration\" : \"2023-12-12T18:51:13Z\"\n}\n```\n\nBy utilizing the Access and Secret keys, we gain full permission to perform actions that are allowed for the instance. For instance, if the IAM role associated with the instance possesses AdminAccess permissions, we can inherit these extensive rights.\n\n### üîÑ Verify and Attach a New Role\n\nTo verify this, let's proceed by attaching a new role that grants access to S3 buckets to the instance.\n\n#### üìã Check the Role in the Metadata\n\n```bash\nroot@ip-172-31-30-97:/# curl http://169.254.169.254/latest/meta-data/iam/info\n{\n    \"Code\" : \"Success\",\n    \"LastUpdated\" : \"2023-12-12T13:34:51Z\",\n    \"InstanceProfileArn\" : \"arn:aws:iam::********:instance-profile/IMDSTestS3ReadOnlyAccess\",\n    \"InstanceProfileId\" : \"AIPAXPNJUS3H7XEB7UT24\"\n}\n```\n\n#### üîê Get the Keys and Token\n\n```bash\nroot@ip-172-31-30-97:/# curl http://169.254.169.254/latest/meta-data/iam/security-credentials/IMDSTestS3ReadOnlyAccess\n{\n    \"Code\" : \"Success\",\n    \"LastUpdated\" : \"2023-12-12T13:35:16Z\",\n    \"Type\" : \"AWS-HMAC\",\n    \"AccessKeyId\" : \"*******PJ\",\n    \"SecretAccessKey\" : \"*******2n\",\n    \"Token\" : \"*******4a\",\n    \"Expiration\" : \"2023-12-12T20:09:51Z\"\n}\n```\n\nAdd them to our working machine in `~/.aws/credentials`:\n\n```ini\n[testimds]\naws_access_key_id = *******PJ\naws_secret_access_key = *******2n\naws_session_token = *******4a\n```\n\nAnd create a profile in the `~/.aws/config`:\n\n```ini\n[profile testimds]\nregion = eu-west-1\noutput = json\n```\n\n#### ‚úÖ Check the Access Now\n\n```bash\n$ aws --profile testimds s3 ls\n2023-12-12 14:20:01 imdsbucket-test\n```\n\nAccess permissions to IMDS can lead to potential security risks. To mitigate these risks, there are two primary options: completely disabling IMDS or transitioning to IMDS version 2.\n\n### üö´ Disabling IMDS\n\nDisabling IMDS can be achieved for EC2 instances using the AWS CLI:\n\n```bash\n$ aws --profile prod ec2 modify-instance-metadata-options --instance-id i-1d4c0e351255ba2b4 --http-endpoint disabled\n{\n    \"InstanceId\": \"i-1d4c0e351255ba2b4\",\n    \"InstanceMetadataOptions\": {\n        \"State\": \"pending\",\n        \"HttpTokens\": \"optional\",\n        \"HttpPutResponseHopLimit\": 1,\n        \"HttpEndpoint\": \"disabled\",\n        \"HttpProtocolIpv6\": \"disabled\",\n        \"InstanceMetadataTags\": \"disabled\"\n    }\n}\n```\n\n## üõ†Ô∏è Modifying Instance Metadata Options via AWS Console\n\nYou can also modify the instance metadata options through the AWS Console:\n\n1. Navigate to **EC2**.\n2. Go to **Instance Settings**.\n3. Select **Modify instance metadata options**.\n\n![Modify Instance Metadata Options](./metadata.png)\n\nNow, when requesting metadata, you will encounter a `403 - Forbidden` error:\n\n```shell\nroot@ip-172-31-30-97:/# curl http://169.254.169.254/latest/meta-data/iam/info\n<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\n\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<title>403 - Forbidden</title>\n```\n\n## üîÑ Transitioning to IMDSv2\n\nTo enhance security, consider transitioning from IMDSv1 to IMDSv2. By disabling IMDSv1 and exclusively utilizing IMDSv2, you can ensure improved protection through the mandatory use of tokens. To achieve this, add the `--http-tokens` parameter when accessing the IMDS:\n\n```shell\n$ aws --profile internal ec2 modify-instance-metadata-options --instance-id i-1d4c0e351255ba2b4 --http-endpoint enabled --http-tokens required\n{\n    \"InstanceId\": \"i-1d4c0e351255ba2b4\",\n    \"InstanceMetadataOptions\": {\n        \"State\": \"pending\",\n        \"HttpTokens\": \"required\",\n        \"HttpPutResponseHopLimit\": 1,\n        \"HttpEndpoint\": \"enabled\",\n        \"HttpProtocolIpv6\": \"disabled\",\n        \"InstanceMetadataTags\": \"disabled\"\n    }\n}\n```\n\nNow, you will encounter a `401 - Unauthorized` error:\n\n```shell\nroot@ip-172-31-30-97:/# curl http://169.254.169.254/latest/meta-data/iam/info\n<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\n\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<title>401 - Unauthorized</title>\n```\n\nBy introducing the token, all functionalities will continue to operate smoothly. Now, let's proceed to obtain the token:\n\n```shell\nTOKEN=$(curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\necho \"$TOKEN\"\n```\n\nSubsequently, execute the curl command once more, this time including the `X-aws-ec2-metadata-token` header:\n\n```shell\nroot@ip-172-31-30-97:/# curl -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/iam/info\n{\n    \"Code\" : \"Success\",\n    \"LastUpdated\" : \"2023-08-06T13:34:51Z\",\n    \"InstanceProfileArn\" : \"arn:aws:iam::******799:instance-profile/IMDSTestS3ReadOnlyAccess\",\n    \"InstanceProfileId\" : \"XXXXXXXXXXXXXXXXXXXXXXXXXX\"\n}\n```\n\n## üì¶ Using Terraform Modules\n\nWhen employing Terraform modules to establish Node Groups, it's essential to carefully consider the provided choices. For instance, the module [cloudposse/terraform-aws-eks-node-group](https://registry.terraform.io/modules/cloudposse/eks-node-group/aws/latest) enables IMDSv2 by default. Refer to the [**Behavior changes**](https://github.com/cloudposse/terraform-aws-eks-node-group/blob/main/docs/migration-v1-v2.md#behavior-changes) section for further details.\n\nFor more information, refer to the [AWS Documentation on IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html).\n\n## üê≥ Working with IMDSv2 and Docker Integration\n\nWhen employing containers alongside IMDSv2 activation, complications might arise when attempting to obtain the token. For instance:\n\n![Alt text](./docker.png)\n\nTo mitigate this issue, introduce a parameter named `http-put-response-hop-limit`, assigning it a value exceeding 1. This precaution is necessary due to an additional network hop introduced by containerized calls when relaying a request from a client to IMDS. The initial hop originates from the host, while the subsequent one emerges from a container residing on the same host.\n\n```bash\n$ aws --profile internal ec2 modify-instance-metadata-options --http-endpoint enabled --http-tokens required --http-put-response-hop-limit 2 --instance-id i-1c3c0e351255ba1c3\n{\n    \"InstanceId\": \"i-1c3c0e351255ba1c3\",\n    \"InstanceMetadataOptions\": {\n        \"State\": \"pending\",\n        \"HttpTokens\": \"required\",\n        \"HttpPutResponseHopLimit\": 2,\n        \"HttpEndpoint\": \"enabled\"\n    }\n}\n```\n\nAnd run again:\n\n![Alt text](./docker2.png)\n\n## üîê Recommendations\n\nBelow are other key steps and measures to enhance security and optimize the usage of AWS EKS cluster:\n\n### üìà Update the aws-node Daemonset to Utilize IRSA\n\nCurrently, the aws-node daemonset employs an EC2 instance-assigned role for IP assignment to pods. This role includes various AWS managed policies, e.g., `AmazonEKS_CNI_Policy` and `EC2ContainerRegistryReadOnly`, posing a security risk. To mitigate this, consider updating the aws-node daemonset to use IRSA, following the script in the repository for this guide, to update the aws-node daemonset to use IRSA.\n\n### üîí Limit Access to the Worker Node's Instance Profile\n\nWhen you use IRSA, it updates the credential chain of the pod to use the IRSA token. However, the pod can still inherit the rights of the instance profile assigned to the worker node. When using IRSA, it is strongly recommended that you block access to instance metadata to minimize the blast radius of a breach.\n\nYou can block access to instance metadata by requiring the instance to use IMDSv2 only and updating the hop count to 1 as in the example below. You can also include these settings in the node group's launch template. Do not disable instance metadata as this will prevent components like the node termination handler and other things that rely on instance metadata from working properly.\n\n```bash\n$ aws ec2 modify-instance-metadata-options --instance-id <value> --http-tokens required --http-put-response-hop-limit 1\n```\n\nIf you are using Terraform to create launch templates for use with Managed Node Groups, add the metadata block to configure the hop count as seen in this code snippet:\n\n```hcl\nresource \"aws_launch_template\" \"foo\" {\n  name = \"foo\"\n  ...\n  metadata_options {\n    http_endpoint               = \"enabled\"\n    http_tokens                 = \"required\"\n    http_put_response_hop_limit = 1\n    instance_metadata_tags      = \"enabled\"\n  }\n}\n```\n\nYou can also block a pod's access to EC2 metadata by manipulating iptables on the node. For further information about this method, see [Limiting access to the instance metadata service](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html).\n\n### üîÑ Update the AWS SDK Version\n\nIf you have an application that is using an older version of the AWS SDK that doesn't support IRSA, you should update the SDK version.\n\n### üîê Scope the IAM Role Trust Policy for IRSA to the Service Account Name\n\nThe trust policy can be scoped to a Namespace or a specific service account within a Namespace. When using IRSA, it's best to make the role trust policy as explicit as possible by including the service account name. This will effectively prevent other Pods within the same Namespace from assuming the role. The CLI `eksctl` will do this automatically when you use it to create service accounts/IAM roles. See [eksctl documentation](https://eksctl.io/usage/iamserviceaccounts/) for further information.\n\n### üõ°Ô∏è Use IMDSv2 and Increase the Hop Limit on EC2 Instances to 2\n\nIMDSv2 requires you to use a PUT request to get a session token. The initial PUT request has to include a TTL for the session token. Newer versions of the AWS SDKs will handle this and the renewal of said token automatically. It's also important to be aware that the default hop limit on EC2 instances is intentionally set to 1 to prevent IP forwarding. As a consequence, Pods that request a session token that are run on EC2 instances may eventually time out and fallback to using the IMDSv1 data flow. EKS adds support for IMDSv2 by enabling both v1 and v2 and changing the hop limit to 2 on nodes provisioned by `eksctl` or with the official CloudFormation templates.\n\nFor more information, refer to the [AWS Documentation on IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html).\n\n\n## ‚≠êÔ∏è Conclusion\n\nIn this blog post, we have conducted a comprehensive analysis of the security considerations of AWS Instance Metadata Service (IMDS) v1 and IMDS v2, as well as their interactions with Kubernetes Pods and Docker Containers. By understanding the strengths and limitations of each version, and by incorporating best practices such as using [IAM Roles for Service Accounts (IRSA)](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html), restricting access to instance profiles, and leveraging IMDSv2, you can effectively secure your AWS environment and ensure its robust security posture. Protecting your assets and data is essential, and this comparative exploration provides you with the insights you need to navigate the complexities of securing your AWS infrastructure.\n\nWe hope that you have found this blog post helpful. If you have any other tips or tricks that you would like to share, please leave a comment below. üí¨\n\nüîó **Useful Links:**\n- [AWS Instance Metadata Service](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)\n- [AWS Security Blog](https://aws.amazon.com/blogs/security/)\n- [Kubernetes Documentation](https://kubernetes.io/docs/home/)\n- [Docker Documentation](https://docs.docker.com/)\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  _**Until next time üéâ**_\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1509},"frontmatter":{"id":"e62371c92777c755deb7e577","path":"/blog/instance-security-imdsv1-vs-v2/","humanDate":"Oct 18, 2024","fullDate":"2024-10-18","title":"AWS Security: A Comparative Analysis of Instance Metadata Service v1 vs. IMDS v2, Kubernetes Pods, and Docker Container","keywords":["AWS Security","AWS EKS","IMDS v2","Kubernetes Pods","Docker Containers","Cloud Security"],"excerpt":"Explore the differences between AWS Instance Metadata Service v1 and v2, and understand their impact on Kubernetes Pods and Docker Containers. Enhance your AWS environment security with this comprehensive analysis.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAVAQEBAAAAAAAAAAAAAAAAAAACBP/aAAwDAQACEAMQAAABySu1EywCv//EABkQAQEAAwEAAAAAAAAAAAAAAAABAhExQf/aAAgBAQABBQKOt2MVe//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAMBAQAAAAAAAAAAAAAAAAABESBB/9oACAEBAAY/AlRrhLj/xAAaEAADAAMBAAAAAAAAAAAAAAAAAREhMUFh/9oACAEBAAE/IUq4EjgNUkRm88kHufWPY//aAAwDAQACAAMAAAAQr9//xAAYEQADAQEAAAAAAAAAAAAAAAAAAREhMf/aAAgBAwEBPxDjhE9h/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAhMf/aAAgBAgEBPxDpKmX/xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhMVFB/9oACAEBAAE/EG0Benz2ZPdFSm/IAoMAiUEtxrhXIiV2zMhDE75P/9k="},"images":{"fallback":{"src":"/static/9af86a2730e60a43fd96c4ebf3b12904/07cea/imds.jpg","srcSet":"/static/9af86a2730e60a43fd96c4ebf3b12904/07cea/imds.jpg 640w","sizes":"100vw"},"sources":[{"srcSet":"/static/9af86a2730e60a43fd96c4ebf3b12904/d846e/imds.webp 640w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.525}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/eks-aws-cloudwatch-container-insights/","title":"Casting light on EKS: exploring AWS CloudWatch Container Insights for kubernetes cluster metrics and logs aggregation","date":"2024-10-18 20:06:00"},"excerpt":"Proactive EKS cluster monitoring üîñ Introduction Kubernetes on AWS is a great managed container orchestration platform, but it can be‚Ä¶"},"nextThought":{"frontmatter":{"path":"/blog/kubernetes-security/","title":"Kubernetes: Security assessment guidelines and necessary checklist","date":"2024-10-18 19:30:00"},"excerpt":"Essential Guidelines and Checklists for Kubernetes Security üìö Introduction The Kubernetes platform has become increasingly popular for‚Ä¶"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}