{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/kubernetes-containerd-cilium-setup/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Definitive Guide to Setting Up Kubernetes 1.31 with containerd v2 and Cilium</strong></p>\n</blockquote>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Introduction</h2>\n<p>Welcome to this guide on setting up Welcome to this guide on setting up <a href=\"https://kubernetes.io/blog/2024/08/13/kubernetes-v1-31-release/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes 1.31</a> with the <a href=\"https://github.com/containerd/containerd/releases/tag/v2.0.0\" target=\"_blank\" rel=\"noopener noreferrer\">containerd v2</a> runtime and <a href=\"https://isovalent.com/blog/post/cilium-1-16/\" target=\"_blank\" rel=\"noopener noreferrer\">Cilium</a> for networking. This guide is designed to be a comprehensive reference for professionals worldwide, ensuring a robust and efficient container orchestration environment with advanced networking capabilities.</p>\n<p>This guide is designed to be a comprehensive reference for professionals worldwide, ensuring an efficient container orchestration environment with advanced networking capabilities.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACsElEQVR42lWSa08TQRSGt9vtbru73V5BLFBFaEAqYqUCClrRpPESo9wqBVQqKF5iNWrVNIJKECQE0RgToyZ+9JuGH2FMiL/DxF/xeNpI1A9nZzYz88y873sU3QpxKFLHqdoYx6LbOOQE2O849HpNhvYk+fZ6meORKF1OiE5NZzU3yKt7N0m4NTKBAEnT5LSsJ0O1aGYQxW342WmHSDoRkv4w/X6HlOWnyzDprW/g+/s1pg72sMOls9f0s/G8zMKlPK2qh322TZvXoMVnUSMwVViK5nVQZOKRsT8YJeMPkA1GOGIHOBffydcnJRZGB0l5LHKJVjaelnh85gQZeW3GtOn0mSgCd8v5KqvyqcD0Shk2mlvHo3lxKR5C4VquzU4xM3MRrx2mu6eH8sMi6QNpbCtIc1MCTfa6NUMYgb/AavkCVOSrblkUsCUW1NbHyU/kmb46TUe6l7PDw1yZnSHR1s6bt+/Y3NykMb4LRVHRRfJ/QI9hoQlIUTTC0Rj9A1lGxiYoz89z536JxRcrPJqbZ2VtjaHzea4XS5TKCzQ1766e+QcoL9NNXN4Yqh4QqT4aGmJ0dO4h0Z6m+3CG4fwks7duM1GYITc5RaQxwfriPD++fGBXS7sADQH+kayKuXZ9N+VPv+jLvcQrLbP6KMvCqRSGVYMeqmNovED2bI6LV4v0DpyUQ0FGD3fy+eYAYWkZRfz2+P4FxtI8+PiTvtE1uUmjcHmIwUwB3V9He9cBllaWmXv2hOcrS4xdKhCLN9FSE2RusI1YfQrTSYpdYpmo/StZj+LSLFRVQrG2ofmlzDBHs1mmJYji3SI3ijcYL0zRk+rg80gj69kI8aYLbI8Pi13GFtCpTjxeuxqKS9UlaV0u8aH6HPmXPlMqJYG5nOro0kOkmlsJS6+6NVv22myF+xub+ExAFfRKCQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/12cdd828513870f8806426a0fb0e22b5/c5bb3/k8s-containerd-cilium-cover.png\" srcset=\"/static/12cdd828513870f8806426a0fb0e22b5/04472/k8s-containerd-cilium-cover.png 170w,\n/static/12cdd828513870f8806426a0fb0e22b5/9f933/k8s-containerd-cilium-cover.png 340w,\n/static/12cdd828513870f8806426a0fb0e22b5/c5bb3/k8s-containerd-cilium-cover.png 680w,\n/static/12cdd828513870f8806426a0fb0e22b5/b12f7/k8s-containerd-cilium-cover.png 1020w,\n/static/12cdd828513870f8806426a0fb0e22b5/b5a09/k8s-containerd-cilium-cover.png 1360w,\n/static/12cdd828513870f8806426a0fb0e22b5/0e758/k8s-containerd-cilium-cover.png 2502w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Prerequisites</h2>\n<p>Before we begin, ensure you have the following prerequisites:</p>\n<ul>\n<li>A system running <a href=\"https://releases.ubuntu.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Ubuntu 22.04 LTS</a> or higher, 64-bit x86, and kernel 6.8.</li>\n<li>Root or sudo access to the system.</li>\n<li>Basic knowledge of <a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a>, <a href=\"https://containerd.io/\" target=\"_blank\" rel=\"noopener noreferrer\">containerd</a>, and <a href=\"https://cilium.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Cilium</a>.</li>\n</ul>\n<h2 id=\"step-by-step-guide\" style=\"position:relative;\"><a href=\"#step-by-step-guide\" aria-label=\"step by step guide permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step-by-Step Guide</h2>\n<h3 id=\"1-install-required-tools\" style=\"position:relative;\"><a href=\"#1-install-required-tools\" aria-label=\"1 install required tools permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>1. Install Required Tools</h3>\n<p>First, we need to ensure that <code class=\"language-text\">figlet</code> and <code class=\"language-text\">toilet</code> are installed for printing colorful messages.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> <span class=\"token builtin class-name\">command</span> <span class=\"token parameter variable\">-v</span> figlet <span class=\"token operator\">&amp;></span> /dev/null <span class=\"token operator\">||</span> <span class=\"token operator\">!</span> <span class=\"token builtin class-name\">command</span> <span class=\"token parameter variable\">-v</span> toilet <span class=\"token operator\">&amp;></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\033\">\\033</span>[0;33mFiglet or Toilet not found, installing...\"</span>\n    <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> figlet toilet\n<span class=\"token keyword\">fi</span></code></pre></div>\n<h3 id=\"2-print-the-title\" style=\"position:relative;\"><a href=\"#2-print-the-title\" aria-label=\"2 print the title permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>2. Print the Title</h3>\n<p>Use <code class=\"language-text\">figlet</code> to print the title of the script.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">figlet <span class=\"token parameter variable\">-f</span> smblock <span class=\"token string\">\"Setup Kubernetes 1.31 with containerd v2 and Cilium\"</span></code></pre></div>\n<h3 id=\"3-disable-swap\" style=\"position:relative;\"><a href=\"#3-disable-swap\" aria-label=\"3 disable swap permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>3. Disable Swap</h3>\n<p>Disabling swap is crucial for Kubernetes to function correctly. Kubernetes requires swap to be disabled to ensure optimal performance and stability.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">swapoff <span class=\"token parameter variable\">-a</span>\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'/swap/d'</span> /etc/fstab</code></pre></div>\n<blockquote>\n<p><strong>Note</strong>: Disabling swap ensures that Kubernetes can manage resources more effectively, preventing potential issues with resource allocation.</p>\n</blockquote>\n<h3 id=\"4-load-necessary-kernel-modules\" style=\"position:relative;\"><a href=\"#4-load-necessary-kernel-modules\" aria-label=\"4 load necessary kernel modules permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>4. Load Necessary Kernel Modules</h3>\n<p>Load the required kernel modules for containerd.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/modules-load.d/containerd.conf<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\noverlay\nbr_netfilter\nEOF</span>\nmodprobe overlay\nmodprobe br_netfilter</code></pre></div>\n<h3 id=\"5-configure-sysctl-for-kubernetes\" style=\"position:relative;\"><a href=\"#5-configure-sysctl-for-kubernetes\" aria-label=\"5 configure sysctl for kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>5. Configure sysctl for Kubernetes</h3>\n<p>Configure sysctl parameters required by Kubernetes.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/sysctl.d/kubernetes.conf<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nEOF</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></code></pre></div>\n<h3 id=\"6-disable-ufw\" style=\"position:relative;\"><a href=\"#6-disable-ufw\" aria-label=\"6 disable ufw permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>6. Disable UFW</h3>\n<p>Disable the Uncomplicated Firewall (UFW) to avoid network issues.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ufw disable</code></pre></div>\n<h3 id=\"7-remove-unnecessary-packages\" style=\"position:relative;\"><a href=\"#7-remove-unnecessary-packages\" aria-label=\"7 remove unnecessary packages permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>7. Remove Unnecessary Packages</h3>\n<p>Remove unnecessary packages to avoid conflicts.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> remove containernetworking-plugins <span class=\"token parameter variable\">-y</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> remove conmon <span class=\"token parameter variable\">-y</span></code></pre></div>\n<h3 id=\"8-create-keyrings-directory\" style=\"position:relative;\"><a href=\"#8-create-keyrings-directory\" aria-label=\"8 create keyrings directory permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>8. Create Keyrings Directory</h3>\n<p>Create the keyrings directory for storing GPG keys.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/apt/keyrings/</code></pre></div>\n<h3 id=\"9-install-containerd\" style=\"position:relative;\"><a href=\"#9-install-containerd\" aria-label=\"9 install containerd permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>9. Install containerd</h3>\n<p>Download and install containerd.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/containerd/containerd/releases/download/v2.0.0/containerd-2.0.0-linux-amd64.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-C</span> /usr/local <span class=\"token parameter variable\">-xzvf</span> containerd-2.0.0-linux-amd64.tar.gz</code></pre></div>\n<h3 id=\"10-configure-containerd\" style=\"position:relative;\"><a href=\"#10-configure-containerd\" aria-label=\"10 configure containerd permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>10. Configure containerd</h3>\n<p>Create a systemd service file for containerd and start the service.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /usr/local/lib/systemd/system/\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /usr/local/lib/systemd/system/containerd.service</span>\n[Unit]\nDescription=containerd container runtime\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target dbus.service\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/containerd\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n\nLimitNPROC=infinity\nLimitCORE=infinity\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\nEOF</span>\n\nsystemctl daemon-reload\nsystemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> containerd</code></pre></div>\n<h3 id=\"11-install-runc\" style=\"position:relative;\"><a href=\"#11-install-runc\" aria-label=\"11 install runc permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>11. Install runc</h3>\n<p>Download and install runc.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/opencontainers/runc/releases/download/v1.2.1/runc.amd64\n<span class=\"token function\">install</span> <span class=\"token parameter variable\">-m</span> <span class=\"token number\">755</span> runc.amd64 /usr/local/sbin/runc</code></pre></div>\n<h3 id=\"12-install-cni-plugins\" style=\"position:relative;\"><a href=\"#12-install-cni-plugins\" aria-label=\"12 install cni plugins permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>12. Install CNI Plugins</h3>\n<p>Download and install CNI plugins.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/containernetworking/plugins/releases/download/v1.6.0/cni-plugins-linux-amd64-v1.6.0.tgz\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /opt/cni/bin\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-C</span> /opt/cni/bin <span class=\"token parameter variable\">-xzvf</span> cni-plugins-linux-amd64-v1.6.0.tgz\nsystemctl restart containerd</code></pre></div>\n<h3 id=\"13-verify-containerd-installation\" style=\"position:relative;\"><a href=\"#13-verify-containerd-installation\" aria-label=\"13 verify containerd installation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>13. Verify containerd Installation</h3>\n<p>Verify the installation of containerd.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">containerd <span class=\"token parameter variable\">-v</span></code></pre></div>\n<h3 id=\"14-add-kubernetes-repository-and-install-components\" style=\"position:relative;\"><a href=\"#14-add-kubernetes-repository-and-install-components\" aria-label=\"14 add kubernetes repository and install components permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>14. Add Kubernetes Repository and Install Components</h3>\n<p>Add the Kubernetes repository and install the necessary components.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/kubernetes.list\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> gpg <span class=\"token parameter variable\">--dearmor</span> <span class=\"token parameter variable\">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> kubelet kubeadm kubectl <span class=\"token parameter variable\">-y</span>\n<span class=\"token function\">sudo</span> apt-mark hold kubelet kubeadm kubectl</code></pre></div>\n<h3 id=\"15-output-versions-of-kubernetes-components\" style=\"position:relative;\"><a href=\"#15-output-versions-of-kubernetes-components\" aria-label=\"15 output versions of kubernetes components permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>15. Output Versions of Kubernetes Components</h3>\n<p>Output the versions of the installed Kubernetes components.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm version\nkubelet <span class=\"token parameter variable\">--version</span>\nkubectl version <span class=\"token parameter variable\">--client</span></code></pre></div>\n<h3 id=\"16-enable-and-start-kubelet\" style=\"position:relative;\"><a href=\"#16-enable-and-start-kubelet\" aria-label=\"16 enable and start kubelet permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>16. Enable and Start kubelet</h3>\n<p>Enable and start the kubelet service.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> kubelet</code></pre></div>\n<h3 id=\"17-initialize-kubernetes-cluster-with-kubeadm\" style=\"position:relative;\"><a href=\"#17-initialize-kubernetes-cluster-with-kubeadm\" aria-label=\"17 initialize kubernetes cluster with kubeadm permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>17. Initialize Kubernetes Cluster with kubeadm</h3>\n<p>Initialize the Kubernetes cluster with the specified pod network CIDR using <code class=\"language-text\">kubeadm</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm init --pod-network-cidr<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.0.0/16 --cri-socket unix:///run/containerd/containerd.sock --ignore-preflight-errors<span class=\"token operator\">=</span>NumCPU</code></pre></div>\n<h3 id=\"18-configure-kubectl-for-the-current-user\" style=\"position:relative;\"><a href=\"#18-configure-kubectl-for-the-current-user\" aria-label=\"18 configure kubectl for the current user permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>18. Configure kubectl for the Current User</h3>\n<p>Set up <code class=\"language-text\">kubectl</code> for the current user.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token environment constant\">$HOME</span>/.kube\n<span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-i</span> /etc/kubernetes/admin.conf <span class=\"token environment constant\">$HOME</span>/.kube/config\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-u</span><span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-g</span><span class=\"token variable\">)</span></span> <span class=\"token environment constant\">$HOME</span>/.kube/config\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.conf\nkubectl cluster-info dump</code></pre></div>\n<h3 id=\"19-remove-taints-on-control-plane-nodes\" style=\"position:relative;\"><a href=\"#19-remove-taints-on-control-plane-nodes\" aria-label=\"19 remove taints on control plane nodes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>19. Remove Taints on Control-Plane Nodes</h3>\n<p>Remove taints on control-plane nodes to allow scheduling of pods.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl taint nodes <span class=\"token parameter variable\">--all</span> node-role.kubernetes.io/control-plane-\nkubectl get nodes <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<h3 id=\"20-install-cilium-cni\" style=\"position:relative;\"><a href=\"#20-install-cilium-cni\" aria-label=\"20 install cilium cni permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>20. Install Cilium CNI</h3>\n<p>Cilium is a networking, observability, and security solution with an eBPF-based data plane. Cilium provides a simple flat Layer 3 network with the ability to span multiple clusters in either a native routing or overlay/encapsulation mode, and can enforce network policies on L3-L7 using an identity-based security model that is decoupled from network addressing. Cilium can act as a replacement for kube-proxy; it also offers additional, opt-in observability and security features. Cilium is a CNCF project at the Graduated level.</p>\n<p>Install Cilium CNI for networking.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">CILIUM_CLI_VERSION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">CLI_ARCH</span><span class=\"token operator\">=</span>amd64\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-m</span><span class=\"token variable\">)</span></span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"aarch64\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token assign-left variable\">CLI_ARCH</span><span class=\"token operator\">=</span>arm64<span class=\"token punctuation\">;</span> <span class=\"token keyword\">fi</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-L</span> <span class=\"token parameter variable\">--fail</span> --remote-name-all https://github.com/cilium/cilium-cli/releases/download/<span class=\"token variable\">${CILIUM_CLI_VERSION}</span>/cilium-linux-<span class=\"token variable\">${CLI_ARCH}</span>.tar.gz<span class=\"token punctuation\">{</span>,.sha256sum<span class=\"token punctuation\">}</span>\nsha256sum <span class=\"token parameter variable\">--check</span> cilium-linux-<span class=\"token variable\">${CLI_ARCH}</span>.tar.gz.sha256sum\n<span class=\"token function\">sudo</span> <span class=\"token function\">tar</span> xzvfC cilium-linux-<span class=\"token variable\">${CLI_ARCH}</span>.tar.gz /usr/local/bin\n<span class=\"token function\">rm</span> cilium-linux-<span class=\"token variable\">${CLI_ARCH}</span>.tar.gz<span class=\"token punctuation\">{</span>,.sha256sum<span class=\"token punctuation\">}</span>\n\ncilium <span class=\"token function\">install</span> <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.16</span>.3</code></pre></div>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Conclusion</h2>\n<p>By following these steps, you can set up Kubernetes 1.31 with the containerd v2 runtime and Cilium for networking using <code class=\"language-text\">kubeadm</code>. This setup provides a robust and efficient container orchestration environment with advanced networking capabilities.</p>\n<blockquote>\n<p><strong>Troubleshooting Tips</strong>: If you encounter any issues during the setup, refer to the official documentation for <a href=\"https://kubernetes.io/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a>, <a href=\"https://containerd.io/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">containerd</a>, and <a href=\"https://docs.cilium.io/en/stable/\" target=\"_blank\" rel=\"noopener noreferrer\">Cilium</a>. Additionally, check the logs for any error messages and ensure all prerequisites are met.</p>\n</blockquote>\n<blockquote>\n<p><strong>Security Considerations</strong>: Ensure that your Kubernetes cluster is secured by following best practices, such as enabling RBAC, using network policies, and regularly updating your components.</p>\n</blockquote>\n<blockquote>\n<p><strong>Performance Tips</strong>: Optimize your cluster's performance by monitoring resource usage, scaling appropriately, and tuning configurations based on your workload requirements.</p>\n</blockquote>\n<br>\n<p><strong><em>Until next time, つづく 🎉</em></strong></p>\n<blockquote>\n<p>💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  <em><strong>Until next time 🎉</strong></em></p>\n</blockquote>\n<p>🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>♻️ LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>♻️ X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ✌🏻</strong></p>\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n<p><strong>📅 Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":5,"rawMarkdownBody":"> **Definitive Guide to Setting Up Kubernetes 1.31 with containerd v2 and Cilium**\n\n## Introduction\n\nWelcome to this guide on setting up Welcome to this guide on setting up [Kubernetes 1.31](https://kubernetes.io/blog/2024/08/13/kubernetes-v1-31-release/) with the [containerd v2](https://github.com/containerd/containerd/releases/tag/v2.0.0) runtime and [Cilium](https://isovalent.com/blog/post/cilium-1-16/) for networking. This guide is designed to be a comprehensive reference for professionals worldwide, ensuring a robust and efficient container orchestration environment with advanced networking capabilities.\n\nThis guide is designed to be a comprehensive reference for professionals worldwide, ensuring an efficient container orchestration environment with advanced networking capabilities.\n\n![alt text](k8s-containerd-cilium-cover.png)\n\n## Prerequisites\n\nBefore we begin, ensure you have the following prerequisites:\n\n- A system running [Ubuntu 22.04 LTS](https://releases.ubuntu.com/) or higher, 64-bit x86, and kernel 6.8.\n- Root or sudo access to the system.\n- Basic knowledge of [Kubernetes](https://kubernetes.io/), [containerd](https://containerd.io/), and [Cilium](https://cilium.io/).\n\n## Step-by-Step Guide\n\n### 1. Install Required Tools\n\nFirst, we need to ensure that `figlet` and `toilet` are installed for printing colorful messages.\n\n```bash\nif ! command -v figlet &> /dev/null || ! command -v toilet &> /dev/null; then\n    echo -e \"\\033[0;33mFiglet or Toilet not found, installing...\"\n    sudo apt-get update && sudo apt-get install -y figlet toilet\nfi\n```\n\n### 2. Print the Title\n\nUse `figlet` to print the title of the script.\n\n```bash\nfiglet -f smblock \"Setup Kubernetes 1.31 with containerd v2 and Cilium\"\n```\n\n### 3. Disable Swap\n\nDisabling swap is crucial for Kubernetes to function correctly. Kubernetes requires swap to be disabled to ensure optimal performance and stability.\n\n```bash\nswapoff -a\nsed -i '/swap/d' /etc/fstab\n```\n\n> **Note**: Disabling swap ensures that Kubernetes can manage resources more effectively, preventing potential issues with resource allocation.\n\n### 4. Load Necessary Kernel Modules\n\nLoad the required kernel modules for containerd.\n\n```bash\ncat >>/etc/modules-load.d/containerd.conf<<EOF\noverlay\nbr_netfilter\nEOF\nmodprobe overlay\nmodprobe br_netfilter\n```\n\n### 5. Configure sysctl for Kubernetes\n\nConfigure sysctl parameters required by Kubernetes.\n\n```bash\ncat >>/etc/sysctl.d/kubernetes.conf<<EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nEOF\nsysctl --system\n```\n\n### 6. Disable UFW\n\nDisable the Uncomplicated Firewall (UFW) to avoid network issues.\n\n```bash\nufw disable\n```\n\n### 7. Remove Unnecessary Packages\n\nRemove unnecessary packages to avoid conflicts.\n\n```bash\nsudo apt-get remove containernetworking-plugins -y && sudo apt-get remove conmon -y\n```\n\n### 8. Create Keyrings Directory\n\nCreate the keyrings directory for storing GPG keys.\n\n```bash\nmkdir -p /etc/apt/keyrings/\n```\n\n### 9. Install containerd\n\nDownload and install containerd.\n\n```bash\nwget https://github.com/containerd/containerd/releases/download/v2.0.0/containerd-2.0.0-linux-amd64.tar.gz\ntar -C /usr/local -xzvf containerd-2.0.0-linux-amd64.tar.gz\n```\n\n### 10. Configure containerd\n\nCreate a systemd service file for containerd and start the service.\n\n```bash\nmkdir -p /usr/local/lib/systemd/system/\ncat <<EOF > /usr/local/lib/systemd/system/containerd.service\n[Unit]\nDescription=containerd container runtime\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target dbus.service\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/containerd\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n\nLimitNPROC=infinity\nLimitCORE=infinity\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\nsystemctl enable --now containerd\n```\n\n### 11. Install runc\n\nDownload and install runc.\n\n```bash\nwget https://github.com/opencontainers/runc/releases/download/v1.2.1/runc.amd64\ninstall -m 755 runc.amd64 /usr/local/sbin/runc\n```\n\n### 12. Install CNI Plugins\n\nDownload and install CNI plugins.\n\n```bash\nwget https://github.com/containernetworking/plugins/releases/download/v1.6.0/cni-plugins-linux-amd64-v1.6.0.tgz\nmkdir -p /opt/cni/bin\ntar -C /opt/cni/bin -xzvf cni-plugins-linux-amd64-v1.6.0.tgz\nsystemctl restart containerd\n```\n\n### 13. Verify containerd Installation\n\nVerify the installation of containerd.\n\n```bash\ncontainerd -v\n```\n\n### 14. Add Kubernetes Repository and Install Components\n\nAdd the Kubernetes repository and install the necessary components.\n\n```bash\necho \"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /\" | sudo tee /etc/apt/sources.list.d/kubernetes.list\ncurl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\nsudo apt-get update\nsudo apt-get install kubelet kubeadm kubectl -y\nsudo apt-mark hold kubelet kubeadm kubectl\n```\n\n### 15. Output Versions of Kubernetes Components\n\nOutput the versions of the installed Kubernetes components.\n\n```bash\nkubeadm version\nkubelet --version\nkubectl version --client\n```\n\n### 16. Enable and Start kubelet\n\nEnable and start the kubelet service.\n\n```bash\nsudo systemctl enable --now kubelet\n```\n\n### 17. Initialize Kubernetes Cluster with kubeadm\n\nInitialize the Kubernetes cluster with the specified pod network CIDR using `kubeadm`.\n\n```bash\nkubeadm init --pod-network-cidr=192.168.0.0/16 --cri-socket unix:///run/containerd/containerd.sock --ignore-preflight-errors=NumCPU\n```\n\n### 18. Configure kubectl for the Current User\n\nSet up `kubectl` for the current user.\n\n```bash\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\nexport KUBECONFIG=/etc/kubernetes/admin.conf\nkubectl cluster-info dump\n```\n\n### 19. Remove Taints on Control-Plane Nodes\n\nRemove taints on control-plane nodes to allow scheduling of pods.\n\n```bash\nkubectl taint nodes --all node-role.kubernetes.io/control-plane-\nkubectl get nodes -o wide\n```\n\n### 20. Install Cilium CNI\n\nCilium is a networking, observability, and security solution with an eBPF-based data plane. Cilium provides a simple flat Layer 3 network with the ability to span multiple clusters in either a native routing or overlay/encapsulation mode, and can enforce network policies on L3-L7 using an identity-based security model that is decoupled from network addressing. Cilium can act as a replacement for kube-proxy; it also offers additional, opt-in observability and security features. Cilium is a CNCF project at the Graduated level.\n\nInstall Cilium CNI for networking.\n\n```bash\nCILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)\nCLI_ARCH=amd64\nif [ \"$(uname -m)\" = \"aarch64\" ]; then CLI_ARCH=arm64; fi\ncurl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}\nsha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum\nsudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin\nrm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}\n\ncilium install --version 1.16.3\n```\n\n## Conclusion\n\nBy following these steps, you can set up Kubernetes 1.31 with the containerd v2 runtime and Cilium for networking using `kubeadm`. This setup provides a robust and efficient container orchestration environment with advanced networking capabilities.\n\n> **Troubleshooting Tips**: If you encounter any issues during the setup, refer to the official documentation for [Kubernetes](https://kubernetes.io/docs/), [containerd](https://containerd.io/docs/), and [Cilium](https://docs.cilium.io/en/stable/). Additionally, check the logs for any error messages and ensure all prerequisites are met.\n\n> **Security Considerations**: Ensure that your Kubernetes cluster is secured by following best practices, such as enabling RBAC, using network policies, and regularly updating your components.\n\n> **Performance Tips**: Optimize your cluster's performance by monitoring resource usage, scaling appropriately, and tuning configurations based on your workload requirements.\n\n<br>\n\n**_Until next time, つづく 🎉_**\n\n> 💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  _**Until next time 🎉**_\n\n🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**♻️ LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**♻️ X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ✌🏻**\n\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n\n**📅 Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":658},"frontmatter":{"id":"db7135ca07ebb25d38a4a243","path":"/blog/kubernetes-containerd-cilium-setup/","humanDate":"Nov 11, 2024","fullDate":"2024-11-11","title":"Guide to Setting Up Kubernetes 1.31 with containerd v2 and Cilium","keywords":["Kubernetes","containerd","Cilium","Networking"],"excerpt":"An authoritative, step-by-step guide to setting up Kubernetes 1.31 with containerd v2 runtime and Cilium for advanced networking.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACsElEQVR42lWSa08TQRSGt9vtbru73V5BLFBFaEAqYqUCClrRpPESo9wqBVQqKF5iNWrVNIJKECQE0RgToyZ+9JuGH2FMiL/DxF/xeNpI1A9nZzYz88y873sU3QpxKFLHqdoYx6LbOOQE2O849HpNhvYk+fZ6meORKF1OiE5NZzU3yKt7N0m4NTKBAEnT5LSsJ0O1aGYQxW342WmHSDoRkv4w/X6HlOWnyzDprW/g+/s1pg72sMOls9f0s/G8zMKlPK2qh322TZvXoMVnUSMwVViK5nVQZOKRsT8YJeMPkA1GOGIHOBffydcnJRZGB0l5LHKJVjaelnh85gQZeW3GtOn0mSgCd8v5KqvyqcD0Shk2mlvHo3lxKR5C4VquzU4xM3MRrx2mu6eH8sMi6QNpbCtIc1MCTfa6NUMYgb/AavkCVOSrblkUsCUW1NbHyU/kmb46TUe6l7PDw1yZnSHR1s6bt+/Y3NykMb4LRVHRRfJ/QI9hoQlIUTTC0Rj9A1lGxiYoz89z536JxRcrPJqbZ2VtjaHzea4XS5TKCzQ1766e+QcoL9NNXN4Yqh4QqT4aGmJ0dO4h0Z6m+3CG4fwks7duM1GYITc5RaQxwfriPD++fGBXS7sADQH+kayKuXZ9N+VPv+jLvcQrLbP6KMvCqRSGVYMeqmNovED2bI6LV4v0DpyUQ0FGD3fy+eYAYWkZRfz2+P4FxtI8+PiTvtE1uUmjcHmIwUwB3V9He9cBllaWmXv2hOcrS4xdKhCLN9FSE2RusI1YfQrTSYpdYpmo/StZj+LSLFRVQrG2ofmlzDBHs1mmJYji3SI3ijcYL0zRk+rg80gj69kI8aYLbI8Pi13GFtCpTjxeuxqKS9UlaV0u8aH6HPmXPlMqJYG5nOro0kOkmlsJS6+6NVv22myF+xub+ExAFfRKCQAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/12cdd828513870f8806426a0fb0e22b5/3e9e3/k8s-containerd-cilium-cover.png","srcSet":"/static/12cdd828513870f8806426a0fb0e22b5/d0df2/k8s-containerd-cilium-cover.png 750w,\n/static/12cdd828513870f8806426a0fb0e22b5/dc0d4/k8s-containerd-cilium-cover.png 1080w,\n/static/12cdd828513870f8806426a0fb0e22b5/d079a/k8s-containerd-cilium-cover.png 1366w,\n/static/12cdd828513870f8806426a0fb0e22b5/3e9e3/k8s-containerd-cilium-cover.png 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/12cdd828513870f8806426a0fb0e22b5/b9516/k8s-containerd-cilium-cover.webp 750w,\n/static/12cdd828513870f8806426a0fb0e22b5/2a327/k8s-containerd-cilium-cover.webp 1080w,\n/static/12cdd828513870f8806426a0fb0e22b5/4fad6/k8s-containerd-cilium-cover.webp 1366w,\n/static/12cdd828513870f8806426a0fb0e22b5/467a8/k8s-containerd-cilium-cover.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5619791666666667}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"nextThought":{"frontmatter":{"path":"/blog/kubernetes-user-namespaces/","title":"Enhancing Kubernetes Security with User Namespaces","date":"2024-11-10 20:00:00"},"excerpt":"Enhancing Kubernetes Security with User Namespaces 🛡️ Introduction User namespaces in Kubernetes offer a robust mechanism for enhancing…","html":"<blockquote>\n<p><strong>Enhancing Kubernetes Security with User Namespaces</strong></p>\n</blockquote>\n<h2 id=\"️-introduction\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-introduction\" aria-label=\"️ introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🛡️ Introduction</h2>\n<p>User namespaces in Kubernetes offer a robust mechanism for enhancing security and flexibility. This blog post explores the benefits of user namespaces, their implementation, and how they contribute to a more secure Kubernetes environment.</p>\n<p>User namespaces in Kubernetes provide several ways to improve workload security, although they can, under certain uncommon configurations, increase the attack surface of clusters. By remapping UIDs and reducing privileges, user namespaces enhance isolation for applicable workloads.</p>\n<h2 id=\"-background\" style=\"position:relative;\"><a href=\"#-background\" aria-label=\" background permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>📚 Background</h2>\n<p>User namespaces are not a new concept. The <a href=\"https://man7.org/linux/man-pages/man7/user_namespaces.7.html\" target=\"_blank\" rel=\"noopener noreferrer\">Linux kernel manual</a> mentions user namespaces starting with v3.8. Since then, user namespaces have been a core technology behind rootless containers. Given that current kernel versions are in the 5.x range, user namespaces have had ample opportunity to evolve. However, their complexity and potential security implications must be recognized: their use opens previously untested code paths. Despite being readily available in the kernel, several Linux distributions chose to disable user namespaces by default to allow the feature to mature. Kubernetes developers adopted a similar approach.</p>\n<h2 id=\"️-kubernetes-versions-and-user-namespaces\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-kubernetes-versions-and-user-namespaces\" aria-label=\"️ kubernetes versions and user namespaces permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🗂️ Kubernetes Versions and User Namespaces</h2>\n<ul>\n<li><strong>Kubernetes v1.25</strong>: Introduced alpha support for Linux user namespaces (userns). This feature is touted as an additional isolation layer that improves host security and prevents many known container escape scenarios.</li>\n<li><strong>Kubernetes v1.28</strong>: Lifted the restriction on user namespaces for stateless pods.</li>\n<li><strong>Kubernetes v1.30</strong>: Moved user namespaces to beta, enabling broader usage and introducing custom ranges for UIDs/GIDs mapping.</li>\n</ul>\n<h2 id=\"-motivation\" style=\"position:relative;\"><a href=\"#-motivation\" aria-label=\" motivation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🎯 Motivation</h2>\n<p>From <a href=\"https://man7.org/linux/man-pages/man7/user_namespaces.7.html\" target=\"_blank\" rel=\"noopener noreferrer\">user_namespaces(7)</a>:</p>\n<blockquote>\n<p>User namespaces isolate security-related identifiers and attributes, in particular, user IDs and group IDs, the root directory, keys, and capabilities. A process's user and group IDs can be different inside and outside a user namespace. In particular, a process can have a normal unprivileged user ID outside a user namespace while at the same time having a user ID of 0 inside the namespace; in other words, the process has full privileges for operations inside the user namespace, but is unprivileged for operations outside the namespace.</p>\n</blockquote>\n<p>The goal of supporting user namespaces in Kubernetes is to run processes in pods with different user and group IDs than in the host. Specifically, a privileged process in the pod runs as an unprivileged process in the host. If such a process breaks out of the container to the host, it will have limited impact as it will be running as an unprivileged user there.</p>\n<h2 id=\"-how-user-namespaces-improve-workload-security\" style=\"position:relative;\"><a href=\"#-how-user-namespaces-improve-workload-security\" aria-label=\" how user namespaces improve workload security permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🔒 How User Namespaces Improve Workload Security</h2>\n<h3 id=\"mitigating-the-impact-of-container-escape\" style=\"position:relative;\"><a href=\"#mitigating-the-impact-of-container-escape\" aria-label=\"mitigating the impact of container escape permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Mitigating the Impact of Container Escape</h3>\n<p>The main motivation behind user namespaces in the container context is curbing the potential impact of container escape. When a container-bound process running as root escapes to the host, it is still considered a privileged process with its user ID (UID) equal to 0. However, user namespaces introduce a consistent mapping between host-level user IDs and container-level user IDs that ensures a UID 0 on the container corresponds to a non-zero UID on the host. To eliminate the possibility of UID overlap with the host, every pod receives 64K user IDs for private use.</p>\n<h3 id=\"user-namespace-mapping-between-host-and-container-user-ids\" style=\"position:relative;\"><a href=\"#user-namespace-mapping-between-host-and-container-user-ids\" aria-label=\"user namespace mapping between host and container user ids permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>User Namespace Mapping Between Host and Container User IDs</h3>\n<p>As a result, even if a process is root (i.e., UID 0) inside the container, escaping to the host will only entitle it to access resources associated with UID X.</p>\n<p>Moreover, an escaped process with a user namespace would be blocked from accessing resources such as:</p>\n<ul>\n<li>Changing the system time (CAP_SYS_TIME)</li>\n<li>Loading a kernel module (CAP_SYS_MODULE)</li>\n<li>Creating a device (CAP_MKNOD)</li>\n<li><code class=\"language-text\">/etc</code> config files</li>\n<li>Devices in <code class=\"language-text\">/dev</code></li>\n<li>The <code class=\"language-text\">/home/root</code> directory storing potential secrets</li>\n<li>Kubelet config, which is commonly used for lateral movement within the cluster and is only readable by the root process on the cluster host</li>\n<li>Unix sockets with root ownership</li>\n<li>TCP/UDP sockets with root ownership</li>\n</ul>\n<h2 id=\"-benefits\" style=\"position:relative;\"><a href=\"#-benefits\" aria-label=\" benefits permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🌟 Benefits</h2>\n<ol>\n<li><strong>Enhanced Security</strong>: User namespaces isolate security-related identifiers and attributes, reducing the risk of privilege escalation attacks.</li>\n<li><strong>Flexibility</strong>: Allows running processes in pods with different user and group IDs than in the host, providing more control over permissions.</li>\n<li><strong>Mitigation of Vulnerabilities</strong>: Helps mitigate several known vulnerabilities, such as <a href=\"https://nvd.nist.gov/vuln/detail/CVE-2019-5736\" target=\"_blank\" rel=\"noopener noreferrer\">CVE-2019-5736</a> and <a href=\"https://github.com/kubernetes/kubernetes/issues/104980\" target=\"_blank\" rel=\"noopener noreferrer\">CVE-2021-25741</a>.</li>\n</ol>\n<p>A process running as root in a container can run as a different (non-root) user in the host; in other words, the process has full privileges for operations inside the user namespace, but is unprivileged for operations outside the namespace.</p>\n<p>You can use this feature to reduce the damage a compromised container can do to the host or other pods in the same node. There are several security vulnerabilities rated either HIGH or CRITICAL that were not exploitable when user namespaces are active. It is expected user namespaces will mitigate some future vulnerabilities too.</p>\n<p>Without using a user namespace, a container running as root, in the case of a container breakout, has root privileges on the node. And if some capability were granted to the container, the capabilities are valid on the host too. None of this is true when user namespaces are used.</p>\n<p>A user namespace is a Linux feature that isolates the user and group identifiers (UIDs and GIDs) of the containers from the ones on the host. The identifiers in the container can be mapped to identifiers on the host in a way where the host UID/GIDs used for different containers never overlap. Furthermore, the identifiers can be mapped to unprivileged non-overlapping UIDs and GIDs on the host. This brings two key benefits:</p>\n<ol>\n<li>\n<p><strong>Prevention of Lateral Movement</strong>: As the UIDs and GIDs for different containers are mapped to different UIDs and GIDs on the host, containers have a harder time attacking each other even if they escape the container boundaries. For example, if container A is running with different UIDs and GIDs on the host than container B, the operations it can do on container B's files and processes are limited: only read/write what a file allows to others, as it will never have permission owner or group permission (the UIDs/GIDs on the host are guaranteed to be different for different containers).</p>\n</li>\n<li>\n<p><strong>Increased Host Isolation</strong>: As the UIDs and GIDs are mapped to unprivileged users on the host, if a container escapes the container boundaries, even if it is running as root inside the container, it has no privileges on the host. This greatly protects what host files it can read/write, which processes it can send signals to, etc. Furthermore, capabilities granted are only valid inside the user namespace and not on the host, which also limits the impact a container escape can have.</p>\n</li>\n</ol>\n<p>Without using a user namespace, a container running as root in the case of a container breakout, has root privileges on the node. And if some capabilities were granted to the container, the capabilities are valid on the host too. None of this is true when using user namespaces.</p>\n<p>There are many known CVEs (and likely many more as-yet unidentified vulnerabilities) that are partially or completely mitigated by the use of user namespaces.</p>\n<h2 id=\"implementation\" style=\"position:relative;\"><a href=\"#implementation\" aria-label=\"implementation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Implementation</h2>\n<h3 id=\"podspec-changes\" style=\"position:relative;\"><a href=\"#podspec-changes\" aria-label=\"podspec changes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Pod.spec Changes</h3>\n<p>The following changes will be done to the pod.spec:</p>\n<ul>\n<li><code class=\"language-text\">pod.spec.hostUsers</code>: <code class=\"language-text\">*bool</code>.\n- If true or not present, uses the host user namespace (as today).\n- If false, a new user namespace is created for the pod.\n- By default, it is not set, which implies using the host user namespace.</li>\n</ul>\n<h3 id=\"support-for-pods\" style=\"position:relative;\"><a href=\"#support-for-pods\" aria-label=\"support for pods permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Support for Pods</h3>\n<p>Make pods work with user namespaces. This is activated via the bool <code class=\"language-text\">pod.spec.hostUsers</code>.\nThe mapping length will be 65536, mapping the range 0-65535 to the pod. This wide range makes sure most workloads will work fine. Additionally, we don't need to worry about fragmentation of IDs, as all pods will use the same length.</p>\n<p>The Kubernetes implementation was redesigned in 1.27, so the requirements are different for versions\npre and post Kubernetes 1.27.</p>\n<p>Please note that if you try to use user namespaces with containerd 1.6 or older, the <code class=\"language-text\">hostUsers:\nfalse</code> setting in your pod.spec will be <strong>silently ignored</strong>.</p>\n<h3 id=\"kubernetes-125-and-126\" style=\"position:relative;\"><a href=\"#kubernetes-125-and-126\" aria-label=\"kubernetes 125 and 126 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes 1.25 and 1.26</h3>\n<ul>\n<li>Containerd 1.7</li>\n<li>You can use runc or crun as the OCI runtime:\n<ul>\n<li>runc 1.1 or greater</li>\n<li>crun 1.4.3 or greater</li>\n</ul>\n</li>\n</ul>\n<p>You can also use containerd 2.0 or above, but the same <a href=\"#Kubernetes-127-and-greater\">requirements as Kubernetes 1.27 and\ngreater</a> apply, except for the Linux kernel. Bear in mind that all the\nrequirements there apply, including file-systems supporting idmap mounts. You can use Linux\nversions:</p>\n<ul>\n<li>Linux 5.15: you will suffer from <a href=\"#Limitations\">the containerd 1.7 storage and latency\nlimitations</a>, as it doesn't support idmap mounts for overlayfs.</li>\n<li>Linux 5.19 or greater (recommended): it doesn't suffer from any of the containerd 1.7\nlimitations, as overlayfs started supporting idmap mounts on this kernel version.</li>\n</ul>\n<h3 id=\"kubernetes-127-and-greater\" style=\"position:relative;\"><a href=\"#kubernetes-127-and-greater\" aria-label=\"kubernetes 127 and greater permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes 1.27 and greater</h3>\n<ul>\n<li>Linux 6.3 or greater</li>\n<li>Containerd 2.0 or greater</li>\n<li>You can use runc or crun as the OCI runtime:\n<ul>\n<li>runc 1.2 or greater</li>\n<li>crun 1.9 or greater</li>\n</ul>\n</li>\n</ul>\n<p>Furthermore, all the file-systems used by the volumes in the pod need kernel-support for idmap\nmounts. Some popular file-systems that support idmap mounts in Linux 6.3 are: <code class=\"language-text\">btrfs</code>, <code class=\"language-text\">ext4</code>, <code class=\"language-text\">xfs</code>,\n<code class=\"language-text\">fat</code>, <code class=\"language-text\">tmpfs</code>, <code class=\"language-text\">overlayfs</code>.</p>\n<p>The kubelet is in charge of populating some files to the containers (like configmap, secrets, etc.).\nThe file-system used in that path needs to support idmap mounts too. See <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/user-namespaces/#before-you-begin\" target=\"_blank\" rel=\"noopener noreferrer\">the Kubernetes\ndocumentation</a> for more info on that.</p>\n<h3 id=\"stripping-unnecessary-privileges\" style=\"position:relative;\"><a href=\"#stripping-unnecessary-privileges\" aria-label=\"stripping unnecessary privileges permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Stripping Unnecessary Privileges</h3>\n<p>Privileged containers running in their own user namespace are isolated and therefore their capabilities cannot harm the host. For example, Kubernetes lacks support for FUSE filesystem mounting. One workaround is adding a spec to mount a GCP bucket at a postStart event with the required CAP_SYS_ADMIN permissions for the initial namespace.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> \n    <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>container \n        <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span> \n            <span class=\"token key atrule\">privileged</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> \n            <span class=\"token key atrule\">capabilities</span><span class=\"token punctuation\">:</span> \n                <span class=\"token key atrule\">add</span><span class=\"token punctuation\">:</span> \n                    <span class=\"token punctuation\">-</span> SYS_ADMIN \n        <span class=\"token key atrule\">lifecycle</span><span class=\"token punctuation\">:</span> \n            <span class=\"token key atrule\">postStart</span><span class=\"token punctuation\">:</span> \n                <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span> \n                    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"gcsfuse\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-o\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nonempty\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"your-bucket-name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/etc/letsencrypt\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>However, SYS_ADMIN is a powerful capability. In this case, implementing a user namespace would eliminate the need to specify <code class=\"language-text\">privileged: true</code> and grant SYS_ADMIN, drastically reducing the host’s attack surface.</p>\n<h2 id=\"demo\" style=\"position:relative;\"><a href=\"#demo\" aria-label=\"demo permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Demo</h2>\n<h3 id=\"run-a-pod-that-uses-a-user-namespace\" style=\"position:relative;\"><a href=\"#run-a-pod-that-uses-a-user-namespace\" aria-label=\"run a pod that uses a user namespace permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Run a Pod that uses a User Namespace</h3>\n<p>A user namespace for a pod is enabled by setting the <code class=\"language-text\">hostUsers</code> field of <code class=\"language-text\">.spec</code> to <code class=\"language-text\">false</code>. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> userns\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hostUsers</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> shell\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sleep\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"infinity\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> debian</code></pre></div>\n<p>Attach to the container and run <code class=\"language-text\">readlink /proc/self/ns/user</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kubectl attach <span class=\"token parameter variable\">-it</span> userns <span class=\"token function\">bash</span></code></pre></div>\n<p>Run this command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">readlink /proc/self/ns/user</code></pre></div>\n<p>The output is similar to:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">user:<span class=\"token punctuation\">[</span><span class=\"token number\">4026531837</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Also, run:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">cat</span> /proc/self/uid_map</code></pre></div>\n<p>The output is similar to:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token number\">0</span>  <span class=\"token number\">833617920</span>      <span class=\"token number\">65536</span></code></pre></div>\n<p>Then, open a shell in the host and run the same commands.</p>\n<p>The <code class=\"language-text\">readlink</code> command shows the user namespace the process is running in. It should be different when it is run on the host and inside the container.</p>\n<p>The last number of the <code class=\"language-text\">uid_map</code> file inside the container must be 65536, on the host it must be a bigger number.</p>\n<p>If you are running the kubelet inside a user namespace, you need to compare the output from running the command in the pod to the output of running in the host:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">readlink /proc/<span class=\"token variable\">$pid</span>/ns/user</code></pre></div>\n<p>replacing <code class=\"language-text\">$pid</code> with the kubelet PID.</p>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🏁 Conclusion</h2>\n<p>User namespaces in Kubernetes provide a robust mechanism for enhancing security and flexibility. By isolating security-related identifiers and attributes, they reduce the risk of privilege escalation attacks and provide more control over permissions. Implementing user namespaces involves changes to the pod specification and container runtime interface, but the benefits in terms of security and flexibility make it a worthwhile endeavor.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}