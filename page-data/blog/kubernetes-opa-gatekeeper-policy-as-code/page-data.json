{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/kubernetes-opa-gatekeeper-policy-as-code/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Building a Fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code Keep Your Cluster Safe üõ°Ô∏è</strong></p>\n</blockquote>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Introduction</h2>\n<p>As organizations adopt Kubernetes as their container orchestration platform, policy management becomes increasingly important. Traditional approaches to policy enforcement can be time-consuming and error-prone.</p>\n<p>Manual policy reviews and audits create delays and introduce human error. In dynamic cloud environments, policies need to be constantly updated to reflect changes in the infrastructure.</p>\n<p>Policy as Code (PaC) with <a href=\"https://www.openpolicyagent.org/docs/latest/\" target=\"_blank\" rel=\"noopener noreferrer\">Open Policy Agent (OPA)</a> for Kubernetes provides an automated and efficient solution. PaC allows easy policy integration into CI/CD pipelines. This approach ensures consistent policy enforcement and reduces human error risk.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.352941176470594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAUEBv/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAa8vfCOqB//EABsQAAEEAwAAAAAAAAAAAAAAAAMAAQQ0AhET/9oACAEBAAEFAjvoQc26qZXj2F//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAdEAAABgMBAAAAAAAAAAAAAAAAAQIQIXEREkFh/9oACAEBAAY/AjnHpBMa8tlBFt//xAAbEAEAAQUBAAAAAAAAAAAAAAABEQAQIUGxYf/aAAgBAQABPyE3qxjYVBpeW9uPtJc9n//aAAwDAQACAAMAAAAQU8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAfEAEAAgIABwAAAAAAAAAAAAABABEhMRBBYYGRobH/2gAIAQEAAT8QBfLoWjgQ7ysHK1FjHPBRi/HD0vhLgTjt6MNT/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"bad pod\" title=\"\" src=\"/static/330135c77f8164bfe91aa3e5f420962c/7bf67/bad-pod.jpg\" srcset=\"/static/330135c77f8164bfe91aa3e5f420962c/651be/bad-pod.jpg 170w,\n/static/330135c77f8164bfe91aa3e5f420962c/d30a3/bad-pod.jpg 340w,\n/static/330135c77f8164bfe91aa3e5f420962c/7bf67/bad-pod.jpg 680w,\n/static/330135c77f8164bfe91aa3e5f420962c/990cb/bad-pod.jpg 1020w,\n/static/330135c77f8164bfe91aa3e5f420962c/e5166/bad-pod.jpg 1200w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-goals--objectives\" style=\"position:relative;\"><a href=\"#-goals--objectives\" aria-label=\" goals  objectives permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üéØ Goals &#x26; Objectives</h2>\n<p>In this article, we will explore how Policy as Code (PaC) with Open Policy Agent (OPA) for Kubernetes can streamline policy enforcement.<br>\n<strong>HAPPY LEARNING üíª</strong></p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 580px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 76.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAklEQVR42p2TXUhTYRjHR9+uTcHlljXSCkFQ2lUjiiLqoi6ivOkiyUgsYXkZRUZBQdIh6MMMFn1ABBHREMfSm75WUA5FsLwI8i5OY07Mcjt+nfOeX2fHLftgndUDL++B87y/5/0/z/+18Q+h66AJYye763/m2AoCCWEc1n9AZ1Q9b66tcJhgPKXREZ6g8cooN7snSE/NF7EE6ppmLNX8jstxQ6NCRyRNc/soD16kOXgpyb2nKfO/JvQCgNmyib4YIf8G7jQdInA1QTDylWF5mmtd3zh+e8z6hjlQ8nWUaN1uQh4H0vatBCrdnD4Vov4WSKEUe8+N0PVWMXNFPmCmX5mY+SzTWeUluqqY9jIHh8vL2Fdip6fxAOfbejh6IkqkV7EeSg44O/yRizu2Ie/cRGylg7MlS5FK7bx3LaPbs4jHZ06aeaomLKZsyDVvn4gj7dnFh80+givs3PW6eL7OQ2d1Bc+cC3nU2jo3DFW1BpoxqRAOHKHPX8P+5Uvor12LvMVHor6OfncRseCNud5ZAn+S/VJqY2BjDdPrXXyqLOXN6mKUWi9ht4ORWO8vuQUBk4MDXKgo54lzgdG/IhoW2zjmtPOwpdlUIn73y998mLPOl6F3vGpqQKpaw32/j6Hrlw1/pyEPzNLYOfDs+Bja1OR8Mf0/33JGvsi2IAMSxnO0iu/S5SwgYdyhTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"opa\" title=\"\" src=\"/static/626ecdac374ce2e2c867cb3db477b4cd/b6272/opa.png\" srcset=\"/static/626ecdac374ce2e2c867cb3db477b4cd/04472/opa.png 170w,\n/static/626ecdac374ce2e2c867cb3db477b4cd/9f933/opa.png 340w,\n/static/626ecdac374ce2e2c867cb3db477b4cd/b6272/opa.png 580w\" sizes=\"(max-width: 580px) 100vw, 580px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>To properly evaluate PaC with OPA, it's essential to first understand Policy as Code.</p>\n<h3 id=\"policy-as-code\" style=\"position:relative;\"><a href=\"#policy-as-code\" aria-label=\"policy as code permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Policy as Code</h3>\n<p>Policy as Code involves managing policy enforcement using machine-readable definition files, rather than documentation or interactive configuration tools. The primary goal is to ensure consistent enforcement of standards and rules across clusters or organizations.</p>\n<p>Once policies are established, the next step is to enforce them effectively. This is where tools like <a href=\"https://github.com/open-policy-agent/opa\" target=\"_blank\" rel=\"noopener noreferrer\">OPA</a> and <a href=\"https://github.com/kyverno/kyverno\" target=\"_blank\" rel=\"noopener noreferrer\">Kyverno</a> come into play.</p>\n<h3 id=\"open-policy-agent-opa\" style=\"position:relative;\"><a href=\"#open-policy-agent-opa\" aria-label=\"open policy agent opa permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Open Policy Agent (OPA)</h3>\n<p><a href=\"https://www.openpolicyagent.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Open Policy Agent (OPA)</a> is an open-source tool that enables creating, validating, and enforcing policies across systems, including Kubernetes. OPA uses the declarative Rego language to define policies as code, enabling easy integration into CI/CD pipelines. It ensures consistent, efficient policy enforcement, reduces human error risk, and provides policy management flexibility based on specific use cases and requirements.</p>\n<p>To expand on the capabilities of OPA in Kubernetes, let's explore the additional features provided by OPA Gatekeeper, a policy controller that runs on top of OPA.</p>\n<h3 id=\"opa-gatekeeper\" style=\"position:relative;\"><a href=\"#opa-gatekeeper\" aria-label=\"opa gatekeeper permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>OPA Gatekeeper</h3>\n<p><a href=\"https://open-policy-agent.github.io/gatekeeper\" target=\"_blank\" rel=\"noopener noreferrer\">OPA Gatekeeper</a> is a policy controller that runs on top of OPA in Kubernetes. It extends the functionality of OPA by enabling users to enforce policies at scale across multiple Kubernetes clusters. Gatekeeper uses the same declarative policy language as OPA, Rego, to define policies as code.</p>\n<p>Gatekeeper integrates with Kubernetes' admission controller mechanism, which allows it to evaluate policies before resources are created or updated. This ensures that only resources that meet the defined policies are allowed to run, reducing the risk of security vulnerabilities and ensuring compliance.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAChUlEQVR42jWR2U8TYRTF+4+pUWNc0OiT4cHEFWNijAZ5EDcsCJGIS9UGMSIQd42KaDRojL4YVxaxgGg705npTNuZLtNpZ6alxZ9fqz6cnJO7nHvv9wU+zlqcfaQQGtPoe6zQdV+nU+DUPYG7Ot0PDfqeGPQ+MgiKWB31/H9drz8p6sLPDYpFl8DlMYV919P0jObYO6Cz7ITK8g6DNV0a604rbD6jsjNs0HwhwepgglVBjZWnVKG1hl4l9IoOUdutETdyBK691GgdSXJ13KJtRKWlX2VbSGXXZYngA4P9AzHab6m039bZ2ic3OPTC5NgdndZBiXPPTM4/T4teDTmRJXDxqd6YtqVX5eCQQXg8z7G7SZrPSXTcT3FUmLUNy/Q8TrM9JHNgUOe4MDt0Q2d3WOHITV3AYE//P8Oh10mxeoKNp2PsvhKld9Tk8LDOph6ZlrAkzBR2XfpF65DKjpDEWvEUTd0SG7pirBdnNnX+FE+jiasMkpZNIGsXmVNdvs7pfJlN8HkuxZcfGaaiNh8jKaYFRxSXGckRXGJGdng/Y/D1h0kkXuRTJMm7CYWFeAbfF5/ieR6wxGKlTKXs4xdzSPNTuPmUCPtQE/lqSbDbQNW3sa0Erp0mb+nk0grfJj/jFGw8z68b+jhOkYnJKVJJA8oFHDuLW8iS1lXRmGXJzVJ1zAZqns3Sok/FdbDSycbAmpenWvtNqVT6u2G5XMbKZMhnUmKzNAWnhGma/IpKJOJRcnoUTZF48/YVdkrCLhT4/j0ierKNq6pFk8VqDbduWHeNxWIsLPxElmVKOZ2ipQiolO0kXi5BJROlYgljdYZFWxOXWxjyLPPTH4jPT+I7Fp5fpr7cH5mEnjtrb/tjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"opa-gatekeeper\" title=\"\" src=\"/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/c5bb3/opa-gatekeeper.png\" srcset=\"/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/04472/opa-gatekeeper.png 170w,\n/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/9f933/opa-gatekeeper.png 340w,\n/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/c5bb3/opa-gatekeeper.png 680w,\n/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/146da/opa-gatekeeper.png 943w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"admission-controllers\" style=\"position:relative;\"><a href=\"#admission-controllers\" aria-label=\"admission controllers permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Admission Controllers</h3>\n<p>Admission controllers in Kubernetes intercept API requests, validate them against specific criteria, and mutate them if necessary. There are two types of admission controllers: mutating admission controllers and validating admission controllers. Mutating admission controllers modify requests while validating admission controllers check requests for compliance with pre-defined policies. They are a powerful tool for enforcing policies and ensuring consistency in Kubernetes environments.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABcElEQVR42q2QzUsbURTF8w+6qVl004Xb7qQbS1GxFFyVghJKoYg7UUQLXbbatIIhxqlpY7SNJppo4sw0mZl8zOfLm58vExAXWfbC45577jn3Xl5KCIHnRxhWwD87JIykwmFSBwq3nRBT8X4o6XSVTmEvGOL0xx7XHxKo3qge6VOeNyCr3TI9f8TMskb2xCC9kCc9n2dfM3j+tsizN8d8Kei8yJR4ulTg00GT1+vnPHmVZzt7y/vdGlNzOTa+NkihojuI0P62+X1pYfcCfql8UmljdT2VLQ5LJnpnQKXe4axmqctczusOP4o6TbPHVdMmd2oojTceOCk8d4BhtNQXRLiuT+O6imO1ESLC1FuKc/H9AOPuBsfuKEec+JKBIyjjOHkjPIzjhHX6AR8/X5PZqVL8oxNLkfTDSLC5d8O7rQu+a81kkJCSWPkmXhiPl2H3QxbXyrz8UKJ81X3oi6FkZbvC7GqRbz/NhJPy0YX/M+4BpjsGLXNWy+QAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"steps\" title=\"\" src=\"/static/7ac61158ec2144d7082cb6e0b059485a/c5bb3/steps.png\" srcset=\"/static/7ac61158ec2144d7082cb6e0b059485a/04472/steps.png 170w,\n/static/7ac61158ec2144d7082cb6e0b059485a/9f933/steps.png 340w,\n/static/7ac61158ec2144d7082cb6e0b059485a/c5bb3/steps.png 680w,\n/static/7ac61158ec2144d7082cb6e0b059485a/b12f7/steps.png 1020w,\n/static/7ac61158ec2144d7082cb6e0b059485a/b5a09/steps.png 1360w,\n/static/7ac61158ec2144d7082cb6e0b059485a/2cefc/steps.png 1400w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Below are the steps of our demo:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHUlEQVR42q2Ta0/aYBiG+d9b3L/Ypp+mX5bMqZs6zcTMlXIoJ6UFoxwU2lJbhFGgHAQr196WYDYT55c9yZW77fPcd98e3giims0m29vbZLNZcrkckiQRjUZJJBIhiqJQqVTIZDLIskwymSSVSoWzQT8mrgXedrtNJAgcjUZ0Oh2GwyGtVotGoxHexDRNKtUKumEwGHjY9g31eh3HccK+bduhBliWxXg8XgT+zwoD5/M5C4Xpvc/4bkav7z0yEefT2YPA527qMxMzgecpj4HL8sYzHHfCTdejbFpUTJtKUzxWt4/jjbEHI1q9CS0xMxHBz65wWXZnzJXjoRcEB7+oHd5iHLl4MgzkuQDM+oiaPcD1pi8HNsSget3n6qKMmT2hnpUw8jHMXFxoHFNQvbIp1Hq0xUrD1/SvwAvdRT7voqp5zpVN1NQOmkBNblHO7wl2ObtsECt2sDqjlwML1S5HuVvkfBlZiSOlkkjJBKlcBq2kogpiZ02+Z8Wv5QwfP+Rfgb7vEzB/8ImXWuz8NHhfsHilXbOSr7KiCi02eF245k3V4eOpw+eTBpdGT9gfuL9f+JdEXNcloN9z2ZNrrH0tsb5/zsZuiY29Uqjrfxx/EL3VL0UUzWA46NHtLvxLIrqui52h0zQNDiSNt58U1rbSrD5D0Hu3qZA6vcRqGqE3yFgS0TSNgGJR4/RM5fBHmv3jNN+eYT+a5jiWZel7ym+noLNSLyjKmgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"demo\" title=\"\" src=\"/static/7e1d556e0359f2723ebc1f05cd3b4364/c5bb3/demo1.png\" srcset=\"/static/7e1d556e0359f2723ebc1f05cd3b4364/04472/demo1.png 170w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/9f933/demo1.png 340w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/c5bb3/demo1.png 680w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/b12f7/demo1.png 1020w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/0d0e4/demo1.png 1230w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"installing-opa-gatekeeper-as-crd\" style=\"position:relative;\"><a href=\"#installing-opa-gatekeeper-as-crd\" aria-label=\"installing opa gatekeeper as crd permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Installing OPA Gatekeeper as CRD</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml</code></pre></div>\n<p>This will create a namespace <code class=\"language-text\">gatekeeper-system</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get ns\nNAME                 STATUS   AGE\ndefault              Active   1h\ngatekeeper-system    Active   48s\nkube-node-lease      Active   1h\nkube-public          Active   1h\nkube-system          Active   1h\nlocal-path-storage   Active   1h</code></pre></div>\n<p>Following are the objects created as part of the Gatekeeper installation:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get all <span class=\"token parameter variable\">-n</span> gatekeeper-system\n\nNAME                                                 READY   STATUS    RESTARTS   AGE\npod/gatekeeper-audit-56ddcd8749-mlvjv                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m5s\npod/gatekeeper-controller-manager-64fd6c8cfd-cqvnw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-xgmxv   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-znxfh   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m4s\n\nNAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE\nservice/gatekeeper-webhook-service   ClusterIP   <span class=\"token number\">10.25</span>.5.7   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP   2m51s\n\nNAME                                            READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/gatekeeper-audit                <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           2m5s\ndeployment.apps/gatekeeper-controller-manager   <span class=\"token number\">3</span>/3     <span class=\"token number\">3</span>            <span class=\"token number\">3</span>           2m5s\n\nNAME                                                       DESIRED   CURRENT   READY   AGE\nreplicaset.apps/gatekeeper-audit-56ddcd8749                <span class=\"token number\">1</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       2m5s\nreplicaset.apps/gatekeeper-controller-manager-64fd6c8cfd   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       2m5s</code></pre></div>\n<p>After installing all the Gatekeeper components in the cluster, the API server will activate the Gatekeeper admission webhook to handle admission requests for resource creation, updates, and deletions. In the validation process, Gatekeeper serves as an intermediary between the API server and OPA, with the API server enforcing all policies executed by OPA.</p>\n<h3 id=\"custom-resource-definition\" style=\"position:relative;\"><a href=\"#custom-resource-definition\" aria-label=\"custom resource definition permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Custom Resource Definition</h3>\n<p>By using the <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions\" target=\"_blank\" rel=\"noopener noreferrer\">CustomResourceDefinition (CRD)</a> API, it is possible to define custom resources in Kubernetes. Once a CRD object is defined, a new custom resource can be created with a name and schema specified by the user. The Kubernetes API handles the storage and serving of these custom resources.</p>\n<p>Gatekeeper leverages the use of CustomResourceDefinitions to enforce policies on Kubernetes resources like Pods, Deployments, and Jobs, by defining ConstraintTemplates and Constraints. As part of the installation process, Gatekeeper generates multiple CRDs to facilitate the implementation of its functionalities.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get crd <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-i</span> gatekeeper\n\nassign.mutations.gatekeeper.sh                       <span class=\"token number\">2024</span>-10-30T13:34:01Z\nassignmetadata.mutations.gatekeeper.sh               <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconfigs.config.gatekeeper.sh                         <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconstraintpodstatuses.status.gatekeeper.sh           <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconstrainttemplatepodstatuses.status.gatekeeper.sh   <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconstrainttemplates.templates.gatekeeper.sh          <span class=\"token number\">2024</span>-10-30T13:34:01Z <span class=\"token comment\">#&lt;---</span>\nexpansiontemplate.expansion.gatekeeper.sh            <span class=\"token number\">2024</span>-10-30T13:34:01Z\nmodifyset.mutations.gatekeeper.sh                    <span class=\"token number\">2024</span>-10-30T13:34:01Z\nmutatorpodstatuses.status.gatekeeper.sh              <span class=\"token number\">2024</span>-10-30T13:34:01Z\nproviders.externaldata.gatekeeper.sh                 <span class=\"token number\">2024</span>-10-30T13:34:01Z</code></pre></div>\n<p>One of them is <code class=\"language-text\">constrainttemplates.templates.gatekeeper.sh</code>, which allows us to create <strong>ConstraintTemplates</strong> and <strong>Constraints</strong> to work with Gatekeeper. Now, we have all the resources, Pods, and Services running in the <code class=\"language-text\">gatekeeper-system</code> namespace.</p>\n<p>The next step is to define policies. In this example, I will create a policy using Rego that denies all namespace creation if the label <code class=\"language-text\">hr</code> is not defined. The first step is to define <strong>ConstraintTemplate</strong> and <strong>Constraint</strong> CRDs using Rego.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKUlEQVR42nWS7U/TUBTG94frJ01QiTFGkWjADwZJMFOIDAYjTAXH2+bEbcAodsBe2q7tuhXade2GP+8tQvzCaW567rnnPOc8T04iDEM8zyMIAnzfZzAYMBwOiaLo9t/v95F5Mkf6V1dX3GUJCVav11EUBV3XsSwL0zTjY9s2nU6HSqVCLpcjn89Tq9XiRncCyqlkoWVbcbGcQNof8UmTDTVNo1qtoqpq3Oh/wNFoJO7R7dQJ6fh+n74XEPQHhIOIQSDPQJxQ3ENBe0jfD4jCKKYt49IfDke4rovW1Oh2u3GjhERVmwobB6usFVKkd+b5Wl6meLLD1lGW9Z+LpLaSZIoLbFez6IbGrrLBan6B5Nos6d1PbB5m0NtazCYG/KXuMZ19yuTSY17OP2Lm2yRfBOhcboo3mXFep8Z5t/6CdPEDLaPJ5x/vmUiN8WzuAdMrz1nYm4njkmlCSqWZTcqnRaqNEqetYzTjjI7T5nejzOFZAVXEWu0GbcuIdT7Xj1H1ErXWIZbTFHTbIm5zeelda+i6F3iuLx4uKSgXbJZtMtsqubJDUfFEssuF0KrX62F3HL6XHFZ22swt77O4eS6kMgVlG9/7BygF7fUcDMthMq3zKFnn3lSBh7MnTCw1BZ0Obk/mdDFtR8hgMvZR5/7bfZ4kz3glchq62BBfAMpFvtk93WiTLeos5002SjaFI4PKiYYh4je7Kf1C9fp998Dg6NRCbYha3YgH+wv0B9djzhF4vAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"policies\" title=\"\" src=\"/static/e00ca923b84a8f84c4e28a4533ef2de3/c5bb3/policies.png\" srcset=\"/static/e00ca923b84a8f84c4e28a4533ef2de3/04472/policies.png 170w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/9f933/policies.png 340w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/c5bb3/policies.png 680w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/b12f7/policies.png 1020w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/b5a09/policies.png 1360w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/e515d/policies.png 1430w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"constraints-and-constraint-templates\" style=\"position:relative;\"><a href=\"#constraints-and-constraint-templates\" aria-label=\"constraints and constraint templates permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Constraints and Constraint Templates</h3>\n<ul>\n<li><strong>Constraints</strong>: These are rules that enforce specific policy requirements on resources in a system. They can be defined and customized by users to meet their specific needs.</li>\n<li><strong>Constraint Templates</strong>: These are reusable policy definitions that allow users to create Constraints more easily and consistently by specifying parameters for the policy rules. They provide a way to standardize policy enforcement across multiple systems and applications and can be customized and extended as needed.</li>\n</ul>\n<p>Having received a substantial amount of new information, I am now eager to explain to you how it all integrates in reality. <a href=\"https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/\" target=\"_blank\" rel=\"noopener noreferrer\">This post</a> does a great job of discussing the inter-relationships between Constraint templates and Constraint CRDs.</p>\n<p>The diagram below is my pictorial representation of the relationship:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0ElEQVR42k2R2W7bQAxF9f/fVKBAgXQB2qRxFhSObNmyPJZkRdJomUUj+5R2GjQPBwQ45CV5J3pORxZJz33SCT23ccPNYs/DVvKbnt8rzd2qo2gmVLfjUT3w4883vgu361/cPN3wVVhk9yT1imi7r3jZHIi3B17ijGSTs1ymrCWu01LyObFEPXjasSItNqSHhF22IlMJ6X5NJjlVbql0QTR2Ffq4xddHwuuFirltOA095zDB+STMwpm27Vjex6jHArXI2d0qunyAaSKMjnkKRMaMvB4zQR51Q9+39F3LIIJDrzFjh661iFkGaepaTakG6nKkEfo+4MOMdRPeeyJnjDQN+MnhvME5c41eGIeRuhlohSBbnGXL82zomoOgsL3CjTmzLZiD5XQ6y8mDpq4yqvxAe6wx2jCIgNaOVjDWy0WeeQ7Ml+t9gVbfKOLPlOtP6N0XTs1PZlNxkoLI+wnd5GRxwuExpXjaou5WVInCy9mTnOGcu043pme/lo943lEsFWWcMzYNViyyWuPHUQTdxZdK/KuwTY2VTzFFjq2qqyf+n+As072z1MeS7ti+8dpzWei9bhJbImftteH6MH3gQ+Gb4Cw+hauXIfznIvJOCIG/GbqqVmawFw4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"relationship\" title=\"\" src=\"/static/867dd8c6b6fbfc09443c3a6db355ea38/c5bb3/relationship.png\" srcset=\"/static/867dd8c6b6fbfc09443c3a6db355ea38/04472/relationship.png 170w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/9f933/relationship.png 340w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/c5bb3/relationship.png 680w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/b12f7/relationship.png 1020w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/121b3/relationship.png 1070w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Starting with the <a href=\"https://github.com/open-policy-agent/gatekeeper/blob/master/example/templates/k8srequiredlabels_template.yaml\" target=\"_blank\" rel=\"noopener noreferrer\">constraint template</a> which is a YAML file named ConstraintTemplate.yaml.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 101.76470588235296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC7ElEQVR42o1U2W7bMBDM/39QCzRFgRboQ2IjcYpcli1btnVS1EHdkhNMZ9kk7UNb52HBJbicnT3PVrGDO/8W23AD3z/AcRx4nof9fo8wDJGmqZUwCGCMwTiOGIbhryJvZ8voER/uPuLefUQQhAiiEFsCKoIcn58xHidMxyOmpyeM0/RPsDfAKAtw5y2QK4XY96HIKvYD6ChCR0ZdVaGn2LNuTgPG8R6LxwvUeYZJPpgKI2UQsKJEWxRWRK8Shb7v/w/YmxqH7IAL7xJFbTD0I/qRBnzsxYjhHiVcSpXnpwENmT0NR2yUi6vtFRx3idVqBdd14SyXUExFQYZN0zCKdwBWEipZrZM1Pj+c42Z1g9lshuvFNebzORY3C0TMZ1VXENu+OwFovXYdXDK83F7AVz4KXUAxX0mSIIkTtE2LJwk5y04zFMCubXEX3OL84RMuNxc2fMlrWATw9BbKKOoh+9LD2A+nQxYjVSrMvBnmlMXuCrrUlk3btej6zuomS9/BUFqCIU/TEQ6n5svjF6icH9veGvyajNE29fuKwrzUZYmRAE1l8N35Cm/PCt8/oMg0RjrrmZKBYtQ7+rBh792s5/ixuUKqOCXBAUkY2KmJDwekrLBMT84CSTQnJ0VCNW2Fb2Tm+muoKEYcx6xygohAshTknkmF5SMZWpZ/nMPQ/wZ8VcS7IVjLItUMtWG+ai6IjumQljm+LIc3GV9OTpJdGi/5fgOstEbOMPV+h5LsCm6dggwLWVs6RcbVJrrY5NQln3LXux2qVKM1xrK1gILecbT0zkO6cW0Dp5sNMuYwJ2hGJ9lhD73dQK1XSNZra2d1jmke+ChJoKvrF0CKTEuycpBwwRZxxHNpQYS5sBbGLT+07ISmLCwBYSUgMhivLXZmFeagZwML/ZyshIn2tvQa2d6rydikinktyF5bUAGXvItDaauRvToJYMuLSMXki9itQs+NfODdyCd5k6KJsGgV3yvDNzordWZtBUMG5CdyQu8hCCeizAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"ConstraintTemplate\" title=\"\" src=\"/static/1e24eb0a6e52e4b823d09161e8674449/c5bb3/ConstraintTemplate.png\" srcset=\"/static/1e24eb0a6e52e4b823d09161e8674449/04472/ConstraintTemplate.png 170w,\n/static/1e24eb0a6e52e4b823d09161e8674449/9f933/ConstraintTemplate.png 340w,\n/static/1e24eb0a6e52e4b823d09161e8674449/c5bb3/ConstraintTemplate.png 680w,\n/static/1e24eb0a6e52e4b823d09161e8674449/57dc1/ConstraintTemplate.png 718w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Create the ConstraintTemplate using the above-defined manifests:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> ConstraintTemplate.yaml\n<span class=\"token comment\">#„ÄÄList the available ConstraintTemplate's </span>\nkubectl get ConstraintTemplate\nNAME                AGE\nk8srequiredlabels   59s\nConstraint: Namespace label</code></pre></div>\n<p>Let's generate a Constraint specification in the file <code class=\"language-text\">ns-enforce-label.yaml</code> that mandates a namespace to have a label named \"hr\" whenever it is generated.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 606px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 61.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACCElEQVR42oWTWW/aQBSF+f9/ppX60ohIVF0CaVhCxFaMd2PwhjHjHdDXsRNVfWjJw9HRSL6fz71zpyNywcJdsN6vWTkzjL1CEkW4lsXesdm9uWuZmIaBab6653u4rst2u0XTNWzb5nQ60fGOHnerO4bKI4NBj6+De+aTMbPRiMnjI6N+X54nqPMZ5nqN7TgYEuj7Pp7ntWpgDTxNUzrhKaCn9BhrQ0aT7+irJc5mQ9B8pGm4uo4vUwoJqGTB5XrlcrlQ1zXnRudze268LEs6WZEx2874LFN+eelirCVQU7E2CraqtqlcQ0JNoy0oiqJV+eZ/qwUWVcHUmTK1X4ia+MqGzXIhwetWynzegpuUTcF76giR0Bt/Yrj4hmtrVMcjRXwgf1PZnA8HskNEGgYIqZvAMss5RD4/zSful1282ONaXzlXZ+qq/tNK02JZVSRylkWe/x+YihNlIohExNR6ZmKOsUILzVdx4i0izRBJQiYhZzn8JAhuA/NUkMkCrrSJ+nqf7qrLszXh5dcTrqLgGxqh3EUhWw/d3WvaWy27noUe6iie0gIf1AcS+aM0ijnaFvHWIZZ+DHwCuW+3gWmOs9N5Mod8nH5goA/QdwaxvHERx2SyuJY7Vsmdq9uW35lhJmTLXsDO1Rkuf6DocwL5Gjx1gy+XOpRP6yTn1lxG4/F+3wKLf+xho99ROoIi0ofYDAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Constraint\" title=\"\" src=\"/static/1cbee96c7efa1a130354bacbf2c2844a/4d4a2/Constraint.png\" srcset=\"/static/1cbee96c7efa1a130354bacbf2c2844a/04472/Constraint.png 170w,\n/static/1cbee96c7efa1a130354bacbf2c2844a/9f933/Constraint.png 340w,\n/static/1cbee96c7efa1a130354bacbf2c2844a/4d4a2/Constraint.png 606w\" sizes=\"(max-width: 606px) 100vw, 606px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Create the Constraint on our Kubernetes cluster and list the available constraints:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> ns-enforce-label.yaml\n<span class=\"token comment\"># List the available Constraints</span>\nkubectl get constraints\nNAME                      ENFORCEMENT-ACTION   TOTAL-VIOLATIONS\nns-must-have-hr                                 <span class=\"token number\">13</span></code></pre></div>\n<p>Next, create a namespace without defining the required label, which is \"hr\" in this case:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create ns demo\nError from server <span class=\"token punctuation\">(</span>Forbidden<span class=\"token punctuation\">)</span>: admission webhook <span class=\"token string\">\"validation.gatekeeper.sh\"</span> denied the request: <span class=\"token punctuation\">[</span>ns-must-have-hr<span class=\"token punctuation\">]</span> you must provide labels: <span class=\"token punctuation\">{</span><span class=\"token string\">\"hr\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, create a namespace using the required label and observe the result:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># demo-ns.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">hr</span><span class=\"token punctuation\">:</span> foo   <span class=\"token comment\">#&lt;---</span>\n<span class=\"token punctuation\">---</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> demo-ns.yaml\nnamespace/demo created</code></pre></div>\n<p>In the above demonstration, we can see that the namespace is created without any issues because we specified the required label.</p>\n<h2 id=\"-conclusion-\" style=\"position:relative;\"><a href=\"#-conclusion-\" aria-label=\" conclusion  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåü Conclusion üåü</h2>\n<p>OPA enables developers to write and implement policies as code, making it easier to enforce and validate policies across an organization's infrastructure. This blog discussed the importance of policy as code, the structure of OPA policies, and how they can be used to enforce policies in Kubernetes.</p>\n<p>I hope you enjoyed this hands-on tutorial and learned more than you knew before. Let me know if you have any questions related to this blog.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.x</p>","timeToRead":6,"rawMarkdownBody":"\n> **Building a Fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code Keep Your Cluster Safe üõ°Ô∏è**\n\n## Introduction\n\nAs organizations adopt Kubernetes as their container orchestration platform, policy management becomes increasingly important. Traditional approaches to policy enforcement can be time-consuming and error-prone.\n\nManual policy reviews and audits create delays and introduce human error. In dynamic cloud environments, policies need to be constantly updated to reflect changes in the infrastructure.\n\nPolicy as Code (PaC) with [Open Policy Agent (OPA)](https://www.openpolicyagent.org/docs/latest/) for Kubernetes provides an automated and efficient solution. PaC allows easy policy integration into CI/CD pipelines. This approach ensures consistent policy enforcement and reduces human error risk.\n\n![bad pod](./bad-pod.jpg)\n\n## üéØ Goals & Objectives\n\nIn this article, we will explore how Policy as Code (PaC) with Open Policy Agent (OPA) for Kubernetes can streamline policy enforcement.  \n**HAPPY LEARNING üíª**\n\n![opa](./opa.png)\n\nTo properly evaluate PaC with OPA, it's essential to first understand Policy as Code.\n\n### Policy as Code\n\nPolicy as Code involves managing policy enforcement using machine-readable definition files, rather than documentation or interactive configuration tools. The primary goal is to ensure consistent enforcement of standards and rules across clusters or organizations.\n\nOnce policies are established, the next step is to enforce them effectively. This is where tools like [OPA](https://github.com/open-policy-agent/opa) and [Kyverno](https://github.com/kyverno/kyverno) come into play.\n\n### Open Policy Agent (OPA)\n\n[Open Policy Agent (OPA)](https://www.openpolicyagent.org/) is an open-source tool that enables creating, validating, and enforcing policies across systems, including Kubernetes. OPA uses the declarative Rego language to define policies as code, enabling easy integration into CI/CD pipelines. It ensures consistent, efficient policy enforcement, reduces human error risk, and provides policy management flexibility based on specific use cases and requirements.\n\nTo expand on the capabilities of OPA in Kubernetes, let's explore the additional features provided by OPA Gatekeeper, a policy controller that runs on top of OPA.\n\n### OPA Gatekeeper\n\n[OPA Gatekeeper](https://open-policy-agent.github.io/gatekeeper) is a policy controller that runs on top of OPA in Kubernetes. It extends the functionality of OPA by enabling users to enforce policies at scale across multiple Kubernetes clusters. Gatekeeper uses the same declarative policy language as OPA, Rego, to define policies as code.\n\nGatekeeper integrates with Kubernetes' admission controller mechanism, which allows it to evaluate policies before resources are created or updated. This ensures that only resources that meet the defined policies are allowed to run, reducing the risk of security vulnerabilities and ensuring compliance.\n\n![opa-gatekeeper](./opa-gatekeeper.png)\n\n### Admission Controllers\n\nAdmission controllers in Kubernetes intercept API requests, validate them against specific criteria, and mutate them if necessary. There are two types of admission controllers: mutating admission controllers and validating admission controllers. Mutating admission controllers modify requests while validating admission controllers check requests for compliance with pre-defined policies. They are a powerful tool for enforcing policies and ensuring consistency in Kubernetes environments.\n\n![steps](./steps.png)\n\nBelow are the steps of our demo:\n\n![demo](./demo1.png)\n\n### Installing OPA Gatekeeper as CRD\n\n```shell\nkubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml\n```\n\nThis will create a namespace `gatekeeper-system`:\n\n```shell\nkubectl get ns\nNAME                 STATUS   AGE\ndefault              Active   1h\ngatekeeper-system    Active   48s\nkube-node-lease      Active   1h\nkube-public          Active   1h\nkube-system          Active   1h\nlocal-path-storage   Active   1h\n```\n\nFollowing are the objects created as part of the Gatekeeper installation:\n\n```shell\nkubectl get all -n gatekeeper-system\n\nNAME                                                 READY   STATUS    RESTARTS   AGE\npod/gatekeeper-audit-56ddcd8749-mlvjv                1/1     Running   0          2m5s\npod/gatekeeper-controller-manager-64fd6c8cfd-cqvnw   1/1     Running   0          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-xgmxv   1/1     Running   0          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-znxfh   1/1     Running   0          2m4s\n\nNAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE\nservice/gatekeeper-webhook-service   ClusterIP   10.25.5.7   <none>        443/TCP   2m51s\n\nNAME                                            READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/gatekeeper-audit                1/1     1            1           2m5s\ndeployment.apps/gatekeeper-controller-manager   3/3     3            3           2m5s\n\nNAME                                                       DESIRED   CURRENT   READY   AGE\nreplicaset.apps/gatekeeper-audit-56ddcd8749                1         1         1       2m5s\nreplicaset.apps/gatekeeper-controller-manager-64fd6c8cfd   3         3         3       2m5s\n```\n\nAfter installing all the Gatekeeper components in the cluster, the API server will activate the Gatekeeper admission webhook to handle admission requests for resource creation, updates, and deletions. In the validation process, Gatekeeper serves as an intermediary between the API server and OPA, with the API server enforcing all policies executed by OPA.\n\n### Custom Resource Definition\n\nBy using the [CustomResourceDefinition (CRD)](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions) API, it is possible to define custom resources in Kubernetes. Once a CRD object is defined, a new custom resource can be created with a name and schema specified by the user. The Kubernetes API handles the storage and serving of these custom resources.\n\nGatekeeper leverages the use of CustomResourceDefinitions to enforce policies on Kubernetes resources like Pods, Deployments, and Jobs, by defining ConstraintTemplates and Constraints. As part of the installation process, Gatekeeper generates multiple CRDs to facilitate the implementation of its functionalities.\n\n```shell\nkubectl get crd | grep -i gatekeeper\n\nassign.mutations.gatekeeper.sh                       2024-10-30T13:34:01Z\nassignmetadata.mutations.gatekeeper.sh               2024-10-30T13:34:01Z\nconfigs.config.gatekeeper.sh                         2024-10-30T13:34:01Z\nconstraintpodstatuses.status.gatekeeper.sh           2024-10-30T13:34:01Z\nconstrainttemplatepodstatuses.status.gatekeeper.sh   2024-10-30T13:34:01Z\nconstrainttemplates.templates.gatekeeper.sh          2024-10-30T13:34:01Z #<---\nexpansiontemplate.expansion.gatekeeper.sh            2024-10-30T13:34:01Z\nmodifyset.mutations.gatekeeper.sh                    2024-10-30T13:34:01Z\nmutatorpodstatuses.status.gatekeeper.sh              2024-10-30T13:34:01Z\nproviders.externaldata.gatekeeper.sh                 2024-10-30T13:34:01Z\n```\n\nOne of them is `constrainttemplates.templates.gatekeeper.sh`, which allows us to create **ConstraintTemplates** and **Constraints** to work with Gatekeeper. Now, we have all the resources, Pods, and Services running in the `gatekeeper-system` namespace.\n\nThe next step is to define policies. In this example, I will create a policy using Rego that denies all namespace creation if the label `hr` is not defined. The first step is to define **ConstraintTemplate** and **Constraint** CRDs using Rego.\n\n![policies](./policies.png)\n\n### Constraints and Constraint Templates\n\n- **Constraints**: These are rules that enforce specific policy requirements on resources in a system. They can be defined and customized by users to meet their specific needs.\n- **Constraint Templates**: These are reusable policy definitions that allow users to create Constraints more easily and consistently by specifying parameters for the policy rules. They provide a way to standardize policy enforcement across multiple systems and applications and can be customized and extended as needed.\n\nHaving received a substantial amount of new information, I am now eager to explain to you how it all integrates in reality. [This post](https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/) does a great job of discussing the inter-relationships between Constraint templates and Constraint CRDs.\n\nThe diagram below is my pictorial representation of the relationship:\n\n![relationship](./relationship.png)\n\nStarting with the [constraint template](https://github.com/open-policy-agent/gatekeeper/blob/master/example/templates/k8srequiredlabels_template.yaml) which is a YAML file named ConstraintTemplate.yaml.\n\n![ConstraintTemplate](./ConstraintTemplate.png)\n\nCreate the ConstraintTemplate using the above-defined manifests:\n\n```shell\nkubectl create -f ConstraintTemplate.yaml\n#„ÄÄList the available ConstraintTemplate's \nkubectl get ConstraintTemplate\nNAME                AGE\nk8srequiredlabels   59s\nConstraint: Namespace label\n```\n\nLet's generate a Constraint specification in the file `ns-enforce-label.yaml` that mandates a namespace to have a label named \"hr\" whenever it is generated.\n\n![Constraint](./Constraint.png)\n\nCreate the Constraint on our Kubernetes cluster and list the available constraints:\n\n```shell\nkubectl create -f ns-enforce-label.yaml\n# List the available Constraints\nkubectl get constraints\nNAME                      ENFORCEMENT-ACTION   TOTAL-VIOLATIONS\nns-must-have-hr                                 13\n```\n\nNext, create a namespace without defining the required label, which is \"hr\" in this case:\n\n```shell\nkubectl create ns demo\nError from server (Forbidden): admission webhook \"validation.gatekeeper.sh\" denied the request: [ns-must-have-hr] you must provide labels: {\"hr\"}\n```\n\nNow, create a namespace using the required label and observe the result:\n\n```yaml\n# demo-ns.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n    name: demo\n    labels:\n        hr: foo   #<---\n---\n```\n\n```shell\nkubectl create -f demo-ns.yaml\nnamespace/demo created\n```\n\nIn the above demonstration, we can see that the namespace is created without any issues because we specified the required label.\n\n## üåü Conclusion üåü\n\nOPA enables developers to write and implement policies as code, making it easier to enforce and validate policies across an organization's infrastructure. This blog discussed the importance of policy as code, the structure of OPA policies, and how they can be used to enforce policies in Kubernetes.\n\nI hope you enjoyed this hands-on tutorial and learned more than you knew before. Let me know if you have any questions related to this blog.\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.x\n","wordCount":{"words":1065},"frontmatter":{"id":"cbd7fa24308175b6fbf7aba7","path":"/blog/kubernetes-opa-gatekeeper-policy-as-code/","humanDate":"Oct 31, 2024","fullDate":"2024-10-31","title":"Securing Your Kubernetes Cluster with OPA Gatekeeper: The Power of Policy-as-Code üõ°Ô∏è","keywords":["Kubernetes","OPA Gatekeeper","Policy-as-Code","k8s","DevOps"],"excerpt":"Building a fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code keep your cluster safe.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVR42o1S30vbUBTuP+ce9iCD4RgIMvag+CKbok8q23TYB1+cfVCczBcVDIo/5lprEtMkNElb2tXAOmTYQlttSGL60/Te9qaepLa+DT9uLt+5937nfPfc+BzHsW2746Hdbvf5c+AzTbNYLOpWOZpI6oaRy+UQQpCREOJ46JL+3AeEvjvTPAqGF9e23k/OjH6c4iIRqP/cyvCt7x7Mr258XQkMvH6zd3isyLIkSalUSlVVnudZlqUZGng2m+MFMRaLpdNpWC8UCq54P8zOLAfefZgeHB6JRKVEPE5RlCAIiqJkMhlRFC84jmE5RZbUdPL75g+aYQSez+fzrhguwMiJibkvqUsVwu5VXdKz50UdrUxuLAJt7e4+2gbgVkszjN7RJ1XvFcjar8rQkvbWX/JTVt0mHcdrmFvZcfLFm1q9rumGbt7phgm8Uq3BsCpVgu+T/9Dg59J6sEqJjVcL2onScDMSrzJCOPH7kuaEw9PQSegcSIi+OA0zP8+Yo+C5dpvdidij3/T4FYIs05vm0l75Sezp0b1tY9wCAiYxxhDWavUmwuDsutR6OV/6tG35qfKL2Vvpb9Pz2xP/B/A7wBz90xwPGGOrxrHc6LfwAXBJRlOL/TQMAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/0d302c8dc1d23228ca71bf4d2b37e947/211a3/opa-gatekeeper-cover.png","srcSet":"/static/0d302c8dc1d23228ca71bf4d2b37e947/596c0/opa-gatekeeper-cover.png 750w,\n/static/0d302c8dc1d23228ca71bf4d2b37e947/211a3/opa-gatekeeper-cover.png 840w","sizes":"100vw"},"sources":[{"srcSet":"/static/0d302c8dc1d23228ca71bf4d2b37e947/4c8c9/opa-gatekeeper-cover.webp 750w,\n/static/0d302c8dc1d23228ca71bf4d2b37e947/ab556/opa-gatekeeper-cover.webp 840w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5714285714285714}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/eks-upgrade-guide/","title":"EKS cluster upgrades: A Step-by-Step guide to a secure Process","date":"2024-10-31 21:30:00"},"excerpt":"A Step-by-Step upgrade handbook üìö Introduction The cloud computing landscape is constantly evolving, and it can be difficult to keep up‚Ä¶"},"nextThought":{"frontmatter":{"path":"/blog/kubernetes-validation-cel/","title":"Introducing Kubernetes Validation with Common Expression Language (CEL) ‚òØ","date":"2024-10-31 19:30:00"},"excerpt":"Simplify Complex Validations with CEL and Kyverno Policies ‚òØ üîÜ Introduction Kubernetes is extensible and allows users to create Custom‚Ä¶"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}