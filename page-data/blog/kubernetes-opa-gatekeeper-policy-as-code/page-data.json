{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/kubernetes-opa-gatekeeper-policy-as-code/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Building a Fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code Keep Your Cluster Safe üõ°Ô∏è</strong></p>\n</blockquote>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Introduction</h2>\n<p>As organizations adopt Kubernetes as their container orchestration platform, policy management becomes increasingly important. Traditional approaches to policy enforcement can be time-consuming and error-prone.</p>\n<p>Manual policy reviews and audits create delays and introduce human error. In dynamic cloud environments, policies need to be constantly updated to reflect changes in the infrastructure.</p>\n<p>Policy as Code (PaC) with <a href=\"https://www.openpolicyagent.org/docs/latest/\" target=\"_blank\" rel=\"noopener noreferrer\">Open Policy Agent (OPA)</a> for Kubernetes provides an automated and efficient solution. PaC allows easy policy integration into CI/CD pipelines. This approach ensures consistent policy enforcement and reduces human error risk.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.352941176470594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAUEBv/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAa8vfCOqB//EABsQAAEEAwAAAAAAAAAAAAAAAAMAAQQ0AhET/9oACAEBAAEFAjvoQc26qZXj2F//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAdEAAABgMBAAAAAAAAAAAAAAAAAQIQIXEREkFh/9oACAEBAAY/AjnHpBMa8tlBFt//xAAbEAEAAQUBAAAAAAAAAAAAAAABEQAQIUGxYf/aAAgBAQABPyE3qxjYVBpeW9uPtJc9n//aAAwDAQACAAMAAAAQU8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAfEAEAAgIABwAAAAAAAAAAAAABABEhMRBBYYGRobH/2gAIAQEAAT8QBfLoWjgQ7ysHK1FjHPBRi/HD0vhLgTjt6MNT/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"bad pod\" title=\"\" src=\"/static/330135c77f8164bfe91aa3e5f420962c/7bf67/bad-pod.jpg\" srcset=\"/static/330135c77f8164bfe91aa3e5f420962c/651be/bad-pod.jpg 170w,\n/static/330135c77f8164bfe91aa3e5f420962c/d30a3/bad-pod.jpg 340w,\n/static/330135c77f8164bfe91aa3e5f420962c/7bf67/bad-pod.jpg 680w,\n/static/330135c77f8164bfe91aa3e5f420962c/990cb/bad-pod.jpg 1020w,\n/static/330135c77f8164bfe91aa3e5f420962c/e5166/bad-pod.jpg 1200w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-goals--objectives\" style=\"position:relative;\"><a href=\"#-goals--objectives\" aria-label=\" goals  objectives permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üéØ Goals &#x26; Objectives</h2>\n<p>In this article, we will explore how Policy as Code (PaC) with Open Policy Agent (OPA) for Kubernetes can streamline policy enforcement.<br>\n<strong>HAPPY LEARNING üíª</strong></p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 580px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 76.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAklEQVR42p2TXUhTYRjHR9+uTcHlljXSCkFQ2lUjiiLqoi6ivOkiyUgsYXkZRUZBQdIh6MMMFn1ABBHREMfSm75WUA5FsLwI8i5OY07Mcjt+nfOeX2fHLftgndUDL++B87y/5/0/z/+18Q+h66AJYye763/m2AoCCWEc1n9AZ1Q9b66tcJhgPKXREZ6g8cooN7snSE/NF7EE6ppmLNX8jstxQ6NCRyRNc/soD16kOXgpyb2nKfO/JvQCgNmyib4YIf8G7jQdInA1QTDylWF5mmtd3zh+e8z6hjlQ8nWUaN1uQh4H0vatBCrdnD4Vov4WSKEUe8+N0PVWMXNFPmCmX5mY+SzTWeUluqqY9jIHh8vL2Fdip6fxAOfbejh6IkqkV7EeSg44O/yRizu2Ie/cRGylg7MlS5FK7bx3LaPbs4jHZ06aeaomLKZsyDVvn4gj7dnFh80+givs3PW6eL7OQ2d1Bc+cC3nU2jo3DFW1BpoxqRAOHKHPX8P+5Uvor12LvMVHor6OfncRseCNud5ZAn+S/VJqY2BjDdPrXXyqLOXN6mKUWi9ht4ORWO8vuQUBk4MDXKgo54lzgdG/IhoW2zjmtPOwpdlUIn73y998mLPOl6F3vGpqQKpaw32/j6Hrlw1/pyEPzNLYOfDs+Bja1OR8Mf0/33JGvsi2IAMSxnO0iu/S5SwgYdyhTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"opa\" title=\"\" src=\"/static/626ecdac374ce2e2c867cb3db477b4cd/b6272/opa.png\" srcset=\"/static/626ecdac374ce2e2c867cb3db477b4cd/04472/opa.png 170w,\n/static/626ecdac374ce2e2c867cb3db477b4cd/9f933/opa.png 340w,\n/static/626ecdac374ce2e2c867cb3db477b4cd/b6272/opa.png 580w\" sizes=\"(max-width: 580px) 100vw, 580px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>To properly evaluate PaC with OPA, it's essential to first understand Policy as Code.</p>\n<h3 id=\"policy-as-code\" style=\"position:relative;\"><a href=\"#policy-as-code\" aria-label=\"policy as code permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Policy as Code</h3>\n<p>Policy as Code involves managing policy enforcement using machine-readable definition files, rather than documentation or interactive configuration tools. The primary goal is to ensure consistent enforcement of standards and rules across clusters or organizations.</p>\n<p>Once policies are established, the next step is to enforce them effectively. This is where tools like <a href=\"https://github.com/open-policy-agent/opa\" target=\"_blank\" rel=\"noopener noreferrer\">OPA</a> and <a href=\"https://github.com/kyverno/kyverno\" target=\"_blank\" rel=\"noopener noreferrer\">Kyverno</a> come into play.</p>\n<h3 id=\"open-policy-agent-opa\" style=\"position:relative;\"><a href=\"#open-policy-agent-opa\" aria-label=\"open policy agent opa permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Open Policy Agent (OPA)</h3>\n<p><a href=\"https://www.openpolicyagent.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Open Policy Agent (OPA)</a> is an open-source tool that enables creating, validating, and enforcing policies across systems, including Kubernetes. OPA uses the declarative Rego language to define policies as code, enabling easy integration into CI/CD pipelines. It ensures consistent, efficient policy enforcement, reduces human error risk, and provides policy management flexibility based on specific use cases and requirements.</p>\n<p>To expand on the capabilities of OPA in Kubernetes, let's explore the additional features provided by OPA Gatekeeper, a policy controller that runs on top of OPA.</p>\n<h3 id=\"opa-gatekeeper\" style=\"position:relative;\"><a href=\"#opa-gatekeeper\" aria-label=\"opa gatekeeper permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>OPA Gatekeeper</h3>\n<p><a href=\"https://open-policy-agent.github.io/gatekeeper\" target=\"_blank\" rel=\"noopener noreferrer\">OPA Gatekeeper</a> is a policy controller that runs on top of OPA in Kubernetes. It extends the functionality of OPA by enabling users to enforce policies at scale across multiple Kubernetes clusters. Gatekeeper uses the same declarative policy language as OPA, Rego, to define policies as code.</p>\n<p>Gatekeeper integrates with Kubernetes' admission controller mechanism, which allows it to evaluate policies before resources are created or updated. This ensures that only resources that meet the defined policies are allowed to run, reducing the risk of security vulnerabilities and ensuring compliance.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAChUlEQVR42jWR2U8TYRTF+4+pUWNc0OiT4cHEFWNijAZ5EDcsCJGIS9UGMSIQd42KaDRojL4YVxaxgGg705npTNuZLtNpZ6alxZ9fqz6cnJO7nHvv9wU+zlqcfaQQGtPoe6zQdV+nU+DUPYG7Ot0PDfqeGPQ+MgiKWB31/H9drz8p6sLPDYpFl8DlMYV919P0jObYO6Cz7ITK8g6DNV0a604rbD6jsjNs0HwhwepgglVBjZWnVKG1hl4l9IoOUdutETdyBK691GgdSXJ13KJtRKWlX2VbSGXXZYngA4P9AzHab6m039bZ2ic3OPTC5NgdndZBiXPPTM4/T4teDTmRJXDxqd6YtqVX5eCQQXg8z7G7SZrPSXTcT3FUmLUNy/Q8TrM9JHNgUOe4MDt0Q2d3WOHITV3AYE//P8Oh10mxeoKNp2PsvhKld9Tk8LDOph6ZlrAkzBR2XfpF65DKjpDEWvEUTd0SG7pirBdnNnX+FE+jiasMkpZNIGsXmVNdvs7pfJlN8HkuxZcfGaaiNh8jKaYFRxSXGckRXGJGdng/Y/D1h0kkXuRTJMm7CYWFeAbfF5/ieR6wxGKlTKXs4xdzSPNTuPmUCPtQE/lqSbDbQNW3sa0Erp0mb+nk0grfJj/jFGw8z68b+jhOkYnJKVJJA8oFHDuLW8iS1lXRmGXJzVJ1zAZqns3Sok/FdbDSycbAmpenWvtNqVT6u2G5XMbKZMhnUmKzNAWnhGma/IpKJOJRcnoUTZF48/YVdkrCLhT4/j0ierKNq6pFk8VqDbduWHeNxWIsLPxElmVKOZ2ipQiolO0kXi5BJROlYgljdYZFWxOXWxjyLPPTH4jPT+I7Fp5fpr7cH5mEnjtrb/tjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"opa-gatekeeper\" title=\"\" src=\"/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/c5bb3/opa-gatekeeper.png\" srcset=\"/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/04472/opa-gatekeeper.png 170w,\n/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/9f933/opa-gatekeeper.png 340w,\n/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/c5bb3/opa-gatekeeper.png 680w,\n/static/ba0fd96ef4e497eeafbf1aba8bfb27a7/146da/opa-gatekeeper.png 943w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"admission-controllers\" style=\"position:relative;\"><a href=\"#admission-controllers\" aria-label=\"admission controllers permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Admission Controllers</h3>\n<p>Admission controllers in Kubernetes intercept API requests, validate them against specific criteria, and mutate them if necessary. There are two types of admission controllers: mutating admission controllers and validating admission controllers. Mutating admission controllers modify requests while validating admission controllers check requests for compliance with pre-defined policies. They are a powerful tool for enforcing policies and ensuring consistency in Kubernetes environments.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABcElEQVR42q2QzUsbURTF8w+6qVl004Xb7qQbS1GxFFyVghJKoYg7UUQLXbbatIIhxqlpY7SNJppo4sw0mZl8zOfLm58vExAXWfbC45577jn3Xl5KCIHnRxhWwD87JIykwmFSBwq3nRBT8X4o6XSVTmEvGOL0xx7XHxKo3qge6VOeNyCr3TI9f8TMskb2xCC9kCc9n2dfM3j+tsizN8d8Kei8yJR4ulTg00GT1+vnPHmVZzt7y/vdGlNzOTa+NkihojuI0P62+X1pYfcCfql8UmljdT2VLQ5LJnpnQKXe4axmqctczusOP4o6TbPHVdMmd2oojTceOCk8d4BhtNQXRLiuT+O6imO1ESLC1FuKc/H9AOPuBsfuKEec+JKBIyjjOHkjPIzjhHX6AR8/X5PZqVL8oxNLkfTDSLC5d8O7rQu+a81kkJCSWPkmXhiPl2H3QxbXyrz8UKJ81X3oi6FkZbvC7GqRbz/NhJPy0YX/M+4BpjsGLXNWy+QAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"steps\" title=\"\" src=\"/static/7ac61158ec2144d7082cb6e0b059485a/c5bb3/steps.png\" srcset=\"/static/7ac61158ec2144d7082cb6e0b059485a/04472/steps.png 170w,\n/static/7ac61158ec2144d7082cb6e0b059485a/9f933/steps.png 340w,\n/static/7ac61158ec2144d7082cb6e0b059485a/c5bb3/steps.png 680w,\n/static/7ac61158ec2144d7082cb6e0b059485a/b12f7/steps.png 1020w,\n/static/7ac61158ec2144d7082cb6e0b059485a/b5a09/steps.png 1360w,\n/static/7ac61158ec2144d7082cb6e0b059485a/2cefc/steps.png 1400w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Below are the steps of our demo:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHUlEQVR42q2Ta0/aYBiG+d9b3L/Ypp+mX5bMqZs6zcTMlXIoJ6UFoxwU2lJbhFGgHAQr196WYDYT55c9yZW77fPcd98e3giims0m29vbZLNZcrkckiQRjUZJJBIhiqJQqVTIZDLIskwymSSVSoWzQT8mrgXedrtNJAgcjUZ0Oh2GwyGtVotGoxHexDRNKtUKumEwGHjY9g31eh3HccK+bduhBliWxXg8XgT+zwoD5/M5C4Xpvc/4bkav7z0yEefT2YPA527qMxMzgecpj4HL8sYzHHfCTdejbFpUTJtKUzxWt4/jjbEHI1q9CS0xMxHBz65wWXZnzJXjoRcEB7+oHd5iHLl4MgzkuQDM+oiaPcD1pi8HNsSget3n6qKMmT2hnpUw8jHMXFxoHFNQvbIp1Hq0xUrD1/SvwAvdRT7voqp5zpVN1NQOmkBNblHO7wl2ObtsECt2sDqjlwML1S5HuVvkfBlZiSOlkkjJBKlcBq2kogpiZ02+Z8Wv5QwfP+Rfgb7vEzB/8ImXWuz8NHhfsHilXbOSr7KiCi02eF245k3V4eOpw+eTBpdGT9gfuL9f+JdEXNcloN9z2ZNrrH0tsb5/zsZuiY29Uqjrfxx/EL3VL0UUzWA46NHtLvxLIrqui52h0zQNDiSNt58U1rbSrD5D0Hu3qZA6vcRqGqE3yFgS0TSNgGJR4/RM5fBHmv3jNN+eYT+a5jiWZel7ym+noLNSLyjKmgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"demo\" title=\"\" src=\"/static/7e1d556e0359f2723ebc1f05cd3b4364/c5bb3/demo1.png\" srcset=\"/static/7e1d556e0359f2723ebc1f05cd3b4364/04472/demo1.png 170w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/9f933/demo1.png 340w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/c5bb3/demo1.png 680w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/b12f7/demo1.png 1020w,\n/static/7e1d556e0359f2723ebc1f05cd3b4364/0d0e4/demo1.png 1230w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"installing-opa-gatekeeper-as-crd\" style=\"position:relative;\"><a href=\"#installing-opa-gatekeeper-as-crd\" aria-label=\"installing opa gatekeeper as crd permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Installing OPA Gatekeeper as CRD</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml</code></pre></div>\n<p>This will create a namespace <code class=\"language-text\">gatekeeper-system</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get ns\nNAME                 STATUS   AGE\ndefault              Active   1h\ngatekeeper-system    Active   48s\nkube-node-lease      Active   1h\nkube-public          Active   1h\nkube-system          Active   1h\nlocal-path-storage   Active   1h</code></pre></div>\n<p>Following are the objects created as part of the Gatekeeper installation:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get all <span class=\"token parameter variable\">-n</span> gatekeeper-system\n\nNAME                                                 READY   STATUS    RESTARTS   AGE\npod/gatekeeper-audit-56ddcd8749-mlvjv                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m5s\npod/gatekeeper-controller-manager-64fd6c8cfd-cqvnw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-xgmxv   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-znxfh   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m4s\n\nNAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE\nservice/gatekeeper-webhook-service   ClusterIP   <span class=\"token number\">10.25</span>.5.7   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP   2m51s\n\nNAME                                            READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/gatekeeper-audit                <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           2m5s\ndeployment.apps/gatekeeper-controller-manager   <span class=\"token number\">3</span>/3     <span class=\"token number\">3</span>            <span class=\"token number\">3</span>           2m5s\n\nNAME                                                       DESIRED   CURRENT   READY   AGE\nreplicaset.apps/gatekeeper-audit-56ddcd8749                <span class=\"token number\">1</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       2m5s\nreplicaset.apps/gatekeeper-controller-manager-64fd6c8cfd   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       2m5s</code></pre></div>\n<p>After installing all the Gatekeeper components in the cluster, the API server will activate the Gatekeeper admission webhook to handle admission requests for resource creation, updates, and deletions. In the validation process, Gatekeeper serves as an intermediary between the API server and OPA, with the API server enforcing all policies executed by OPA.</p>\n<h3 id=\"custom-resource-definition\" style=\"position:relative;\"><a href=\"#custom-resource-definition\" aria-label=\"custom resource definition permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Custom Resource Definition</h3>\n<p>By using the <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions\" target=\"_blank\" rel=\"noopener noreferrer\">CustomResourceDefinition (CRD)</a> API, it is possible to define custom resources in Kubernetes. Once a CRD object is defined, a new custom resource can be created with a name and schema specified by the user. The Kubernetes API handles the storage and serving of these custom resources.</p>\n<p>Gatekeeper leverages the use of CustomResourceDefinitions to enforce policies on Kubernetes resources like Pods, Deployments, and Jobs, by defining ConstraintTemplates and Constraints. As part of the installation process, Gatekeeper generates multiple CRDs to facilitate the implementation of its functionalities.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get crd <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-i</span> gatekeeper\n\nassign.mutations.gatekeeper.sh                       <span class=\"token number\">2024</span>-10-30T13:34:01Z\nassignmetadata.mutations.gatekeeper.sh               <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconfigs.config.gatekeeper.sh                         <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconstraintpodstatuses.status.gatekeeper.sh           <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconstrainttemplatepodstatuses.status.gatekeeper.sh   <span class=\"token number\">2024</span>-10-30T13:34:01Z\nconstrainttemplates.templates.gatekeeper.sh          <span class=\"token number\">2024</span>-10-30T13:34:01Z <span class=\"token comment\">#&lt;---</span>\nexpansiontemplate.expansion.gatekeeper.sh            <span class=\"token number\">2024</span>-10-30T13:34:01Z\nmodifyset.mutations.gatekeeper.sh                    <span class=\"token number\">2024</span>-10-30T13:34:01Z\nmutatorpodstatuses.status.gatekeeper.sh              <span class=\"token number\">2024</span>-10-30T13:34:01Z\nproviders.externaldata.gatekeeper.sh                 <span class=\"token number\">2024</span>-10-30T13:34:01Z</code></pre></div>\n<p>One of them is <code class=\"language-text\">constrainttemplates.templates.gatekeeper.sh</code>, which allows us to create <strong>ConstraintTemplates</strong> and <strong>Constraints</strong> to work with Gatekeeper. Now, we have all the resources, Pods, and Services running in the <code class=\"language-text\">gatekeeper-system</code> namespace.</p>\n<p>The next step is to define policies. In this example, I will create a policy using Rego that denies all namespace creation if the label <code class=\"language-text\">hr</code> is not defined. The first step is to define <strong>ConstraintTemplate</strong> and <strong>Constraint</strong> CRDs using Rego.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKUlEQVR42nWS7U/TUBTG94frJ01QiTFGkWjADwZJMFOIDAYjTAXH2+bEbcAodsBe2q7tuhXade2GP+8tQvzCaW567rnnPOc8T04iDEM8zyMIAnzfZzAYMBwOiaLo9t/v95F5Mkf6V1dX3GUJCVav11EUBV3XsSwL0zTjY9s2nU6HSqVCLpcjn89Tq9XiRncCyqlkoWVbcbGcQNof8UmTDTVNo1qtoqpq3Oh/wNFoJO7R7dQJ6fh+n74XEPQHhIOIQSDPQJxQ3ENBe0jfD4jCKKYt49IfDke4rovW1Oh2u3GjhERVmwobB6usFVKkd+b5Wl6meLLD1lGW9Z+LpLaSZIoLbFez6IbGrrLBan6B5Nos6d1PbB5m0NtazCYG/KXuMZ19yuTSY17OP2Lm2yRfBOhcboo3mXFep8Z5t/6CdPEDLaPJ5x/vmUiN8WzuAdMrz1nYm4njkmlCSqWZTcqnRaqNEqetYzTjjI7T5nejzOFZAVXEWu0GbcuIdT7Xj1H1ErXWIZbTFHTbIm5zeelda+i6F3iuLx4uKSgXbJZtMtsqubJDUfFEssuF0KrX62F3HL6XHFZ22swt77O4eS6kMgVlG9/7BygF7fUcDMthMq3zKFnn3lSBh7MnTCw1BZ0Obk/mdDFtR8hgMvZR5/7bfZ4kz3glchq62BBfAMpFvtk93WiTLeos5002SjaFI4PKiYYh4je7Kf1C9fp998Dg6NRCbYha3YgH+wv0B9djzhF4vAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"policies\" title=\"\" src=\"/static/e00ca923b84a8f84c4e28a4533ef2de3/c5bb3/policies.png\" srcset=\"/static/e00ca923b84a8f84c4e28a4533ef2de3/04472/policies.png 170w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/9f933/policies.png 340w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/c5bb3/policies.png 680w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/b12f7/policies.png 1020w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/b5a09/policies.png 1360w,\n/static/e00ca923b84a8f84c4e28a4533ef2de3/e515d/policies.png 1430w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"constraints-and-constraint-templates\" style=\"position:relative;\"><a href=\"#constraints-and-constraint-templates\" aria-label=\"constraints and constraint templates permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Constraints and Constraint Templates</h3>\n<ul>\n<li><strong>Constraints</strong>: These are rules that enforce specific policy requirements on resources in a system. They can be defined and customized by users to meet their specific needs.</li>\n<li><strong>Constraint Templates</strong>: These are reusable policy definitions that allow users to create Constraints more easily and consistently by specifying parameters for the policy rules. They provide a way to standardize policy enforcement across multiple systems and applications and can be customized and extended as needed.</li>\n</ul>\n<p>Having received a substantial amount of new information, I am now eager to explain to you how it all integrates in reality. <a href=\"https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/\" target=\"_blank\" rel=\"noopener noreferrer\">This post</a> does a great job of discussing the inter-relationships between Constraint templates and Constraint CRDs.</p>\n<p>The diagram below is my pictorial representation of the relationship:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0ElEQVR42k2R2W7bQAxF9f/fVKBAgXQB2qRxFhSObNmyPJZkRdJomUUj+5R2GjQPBwQ45CV5J3pORxZJz33SCT23ccPNYs/DVvKbnt8rzd2qo2gmVLfjUT3w4883vgu361/cPN3wVVhk9yT1imi7r3jZHIi3B17ijGSTs1ymrCWu01LyObFEPXjasSItNqSHhF22IlMJ6X5NJjlVbql0QTR2Ffq4xddHwuuFirltOA095zDB+STMwpm27Vjex6jHArXI2d0qunyAaSKMjnkKRMaMvB4zQR51Q9+39F3LIIJDrzFjh661iFkGaepaTakG6nKkEfo+4MOMdRPeeyJnjDQN+MnhvME5c41eGIeRuhlohSBbnGXL82zomoOgsL3CjTmzLZiD5XQ6y8mDpq4yqvxAe6wx2jCIgNaOVjDWy0WeeQ7Ml+t9gVbfKOLPlOtP6N0XTs1PZlNxkoLI+wnd5GRxwuExpXjaou5WVInCy9mTnOGcu043pme/lo943lEsFWWcMzYNViyyWuPHUQTdxZdK/KuwTY2VTzFFjq2qqyf+n+As072z1MeS7ti+8dpzWei9bhJbImftteH6MH3gQ+Gb4Cw+hauXIfznIvJOCIG/GbqqVmawFw4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"relationship\" title=\"\" src=\"/static/867dd8c6b6fbfc09443c3a6db355ea38/c5bb3/relationship.png\" srcset=\"/static/867dd8c6b6fbfc09443c3a6db355ea38/04472/relationship.png 170w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/9f933/relationship.png 340w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/c5bb3/relationship.png 680w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/b12f7/relationship.png 1020w,\n/static/867dd8c6b6fbfc09443c3a6db355ea38/121b3/relationship.png 1070w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Starting with the <a href=\"https://github.com/open-policy-agent/gatekeeper/blob/master/example/templates/k8srequiredlabels_template.yaml\" target=\"_blank\" rel=\"noopener noreferrer\">constraint template</a> which is a YAML file named ConstraintTemplate.yaml.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 101.76470588235296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC7ElEQVR42o1U2W7bMBDM/39QCzRFgRboQ2IjcYpcli1btnVS1EHdkhNMZ9kk7UNb52HBJbicnT3PVrGDO/8W23AD3z/AcRx4nof9fo8wDJGmqZUwCGCMwTiOGIbhryJvZ8voER/uPuLefUQQhAiiEFsCKoIcn58xHidMxyOmpyeM0/RPsDfAKAtw5y2QK4XY96HIKvYD6ChCR0ZdVaGn2LNuTgPG8R6LxwvUeYZJPpgKI2UQsKJEWxRWRK8Shb7v/w/YmxqH7IAL7xJFbTD0I/qRBnzsxYjhHiVcSpXnpwENmT0NR2yUi6vtFRx3idVqBdd14SyXUExFQYZN0zCKdwBWEipZrZM1Pj+c42Z1g9lshuvFNebzORY3C0TMZ1VXENu+OwFovXYdXDK83F7AVz4KXUAxX0mSIIkTtE2LJwk5y04zFMCubXEX3OL84RMuNxc2fMlrWATw9BbKKOoh+9LD2A+nQxYjVSrMvBnmlMXuCrrUlk3btej6zuomS9/BUFqCIU/TEQ6n5svjF6icH9veGvyajNE29fuKwrzUZYmRAE1l8N35Cm/PCt8/oMg0RjrrmZKBYtQ7+rBh792s5/ixuUKqOCXBAUkY2KmJDwekrLBMT84CSTQnJ0VCNW2Fb2Tm+muoKEYcx6xygohAshTknkmF5SMZWpZ/nMPQ/wZ8VcS7IVjLItUMtWG+ai6IjumQljm+LIc3GV9OTpJdGi/5fgOstEbOMPV+h5LsCm6dggwLWVs6RcbVJrrY5NQln3LXux2qVKM1xrK1gILecbT0zkO6cW0Dp5sNMuYwJ2hGJ9lhD73dQK1XSNZra2d1jmke+ChJoKvrF0CKTEuycpBwwRZxxHNpQYS5sBbGLT+07ISmLCwBYSUgMhivLXZmFeagZwML/ZyshIn2tvQa2d6rydikinktyF5bUAGXvItDaauRvToJYMuLSMXki9itQs+NfODdyCd5k6KJsGgV3yvDNzordWZtBUMG5CdyQu8hCCeizAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"ConstraintTemplate\" title=\"\" src=\"/static/1e24eb0a6e52e4b823d09161e8674449/c5bb3/ConstraintTemplate.png\" srcset=\"/static/1e24eb0a6e52e4b823d09161e8674449/04472/ConstraintTemplate.png 170w,\n/static/1e24eb0a6e52e4b823d09161e8674449/9f933/ConstraintTemplate.png 340w,\n/static/1e24eb0a6e52e4b823d09161e8674449/c5bb3/ConstraintTemplate.png 680w,\n/static/1e24eb0a6e52e4b823d09161e8674449/57dc1/ConstraintTemplate.png 718w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Create the ConstraintTemplate using the above-defined manifests:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> ConstraintTemplate.yaml\n<span class=\"token comment\">#„ÄÄList the available ConstraintTemplate's </span>\nkubectl get ConstraintTemplate\nNAME                AGE\nk8srequiredlabels   59s\nConstraint: Namespace label</code></pre></div>\n<p>Let's generate a Constraint specification in the file <code class=\"language-text\">ns-enforce-label.yaml</code> that mandates a namespace to have a label named \"hr\" whenever it is generated.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 606px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 61.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACCElEQVR42oWTWW/aQBSF+f9/ppX60ohIVF0CaVhCxFaMd2PwhjHjHdDXsRNVfWjJw9HRSL6fz71zpyNywcJdsN6vWTkzjL1CEkW4lsXesdm9uWuZmIaBab6653u4rst2u0XTNWzb5nQ60fGOHnerO4bKI4NBj6+De+aTMbPRiMnjI6N+X54nqPMZ5nqN7TgYEuj7Pp7ntWpgDTxNUzrhKaCn9BhrQ0aT7+irJc5mQ9B8pGm4uo4vUwoJqGTB5XrlcrlQ1zXnRudze268LEs6WZEx2874LFN+eelirCVQU7E2CraqtqlcQ0JNoy0oiqJV+eZ/qwUWVcHUmTK1X4ia+MqGzXIhwetWynzegpuUTcF76giR0Bt/Yrj4hmtrVMcjRXwgf1PZnA8HskNEGgYIqZvAMss5RD4/zSful1282ONaXzlXZ+qq/tNK02JZVSRylkWe/x+YihNlIohExNR6ZmKOsUILzVdx4i0izRBJQiYhZzn8JAhuA/NUkMkCrrSJ+nqf7qrLszXh5dcTrqLgGxqh3EUhWw/d3WvaWy27noUe6iie0gIf1AcS+aM0ijnaFvHWIZZ+DHwCuW+3gWmOs9N5Mod8nH5goA/QdwaxvHERx2SyuJY7Vsmdq9uW35lhJmTLXsDO1Rkuf6DocwL5Gjx1gy+XOpRP6yTn1lxG4/F+3wKLf+xho99ROoIi0ofYDAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Constraint\" title=\"\" src=\"/static/1cbee96c7efa1a130354bacbf2c2844a/4d4a2/Constraint.png\" srcset=\"/static/1cbee96c7efa1a130354bacbf2c2844a/04472/Constraint.png 170w,\n/static/1cbee96c7efa1a130354bacbf2c2844a/9f933/Constraint.png 340w,\n/static/1cbee96c7efa1a130354bacbf2c2844a/4d4a2/Constraint.png 606w\" sizes=\"(max-width: 606px) 100vw, 606px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Create the Constraint on our Kubernetes cluster and list the available constraints:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> ns-enforce-label.yaml\n<span class=\"token comment\"># List the available Constraints</span>\nkubectl get constraints\nNAME                      ENFORCEMENT-ACTION   TOTAL-VIOLATIONS\nns-must-have-hr                                 <span class=\"token number\">13</span></code></pre></div>\n<p>Next, create a namespace without defining the required label, which is \"hr\" in this case:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create ns demo\nError from server <span class=\"token punctuation\">(</span>Forbidden<span class=\"token punctuation\">)</span>: admission webhook <span class=\"token string\">\"validation.gatekeeper.sh\"</span> denied the request: <span class=\"token punctuation\">[</span>ns-must-have-hr<span class=\"token punctuation\">]</span> you must provide labels: <span class=\"token punctuation\">{</span><span class=\"token string\">\"hr\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, create a namespace using the required label and observe the result:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># demo-ns.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">hr</span><span class=\"token punctuation\">:</span> foo   <span class=\"token comment\">#&lt;---</span>\n<span class=\"token punctuation\">---</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> demo-ns.yaml\nnamespace/demo created</code></pre></div>\n<p>In the above demonstration, we can see that the namespace is created without any issues because we specified the required label.</p>\n<h2 id=\"-conclusion-\" style=\"position:relative;\"><a href=\"#-conclusion-\" aria-label=\" conclusion  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåü Conclusion üåü</h2>\n<p>OPA enables developers to write and implement policies as code, making it easier to enforce and validate policies across an organization's infrastructure. This blog discussed the importance of policy as code, the structure of OPA policies, and how they can be used to enforce policies in Kubernetes.</p>\n<p>I hope you enjoyed this hands-on tutorial and learned more than you knew before. Let me know if you have any questions related to this blog.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.x</p>","timeToRead":6,"rawMarkdownBody":"\n> **Building a Fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code Keep Your Cluster Safe üõ°Ô∏è**\n\n## Introduction\n\nAs organizations adopt Kubernetes as their container orchestration platform, policy management becomes increasingly important. Traditional approaches to policy enforcement can be time-consuming and error-prone.\n\nManual policy reviews and audits create delays and introduce human error. In dynamic cloud environments, policies need to be constantly updated to reflect changes in the infrastructure.\n\nPolicy as Code (PaC) with [Open Policy Agent (OPA)](https://www.openpolicyagent.org/docs/latest/) for Kubernetes provides an automated and efficient solution. PaC allows easy policy integration into CI/CD pipelines. This approach ensures consistent policy enforcement and reduces human error risk.\n\n![bad pod](./bad-pod.jpg)\n\n## üéØ Goals & Objectives\n\nIn this article, we will explore how Policy as Code (PaC) with Open Policy Agent (OPA) for Kubernetes can streamline policy enforcement.  \n**HAPPY LEARNING üíª**\n\n![opa](./opa.png)\n\nTo properly evaluate PaC with OPA, it's essential to first understand Policy as Code.\n\n### Policy as Code\n\nPolicy as Code involves managing policy enforcement using machine-readable definition files, rather than documentation or interactive configuration tools. The primary goal is to ensure consistent enforcement of standards and rules across clusters or organizations.\n\nOnce policies are established, the next step is to enforce them effectively. This is where tools like [OPA](https://github.com/open-policy-agent/opa) and [Kyverno](https://github.com/kyverno/kyverno) come into play.\n\n### Open Policy Agent (OPA)\n\n[Open Policy Agent (OPA)](https://www.openpolicyagent.org/) is an open-source tool that enables creating, validating, and enforcing policies across systems, including Kubernetes. OPA uses the declarative Rego language to define policies as code, enabling easy integration into CI/CD pipelines. It ensures consistent, efficient policy enforcement, reduces human error risk, and provides policy management flexibility based on specific use cases and requirements.\n\nTo expand on the capabilities of OPA in Kubernetes, let's explore the additional features provided by OPA Gatekeeper, a policy controller that runs on top of OPA.\n\n### OPA Gatekeeper\n\n[OPA Gatekeeper](https://open-policy-agent.github.io/gatekeeper) is a policy controller that runs on top of OPA in Kubernetes. It extends the functionality of OPA by enabling users to enforce policies at scale across multiple Kubernetes clusters. Gatekeeper uses the same declarative policy language as OPA, Rego, to define policies as code.\n\nGatekeeper integrates with Kubernetes' admission controller mechanism, which allows it to evaluate policies before resources are created or updated. This ensures that only resources that meet the defined policies are allowed to run, reducing the risk of security vulnerabilities and ensuring compliance.\n\n![opa-gatekeeper](./opa-gatekeeper.png)\n\n### Admission Controllers\n\nAdmission controllers in Kubernetes intercept API requests, validate them against specific criteria, and mutate them if necessary. There are two types of admission controllers: mutating admission controllers and validating admission controllers. Mutating admission controllers modify requests while validating admission controllers check requests for compliance with pre-defined policies. They are a powerful tool for enforcing policies and ensuring consistency in Kubernetes environments.\n\n![steps](./steps.png)\n\nBelow are the steps of our demo:\n\n![demo](./demo1.png)\n\n### Installing OPA Gatekeeper as CRD\n\n```shell\nkubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml\n```\n\nThis will create a namespace `gatekeeper-system`:\n\n```shell\nkubectl get ns\nNAME                 STATUS   AGE\ndefault              Active   1h\ngatekeeper-system    Active   48s\nkube-node-lease      Active   1h\nkube-public          Active   1h\nkube-system          Active   1h\nlocal-path-storage   Active   1h\n```\n\nFollowing are the objects created as part of the Gatekeeper installation:\n\n```shell\nkubectl get all -n gatekeeper-system\n\nNAME                                                 READY   STATUS    RESTARTS   AGE\npod/gatekeeper-audit-56ddcd8749-mlvjv                1/1     Running   0          2m5s\npod/gatekeeper-controller-manager-64fd6c8cfd-cqvnw   1/1     Running   0          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-xgmxv   1/1     Running   0          2m4s\npod/gatekeeper-controller-manager-64fd6c8cfd-znxfh   1/1     Running   0          2m4s\n\nNAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE\nservice/gatekeeper-webhook-service   ClusterIP   10.25.5.7   <none>        443/TCP   2m51s\n\nNAME                                            READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/gatekeeper-audit                1/1     1            1           2m5s\ndeployment.apps/gatekeeper-controller-manager   3/3     3            3           2m5s\n\nNAME                                                       DESIRED   CURRENT   READY   AGE\nreplicaset.apps/gatekeeper-audit-56ddcd8749                1         1         1       2m5s\nreplicaset.apps/gatekeeper-controller-manager-64fd6c8cfd   3         3         3       2m5s\n```\n\nAfter installing all the Gatekeeper components in the cluster, the API server will activate the Gatekeeper admission webhook to handle admission requests for resource creation, updates, and deletions. In the validation process, Gatekeeper serves as an intermediary between the API server and OPA, with the API server enforcing all policies executed by OPA.\n\n### Custom Resource Definition\n\nBy using the [CustomResourceDefinition (CRD)](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions) API, it is possible to define custom resources in Kubernetes. Once a CRD object is defined, a new custom resource can be created with a name and schema specified by the user. The Kubernetes API handles the storage and serving of these custom resources.\n\nGatekeeper leverages the use of CustomResourceDefinitions to enforce policies on Kubernetes resources like Pods, Deployments, and Jobs, by defining ConstraintTemplates and Constraints. As part of the installation process, Gatekeeper generates multiple CRDs to facilitate the implementation of its functionalities.\n\n```shell\nkubectl get crd | grep -i gatekeeper\n\nassign.mutations.gatekeeper.sh                       2024-10-30T13:34:01Z\nassignmetadata.mutations.gatekeeper.sh               2024-10-30T13:34:01Z\nconfigs.config.gatekeeper.sh                         2024-10-30T13:34:01Z\nconstraintpodstatuses.status.gatekeeper.sh           2024-10-30T13:34:01Z\nconstrainttemplatepodstatuses.status.gatekeeper.sh   2024-10-30T13:34:01Z\nconstrainttemplates.templates.gatekeeper.sh          2024-10-30T13:34:01Z #<---\nexpansiontemplate.expansion.gatekeeper.sh            2024-10-30T13:34:01Z\nmodifyset.mutations.gatekeeper.sh                    2024-10-30T13:34:01Z\nmutatorpodstatuses.status.gatekeeper.sh              2024-10-30T13:34:01Z\nproviders.externaldata.gatekeeper.sh                 2024-10-30T13:34:01Z\n```\n\nOne of them is `constrainttemplates.templates.gatekeeper.sh`, which allows us to create **ConstraintTemplates** and **Constraints** to work with Gatekeeper. Now, we have all the resources, Pods, and Services running in the `gatekeeper-system` namespace.\n\nThe next step is to define policies. In this example, I will create a policy using Rego that denies all namespace creation if the label `hr` is not defined. The first step is to define **ConstraintTemplate** and **Constraint** CRDs using Rego.\n\n![policies](./policies.png)\n\n### Constraints and Constraint Templates\n\n- **Constraints**: These are rules that enforce specific policy requirements on resources in a system. They can be defined and customized by users to meet their specific needs.\n- **Constraint Templates**: These are reusable policy definitions that allow users to create Constraints more easily and consistently by specifying parameters for the policy rules. They provide a way to standardize policy enforcement across multiple systems and applications and can be customized and extended as needed.\n\nHaving received a substantial amount of new information, I am now eager to explain to you how it all integrates in reality. [This post](https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/) does a great job of discussing the inter-relationships between Constraint templates and Constraint CRDs.\n\nThe diagram below is my pictorial representation of the relationship:\n\n![relationship](./relationship.png)\n\nStarting with the [constraint template](https://github.com/open-policy-agent/gatekeeper/blob/master/example/templates/k8srequiredlabels_template.yaml) which is a YAML file named ConstraintTemplate.yaml.\n\n![ConstraintTemplate](./ConstraintTemplate.png)\n\nCreate the ConstraintTemplate using the above-defined manifests:\n\n```shell\nkubectl create -f ConstraintTemplate.yaml\n#„ÄÄList the available ConstraintTemplate's \nkubectl get ConstraintTemplate\nNAME                AGE\nk8srequiredlabels   59s\nConstraint: Namespace label\n```\n\nLet's generate a Constraint specification in the file `ns-enforce-label.yaml` that mandates a namespace to have a label named \"hr\" whenever it is generated.\n\n![Constraint](./Constraint.png)\n\nCreate the Constraint on our Kubernetes cluster and list the available constraints:\n\n```shell\nkubectl create -f ns-enforce-label.yaml\n# List the available Constraints\nkubectl get constraints\nNAME                      ENFORCEMENT-ACTION   TOTAL-VIOLATIONS\nns-must-have-hr                                 13\n```\n\nNext, create a namespace without defining the required label, which is \"hr\" in this case:\n\n```shell\nkubectl create ns demo\nError from server (Forbidden): admission webhook \"validation.gatekeeper.sh\" denied the request: [ns-must-have-hr] you must provide labels: {\"hr\"}\n```\n\nNow, create a namespace using the required label and observe the result:\n\n```yaml\n# demo-ns.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n    name: demo\n    labels:\n        hr: foo   #<---\n---\n```\n\n```shell\nkubectl create -f demo-ns.yaml\nnamespace/demo created\n```\n\nIn the above demonstration, we can see that the namespace is created without any issues because we specified the required label.\n\n## üåü Conclusion üåü\n\nOPA enables developers to write and implement policies as code, making it easier to enforce and validate policies across an organization's infrastructure. This blog discussed the importance of policy as code, the structure of OPA policies, and how they can be used to enforce policies in Kubernetes.\n\nI hope you enjoyed this hands-on tutorial and learned more than you knew before. Let me know if you have any questions related to this blog.\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.x\n","wordCount":{"words":1065},"frontmatter":{"id":"cbd7fa24308175b6fbf7aba7","path":"/blog/kubernetes-opa-gatekeeper-policy-as-code/","humanDate":"Oct 31, 2024","fullDate":"2024-10-31","title":"Securing Your Kubernetes Cluster with OPA Gatekeeper: The Power of Policy-as-Code üõ°Ô∏è","keywords":["Kubernetes","OPA Gatekeeper","Policy-as-Code","k8s","DevOps"],"excerpt":"Building a fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code keep your cluster safe.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVR42o1S30vbUBTuP+ce9iCD4RgIMvag+CKbok8q23TYB1+cfVCczBcVDIo/5lprEtMkNElb2tXAOmTYQlttSGL60/Te9qaepLa+DT9uLt+5937nfPfc+BzHsW2746Hdbvf5c+AzTbNYLOpWOZpI6oaRy+UQQpCREOJ46JL+3AeEvjvTPAqGF9e23k/OjH6c4iIRqP/cyvCt7x7Mr258XQkMvH6zd3isyLIkSalUSlVVnudZlqUZGng2m+MFMRaLpdNpWC8UCq54P8zOLAfefZgeHB6JRKVEPE5RlCAIiqJkMhlRFC84jmE5RZbUdPL75g+aYQSez+fzrhguwMiJibkvqUsVwu5VXdKz50UdrUxuLAJt7e4+2gbgVkszjN7RJ1XvFcjar8rQkvbWX/JTVt0mHcdrmFvZcfLFm1q9rumGbt7phgm8Uq3BsCpVgu+T/9Dg59J6sEqJjVcL2onScDMSrzJCOPH7kuaEw9PQSegcSIi+OA0zP8+Yo+C5dpvdidij3/T4FYIs05vm0l75Sezp0b1tY9wCAiYxxhDWavUmwuDsutR6OV/6tG35qfKL2Vvpb9Pz2xP/B/A7wBz90xwPGGOrxrHc6LfwAXBJRlOL/TQMAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/0d302c8dc1d23228ca71bf4d2b37e947/211a3/opa-gatekeeper-cover.png","srcSet":"/static/0d302c8dc1d23228ca71bf4d2b37e947/596c0/opa-gatekeeper-cover.png 750w,\n/static/0d302c8dc1d23228ca71bf4d2b37e947/211a3/opa-gatekeeper-cover.png 840w","sizes":"100vw"},"sources":[{"srcSet":"/static/0d302c8dc1d23228ca71bf4d2b37e947/4c8c9/opa-gatekeeper-cover.webp 750w,\n/static/0d302c8dc1d23228ca71bf4d2b37e947/ab556/opa-gatekeeper-cover.webp 840w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5714285714285714}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/eks-upgrade-guide/","title":"EKS cluster upgrades: A Step-by-Step guide to a secure Process","date":"2024-10-31 21:30:00"},"excerpt":"A Step-by-Step upgrade handbook üìö Introduction The cloud computing landscape is constantly evolving, and it can be difficult to keep up‚Ä¶","html":"<blockquote>\n<p><strong>A Step-by-Step upgrade handbook</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìö Introduction</h2>\n<p>The <a href=\"https://landscape.cncf.io/\" target=\"_blank\" rel=\"noopener noreferrer\">cloud computing landscape</a> is constantly evolving, and it can be difficult to keep up with the latest changes. However, staying up-to-date is essential for ensuring the security and reliability of your infrastructure.</p>\n<p><a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon Elastic Kubernetes Service (EKS)</a> is a managed Kubernetes service that makes it easy to deploy, manage, and scale containerized applications.</p>\n<p>One of the most important tasks for EKS cluster administrators is to perform regular upgrades. This ensures that your cluster is running on the latest version of Kubernetes, which includes the latest security patches and features.</p>\n<p>This guide provides a step-by-step walkthrough of the EKS cluster upgrade process. We cover all the essential steps, from planning the upgrade to testing and deploying the new version. Whether you are working with self-managed nodes, managed node groups, Karpenter nodes, or Fargate nodes, we have you covered.\nBy following the guidance in this guide, you can confidently upgrade your EKS cluster without disrupting your applications.</p>\n<p>So let's get started!</p>\n<h2 id=\"-staying-current-how-often-to-upgrade-kubernetes\" style=\"position:relative;\"><a href=\"#-staying-current-how-often-to-upgrade-kubernetes\" aria-label=\" staying current how often to upgrade kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìÖ Staying Current: How Often to Upgrade Kubernetes</h2>\n<p>How frequently should you perform Kubernetes upgrades? This is a crucial aspect often overlooked by newcomers to Kubernetes. Unlike many traditional infrastructure projects, Kubernetes evolves rapidly through its versions. Upgrading Kubernetes cannot be likened to switching to a new long-term support (LTS) release of a Linux distribution; it's a continuous process that demands regular attention.</p>\n<p>To be fair, the Kubernetes team has taken significant steps to make this process more manageable. They follow an <a href=\"https://kubernetes.io/releases/version-skew-policy/\" target=\"_blank\" rel=\"noopener noreferrer\">N-2 support policy</a>, ensuring that the three most recent minor versions receive security fixes and bug patches. This approach gives you ample time to establish a cluster and incorporate upgrade planning into your initial cluster design. Waiting until your cluster is nearly at its end-of-life (EOL) to contemplate upgrades is not a viable strategy. Each release remains eligible for patches for 14 months, which may seem like an extended period, but you're unlikely to install the very latest release.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJUlEQVR42o2S+0vDMBCA9///L+ovU4ZzPsp0+IQNnTCwsOFGVyuza3K55PLw2s4HatWjhGsuX75LSCuEoJTSWoem8L76giORwt1CXj+KYUEZz7S4muc58w2kY9KHQDZDPZLrAcpbIlEXW7UZEX8WhuAUUvagkwHO+0bNvLfvSxrMrhLywqdUX5xCewuinp3GzlK9cYP5TWg1msnYHHWg2zb3I/e9tRouimIDM+YcozZfsVDubqvjfT2N6+024xf4s9lrTfOZiQ4YM+ORXeehOUpYCIEAnJAQ+vJM7u0AC5PFx0F+gQEAjfHcwHkfTroYTzz//kVuYAkg06WKesVhh15W4d9RwqjU8/CmGF7ly0TyW0PkKyzbqRJVBSdc4Uk+Iyc8EtErSdJ8vXFxmVwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Kubernetes Versions\" title=\"\" src=\"/static/a1f99354749040eceeca7ad10eeb28aa/c5bb3/k8s-versions.png\" srcset=\"/static/a1f99354749040eceeca7ad10eeb28aa/04472/k8s-versions.png 170w,\n/static/a1f99354749040eceeca7ad10eeb28aa/9f933/k8s-versions.png 340w,\n/static/a1f99354749040eceeca7ad10eeb28aa/c5bb3/k8s-versions.png 680w,\n/static/a1f99354749040eceeca7ad10eeb28aa/5a190/k8s-versions.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://endoflife.date/kubernetes\">End of Life Date for Kubernetes</a></div>\n<p>So, how frequently should you upgrade Kubernetes? The answer is quite often. Kubernetes aims for three releases per year, down from the previous rate of four releases annually. To assess Kubernetes releases for your organization, you'll likely need to manage multiple versions simultaneously in various environments.</p>\n<p>As a rule of thumb, I recommend letting a minor version bake in a development environment for at least two weeks, and the same applies to the subsequent stages, such as staging or sandbox environments. For production upgrades, ideally, you should have at least a month of solid data indicating that the organization won't encounter issues.</p>\n<p>üîÑ <strong>Key Takeaways:</strong></p>\n<ul>\n<li><strong>N-2 Support Policy:</strong> Ensures the three most recent minor versions receive updates.</li>\n<li><strong>14-Month Patch Eligibility:</strong> Each release is eligible for patches for 14 months.</li>\n<li><strong>Three Releases Per Year:</strong> Kubernetes aims for three releases annually.</li>\n<li><strong>Staging and Production:</strong> Test in development for two weeks and in production for at least a month.</li>\n</ul>\n<h3 id=\"-strategic-kubernetes-upgrade-scheduling\" style=\"position:relative;\"><a href=\"#-strategic-kubernetes-upgrade-scheduling\" aria-label=\" strategic kubernetes upgrade scheduling permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ü§ñ Strategic Kubernetes Upgrade Scheduling</h3>\n<p>A Kubernetes version encompasses both the control plane and the data plane. To ensure smooth operation, both the control plane and the data plane should run the same Kubernetes <a href=\"https://kubernetes.io/releases/version-skew-policy/#supported-versions\" target=\"_blank\" rel=\"noopener noreferrer\">minor version, such as 1.27</a>.</p>\n<ul>\n<li><strong>Control plane</strong>: The control plane version is defined by the Kubernetes API server. In EKS clusters, this is managed by AWS. Upgrades to the control plane version are started using the AWS API.</li>\n<li><strong>Data plane</strong>: The data plane version references the version of the Kubelet running on your nodes. Different nodes in the same cluster may have different versions. See the version of all nodes with <code class=\"language-text\">kubectl get nodes</code>.</li>\n</ul>\n<h2 id=\"-kubernetes-version-management-a-staged-approach\" style=\"position:relative;\"><a href=\"#-kubernetes-version-management-a-staged-approach\" aria-label=\" kubernetes version management a staged approach permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üíπ Kubernetes Version Management: A Staged Approach</h2>\n<p>In my carefully planned layout:</p>\n<p>‚òëÔ∏è <strong>Development Cluster: Embrace the Bleeding Edge</strong><br>\nThe dev cluster should be on the cutting edge, aligned with the latest Kubernetes version. This approach helps establish SLAs for the dev environment, with a focus on frequent upgrades. The internal communication strategy is to upgrade dev often during specific time frames, relying on it to identify and surface early problems. It's common to encounter critical issues almost immediately, providing ample time for resolution and determining the maximum safe upgrade version on testing day.</p>\n<p>‚òëÔ∏è <strong>Staging Cluster: A Step Behind Dev</strong><br>\nStaging lags slightly behind dev, typically running a minor release older. The concern here might be the possibility of incompatible YAML files. However, it's a prevalent practice to employ per-environment YAMLs, allowing for variations in resource requests and limits. If you're exploring per-environment configuration, consider tools like <a href=\"https://kustomize.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kustomize</a>.</p>\n<p>‚òëÔ∏è <strong>Production Cluster: Align with Staging</strong><br>\nIn production, the goal is to keep version alignment as close to staging as possible. This approach simplifies developers' lives by avoiding excessive version fragmentation. Kubernetes patch releases are usually conservative with changes, resulting in rare problems. The release cadence for patches on the same minor version follows a two-week cycle in staging before being deployed to production.</p>\n<p>‚òëÔ∏è <strong>Crucial Note: Exercise Caution with Minor Version Upgrades</strong><br>\nA key rule is not to upgrade the minor version until it reaches at least patch <code class=\"language-text\">.2</code>. This means that the latest Kubernetes version, such as 1.26.0, isn't considered ready for a dev release until it reaches 1.26.2. Once this milestone is achieved, the upgrade process begins, progressing from dev to stage and finally to production. By the time the dev upgrade is completed and rolled out to staging, it's often the <code class=\"language-text\">.3</code> release (depending on the time of year).</p>\n<p>‚òëÔ∏è <strong>Balancing Speed and Safety: The Delicate Art of Version Management</strong><br>\nWhile this approach may seem slow, it's rooted in past experiences. Rushing into upgrades too early has led to issues. It's challenging for the Kubernetes team to anticipate every use-case and prevent all regressions. Waiting until at least <code class=\"language-text\">.2</code> ensures extensive testing, with most issues discovered by that point. Some opt to wait until <code class=\"language-text\">.5</code> for the safest path, although it's a slower approach.</p>\n<h3 id=\"-keep-your-cluster-updated\" style=\"position:relative;\"><a href=\"#-keep-your-cluster-updated\" aria-label=\" keep your cluster updated permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Keep Your Cluster Updated</h3>\n<p>Staying current with Kubernetes releases is vital within the shared responsibility model for EKS and Kubernetes adoption.</p>\n<ul>\n<li><strong>Review the EKS Release Calendar</strong>: Frequent updates are the norm, with EKS typically releasing three minor Kubernetes versions annually, each supported for around 14 months. Always check the EKS Kubernetes <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html#kubernetes-release-calendar\" target=\"_blank\" rel=\"noopener noreferrer\">release calendar</a> for the latest information.</li>\n<li><strong>Understand Shared Responsibility</strong>: You're responsible for initiating upgrades for both the cluster control plane and data plane. While AWS handles the control plane during upgrades, the data plane, including Fargate pods and add-ons, falls under your purview. Planning is crucial to ensure workload availability.</li>\n<li><strong>In-Place Cluster Upgrades</strong>: EKS supports in-place cluster upgrades, preserving resources and configuration consistency. This minimizes disruption for users and retains existing workloads and resources. Note that only one minor version upgrade can occur at a time.</li>\n<li><strong>Plan Sequential Upgrades Carefully</strong>: For multiple version updates, sequential upgrades are necessary. However, they pose a higher risk of downtime. Consider evaluating a blue/green cluster upgrade strategy in such cases.</li>\n</ul>\n<h2 id=\"-how-aws-manages-eks-upgrades\" style=\"position:relative;\"><a href=\"#-how-aws-manages-eks-upgrades\" aria-label=\" how aws manages eks upgrades permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ How AWS Manages EKS Upgrades</h2>\n<p>The EKS upgrade process is managed by AWS to ensure a seamless and safe transition between Kubernetes versions. Here is a detailed breakdown of the steps AWS takes to upgrade the EKS control plane:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVR42o1Sy07DMBDM/38DJzhW3PgDDiBUJC5UokGogijNq3nbjp/Dxn3QUFXKSiuvvOvJzGwCzAzrHPo4BK9TOMMA08NpDtD9eQSnamz8a2qtoZSCMQaazrFrhhLi6wH9+x0c/6EvmSuAk9gDK6VR1zXSLAPvOyjWUGZo4zcUmyVsv6FROwV0B1aqySC7Ej0f0DEBxoW/77oOebGDlhymiogig2MENKbcXZcsqoRyC823sNWK5EQwSnjZJ0u8DxXa8B7N6haGZixJHi2RUvozSNMUTAwwbQotGsiC5LzcQCTPxIZj6jGdQ4G2eEVdLGkv3x6kaRrkee7tCRhjMNbBiRZWcej2E10RQlZrMlxM2fna0HaJDVmgBrLhqMCPufOluIPB7lCfb93tySUf0H0JRWN8GCCIzCh1xpb/wlgLTgtS9JDXBYYugYkf4bIn8rM+/hDzAUcGaZZ7ebqMoFmEbL1AHi7IpvhiPsDs2FOxsoIRW59k9AXgL6PWW2P3QwRpAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"EKS Upgrade Process\" title=\"\" src=\"/static/ddfd8b0f2d3debaabcdfdfb7c15eb884/c5bb3/upgrades.png\" srcset=\"/static/ddfd8b0f2d3debaabcdfdfb7c15eb884/04472/upgrades.png 170w,\n/static/ddfd8b0f2d3debaabcdfdfb7c15eb884/9f933/upgrades.png 340w,\n/static/ddfd8b0f2d3debaabcdfdfb7c15eb884/c5bb3/upgrades.png 680w,\n/static/ddfd8b0f2d3debaabcdfdfb7c15eb884/5a190/upgrades.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"Ô∏è-pre-upgrade-checks\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-pre-upgrade-checks\" aria-label=\"Ô∏è pre upgrade checks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Pre-upgrade Checks</h3>\n<p>AWS first performs pre-upgrade checks, including assessing the current cluster state and evaluating the compatibility of the new version with your workloads. If any issues are detected, the upgrade process will not proceed.</p>\n<h3 id=\"-backup-and-snapshot\" style=\"position:relative;\"><a href=\"#-backup-and-snapshot\" aria-label=\" backup and snapshot permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üíæ Backup and Snapshot</h3>\n<p>Before initiating the upgrade, AWS takes a backup of your existing control plane and creates a snapshot of your etcd data store. This is done to ensure data consistency and to enable rollback in case of an upgrade failure.</p>\n<p>For additional data protection, consider using <a href=\"https://velero.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Velero</a>, an open-source tool that simplifies the backup and recovery process for Kubernetes cluster resources and persistent volumes. Velero allows you to schedule and manage backups, as well as restore processes, providing an extra layer of safety for your data.</p>\n<h3 id=\"-creating-a-new-control-plane\" style=\"position:relative;\"><a href=\"#-creating-a-new-control-plane\" aria-label=\" creating a new control plane permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üÜï Creating a New Control Plane</h3>\n<p>AWS creates a new control plane with the desired Kubernetes version. This new control plane runs in parallel with your existing control plane, ensuring minimal disruption to your workload.</p>\n<h3 id=\"-testing-compatibility\" style=\"position:relative;\"><a href=\"#-testing-compatibility\" aria-label=\" testing compatibility permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Testing Compatibility</h3>\n<p>The new control plane is tested for compatibility with your workloads, including running automated tests to verify that your applications continue to function as expected. The goal is to minimize potential disruptions during the upgrade process and maintain the stability of your services. It's important to mention that this only looks for your application health and not for APIs that may be removed or deprecated.</p>\n<h3 id=\"-switching-control-plane-endpoints\" style=\"position:relative;\"><a href=\"#-switching-control-plane-endpoints\" aria-label=\" switching control plane endpoints permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Switching Control Plane Endpoints</h3>\n<p>Once compatibility is confirmed, AWS switches the control plane endpoints (API server) to the new control plane. This switch happens atomically, resulting in minimal downtime during the upgrade process.</p>\n<h3 id=\"Ô∏è-terminating-the-old-control-plane\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-terminating-the-old-control-plane\" aria-label=\"Ô∏è terminating the old control plane permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üóëÔ∏è Terminating the Old Control Plane</h3>\n<p>The old control plane is terminated once the upgrade is complete, and all resources associated with it are cleaned up.</p>\n<h2 id=\"-eks-rollback-on-upgrade-failure\" style=\"position:relative;\"><a href=\"#-eks-rollback-on-upgrade-failure\" aria-label=\" eks rollback on upgrade failure permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîô EKS Rollback on Upgrade Failure</h2>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.352941176470594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVR42o1Sy07DMBDM/18rwQ1x4iPghlQe4oKoilQkCBJVcNrQOHHi2Im9w9ahbapSxEqrdWzPZGbXEf4ZngiViKFlCmol0OagruIT2rsXbVcMCDmIrutgrQ215bo+dVpAzy6gHk9AasYYf4RwL3pi5xyklBAiRaMrWJWjrRKo5B6r9xv4cnYgItrArRSwZYZKG6jaoNZNuFCWCsvsC8428IVg2SWoeAY4yaS/W15vmWLJuYBTMfzyge28Molmu27XknUYwVznyJ9OmfsluOhcB2NMWEdJ8smqGjj+e6clrLjG8naE5uOKPdc/Ddj1lxoBlY6hFmNQ/cYkHkVRIMuyUCOtNbxniK14aqwon6LOpmhXE/j1txu4CoPzIVtrUBZ5UHZkKDREbgk84ztHrIT6XW+4dxI1O5KrxV+EA2LqyYlrnuc8ZX4qjQlqvY4h70aoJ2f8FpN9AcefzYCeeuINiKoYK+6vnF9yD+cHhN9segqm7sQpQAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"EKS Rollback Process\" title=\"\" src=\"/static/e78540955b703aecd2357c7fc0248b41/c5bb3/rolloback.png\" srcset=\"/static/e78540955b703aecd2357c7fc0248b41/04472/rolloback.png 170w,\n/static/e78540955b703aecd2357c7fc0248b41/9f933/rolloback.png 340w,\n/static/e78540955b703aecd2357c7fc0248b41/c5bb3/rolloback.png 680w,\n/static/e78540955b703aecd2357c7fc0248b41/5a190/rolloback.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>In case an EKS upgrade fails, AWS has measures in place to minimize disruption and revert the control plane to its previous version:</p>\n<h3 id=\"-detecting-the-failure\" style=\"position:relative;\"><a href=\"#-detecting-the-failure\" aria-label=\" detecting the failure permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üö® Detecting the Failure</h3>\n<p>AWS constantly monitors the upgrade process to detect any issues. If a problem arises during the upgrade, the process is immediately halted.</p>\n<h3 id=\"-restoring-from-backup\" style=\"position:relative;\"><a href=\"#-restoring-from-backup\" aria-label=\" restoring from backup permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Restoring from Backup</h3>\n<p>AWS uses the backup and snapshot created before the upgrade to restore the control plane and etcd data store to their previous state.</p>\n<h3 id=\"-switching-control-plane-endpoints-1\" style=\"position:relative;\"><a href=\"#-switching-control-plane-endpoints-1\" aria-label=\" switching control plane endpoints 1 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Switching Control Plane Endpoints</h3>\n<p>AWS atomically switches the control plane endpoints back to the previous control plane, ensuring minimal downtime.</p>\n<h3 id=\"Ô∏è-terminating-the-new-control-plane\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-terminating-the-new-control-plane\" aria-label=\"Ô∏è terminating the new control plane permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üóëÔ∏è Terminating the New Control Plane</h3>\n<p>Once the rollback is complete, AWS terminates the new control plane and cleans up any associated resources.</p>\n<h3 id=\"-post-rollback-assessment\" style=\"position:relative;\"><a href=\"#-post-rollback-assessment\" aria-label=\" post rollback assessment permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìù Post-rollback Assessment</h3>\n<p>After the rollback, AWS will assess the reasons behind the upgrade failure and provide guidance on how to address the issues. You will need to troubleshoot and resolve the problems before attempting the upgrade again.</p>\n<h2 id=\"upgrade-your-control-plane-and-data-plane-in-sequence\" style=\"position:relative;\"><a href=\"#upgrade-your-control-plane-and-data-plane-in-sequence\" aria-label=\"upgrade your control plane and data plane in sequence permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Upgrade your control plane and data plane in sequence</h2>\n<p>To upgrade a cluster you will need to take the following actions:\n<a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#use-the-eks-documentation-to-create-an-upgrade-checklist\" target=\"_blank\" rel=\"noopener noreferrer\">Review the Kubernetes and EKS release notes</a>.\n<a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#backup-the-cluster-before-upgrading\" target=\"_blank\" rel=\"noopener noreferrer\">Take a backup of the cluster</a>. (optional)\n<a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#identify-and-remediate-removed-api-usage-before-upgrading-the-control-plane\" target=\"_blank\" rel=\"noopener noreferrer\">Identify and remediate deprecated and removed API usage in your workloads</a>.\n<a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#track-the-version-skew-of-nodes-ensure-managed-node-groups-are-on-the-same-version-as-the-control-plane-before-upgrading\" target=\"_blank\" rel=\"noopener noreferrer\">Ensure Managed Node Groups, if used, are on the same Kubernetes version as the control plane</a>. EKS managed node groups and nodes created by EKS Fargate Profiles only support 1 minor version skew between the control plane and data plane.\n<a href=\"https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html\" target=\"_blank\" rel=\"noopener noreferrer\">Upgrade the cluster control plane using the AWS console or cli</a>.\n<a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#upgrade-add-ons-and-components-using-the-kubernetes-api\" target=\"_blank\" rel=\"noopener noreferrer\">Review add-on compatibility</a>. Upgrade your Kubernetes add-ons and custom controllers, as required.\n<a href=\"https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html\" target=\"_blank\" rel=\"noopener noreferrer\">Update kubectl</a>.\n<a href=\"https://docs.aws.amazon.com/eks/latest/userguide/update-managed-node-group.html\" target=\"_blank\" rel=\"noopener noreferrer\">Upgrade the cluster data plane</a>. Upgrade your nodes to the same Kubernetes minor version as your upgraded cluster.</p>\n<h2 id=\"-use-the-eks-documentation-to-create-an-upgrade-checklist\" style=\"position:relative;\"><a href=\"#-use-the-eks-documentation-to-create-an-upgrade-checklist\" aria-label=\" use the eks documentation to create an upgrade checklist permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Use the EKS Documentation to Create an Upgrade Checklist</h2>\n<p>The EKS Kubernetes version documentation includes a detailed list of changes for each version. Build a checklist for each upgrade.</p>\n<p>For specific EKS version upgrade guidance, review the documentation for notable changes and considerations for each version. The following Kubernetes versions are currently available in Amazon EKS standard support:</p>\n<ul>\n<li><strong>1.30</strong></li>\n<li><strong>1.29</strong></li>\n<li><strong>1.28</strong></li>\n</ul>\n<p>For important changes to be aware of for each version in standard support, see <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html\" target=\"_blank\" rel=\"noopener noreferrer\">Review release notes for Kubernetes versions on standard support</a>.</p>\n<p><strong>üìÖ Available Versions on Extended Support</strong></p>\n<p>The following Kubernetes versions are currently available in Amazon EKS extended support:</p>\n<ul>\n<li><strong>1.27</strong></li>\n<li><strong>1.26</strong></li>\n<li><strong>1.25</strong></li>\n<li><strong>1.24</strong></li>\n<li><strong>1.23</strong></li>\n</ul>\n<h3 id=\"-upgrading-add-ons-and-components-via-the-kubernetes-api\" style=\"position:relative;\"><a href=\"#-upgrading-add-ons-and-components-via-the-kubernetes-api\" aria-label=\" upgrading add ons and components via the kubernetes api permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Upgrading Add-ons and Components via the Kubernetes API</h3>\n<p>Before initiating a cluster upgrade, it's essential to have a comprehensive understanding of the versions of Kubernetes components in use. Conduct an inventory of cluster components, specifically focusing on those that directly interact with the Kubernetes API. These critical cluster components encompass:</p>\n<ul>\n<li><strong>Monitoring and Logging Agents</strong></li>\n<li><strong>Cluster Autoscalers</strong></li>\n<li><strong>Container Storage Drivers</strong> (e.g., <a href=\"https://github.com/kubernetes-sigs/aws-ebs-csi-driver\" target=\"_blank\" rel=\"noopener noreferrer\">EBS CSI</a>, <a href=\"https://github.com/kubernetes-sigs/aws-efs-csi-driver\" target=\"_blank\" rel=\"noopener noreferrer\">EFS CSI</a>)</li>\n<li><strong>Ingress Controllers</strong></li>\n<li><strong>Other Workloads or Add-ons</strong> reliant on direct Kubernetes API interactions</li>\n</ul>\n<h3 id=\"-pro-tip\" style=\"position:relative;\"><a href=\"#-pro-tip\" aria-label=\" pro tip permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üí° Pro Tip</h3>\n<p>Critical cluster components are frequently found within namespaces ending in <code class=\"language-text\">*-system</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get ns <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'-system'</span></code></pre></div>\n<p>Once you've identified components that depend on the Kubernetes API, refer to their documentation to ascertain version compatibility and any prerequisites for upgrading. For instance, consult the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Load Balancer Controller documentation</a> for insights into version compatibility. Certain components might necessitate updates or configuration adjustments before proceeding with a cluster upgrade. It's imperative to pay special attention to critical components like CoreDNS, kube-proxy, VPC CNI, and storage drivers.</p>\n<p>Clusters typically encompass a multitude of workloads relying on the Kubernetes API, essential for functionalities such as ingress control, continuous delivery systems, and monitoring tools. When embarking on an EKS cluster upgrade, it's equally crucial to upgrade your add-ons and third-party tools, ensuring their seamless compatibility with the upgraded environment.</p>\n<p>See the following examples of common add-ons and their relevant upgrade documentation:</p>\n<ul>\n<li><strong>Amazon VPC CNI</strong>: For the recommended version of the Amazon VPC CNI add-on for each cluster version, see <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html\" target=\"_blank\" rel=\"noopener noreferrer\">Updating the Amazon VPC CNI plugin for Kubernetes self-managed add-on</a>. When installed as an Amazon EKS Add-on, it can only be upgraded one minor version at a time.</li>\n<li><strong>kube-proxy</strong>: See <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/managing-kube-proxy.html\" target=\"_blank\" rel=\"noopener noreferrer\">Updating the Kubernetes kube-proxy self-managed add-on</a>.</li>\n<li><strong>CoreDNS</strong>: See <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/managing-coredns.html\" target=\"_blank\" rel=\"noopener noreferrer\">Updating the CoreDNS self-managed add-on</a>.</li>\n<li><strong>AWS Load Balancer Controller</strong>: The AWS Load Balancer Controller needs to be compatible with the EKS version you have deployed. See the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html\" target=\"_blank\" rel=\"noopener noreferrer\">installation guide</a> for more information.</li>\n<li><strong>Amazon Elastic Block Store (Amazon EBS) Container Storage Interface (CSI) driver</strong>: For installation and upgrade information, see <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/managing-ebs-csi.html\" target=\"_blank\" rel=\"noopener noreferrer\">Managing the Amazon EBS CSI driver as an Amazon EKS add-on</a>.</li>\n<li><strong>Amazon Elastic File System (Amazon EFS) Container Storage Interface (CSI) driver</strong>: For installation and upgrade information, see <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/efs-csi.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon EFS CSI driver</a>.</li>\n<li><strong>Kubernetes Metrics Server</strong>: For more information, see <a href=\"https://kubernetes-sigs.github.io/metrics-server\" target=\"_blank\" rel=\"noopener noreferrer\">metrics-server on GitHub</a>.</li>\n<li><strong>Kubernetes Cluster Autoscaler</strong>: To upgrade the version of Kubernetes Cluster Autoscaler, change the version of the image in the deployment. The Cluster Autoscaler is tightly coupled with the Kubernetes scheduler. You will always need to upgrade it when you upgrade the cluster. Review the <a href=\"https://github.com/kubernetes/autoscaler/releases\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub releases</a> to find the address of the latest release corresponding to your Kubernetes minor version.</li>\n<li><strong>Karpenter</strong>: For installation and upgrade information, see the <a href=\"https://karpenter.sh/docs/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">Karpenter documentation</a>.</li>\n<li><strong>Ingress</strong>: You need to really understand how traffic is coming into the cluster and through what systems.</li>\n<li><strong>Service mesh</strong>: Are you using one, what does it do and what version is it set at? Istio can be a BEAR to upgrade, so if you can switch to Linkerd you'll likely be much happier in the long term. However, understanding what controls access to what namespaces and pods is critical to a happy upgrade.</li>\n<li><strong>Certificates</strong>: By default, they expire after a year. You get fresh ones with every upgrade, but you can also trigger a manual refresh whenever with <code class=\"language-text\">kubeadm certs renew</code>. If you are running an old cluster, PLEASE check the expiration dates of your client certificates with:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubeadm certs check-expiration now</code></pre></div>\n<ul>\n<li><strong>Stateful deployments</strong>: Are they storing something, where are they storing it, and how do you manage them? This would be databases, Redis, message queues, applications that hold state. These are often the hardest to move or interact with during an upgrade. You can review the options for moving those <a href=\"https://www.velotio.com/engineering-blog/exploring-upgrade-strategies-for-stateful-sets-in-kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>. The biggest thing is to set the pod disruption budget so that there is some minimum available during the upgrade process as shown <a href=\"https://kubernetes.io/docs/tasks/run-application/configure-pdb/\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</li>\n</ul>\n<h3 id=\"-verify-available-ip-addresses\" style=\"position:relative;\"><a href=\"#-verify-available-ip-addresses\" aria-label=\" verify available ip addresses permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Verify Available IP Addresses</h3>\n<p>To update the cluster, Amazon EKS requires up to five available IP addresses from the subnets that you specified when you created your cluster. To verify that your subnets have enough IP addresses to upgrade the cluster, you can run the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">CLUSTER</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>cluster name<span class=\"token operator\">></span>\naws ec2 describe-subnets --subnet-ids <span class=\"token punctuation\">\\</span>\n    <span class=\"token variable\"><span class=\"token variable\">$(</span>aws eks describe-cluster <span class=\"token parameter variable\">--name</span> $<span class=\"token punctuation\">{</span>CLUSTER<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--query</span> <span class=\"token string\">'cluster.resourcesVpcConfig.subnetIds'</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--output</span> text<span class=\"token variable\">)</span></span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--query</span> <span class=\"token string\">'Subnets[*].[SubnetId,AvailabilityZone,AvailableIpAddressCount]'</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--output</span> table</code></pre></div>\n<p>The <a href=\"https://github.com/aws/amazon-vpc-cni-k8s/tree/master/cmd/cni-metrics-helper\" target=\"_blank\" rel=\"noopener noreferrer\">VPC CNI Metrics Helper</a> may be used to create a CloudWatch dashboard for VPC metrics.</p>\n<h3 id=\"-transition-to-eks-add-ons\" style=\"position:relative;\"><a href=\"#-transition-to-eks-add-ons\" aria-label=\" transition to eks add ons permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Transition to EKS Add-ons</h3>\n<p>Amazon EKS seamlessly deploys essential add-ons like the Amazon VPC CNI plugin for Kubernetes, kube-proxy, and CoreDNS for each cluster. These add-ons can either be self-managed or installed via Amazon EKS Add-ons, offering an alternative approach to add-on management through the EKS API.</p>\n<p>With Amazon EKS Add-ons, you gain the convenience of updating versions with a single command. For instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws eks update-addon --cluster-name my-cluster --addon-name vpc-cni --addon-version version-number <span class=\"token punctuation\">\\</span>\n--service-account-role-arn arn:aws:iam::111122223333:role/role-name --configuration-values <span class=\"token string\">'{}'</span> --resolve-conflicts PRESERVE</code></pre></div>\n<p>Check if you have any EKS Add-ons with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws eks list-addons --cluster-name <span class=\"token operator\">&lt;</span>cluster name<span class=\"token operator\">></span></code></pre></div>\n<p>EKS Add-ons are not automatically upgraded during a control plane upgrade. You must initiate EKS add-on updates and select the desired version. You are responsible for selecting a compatible version from all available versions. Review the guidance on <a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#upgrade-add-ons-and-components-using-the-kubernetes-api\" target=\"_blank\" rel=\"noopener noreferrer\">add-on version compatibility</a>.</p>\n<div class=\"warning\">\n    <p><strong>‚ö†Ô∏è Warning:</strong></p>\n    <p>Amazon EKS Add-ons may only be upgraded one minor version at a time.</p>\n</div>\n<h3 id=\"Ô∏è-kube-no-trouble\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-kube-no-trouble\" aria-label=\"Ô∏è kube no trouble permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Kube-no-trouble</h3>\n<p><a href=\"https://github.com/doitintl/kube-no-trouble\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Kube-no-trouble</strong></a> is an open-source command line utility with the command <code class=\"language-text\">kubent</code>. When you run <code class=\"language-text\">kubent</code> without any arguments, it will use your current KubeConfig context, scan the cluster, and print a report with what APIs will be deprecated and removed.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubent</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token number\">4</span>:17PM INF <span class=\"token operator\">>></span><span class=\"token operator\">></span> Kube No Trouble <span class=\"token variable\"><span class=\"token variable\">`</span>kubent<span class=\"token variable\">`</span></span> <span class=\"token operator\">&lt;&lt;&lt;</span>\n<span class=\"token number\">4</span>:17PM INF version <span class=\"token number\">0.7</span>.0 <span class=\"token punctuation\">(</span>git sha d1bb4e5fd6550b533b2013671aa8419d923ee042<span class=\"token punctuation\">)</span>\n<span class=\"token number\">4</span>:17PM INF Initializing collectors and retrieving data\n<span class=\"token number\">4</span>:17PM INF Target K8s version is <span class=\"token number\">1.24</span>.8-eks-ffeb93d\n<span class=\"token number\">4</span>:17PM INF Retrieved <span class=\"token number\">93</span> resources from collector <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Cluster\n<span class=\"token number\">4</span>:17PM INF Retrieved <span class=\"token number\">16</span> resources from collector <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Helm v3\"</span>\n<span class=\"token number\">4</span>:17PM INF Loaded ruleset <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>custom.rego.tmpl\n<span class=\"token number\">4</span>:17PM INF Loaded ruleset <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>deprecated-1-16.rego\n<span class=\"token number\">4</span>:17PM INF Loaded ruleset <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>deprecated-1-22.rego\n<span class=\"token number\">4</span>:17PM INF Loaded ruleset <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>deprecated-1-25.rego\n<span class=\"token number\">4</span>:17PM INF Loaded ruleset <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>deprecated-1-26.rego\n<span class=\"token number\">4</span>:17PM INF Loaded ruleset <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>deprecated-future.rego\n__________________________________________________________________________________________\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> Deprecated APIs removed <span class=\"token keyword\">in</span> <span class=\"token number\">1.25</span> <span class=\"token operator\">&lt;&lt;&lt;</span>\n------------------------------------------------------------------------------------------\nKIND                NAMESPACE     NAME             API_VERSION      REPLACE_WITH <span class=\"token punctuation\">(</span>SINCE<span class=\"token punctuation\">)</span>\nPodSecurityPolicy   <span class=\"token operator\">&lt;</span>undefined<span class=\"token operator\">></span>   eks.privileged   policy/v1beta1   <span class=\"token operator\">&lt;</span>removed<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.21</span>.0<span class=\"token punctuation\">)</span></code></pre></div>\n<p>It can also be used to scan static manifest files and helm packages. It is recommended to run <code class=\"language-text\">kubent</code> as part of a continuous integration (CI) process to identify issues before manifests are deployed. Scanning manifests is also more accurate than scanning live clusters.</p>\n<p>Kube-no-trouble provides a sample <a href=\"https://github.com/doitintl/kube-no-trouble/blob/master/docs/k8s-sa-and-role-example.yaml\" target=\"_blank\" rel=\"noopener noreferrer\">Service Account and Role</a> with the appropriate permissions for scanning the cluster.</p>\n<h3 id=\"Ô∏è-pluto\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-pluto\" aria-label=\"Ô∏è pluto permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Pluto</h3>\n<p>Another option is <a href=\"https://pluto.docs.fairwinds.com/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Pluto</strong></a>, which is similar to <code class=\"language-text\">kubent</code> because it supports scanning a live cluster, manifest files, helm charts, and has a <a href=\"https://github.com/FairwindsOps/pluto\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub Action</a> you can include in your CI process.</p>\n<p>See if you can upgrade safely against API paths. I use Pluto. This will check to see if you are calling deprecated or removed API paths in your configuration or helm charts. Run Pluto against local files with:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pluto detect-files <span class=\"token parameter variable\">-d</span></code></pre></div>\n<p>You can also check Helm with:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pluto detect-helm <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>Adding all of this to CI is also pretty trivial and something I recommend for people managing many clusters.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pluto detect-all-in-cluster</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">NAME             KIND                VERSION          REPLACEMENT   REMOVED   DEPRECATED   REPL AVAIL  \neks.privileged   PodSecurityPolicy   policy/v1beta1                 false     true         true</code></pre></div>\n<p>After you have identified what workloads and manifests need to be updated, you may need to change the resource type in your manifest files (e.g., PodSecurityPolicies to PodSecurityStandards). This will require updating the resource specification and additional research depending on what resource is being replaced.</p>\n<p>If the resource type is staying the same but the API version needs to be updated, you can use the <code class=\"language-text\">kubectl-convert</code> command to automatically convert your manifest files. For example, to convert an older Deployment to <code class=\"language-text\">apps/v1</code>. For more information, see <a href=\"https://kubernetes.io/docs/tasks/tools/install-kubectl/\" target=\"_blank\" rel=\"noopener noreferrer\">Install kubectl convert plugin</a> on the Kubernetes website.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl-convert <span class=\"token parameter variable\">-f</span> <span class=\"token operator\">&lt;</span>file<span class=\"token operator\">></span> --output-version <span class=\"token operator\">&lt;</span>group<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>version<span class=\"token operator\">></span></code></pre></div>\n<h3 id=\"Ô∏è-nova\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-nova\" aria-label=\"Ô∏è nova permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Nova</h3>\n<p>Check your Helm releases for upgrades. Since typically things like the CNI and other dependencies like CoreDNS are installed with Helm, this is often the fastest way to make sure you are running the latest version (check patch notes to ensure they support the version you are targeting). I use <strong>Nova</strong> for this.</p>\n<h3 id=\"Ô∏è-kubepug\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-kubepug\" aria-label=\"Ô∏è kubepug permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è KubePug</h3>\n<p><strong>KubePug/Deprecations</strong> is designed to function as a kubectl plugin with the following capabilities:</p>\n<ul>\n<li><strong>Downloads Deprecation Data</strong>: It fetches a <code class=\"language-text\">data.json</code> file containing deprecation information related to Kubernetes APIs.</li>\n<li><strong>Validation Check</strong>: Verifies the current Kubernetes cluster or input files to determine whether objects exist in deprecated API Versions. This enables users to assess and plan for migration before proceeding.</li>\n</ul>\n<h4 id=\"key-features\" style=\"position:relative;\"><a href=\"#key-features\" aria-label=\"key features permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Key Features</h4>\n<ul>\n<li>Operates against a Kubernetes cluster, utilizing kubeconfig or the active cluster.</li>\n<li>Can be executed against a distinct set of manifests or files.</li>\n<li>Allows users to specify the target Kubernetes version for validation.</li>\n<li>Provides information on the replacement API that should be adopted.</li>\n<li>Offers details about the version in which the API was deprecated or removed, based on the target cluster version.</li>\n</ul>\n<h4 id=\"how-to-install-as-a-krew-plugin\" style=\"position:relative;\"><a href=\"#how-to-install-as-a-krew-plugin\" aria-label=\"how to install as a krew plugin permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>How to Install as a Krew Plugin</h4>\n<p>Simply run the following command to install it as a Krew plugin:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl krew <span class=\"token function\">install</span> deprecations</code></pre></div>\n<h3 id=\"Ô∏è-eksup-cluster-upgrade-preparation-assistant\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-eksup-cluster-upgrade-preparation-assistant\" aria-label=\"Ô∏è eksup cluster upgrade preparation assistant permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è eksup: Cluster Upgrade Preparation Assistant</h3>\n<p><strong>eksup</strong> is a command-line interface (CLI) designed to empower users with comprehensive information and tools for preparing their clusters for an upgrade. It streamlines the upgrade process by delivering critical insights and actions for a seamless transition.</p>\n<h4 id=\"key-functions\" style=\"position:relative;\"><a href=\"#key-functions\" aria-label=\"key functions permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Key Functions</h4>\n<ul>\n<li><strong>Cluster Analysis</strong>: eksup allows users to assess their clusters against the next Kubernetes version, identifying any potential issues that could impact the upgrade process.</li>\n<li><strong>Playbook Generation</strong>: Users can generate customized playbooks that outline the upgrade steps specific to their cluster's analysis results. These playbooks detail the necessary actions and remediations.</li>\n<li><strong>Flexibility and Learning</strong>: The generated playbook is editable, enabling users to adapt the upgrade steps to align with their cluster configurations and business needs. It also provides a platform to document insights gained during the upgrade process.</li>\n<li><strong>Enhanced Collaboration</strong>: As upgrades are often initiated on non-production clusters first, any additional steps or insights discovered during this phase can be captured and utilized to enhance the upgrade process for production clusters.</li>\n<li><strong>Historical Artifact</strong>: Users are encouraged to preserve their playbooks as historical references. This practice ensures that each upgrade cycle benefits from a deeper understanding of the process, instilling confidence and efficiency in future upgrades before Kubernetes version support expires.</li>\n</ul>\n<p><strong>High Level¬†Diagram</strong></p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 203.5294117647059%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAApCAYAAAA1bQl+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFtElEQVR42oVXi3LjNhDL//9fp3Nt73IXW2+KlPjQW9oCK7uTc5w0M5o4lgSCuwCWeZEnPzGNcrnmkhelpGGUz36O45Ad1/ufl8eH9n2XsjLy/cdPvUzbybyuMs+zDMMgIQRJKelzddNg4Uw/fwq44uXaWLGul7Z10uCal0UBp2kC6Ki/921TcOe6rwEXAFaNlbJupcDVgCG3tgGA24+4Qhz0uz5EXfhrwAUMAXgHbfECt2itlRGMYlNJagpZvJVkKvxdyjbErxmybsZ20hgnre3FA2gaRzmGJFsMMgN0qUrpi1xsWcoeLRaoZRsDAQ+Zg8UfXgHHcZKqNgBr8bvRel4uF6krgKB2PkbpPUCxk6a1cs3BMDnxtpIxhpNhdI1M6QRkJ2sw0xqi22TL+rEJ6zTLgueWgLpOEe8Z6bHlHczkYB0PedlQ0BVfrMssIxiwm2wEAcva6ud793nfdj0aM8m2H1pfAxUs6yY2rhLHTV7meZEOD7nurNWKmwp4a8rZ5VOfXCwNeD5i68MslekkK43EaZefuRXjkrwcD6IeUHxqj03h6g1qWKF+fd/j8np1t89d10mNOvO9Q50jZ1P2KcgxJ5Rh127WjQFIiRrW2hTnHJo1qgLuZaEOCWja9lGHuAE9DV0jss0yj4MYWIqA1KKBbNgUuiPGpKXp0OVpPg2QFbWM+NwlCH/ezy4f2wJ2m67A1dnlqnFax3tTyIj3+jhKF0YZl10a66XC/TgfkjcoAe59ELYCvnMKaxmhPW4vwjEBdtNwAGt+z9pyB8t2yIrOP7HeAkG3N5ZWAQnAGk5YLGDbA8TP2KobSKtqZPvKy1yND7ExjKdrlmtX7zqMwcsAR2zLJM4asa2RfR4kmkym4D4Cslb0sDI0Z3xxawNYTnCK750kAO6ouzFoXl3DKV7a8iqh/wTwvt2zhv0p6DQoYIT4T4YzGEL4AFxGps3+fMvvASsERGvPAFUg+Nx3FoBe9hUMG+gU8trw+Z2wH0YAt4xt5vDxpUBANBwBB7S2iU+TysanWWVTtx73nQR4ODPQaJw/mykNBFtJXtZyhXBPh8ya1M7R81GDmDFX4Jl1xTttVI8/TWz6VyMM7F7fCh0Fzg/K7GQ4yXQTdlG1J8MWi8XlibChwxKGz7AymV6yQt4umXjYLYYEgQeIOWiDGMBFWWl8FWDowhOnMLEZCIwm1uf1Usqff70qwzSuEhBbARE2oKasYQ6GHgwvdXxeQzqC8V/WRp2Qo5Z/f3/VrKRLOsSW13BYVPxaw20HQ9x7BKRkKGJ2maLOKie/slr++PZD2h4+Hhfp2WlcaUIQ26B19gMZerH+YcvsMM3P4cPTA5tzzUr55/tPzN9O5zKDlSGhBwIwZH03MDT+lNPLY9IQkDVkQygL5t2P1183P3PYTyqPLi1i0Rw+S01mZtDvdKZ47xWILCgbo0PKaupwKJUYAYz6EeHLcHU9Jt5wqqGsqFNIqOOcWeWF1GmpcRpPv4IlI6uonVxKNKft4Rr8piPQ4S7gwITTGVPaAthCRhH1rBRw+33Lm4ZmUjdUzDrUyHYcSkHrSadYh7+hRwJmeSVviLcF1rRh0UZ96DKnnrFn/GfVqcfOJ93mMEGH6HAc6eVNv+OCCZq80MvhiVMYoncd0susJ09cTB0PZhzuDiBMbT7zds21hm0/aEk+MDyb4m5+tgrAMyFnyqoHz0XHBCXG0cCG/s9xbvktYO8nBx2f3Tnc6RRKrISPeYLlQlAOHHN8cj4096l3jtHjxn7FYgn16yFgdYqDDqECevnaxI/We8/wv6kHQIYuM5F+ZsPIloO/0alX69Rr0RDG2NOpx1CoUXCdfmDLl5UhNTvBCEwbMDRdxAEJoTHu8lYFSGd+PgJ00FPM6md3MuR2IfwW5xwy1dwEuzwvlAQjjdp8OqT0YJ4GveK7/1MIfP/f5Lhft3fuXf4XTdhhPG1vSUAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/2bcf04daf28b5bc0a01a97056b293483/c5bb3/eksup.png\" srcset=\"/static/2bcf04daf28b5bc0a01a97056b293483/04472/eksup.png 170w,\n/static/2bcf04daf28b5bc0a01a97056b293483/9f933/eksup.png 340w,\n/static/2bcf04daf28b5bc0a01a97056b293483/c5bb3/eksup.png 680w,\n/static/2bcf04daf28b5bc0a01a97056b293483/5a190/eksup.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"-gonogo\" style=\"position:relative;\"><a href=\"#-gonogo\" aria-label=\" gonogo permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üö¶ GoNoGo</h3>\n<p><a href=\"https://github.com/FairwindsOps/GoNoGo\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>GoNoGo</strong></a> is an alpha-stage tool to determine the upgrade confidence of your cluster add-ons.</p>\n<h3 id=\"Ô∏è-configure-poddisruptionbudgets-and-topologyspreadconstraints-during-data-plane-upgrade\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-configure-poddisruptionbudgets-and-topologyspreadconstraints-during-data-plane-upgrade\" aria-label=\"Ô∏è configure poddisruptionbudgets and topologyspreadconstraints during data plane upgrade permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Configure PodDisruptionBudgets and TopologySpreadConstraints During Data Plane Upgrade</h3>\n<p>To safeguard the availability of your workloads during a data plane upgrade, it's crucial to configure <strong>PodDisruptionBudgets</strong> and <strong>topologySpreadConstraints</strong> appropriately. Remember that not all workloads demand the same level of availability. Thus, it's imperative to assess your workload's scale and requirements.</p>\n<p>Ensuring that workloads are distributed across multiple Availability Zones and hosts with topology spreads enhances the confidence that migrations to the new data plane will occur seamlessly and without disruptions.</p>\n<p>Here's an illustrative example of a workload configuration that guarantees 80% of replicas are consistently available and efficiently spreads replicas across zones and hosts:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> policy/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PodDisruptionBudget\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">minAvailable</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"80%\"</span>\n    <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n    <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n        <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> public.ecr.aws/eks<span class=\"token punctuation\">-</span>distro/kubernetes/pause<span class=\"token punctuation\">:</span><span class=\"token number\">3.2</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp\n                <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span>\n                        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 256M\n            <span class=\"token key atrule\">topologySpreadConstraints</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> host<span class=\"token punctuation\">-</span>zone<span class=\"token punctuation\">-</span>spread\n                <span class=\"token key atrule\">maxSkew</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n                <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname\n                <span class=\"token key atrule\">whenUnsatisfiable</span><span class=\"token punctuation\">:</span> DoNotSchedule\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> host<span class=\"token punctuation\">-</span>zone<span class=\"token punctuation\">-</span>spread\n                <span class=\"token key atrule\">maxSkew</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n                <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> topology.kubernetes.io/zone\n                <span class=\"token key atrule\">whenUnsatisfiable</span><span class=\"token punctuation\">:</span> DoNotSchedule</code></pre></div>\n<h3 id=\"-aws-resilience-hub\" style=\"position:relative;\"><a href=\"#-aws-resilience-hub\" aria-label=\" aws resilience hub permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê AWS Resilience Hub</h3>\n<p><a href=\"https://aws.amazon.com/resilience-hub/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Resilience Hub</a> has added Amazon Elastic Kubernetes Service (Amazon EKS) as a supported resource. Resilience Hub provides a single place to define, validate, and track the resilience of your applications so that you can avoid unnecessary downtime caused by software, infrastructure, or operational disruptions.</p>\n<h3 id=\"Ô∏è-use-managed-node-groups-or-karpenter-to-simplify-data-plane-upgrades\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-use-managed-node-groups-or-karpenter-to-simplify-data-plane-upgrades\" aria-label=\"Ô∏è use managed node groups or karpenter to simplify data plane upgrades permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Use Managed Node Groups or Karpenter to Simplify Data Plane Upgrades</h3>\n<p>Managed Node Groups and Karpenter both simplify node upgrades, but they take different approaches.</p>\n<ul>\n<li><strong>Managed Node Groups</strong>: Automate the provisioning and lifecycle management of nodes. This means that you can create, automatically update, or terminate nodes with a single operation.</li>\n<li><strong>Karpenter</strong>: Automatically creates new nodes using the latest compatible EKS Optimized AMI. As EKS releases updated EKS Optimized AMIs or the cluster is upgraded, Karpenter will automatically start using these images. <a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/#enable-node-expiry-for-karpenter-managed-nodes\" target=\"_blank\" rel=\"noopener noreferrer\">Karpenter also implements Node Expiry to update nodes</a>. <a href=\"https://karpenter.sh/docs/concepts/node-templates/\" target=\"_blank\" rel=\"noopener noreferrer\">Karpenter can be configured to use custom AMIs</a>. If you use custom AMIs with Karpenter, you are responsible for the version of kubelet.</li>\n</ul>\n<h3 id=\"-use-code-classlanguage-texteksctlcode-to-automate-upgrades-for-self-managed-node-groups\" style=\"position:relative;\"><a href=\"#-use-code-classlanguage-texteksctlcode-to-automate-upgrades-for-self-managed-node-groups\" aria-label=\" use code classlanguage texteksctlcode to automate upgrades for self managed node groups permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ü§ñ Use <code class=\"language-text\">eksctl</code> to Automate Upgrades for Self-Managed Node Groups</h3>\n<p>Self-managed node groups are EC2 instances that were deployed in your account and attached to the cluster outside of the EKS service. These are usually deployed and managed by some form of automation tooling. To upgrade self-managed node groups you should refer to your tools documentation.</p>\n<p>For example, <code class=\"language-text\">eksctl</code> supports <a href=\"https://eksctl.io/usage/managing-nodegroups/#deleting-and-draining\" target=\"_blank\" rel=\"noopener noreferrer\">deleting and draining self-managed nodes</a>. Some common tools include:</p>\n<ul>\n<li><a href=\"https://eksctl.io/usage/nodegroup-upgrade/\" target=\"_blank\" rel=\"noopener noreferrer\">eksctl</a></li>\n<li><a href=\"https://kops.sigs.k8s.io/operations/updates_and_upgrades/\" target=\"_blank\" rel=\"noopener noreferrer\">kOps</a></li>\n<li><a href=\"https://aws-ia.github.io/terraform-aws-eks-blueprints/node-groups/#self-managed-node-groups\" target=\"_blank\" rel=\"noopener noreferrer\">EKS Blueprints</a></li>\n</ul>\n<h3 id=\"-backup-the-cluster-before-upgrading\" style=\"position:relative;\"><a href=\"#-backup-the-cluster-before-upgrading\" aria-label=\" backup the cluster before upgrading permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üíæ Backup the Cluster Before Upgrading</h3>\n<p>New versions of Kubernetes introduce significant changes to your Amazon EKS cluster. After you upgrade a cluster, you can't downgrade it.</p>\n<p><a href=\"https://velero.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Velero</a> is a community-supported open-source tool that can be used to take backups of existing clusters and apply the backups to a new cluster.</p>\n<p>Note that you can only create new clusters for Kubernetes versions currently supported by EKS. If the version your cluster is currently running is still supported and an upgrade fails, you can create a new cluster with the original version and restore the data plane. Note that AWS resources, including IAM, are not included in the backup by Velero. These resources would need to be recreated.</p>\n<h3 id=\"-anticipate-major-kubernetes-changes-stay-ahead-of-the-curve\" style=\"position:relative;\"><a href=\"#-anticipate-major-kubernetes-changes-stay-ahead-of-the-curve\" aria-label=\" anticipate major kubernetes changes stay ahead of the curve permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Anticipate Major Kubernetes Changes‚Ää-‚ÄäStay Ahead of the Curve</h3>\n<p>Rather than solely focusing on the immediate next version of Kubernetes, adopt a forward-thinking approach. Continuously monitor new Kubernetes releases and be vigilant in identifying significant alterations. For instance, certain applications directly interfaced with the Docker API, and Kubernetes 1.24 made a pivotal change by removing support for Container Runtime Interface (CRI) for Docker, commonly known as Dockershim. üê≥ Preparing for such substantial changes demands additional time and planning.</p>\n<p>Examine all documented modifications for the version to which you plan to upgrade, meticulously noting any mandatory upgrade procedures. Additionally, pay attention to specific requirements or processes tailored to Amazon EKS managed clusters. This proactive stance ensures a smoother upgrade process while mitigating potential disruptions caused by unforeseen changes.</p>\n<p>Always keep an eye on <a href=\"https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes CHANGLELOG</a></p>\n<h3 id=\"-important-guidance-on-feature-removals\" style=\"position:relative;\"><a href=\"#-important-guidance-on-feature-removals\" aria-label=\" important guidance on feature removals permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üö¢ Important Guidance on Feature Removals</h3>\n<h4 id=\"Ô∏è-removal-of-dockershim-in-125-transition-to-detector-for-docker-socket-dds\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-removal-of-dockershim-in-125-transition-to-detector-for-docker-socket-dds\" aria-label=\"Ô∏è removal of dockershim in 125 transition to detector for docker socket dds permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ñ∂Ô∏è Removal of Dockershim in 1.25‚Ää-‚ÄäTransition to Detector for Docker Socket (DDS)</h4>\n<p>In Kubernetes 1.25, Dockershim support has been discontinued, particularly in the EKS Optimized AMI for 1.25. If your applications rely on Dockershim, for instance, by mounting the Docker socket, it's imperative to eliminate these dependencies before proceeding with the upgrade of your worker nodes to version 1.25. This ensures a seamless transition without any disruptions caused by the removal of Dockershim.</p>\n<p>Find instances where you have a dependency on the Docker socket before upgrading to 1.25. We recommend using <a href=\"https://github.com/aws-containers/kubectl-detector-for-docker-socket\" target=\"_blank\" rel=\"noopener noreferrer\">Detector for Docker Socket (DDS)</a>, a kubectl plugin.</p>\n<h4 id=\"Ô∏è-removal-of-podsecuritypolicy-in-125-migration-to-pod-security-standards-or-policy-as-code-solution\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-removal-of-podsecuritypolicy-in-125-migration-to-pod-security-standards-or-policy-as-code-solution\" aria-label=\"Ô∏è removal of podsecuritypolicy in 125 migration to pod security standards or policy as code solution permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ñ∂Ô∏è Removal of PodSecurityPolicy in 1.25‚Ää-‚ÄäMigration to Pod Security Standards or Policy-as-Code Solution</h4>\n<p>PodSecurityPolicy, deprecated in Kubernetes 1.21, has been entirely removed in Kubernetes 1.25. If your cluster currently utilizes PodSecurityPolicy, it's paramount to initiate a migration process before upgrading your cluster to version 1.25. This migration should involve transitioning to the native Kubernetes Pod Security Standards (PSS) or implementing a policy-as-code solution. This proactive step is crucial for maintaining the uninterrupted functionality of your workloads during the upgrade.</p>\n<ul>\n<li>Review the <a href=\"https://kubernetes.io/docs/concepts/security/pod-security-standards/\" target=\"_blank\" rel=\"noopener noreferrer\">Pod Security Standards (PSS)</a> and <a href=\"https://kubernetes.io/docs/concepts/security/pod-security-admission/\" target=\"_blank\" rel=\"noopener noreferrer\">Pod Security Admission (PSA)</a> best practices.</li>\n<li>Review the <a href=\"https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/\" target=\"_blank\" rel=\"noopener noreferrer\">PodSecurityPolicy Deprecation blog post</a> on the Kubernetes website.</li>\n</ul>\n<h4 id=\"Ô∏è-deprecation-of-in-tree-storage-driver-in-123-migrate-to-container-storage-interface-csi-drivers\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-deprecation-of-in-tree-storage-driver-in-123-migrate-to-container-storage-interface-csi-drivers\" aria-label=\"Ô∏è deprecation of in tree storage driver in 123 migrate to container storage interface csi drivers permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ñ∂Ô∏è Deprecation of In-Tree Storage Driver in 1.23‚Ää-‚ÄäMigrate to Container Storage Interface (CSI) Drivers</h4>\n<p>The Container Storage Interface (CSI) was designed to help Kubernetes replace its existing, in-tree storage driver mechanisms. The Amazon EBS container storage interface (CSI) migration feature is enabled by default in Amazon EKS 1.23 and later clusters. If you have pods running on a version 1.22 or earlier cluster, then you must install the Amazon EBS CSI driver before updating your cluster to version 1.23 to avoid service interruption.</p>\n<ul>\n<li>Review the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon EBS CSI migration frequently asked questions</a>.</li>\n</ul>\n<h3 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîö Conclusion</h3>\n<p>I trust that the information provided has been valuable to you. The journey of keeping Kubernetes consistently upgraded becomes less daunting with regular practice. The key takeaway is to allocate ample time to acclimate your environment with each minor release. By adhering to a predictable schedule, the process of upgrading clusters becomes remarkably painless and straightforward, even for less experienced users, as long as you perform the necessary checks.</p>\n<p>Remember, the key to success lies in regularity and thorough preparation when it comes to Kubernetes upgrades.</p>\n<p>We hope that you have found this blog post helpful. If you have any other tips or tricks that you would like to share, please leave a comment below.</p>\n<h2 id=\"-conclusion-1\" style=\"position:relative;\"><a href=\"#-conclusion-1\" aria-label=\" conclusion 1 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîö Conclusion</h2>\n<p>I trust that the information provided has been valuable to you. The journey of keeping Kubernetes consistently upgraded becomes less daunting with regular practice. The key takeaway is to allocate ample time to acclimate your environment with each minor release. By adhering to a predictable schedule, the process of upgrading clusters becomes remarkably painless and straightforward, even for less experienced users, as long as you perform the necessary checks.</p>\n<p>Remember, the key to success lies in regularity and thorough preparation when it comes to Kubernetes upgrades.</p>\n<p>We hope that you have found this blog post helpful. If you have any other tips or tricks that you would like to share, please leave a comment below.</p>\n<p><strong>üìï References:</strong></p>\n<ul>\n<li><a href=\"https://repost.aws/knowledge-center/eks-plan-upgrade-cluster\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Knowledge Center: Plan an EKS Cluster Upgrade</a></li>\n<li><a href=\"https://aws.github.io/aws-eks-best-practices/upgrades/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EKS Best Practices: Upgrades</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/kubernetes-validation-cel/","title":"Introducing Kubernetes Validation with Common Expression Language (CEL) ‚òØ","date":"2024-10-31 19:30:00"},"excerpt":"Simplify Complex Validations with CEL and Kyverno Policies ‚òØ üîÜ Introduction Kubernetes is extensible and allows users to create Custom‚Ä¶","html":"<blockquote>\n<p><strong>Simplify Complex Validations with CEL and Kyverno Policies ‚òØ</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÜ Introduction</h2>\n<p>Kubernetes is extensible and allows users to create <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Resources (CR)</a> and <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Resource Definitions (CRD)</a> that define the structure and meta-attributes of future resources. However, creating complex validation webhooks for each CRD can be an operational and development overhead.</p>\n<p>Kubernetes now provides a solution in the form of the <a href=\"https://kubernetes.io/docs/reference/using-api/cel/\" target=\"_blank\" rel=\"noopener noreferrer\">Common Expression Language (CEL)</a>. CEL is a simple yet powerful language that allows you to define complex validation rules directly in the Kubernetes API server. With CEL, you can introduce complex validations without creating your own validating webhooks in code.</p>\n<p><a href=\"https://kyverno.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kyverno</a> is a Kubernetes-native policy engine that allows you to define policies as code. With Kyverno, you can enforce best practices, security standards, and compliance requirements.</p>\n<p>By using CEL expressions in Kyverno policies, you can simplify your validation rules and make them more expressive.</p>\n<p>In this blog post, we'll explore how to use CEL expressions in Kyverno policies to simplify your Kubernetes validation rules. We'll walk through examples of using CEL expressions in Kyverno policies to enforce policies for your Kubernetes resources.</p>\n<p>So, if you're looking to simplify your Kubernetes validation rules and make them more expressive, read on to learn how to use CEL expressions in Kyverno policies.</p>\n<h2 id=\"cel-and-validation-in-kubernetes\" style=\"position:relative;\"><a href=\"#cel-and-validation-in-kubernetes\" aria-label=\"cel and validation in kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>CEL and Validation in Kubernetes</h2>\n<p>Kubernetes Custom Resource Definitions (CRDs) support validation through <a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema\" target=\"_blank\" rel=\"noopener noreferrer\">structural schemas</a>, <a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation\" target=\"_blank\" rel=\"noopener noreferrer\">OpenAPI v3 validation rules</a>, <a href=\"https://thenewstack.io/developer-guardrails-with-custom-kubernetes-resource-validators/\" target=\"_blank\" rel=\"noopener noreferrer\">custom validators</a>, and <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">admission webhooks</a>.</p>\n<p>CRD structural schemas provide type checking, while OpenAPI v3 validation rules offer regex, range, and size limits. Custom validators can be written in various languages, and admission webhooks are used for more complex validation scenarios.</p>\n<p>To address the need for self-contained validation, Kubernetes introduced Common Expression Language (CEL) into CRDs. CEL is a lightweight, safe, and easy-to-use expression language that supports pre-parsing and type checking at CRD registration time. This allows syntax and type errors to be caught before the CRD is deployed, improving cluster operability and reducing the need for webhooks. CEL is chosen for its simplicity, flexibility, and ability to express validation rules in a declarative manner. This choice aligns with Kubernetes' goal of providing a simple and consistent validation framework for CRDs.</p>\n<hr>\n<h3 id=\"a-deep-dive-into-cel\" style=\"position:relative;\"><a href=\"#a-deep-dive-into-cel\" aria-label=\"a deep dive into cel permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>A Deep Dive into CEL</h3>\n<p>Kubernetes CRDs support validation through CEL to ensure the correctness and consistency of custom resources. This feature, introduced in Kubernetes 1.25, allows developers to define validation rules using CEL expressions, which are declarative and lightweight. CEL validation rules are scoped to the location of the <code class=\"language-text\">x-kubernetes-validations</code> extension in the CRD schema, and the <code class=\"language-text\">self</code> variable in the CEL expression is bound to the scoped value. All validation rules are scoped to the current object, and cross-object or stateful validation rules are not supported.</p>\n<p>For example, a validation rule using <code class=\"language-text\">x-kubernetes-validations</code> could be:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">openAPIV3Schema</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n  <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n      <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> string\n          <span class=\"token key atrule\">x-kubernetes-validations</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"self.cpu in ['1', '2', '4']\"</span>\n            <span class=\"token key atrule\">message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CPU should be one of 1, 2, or 4.\"</span>\n        <span class=\"token key atrule\">required</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> cpu</code></pre></div>\n<p><a href=\"https://github.com/kubernetes/kubernetes/issues/121164\" target=\"_blank\" rel=\"noopener noreferrer\">CEL validation rules support a wide range of use cases, and they were promoted to GA in Kubernetes 1.29</a>. This feature has been adopted by many Kubernetes ecosystem projects and is widely used in the Kubernetes community. CEL validation rules provide a lightweight and self-contained validation mechanism that reduces the need for admission webhooks and simplifies the development and operability of CRDs. They also allow users to define complex validation rules in a declarative manner, improving the readability and maintainability of the CRD schema.</p>\n<hr>\n<h3 id=\"kyverno-a-policy-engine-for-k8s-resource-validation\" style=\"position:relative;\"><a href=\"#kyverno-a-policy-engine-for-k8s-resource-validation\" aria-label=\"kyverno a policy engine for k8s resource validation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kyverno: A Policy Engine for k8s Resource Validation</h3>\n<p>Kyverno is a policy engine for Kubernetes that enables resource validation, change, and creation based on defined policies. It uses CEL expressions for validation, reducing the need for admission webhooks. <a href=\"https://kyverno.io/policies/\" target=\"_blank\" rel=\"noopener noreferrer\">Kyverno policies</a> consist of Match, Exclude, Validate, Mutate, Generate, and Verify Images clauses, allowing users to define complex validation rules in a declarative manner.</p>\n<p>Kyverno policies provide a lightweight and self-contained validation mechanism that reduces the need for admission webhooks and simplifies the development and operability of CRDs. They also allow users to define complex validation rules in a declarative manner, improving the readability and maintainability of the CRD schema.</p>\n<h4 id=\"using-cel-expressions-in-kyverno-policies\" style=\"position:relative;\"><a href=\"#using-cel-expressions-in-kyverno-policies\" aria-label=\"using cel expressions in kyverno policies permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Using CEL Expressions in Kyverno Policies</h4>\n<p>CEL expressions in Kyverno policies are used in the validate section. The <code class=\"language-text\">message</code> field is used to display an error message when the expression evaluates to false. The <code class=\"language-text\">validationFailureAction</code> field is used to enforce the validation failure action when the expression evaluates to false.</p>\n<p>CEL expressions in Kyverno policies can be used to validate various aspects of Kubernetes resources, such as resource limits, labels, and annotations. Kyverno also supports the automatic generation of policy rules for higher-level controllers, such as Deployments, DaemonSets, StatefulSets, and CronJobs.</p>\n<p>To create a Kyverno policy that disallows CPU requests without a value, use the following example:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kyverno.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterPolicy\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> disallow<span class=\"token punctuation\">-</span>cpu<span class=\"token punctuation\">-</span>requests<span class=\"token punctuation\">-</span>without<span class=\"token punctuation\">-</span>value\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">validationFailureAction</span><span class=\"token punctuation\">:</span> Enforce\n  <span class=\"token key atrule\">background</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> disallow<span class=\"token punctuation\">-</span>cpu<span class=\"token punctuation\">-</span>requests<span class=\"token punctuation\">-</span>without<span class=\"token punctuation\">-</span>value\n    <span class=\"token key atrule\">match</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">any</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">kinds</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> Pod \n    <span class=\"token key atrule\">validate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">cel</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">expressions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CPU requests must have a value\"</span>\n            <span class=\"token key atrule\">expression</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"object.spec.containers.all(container, has(container.resources.requests.cpu))\"</span></code></pre></div>\n<p>Now, let's try deploying a pod without CPU requests:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cpu<span class=\"token punctuation\">-</span>pod\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cpu<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"256Mi\"</span></code></pre></div>\n<p>We can see that our policy is enforced. Great!</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply <span class=\"token parameter variable\">-f</span> pod.yaml\nError from server: error when creating <span class=\"token string\">\"pod.yaml\"</span><span class=\"token builtin class-name\">:</span> admission webhook <span class=\"token string\">\"validate.kyverno.svc-fail\"</span> denied the request: \n\nresource Pod/default/cpu-pod was blocked due to the following policies \n\ndisallow-cpu-requests-without-value:\n  disallow-cpu-requests-without-value: CPU requests must have a value</code></pre></div>\n<p>Some other useful variables that we can use in CEL expressions are:</p>\n<ul>\n<li><code class=\"language-text\">oldObject</code>: The existing object. The value is null for CREATE requests.</li>\n<li><code class=\"language-text\">authorizer</code>: It can be used to perform authorization checks.</li>\n<li><code class=\"language-text\">authorizer.requestResource</code>: A shortcut for an authorization check configured with the request resource (group, resource, (subresource), namespace, name).</li>\n</ul>\n<h4 id=\"cel-preconditions-in-kyverno-policies\" style=\"position:relative;\"><a href=\"#cel-preconditions-in-kyverno-policies\" aria-label=\"cel preconditions in kyverno policies permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>CEL Preconditions in Kyverno Policies</h4>\n<p>The below policy ensures the <code class=\"language-text\">hostPort</code> field is set to a value between 5000 and 6000 for pods whose <code class=\"language-text\">metadata.name</code> is set to nginx:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: disallow-host-port-range\nspec:\n  validationFailureAction: Enforce\n  background: false\n  rules:\n    - name: host-port-range\n      match:\n        any:\n        - resources:\n            kinds:\n              - Pod\n      celPreconditions:\n          - name: \"first match condition in CEL\"\n            expression: \"object.metadata.name.matches('nginx')\"\n      validate:\n        cel:\n          expressions:\n          - expression: \"object.spec.containers.all(container, !has(container.ports) || container.ports.all(port, !has(port.hostPort) || (port.hostPort >= 5000 &amp;&amp; port.hostPort &lt;= 6000)))\"\n            message: \"The only permitted hostPorts are in the range 5000-6000.\"\nEOF</span></code></pre></div>\n<p><code class=\"language-text\">spec.rules.celPreconditions</code> are CEL expressions. All celPreconditions must be evaluated to true for the resource to be evaluated. Therefore, any Pod with nginx in its <code class=\"language-text\">metadata.name</code> will be evaluated.</p>\n<p>Let's try deploying an Apache server with <code class=\"language-text\">hostPort</code> set to 80:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: apache\nspec:\n  containers:\n  - name: apache-server\n    image: httpd\n    ports:\n    - containerPort: 8080\n      hostPort: 80\nEOF</span></code></pre></div>\n<p>You'll see that it's successfully created because the validation rule wasn't applied to the new Pod as it doesn't satisfy the celPreconditions. That's exactly what we need.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Pod/apache created</code></pre></div>\n<p>Let's try deploying an Nginx server with <code class=\"language-text\">hostPort</code> set to 80:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  containers:\n  - name: nginx-server\n    image: nginx\n    ports:\n    - containerPort: 8080\n      hostPort: 80\nEOF</span></code></pre></div>\n<p>Since the new Pod satisfies the celPreconditions, the validation rule will be applied. As a result, the creation of the Pod will be blocked as it violates the rule.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Error from server: error when creating <span class=\"token string\">\"STDIN\"</span><span class=\"token builtin class-name\">:</span> admission webhook <span class=\"token string\">\"validate.kyverno.svc-fail\"</span> denied the request:\nresource Pod/default/nginx was blocked due to the following policies\n\ndisallow-host-port-range:\n  host-port-range: The only permitted hostPorts are <span class=\"token keyword\">in</span> the range <span class=\"token number\">5000</span>-6000.</code></pre></div>\n<h2 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Summary</h2>\n<p>The blog provides a good understanding of the Common Expression Language (CEL) and its application in Kubernetes <code class=\"language-text\">ValidatingAdmissionPolicies</code>. It shows the significance of CEL in validating Custom Resource Definitions (CRDs) and its integration into Kyverno policies for resource validation. The post covers the features introduced in Kubernetes ValidatingAdmissionPolicies and demonstrates the use of CEL expressions in Kyverno policies to validate resources. It also emphasizes the benefits of using CEL for in-process validation, reducing the reliance on admission webhooks, and simplifying the development and operability of CRDs.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">Saifeddine Rajhi</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">@rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}