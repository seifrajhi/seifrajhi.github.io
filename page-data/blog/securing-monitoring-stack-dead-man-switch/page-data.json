{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/securing-monitoring-stack-dead-man-switch/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Who Watches the Watchers and the Monitoring Stack? üëÆ</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üí¨ Introduction</h2>\n<p>Nowadays, monitoring systems play an important role in ensuring the smooth operation of critical infrastructure.</p>\n<p>However, what happens when the monitoring system itself falters? This is where the concept of a <a href=\"https://deadmanssnitch.com/\" target=\"_blank\" rel=\"noopener noreferrer\">dead man switch</a> comes into play.</p>\n<p>A dead man switch, in the context of monitoring, serves as an independent watchdog, tasked with keeping an eye on the monitoring system. If the monitoring system fails to provide <a href=\"https://en.wikipedia.org/wiki/Heartbeat_(computing)\" target=\"_blank\" rel=\"noopener noreferrer\">regular heartbeats</a> to the dead man switch, it triggers an alarm, alerting operators to a potential problem.</p>\n<h2 id=\"-objectives\" style=\"position:relative;\"><a href=\"#-objectives\" aria-label=\" objectives permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ü•Ö Objectives</h2>\n<p>This blog post is a deep dive into the implementation of a dead man switch for <a href=\"https://prometheus.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Prometheus</a>, a widely used monitoring tool. We'll explore the tools and techniques involved in setting up this guardian of the guardians, ensuring that our monitoring system remains vigilant and reliable.</p>\n<p>By the end of this post, you'll have a clear understanding of how a dead man switch can safeguard your monitoring system and prevent blind spots in your infrastructure.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 512px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEz0lEQVR42gHEBDv7AAsTFgAAAAABAQAAAAAAAAIHCwwSFw0aHgtBSh5JUi5KUzlNU0tSU1pXU1pWUk1QTzhJTiFDSwg8Rww8RgAPXGQLDhEAAAABAgIAAAADCAwTGB0aIiYgRk82UVlIVFliXFqOdF6gfVyee1mPclhpX1VASk8hRk0gQEcABomPEF1iCgwOAAAAAQEBBAcKGB8lJysyNUtSTVpfdGVdnXBUyJlh1q1q1apnzJ9jo3dUcFpPQFheETU/AAqAhgV/ghRMUhMbHgAAAAQGCRsgJy0yO0FMUm1lY6FzWsiGT+OzaPDWiO/VhOfEc8+LSphwVDtXYQ4tNgAZmKgGfoQVYGk2UFsqMTQAAAAZHiMwNUBLTlSPb13Df0vfo1nxzn778sH79Mn235nor1mrfV06T1QRMDcAD4+cDZmnFVxmJD9IWG97PkBECgsOKzA7T05Tk29cypNr6bNh9uCZ/f73/v//+u6/78Jku4ZhSlRREC42AAt2eglschNeZxw7QkZcZY2aqWReZDc4QkZFTHJTTLF6ae2uV/Tck/7/+f7///nuv+6+YLKFY0BPVA8iKgAJfIYNYmYUWF4WOUA8TlN4qrulxtpUT1lAQE17doKtiInapHvtvmr335734qfvzX7io06GblocKzQFCw8ABoGKCIGIEkZNES0zL0pQKZu6Qb3jQUZROzdCfIyomYudrX9635RF57168Pfn4MykxHo9XEhABwoRAQQGAAp1ewZ4exBGSxAYHBtJWQGu3Aar2DFBSickKzxUaE9ohqBvWcBuM8mje97//8HIt4leRTw5OQACBgEBAgAHbHMFbnMUU1kWMTUaQk4QgaERlrgjOkIaFRcZRFshcpJsaGF9TjmajXjG9eSbu6dPUlApMzcDBwwHFhwACHB5BWhvEE1UFDI3GDU+KICZVKK5GC43Cw0QHURcL1NgNGBsU2Fobo6HsefLgbKfJ0lPHTU8CxsjCB0mAApzdwVmaQ5SVxIxNxstNRJ5nhew4QsiKhsYGUJmdkhjbkBncihjd0yGhKDcvmqmlQxATBQ1PgkaIAYbIwAIcnQEcnANVloPLzUXKC8PTWsCgrkIHCMRDAonOkAoSFI/XWQHT2QubW+LzrBYnIwAM0ISMjsKGiAFGyIABnFyA2trDExPDi8zDSIsAR0zBDJNGSwyJiovME5bQlpfQFxpFzE4cYx9h7GbO2hmETlFFjM6CRkfBRkfAAV7fgNpaw5LTQ0tLwskKwQiLhU0PSc/RzxOWDZQWz1TXH2Ri8rOpP/+yqCljx41RCtGTzI/QwoYHgQWHAANYGEKLi8ePkIbNz0PJy0TKzMdMzwhOEETKzccNT83Qj9wgHLj7rDl7q+SooQaNkQjP0gdLDEUGR0HERUAEhUbDxAUDBIVDx4jFy01GTA6Eyo2ECc0DyYvQVpMf5Zwka+Fv9mcz+elgZx6EzA+HThCFzQ+Dh0iDQ8SAAUMEAQLEQsZJhAlNRAmMxs0Oi9NRVN3XIivfq3VlbTdmrPamazRlLndm3aYdBEqNhoxORgvORcxOwkWGgAQJCcnRkE1WUxKdVZglGVzrXGIxH2SzoKQy4GKxH2IwXyJwn6Mw3+WzoZnlWoRJzIWLTUVLDMVLTUVLzdkK5VPW0cNiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"dms\" title=\"\" src=\"/static/5ea78d6221ddecfdc2ea528584b7892e/01e7c/dms.png\" srcset=\"/static/5ea78d6221ddecfdc2ea528584b7892e/04472/dms.png 170w,\n/static/5ea78d6221ddecfdc2ea528584b7892e/9f933/dms.png 340w,\n/static/5ea78d6221ddecfdc2ea528584b7892e/01e7c/dms.png 512w\" sizes=\"(max-width: 512px) 100vw, 512px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-dead-mans-switch\" style=\"position:relative;\"><a href=\"#-dead-mans-switch\" aria-label=\" dead mans switch permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìò Dead Man's Switch</h2>\n<p>A monitoring system can be very simple, like a ping to a server IP, or it can be as complex as monitoring every component in a distributed system to ensure everything is working as expected. No matter how sophisticated the monitoring system is, we rely on them to ensure that our main system is in a healthy state. But what happens when your monitoring system fails? How do you know that your monitoring system is healthy?</p>\n<p>A frequent question I get asked when working with our DevOps teams is:</p>\n<blockquote>\n<p><strong>Who is monitoring the monitoring system to make sure it's working?</strong></p>\n</blockquote>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 54.70588235294118%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB30lEQVR42oWTbY/SQBSF+f+/xY9GP7jGdaOyQFgxvK4CUqBMaaFv9L2dPs7UJQiaeJOTO83tnDN37plWLSV1XZOmKVEUEcdxgyRJyPO8ga7pb13XWaMsy2bfLVrUEqhxjw7mdoMldji2zWg0otvp0H964lHl3W7HZrNBCNFAk+r4izCMJWEKcaGQg5tI0qpCKuR5QVVo5M3Pf0ZdyxfcEHZmEXc9wbuuyedJxKe9xTDYsIocNrnLOAqwconuI60kSSkpZXUh5oawv6y4/+ZyPzjSVeu2WHE36/J2+IWH7YSPfsr7tc/dQvDoVXx1F4jTmKiw8DNDdXXUrBdCxy+w/RIvkuyDgkloMQ5NRt5abTZo+xmvxwav+jMe7ISf4ZTvxgd64zds3R52PKSo0hdSSevg2EzGQ6aTEbZqN1ITtlTO1HQLNUmRVhhRrogy1kmBeXpmabX5YbZZH7u46RwpL3fZMs0tq5XBfr9vLCKExWAwUAITNXUT33WZKUFHiWiLnaKQnTCVqMA+CCpZXLesp6kVzqG9FgQBVfX74o+KcDqb4XoesbKKYzvM53MWiyWGsb46XUN4XtwWzjbJsowwDBsRLeYqAU04nU6brv5h7Gt//S/0tXjqtIfDoXktt/ELAa9G78y6ljAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/50a19ac56732f90aa55f1d0ac63b0216/c5bb3/image.png\" srcset=\"/static/50a19ac56732f90aa55f1d0ac63b0216/04472/image.png 170w,\n/static/50a19ac56732f90aa55f1d0ac63b0216/9f933/image.png 340w,\n/static/50a19ac56732f90aa55f1d0ac63b0216/c5bb3/image.png 680w,\n/static/50a19ac56732f90aa55f1d0ac63b0216/b12f7/image.png 1020w,\n/static/50a19ac56732f90aa55f1d0ac63b0216/fbf76/image.png 1252w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>We can borrow a concept from the physical engineering world: the <a href=\"https://en.wikipedia.org/wiki/Dead_man&#x27;s_switch\" target=\"_blank\" rel=\"noopener noreferrer\">dead man's switch</a>.</p>\n<p>The idea revolves around ensuring that we can receive a signal to trigger an alarm at any unpredictable moment. To achieve this, we can flip the logic: instead of relying on a signal to activate the alarm, we can set it up so that the alarm goes off when we <strong>do not</strong> receive a signal. This approach is quite straightforward! This principle, often referred to as a <a href=\"https://en.wikipedia.org/wiki/Heartbeat_(computing)\" target=\"_blank\" rel=\"noopener noreferrer\">¬´heartbeat¬ª</a>, is used in various applications, including clustering, and is also employed in military contexts.</p>\n<p>In this scenario, if the operator (like Prometheus) goes offline or malfunctions, it will stop sending its \"OK\" response, which will then trigger an alert.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 74.11764705882352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQ0lEQVR42m1U227aQBDN/39EGymoalVVykOkPhRI4pZEbapETYH0zjU4Bl+xvbbX9p7ODoYY5JEGdndmz5yzs+ujolT4FozQ8wb45PXhSwEz8XHlDXHtD/EjnCOUaTV/wFf/N/QeJ43Q8/u48ge4C/7SGtiOJI0u/Fuc2gZOHQOrLMC/yMKrxSVOphfouUN4WYw3poHXjx9xtvwCvWcee2hNDbRmBs7MW+RFBci/ChBZCS/K4cYSXpzDCiREuslSapOcyhJlyensslCQudrFnwF1MgVykpJTUkGeka+TAr7IqYCEG20K1U1L13vqtgPMSEY9FOUZHCG4QJaX7I9eSswzrMKMwU0/46KVyH1AWQGqKvR5OUF7/pMzi4r52BYMahNbLX+d5OyNDOUBQ71hFUoELPn5bOum5cZZ2QwYS8lMtgecEKBTMWEnyU8kd7neuE3Fpk7C40bJ19YYlgh3EgWBaI+p05qpBl+Q3ITXCy6gzy8QRTPDICGGtf5rORGBuXSVLGJRl7xN0+caZ42Am4DaA9QyC7p3ihmXFAvTnNmNVoK7rfcEh03ZQrghsQlKZhUlBJYo+GHJYz8uIGjurklqqjbXhpjHseL4HqCW1o9GMJw+2tZ3LEWEWeShu9TzPu69GWyR0HyADya9XfsXs3yKQ3Qtev/OA+7XY5bPgPrCvl/doGV2cLJo84fhT2SitejgeNbBpd3nD8HxtIsXo3O8fezxFZtELl5OaG18jnfzG3qCB29ZqVrv66Zq/4c5DWv/AXL4ghnCpD3zAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/32118deec60cf303716385f78ccb8b2d/c5bb3/image-1.png\" srcset=\"/static/32118deec60cf303716385f78ccb8b2d/04472/image-1.png 170w,\n/static/32118deec60cf303716385f78ccb8b2d/9f933/image-1.png 340w,\n/static/32118deec60cf303716385f78ccb8b2d/c5bb3/image-1.png 680w,\n/static/32118deec60cf303716385f78ccb8b2d/b12f7/image-1.png 1020w,\n/static/32118deec60cf303716385f78ccb8b2d/b5a09/image-1.png 1360w,\n/static/32118deec60cf303716385f78ccb8b2d/51dd6/image-1.png 1952w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-why-do-we-need-it\" style=\"position:relative;\"><a href=\"#-why-do-we-need-it\" aria-label=\" why do we need it permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèó Why Do We Need It</h2>\n<p>Your monitoring solution is your bread and butter for knowing when you have issues with your infrastructure. But what happens if it has issues? Unless you are monitoring your system health dashboards 24/7, you will want to have some notification configured to let you know if your monitoring solution itself is experiencing issues.</p>\n<p>To do this, we'll want to create a rule that always triggers in Prometheus (think if <code class=\"language-text\">False == True</code>).</p>\n<h3 id=\"integrations\" style=\"position:relative;\"><a href=\"#integrations\" aria-label=\"integrations permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Integrations</h3>\n<p>Integrations help bring alerts from Dead Man's Snitch into the systems and services your team uses.</p>\n<p>Supported Integrations:</p>\n<ul>\n<li><a href=\"https://deadmanssnitch.com/docs/integrations/teams\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Teams</a></li>\n<li><a href=\"https://deadmanssnitch.com/docs/integrations/opsgenie\" target=\"_blank\" rel=\"noopener noreferrer\">Opsgenie</a></li>\n<li><a href=\"https://deadmanssnitch.com/docs/integrations/pagerduty\" target=\"_blank\" rel=\"noopener noreferrer\">PagerDuty</a></li>\n<li><a href=\"https://deadmanssnitch.com/docs/integrations/slack\" target=\"_blank\" rel=\"noopener noreferrer\">Slack</a></li>\n<li><a href=\"https://deadmanssnitch.com/docs/integrations/victor-ops\" target=\"_blank\" rel=\"noopener noreferrer\">VictorOps</a></li>\n<li><a href=\"https://deadmanssnitch.com/docs/integrations/webhooks\" target=\"_blank\" rel=\"noopener noreferrer\">Webhooks</a></li>\n</ul>\n<h2 id=\"hands-on\" style=\"position:relative;\"><a href=\"#hands-on\" aria-label=\"hands on permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Hands-On</h2>\n<p>To transform the concept of a dead man's switch into the Prometheus world, we need to:</p>\n<ol>\n<li><strong>Create a Prometheus alert</strong> that will fire regularly, like the train conductor pushing the button.</li>\n<li><strong>Configure the Alertmanager</strong> to send to another system outside our primary monitoring system.</li>\n<li><strong>Set up the outside system</strong> to take care of the alert and notify us if it doesn't receive the alert.</li>\n</ol>\n<p>In the following sections, we will go through each of these steps in detail.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 117.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAADfUlEQVR42q1VS4sjVRQeBEFm7ULUjS6EWbgRF/4Axb8guPKxcUDGhSAqKIPoQsGVDP4DXQiiM2Jnphv7kX4kpjGPqkrSSedRValKPW89U0lVJd/ce3vSdtOZpgUPnDp17z33u+ee75yqa7hUFo/06nKNPfI8x3g8BiEEnU4Hoiig1jhCs63iqKtRK0OQhlT7qNfrUFWV+5qmifl8fhEwTVM4jsMnPM+FOnIg7H+O0u+vorL2JvbvvoG/772G+ta76PcHCIKA+9q2zfeuBHRd99HUHBk91O58idHBS+gVX0Fz42UMizcgH76FLP83IgY4m80uArLJZYSLxYKnwPcJkokH01CgyF3EoQvingewLOvxgGxxKdPpFN1jGUPZgKIaGAx1yMqYjnWEYXzqx3J4JcDFPEfsSUj8GtxxCf32A/peRUSqND3R1SJkpy1lEtvorD+N8i9Pon7vOppr13H461PobTwBS13/71fOsyms3o8wu99Db38LRfwazuAOyPAOkmh0NVKWgCc1qUEfE6iaA8sOaBnZGOkOVUL9TGRZxn0ZkSvL5iwgY9myI9huDNsJYVoeJUhFGKV87JKEAubcl5XaJYAnOcyyFCPpNrT6e9AaN9Etv4Ne+W2MxZt0/AEM6UNaQublgGc7JUtn6O29DqnwDMTCc+huvkCL+kU07z8PYe1Z6KUb8MmA+xLyGECWE8ZyHMeIogjKUMJh+T4GxxWYmgBdFaApdUiNbXTaFd56SZLwIJb5PAfIhIH5vs+bvlSq0BQQxJMZ+gMV1ZoIQWyjcljja5IoQZIk+hERIcsyz/sFwLMShsHpycyZtyMfL+DSqFgnzWk1sHxneX4xQraBXTWZTJBSZ7EhwHNcTOgcizikNprOEFPyhFYLrh9gSoEm1JftWcmyqigY6hqEQQ+FnS38c9RCuV7DQamEg2IRhZ9/Qmt/F7t/3EWT2uNKGYYiQzeMc8ScAtpjA781q/iqWMB3uw/wzfaf+GF/A+xCdqMK4bOPUP70Flq3P0Hti49RuvU+RpvrCGcpZtNkBSBluWcZ2Bt0sNttY+e4hUrvCDlNR2Aa0Pa2aflsQt75CyP6Lm9tINRG8MMI6Zn244DsM27Rvgw8H6FLEBCP28g7Yd0LqKVVQKIYLgVwwhBORLvG8zhJK1lmk/MVevqzWix1ziLgumC66if1f8pD5GO7iblWma4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/5d08d7b2e5070900b428a4a74592580f/c5bb3/image-2.png\" srcset=\"/static/5d08d7b2e5070900b428a4a74592580f/04472/image-2.png 170w,\n/static/5d08d7b2e5070900b428a4a74592580f/9f933/image-2.png 340w,\n/static/5d08d7b2e5070900b428a4a74592580f/c5bb3/image-2.png 680w,\n/static/5d08d7b2e5070900b428a4a74592580f/b12f7/image-2.png 1020w,\n/static/5d08d7b2e5070900b428a4a74592580f/302a4/image-2.png 1080w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"setting-up-the-dead-mans-switch\" style=\"position:relative;\"><a href=\"#setting-up-the-dead-mans-switch\" aria-label=\"setting up the dead mans switch permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Setting Up the Dead Man's Switch</h3>\n<p>I will use the following services and tools:</p>\n<ul>\n<li><a href=\"https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack\" target=\"_blank\" rel=\"noopener noreferrer\">kube-prometheus-stack Helm chart</a> to deploy Prometheus and Alertmanager.</li>\n<li><a href=\"https://deadmanssnitch.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Dead Man's Snitch</a> to send the alerts to.</li>\n<li>A Kubernetes cluster to deploy onto. I will use Docker Desktop for Mac to deploy the services, but you can use any Kubernetes cluster you want.</li>\n</ul>\n<h4 id=\"sign-up-for-dead-mans-snitch\" style=\"position:relative;\"><a href=\"#sign-up-for-dead-mans-snitch\" aria-label=\"sign up for dead mans snitch permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Sign Up for Dead Man's Snitch</h4>\n<p>Dead Man's Snitch is a monitoring tool for cron, <a href=\"https://addons.heroku.com/scheduler\" target=\"_blank\" rel=\"noopener noreferrer\">Heroku Scheduler</a>, or any periodic process. Dead Man's Snitch will notify you when your scheduled tasks don't run so you can investigate before it becomes a problem.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 51.17647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAt0lEQVR42qWSyw7CIBBF+/+f4o+4dd9q2ZSHBbQ82rhortNpXBYjkpxAyHAyw0wzSIkjpFK49T26rkPbthBC8F3pTZPmjBJ3O0JpDWU0n2NOxfhmCzgk7TzDxKScUYwnisJEZJKs64rPynOuF0aSbVn5ECGMRU88QqDSqoWJM7pKjdP5wgzWYV4yQq2QpSR4vRYm/VfyTqDGTCkyobYp38bpZ6H1DtY5jM7y/GljaLcw9IfO+0PhGwcN/Q9d2Le7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Sign up page\" title=\"\" src=\"/static/9f2ef18bff3f1e2addf3fbbb63364baa/c5bb3/account.png\" srcset=\"/static/9f2ef18bff3f1e2addf3fbbb63364baa/04472/account.png 170w,\n/static/9f2ef18bff3f1e2addf3fbbb63364baa/9f933/account.png 340w,\n/static/9f2ef18bff3f1e2addf3fbbb63364baa/c5bb3/account.png 680w,\n/static/9f2ef18bff3f1e2addf3fbbb63364baa/b12f7/account.png 1020w,\n/static/9f2ef18bff3f1e2addf3fbbb63364baa/c1b63/account.png 1200w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>A Snitch looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">curl</span> https://nosnch.in/c2354d53d2</code></pre></div>\n<p>It's a unique URL we create for you to add to jobs you want to be monitored. If you want to add a Snitch to your backup cron job, it would look something like this:</p>\n<p>To create a snitch:</p>\n<ol>\n<li>Log in and click \"Create Your First Snitch\".</li>\n<li>Give your Snitch a name (Nightly Backup, Data Import, Monthly Invoice, etc.).</li>\n<li>Choose an interval. This is based on how often your task runs. If you have an hourly task, then choose hourly. If you have a task that runs every six hours, round up to Daily.</li>\n<li>Type in an email address that you would like to be alerted at should your task fail. If you leave this space blank, your Snitch alerts will be sent to the email you used to sign up with. Click \"Save\".</li>\n</ol>\n<p>The next page displays your unique Snitch URL in the blue box followed by examples of how your Snitch can be used. For each Snitch you create, a new URL will be created. Simply curl the unique Snitch URL after your task (as shown in the examples).</p>\n<p>To tell your Snitch to start checking, hit the URL. You can manually hit the URL by pasting your Snitch URL into a browser window and hitting return. Refresh the page. The box next to your Snitch should be green.</p>\n<p>That's it! If your process fails to run, Dead Man's Snitch will email you.</p>\n<p><img src=\"/abe81a46d267e9a529b9108aa856a662/snitch.gif\" alt=\"snitch\" loading=\"lazy\">\n          </p>\n<p>The next page displays your unique Snitch URL and methods for checking in your Snitch: cURL, <a href=\"https://deadmanssnitch.com/docs/field-agent\" target=\"_blank\" rel=\"noopener noreferrer\">Field Agent</a>, <a href=\"https://deadmanssnitch.com/blog/snitch-check-in-via-email\" target=\"_blank\" rel=\"noopener noreferrer\">email</a>, Ruby, and Python.</p>\n<p>To kick off the checking-in process for your Snitch, you'll send a request for the unique Snitch URL. The most common and basic method is using cURL and it would look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">run_backups_or_something.sh <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">curl</span> https://nosnch.in/c2354d53d2</code></pre></div>\n<p>For the purpose of the test Snitch, cURL only the Snitch URL in the terminal or paste the Snitch URL in your browser.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 54.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7ElEQVR42nWSyW7aUBSG71Ok21RMggA2XSAhVrwIuzTdFGyk0GYR5jxAum5eo0W46iaNAaXbRGrTQplthjCVQVXM33uvC1EaYunT+f/zn2PJ1iGhUAhujweiT4QoivAKXgiCAI/XQ/tu7Ln34Pf7EQgEuN+GIArYfb6L/Zf7ILFYDBEpClmWEaX1MH6I+Js45JiM15EIItEIJEmCJEtcb4PtHbw6wOm7U5BvN99Rb9Rx8/MHR+/p0LoaRae6yzH1vX+KttYBufx6iWKxiHK5zCmVStyrRXVTVVXFhXphevXes2w9f/7lHFfXVyDD4RCMwWCA0XBEMX2/38c6ux3cmvlotJkbj8cP5lidzWYgtVoNzWYTjUYD1WoVlUoF9Xqde6bXOcvYr6n9qvE+yzudDnq9Hn+ZpmmYTCYgHfrdLPgfXdfRbrf5IKPVaqHb7fI+82xmOp1isVhgPp9zlsslSDAYhN1uh9PphMvl4nWNy+mCw+Hg5+R74YPVaoXNZttgsVg4TD/b2UE4HAbJZNNIZzLInZxQcpxsLvtAJ1MppNJJJJIJzvE/EskkjhMJmqXw9ugI78/OQK7bn2HgDoaxwlOPYRhYrbbnd7T9h+4yftPTIfnCBxSUAkf5pDyCZwUTRVEeYe4q+JjP8xP6C0Nbmf6ReOREAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"test\" title=\"\" src=\"/static/1676add9d9cddbc23df8dbfb97b6656e/c5bb3/test.png\" srcset=\"/static/1676add9d9cddbc23df8dbfb97b6656e/04472/test.png 170w,\n/static/1676add9d9cddbc23df8dbfb97b6656e/9f933/test.png 340w,\n/static/1676add9d9cddbc23df8dbfb97b6656e/c5bb3/test.png 680w,\n/static/1676add9d9cddbc23df8dbfb97b6656e/b12f7/test.png 1020w,\n/static/1676add9d9cddbc23df8dbfb97b6656e/c1b63/test.png 1200w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>On the hour, every hour, Dead Man's Snitch looks to see if your Snitch checked in during the previous hour. Since you just checked in your Snitch manually, and our alert type is set to Basic, we won't check on your Snitch until the next full hour. For example, if you manually checked in your Snitch at 2:10 p.m., the next full hour it monitors doesn't start until the period of 3‚Äì4 p.m. This means we won't check for your Snitch until 4:01 p.m. Once you check-in, we will continue to monitor your Snitches on the hour, every hour.</p>\n<p>We'll keep watching your Snitch, expecting it to check in every hour. We'll alert you at the end of the expected interval if it doesn't check-in.</p>\n<h3 id=\"terraform-code\" style=\"position:relative;\"><a href=\"#terraform-code\" aria-label=\"terraform code permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Terraform Code</h3>\n<p>We can automate the creation of snitch. I have created a <a href=\"https://github.com/seifrajhi/Terraform-Dead-Mans-Snitch-module/tree/main\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform module</a> to automate it.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">required_providers</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">dmsnitch</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"plukevdh/dmsnitch\"</span>\n            <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"0.1.5\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">provider<span class=\"token type variable\"> \"dmsnitch\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">api_key</span> <span class=\"token punctuation\">=</span> var.dms_key\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"dmsnitch_snitch\"</span></span> <span class=\"token string\">\"dmsnitch\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> var.snitch_name\n    <span class=\"token property\">notes</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"DeadMan's Switch ensures proper functioning of k8s Alertmanager alerting pipeline\"</span>\n\n    <span class=\"token property\">interval</span> <span class=\"token punctuation\">=</span> var.snitch_interval\n    <span class=\"token property\">type</span> <span class=\"token punctuation\">=</span> var.snitch_type\n    <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> var.snitch_tags\n    <span class=\"token property\">alert_email</span> <span class=\"token punctuation\">=</span> var.snitch_emails\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To apply it, you can use your values:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">module<span class=\"token type variable\"> \"dmsnitch\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"git::https://github.com/seifrajhi/Terraform-Dead-Mans-Snitch-module.git?ref=v1.0.0\"</span>\n\n    <span class=\"token property\">snitch_name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"dms-demo-blog\"</span>\n    <span class=\"token property\">snitch_interval</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"5_minute\"</span>\n    <span class=\"token property\">snitch_type</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"basic\"</span>\n    <span class=\"token property\">snitch_tags</span>     <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"DMS\"</span>, <span class=\"token string\">\"demo\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token property\">snitch_emails</span>   <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"example@example.com\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"deploying-prometheus-and-alertmanager\" style=\"position:relative;\"><a href=\"#deploying-prometheus-and-alertmanager\" aria-label=\"deploying prometheus and alertmanager permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploying Prometheus and Alertmanager</h3>\n<p>I use the default values to deploy the <a href=\"https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack\" target=\"_blank\" rel=\"noopener noreferrer\">kube-prometheus-stack Helm chart</a>. The only thing I changed is setting the Alertmanager configuration to use the deadmanssnitch.com service when it receives it's not receiving an alert.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">alertmanager:\n    config:\n        receivers:\n            - name: <span class=\"token string\">'null'</span>\n            - name: deadman\n                webhook_configs:\n                    - url: <span class=\"token string\">\"https://nosnch.in/c2354d53d2\"</span>\n        route:\n            routes:\n                - match:\n                        alertname: Watchdog\n                    receiver: deadman\n                    group_wait: 0s\n                    group_interval: 1m\n                    repeat_interval: 50s\nprometheus-node-exporter:\n    hostRootFsMount:\n        enabled: <span class=\"token boolean\">false</span></code></pre></div>\n<p>Then run the following commands</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm repo <span class=\"token function\">add</span> prometheus-community https://prometheus-community.github.io/helm-charts\nhelm upgrade <span class=\"token parameter variable\">-i</span> monitoring prometheus-community/kube-prometheus-stack <span class=\"token parameter variable\">-f</span> values.yaml</code></pre></div>\n<p>The good thing about the kube-prometheus-stack Helm chart is that there is already a Prometheus alert configured that acts as a heartbeat. The alert is called Watchdog and here is the alert rule:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">alert</span><span class=\"token punctuation\">:</span> Watchdog\n                <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n                        This is an alert meant to ensure that the entire alerting pipeline is functional.\n                        This alert is always firing, therefore it should always be firing in Alertmanager\n                        and always fire against a receiver. There are integrations with various notification\n                        mechanisms that send a notification when this alert is not firing. For example the\n                        \"DeadMansSnitch\" integration in PagerDuty.</span>\n                    <span class=\"token key atrule\">runbook_url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//runbooks.prometheus<span class=\"token punctuation\">-</span>operator.dev/runbooks/general/watchdog\n                    <span class=\"token key atrule\">summary</span><span class=\"token punctuation\">:</span> An alert that should always be firing to certify that Alertmanager\n                        is working properly.\n                <span class=\"token key atrule\">expr</span><span class=\"token punctuation\">:</span> vector(1)\n                <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token key atrule\">severity</span><span class=\"token punctuation\">:</span> none</code></pre></div>\n<p>If everything went well, you should see the Watchdog alert firing in the Alertmanager dashboard.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 51.17647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/ElEQVR42nWSWQqEQAwFvf8p/RAVd3FfM1TgyeD0BKRNJ6m8RKNpmixJEqvr2u77tvM8rSgKy7LMxnE0jHsMP01Ty/Pc9n23kEXrujqEIgpI3rbNrusyYjTs+966rvOTvOM4PBYELsvyOLzP8+xAjEKUAOcELsV/FQpIEl2BCEgRvuLcc6pBEEgA6Ht0HgFk5HDPFNRp/B+FLLppmqd7WZa+y+8RMXw+lj4K9+TSWH5EByAaSXt7j0zj731XVWVxHHtcSnl8ZEYFKqAgxAQnzqhSPAyDtW3rtYqTGwHR7qQopJC4FJKv5gJyukJepETy375M/x9ggZTLPTv8AJLHENjSJLzgAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"logic\" title=\"\" src=\"/static/86e9cb03a086f37228e7ae5f631acc0c/c5bb3/logic.png\" srcset=\"/static/86e9cb03a086f37228e7ae5f631acc0c/04472/logic.png 170w,\n/static/86e9cb03a086f37228e7ae5f631acc0c/9f933/logic.png 340w,\n/static/86e9cb03a086f37228e7ae5f631acc0c/c5bb3/logic.png 680w,\n/static/86e9cb03a086f37228e7ae5f631acc0c/c1c45/logic.png 824w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"lets-break-it\" style=\"position:relative;\"><a href=\"#lets-break-it\" aria-label=\"lets break it permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Let's break it</h3>\n<p>Now that we have everything set up, let's break it and see what happens. For this, I will <strong>scale down the Alertmanager and the operator to 0</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl scale statefulset alertmanager-monitoring-kube-prometheus-alertmanager <span class=\"token parameter variable\">--replicas</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\nkubectl scale deployment monitoring-kube-prometheus-operator <span class=\"token parameter variable\">--replicas</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></code></pre></div>\n<p>Let's see what happens in the <strong>deadmanssnitch.com</strong> dashboard. We should see in the status column that the check is late. This means that the check didn't receive a ping in the last 2 minutes.</p>\n<p>To fix the problem, we need to scale up the Alertmanager and the operator again.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl scale statefulset alertmanager-monitoring-kube-prometheus-alertmanager <span class=\"token parameter variable\">--replicas</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\nkubectl scale deployment monitoring-kube-prometheus-operator <span class=\"token parameter variable\">--replicas</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></code></pre></div>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìë Conclusion</h2>\n<p>In this article, we learned how to create a dead man's switch implementation with Prometheus and Alertmanager. Of course, a dead man's switch is not a silver bullet, but it is an important part of a monitoring system and helps to build a more robust monitoring system.</p>\n<p>In the end, we need to make sure that our systems are up and running, and if they are not, which can happen more often than we think, we need to be notified as soon as possible. This means also when the monitoring system itself is not working.</p>\n<p><strong>References</strong></p>\n<ul>\n<li><a href=\"https://deadmanssnitch.com/docs/api/\" target=\"_blank\" rel=\"noopener noreferrer\">https://deadmanssnitch.com/docs/api/</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":7,"rawMarkdownBody":"\n> **Who Watches the Watchers and the Monitoring Stack? üëÆ**\n\n## üí¨ Introduction\n\nNowadays, monitoring systems play an important role in ensuring the smooth operation of critical infrastructure.\n\nHowever, what happens when the monitoring system itself falters? This is where the concept of a [dead man switch](https://deadmanssnitch.com/) comes into play.\n\nA dead man switch, in the context of monitoring, serves as an independent watchdog, tasked with keeping an eye on the monitoring system. If the monitoring system fails to provide [regular heartbeats](https://en.wikipedia.org/wiki/Heartbeat_(computing)) to the dead man switch, it triggers an alarm, alerting operators to a potential problem.\n\n## ü•Ö Objectives\n\nThis blog post is a deep dive into the implementation of a dead man switch for [Prometheus](https://prometheus.io/), a widely used monitoring tool. We'll explore the tools and techniques involved in setting up this guardian of the guardians, ensuring that our monitoring system remains vigilant and reliable.\n\nBy the end of this post, you'll have a clear understanding of how a dead man switch can safeguard your monitoring system and prevent blind spots in your infrastructure.\n\n![dms](./dms.png)\n\n## üìò Dead Man's Switch\n\nA monitoring system can be very simple, like a ping to a server IP, or it can be as complex as monitoring every component in a distributed system to ensure everything is working as expected. No matter how sophisticated the monitoring system is, we rely on them to ensure that our main system is in a healthy state. But what happens when your monitoring system fails? How do you know that your monitoring system is healthy?\n\nA frequent question I get asked when working with our DevOps teams is:\n\n> **Who is monitoring the monitoring system to make sure it's working?**\n\n![alt text](image.png)\n\nWe can borrow a concept from the physical engineering world: the [dead man's switch](https://en.wikipedia.org/wiki/Dead_man's_switch).\n\nThe idea revolves around ensuring that we can receive a signal to trigger an alarm at any unpredictable moment. To achieve this, we can flip the logic: instead of relying on a signal to activate the alarm, we can set it up so that the alarm goes off when we **do not** receive a signal. This approach is quite straightforward! This principle, often referred to as a [¬´heartbeat¬ª](https://en.wikipedia.org/wiki/Heartbeat_(computing)), is used in various applications, including clustering, and is also employed in military contexts.\n\nIn this scenario, if the operator (like Prometheus) goes offline or malfunctions, it will stop sending its \"OK\" response, which will then trigger an alert.\n\n![alt text](image-1.png)\n\n## üèó Why Do We Need It\n\nYour monitoring solution is your bread and butter for knowing when you have issues with your infrastructure. But what happens if it has issues? Unless you are monitoring your system health dashboards 24/7, you will want to have some notification configured to let you know if your monitoring solution itself is experiencing issues.\n\nTo do this, we'll want to create a rule that always triggers in Prometheus (think if `False == True`).\n\n### Integrations\n\nIntegrations help bring alerts from Dead Man's Snitch into the systems and services your team uses.\n\nSupported Integrations:\n\n* [Microsoft Teams](https://deadmanssnitch.com/docs/integrations/teams)\n* [Opsgenie](https://deadmanssnitch.com/docs/integrations/opsgenie)\n* [PagerDuty](https://deadmanssnitch.com/docs/integrations/pagerduty)\n* [Slack](https://deadmanssnitch.com/docs/integrations/slack)\n* [VictorOps](https://deadmanssnitch.com/docs/integrations/victor-ops)\n* [Webhooks](https://deadmanssnitch.com/docs/integrations/webhooks)\n\n## Hands-On\n\nTo transform the concept of a dead man's switch into the Prometheus world, we need to:\n\n1. **Create a Prometheus alert** that will fire regularly, like the train conductor pushing the button.\n2. **Configure the Alertmanager** to send to another system outside our primary monitoring system.\n3. **Set up the outside system** to take care of the alert and notify us if it doesn't receive the alert.\n\nIn the following sections, we will go through each of these steps in detail.\n\n![alt text](image-2.png)\n\n### Setting Up the Dead Man's Switch\n\nI will use the following services and tools:\n- [kube-prometheus-stack Helm chart](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack) to deploy Prometheus and Alertmanager.\n- [Dead Man's Snitch](https://deadmanssnitch.com/) to send the alerts to.\n- A Kubernetes cluster to deploy onto. I will use Docker Desktop for Mac to deploy the services, but you can use any Kubernetes cluster you want.\n\n#### Sign Up for Dead Man's Snitch\n\nDead Man's Snitch is a monitoring tool for cron, [Heroku Scheduler](https://addons.heroku.com/scheduler), or any periodic process. Dead Man's Snitch will notify you when your scheduled tasks don't run so you can investigate before it becomes a problem.\n\n![Sign up page](./account.png)\n\nA Snitch looks like this:\n\n```shell\n$ curl https://nosnch.in/c2354d53d2\n```\n\nIt's a unique URL we create for you to add to jobs you want to be monitored. If you want to add a Snitch to your backup cron job, it would look something like this:\n\nTo create a snitch:\n\n1. Log in and click \"Create Your First Snitch\".\n2. Give your Snitch a name (Nightly Backup, Data Import, Monthly Invoice, etc.).\n3. Choose an interval. This is based on how often your task runs. If you have an hourly task, then choose hourly. If you have a task that runs every six hours, round up to Daily.\n4. Type in an email address that you would like to be alerted at should your task fail. If you leave this space blank, your Snitch alerts will be sent to the email you used to sign up with. Click \"Save\".\n\nThe next page displays your unique Snitch URL in the blue box followed by examples of how your Snitch can be used. For each Snitch you create, a new URL will be created. Simply curl the unique Snitch URL after your task (as shown in the examples).\n\nTo tell your Snitch to start checking, hit the URL. You can manually hit the URL by pasting your Snitch URL into a browser window and hitting return. Refresh the page. The box next to your Snitch should be green.\n\nThat's it! If your process fails to run, Dead Man's Snitch will email you.\n\n![snitch](./snitch.gif)\n\nThe next page displays your unique Snitch URL and methods for checking in your Snitch: cURL, [Field Agent](https://deadmanssnitch.com/docs/field-agent), [email](https://deadmanssnitch.com/blog/snitch-check-in-via-email), Ruby, and Python.\n\nTo kick off the checking-in process for your Snitch, you'll send a request for the unique Snitch URL. The most common and basic method is using cURL and it would look something like this:\n\n```shell\nrun_backups_or_something.sh && curl https://nosnch.in/c2354d53d2\n```\n\nFor the purpose of the test Snitch, cURL only the Snitch URL in the terminal or paste the Snitch URL in your browser.\n\n![test](./test.png)\n\nOn the hour, every hour, Dead Man's Snitch looks to see if your Snitch checked in during the previous hour. Since you just checked in your Snitch manually, and our alert type is set to Basic, we won't check on your Snitch until the next full hour. For example, if you manually checked in your Snitch at 2:10 p.m., the next full hour it monitors doesn't start until the period of 3‚Äì4 p.m. This means we won't check for your Snitch until 4:01 p.m. Once you check-in, we will continue to monitor your Snitches on the hour, every hour.\n\nWe'll keep watching your Snitch, expecting it to check in every hour. We'll alert you at the end of the expected interval if it doesn't check-in.\n\n### Terraform Code\n\nWe can automate the creation of snitch. I have created a [Terraform module](https://github.com/seifrajhi/Terraform-Dead-Mans-Snitch-module/tree/main) to automate it.\n\n```hcl\nterraform {\n    required_providers {\n        dmsnitch = {\n            source = \"plukevdh/dmsnitch\"\n            version = \"0.1.5\"\n        }\n    }\n}\n\nprovider \"dmsnitch\" {\n    api_key = var.dms_key\n}\n\nresource \"dmsnitch_snitch\" \"dmsnitch\" {\n    name = var.snitch_name\n    notes = \"DeadMan's Switch ensures proper functioning of k8s Alertmanager alerting pipeline\"\n\n    interval = var.snitch_interval\n    type = var.snitch_type\n    tags = var.snitch_tags\n    alert_email = var.snitch_emails\n}\n```\n\nTo apply it, you can use your values:\n\n```hcl\nmodule \"dmsnitch\" {\n    source = \"git::https://github.com/seifrajhi/Terraform-Dead-Mans-Snitch-module.git?ref=v1.0.0\"\n\n    snitch_name     = \"dms-demo-blog\"\n    snitch_interval = \"5_minute\"\n    snitch_type     = \"basic\"\n    snitch_tags     = [\"DMS\", \"demo\"]\n    snitch_emails   = [\"example@example.com\"]\n}\n```\n\n### Deploying Prometheus and Alertmanager\n\nI use the default values to deploy the [kube-prometheus-stack Helm chart](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack). The only thing I changed is setting the Alertmanager configuration to use the deadmanssnitch.com service when it receives it's not receiving an alert.\n\n```shell\nalertmanager:\n    config:\n        receivers:\n            - name: 'null'\n            - name: deadman\n                webhook_configs:\n                    - url: \"https://nosnch.in/c2354d53d2\"\n        route:\n            routes:\n                - match:\n                        alertname: Watchdog\n                    receiver: deadman\n                    group_wait: 0s\n                    group_interval: 1m\n                    repeat_interval: 50s\nprometheus-node-exporter:\n    hostRootFsMount:\n        enabled: false\n```\n\nThen run the following commands\n\n```shell\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm upgrade -i monitoring prometheus-community/kube-prometheus-stack -f values.yaml\n```\n\nThe good thing about the kube-prometheus-stack Helm chart is that there is already a Prometheus alert configured that acts as a heartbeat. The alert is called Watchdog and here is the alert rule:\n\n```yaml\n- alert: Watchdog\n                annotations:\n                    description: |\n                        This is an alert meant to ensure that the entire alerting pipeline is functional.\n                        This alert is always firing, therefore it should always be firing in Alertmanager\n                        and always fire against a receiver. There are integrations with various notification\n                        mechanisms that send a notification when this alert is not firing. For example the\n                        \"DeadMansSnitch\" integration in PagerDuty.\n                    runbook_url: https://runbooks.prometheus-operator.dev/runbooks/general/watchdog\n                    summary: An alert that should always be firing to certify that Alertmanager\n                        is working properly.\n                expr: vector(1)\n                labels:\n                    severity: none\n```\n\nIf everything went well, you should see the Watchdog alert firing in the Alertmanager dashboard.\n\n![logic](./logic.png)\n\n### Let's break it\n\nNow that we have everything set up, let's break it and see what happens. For this, I will **scale down the Alertmanager and the operator to 0**.\n\n```shell\nkubectl scale statefulset alertmanager-monitoring-kube-prometheus-alertmanager --replicas=0\nkubectl scale deployment monitoring-kube-prometheus-operator --replicas=0\n```\n\nLet's see what happens in the **deadmanssnitch.com** dashboard. We should see in the status column that the check is late. This means that the check didn't receive a ping in the last 2 minutes.\n\nTo fix the problem, we need to scale up the Alertmanager and the operator again.\n\n```shell\nkubectl scale statefulset alertmanager-monitoring-kube-prometheus-alertmanager --replicas=1\nkubectl scale deployment monitoring-kube-prometheus-operator --replicas=1\n```\n\n## üìë Conclusion\n\nIn this article, we learned how to create a dead man's switch implementation with Prometheus and Alertmanager. Of course, a dead man's switch is not a silver bullet, but it is an important part of a monitoring system and helps to build a more robust monitoring system.\n\nIn the end, we need to make sure that our systems are up and running, and if they are not, which can happen more often than we think, we need to be notified as soon as possible. This means also when the monitoring system itself is not working.\n\n**References**\n\n* https://deadmanssnitch.com/docs/api/\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** [https://www.linkedin.com/in/rajhi-saif/](https://www.linkedin.com/in/rajhi-saif/)\n\n**‚ôªÔ∏è X/Twitter:** [https://x.com/rajhisaifeddine](https://x.com/rajhisaifeddine)\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1494},"frontmatter":{"id":"257db58436cf4c930e1c5c3e","path":"/blog/securing-monitoring-stack-dead-man-switch/","humanDate":"Oct 27, 2024","fullDate":"2024-10-27","title":"Never Get Caught Blind: Securing Your Monitoring Stack with a Dead Man Switch üëÄ","keywords":["Monitoring & Security","SRE","Dead Man Switch","Observability","Incident Response"],"excerpt":"How to enhance the security of your monitoring stack using a dead man switch, ensuring that your systems are always under watchful eyes.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFAv/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAGTgfRIqlf/xAAZEAADAAMAAAAAAAAAAAAAAAABAgMQERL/2gAIAQEAAQUCLnb9YQBjCCVFJKrf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAwADAQAAAAAAAAAAAAAAAAERAhAhkf/aAAgBAQAGPwJRlyeozt9If//EABoQAQEBAAMBAAAAAAAAAAAAAAERACFRcUH/2gAIAQEAAT8hohGS4LgL5oJ1ipPtyzhnWRg+b//aAAwDAQACAAMAAAAQOB//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPxBH/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/EK1//8QAHBABAQEAAgMBAAAAAAAAAAAAAREAIcExUXGB/9oACAEBAAE/EHilyLAPt3qMCo6wc2pyCd5sZaxM/Jny9JwdmrxAeHf/2Q=="},"images":{"fallback":{"src":"/static/bd2e4367c6d3b74929af61251ddc5cd6/7284f/switch-cover.jpg","srcSet":"/static/bd2e4367c6d3b74929af61251ddc5cd6/7284f/switch-cover.jpg 750w","sizes":"100vw"},"sources":[{"srcSet":"/static/bd2e4367c6d3b74929af61251ddc5cd6/57584/switch-cover.webp 750w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/eks-node-viewer-visualizing-node-usage/","title":"eks-node-viewer: A Tool for Visualizing Dynamic Node Usage in EKS Clusters¬†üöÄ","date":"2024-10-27 18:40:00"},"excerpt":"Optimizing AWS Kubernetes Cluster üîä Introduction EKS Node Viewer is a tool for visualizing dynamic node usage within a Kubernetes cluster‚Ä¶"},"nextThought":{"frontmatter":{"path":"/blog/victoriametrics-time-series-db-prometheus-k8s/","title":"VictoriaMetrics: A Guide, Comparing It to Prometheus, and Implementing Kubernetes Monitoring","date":"2024-10-27 18:06:00"},"excerpt":"A great Time-Series database for monitoring and analytics üîÜ üí¨ Introduction VictoriaMetrics is a time-series database designed for high‚Ä¶"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}