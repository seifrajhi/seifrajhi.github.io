{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/authenticate-apps-on-k8s-okta-istio-oauth2/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Secure authentication and authorization for Kubernetes apps üëÆ‚Äç‚ôÄ</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìë Introduction</h2>\n<p>Authenticating applications on Kubernetes can be a complex process, but integrating <a href=\"https://www.okta.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Okta</a>, <a href=\"https://istio.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio</a>, and <a href=\"https://github.com/oauth2-proxy/oauth2-proxy\" target=\"_blank\" rel=\"noopener noreferrer\">OAuth2-Proxy</a> provides a powerful solution.</p>\n<p>This guide will walk you through the steps to establish a robust and secure authentication framework for your Kubernetes-based applications.</p>\n<p>From using Istio for <a href=\"https://openid.net/\" target=\"_blank\" rel=\"noopener noreferrer\">OpenID Connect (OIDC)</a> authentication to leveraging OAuth2-Proxy for seamless interaction with identity providers like Okta, this integration allows you to enforce user authentication and authorization with confidence.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 71.17647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAklEQVR42oWSzW7TQBDH/Ua8BA/AI/AIHLj0jFB5gF6Q4ITKBakXhJpDFZWiQtQCTUCQlDYyUfyR2nETO7b3w/b+2V1/1JSEjjTa1X9nfzszOwaUCVEuLEa0+wCLnXugl10UUss4Q1EUWC6XmM/nCIJAr3Ecaz3P88aF5BglrwQWLIHz/CEm2/exGn5AJjVGiQ72fR+macKyLNi2raFZloFSCsYYOOd6r4GtJEEDF7FjQmQM/7OiENrbpsCG0tJcBlRnKht1UJt6mRDSeJoSiJzhbOjioDfG0fsuTk5PdazK2OAS1vklcOaWxFyKTKZeGyEUuexVAaFbU2c1Muf4+tOFPZ3C8/zmcWO4ENg6Ap7upyCpyiBFFEU6S9UTpZVg0jRf7TmnoIzomHY1xrELPPvM0emHa0uOBcfHzMUomsGfXSG4DrTuhg72Dvfwen8Xg0n/BsjlZXvqgFeQ28AJSfDit4NPgY2L4TmuPE/ry2SB7+NvGFz2YQXTG6BqierKpk9RvZMThiRNmvHaZBrYHpl6Jssecf1rCs4Yxype6X7VOs94dVbO4D9zeNvUJeVlVgJhGDYar9a2q8qUbQTW5f248DAYzTQ0L8SdZRvrYdUM0gyPtzt49OQd3nbPsfOqh5dvvsCahX89eiewHXzYM3FwPMZ1mMJyQwmLkBBexqzJ8A+QMzYNgoFPeAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"OIDC\" title=\"\" src=\"/static/96f4c0b9876573c4b6b927a49ec2ce44/c5bb3/oidc.png\" srcset=\"/static/96f4c0b9876573c4b6b927a49ec2ce44/04472/oidc.png 170w,\n/static/96f4c0b9876573c4b6b927a49ec2ce44/9f933/oidc.png 340w,\n/static/96f4c0b9876573c4b6b927a49ec2ce44/c5bb3/oidc.png 680w,\n/static/96f4c0b9876573c4b6b927a49ec2ce44/d0cc0/oidc.png 732w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"workflow-and-architecture-diagram\" style=\"position:relative;\"><a href=\"#workflow-and-architecture-diagram\" aria-label=\"workflow and architecture diagram permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Workflow and Architecture Diagram</h2>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABm0lEQVR42o1Sy3KjMBD0/9f+QK573l/JKS5wrV3GwUkw4iWEJJAQ6h1p144fSdVO1YAQUk93z6xwFd57zPMc87y21sZclgX34fEYqzNQCCkltrsdNkmCtq7R9wI7+j4ej9Ba3xT2/yC9Xy73L4DXBx2xKgTHvm/BygIVAYdCxpiY4ziia2oIIbD94DiUnBSYrwEjKEnTxoJPEziXBDChLBnSNMXLeo0sO0AOEkqPeK8VikZGa24Ar/1xtGx7jcU52DmwBmbaVHLEIDSxcZiDknAnvOnf7O4kGzNRRQUuO+hqQLFm+PH0jPR3CcZK6NGiahny0yu01FBbhqwYkWQVJNlj509Cq+DbMAzRB+MMxEeL06bEz18bbPcNqopFBi1vkBevUL1CkxwJXONwEpi0pLvLLUNH8qJ0om/Jj2l2UaqxHobWQaYQirouEZRaeiwxfSzmFjw2JTBt2xbZPqMGbPD29o6m4cjzHEmSxmYopT7Hxv/1934eH7tMp8J4dCStqht0XXcZ9Ot5+y5WX20GOaeqj+PCGPsvoDPgH2UNVuaNM6l8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Workflow\" title=\"\" src=\"/static/73cc4e8079a0f7f1382ba4c99b5d4357/c5bb3/workflow.png\" srcset=\"/static/73cc4e8079a0f7f1382ba4c99b5d4357/04472/workflow.png 170w,\n/static/73cc4e8079a0f7f1382ba4c99b5d4357/9f933/workflow.png 340w,\n/static/73cc4e8079a0f7f1382ba4c99b5d4357/c5bb3/workflow.png 680w,\n/static/73cc4e8079a0f7f1382ba4c99b5d4357/b12f7/workflow.png 1020w,\n/static/73cc4e8079a0f7f1382ba4c99b5d4357/d8817/workflow.png 1238w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<ol>\n<li>An employee tries to access an internal application (e.g., admin-service).</li>\n<li>The employee connects to the application URL, and the request is sent to the Istio service mesh inside our Kubernetes cluster.</li>\n<li>The request arrives via the <a href=\"https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio Ingress Gateway</a>.</li>\n<li>We have an Istio authorization policy that limits access to the admin service.</li>\n<li>The authorization policy points to the custom extension provider, OAuth2-Proxy. OAuth2-Proxy is set up to connect with our identity provider, Okta.</li>\n<li>When the user is authenticated successfully with our IdP, OAuth2-Proxy gets a JWT back and looks into the \"groups\" claim. This will be evaluated against any groups we have configured, let's say \"admins\". If the \"admins\" group is found in the JWT groups claim, OAuth2-Proxy puts the token into a cookie and sends it back to the requesting client‚Ää‚Äî‚Ääour user.</li>\n<li>The employee's request is redirected to Okta for login. On successful authentication, it passes through the Istio authorization policy and connects with the admin service.</li>\n<li>The user will now be forwarded to the actual application. If the application supports it (e.g., <a href=\"https://grafana.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Grafana</a>), we can configure the application to look into the headers we inject with OAuth2-Proxy. This allows us to set, for example, the <code class=\"language-text\">preferred_username</code> or <code class=\"language-text\">email</code> attributes in the application - info we get from the ID token claims.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 63.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdklEQVR42nWS627CMAyFef/34x8ImEaB3tI0bXMP+5psFWibVVmJ6+Nz7Hgn+uBcijHEGJVav+e7KeXb1sQcHqVrGmNMqmttbdoZE5fF1HU9jsqYYO2aRSHnXAiBs3ORnFLI+8SZQkavfpdS2kgIUFYIcT6f9/v98Xjsum5ZFu/9llPyi9+hVykFQEpprfM+hBg4N02Dh5/IK0GKL2Bn3ZiN1HmeSR2GAeTj8aAitIinqP2x0ss32GjTZgMgxFDypmlCMFVg3gCF9o35VdIz0fZ6JRsVIPlLX/BXVXW5XPq+j69g7zw93+/30+l0u90gJANPI8jWmrEmChHkSvANzHzQ/JGN1wp5YEglD0Lmj4oCeJt2/Ed2eWTmBy1/h0EiRI7yT/B6L8adISFkE8/Mr9dPVGT+dVybX8GsAG8ZsnGeZ6v10mRj7ZjF4XCqqoZGvHfTpKVctKYpvW6YEKHsD8Qs9vRrt5c5DsKX5iblRWetSV1LtfQFfb7y/E97Ij0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"States\" title=\"\" src=\"/static/abc397bd0035b68786a7ed9ee85730e0/c5bb3/states.png\" srcset=\"/static/abc397bd0035b68786a7ed9ee85730e0/04472/states.png 170w,\n/static/abc397bd0035b68786a7ed9ee85730e0/9f933/states.png 340w,\n/static/abc397bd0035b68786a7ed9ee85730e0/c5bb3/states.png 680w,\n/static/abc397bd0035b68786a7ed9ee85730e0/72aae/states.png 964w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"technologies-used\" style=\"position:relative;\"><a href=\"#technologies-used\" aria-label=\"technologies used permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Technologies Used</h3>\n<ul>\n<li><img src=\"https://img.icons8.com/color/48/000000/amazon-web-services.png\" alt=\"AWS EKS\" loading=\"lazy\">\n           AWS EKS Kubernetes</li>\n<li><img src=\"https://img.icons8.com/color/48/000000/istio.png\" alt=\"Istio\" loading=\"lazy\">\n           Istio</li>\n<li><img src=\"https://img.icons8.com/color/48/000000/oauth.png\" alt=\"OAuth2-Proxy\" loading=\"lazy\">\n           OAuth2-Proxy</li>\n<li><img src=\"https://img.icons8.com/color/48/000000/helm.png\" alt=\"Helm\" loading=\"lazy\">\n           Helm</li>\n<li><img src=\"https://img.icons8.com/color/48/000000/okta.png\" alt=\"Okta\" loading=\"lazy\">\n           Okta</li>\n<li><img src=\"https://img.icons8.com/color/48/000000/grafana.png\" alt=\"Grafana\" loading=\"lazy\">\n           <a href=\"https://grafana.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Grafana</a></li>\n</ul>\n<h2 id=\"setup-okta-application-for-oauth2-proxy\" style=\"position:relative;\"><a href=\"#setup-okta-application-for-oauth2-proxy\" aria-label=\"setup okta application for oauth2 proxy permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Setup Okta Application for OAuth2-Proxy</h2>\n<p>This Okta application will allow for access management to your application.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA00lEQVR42nWRbYvDIBCE8/9/Y/uhF8jRpDZe1FXXl7ndHKXtlQwsgg6PzjhM04RxHNFaQ+/9Y1JK8CEgxoicGcyMWqus5W30TP3Duq4gIqge0FcVMSeBqYcogATOOeNIg7UW27YdArk3LOQRPOF0nnD+uuB7uYn3AGjMHcvNQDG1fgKJEuwmwEBwXuLLaz1FWOskZoZzDt77vYa/F/5EXGeLxECUJLX9B7L0xyhFe0p7fAVpBY9Vp9ayJxy07Hme5abnLa/SPe3ZGLN/0JG4dPF2/AL2vdYBEuM0OQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"okta-app\" title=\"\" src=\"/static/c3160ec5d169f1db1695c053e89fbb6d/c5bb3/okta-app.png\" srcset=\"/static/c3160ec5d169f1db1695c053e89fbb6d/04472/okta-app.png 170w,\n/static/c3160ec5d169f1db1695c053e89fbb6d/9f933/okta-app.png 340w,\n/static/c3160ec5d169f1db1695c053e89fbb6d/c5bb3/okta-app.png 680w,\n/static/c3160ec5d169f1db1695c053e89fbb6d/b12f7/okta-app.png 1020w,\n/static/c3160ec5d169f1db1695c053e89fbb6d/b5a09/okta-app.png 1360w,\n/static/c3160ec5d169f1db1695c053e89fbb6d/2cefc/okta-app.png 1400w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVR42p2UiXKDMAxE/f8/mU6OgYQrYGwug5Ln1CklTErKjIAR8kparVB1XUsURXI+n+V4PEpZlvLpNY4ieemk6ydRxhiJ41gul4sHrarqY8BpEqnNKIObAVKl1vo7YJL/Xspa6ysDNE3TlwqHYfA04O+67plwzcZ774obhzDnnHcuAYuikOv1KiTnO3Ehdmm+QvjLsuzXQELb+j40c4/Z3HLbtr4CgNe447vWlRhjBb6Jw0L7L4B933t+mqZZDbC2lSguJElQwUMJeZ77RKuAWzSWFbWcTic5HA6eHnhdG84T8C+ZWGtkt/vy1SVJ4g1gVBF80AaO2kI0nO33e3+Qwb0rQP209hj7mr6QCFzDGzaXyTJWscvwE7KuAb5fuwVg0CFrBzhGRfPKUQB+YsI7hoyWi6DQUwhGPjzngEyULUH4YTV5Rzo8SeAcmzZJP2wYCgnpgIEAwFQDOD5+KlmWim2cVHqUG4Jn5erocHhhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"app-settings\" title=\"\" src=\"/static/05b1c4f7527e2e525028b7b8d31163b7/c5bb3/app-settings.png\" srcset=\"/static/05b1c4f7527e2e525028b7b8d31163b7/04472/app-settings.png 170w,\n/static/05b1c4f7527e2e525028b7b8d31163b7/9f933/app-settings.png 340w,\n/static/05b1c4f7527e2e525028b7b8d31163b7/c5bb3/app-settings.png 680w,\n/static/05b1c4f7527e2e525028b7b8d31163b7/b12f7/app-settings.png 1020w,\n/static/05b1c4f7527e2e525028b7b8d31163b7/b5a09/app-settings.png 1360w,\n/static/05b1c4f7527e2e525028b7b8d31163b7/2cefc/app-settings.png 1400w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Be sure to include the URL of your internal application as the sign-in redirect URI in Okta. This allows Okta to redirect to your internal app after authenticating an employee.</p>\n<p>You can also add other internal app URLs to this application. However, be aware that any Okta users or groups added to this Okta application will be able to access every internal application URL listed.</p>\n<p>If you need to control access to an application for specific groups, such as allowing only the finance team to access an application, you will need to create a separate OAuth2-Proxy app in Okta for each application you want to customize access to.</p>\n<h3 id=\"deploy-oauth2-proxy-to-kubernetes\" style=\"position:relative;\"><a href=\"#deploy-oauth2-proxy-to-kubernetes\" aria-label=\"deploy oauth2 proxy to kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy OAuth2-Proxy to Kubernetes</h3>\n<p>OAuth2-Proxy is an open-source software handling the authentication flow needed for OAuth2 or in this case OIDC. This will handle the authentication flow and pass the needed token back to the application.</p>\n<p>Install by replacing <code class=\"language-text\">oauth2-proxy-values.yaml</code> with your value then apply with:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm repo <span class=\"token function\">add</span> oauth2-proxy https://oauth2-proxy.github.io/manifests\nhelm repo update\nhelm <span class=\"token function\">install</span> <span class=\"token parameter variable\">--values</span> oauth2-proxy-values.yaml oauth2-proxy oauth2-proxy/oauth2-proxy</code></pre></div>\n<p>Where <code class=\"language-text\">oauth2-proxy-values.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">clientID</span><span class=\"token punctuation\">:</span> xx\n  <span class=\"token key atrule\">clientSecret</span><span class=\"token punctuation\">:</span> xx\n  <span class=\"token key atrule\">cookieSecret</span><span class=\"token punctuation\">:</span> xx\n  <span class=\"token key atrule\">configFile</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token key atrule\">extraArgs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span> oidc\n  <span class=\"token key atrule\">cookie-secure</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">cookie-samesite</span><span class=\"token punctuation\">:</span> lax\n  <span class=\"token key atrule\">cookie-refresh</span><span class=\"token punctuation\">:</span> 1h\n  <span class=\"token key atrule\">cookie-expire</span><span class=\"token punctuation\">:</span> 4h\n  <span class=\"token key atrule\">cookie-name</span><span class=\"token punctuation\">:</span> _oauth2_proxy_istio_ingressgateway\n  <span class=\"token key atrule\">set-authorization-header</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">email-domain</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span>\n  <span class=\"token key atrule\">http-address</span><span class=\"token punctuation\">:</span> 0.0.0.0<span class=\"token punctuation\">:</span><span class=\"token number\">4180</span>\n  <span class=\"token key atrule\">upstream</span><span class=\"token punctuation\">:</span> static<span class=\"token punctuation\">:</span>//200\n  <span class=\"token key atrule\">skip-provider-button</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">oidc-issuer-url</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values <span class=\"token punctuation\">|</span> get \"charts.oauth2<span class=\"token punctuation\">-</span>proxy.issuer\" \"https<span class=\"token punctuation\">:</span>//your<span class=\"token punctuation\">-</span>okta.com\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">portNumber</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4180</span>\n\n<span class=\"token key atrule\">serviceAccount</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 100m\n    <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 300Mi\n  <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 100m\n    <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 300Mi\n\n<span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n<span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n<span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Enable Prometheus metrics endpoint</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token key atrule\">replicaCount</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n\n<span class=\"token key atrule\">podDisruptionBudget</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">minAvailable</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n<span class=\"token key atrule\">topologySpreadConstraints</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">maxSkew</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> topology.kubernetes.io/zone\n    <span class=\"token key atrule\">whenUnsatisfiable</span><span class=\"token punctuation\">:</span> ScheduleAnyway\n    <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app.kubernetes.io/instance</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Release.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"add-oauth2-proxy-as-an-extension-provider-in-istio\" style=\"position:relative;\"><a href=\"#add-oauth2-proxy-as-an-extension-provider-in-istio\" aria-label=\"add oauth2 proxy as an extension provider in istio permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Add OAuth2-Proxy as an Extension Provider in Istio</h3>\n<p>Inside your Istio mesh config, you will need to add an <a href=\"https://istio.io/latest/docs/tasks/security/authorization/authz-custom/#define-the-external-authorizer\" target=\"_blank\" rel=\"noopener noreferrer\">extension provider</a>. This will reference the OAuth2-Proxy deployment and will allow us to use OAuth2-Proxy as a CUSTOM action in our Istio Authorization Policy.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">meshConfig</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">extensionProviders</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oauth2<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">envoyExtAuthzHttp</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> oauth2<span class=\"token punctuation\">-</span>proxy.oauth2<span class=\"token punctuation\">-</span>proxy.svc.cluster.local\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4180</span>\n      <span class=\"token key atrule\">headersToDownstreamOnDeny</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> content<span class=\"token punctuation\">-</span>type\n      <span class=\"token punctuation\">-</span> set<span class=\"token punctuation\">-</span>cookie\n      <span class=\"token key atrule\">headersToUpstreamOnAllow</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> authorization\n      <span class=\"token punctuation\">-</span> path\n      <span class=\"token punctuation\">-</span> x<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>request<span class=\"token punctuation\">-</span>user\n      <span class=\"token punctuation\">-</span> x<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>request<span class=\"token punctuation\">-</span>email\n      <span class=\"token punctuation\">-</span> x<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>request<span class=\"token punctuation\">-</span>access<span class=\"token punctuation\">-</span>token\n      <span class=\"token key atrule\">includeHeadersInCheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> authorization\n      <span class=\"token punctuation\">-</span> cookie\n  <span class=\"token key atrule\">defaultConfig</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">terminationDrainDuration</span><span class=\"token punctuation\">:</span> 310s</code></pre></div>\n<p>This config is creating a new provider with the name <code class=\"language-text\">oauth2-proxy</code>. This can later be used in the authorization-policy to route requests through the OAuth2-Proxy. The rest of this config is basically what headers to include to make sure the correct tokens are passed along.</p>\n<h3 id=\"Ô∏è-add-istio-authorization-policy\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-add-istio-authorization-policy\" aria-label=\"Ô∏è add istio authorization policy permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Add Istio Authorization Policy</h3>\n<p>Finally, apply the authorization policy to tell Istio what requests should be routed through the OAuth2-Proxy. This CUSTOM authorization policy allows us to restrict access to the host specified and authenticate via Okta and the OAuth2-Proxy. See the <a href=\"https://istio.io/latest/docs/tasks/security/authorization/authz-custom/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio reference document</a> for more info.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> security.istio.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AuthorizationPolicy\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oauth<span class=\"token punctuation\">-</span>policy\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> istio<span class=\"token punctuation\">-</span>system\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">istio</span><span class=\"token punctuation\">:</span> ingressgateway\n  <span class=\"token key atrule\">action</span><span class=\"token punctuation\">:</span> CUSTOM\n  <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"oauth2-proxy\"</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">operation</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> &lt;INTERNAL APPLICATION HOST<span class=\"token punctuation\">></span></code></pre></div>\n<p>The most important part of this config is the provider name which has to match the provider created in the <code class=\"language-text\">meshConfig</code> part of the <code class=\"language-text\">istio-controlplane.yaml</code> and the hosts list which is the host names that the policy applies to.</p>\n<p>Apply by replacing <code class=\"language-text\">&lt;INTERNAL APPLICATION HOST></code> with your app URL in <code class=\"language-text\">authorization-policy.yaml</code> then run:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> authorization-policy.yaml</code></pre></div>\n<h3 id=\"-authentication-and-authorization\" style=\"position:relative;\"><a href=\"#-authentication-and-authorization\" aria-label=\" authentication and authorization permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Authentication and Authorization</h3>\n<p>If you have made it this far, you have probably heard of authentication vs authorization before. I just want to make it clear that this use case of Istio is only used for authentication. Istio will route to the authentication service and if a valid token is presented, it will pass you on to the application. This provides some security for all the applications, but the application will still have to be responsible for authorization and any form of RBAC.</p>\n<h2 id=\"-final-notes\" style=\"position:relative;\"><a href=\"#-final-notes\" aria-label=\" final notes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üñã Final Notes</h2>\n<p>This blog post aims to provide a clear understanding of how to use Istio and OAuth2-Proxy for authentication in Kubernetes applications. By following the steps outlined in the guide, you can ensure that your applications are secure and that user authentication and authorization are enforced with confidence.</p>\n<p>The integration of Okta, Istio, and OAuth2-Proxy allows you to leverage the power of these tools to create a robust and secure authentication framework for your Kubernetes-based applications.</p>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://istio.io/latest/docs/tasks/security/authorization/authz-custom/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio: External Authorization</a></li>\n<li><a href=\"https://oauth2-proxy.github.io/oauth2-proxy/\" target=\"_blank\" rel=\"noopener noreferrer\">Welcome to OAuth2 Proxy | OAuth2 Proxy</a></li>\n<li><a href=\"https://events.istio.io/istiocon-2021/slides/d8p-DeepDiveAuthPolicies-LawrenceGadban.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Deep Dive Auth Policies - Lawrence Gadban</a></li>\n<li><a href=\"https://oauth2-proxy.github.io/oauth2-proxy/configuration/alpha-config\" target=\"_blank\" rel=\"noopener noreferrer\">Alpha Configuration | OAuth2 Proxy</a></li>\n<li><a href=\"https://developers.onelogin.com/openid-connect/scopes\" target=\"_blank\" rel=\"noopener noreferrer\">OpenId Connect Scopes</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/apn/saas-identity-and-routing-with-istio-service-mesh-and-amazon-eks/\" target=\"_blank\" rel=\"noopener noreferrer\">SaaS Identity and Routing with Istio Service Mesh and Amazon EKS | Amazon Web Services</a></li>\n<li><a href=\"https://venafi.com/blog/istio-oidc/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio OIDC Authentication | Jetstack Blog</a></li>\n<li><a href=\"https://elastisys.com/istio-and-oauth2-proxy-in-kubernetes-for-microservice-authentication/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio and OAuth2-Proxy in Kubernetes for Microservice Authentication</a></li>\n<li>Alternative to OAuth2-Proxy: <a href=\"https://github.com/istio-ecosystem/authservice\" target=\"_blank\" rel=\"noopener noreferrer\">Authservice</a></li>\n<li>Alternative to OAuth2-Proxy: <a href=\"http://openpolicyagent.org\" target=\"_blank\" rel=\"noopener noreferrer\">Open Policy Agent</a></li>\n</ul>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâüáµüá∏</em></strong></p>\n<p><br><br></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":5,"rawMarkdownBody":"\n> **Secure authentication and authorization for Kubernetes apps üëÆ‚Äç‚ôÄ**\n\n## üìë Introduction\n\nAuthenticating applications on Kubernetes can be a complex process, but integrating [Okta](https://www.okta.com/), [Istio](https://istio.io/), and [OAuth2-Proxy](https://github.com/oauth2-proxy/oauth2-proxy) provides a powerful solution.\n\nThis guide will walk you through the steps to establish a robust and secure authentication framework for your Kubernetes-based applications.\n\nFrom using Istio for [OpenID Connect (OIDC)](https://openid.net/) authentication to leveraging OAuth2-Proxy for seamless interaction with identity providers like Okta, this integration allows you to enforce user authentication and authorization with confidence.\n\n![OIDC](./oidc.png)\n\n## Workflow and Architecture Diagram\n\n![Workflow](./workflow.png)\n\n1. An employee tries to access an internal application (e.g., admin-service).\n2. The employee connects to the application URL, and the request is sent to the Istio service mesh inside our Kubernetes cluster.\n3. The request arrives via the [Istio Ingress Gateway](https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/).\n4. We have an Istio authorization policy that limits access to the admin service.\n5. The authorization policy points to the custom extension provider, OAuth2-Proxy. OAuth2-Proxy is set up to connect with our identity provider, Okta.\n6. When the user is authenticated successfully with our IdP, OAuth2-Proxy gets a JWT back and looks into the \"groups\" claim. This will be evaluated against any groups we have configured, let's say \"admins\". If the \"admins\" group is found in the JWT groups claim, OAuth2-Proxy puts the token into a cookie and sends it back to the requesting client‚Ää‚Äî‚Ääour user.\n7. The employee's request is redirected to Okta for login. On successful authentication, it passes through the Istio authorization policy and connects with the admin service.\n8. The user will now be forwarded to the actual application. If the application supports it (e.g., [Grafana](https://grafana.com/)), we can configure the application to look into the headers we inject with OAuth2-Proxy. This allows us to set, for example, the `preferred_username` or `email` attributes in the application - info we get from the ID token claims.\n\n![States](./states.png)\n\n### Technologies Used\n\n- ![AWS EKS](https://img.icons8.com/color/48/000000/amazon-web-services.png) AWS EKS Kubernetes\n- ![Istio](https://img.icons8.com/color/48/000000/istio.png) Istio\n- ![OAuth2-Proxy](https://img.icons8.com/color/48/000000/oauth.png) OAuth2-Proxy\n- ![Helm](https://img.icons8.com/color/48/000000/helm.png) Helm\n- ![Okta](https://img.icons8.com/color/48/000000/okta.png) Okta\n- ![Grafana](https://img.icons8.com/color/48/000000/grafana.png) [Grafana](https://grafana.com/)\n\n## Setup Okta Application for OAuth2-Proxy\n\nThis Okta application will allow for access management to your application.\n\n![okta-app](./okta-app.png)\n\n![app-settings](./app-settings.png)\n\nBe sure to include the URL of your internal application as the sign-in redirect URI in Okta. This allows Okta to redirect to your internal app after authenticating an employee.\n\nYou can also add other internal app URLs to this application. However, be aware that any Okta users or groups added to this Okta application will be able to access every internal application URL listed.\n\nIf you need to control access to an application for specific groups, such as allowing only the finance team to access an application, you will need to create a separate OAuth2-Proxy app in Okta for each application you want to customize access to.\n\n### Deploy OAuth2-Proxy to Kubernetes\n\nOAuth2-Proxy is an open-source software handling the authentication flow needed for OAuth2 or in this case OIDC. This will handle the authentication flow and pass the needed token back to the application.\n\nInstall by replacing `oauth2-proxy-values.yaml` with your value then apply with:\n\n```shell\nhelm repo add oauth2-proxy https://oauth2-proxy.github.io/manifests\nhelm repo update\nhelm install --values oauth2-proxy-values.yaml oauth2-proxy oauth2-proxy/oauth2-proxy\n```\n\nWhere `oauth2-proxy-values.yaml`:\n\n```yaml\nconfig:\n  clientID: xx\n  clientSecret: xx\n  cookieSecret: xx\n  configFile: false\n\nextraArgs:\n  provider: oidc\n  cookie-secure: true\n  cookie-samesite: lax\n  cookie-refresh: 1h\n  cookie-expire: 4h\n  cookie-name: _oauth2_proxy_istio_ingressgateway\n  set-authorization-header: true\n  email-domain: \"*\"\n  http-address: 0.0.0.0:4180\n  upstream: static://200\n  skip-provider-button: true\n  oidc-issuer-url: {{ .Values | get \"charts.oauth2-proxy.issuer\" \"https://your-okta.com\" }}\nservice:\n  portNumber: 4180\n\nserviceAccount:\n  enabled: false\n\nresources:\n  limits:\n    cpu: 100m\n    memory: 300Mi\n  requests:\n    cpu: 100m\n    memory: 300Mi\n\nlivenessProbe:\n  enabled: true\n  initialDelaySeconds: 0\n  timeoutSeconds: 1\n\nreadinessProbe:\n  enabled: true\n  initialDelaySeconds: 0\n  timeoutSeconds: 1\n  periodSeconds: 10\n  successThreshold: 1\n\nmetrics:\n  # Enable Prometheus metrics endpoint\n  enabled: false\n\nreplicaCount: 2\n\npodDisruptionBudget:\n  enabled: true\n  minAvailable: 1\n\ntopologySpreadConstraints:\n  - maxSkew: 1\n    topologyKey: topology.kubernetes.io/zone\n    whenUnsatisfiable: ScheduleAnyway\n    labelSelector:\n      matchLabels:\n        app.kubernetes.io/instance: {{ .Release.Name }}\n```\n\n### Add OAuth2-Proxy as an Extension Provider in Istio\n\nInside your Istio mesh config, you will need to add an [extension provider](https://istio.io/latest/docs/tasks/security/authorization/authz-custom/#define-the-external-authorizer). This will reference the OAuth2-Proxy deployment and will allow us to use OAuth2-Proxy as a CUSTOM action in our Istio Authorization Policy.\n\n```yaml\nmeshConfig:\n  extensionProviders:\n  - name: oauth2-proxy\n    envoyExtAuthzHttp:\n      service: oauth2-proxy.oauth2-proxy.svc.cluster.local\n      port: 4180\n      headersToDownstreamOnDeny:\n      - content-type\n      - set-cookie\n      headersToUpstreamOnAllow:\n      - authorization\n      - path\n      - x-auth-request-user\n      - x-auth-request-email\n      - x-auth-request-access-token\n      includeHeadersInCheck:\n      - authorization\n      - cookie\n  defaultConfig:\n    terminationDrainDuration: 310s\n```\n\nThis config is creating a new provider with the name `oauth2-proxy`. This can later be used in the authorization-policy to route requests through the OAuth2-Proxy. The rest of this config is basically what headers to include to make sure the correct tokens are passed along.\n\n### üõ°Ô∏è Add Istio Authorization Policy\n\nFinally, apply the authorization policy to tell Istio what requests should be routed through the OAuth2-Proxy. This CUSTOM authorization policy allows us to restrict access to the host specified and authenticate via Okta and the OAuth2-Proxy. See the [Istio reference document](https://istio.io/latest/docs/tasks/security/authorization/authz-custom/) for more info.\n\n```yaml\napiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: oauth-policy\n  namespace: istio-system\nspec:\n  selector:\n    matchLabels:\n      istio: ingressgateway\n  action: CUSTOM\n  provider:\n    name: \"oauth2-proxy\"\n  rules:\n  - to:\n    - operation:\n        hosts:\n          - <INTERNAL APPLICATION HOST>\n```\n\nThe most important part of this config is the provider name which has to match the provider created in the `meshConfig` part of the `istio-controlplane.yaml` and the hosts list which is the host names that the policy applies to.\n\nApply by replacing `<INTERNAL APPLICATION HOST>` with your app URL in `authorization-policy.yaml` then run:\n\n```shell\nkubectl apply -f authorization-policy.yaml\n```\n\n### üîê Authentication and Authorization\n\nIf you have made it this far, you have probably heard of authentication vs authorization before. I just want to make it clear that this use case of Istio is only used for authentication. Istio will route to the authentication service and if a valid token is presented, it will pass you on to the application. This provides some security for all the applications, but the application will still have to be responsible for authorization and any form of RBAC.\n\n## üñã Final Notes\n\nThis blog post aims to provide a clear understanding of how to use Istio and OAuth2-Proxy for authentication in Kubernetes applications. By following the steps outlined in the guide, you can ensure that your applications are secure and that user authentication and authorization are enforced with confidence.\n\nThe integration of Okta, Istio, and OAuth2-Proxy allows you to leverage the power of these tools to create a robust and secure authentication framework for your Kubernetes-based applications.\n\n**References:**\n\n- [Istio: External Authorization](https://istio.io/latest/docs/tasks/security/authorization/authz-custom/)\n- [Welcome to OAuth2 Proxy | OAuth2 Proxy](https://oauth2-proxy.github.io/oauth2-proxy/)\n- [Deep Dive Auth Policies - Lawrence Gadban](https://events.istio.io/istiocon-2021/slides/d8p-DeepDiveAuthPolicies-LawrenceGadban.pdf)\n- [Alpha Configuration | OAuth2 Proxy](https://oauth2-proxy.github.io/oauth2-proxy/configuration/alpha-config)\n- [OpenId Connect Scopes](https://developers.onelogin.com/openid-connect/scopes)\n- [SaaS Identity and Routing with Istio Service Mesh and Amazon EKS | Amazon Web Services](https://aws.amazon.com/blogs/apn/saas-identity-and-routing-with-istio-service-mesh-and-amazon-eks/)\n- [Istio OIDC Authentication | Jetstack Blog](https://venafi.com/blog/istio-oidc/)\n- [Istio and OAuth2-Proxy in Kubernetes for Microservice Authentication](https://elastisys.com/istio-and-oauth2-proxy-in-kubernetes-for-microservice-authentication/)\n- Alternative to OAuth2-Proxy: [Authservice](https://github.com/istio-ecosystem/authservice)\n- Alternative to OAuth2-Proxy: [Open Policy Agent](http://openpolicyagent.org)\n\n**_Until next time, „Å§„Å•„Åè üéâüáµüá∏_**\n\n<br><br>\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":957},"frontmatter":{"id":"c254b9ece5e7331e70d7689a","path":"/blog/authenticate-apps-on-k8s-okta-istio-oauth2/","humanDate":"Oct 24, 2024","fullDate":"2024-10-24","title":"Authenticate applications on Kubernetes: Okta(OIDC), Istio, and OAuth2-Proxy integration. üîù","keywords":["Kubernetes","Okta OIDC","Istio","OAuth2-Proxy","Authentication"],"excerpt":"How to secure your Kubernetes applications using Okta for OIDC, Istio for service mesh, and OAuth2-Proxy for authentication.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACuUlEQVR42kWTy27bRhSG9Vh9jfYNuumyqwDZuejCQIsEgYF0kSwStEWKpkGcVG2aykYs2JKdmLarxLEkS5R1oS4URZHiRbxT0teTbjrAwcwAc775559zCvcOVR4pGk8/jPm9PmWvbVLt2VyMHBqGR88KmHoxXpSSZDlplpBlAWnqkqU2y6WOtehh2R18T6Vw96DF4/MhvwmwKMD99oxKdy5Am8bURbMF6IY4YUyYJBIhfugRRgsBOxiWRqNXR9WuMMwGhV/PO7yo3VBszChdG1R6FjXdp274NI0lDVnbYUq6WrPerICc0tmAZbDAd4ZEwQjXVsmTMXFwQ+Fl9ZRi9YRH++c8eaNw2NQ4aM3YLra59Uud7/5Q2SnJhRc6n4ZmLPh8q0yl1uHnH3/gzp1tvtm6zU+Pd0jCLoW/RNVeU6dcH1Np6XwUZRdDh92LCX++n3KiWhzUZ5x2LMFteCvnbj9UqF72sfU6k56C1jvh5roqCsXDo67NsQBeTia8MnQU02HgxPj5hmwjiM2G/0fGKg+JEl/WHqMw4OFZxPGZKfsp0bJNQRkueDbro1hzqrMx388VTn2LZmfIldrFtB0mus5QGxCKbxCR557MFl/vhdx/Y/Lt/T71Tk/ua1E4Nkx2pk2+Gil80S3zWafI86VG+bDKi2KRSuWIUulvisVdprokEZPL734CPvgn4svnKdv7S3zJyaJrCrXFnKd9i63diFeXGSctKLsm3f6AwWBIr9vFdez/nrtZB7ASdesFaTRhOHjPk6rKu6tLwsUH8VCAuhujBFLMpoUW+Vyv5vQlaZOviMQjz7WII1fMjAQksJWoW1tSJhMa9be8O9qldvYafXROEkgdml7EfBnTDqSQA4tB5EkXZMRpLJ0RSWcEJIlHHNsSc4EbEhOSeESaDBmPL1l6LfJUJfQ+8i8fVhbuTD3ILgAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/7dc7602024f5ae6dd91173a1ba768833/5b69c/oidc-cover.png","srcSet":"/static/7dc7602024f5ae6dd91173a1ba768833/b95c0/oidc-cover.png 750w,\n/static/7dc7602024f5ae6dd91173a1ba768833/db1e8/oidc-cover.png 1080w,\n/static/7dc7602024f5ae6dd91173a1ba768833/aa4a0/oidc-cover.png 1366w,\n/static/7dc7602024f5ae6dd91173a1ba768833/5b69c/oidc-cover.png 1587w","sizes":"100vw"},"sources":[{"srcSet":"/static/7dc7602024f5ae6dd91173a1ba768833/47593/oidc-cover.webp 750w,\n/static/7dc7602024f5ae6dd91173a1ba768833/705ed/oidc-cover.webp 1080w,\n/static/7dc7602024f5ae6dd91173a1ba768833/1bffb/oidc-cover.webp 1366w,\n/static/7dc7602024f5ae6dd91173a1ba768833/df222/oidc-cover.webp 1587w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.538122243226213}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/pre-commit-hooks-terraform-code-quality/","title":"A Guide to using Pre-commit hooks for Terraform: Save time and improve code quality ü™ù","date":"2024-10-24 21:06:00"},"excerpt":"Automate Terraform Code Checks and and Security Standards ‚Ü™Ô∏è ‚òÅÔ∏è Introduction In the ever-changing world of tech, it is essential to ensure‚Ä¶","html":"<blockquote>\n<p><strong>Automate Terraform Code Checks and and Security Standards ‚Ü™Ô∏è</strong></p>\n</blockquote>\n<h2 id=\"Ô∏è-introduction\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-introduction\" aria-label=\"Ô∏è introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚òÅÔ∏è Introduction</h2>\n<p>In the ever-changing world of tech, it is essential to ensure the quality and security of your code. However, manually running command-line checks before every commit can be a time-consuming and tedious task. In this blog post, we will introduce you to Pre-commit hooks, a powerful tool that can help you automate code quality checks. Pre-commit hooks for Terraform are scripts that run automatically before you commit your code.</p>\n<p>They can be used to check for a variety of errors, such as linting errors, security vulnerabilities, and formatting issues.</p>\n<p>This blog post is designed for both experienced and inexperienced Terraform users. We will cover the basics of <a href=\"https://github.com/antonbabenko/pre-commit-terraform\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform pre-commit hooks</a> and how to use them with Terraform. We will also provide some tips on how to choose the right hooks for your needs.</p>\n<p>Let's get started! üí™</p>\n<h2 id=\"-what-is-pre-commit\" style=\"position:relative;\"><a href=\"#-what-is-pre-commit\" aria-label=\" what is pre commit permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìç What is pre-commit</h2>\n<p><a href=\"https://pre-commit.com/#install\" target=\"_blank\" rel=\"noopener noreferrer\">Pre-commit hooks</a> are essential scripts that automatically execute before committing your code changes. They serve a critical role in identifying various types of issues, including linting errors, security vulnerabilities, and formatting inconsistencies. This robust pre-commit process ensures the highest quality and safety of your code, making it ready for deployment.</p>\n<p><a href=\"https://developer.hashicorp.com/terraform/downloads\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>, on the other hand, is a powerful open-source infrastructure as code (IaC) tool that empowers users to create, modify, and enhance infrastructure in a reliable and predictable manner. It achieves this by converting infrastructure into a configuration language, which can be efficiently managed using version control tools.</p>\n<p>Now, let's explore some of the most popular <a href=\"https://github.com/antonbabenko/pre-commit-terraform\" target=\"_blank\" rel=\"noopener noreferrer\">pre-commit hooks tailored for Terraform</a>:</p>\n<ul>\n<li><strong><a href=\"https://github.com/terraform-docs/terraform-docs\" target=\"_blank\" rel=\"noopener noreferrer\">terraform-docs</a></strong>: This hook meticulously inspects your Terraform configuration files, detecting and correcting documentation errors.</li>\n<li><strong><a href=\"https://github.com/terraform-linters/tflint\" target=\"_blank\" rel=\"noopener noreferrer\">tflint</a></strong>: With this hook, your Terraform configurations undergo a thorough linting process to identify and rectify errors.</li>\n<li><strong><a href=\"https://github.com/aquasecurity/tfsec\" target=\"_blank\" rel=\"noopener noreferrer\">tfsec</a></strong>: Ensuring security is paramount, and tfsec specializes in scanning Terraform configurations for potential vulnerabilities.</li>\n<li><strong><a href=\"https://github.com/bridgecrewio/checkov\" target=\"_blank\" rel=\"noopener noreferrer\">checkov</a></strong>: This hook evaluates your Terraform configurations against a predefined set of security best practices, ensuring robust security posture.</li>\n<li><strong><a href=\"https://github.com/tenable/terrascan\" target=\"_blank\" rel=\"noopener noreferrer\">terrascan</a></strong>: Compliance with security standards is vital, and terrascan evaluates your configurations for adherence to these standards.</li>\n<li><strong><a href=\"https://github.com/infracost/infracost\" target=\"_blank\" rel=\"noopener noreferrer\">infracost</a></strong>: Providing financial insights, this hook estimates the cost implications of running your Terraform configurations.</li>\n<li><strong><a href=\"https://github.com/minamijoyo/tfupdate\" target=\"_blank\" rel=\"noopener noreferrer\">tfupdate</a></strong>: Stay up-to-date with Terraform providers by using this hook to check for updates and improvements.</li>\n<li><strong><a href=\"https://github.com/minamijoyo/hcledit\" target=\"_blank\" rel=\"noopener noreferrer\">minamijoyo/hcledit</a></strong>: Code readability and maintainability are enhanced with this hook, which refines your Terraform configurations.</li>\n<li><strong><a href=\"https://github.com/jqlang/jq\" target=\"_blank\" rel=\"noopener noreferrer\">jq</a></strong>: A versatile command-line JSON processor, jq is used to manipulate and refine Terraform configuration files as needed.</li>\n<li><strong><a href=\"https://terragrunt.gruntwork.io/docs/getting-started/quick-start/\" target=\"_blank\" rel=\"noopener noreferrer\">Terragrunt</a></strong>: A thin wrapper that provides extra tools for keeping your configurations DRY, working with multiple Terraform modules, and managing remote state.</li>\n<li><strong><a href=\"https://www.terraform.io/docs/commands/validate.html\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform Validate</a></strong>: A native Terraform command that validates the configuration files in a directory, referring only to the configuration and not accessing any remote services such as remote state, provider APIs, etc.</li>\n<li><strong><a href=\"https://www.terraform.io/docs/commands/fmt.html\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform Fmt</a></strong>: A Terraform command that is available natively and is used to rewrite Terraform configuration files to a canonical format and style. This command applies a subset of the <a href=\"https://www.terraform.io/docs/configuration/style.html\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform language style conventions</a>, along with other minor adjustments for readability.</li>\n</ul>\n<h3 id=\"Ô∏è-setting-up-pre-commit-hooks-for-terraform\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-setting-up-pre-commit-hooks-for-terraform\" aria-label=\"Ô∏è setting up pre commit hooks for terraform permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Setting Up Pre-commit Hooks for Terraform</h3>\n<p>To globally install the pre-commit hook and configure it for use with Terraform, follow these steps:</p>\n<ol>\n<li><strong>Install Pre-Commit Globally (Not Needed if Using Docker Image):</strong></li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token assign-left variable\">DIR</span><span class=\"token operator\">=~</span>/.git-template\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> init.templateDir <span class=\"token variable\">${DIR}</span>\npre-commit init-templatedir <span class=\"token parameter variable\">-t</span> pre-commit <span class=\"token variable\">${DIR}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">*Note: If you're already using a Docker image, you can skip this step.*</code></pre></div>\n<ol start=\"2\">\n<li><strong>Add Configurations and Hooks:</strong></li>\n</ol>\n<p>Navigate to the repository where you want to set up the pre-commit hooks, and perform the following steps:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">git</span> init\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> .pre-commit-config.yaml</span>\ndefault_install_hook_types:\n    - pre-commit\n    - commit-msg\n\nrepos:\n# BASIC CONF FOR ALL PRE-COMMITS REPO TYPE\n    - repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v4.4.0\n    hooks:\n        - id: trailing-whitespace\n        stages: [commit]\n        - id: end-of-file-fixer\n        exclude: /secrets\n        stages: [commit]\n        - id: check-added-large-files\n        stages: [commit]\n        - id: check-yaml\n        args:\n        - '--allow-multiple-documents'\n        exclude: /templates|/secrets\n        stages: [commit]\n        - id: check-json\n        stages: [commit]\n        - id: check-toml\n        stages: [commit]\n        - id: check-shebang-scripts-are-executable\n        stages: [commit]\n\n    - repo: https://github.com/compilerla/conventional-pre-commit\n    rev: v2.1.1\n    hooks:\n        - id: conventional-pre-commit\n        stages: [commit-msg]\n\n    - repo: https://github.com/gitleaks/gitleaks\n        rev: v8.16.1\n        hooks:\n        - id: gitleaks\n\n# SPECIFIC CONF FOR TERRAFORM MODULE REPOSITORIES\n    - repo: https://github.com/antonbabenko/pre-commit-terraform\n    rev: v1.77.1\n    hooks:\n        - id: terraform_fmt\n        args:\n        - --args=-diff\n        - --args=-write=true\n        stages: [commit]\n        - id: terraform_docs\n        stages: [commit]\n        - id: terraform_tflint\n        files: \\.tf$\n        args:\n            - --args=--config=__GIT_WORKING_DIR__/.tflint.hcl\n        stages: [commit]\n        - id: terraform_tfsec\n        files: \\.tf$\n        args:\n            - >\n            --args=--config-file=__GIT_WORKING_DIR__/.tfsec.yml\n            --var-file tests/terraform.tfvars\n        stages: [commit]\nEOF</span></code></pre></div>\n<p>Make sure to replace <code class=\"language-text\">&lt;VERSION></code> with the latest available version from the provided URL.</p>\n<ol start=\"3\">\n<li><strong>Running the Pre-Commit Hook:</strong></li>\n</ol>\n<p>After configuring the pre-commit hook, you can either install it globally or run it manually. In this example, we'll manually run the pre-commit hook:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">pre-commit run <span class=\"token parameter variable\">-a</span></code></pre></div>\n<h2 id=\"-closing-thoughts\" style=\"position:relative;\"><a href=\"#-closing-thoughts\" aria-label=\" closing thoughts permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìö Closing Thoughts</h2>\n<p>By leveraging pre-commit hooks, you can seamlessly integrate various open-source and Terraform-native tools into your workflow, all through a unified automation tool. This approach shifts the responsibility of enforcing code quality to pre-commit hooks, reducing the workload on downstream continuous integration (CI) systems. Additionally, it allows for the swift identification and resolution of minor issues with each commit, resulting in cleaner pull requests and reduced review time.</p>\n<p><br><br></p>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò</p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/kubernetes-admission-controllers-security-control/","title":"Kubernetes Admission Controllers: A Comprehensive Guide to Enhancing Security and Control","date":"2024-10-24 19:36:00"},"excerpt":"Admission Controllers: A Comprehensive Guide üìå Introduction Kubernetes Admission Controllers are an important feature that empowers you to‚Ä¶","html":"<blockquote>\n<p><strong>Admission Controllers: A Comprehensive Guide</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p><a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Admission Controllers</a> are an important feature that empowers you to enhance security and maintain control within your Kubernetes cluster. At the heart of every Kubernetes cluster lies the Kubernetes API server, serving as the gateway to cluster operations. This server operates as a RESTful API over HTTP, facilitating and executing all API actions while persistently storing API objects in the backend store, usually etcd.</p>\n<p>Whether it's interactions with external clients like <code class=\"language-text\">kubectl</code> or communication between various control plane components, the API server is the linchpin. Notably, it's designed to be stateless and capable of horizontal scaling to accommodate your cluster's growing demands.</p>\n<p>In this dynamic landscape, Admission Controllers emerge as a potent native Kubernetes feature. Imagine them as vigilant gatekeepers, finely tuned to determine what enters your cluster. They provide the means to govern deployments that request excessive resources, enforce stringent pod security policies, and preemptively thwart the deployment of vulnerable container images.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABwklEQVR42l2Rz2/TMBTH88dx4sR/wIEDpwkNIcQFTbsM7bIDTPyYJoQKAtGIikkcetiKQC0TlK5Vt5K1SdOmSZolTVzHjUNiOw5uMy59erLs5/eRv89fKV8F5/laZJzTjHtBQCmBOIOYFcUi+QqQ1hiWccLE9bIvZsxxpg6IN14GmwdBnGbLZ/7nNQzC6NJwZiBkWa77ierF3oImlCsmGadkhun2e7Arhz1nsXc8eHrSF+u7n8Y1/PbL15t3t15VqkKZatjdzpmHSBhhGOIhjBaEg5Vm+bdxY6/2uW3d/9i6V+7wAq4P1Z1K+ajXi0nuATS1JgGmhmmJjQsTywVjFwrJW0fdg+9a1wQ/hv6jSvePg6TzEXlSdndK1Vb7F4zSaDkYDzBLCWOU+JgZEzOYw/MpvvW8UTodib8Y+dHtN83XpxPpsBo+PESPPyhN9SJKcjH6QLnwMb3yPBRC3Z7ptq+MpsYVaOhgs9zerSoP5M6Lb0NrHkvunB2fxYq/8KNQyB47QNNHDkzFOI16fX//2UmtJsuf+v2BqEyC6E6pKbfMlbtcWvNpHjOUZOgvFUfbtjVNU1X1UlEQQgVAly7nhdP/AGZJ38gKvL6HAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Admission Controller\" title=\"\" src=\"/static/c9274295864b81033ca0aea0ff720e6c/c5bb3/adm-controller.png\" srcset=\"/static/c9274295864b81033ca0aea0ff720e6c/04472/adm-controller.png 170w,\n/static/c9274295864b81033ca0aea0ff720e6c/9f933/adm-controller.png 340w,\n/static/c9274295864b81033ca0aea0ff720e6c/c5bb3/adm-controller.png 680w,\n/static/c9274295864b81033ca0aea0ff720e6c/ae694/adm-controller.png 850w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"kubernetes-http-request-flow\" style=\"position:relative;\"><a href=\"#kubernetes-http-request-flow\" aria-label=\"kubernetes http request flow permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes HTTP Request Flow</h3>\n<p>Kubernetes offers powerful customization through custom resources (CRD) and controllers. Webhooks, like the validation and mutation controllers, let you modify incoming requests. To validate and modify requests, you'll need admission controllers.</p>\n<ul>\n<li><strong>Validation</strong> ensures request compliance. For instance, a pod name might violate naming policies. The validation controller rejects such requests, applying custom rules‚Ää‚Äî‚Äälike verifying phone numbers.</li>\n<li><strong>Mutation</strong> adapts requests. Imagine missing labels in a pod creation request. The mutation webhook can add defaults, ensuring validation success even with incomplete data.</li>\n</ul>\n<p>Mutation first alters requests; then, validation ensures their correctness. Successful validation stores Kubernetes component states, while failure prompts error responses. Admission controllers grant fine-grained control over your Kubernetes environment.</p>\n<h3 id=\"admission-controllers-extending-kubernetes-capabilities\" style=\"position:relative;\"><a href=\"#admission-controllers-extending-kubernetes-capabilities\" aria-label=\"admission controllers extending kubernetes capabilities permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Admission Controllers: Extending Kubernetes Capabilities</h3>\n<p>Admission controllers are integral to enhancing Kubernetes' capabilities. These controllers assess API requests, ensuring their correctness, and either approve or reject them. They primarily operate during create, update, delete, or proxy requests, without affecting list resource operations.</p>\n<p>Inherent in the Kubernetes API server are several built-in admission controllers, packaged with the <code class=\"language-text\">kube-apiserver</code> binary. These controllers, which can be enabled or disabled, are outlined in the <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes documentation</a>. Examples include the <code class=\"language-text\">LimitRanger</code> controller, setting default pod limits based on namespace constraints, and the <code class=\"language-text\">AlwaysPullImages</code> controller, which modifies the <code class=\"language-text\">ImagePullPolicy</code> for all pods.</p>\n<p>Admission controllers encompass two phases: mutation and validation. In the mutating phase, requests are altered and updated attributes are generated. The validating phase, however, determines request validity, rejecting improper ones.</p>\n<p>There are two types of admission controllers:</p>\n<ul>\n<li><strong>Mutating Admission Controllers</strong>: These controllers modify resource attributes before progressing to subsequent phases. An example is the <code class=\"language-text\">ServiceAccount</code> admission controller, which adds a default service account if missing, granting pods access to their service account tokens.</li>\n<li><strong>Validating Admission Controllers</strong>: These controllers validate requests, ensuring compliance with defined rules.</li>\n</ul>\n<p>Admission controllers play a pivotal role in the Kubernetes API server's lifecycle, enhancing security and control while adapting requests for seamless integration.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFklEQVR42mVQXU+DQBDk//8PjT7VZ7UmjaQP2FqkSmhDaaHycVe4A47j7iCAR4kYwz5MsrMzs5tVmqbpui6nzINYIspoiAqcl5iU3zEpeYUIdSPERIXy0o9zLqpEahIiqlqhtPTP3sfenamftp+8bqzbJ+3NPG527v18FVyw9uXcPa9Aki0Ne7Z4Dy9YNQ4P6janXGlbubhLCdudQVowgMgxSpOskKg7MMlKiHLrFHIhPJg9rj3GBcCFC1IuN3eTuqZ1MGUQs4LVPXOlEBGLLRgFsv7MbdtOzJzy3tw07cDM9XDM+mf+jegRE7beR/oBWl7MRT2MTDe+ebHsAI+yqbmnPYA182TYgUT5mGHk+LFsQUrH634AwAyJ6jEfJe0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Flow\" title=\"\" src=\"/static/69d3eb43d54b235f8c7aa9cc3ea3c436/c5bb3/flow.png\" srcset=\"/static/69d3eb43d54b235f8c7aa9cc3ea3c436/04472/flow.png 170w,\n/static/69d3eb43d54b235f8c7aa9cc3ea3c436/9f933/flow.png 340w,\n/static/69d3eb43d54b235f8c7aa9cc3ea3c436/c5bb3/flow.png 680w,\n/static/69d3eb43d54b235f8c7aa9cc3ea3c436/b12f7/flow.png 1020w,\n/static/69d3eb43d54b235f8c7aa9cc3ea3c436/e996b/flow.png 1050w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"enabling-admission-control-plugins\" style=\"position:relative;\"><a href=\"#enabling-admission-control-plugins\" aria-label=\"enabling admission control plugins permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Enabling Admission Control Plugins</h3>\n<p>Kubernetes enables many admission control plugins by default. Use the following command to see the enabled admission control plugins list:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kube-apiserver <span class=\"token parameter variable\">-h</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> enable-admission-plugins</code></pre></div>\n<p>The sample output for the above command is given below:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">CertificateApproval, CertificateSigning, CertificateSubjectRestriction, DefaultIngressClass, DefaultStorageClass, DefaultTolerationSeconds, LimitRanger, MutatingAdmissionWebhook, NamespaceLifecycle, PersistentVolumeClaimResize, PodSecurity, Priority, ResourceQuota, RuntimeClass, ServiceAccount, StorageObjectInUseProtection, TaintNodesByCondition, ValidatingAdmissionWebhook</code></pre></div>\n<p>Use the <code class=\"language-text\">enable-admission-plugins</code> command to enable the needed admission plugin:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kube-apiserver --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger</code></pre></div>\n<p>To disable the admission plugins, use the <code class=\"language-text\">disable-admission-plugins</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kube-apiserver --disable-admission-plugins<span class=\"token operator\">=</span>PodNodeSelector,AlwaysDeny</code></pre></div>\n<h3 id=\"validation-and-mutation-webhook\" style=\"position:relative;\"><a href=\"#validation-and-mutation-webhook\" aria-label=\"validation and mutation webhook permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Validation and Mutation Webhook</h3>\n<p>Within GitHub, resides an uncomplicated mutation and validation webhook, authored using the GO language. It's important to note that this project isn't yet optimized for production. Instead, it serves as a tutorial on crafting a basic and efficient Kubernetes webhook. This demonstration encompasses both validation and mutation webhooks.</p>\n<p>The validation webhook is responsible for scrutinizing pod names, ensuring they adhere to acceptable standards. Should a pod's name fall short of this validation, its creation is unsuccessful. Subsequently, the mutation webhook steps in, injecting essential labels like <code class=\"language-text\">KUBE:true</code> and establishing a minimum pod lifespan.</p>\n<h2 id=\"Ô∏è-hands-on-tutorial\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-hands-on-tutorial\" aria-label=\"Ô∏è hands on tutorial permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Hands-on Tutorial</h2>\n<p>You can find the complete source code <a href=\"https://github.com/your-repo-link\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<h3 id=\"step-1-create-a-kubernetes-cluster\" style=\"position:relative;\"><a href=\"#step-1-create-a-kubernetes-cluster\" aria-label=\"step 1 create a kubernetes cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 1: Create a Kubernetes Cluster</h3>\n<p>First, we need to create a Kubernetes cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">‚ùØ <span class=\"token function\">make</span> cluster\n\nüîß Creating Kubernetes cluster<span class=\"token punctuation\">..</span>.\nkind create cluster <span class=\"token parameter variable\">--config</span> dev/manifests/kind/kind.cluster.yaml\nüîß Creating cluster <span class=\"token string\">\"kind\"</span> <span class=\"token punctuation\">..</span>.\n    - ‚úì Ensuring <span class=\"token function\">node</span> image <span class=\"token punctuation\">(</span>kindest/node:v1.28.1<span class=\"token punctuation\">)</span> üñº\n    - ‚úì Preparing nodes üì¶\n    - ‚úì Writing configuration üìú\n    - ‚úì Starting control-plane üïπÔ∏è\n    - ‚úì Installing CNI üîå\n    - ‚úì Installing StorageClass üíæ\n\nSet kubectl context to <span class=\"token string\">\"kind-kind\"</span><span class=\"token builtin class-name\">.</span>\n\nYou can now use your cluster with:\nkubectl cluster-info <span class=\"token parameter variable\">--context</span> kind-kind\n\nHave a <span class=\"token function\">nice</span> day<span class=\"token operator\">!</span> üëã</code></pre></div>\n<h3 id=\"verify-kubernetes-node-and-system-pods\" style=\"position:relative;\"><a href=\"#verify-kubernetes-node-and-system-pods\" aria-label=\"verify kubernetes node and system pods permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Verify Kubernetes Node and System Pods</h3>\n<p>Ensure that the Kubernetes node is ready:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">‚ùØ kubectl get nodes\nNAME                 STATUS   ROLES                  AGE     VERSION\nkind-control-plane   Ready    control-plane,master   3m25s   v1.28.1</code></pre></div>\n<p>And that system pods are running happily:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">‚ùØ kubectl <span class=\"token parameter variable\">-n</span> kube-system get pods\nNAME                                         READY   STATUS    RESTARTS   AGE\ncoredns-558bd4d5db-thwvj                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m39s\ncoredns-558bd4d5db-w85ks                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m39s\netcd-kind-control-plane                      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m56s\nkindnet-84slq                                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m40s\nkube-apiserver-kind-control-plane            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m54s\nkube-controller-manager-kind-control-plane   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m56s\nkube-proxy-4h6sj                             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m40s\nkube-scheduler-kind-control-plane            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m54s</code></pre></div>\n<h3 id=\"deploy-admission-webhook\" style=\"position:relative;\"><a href=\"#deploy-admission-webhook\" aria-label=\"deploy admission webhook permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy Admission Webhook</h3>\n<p>To configure the cluster to use the admission webhook and to deploy said webhook, simply run:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">‚ùØ <span class=\"token function\">make</span> deploy\nüì¶ Building simple-kubernetes-webhook Docker image<span class=\"token punctuation\">..</span>.\n<span class=\"token function\">docker</span> build <span class=\"token parameter variable\">-t</span> simple-kubernetes-webhook:latest <span class=\"token builtin class-name\">.</span>\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Building <span class=\"token number\">14</span>.3s <span class=\"token punctuation\">(</span><span class=\"token number\">13</span>/13<span class=\"token punctuation\">)</span> FINISHED\n<span class=\"token punctuation\">..</span>.\nüì¶ Pushing admission-webhook image into Kind's Docker daemon<span class=\"token punctuation\">..</span>.\nkind load docker-image simple-kubernetes-webhook:latest\nImage: <span class=\"token string\">\"simple-kubernetes-webhook:latest\"</span> with ID <span class=\"token string\">\"sha256:46b8603bcc11a8fa1825190d3ed99c099096395b22a709e13ec6e7ae2f54014d\"</span> not yet present on <span class=\"token function\">node</span> <span class=\"token string\">\"kind-control-plane\"</span>, loading<span class=\"token punctuation\">..</span>.\n‚öôÔ∏è  Applying cluster config<span class=\"token punctuation\">..</span>.\nkubectl apply <span class=\"token parameter variable\">-f</span> dev/manifests/cluster-config/\nnamespace/apps created\nmutatingwebhookconfiguration.admissionregistration.k8s.io/simple-kubernetes-webhook.acme.com created\nvalidatingwebhookconfiguration.admissionregistration.k8s.io/simple-kubernetes-webhook.acme.com created\nüöÄ Deploying simple-kubernetes-webhook<span class=\"token punctuation\">..</span>.\nkubectl apply <span class=\"token parameter variable\">-f</span> dev/manifests/webhook/\ndeployment.apps/simple-kubernetes-webhook created\nservice/simple-kubernetes-webhook created\nsecret/simple-kubernetes-webhook-tls created</code></pre></div>\n<p>Then, make sure the admission webhook pod is running (in the default namespace):</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">‚ùØ kubectl get pods\nNAME                                        READY   STATUS    RESTARTS   AGE\nsimple-kubernetes-webhook-77444566b7-wzwmx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m21s</code></pre></div>\n<p>You can stream logs from it:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">‚ùØ <span class=\"token function\">make</span> logs\nüîç Streaming simple-kubernetes-webhook logs<span class=\"token punctuation\">..</span>.\nkubectl logs <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>simple-kubernetes-webhook <span class=\"token parameter variable\">-f</span>\n<span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-08-08T14:59:10Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Listening on port 443...\"</span>\n<span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-08-08T05:02:21Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>debug <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span>healthy <span class=\"token assign-left variable\">uri</span><span class=\"token operator\">=</span>/health</code></pre></div>\n<p>And hit it's health endpoint from your local machine:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">‚ùØ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-k</span> https://localhost:8443/health\nOK</code></pre></div>\n<h3 id=\"deploying-pods\" style=\"position:relative;\"><a href=\"#deploying-pods\" aria-label=\"deploying pods permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploying pods</h3>\n<p>Deploy a valid test pod that gets succesfully created:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">‚ùØ <span class=\"token function\">make</span> pod\n\nüöÄ Deploying <span class=\"token builtin class-name\">test</span> pod<span class=\"token punctuation\">..</span>.\nkubectl apply <span class=\"token parameter variable\">-f</span> dev/manifests/pods/lifespan-seven.pod.yaml\npod/lifespan-seven created</code></pre></div>\n<p>You should see in the admission webhook logs that the pod got mutated and validated.</p>\n<p>Deploy a non valid pod that gets rejected:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">‚ùØ <span class=\"token function\">make</span> bad-pod\n\nüöÄ Deploying <span class=\"token string\">\"bad\"</span> pod<span class=\"token punctuation\">..</span>.\nkubectl apply <span class=\"token parameter variable\">-f</span> dev/manifests/pods/bad-name.pod.yaml\nError from server: error when creating <span class=\"token string\">\"dev/manifests/pods/bad-name.pod.yaml\"</span><span class=\"token builtin class-name\">:</span> admission webhook <span class=\"token string\">\"simple-kubernetes-webhook.acme.com\"</span> denied the request: pod name contains <span class=\"token string\">\"offensive\"</span></code></pre></div>\n<p>You should see in the admission webhook logs that the pod validation failed. It's possible you will also see that the pod was mutated, as webhook configurations are not ordered.\nTesting\nUnit tests can be run with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">make</span> <span class=\"token builtin class-name\">test</span>\ngo <span class=\"token builtin class-name\">test</span> ./<span class=\"token punctuation\">..</span>.\n?   \tgithub.com/slackhq/simple-kubernetes-webhook\t<span class=\"token punctuation\">[</span>no <span class=\"token builtin class-name\">test</span> files<span class=\"token punctuation\">]</span>\nok  \tgithub.com/slackhq/simple-kubernetes-webhook/pkg/admission\t<span class=\"token number\">0</span>.611s\nok  \tgithub.com/slackhq/simple-kubernetes-webhook/pkg/mutation\t<span class=\"token number\">1</span>.064s\nok  \tgithub.com/slackhq/simple-kubernetes-webhook/pkg/validation\t<span class=\"token number\">0</span>.749s</code></pre></div>\n<h3 id=\"Ô∏è-admission-logic\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-admission-logic\" aria-label=\"Ô∏è admission logic permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Admission Logic</h3>\n<p>A set of validations and mutations are implemented in an extensible framework. These occur on the fly when a pod is deployed, and no further resources are tracked and updated (i.e., no controller logic).</p>\n<h4 id=\"-validating-webhooks\" style=\"position:relative;\"><a href=\"#-validating-webhooks\" aria-label=\" validating webhooks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìù Validating Webhooks</h4>\n<p><strong>Implemented:</strong></p>\n<ul>\n<li><a href=\"https://github.com/slackhq/simple-kubernetes-webhook/blob/main/pkg/validation/name_validator.go\" target=\"_blank\" rel=\"noopener noreferrer\">Name Validation</a>: Ensures that a pod name doesn't contain any offensive string.</li>\n</ul>\n<h4 id=\"-how-to-add-a-new-pod-validation\" style=\"position:relative;\"><a href=\"#-how-to-add-a-new-pod-validation\" aria-label=\" how to add a new pod validation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ûï How to Add a New Pod Validation</h4>\n<p>To add a new pod mutation, follow these steps:</p>\n<ol>\n<li>Create a file in <code class=\"language-text\">pkg/validation/</code> named <code class=\"language-text\">MUTATION_NAME.go</code>.</li>\n<li>Implement a new struct that adheres to the <code class=\"language-text\">validation.podValidator</code> interface.</li>\n</ol>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîö Conclusion</h2>\n<p>In summary, admission controllers stand as a pivotal element within the Kubernetes API server's admission procedure. They offer meticulous command over object creation, updates, and deletions. These controllers possess expandable capabilities through admission webhooks, affording developers the opportunity to construct tailored admission logic.</p>\n<p><strong>üìö Resources</strong></p>\n<ul>\n<li><a href=\"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Documentation: Admission Controllers</a></li>\n<li><a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Documentation: Extensible Admission Controllers</a></li>\n<li><a href=\"https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes API Server</a></li>\n<li><a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Custom Resources</a></li>\n<li><a href=\"https://github.com/slackhq/simple-kubernetes-webhook\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub: Simple Kubernetes Webhook</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}