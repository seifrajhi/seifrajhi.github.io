{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/aws-controllers-for-kubernetes-ack/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>A Path to AWS Service Control in Kubernetes</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ü§ñ Introduction</h2>\n<p><a href=\"https://aws-controllers-k8s.github.io/community/docs/community/overview/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Controllers for Kubernetes (ACK)</a> is an open-source project that lets you define and use AWS service resources directly from Kubernetes. This means that you can manage all of your application's resources, including its infrastructure and dependencies, from a single place.</p>\n<p>ACK works by extending the Kubernetes API with custom resource definitions (CRDs) and custom controllers. These CRDs and controllers allow you to define and manage AWS service resources using the same Kubernetes constructs that you use to manage your application's other resources.</p>\n<p>ACK makes it easy to take advantage of AWS managed services for your Kubernetes applications. With ACK, you don't need to worry about provisioning or managing the underlying infrastructure for these services. You can simply define the AWS service resources that you need in your Kubernetes cluster, and ACK will take care of the rest.</p>\n<p>This article aims to discover this service and test it by installing a controller within a Kubernetes cluster.</p>\n<h3 id=\"-what-is-the-benefit-of-ack\" style=\"position:relative;\"><a href=\"#-what-is-the-benefit-of-ack\" aria-label=\" what is the benefit of ack permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåü What is the benefit of ACK?</h3>\n<p>ACK can be considered as an additional abstraction for managing AWS resources that is added to the existing solutions. Today, there are three levels of \"abstraction\" for infrastructure as code:</p>\n<ol>\n<li><strong>Level 1</strong>: Infrastructure as code defined as shell scripts. In this category, we can cite the launching of commands via the <a href=\"https://aws.amazon.com/cli/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS CLI</a>.</li>\n<li><strong>Level 2</strong>: The use of tools such as <a href=\"https://puppet.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Puppet</a>, <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>, <a href=\"https://www.ansible.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Ansible</a>, and <a href=\"https://saltproject.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Salt</a> to define step by step the infrastructure that we want to put in place.</li>\n<li><strong>Level 3</strong>: We only define the desired final state of the infrastructure. This is the level that ACK belongs to.</li>\n</ol>\n<p>Currently, the use of AWS and Kubernetes represents a design complexity that is not easy to understand. Indeed, these architectures require the articulation of resources with each other in order to allow the general infrastructure to function properly. The understanding of the infrastructure in its entirety is therefore necessary and requires switching very regularly between the different technologies.</p>\n<p>AWS offers us this new tool to allow its users to create new resources and control their current state. Thus, the user would only have to define the state of the desired AWS resource, and the controller would take care of bringing the resource from the current state to the desired state.</p>\n<h3 id=\"Ô∏è-how-ack-works\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-how-ack-works\" aria-label=\"Ô∏è how ack works permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚öôÔ∏è How ACK works</h3>\n<p>Our goal with ACK is to provide a consistent Kubernetes interface for AWS, regardless of the AWS service API. One example of this is ensuring field names and identifiers are normalized and tags are handled the same way across AWS resources.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 84.11764705882354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACQUlEQVR42n1Ui47aMBDMV/MV/FhP5aRSpIpDvJTjekcO8o7fme6uk5RWBxYrG2OPZ8Zjkr7vca9AH+M0XrMDVHpGe8zQvW2w26VI0xZlpuGchTEG3nvZk9wDC30At6LJ8WP3hHa5R/F9C735hsPuHctlidOmpBWBQP20LwkhYCwBGnou5xyUUgLcc8lBvMbH6oOs4eJ9zPJLhvwjt/V6jcvlU8bBx81adbDWCitjolz+zmA8Th552HXd5M3tYeO4bpppDTdh+I/kG+me2WjNOmXMbbVaYT6fCwgGC9q2k8rznC5rFxnenhpG/+g0TRLYOzcwWCwWmM1mBNBOgGzDKL0sy1EyeeQMgmmJpZPy1sCQX+hJsnfCfjycqyWW1ihsfxs8rTX2H1bWJrKQTrPvLyi2z1A07yzLNSKFzXdkeu/Z+CA2MHBV1XRBLQ5ni8XW4JhFIoOHHGKLnweDrAhQpkfTORSVRqPjmBWMEseYxKhYCTfHiG97umVnNfKavLBeWCnjyXwlN2fpe6BNIyDPjWVt9JDZTzk8nU7Ybl7EfGM0Ogrz6qBQ1hTqPr4ETwwZLGbQ3QBaYXq9XrHf75FUdf03sD7KN47iQFKrRkUwnhdAPwFydPhm/wePkjmUzgqbt4tDmlkcyexX7j+MzPvBw/iKYujdkM/b4E8eMgM2v9ODf0OvTCAm46UAj14WHzYBIlj8Sh3OFT0peiAlRbDqYl92JNnbu0/wC4Z0slPIP6/QTQHflXC31eaUqnb6x3lUfwDEki9srIKnLQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"ACK Workflow\" title=\"\" src=\"/static/f50cdf2dcd65ba8d3ce914553ae33dc7/c5bb3/ack.png\" srcset=\"/static/f50cdf2dcd65ba8d3ce914553ae33dc7/04472/ack.png 170w,\n/static/f50cdf2dcd65ba8d3ce914553ae33dc7/9f933/ack.png 340w,\n/static/f50cdf2dcd65ba8d3ce914553ae33dc7/c5bb3/ack.png 680w,\n/static/f50cdf2dcd65ba8d3ce914553ae33dc7/5a190/ack.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>As depicted above, from a high level, the ACK workflow is as follows:</p>\n<ol>\n<li><strong>Artifact Generation</strong>: We, as in \"the project team led by the authors\", generate and maintain a collection of artifacts (binaries, container images, Helm charts, etc.). These artifacts are automatically derived from the AWS services APIs and represent the business logic of how to manage AWS resources from within Kubernetes.</li>\n<li><strong>Controller Installation</strong>: As a cluster admin, you select one or more ACK controllers you want to install and configure for a cluster you're responsible for.</li>\n<li><strong>Custom Resource Creation</strong>: As an application developer, you create (Kubernetes) custom resources representing AWS resources.</li>\n<li><strong>Resource Management</strong>: The respective ACK controller (installed in step 2) manages said custom resources and with it the underlying AWS resources. Based on the custom resource defined in step 3, the controller creates, updates, or deletes the underlying AWS resources using the AWS APIs.</li>\n</ol>\n<h2 id=\"Ô∏è-hands-on-for-testing-ack-on-a-kubernetes-cluster\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-hands-on-for-testing-ack-on-a-kubernetes-cluster\" aria-label=\"Ô∏è hands on for testing ack on a kubernetes cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Hands-On for Testing ACK on a Kubernetes Cluster</h2>\n<p><strong>Required Tools:</strong></p>\n<ul>\n<li>üê≥ <strong>Docker</strong></li>\n<li>üì¶ <strong>kubectl</strong></li>\n<li>üéõÔ∏è <strong>Helm 3</strong></li>\n<li>‚ò∏Ô∏è <strong>eksctl</strong></li>\n</ul>\n<h3 id=\"setting-up-the-eks-cluster\" style=\"position:relative;\"><a href=\"#setting-up-the-eks-cluster\" aria-label=\"setting up the eks cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Setting Up the EKS Cluster</h3>\n<p>To test this service, quickly set up an EKS Kubernetes cluster using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">eksctl create cluster <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>ack-demo <span class=\"token parameter variable\">--nodes</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">--region</span><span class=\"token operator\">=</span>eu-west-1</code></pre></div>\n<p>You can consult the <a href=\"https://aws.amazon.com/cloudformation/\" target=\"_blank\" rel=\"noopener noreferrer\">CloudFormation stack on AWS</a> to learn more about the resources created previously.</p>\n<h3 id=\"installing-an-ack-service-controller-with-helm-recommended\" style=\"position:relative;\"><a href=\"#installing-an-ack-service-controller-with-helm-recommended\" aria-label=\"installing an ack service controller with helm recommended permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Installing an ACK Service Controller with Helm (Recommended)</h3>\n<p>The recommended way to install an ACK service controller for Kubernetes is to use <a href=\"https://helm.sh/docs/intro/install/\" target=\"_blank\" rel=\"noopener noreferrer\">Helm 3.8+</a>.</p>\n<p>Each ACK service controller has a separate Helm chart that installs the necessary supporting artifacts as a Kubernetes Deployment. This includes the ACK service controller, custom resource definitions (CRDs), and Kubernetes Role-Based Access Control (RBAC) manifests.</p>\n<p>Helm charts for ACK service controllers can be found in the ACK registry within the <a href=\"https://gallery.ecr.aws/aws-controllers-k8s\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon ECR Public Gallery</a>. To find a Helm chart for a specific service, you can go to <code class=\"language-text\">gallery.ecr.aws/aws-controllers-k8s/$SERVICENAME-chart</code>. For example, the link to the ACK service controller Helm chart for Amazon Simple Storage Service (Amazon S3) is <a href=\"https://gallery.ecr.aws/aws-controllers-k8s/s3-chart\" target=\"_blank\" rel=\"noopener noreferrer\">gallery.ecr.aws/aws-controllers-k8s/s3-chart</a>.</p>\n<p>Helm charts for individual ACK service controllers are tagged with their release version. You can find charts for different releases under the <strong>Image tags</strong> section in the chart repository on the ECR Public Gallery.</p>\n<p>Before installing a Helm chart, you can query the controller repository to find the latest release tag. This tag will correspond with a version of the Helm chart and a controller image. Then, you can use the Helm CLI to log into the ECR public Helm registry and install the chart.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">SERVICE</span><span class=\"token operator\">=</span>s3\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RELEASE_VERSION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-sL</span> https://api.github.com/repos/aws-controllers-k8s/$<span class=\"token punctuation\">{</span>SERVICE<span class=\"token punctuation\">}</span>-controller/releases/latest <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.tag_name | ltrimstr(\"v\")'</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ACK_SYSTEM_NAMESPACE</span><span class=\"token operator\">=</span>ack-system\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_REGION</span><span class=\"token operator\">=</span>eu-west-1\n\naws ecr-public get-login-password <span class=\"token parameter variable\">--region</span> us-east-1 <span class=\"token operator\">|</span> helm registry login <span class=\"token parameter variable\">--username</span> AWS --password-stdin public.ecr.aws\nhelm <span class=\"token function\">install</span> --create-namespace <span class=\"token parameter variable\">-n</span> <span class=\"token variable\">$ACK_SYSTEM_NAMESPACE</span> ack-<span class=\"token variable\">$SERVICE</span>-controller <span class=\"token punctuation\">\\</span>\n    oci://public.ecr.aws/aws-controllers-k8s/<span class=\"token variable\">$SERVICE</span>-chart <span class=\"token parameter variable\">--version</span><span class=\"token operator\">=</span><span class=\"token variable\">$RELEASE_VERSION</span> <span class=\"token parameter variable\">--set</span><span class=\"token operator\">=</span>aws.region<span class=\"token operator\">=</span><span class=\"token variable\">$AWS_REGION</span></code></pre></div>\n<p>The <code class=\"language-text\">helm install</code> command should return relevant installation information:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">NAME</span><span class=\"token punctuation\">:</span> ack<span class=\"token punctuation\">-</span>s3<span class=\"token punctuation\">-</span>controller\n<span class=\"token key atrule\">LAST DEPLOYED</span><span class=\"token punctuation\">:</span> Thu Nov 02 10<span class=\"token punctuation\">:</span>30<span class=\"token punctuation\">:</span>16 2023\n<span class=\"token key atrule\">NAMESPACE</span><span class=\"token punctuation\">:</span> ack<span class=\"token punctuation\">-</span>system\n<span class=\"token key atrule\">STATUS</span><span class=\"token punctuation\">:</span> deployed\n<span class=\"token key atrule\">REVISION</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n<span class=\"token key atrule\">TEST SUITE</span><span class=\"token punctuation\">:</span> None\n<span class=\"token key atrule\">NOTES</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span></code></pre></div>\n<p>To verify that the Helm chart was installed, use the <code class=\"language-text\">helm list</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">helm list <span class=\"token parameter variable\">--namespace</span> <span class=\"token variable\">$ACK_SYSTEM_NAMESPACE</span> <span class=\"token parameter variable\">-o</span> yaml</code></pre></div>\n<h2 id=\"-configure-iam-permissions\" style=\"position:relative;\"><a href=\"#-configure-iam-permissions\" aria-label=\" configure iam permissions permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Configure IAM Permissions</h2>\n<h3 id=\"set-up-ack-with-iam-roles-for-service-accounts\" style=\"position:relative;\"><a href=\"#set-up-ack-with-iam-roles-for-service-accounts\" aria-label=\"set up ack with iam roles for service accounts permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Set up ACK with IAM Roles for Service Accounts</h3>\n<p>IAM Roles for Service Accounts (IRSA) is a system that automates the provisioning and rotation of IAM temporary credentials (called a Web Identity) that a Kubernetes ServiceAccount can use to call AWS APIs.</p>\n<p>The primary advantage of IRSA is that Kubernetes Pods which use the ServiceAccount associated with an IAM Role can have a reduced IAM permission footprint compared to the IAM Role in use for the Kubernetes EC2 worker node (known as the EC2 Instance Profile Role). This security concept is known as <strong>Least Privilege</strong>.</p>\n<h3 id=\"step-1-create-an-oidc-identity-provider-for-your-cluster\" style=\"position:relative;\"><a href=\"#step-1-create-an-oidc-identity-provider-for-your-cluster\" aria-label=\"step 1 create an oidc identity provider for your cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 1: Create an OIDC Identity Provider for Your Cluster</h3>\n<p>Create an OpenID Connect (OIDC) identity provider for your EKS cluster using the <code class=\"language-text\">eksctl utils</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">EKS_CLUSTER_NAME</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>eks cluster name<span class=\"token operator\">></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_REGION</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>aws region id<span class=\"token operator\">></span>\neksctl utils associate-iam-oidc-provider <span class=\"token parameter variable\">--cluster</span> <span class=\"token variable\">$EKS_CLUSTER_NAME</span> <span class=\"token parameter variable\">--region</span> <span class=\"token variable\">$AWS_REGION</span> <span class=\"token parameter variable\">--approve</span></code></pre></div>\n<p>For detailed instructions, refer to the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon EKS documentation</a> on how to create an IAM OIDC provider for your cluster.</p>\n<h3 id=\"step-2-create-an-iam-role-and-policy-for-your-serviceaccount\" style=\"position:relative;\"><a href=\"#step-2-create-an-iam-role-and-policy-for-your-serviceaccount\" aria-label=\"step 2 create an iam role and policy for your serviceaccount permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 2. Create an IAM role and policy for your service¬†account</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Update the service name variables as needed</span>\n<span class=\"token assign-left variable\">SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"s3\"</span>\n<span class=\"token assign-left variable\">AWS_ACCOUNT_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws sts get-caller-identity <span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"Account\"</span> <span class=\"token parameter variable\">--output</span> text<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">OIDC_PROVIDER</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws eks describe-cluster <span class=\"token parameter variable\">--name</span> $EKS_CLUSTER_NAME <span class=\"token parameter variable\">--region</span> $AWS_REGION <span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"cluster.identity.oidc.issuer\"</span> <span class=\"token parameter variable\">--output</span> text <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"s/^https:\\/\\///\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">ACK_K8S_NAMESPACE</span><span class=\"token operator\">=</span>ack-system\n\n<span class=\"token assign-left variable\">ACK_K8S_SERVICE_ACCOUNT_NAME</span><span class=\"token operator\">=</span>ack-<span class=\"token variable\">$SERVICE</span>-controller\n\n<span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">''</span> TRUST_RELATIONSHIP <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Federated\": \"arn:aws:iam::<span class=\"token variable\">${AWS_ACCOUNT_ID}</span>:oidc-provider/<span class=\"token variable\">${OIDC_PROVIDER}</span>\"\n      },\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"<span class=\"token variable\">${OIDC_PROVIDER}</span>:sub\": \"system:serviceaccount:<span class=\"token variable\">${ACK_K8S_NAMESPACE}</span>:<span class=\"token variable\">${ACK_K8S_SERVICE_ACCOUNT_NAME}</span>\"\n        }\n      }\n    }\n  ]\n}\nEOF</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${TRUST_RELATIONSHIP}</span>\"</span> <span class=\"token operator\">></span> trust.json\n\n<span class=\"token assign-left variable\">ACK_CONTROLLER_IAM_ROLE</span><span class=\"token operator\">=</span><span class=\"token string\">\"ack-<span class=\"token variable\">${SERVICE}</span>-controller\"</span>\n<span class=\"token assign-left variable\">ACK_CONTROLLER_IAM_ROLE_DESCRIPTION</span><span class=\"token operator\">=</span><span class=\"token string\">\"IRSA role for ACK <span class=\"token variable\">${SERVICE}</span> controller deployment on EKS cluster using Helm charts\"</span>\naws iam create-role --role-name <span class=\"token string\">\"<span class=\"token variable\">${ACK_CONTROLLER_IAM_ROLE}</span>\"</span> --assume-role-policy-document file://trust.json <span class=\"token parameter variable\">--description</span> <span class=\"token string\">\"<span class=\"token variable\">${ACK_CONTROLLER_IAM_ROLE_DESCRIPTION}</span>\"</span>\n<span class=\"token assign-left variable\">ACK_CONTROLLER_IAM_ROLE_ARN</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws iam get-role --role-name<span class=\"token operator\">=</span>$ACK_CONTROLLER_IAM_ROLE <span class=\"token parameter variable\">--query</span> Role.Arn <span class=\"token parameter variable\">--output</span> text<span class=\"token variable\">)</span></span></code></pre></div>\n<h3 id=\"attach-iam-policy-to-the-iam-role\" style=\"position:relative;\"><a href=\"#attach-iam-policy-to-the-iam-role\" aria-label=\"attach iam policy to the iam role permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Attach IAM policy to the IAM role:</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Download the recommended managed and inline policies and apply them to the</span>\n<span class=\"token comment\"># newly created IRSA role</span>\n<span class=\"token assign-left variable\">BASE_URL</span><span class=\"token operator\">=</span>https://raw.githubusercontent.com/aws-controllers-k8s/<span class=\"token variable\">${SERVICE}</span>-controller/main\n<span class=\"token assign-left variable\">POLICY_ARN_URL</span><span class=\"token operator\">=</span><span class=\"token variable\">${BASE_URL}</span>/config/iam/recommended-policy-arn\n<span class=\"token assign-left variable\">POLICY_ARN_STRINGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">wget</span> -qO- $<span class=\"token punctuation\">{</span>POLICY_ARN_URL<span class=\"token punctuation\">}</span><span class=\"token variable\">)</span></span>\"</span>\n\n<span class=\"token assign-left variable\">INLINE_POLICY_URL</span><span class=\"token operator\">=</span><span class=\"token variable\">${BASE_URL}</span>/config/iam/recommended-inline-policy\n<span class=\"token assign-left variable\">INLINE_POLICY</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">wget</span> -qO- $<span class=\"token punctuation\">{</span>INLINE_POLICY_URL<span class=\"token punctuation\">}</span><span class=\"token variable\">)</span></span>\"</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">IFS</span></span><span class=\"token operator\">=</span> <span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-r</span> POLICY_ARN<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"Attaching <span class=\"token variable\">$POLICY_ARN</span> ... \"</span>\n    aws iam attach-role-policy <span class=\"token punctuation\">\\</span>\n        --role-name <span class=\"token string\">\"<span class=\"token variable\">${ACK_CONTROLLER_IAM_ROLE}</span>\"</span> <span class=\"token punctuation\">\\</span>\n        --policy-arn <span class=\"token string\">\"<span class=\"token variable\">${POLICY_ARN}</span>\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"ok.\"</span>\n<span class=\"token keyword\">done</span> <span class=\"token operator\">&lt;&lt;&lt;</span> <span class=\"token string\">\"<span class=\"token variable\">$POLICY_ARN_STRINGS</span>\"</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$INLINE_POLICY</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"Putting inline policy ... \"</span>\n    aws iam put-role-policy <span class=\"token punctuation\">\\</span>\n        --role-name <span class=\"token string\">\"<span class=\"token variable\">${ACK_CONTROLLER_IAM_ROLE}</span>\"</span> <span class=\"token punctuation\">\\</span>\n        --policy-name <span class=\"token string\">\"ack-recommended-policy\"</span> <span class=\"token punctuation\">\\</span>\n        --policy-document <span class=\"token string\">\"<span class=\"token variable\">$INLINE_POLICY</span>\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"ok.\"</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<h3 id=\"step-3-associate-an-iam-role-to-a-service-account-and-restart-deployment\" style=\"position:relative;\"><a href=\"#step-3-associate-an-iam-role-to-a-service-account-and-restart-deployment\" aria-label=\"step 3 associate an iam role to a service account and restart deployment permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 3. Associate an IAM role to a service account and restart deployment</h3>\n<p>If you installed your <a href=\"https://aws-controllers-k8s.github.io/community/docs/user-docs/install/\" target=\"_blank\" rel=\"noopener noreferrer\">ACK service controller using a Helm chart</a>, then a service account already exists on your cluster.</p>\n<blockquote>\n<p>However, it is still neccessary to associate an IAM role with the service account.</p>\n</blockquote>\n<p>Verify that your service account exists using kubectl describe:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl describe serviceaccount/<span class=\"token variable\">$ACK_K8S_SERVICE_ACCOUNT_NAME</span> <span class=\"token parameter variable\">-n</span> <span class=\"token variable\">$ACK_K8S_NAMESPACE</span></code></pre></div>\n<p>Note that the Amazon Resource Name (ARN) of the IAM role that you created is not yet set as an annotation for the service account.</p>\n<p>Use the following commands to associate an IAM role to a service account:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Annotate the service account with the ARN</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IRSA_ROLE_ARN</span><span class=\"token operator\">=</span>eks.amazonaws.com/role-arn<span class=\"token operator\">=</span><span class=\"token variable\">$ACK_CONTROLLER_IAM_ROLE_ARN</span>\nkubectl annotate serviceaccount <span class=\"token parameter variable\">-n</span> <span class=\"token variable\">$ACK_K8S_NAMESPACE</span> <span class=\"token variable\">$ACK_K8S_SERVICE_ACCOUNT_NAME</span> <span class=\"token variable\">$IRSA_ROLE_ARN</span></code></pre></div>\n<p>Restart ACK service controller deployment using the following commands. The restart will update service controller pods with IRSA environment variables:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Note the deployment name for ACK service controller from following command</span>\nkubectl get deployments <span class=\"token parameter variable\">-n</span> <span class=\"token variable\">$ACK_K8S_NAMESPACE</span>\nkubectl <span class=\"token parameter variable\">-n</span> <span class=\"token variable\">$ACK_K8S_NAMESPACE</span> rollout restart deployment <span class=\"token operator\">&lt;</span>ACK deployment name<span class=\"token operator\">></span></code></pre></div>\n<h2 id=\"create-an-ack-resource\" style=\"position:relative;\"><a href=\"#create-an-ack-resource\" aria-label=\"create an ack resource permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Create an ACK Resource</h2>\n<p><strong>Create an S3 bucket:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_ACCOUNT_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws sts get-caller-identity <span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"Account\"</span> <span class=\"token parameter variable\">--output</span> text<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">BUCKET_NAME</span><span class=\"token operator\">=</span>my-ack-s3-bucket-<span class=\"token variable\">$AWS_ACCOUNT_ID</span>\n<span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">''</span> BUCKET_MANIFEST <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: s3.services.k8s.aws/v1alpha1\nkind: Bucket\nmetadata:\n  name: <span class=\"token variable\">$BUCKET_NAME</span>\nspec:\n  name: <span class=\"token variable\">$BUCKET_NAME</span>\nEOF</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${BUCKET_MANIFEST}</span>\"</span> <span class=\"token operator\">></span> bucket.yaml\nkubectl create <span class=\"token parameter variable\">-f</span> bucket.yaml\nkubectl describe bucket/<span class=\"token variable\">$BUCKET_NAME</span></code></pre></div>\n<p><strong>Update the S3 bucket:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">''</span> BUCKET_MANIFEST <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: s3.services.k8s.aws/v1alpha1\nkind: Bucket\nmetadata:\n  name: <span class=\"token variable\">$BUCKET_NAME</span>\nspec:\n  name: <span class=\"token variable\">$BUCKET_NAME</span>\n  tagging:\n    tagSet:\n    - key: myTagKey\n      value: myTagValue\nEOF</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${BUCKET_MANIFEST}</span>\"</span> <span class=\"token operator\">></span> bucket.yaml\nkubectl apply <span class=\"token parameter variable\">-f</span> bucket.yaml\nkubectl describe bucket/<span class=\"token variable\">$BUCKET_NAME</span></code></pre></div>\n<p><strong>Delete the S3 bucket:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl delete <span class=\"token parameter variable\">-f</span> bucket.yaml\n<span class=\"token comment\"># verify the bucket no longer exists</span>\nkubectl get bucket/<span class=\"token variable\">$BUCKET_NAME</span></code></pre></div>\n<h2 id=\"what-can-we-learn-from-this-exploration\" style=\"position:relative;\"><a href=\"#what-can-we-learn-from-this-exploration\" aria-label=\"what can we learn from this exploration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>What can we learn from this exploration?</h2>\n<p>The ACK service offers significant benefits for managing AWS resources through Kubernetes. However, it is best suited for organizations with advanced proficiency in both AWS and Kubernetes. A strong understanding of these technologies by the DevOps team is crucial for effectively implementing ACK. This includes managing resource separation into namespaces and addressing security concerns related to AWS resource management from Kubernetes.</p>\n<p>To adhere to a \"least privilege\" policy, Kubernetes users should be granted access only to the necessary namespaces. Implementing and maintaining this level of granularity can be challenging in large organizations where teams require access to numerous resources.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":8,"rawMarkdownBody":"\n> **A Path to AWS Service Control in Kubernetes**\n\n## ü§ñ Introduction\n\n[AWS Controllers for Kubernetes (ACK)](https://aws-controllers-k8s.github.io/community/docs/community/overview/) is an open-source project that lets you define and use AWS service resources directly from Kubernetes. This means that you can manage all of your application's resources, including its infrastructure and dependencies, from a single place.\n\nACK works by extending the Kubernetes API with custom resource definitions (CRDs) and custom controllers. These CRDs and controllers allow you to define and manage AWS service resources using the same Kubernetes constructs that you use to manage your application's other resources.\n\nACK makes it easy to take advantage of AWS managed services for your Kubernetes applications. With ACK, you don't need to worry about provisioning or managing the underlying infrastructure for these services. You can simply define the AWS service resources that you need in your Kubernetes cluster, and ACK will take care of the rest.\n\nThis article aims to discover this service and test it by installing a controller within a Kubernetes cluster.\n\n### üåü What is the benefit of ACK?\n\nACK can be considered as an additional abstraction for managing AWS resources that is added to the existing solutions. Today, there are three levels of \"abstraction\" for infrastructure as code:\n\n1. **Level 1**: Infrastructure as code defined as shell scripts. In this category, we can cite the launching of commands via the [AWS CLI](https://aws.amazon.com/cli/).\n2. **Level 2**: The use of tools such as [Puppet](https://puppet.com/), [Terraform](https://www.terraform.io/), [Ansible](https://www.ansible.com/), and [Salt](https://saltproject.io/) to define step by step the infrastructure that we want to put in place.\n3. **Level 3**: We only define the desired final state of the infrastructure. This is the level that ACK belongs to.\n\nCurrently, the use of AWS and Kubernetes represents a design complexity that is not easy to understand. Indeed, these architectures require the articulation of resources with each other in order to allow the general infrastructure to function properly. The understanding of the infrastructure in its entirety is therefore necessary and requires switching very regularly between the different technologies.\n\nAWS offers us this new tool to allow its users to create new resources and control their current state. Thus, the user would only have to define the state of the desired AWS resource, and the controller would take care of bringing the resource from the current state to the desired state.\n\n### ‚öôÔ∏è How ACK works\n\nOur goal with ACK is to provide a consistent Kubernetes interface for AWS, regardless of the AWS service API. One example of this is ensuring field names and identifiers are normalized and tags are handled the same way across AWS resources.\n\n![ACK Workflow](./ack.png)\n\nAs depicted above, from a high level, the ACK workflow is as follows:\n\n1. **Artifact Generation**: We, as in \"the project team led by the authors\", generate and maintain a collection of artifacts (binaries, container images, Helm charts, etc.). These artifacts are automatically derived from the AWS services APIs and represent the business logic of how to manage AWS resources from within Kubernetes.\n2. **Controller Installation**: As a cluster admin, you select one or more ACK controllers you want to install and configure for a cluster you're responsible for.\n3. **Custom Resource Creation**: As an application developer, you create (Kubernetes) custom resources representing AWS resources.\n4. **Resource Management**: The respective ACK controller (installed in step 2) manages said custom resources and with it the underlying AWS resources. Based on the custom resource defined in step 3, the controller creates, updates, or deletes the underlying AWS resources using the AWS APIs.\n\n## üõ†Ô∏è Hands-On for Testing ACK on a Kubernetes Cluster\n\n**Required Tools:**\n\n- üê≥ **Docker**\n- üì¶ **kubectl**\n- üéõÔ∏è **Helm 3**\n- ‚ò∏Ô∏è **eksctl**\n\n### Setting Up the EKS Cluster\n\nTo test this service, quickly set up an EKS Kubernetes cluster using the following command:\n\n```sh\neksctl create cluster --name=ack-demo --nodes=2 --region=eu-west-1\n```\n\nYou can consult the [CloudFormation stack on AWS](https://aws.amazon.com/cloudformation/) to learn more about the resources created previously.\n\n### Installing an ACK Service Controller with Helm (Recommended)\n\nThe recommended way to install an ACK service controller for Kubernetes is to use [Helm 3.8+](https://helm.sh/docs/intro/install/).\n\nEach ACK service controller has a separate Helm chart that installs the necessary supporting artifacts as a Kubernetes Deployment. This includes the ACK service controller, custom resource definitions (CRDs), and Kubernetes Role-Based Access Control (RBAC) manifests.\n\nHelm charts for ACK service controllers can be found in the ACK registry within the [Amazon ECR Public Gallery](https://gallery.ecr.aws/aws-controllers-k8s). To find a Helm chart for a specific service, you can go to `gallery.ecr.aws/aws-controllers-k8s/$SERVICENAME-chart`. For example, the link to the ACK service controller Helm chart for Amazon Simple Storage Service (Amazon S3) is [gallery.ecr.aws/aws-controllers-k8s/s3-chart](https://gallery.ecr.aws/aws-controllers-k8s/s3-chart).\n\nHelm charts for individual ACK service controllers are tagged with their release version. You can find charts for different releases under the **Image tags** section in the chart repository on the ECR Public Gallery.\n\nBefore installing a Helm chart, you can query the controller repository to find the latest release tag. This tag will correspond with a version of the Helm chart and a controller image. Then, you can use the Helm CLI to log into the ECR public Helm registry and install the chart.\n\n```sh\nexport SERVICE=s3\nexport RELEASE_VERSION=$(curl -sL https://api.github.com/repos/aws-controllers-k8s/${SERVICE}-controller/releases/latest | jq -r '.tag_name | ltrimstr(\"v\")')\nexport ACK_SYSTEM_NAMESPACE=ack-system\nexport AWS_REGION=eu-west-1\n\naws ecr-public get-login-password --region us-east-1 | helm registry login --username AWS --password-stdin public.ecr.aws\nhelm install --create-namespace -n $ACK_SYSTEM_NAMESPACE ack-$SERVICE-controller \\\n    oci://public.ecr.aws/aws-controllers-k8s/$SERVICE-chart --version=$RELEASE_VERSION --set=aws.region=$AWS_REGION\n```\n\nThe `helm install` command should return relevant installation information:\n\n```yaml\nNAME: ack-s3-controller\nLAST DEPLOYED: Thu Nov 02 10:30:16 2023\nNAMESPACE: ack-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES: ...\n```\n\nTo verify that the Helm chart was installed, use the `helm list` command:\n\n```sh\nhelm list --namespace $ACK_SYSTEM_NAMESPACE -o yaml\n```\n\n## üîê Configure IAM Permissions\n\n### Set up ACK with IAM Roles for Service Accounts\n\nIAM Roles for Service Accounts (IRSA) is a system that automates the provisioning and rotation of IAM temporary credentials (called a Web Identity) that a Kubernetes ServiceAccount can use to call AWS APIs.\n\nThe primary advantage of IRSA is that Kubernetes Pods which use the ServiceAccount associated with an IAM Role can have a reduced IAM permission footprint compared to the IAM Role in use for the Kubernetes EC2 worker node (known as the EC2 Instance Profile Role). This security concept is known as **Least Privilege**.\n\n### Step 1: Create an OIDC Identity Provider for Your Cluster\n\nCreate an OpenID Connect (OIDC) identity provider for your EKS cluster using the `eksctl utils` command:\n\n```shell\nexport EKS_CLUSTER_NAME=<eks cluster name>\nexport AWS_REGION=<aws region id>\neksctl utils associate-iam-oidc-provider --cluster $EKS_CLUSTER_NAME --region $AWS_REGION --approve\n```\n\nFor detailed instructions, refer to the [Amazon EKS documentation](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html) on how to create an IAM OIDC provider for your cluster.\n\n### Step 2. Create an IAM role and policy for your service¬†account\n\n```shell\n# Update the service name variables as needed\nSERVICE=\"s3\"\nAWS_ACCOUNT_ID=$(aws sts get-caller-identity --query \"Account\" --output text)\nOIDC_PROVIDER=$(aws eks describe-cluster --name $EKS_CLUSTER_NAME --region $AWS_REGION --query \"cluster.identity.oidc.issuer\" --output text | sed -e \"s/^https:\\/\\///\")\nACK_K8S_NAMESPACE=ack-system\n\nACK_K8S_SERVICE_ACCOUNT_NAME=ack-$SERVICE-controller\n\nread -r -d '' TRUST_RELATIONSHIP <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Federated\": \"arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}\"\n      },\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"${OIDC_PROVIDER}:sub\": \"system:serviceaccount:${ACK_K8S_NAMESPACE}:${ACK_K8S_SERVICE_ACCOUNT_NAME}\"\n        }\n      }\n    }\n  ]\n}\nEOF\n\necho \"${TRUST_RELATIONSHIP}\" > trust.json\n\nACK_CONTROLLER_IAM_ROLE=\"ack-${SERVICE}-controller\"\nACK_CONTROLLER_IAM_ROLE_DESCRIPTION=\"IRSA role for ACK ${SERVICE} controller deployment on EKS cluster using Helm charts\"\naws iam create-role --role-name \"${ACK_CONTROLLER_IAM_ROLE}\" --assume-role-policy-document file://trust.json --description \"${ACK_CONTROLLER_IAM_ROLE_DESCRIPTION}\"\nACK_CONTROLLER_IAM_ROLE_ARN=$(aws iam get-role --role-name=$ACK_CONTROLLER_IAM_ROLE --query Role.Arn --output text)\n```\n\n### Attach IAM policy to the IAM role:\n\n```shell\n# Download the recommended managed and inline policies and apply them to the\n# newly created IRSA role\nBASE_URL=https://raw.githubusercontent.com/aws-controllers-k8s/${SERVICE}-controller/main\nPOLICY_ARN_URL=${BASE_URL}/config/iam/recommended-policy-arn\nPOLICY_ARN_STRINGS=\"$(wget -qO- ${POLICY_ARN_URL})\"\n\nINLINE_POLICY_URL=${BASE_URL}/config/iam/recommended-inline-policy\nINLINE_POLICY=\"$(wget -qO- ${INLINE_POLICY_URL})\"\n\nwhile IFS= read -r POLICY_ARN; do\n    echo -n \"Attaching $POLICY_ARN ... \"\n    aws iam attach-role-policy \\\n        --role-name \"${ACK_CONTROLLER_IAM_ROLE}\" \\\n        --policy-arn \"${POLICY_ARN}\"\n    echo \"ok.\"\ndone <<< \"$POLICY_ARN_STRINGS\"\n\nif [ ! -z \"$INLINE_POLICY\" ]; then\n    echo -n \"Putting inline policy ... \"\n    aws iam put-role-policy \\\n        --role-name \"${ACK_CONTROLLER_IAM_ROLE}\" \\\n        --policy-name \"ack-recommended-policy\" \\\n        --policy-document \"$INLINE_POLICY\"\n    echo \"ok.\"\nfi\n```\n\n### Step 3. Associate an IAM role to a service account and restart deployment\n\nIf you installed your [ACK service controller using a Helm chart](https://aws-controllers-k8s.github.io/community/docs/user-docs/install/), then a service account already exists on your cluster.\n\n> However, it is still neccessary to associate an IAM role with the service account.\n\nVerify that your service account exists using kubectl describe:\n\n```shell\nkubectl describe serviceaccount/$ACK_K8S_SERVICE_ACCOUNT_NAME -n $ACK_K8S_NAMESPACE\n```\n\nNote that the Amazon Resource Name (ARN) of the IAM role that you created is not yet set as an annotation for the service account.\n\nUse the following commands to associate an IAM role to a service account:\n\n```shell\n# Annotate the service account with the ARN\nexport IRSA_ROLE_ARN=eks.amazonaws.com/role-arn=$ACK_CONTROLLER_IAM_ROLE_ARN\nkubectl annotate serviceaccount -n $ACK_K8S_NAMESPACE $ACK_K8S_SERVICE_ACCOUNT_NAME $IRSA_ROLE_ARN\n```\n\nRestart ACK service controller deployment using the following commands. The restart will update service controller pods with IRSA environment variables:\n\n```shell\n# Note the deployment name for ACK service controller from following command\nkubectl get deployments -n $ACK_K8S_NAMESPACE\nkubectl -n $ACK_K8S_NAMESPACE rollout restart deployment <ACK deployment name>\n```\n\n## Create an ACK Resource\n\n**Create an S3 bucket:**\n\n```shell\nexport AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query \"Account\" --output text)\nexport BUCKET_NAME=my-ack-s3-bucket-$AWS_ACCOUNT_ID\nread -r -d '' BUCKET_MANIFEST <<EOF\napiVersion: s3.services.k8s.aws/v1alpha1\nkind: Bucket\nmetadata:\n  name: $BUCKET_NAME\nspec:\n  name: $BUCKET_NAME\nEOF\necho \"${BUCKET_MANIFEST}\" > bucket.yaml\nkubectl create -f bucket.yaml\nkubectl describe bucket/$BUCKET_NAME\n```\n\n**Update the S3 bucket:**\n\n```shell\nread -r -d '' BUCKET_MANIFEST <<EOF\napiVersion: s3.services.k8s.aws/v1alpha1\nkind: Bucket\nmetadata:\n  name: $BUCKET_NAME\nspec:\n  name: $BUCKET_NAME\n  tagging:\n    tagSet:\n    - key: myTagKey\n      value: myTagValue\nEOF\n\necho \"${BUCKET_MANIFEST}\" > bucket.yaml\nkubectl apply -f bucket.yaml\nkubectl describe bucket/$BUCKET_NAME\n```\n\n**Delete the S3 bucket:**\n\n```shell\nkubectl delete -f bucket.yaml\n# verify the bucket no longer exists\nkubectl get bucket/$BUCKET_NAME\n```\n\n## What can we learn from this exploration?\n\nThe ACK service offers significant benefits for managing AWS resources through Kubernetes. However, it is best suited for organizations with advanced proficiency in both AWS and Kubernetes. A strong understanding of these technologies by the DevOps team is crucial for effectively implementing ACK. This includes managing resource separation into namespaces and addressing security concerns related to AWS resource management from Kubernetes.\n\nTo adhere to a \"least privilege\" policy, Kubernetes users should be granted access only to the necessary namespaces. Implementing and maintaining this level of granularity can be challenging in large organizations where teams require access to numerous resources.\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  _**Until next time üéâ**_\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1311},"frontmatter":{"id":"b5f9d03f47a346780cf5aede","path":"/blog/aws-controllers-for-kubernetes-ack/","humanDate":"Oct 19, 2024","fullDate":"2024-10-19","title":"AWS Controllers for Kubernetes (ACK): Managing AWS services from Kubernetes","keywords":["AWS EKS","Kubernetes","AWS Controllers for Kubernetes","Cloud-native","Service management"],"excerpt":"How AWS Controllers for Kubernetes (ACK) enables seamless management of AWS services directly from your Kubernetes cluster.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAABBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHipK25HZD/AP/EABgQAQEBAQEAAAAAAAAAAAAAAAEAAgMT/9oACAEBAAEFAi8xGI55cpf/xAAWEQADAAAAAAAAAAAAAAAAAAAQESH/2gAIAQMBAT8BVH//xAAWEQADAAAAAAAAAAAAAAAAAAAQESH/2gAIAQIBAT8BcH//xAAXEAEAAwAAAAAAAAAAAAAAAAARACAh/9oACAEBAAY/AouV/8QAGhAAAwEAAwAAAAAAAAAAAAAAAAEhETFBUf/aAAgBAQABPyHO0UGSc+iLYWyxVfYnT//aAAwDAQACAAMAAAAQYM//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QkGv/xAAXEQADAQAAAAAAAAAAAAAAAAAAARFh/9oACAECAQE/EGwmH//EABwQAQACAgMBAAAAAAAAAAAAAAEAESExQVFhcf/aAAgBAQABPxBLBRPboMW6DmXNsfJqalSZJQNVXnMAyf/Z"},"images":{"fallback":{"src":"/static/337542faae08df3f2211e006ed8e7548/20b93/ack-cover.jpg","srcSet":"/static/337542faae08df3f2211e006ed8e7548/6cce3/ack-cover.jpg 750w,\n/static/337542faae08df3f2211e006ed8e7548/20b93/ack-cover.jpg 800w","sizes":"100vw"},"sources":[{"srcSet":"/static/337542faae08df3f2211e006ed8e7548/d2a19/ack-cover.webp 750w,\n/static/337542faae08df3f2211e006ed8e7548/56f2e/ack-cover.webp 800w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6675}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/k8s-observability-datadaog/","title":"Automate Kubernetes Monitoring with Terraform and Datadog","date":"2024-10-19 21:36:00"},"excerpt":"Infrastructure as Code for K8s Observability: Terraform and Datadog in Action üìå Introduction Datadog is a powerful cloud monitoring‚Ä¶","html":"<blockquote>\n<p><strong>Infrastructure as Code for K8s Observability: Terraform and Datadog in Action</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>Datadog is a powerful cloud monitoring platform that helps you keep an eye on your systems in real-time. It can easily connect with your infrastructure to provide insights into how everything is working. In this guide, we'll show you how to use Datadog along with some helpful tools to monitor a Kubernetes cluster and create custom monitors and dashboards.</p>\n<p>We'll start by setting up a sample Nginx application on your Kubernetes cluster using <a href=\"https://helm.sh/\" target=\"_blank\" rel=\"noopener noreferrer\">Helm</a>. To make sure everything's running smoothly, we'll install the Datadog agent, which will send information about your cluster to your Datadog dashboard. This will help you keep track of what's happening in your cluster and plan your monitoring strategy. By the end of this tutorial, you'll also learn how to create a monitor specifically designed for your Kubernetes cluster using <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>.</p>\n<p>As your responsibilities grow and you manage many applications in production K8s clusters, especially with important applications, having a solid monitoring system is crucial. This system involves tracking performance, capturing logs, and tracing issues.</p>\n<p>In this blog, we'll guide you through the process of setting up a monitoring system, building a dashboard, and effectively managing your Kubernetes infrastructure (often referred to as K8s) using the versatile capabilities of Datadog.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 74.11764705882352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAADBklEQVR42kVT2W4cRRRtvoOP4W94RhGveeQhEjJCKCQRCSYGO1YSx4k9A0jWBMsmeJzZPDOevWd6qe6u6qquXqp6X6Yp5wGOSvft6Nx7Th3p4LjVA8n5jOg42JZ5VhRJEkUhTRO/KFie86osq7LKy21elFWR1VVR11vxtttK+uLrk8+/8T67pz9o0TFCEFHmbwylockNfXPKcWfC1K63quH7zJ2McHRt+l3EO4gPbSZ9t3t6PKS7F8qtSg0H6jZ0sEVsxSPQp4C5xhqDuQM5VVwK5xqUDYiIYxFHRY70e/NPsUMacZsHD7U/drSTOE02sDcDLTtYlGLbLE8Wl0HndaoP67reOOHRPDjToigvpYfPGgoOJmugOO6OdvpAOxaXtdc7rwdf3pr74ro0L0L5Q9w/yM07surGL6a8sY7jvJJ+enbi+AGykMu9++qLe/JuGHLOAsaEYUVZ10xdBp1WMGjz9l/e6nZCvSVGc4ynmEo/PnkHHV+ckWaZEsA1s9OCNUf3X3a/ej/7tqi3zJTd7qvgphH33zF9NjDRtabfQCKTO/Ib23FXssxYkIZRFiY89KfgbGq2oDfPy8q1FvrF97j9Qw2aWRL9vZQ/LOU4F4HV0suDoyjOAICmSWybAgNZFkGmr8qOqbm6Tqi1sj7+hjvPM3AVxWlHEbloqfArz6W9J69CXBprMuuh1YgsB1C+geoS9y/BuG1Nu9CllAU0joIoCgjBxKGMC4Q8DKXHh7+uanJrL86t9pXVvbBvRhwMyWJfbr5RzprgHEKqLsQWvrqkyPQA0FVVhRAihKSn+3taYU+NVdccjdBsjOc6A8DeDJWridFbWkMhZYg/QQOEXUI93xdBfNLmXHr+6JDhcjEGs64xvrYcRan9cSJfVxePtu1f6v6R6qiXZq+PJ//AwdJR0igN78IUI5T2nh56hEPLNYBvwdDGnhcE1PMIdanvC6U4jrMsK0U9tlWapoz9J8yltwc/12U3getK+VgpnZSawvw4jKNIlEvMWBCEsdknJHeN+x//AoUKFwombGQaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/68e50298b63017fa73eb6e1401607a2b/c5bb3/dd.png\" srcset=\"/static/68e50298b63017fa73eb6e1401607a2b/04472/dd.png 170w,\n/static/68e50298b63017fa73eb6e1401607a2b/9f933/dd.png 340w,\n/static/68e50298b63017fa73eb6e1401607a2b/c5bb3/dd.png 680w,\n/static/68e50298b63017fa73eb6e1401607a2b/5a190/dd.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"-prerequisites\" style=\"position:relative;\"><a href=\"#-prerequisites\" aria-label=\" prerequisites permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Prerequisites</h3>\n<p>Before we dive into the tutorial, there are a few things you should have in place:</p>\n<ul>\n<li><strong>Familiarity with Terraform</strong>: This tutorial assumes you have a basic understanding of how Terraform works. If you're new to Terraform, it's a good idea to complete the <a href=\"https://learn.hashicorp.com/collections/terraform/getting-started\" target=\"_blank\" rel=\"noopener noreferrer\">Get Started tutorials</a> to get a grasp of the fundamentals.</li>\n<li><strong>Datadog Trial Account</strong>: You'll need access to a <a href=\"https://www.datadoghq.com/free-datadog-trial/\" target=\"_blank\" rel=\"noopener noreferrer\">Datadog trial account</a>. If you don't have one, you can sign up for a trial on the Datadog website.</li>\n<li><strong>Terraform Installed</strong>: Make sure you have <a href=\"https://learn.hashicorp.com/tutorials/terraform/install-cli\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform installed</a> on your system.</li>\n<li><strong>EKS Cluster</strong>: You should have an Amazon Elastic Kubernetes Service (EKS) cluster set up and running. You can also visit <a href=\"https://eksworkshop.com\" target=\"_blank\" rel=\"noopener noreferrer\">EKS Workshop</a> to learn how to set up.</li>\n<li><strong>Helm</strong>: You should have <a href=\"https://helm.sh/\" target=\"_blank\" rel=\"noopener noreferrer\">Helm</a>, the Kubernetes package manager, installed.</li>\n<li><strong>Basic knowledge of K8s, Docker, and Datadog</strong>.</li>\n<li><strong>kubectl</strong>: to manage the K8s cluster.</li>\n</ul>\n<p>Having these prerequisites in place will ensure you can follow along with the tutorial smoothly.</p>\n<h2 id=\"-retrieve-datadog-api-credentials\" style=\"position:relative;\"><a href=\"#-retrieve-datadog-api-credentials\" aria-label=\" retrieve datadog api credentials permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîë Retrieve Datadog API Credentials</h2>\n<p>After successfully registering for your Datadog trial, it's essential to obtain your <a href=\"https://docs.datadoghq.com/account_management/api-app-keys/#api-keys\" target=\"_blank\" rel=\"noopener noreferrer\">API</a> and <a href=\"https://docs.datadoghq.com/account_management/api-app-keys/#application-keys\" target=\"_blank\" rel=\"noopener noreferrer\">Application keys</a>.</p>\n<ol>\n<li>\n<p><strong>Access your Datadog account</strong> and go to the <strong>API Keys</strong> section located within the <strong>Organization Settings</strong> page.</p>\n<ul>\n<li>Your API key is generated automatically and is obscured for security purposes. To reveal more information about the API key, simply click on it, and then click on the <strong>Copy</strong> button. Make sure to securely save this information in a safe location.</li>\n</ul>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVR42m1Ra2/TQBDMn0Gpkya2z3e+hx9xRR4KRGoKKTRQBFKLIClYLY1TEAKpaj/0X093rxVCgg+j3dvzzc6MW79+XuPrlxrNpsG3i0tcXf3Attni/OIczfcGl5sN6rrG6vMK69X6H5ytzzxOT05we3OLVrgrEfZjOJcjVQZaW/R6IYKgi253Fx0C9zs7nT9otwN/J+IEUSQICZ4EEeYvXqOlZQ6ZpFBSP14KpKlBWVaI6QFDCPlfJPQuCkMU4wPM13f41JBCq0oopZHnJX2gvDpWORyOMCBS7hnGuIf62DOszXxldyq1OFoeo1UVIyI0NDDohwIhKYx5u0z9jJdI6iNSynd/g62yI3bR6XRxeEiWnR5A9HrQIvLoB22kRFAVAxS0OScFKS3QUiGJYsiYIuElRCKJjN1xRJzzgglz9xTTd1vsUwaT0xsMP/zGbG+E5WSMZ1mGoVIYG4OXFMG82sOsKDCl+cRYzKhaytDSYnayWLyiDElh+fwY0zc1qoOPcLP3yCiPPI6RiQSOFDkhfF8QeZY8zPxZSlgi0tr5H7s8eot7lMUYWjGpH6cAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"API Key\" title=\"\" src=\"/static/b9b2d5fabc62aa1e82e0c6ab15e2009e/c5bb3/dd-keys.png\" srcset=\"/static/b9b2d5fabc62aa1e82e0c6ab15e2009e/04472/dd-keys.png 170w,\n/static/b9b2d5fabc62aa1e82e0c6ab15e2009e/9f933/dd-keys.png 340w,\n/static/b9b2d5fabc62aa1e82e0c6ab15e2009e/c5bb3/dd-keys.png 680w,\n/static/b9b2d5fabc62aa1e82e0c6ab15e2009e/5a190/dd-keys.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n</li>\n<li>\n<p><strong>To generate an application key</strong>:</p>\n<ul>\n<li>Click the <strong>Application Keys</strong> on the <strong>Organization Settings</strong> page.</li>\n<li>Click <strong>New Key</strong>, type in <code class=\"language-text\">Terraform</code> as your new application key name, and click <strong>Create Key</strong>. Click <strong>Copy</strong> and save the key somewhere safe.</li>\n</ul>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoklEQVR42l2Qy3ISURRF+28g0O8H9NM0NKTBRwC10NIKJQ0GIxCcODcpLSf5DR36i8tzOzjAwa7d99w++6xztZ8/HlhVH7ndH9jv9hxuD6IvXG827A47trstm+sNyw/LE1XLivVqzUqpWrG4WnDz6TPas9GUZqNFmj4hCEK63QjLdGjrBoZhoYu3ztqcNVsnard0HMfDtl0c18f0EqK0QHs5mWPqtgSFmKaNZTn4foc0OydJMjpBt66p5v9liyzTopMOmN58Z7r8ivZ69hbTcI6E3TpUBcZxWtMG8q1CPaFwJeBEUnOOrkhVhvbuzUKKAWEY1yS6bgldTt4rCKO0fgZFYsggU+7/ea3jRo99BlGUoM1fvZeVLeIoIg4jmewSBR0m5YhenNBPM3LxQjz2fM7ln1TuM6HOhEiRqc3URjXh7HKO5YTE+QW2n6B7MZk0zpKIgWPTt0yG4uPAp/RcRr5H6bs8FXkyXJE2Gs36CerAarFmtrlj+/CH6v4Xi2+/Gc2uyLOMojc4qqDf6z96XhzPBXnep7wYMx4/ZzgseXE54S+4KBf9ysJ62wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Application Key\" title=\"\" src=\"/static/bfe0967ed26e403bfca24c6554543f91/c5bb3/app-key.png\" srcset=\"/static/bfe0967ed26e403bfca24c6554543f91/04472/app-key.png 170w,\n/static/bfe0967ed26e403bfca24c6554543f91/9f933/app-key.png 340w,\n/static/bfe0967ed26e403bfca24c6554543f91/c5bb3/app-key.png 680w,\n/static/bfe0967ed26e403bfca24c6554543f91/5a190/app-key.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n</li>\n</ol>\n<p>üö® <strong>Important</strong>: These keys serve as the credentials that Terraform will use to create monitors and dashboards on your behalf. When used together, they grant complete access to your Datadog account, so it's crucial to handle them with the same level of security as you would a password. <strong>Never share or commit them to version control systems</strong>.</p>\n<h2 id=\"Ô∏è-hands-on-setting-up-the-environment\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-hands-on-setting-up-the-environment\" aria-label=\"Ô∏è hands on setting up the environment permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Hands-on: Setting Up the Environment</h2>\n<h3 id=\"-clone-the-example-repository\" style=\"position:relative;\"><a href=\"#-clone-the-example-repository\" aria-label=\" clone the example repository permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Clone the Example Repository</h3>\n<p>To begin, make sure you're not currently within the <code class=\"language-text\">demo-terraform-k8s-datadog</code> directory created in the EKS cluster tutorial. Next, clone the configuration specific to this tutorial using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/seifrajhi/demo-terraform-k8s-datadog.git</code></pre></div>\n<h3 id=\"-navigate-to-the-repository-directory\" style=\"position:relative;\"><a href=\"#-navigate-to-the-repository-directory\" aria-label=\" navigate to the repository directory permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Navigate to the Repository Directory</h3>\n<p>After cloning the repository, change your working directory to the newly created <code class=\"language-text\">demo-terraform-k8s-datadog</code> folder using:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> demo-terraform-k8s-datadog</code></pre></div>\n<h3 id=\"-deploy-your-kubernetes-application\" style=\"position:relative;\"><a href=\"#-deploy-your-kubernetes-application\" aria-label=\" deploy your kubernetes application permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Deploy Your Kubernetes Application</h3>\n<p>Open the <code class=\"language-text\">terraform.tf</code> configuration file. This file contains information about the minimum versions required for Datadog, Helm, AWS, Kubernetes providers, and Terraform itself.</p>\n<h3 id=\"-edit-the-code-classlanguage-textkubernetestfcode-file\" style=\"position:relative;\"><a href=\"#-edit-the-code-classlanguage-textkubernetestfcode-file\" aria-label=\" edit the code classlanguage textkubernetestfcode file permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Edit the <code class=\"language-text\">kubernetes.tf</code> File</h3>\n<p>Within your file editor, open the <code class=\"language-text\">kubernetes.tf</code> file. This tutorial will guide you through the configuration blocks step by step.</p>\n<h3 id=\"-define-the-kubernetes-namespace\" style=\"position:relative;\"><a href=\"#-define-the-kubernetes-namespace\" aria-label=\" define the kubernetes namespace permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Define the Kubernetes Namespace</h3>\n<p>In the <code class=\"language-text\">kubernetes_namespace</code> block, specify the new namespace you want to create. This namespace will be named after the demo image, and it will be used throughout the rest of the tutorial.</p>\n<p>Notice that the Terraform Kubernetes provider is authenticated using the cluster name provided by the <code class=\"language-text\">demo-terraform-k8s-datadog</code> directory.</p>\n<p>As you can find below, the <code class=\"language-text\">kubernetes_deployment</code> block specifies various aspects, such as the cluster's node count, metadata assignments, and the container image definition. In this setup, it deploys an image named <code class=\"language-text\">demo:datadog</code> which has been specially crafted for use within this tutorial.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_deployment\"</span></span> <span class=\"token string\">\"demo\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>      <span class=\"token punctuation\">=</span> var.application_name\n        <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> kubernetes_namespace.demo.id\n        <span class=\"token property\">labels</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> var.application_name\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">replicas</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">3</span>\n\n        <span class=\"token keyword\">selector</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">match_labels</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> var.application_name\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">template</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">labels</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> var.application_name\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">container</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">image</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"rajhisaifeddine/demo:datadog\"</span>\n                    <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> var.application_name\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We also have the <code class=\"language-text\">kubernetes_service</code> resource which exposes the demo service using a load balancer on port 8080.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_service\"</span></span> <span class=\"token string\">\"demo\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>      <span class=\"token punctuation\">=</span> var.application_name\n        <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> kubernetes_namespace.demo.id\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">selector</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> kubernetes_deployment.demo.metadata<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>.labels.app\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">port</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">port</span>        <span class=\"token punctuation\">=</span> <span class=\"token number\">8080</span>\n            <span class=\"token property\">target_port</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"LoadBalancer\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">application_name</code> variable is defined in the <code class=\"language-text\">variables.tf</code> file and is set to a default value of <code class=\"language-text\">demo</code>.</p>\n<p>Now that you have reviewed the infrastructure, initialize and apply your configuration.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform init\nterraform apply</code></pre></div>\n<p>Verify the namespace.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get namespaces</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">NAME              STATUS        AGE\ndemo              Active        3m</code></pre></div>\n<p>Check if the deployment is created.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get deployment <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>demo</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">NAME        READY    UP-TO-DATE     AVAILABLE           AGE\ndemo        3/3      3              3                   5m</code></pre></div>\n<p>In the next step, you will deploy the Datadog Agent to your Kubernetes cluster as a DaemonSet in order to start collecting your cluster and application metrics, traces, and logs. To do this, you will use the Helm provider to deploy the <a href=\"https://github.com/DataDog/helm-charts/tree/main/charts/datadog\" target=\"_blank\" rel=\"noopener noreferrer\">Datadog Helm chart</a>.</p>\n<h2 id=\"-deploy-the-datadog-agent-to-your-nodes\" style=\"position:relative;\"><a href=\"#-deploy-the-datadog-agent-to-your-nodes\" aria-label=\" deploy the datadog agent to your nodes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üè¥ Deploy the Datadog Agent to Your Nodes</h2>\n<h3 id=\"using-helm\" style=\"position:relative;\"><a href=\"#using-helm\" aria-label=\"using helm permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Using Helm</h3>\n<p>Now, proceed to deploy the Datadog Helm chart. This chart will install the Datadog Agent on all nodes within your cluster by utilizing a DaemonSet.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"helm\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">kubernetes</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">config_path</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"~/.kube/config\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"helm_release\"</span></span> <span class=\"token string\">\"datadog_agent\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog-agent\"</span>\n    <span class=\"token property\">chart</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog\"</span>\n    <span class=\"token property\">repository</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"https://helm.datadoghq.com\"</span>\n    <span class=\"token property\">version</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"3.10.9\"</span>\n    <span class=\"token property\">namespace</span>  <span class=\"token punctuation\">=</span> kubernetes_namespace.demo.id\n\n    <span class=\"token keyword\">set_sensitive</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.apiKey\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> var.datadog_api_key\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.site\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> var.datadog_site\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.logs.enabled\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.logs.containerCollectAll\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.leaderElection\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.collectEvents\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"clusterAgent.enabled\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"clusterAgent.metricsProvider.enabled\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"networkMonitoring.enabled\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"systemProbe.enableTCPQueueLength\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"systemProbe.enableOOMKill\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"securityAgent.runtime.enabled\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadog.hostVolumeMountPropagation\"</span>\n        <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"HostToContainer\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This Helm configuration requires your Datadog API and application keys. Set these values as environment variables in your terminal.</p>\n<p>Run the following command, replacing <code class=\"language-text\">&lt;Your-API-Key></code> with your Datadog API key and <code class=\"language-text\">&lt;Your-App-Key></code> with your Datadog application key you saved earlier.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_datadog_api_key</span><span class=\"token operator\">=</span><span class=\"token string\">\"&lt;Your-API-Key>\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_datadog_app_key</span><span class=\"token operator\">=</span><span class=\"token string\">\"&lt;Your-App-Key>\"</span></code></pre></div>\n<p>Note the URL of the Datadog website and refer to the <a href=\"https://docs.datadoghq.com/getting_started/site/\" target=\"_blank\" rel=\"noopener noreferrer\">Getting Started with Datadog Sites</a> documentation to determine the correct values for the <code class=\"language-text\">datadog_site</code> and <code class=\"language-text\">datadog_api_url</code> variables. This tutorial defaults to using values for site EU1.</p>\n<p>If you are on a different site, set the <code class=\"language-text\">datadog_site</code> and <code class=\"language-text\">datadog_api_url</code> to the values in the Datadog documentation.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_datadog_site</span><span class=\"token operator\">=</span><span class=\"token string\">\"datadoghq.eu\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_datadog_api_url</span><span class=\"token operator\">=</span><span class=\"token string\">\"https://api.datadoghq.eu\"</span></code></pre></div>\n<p>Insert your Datadog key values into the <code class=\"language-text\">variables.tf</code> file. Terraform will then assign these environment variable values to their respective variable declarations.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"datadog_api_key\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n    <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Datadog API Key\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"datadog_app_key\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n    <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Datadog Application Key\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"datadog_site\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n    <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Datadog Site Parameter\"</span>\n    <span class=\"token property\">default</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"datadoghq.eu\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"datadog_api_url\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n    <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Datadog API URL\"</span>\n    <span class=\"token property\">default</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"https://api.datadoghq.eu\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then, apply your configuration.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform apply</code></pre></div>\n<p>You can then see that Datadog has been deployed with 3 main components:</p>\n<ol>\n<li><strong>Datadog Agent DaemonSet</strong>.</li>\n<li><strong>Datadog Cluster-Agent</strong>.</li>\n<li><strong>Datadog Kube-state-metrics (KSM)</strong>: Which is a simple service that listens to the Kubernetes API server and generates metrics about the state of the objects: node status, node capacity (CPU and memory), number of desired/available/unavailable/updated replicas per Deployment, pod status (e.g., waiting, running, ready), and so on.</li>\n</ol>\n<p>To understand about DataDog agents and cluster-agent, let me explain DataDog designs, which can be found in <a href=\"https://www.datadoghq.com/blog/datadog-cluster-agent/\" target=\"_blank\" rel=\"noopener noreferrer\">their official docs.</a></p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 77.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEDBAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHtqSNBIP/EABgQAAMBAQAAAAAAAAAAAAAAAAABISIC/9oACAEBAAEFAqUps0ku0z//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAcEAABAwUAAAAAAAAAAAAAAAAAARARISIygaH/2gAIAQEABj8CfHpckbKH/8QAGhAAAwEAAwAAAAAAAAAAAAAAAAERIVFhof/aAAgBAQABPyF8TAglMktsufqhFrxn/9oADAMBAAIAAwAAABAwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQACAgMBAAAAAAAAAAAAAAEAESFhMUFRwf/aAAgBAQABPxD2O7uCyDR055grlV1ApBhzn8lLBotLt+BcuyoY4utk/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt tetx\" title=\"\" src=\"/static/11ff3b13cfe6904d33a820fff8cd96dc/7bf67/dd-agent.jpg\" srcset=\"/static/11ff3b13cfe6904d33a820fff8cd96dc/651be/dd-agent.jpg 170w,\n/static/11ff3b13cfe6904d33a820fff8cd96dc/d30a3/dd-agent.jpg 340w,\n/static/11ff3b13cfe6904d33a820fff8cd96dc/7bf67/dd-agent.jpg 680w,\n/static/11ff3b13cfe6904d33a820fff8cd96dc/4b190/dd-agent.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"Ô∏è-datadog-cluster-agent-main-features\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-datadog-cluster-agent-main-features\" aria-label=\"Ô∏è datadog cluster agent main features permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üè∑Ô∏è DataDog Cluster Agent Main Features</h2>\n<ul>\n<li><strong>Streamlined Data Collection</strong>: Provides a centralized approach to collecting cluster-level monitoring data.</li>\n<li><strong>Server Load Alleviation</strong>: Acts as a proxy between the API server and node-based Agents, helping to reduce server load.</li>\n<li><strong>Enhanced Metadata</strong>: Relays cluster-level metadata to node-based Agents, allowing them to enrich the metadata of locally collected metrics.</li>\n</ul>\n<h3 id=\"benefits-of-using-the-datadog-cluster-agent\" style=\"position:relative;\"><a href=\"#benefits-of-using-the-datadog-cluster-agent\" aria-label=\"benefits of using the datadog cluster agent permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Benefits of Using the Datadog Cluster Agent</h3>\n<ul>\n<li><strong>Infrastructure Impact Reduction</strong>: Alleviates the impact of Agents on your infrastructure.</li>\n<li><strong>Node Isolation</strong>: Isolates node-based Agents to their respective nodes, reducing RBAC rules to solely read metrics and metadata from the kubelet.</li>\n<li><strong>Cluster-Level Metadata</strong>: Provides cluster-level metadata that can only be found in the API server to the Node Agents, enriching the metadata of the locally collected metrics.</li>\n<li><strong>Cluster-Level Data Collection</strong>: Enables the collection of cluster-level data, such as the monitoring of services or SPOF and events.</li>\n<li><strong>Horizontal Pod Autoscaling</strong>: Leverages Horizontal Pod Autoscaling (HPA) with custom Kubernetes metrics.</li>\n</ul>\n<p>With this setup, the DataDog agent doesn't need to elect a leader pod, and the cluster agent will handle the K8s events collection. The DataDog cluster-agent also provides an <a href=\"https://www.datadoghq.com/blog/autoscale-kubernetes-datadog/\" target=\"_blank\" rel=\"noopener noreferrer\">External Metrics Provider</a> to define HPA based on DataDog metrics (not limited to only CPU/Memory utilization).</p>\n<h2 id=\"-create-a-metric-alert-with-the-datadog-provider\" style=\"position:relative;\"><a href=\"#-create-a-metric-alert-with-the-datadog-provider\" aria-label=\" create a metric alert with the datadog provider permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìä Create a Metric Alert with the Datadog Provider</h2>\n<p>The <a href=\"https://registry.terraform.io/providers/DataDog/datadog/latest/docs/resources/monitor\" target=\"_blank\" rel=\"noopener noreferrer\">datadog_monitor resource</a> will report threshold errors in the Kubernetes pods and notify if any pods go down. Copy and paste the configuration below to <code class=\"language-text\">datadog_metrics.tf</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"datadog\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">api_key</span> <span class=\"token punctuation\">=</span> var.datadog_api_key\n    <span class=\"token property\">app_key</span> <span class=\"token punctuation\">=</span> var.datadog_app_key\n    <span class=\"token property\">api_url</span> <span class=\"token punctuation\">=</span> var.datadog_api_url\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"datadog_monitor\"</span></span> <span class=\"token string\">\"demo\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Kubernetes Pod Health\"</span>\n    <span class=\"token property\">type</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"metric alert\"</span>\n    <span class=\"token property\">message</span>            <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Kubernetes Pods are not in an optimal health state. Notify: @operator\"</span>\n    <span class=\"token property\">escalation_message</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Please investigate the Kubernetes Pods, @operator\"</span>\n\n    <span class=\"token property\">query</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"max(last_1m):sum:kubernetes.containers.running{short_image:beacon} &lt;= 1\"</span>\n\n    <span class=\"token keyword\">monitor_thresholds</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">ok</span>       <span class=\"token punctuation\">=</span> <span class=\"token number\">3</span>\n        <span class=\"token property\">warning</span>  <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n        <span class=\"token property\">critical</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token property\">notify_no_data</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n    <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"app:demo\"</span>, <span class=\"token string\">\"env:demo\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">datadog_monitor.demo</code> resource notifies and escalates the health of the Kubernetes \"beacon\" application. The <code class=\"language-text\">query</code> argument is how Datadog communicates with the pods.</p>\n<ul>\n<li>If all three pods are operational, your Datadog monitor status report is \"OK\".</li>\n<li>If any pods go down, your Datadog monitor status will change to \"Warn\".</li>\n<li>If more than one pod goes down, your Datadog monitor status will change to \"Alert\".</li>\n</ul>\n<p>Apply your configuration to create a new Datadog monitor.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform apply</code></pre></div>\n<p>Navigate to the <a href=\"https://app.datadoghq.com/monitors/manage\" target=\"_blank\" rel=\"noopener noreferrer\">Datadog Monitor page</a>. Your Kubernetes Pod Health monitor is reporting here now.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 75.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVR42pWSy3LUMBBF/QlJkQzxQ89WS/JD0ozt8QwmyTop2LDiK1jy/7THMBkoCpKqu2iX6nTf7utsF/cxpnEYx36YP3w87I/T8TDOUz/0oQ3OOu/8hZyvm93D0+7xU394zG6ucqEbwLZpYu1ba/w4TEoBq4QUmsSZpPqnSiYkjl++TV+/bx8+Z5vrwvqQxvu6GwRXaJzRqCSARouePlf+QqLc3Obvrj26jJegpLYGERC0oVpwzQVwrrQyWgJ1lAJWF2uhFAoBTR2y6k7ShGl/ADAEGzBKWykbKWwMydmaXBCzNFJ4KvBU6AXmBYhKDjEJocuCLXO42j4fmzlZ7Yxxu+1gjUNjQ0i00bo8wV0bM5YrOk/XBf3rSILTYBQIVc4Yk+ez0Ubk4ry8kmaBLbrQRSWVOa1ND4RVBV+HVCUnXRar6DRZseHUmCw1vqULe1uT8+WZiZeE/qYFru4UmQldQnBUuDNcvQIu39N2NsUtGQZN8cJvf8V/YVA4z/cUGK305y/1bzi/5ZTh0O/J85thlmu6E8HUYo3qTbaXqFJMlBMJDVLOr4R/AARleIvZOAyWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/8e010958f7383382f6372799158f4d64/c5bb3/monitor.png\" srcset=\"/static/8e010958f7383382f6372799158f4d64/04472/monitor.png 170w,\n/static/8e010958f7383382f6372799158f4d64/9f933/monitor.png 340w,\n/static/8e010958f7383382f6372799158f4d64/c5bb3/monitor.png 680w,\n/static/8e010958f7383382f6372799158f4d64/5a190/monitor.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"datadog-events\" style=\"position:relative;\"><a href=\"#datadog-events\" aria-label=\"datadog events permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>DataDog Events</h2>\n<p>In this setup, we have already enabled the <a href=\"https://docs.datadoghq.com/containers/kubernetes/configuration/?tab=datadogoperator#enable-kubernetes-event-collection\" target=\"_blank\" rel=\"noopener noreferrer\">K8s Event Collection</a> by setting the <code class=\"language-text\">datadog.leaderElection</code>, <code class=\"language-text\">datadog.collectEvents</code>, and <code class=\"language-text\">agents.rbac.create</code> options to true in the <code class=\"language-text\">values.yaml</code> file.</p>\n<p>This feature instructs the DataDog Cluster Agent to collect the K8s events from the Control Plane and forward them to DataDog. You can easily check what happens to your clusters, why a pod can't be scheduled, or troubleshoot a BackOff container without needing to use <code class=\"language-text\">kubectl get events</code> or <code class=\"language-text\">kubectl describe nodes|pods</code>.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 39.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAByQSD/8QAFRABAQAAAAAAAAAAAAAAAAAAARD/2gAIAQEAAQUCL//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABgQAAMBAQAAAAAAAAAAAAAAAAABESFB/9oACAEBAAE/IYdHnCn/2gAMAwEAAgADAAAAEIvv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAICAwAAAAAAAAAAAAAAAQARIUFRcZH/2gAIAQEAAT8QACsjvMpq8ieK6an/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/29fb4876e18197f30b5365a0c335a941/7bf67/events.jpg\" srcset=\"/static/29fb4876e18197f30b5365a0c335a941/651be/events.jpg 170w,\n/static/29fb4876e18197f30b5365a0c335a941/d30a3/events.jpg 340w,\n/static/29fb4876e18197f30b5365a0c335a941/7bf67/events.jpg 680w,\n/static/29fb4876e18197f30b5365a0c335a941/4b190/events.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>We can easily create dashboards or monitors to watch and notify any K8s events in nearly real-time.</p>\n<h2 id=\"Ô∏è-dashboards\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-dashboards\" aria-label=\"Ô∏è dashboards permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üñºÔ∏è Dashboards</h2>\n<p>The Datadog dashboard is an easily accessible dashboard for your monitors in the Datadog UI, which is useful if you have several monitors and need to group them together for visibility. This configuration contains the dashboard setup for your metrics and synthetics monitors with the <code class=\"language-text\">datadog_dashboard</code> resource.</p>\n<h3 id=\"-types-of-metrics\" style=\"position:relative;\"><a href=\"#-types-of-metrics\" aria-label=\" types of metrics permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìä Types of Metrics</h3>\n<ul>\n<li><strong>Cloud/Cluster Infrastructure Metrics</strong>: EC2, RDS, ElastiCache, etc.</li>\n<li><strong>System Metrics</strong>: OS, CPU, Memory, Disk IOps, Network bandwidth, etc.</li>\n<li><strong>Orchestration (K8s) Metrics</strong>: Node status, deployments/replicaSet/statefulSet, pods (CPU/Mem), PVC size, etc.</li>\n<li><strong>Application Metrics</strong>: HTTP response time, Kafka consumer lag, JVM Heap, Logstash events, Spark job metrics, etc.</li>\n</ul>\n<h3 id=\"-example-dashboard\" style=\"position:relative;\"><a href=\"#-example-dashboard\" aria-label=\" example dashboard permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìà Example Dashboard</h3>\n<p>An example dashboard I created which provides an overview for all running EKS clusters:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUCAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABUWbF5IRGv//EABkQAQADAQEAAAAAAAAAAAAAAAEAAhEQE//aAAgBAQABBQKNXXSWDy5//8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BGf/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAIDAAAAAAAAAAAAAAAAAAAhARBB/9oACAEBAAY/AjRkq//EABoQAAICAwAAAAAAAAAAAAAAAAERACEQUXH/2gAIAQEAAT8hcEAAW3GVQxiR8z//2gAMAwEAAgADAAAAEA/v/8QAFxEAAwEAAAAAAAAAAAAAAAAAARARUf/aAAgBAwEBPxClGL//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QHZ//xAAbEAEAAgMBAQAAAAAAAAAAAAABABEhMVFBcf/aAAgBAQABPxC+hb+yxEHgM7xUGRcLhDDQyC9diUx3P//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Cluster Metrics\" title=\"\" src=\"/static/52bf492e3e452d37aa0012bfb1768437/7bf67/dash1.jpg\" srcset=\"/static/52bf492e3e452d37aa0012bfb1768437/651be/dash1.jpg 170w,\n/static/52bf492e3e452d37aa0012bfb1768437/d30a3/dash1.jpg 340w,\n/static/52bf492e3e452d37aa0012bfb1768437/7bf67/dash1.jpg 680w,\n/static/52bf492e3e452d37aa0012bfb1768437/4b190/dash1.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          \n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUD/8QAFgEBAQEAAAAAAAAAAAAAAAAAAwEC/9oADAMBAAIQAxAAAAGZRMHmIX//xAAYEAACAwAAAAAAAAAAAAAAAAAAAgExMv/aAAgBAQABBQJdSNf/xAAXEQADAQAAAAAAAAAAAAAAAAAAAQIR/9oACAEDAQE/Abpo0//EABURAQEAAAAAAAAAAAAAAAAAAAIQ/9oACAECAQE/AVP/xAAYEAADAQEAAAAAAAAAAAAAAAAAAZExQf/aAAgBAQAGPwJCyHIf/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAEhQVH/2gAIAQEAAT8hfNR8HsGhP//aAAwDAQACAAMAAAAQC+//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/EMBMo//EABYRAQEBAAAAAAAAAAAAAAAAABEAAf/aAAgBAgEBPxDGLN//xAAdEAEAAgICAwAAAAAAAAAAAAABESEAMUFxYYHB/9oACAEBAAE/EEnhh7dnOed7om/d4Yg0Ion3P//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Cluster Metrics\" title=\"\" src=\"/static/fc57a364ceff24d039ca4cc84cef2d58/7bf67/dash2.jpg\" srcset=\"/static/fc57a364ceff24d039ca4cc84cef2d58/651be/dash2.jpg 170w,\n/static/fc57a364ceff24d039ca4cc84cef2d58/d30a3/dash2.jpg 340w,\n/static/fc57a364ceff24d039ca4cc84cef2d58/7bf67/dash2.jpg 680w,\n/static/fc57a364ceff24d039ca4cc84cef2d58/4b190/dash2.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Cluster-metrics graphs</p>\n<p>Datadog supports configuring template variables to quickly filter or query metrics from specific tags or attributes, e.g., subaccount (AWS accounts), k8s_cluster (K8s cluster names), k8s_node (EC2 Worker nodes), k8s_namespace, k8s_deployment, k8s_daemonset, and so on.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 75.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeSuQg//xAAXEAADAQAAAAAAAAAAAAAAAAABEBFB/9oACAEBAAEFAsQFf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABcQAQEBAQAAAAAAAAAAAAAAAAEAEBH/2gAIAQEAAT8hjiDgTn//2gAMAwEAAgADAAAAEBjv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFBUf/aAAgBAQABPxC3V+zFc58hs2IVoiFx8qE//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Template Variables\" title=\"\" src=\"/static/bcab26624c591d9fe214197d07d56be9/7bf67/vars.jpg\" srcset=\"/static/bcab26624c591d9fe214197d07d56be9/651be/vars.jpg 170w,\n/static/bcab26624c591d9fe214197d07d56be9/d30a3/vars.jpg 340w,\n/static/bcab26624c591d9fe214197d07d56be9/7bf67/vars.jpg 680w,\n/static/bcab26624c591d9fe214197d07d56be9/4b190/vars.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Datadog template variables</p>\n<p>You will notice why I'm using 2 different tags to filter the same thing, like <code class=\"language-text\">k8s_namespace</code> and <code class=\"language-text\">k8s_state_namespace</code>. That is because there are 2 sets of metrics gathered by Datadog and being tagged differently:</p>\n<ul>\n<li><code class=\"language-text\">kubernetes.*</code> metrics are collected by Datadog agents/cluster-agent.</li>\n<li><code class=\"language-text\">kubernetes_state.*</code> metrics are gathered from the Kube-state-metrics (KSM) API.</li>\n</ul>\n<p>Besides cluster graphs, I also added system metrics and K8s metrics into the dashboard like this:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 48.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAQAF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAByZAiP//EABgQAAIDAAAAAAAAAAAAAAAAAAERABAx/9oACAEBAAEFAiogzt//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAEBAAMBAAAAAAAAAAAAAAABABExUWH/2gAIAQEAAT8h4SBMidgCBz7Oo3O7/9oADAMBAAIAAwAAABBAz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQEAAgMBAAAAAAAAAAAAAAERACExUWHR/9oACAEBAAE/EEmrfW8ILEoWF+ZBAGA4fcAWae8aut1nPn//2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"System Metrics\" title=\"\" src=\"/static/a5670250d809303066612850e9a40f24/7bf67/dash3.jpg\" srcset=\"/static/a5670250d809303066612850e9a40f24/651be/dash3.jpg 170w,\n/static/a5670250d809303066612850e9a40f24/d30a3/dash3.jpg 340w,\n/static/a5670250d809303066612850e9a40f24/7bf67/dash3.jpg 680w,\n/static/a5670250d809303066612850e9a40f24/4b190/dash3.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          \n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 48.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHOiUMkT//EABgQAAIDAAAAAAAAAAAAAAAAAAABEiBB/9oACAEBAAEFAnE2n//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAIDAQAAAAAAAAAAAAAAAABBAiAxkf/aAAgBAQAGPwLI9EKn/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAERcRBR8P/aAAgBAQABPyHRNYimxrjGPH//2gAMAwEAAgADAAAAEIc//8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/EGR//8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/EG1//8QAHBAAAgICAwAAAAAAAAAAAAAAAREAITFBEHGh/9oACAEBAAE/ECTZDBj7FumOtIJ0nUAFjl//2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"K8s Metrics\" title=\"\" src=\"/static/a367fd18289f525ce33ed9a2015fcd25/7bf67/dash4.jpg\" srcset=\"/static/a367fd18289f525ce33ed9a2015fcd25/651be/dash4.jpg 170w,\n/static/a367fd18289f525ce33ed9a2015fcd25/d30a3/dash4.jpg 340w,\n/static/a367fd18289f525ce33ed9a2015fcd25/7bf67/dash4.jpg 680w,\n/static/a367fd18289f525ce33ed9a2015fcd25/4b190/dash4.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          \n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.705882352941174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABz4uIQWCP/8QAFxAAAwEAAAAAAAAAAAAAAAAAARAhMf/aAAgBAQABBQKMYF//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFX/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAEyEHH/2gAIAQEABj8CghkPH3P/xAAdEAACAQQDAAAAAAAAAAAAAAAAAREQITFBUXHh/9oACAEBAAE/IZgp15Ek5uX0xpe5g6M6X//aAAwDAQACAAMAAAAQiz//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QjH//xAAWEQADAAAAAAAAAAAAAAAAAAABECH/2gAIAQIBAT8QMT//xAAdEAABBAIDAAAAAAAAAAAAAAABABExYSHRQaHw/9oACAEBAAE/ECAQXZnncIkbCAIwqEGcgp2l0S8FBbK//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"K8s Metrics\" title=\"\" src=\"/static/d8f1ca2740d74788a57bfeb462fd4093/7bf67/dash5.jpg\" srcset=\"/static/d8f1ca2740d74788a57bfeb462fd4093/651be/dash5.jpg 170w,\n/static/d8f1ca2740d74788a57bfeb462fd4093/d30a3/dash5.jpg 340w,\n/static/d8f1ca2740d74788a57bfeb462fd4093/7bf67/dash5.jpg 680w,\n/static/d8f1ca2740d74788a57bfeb462fd4093/4b190/dash5.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>You can add more metrics to your dashboard to have more observations on your infrastructure, but I would recommend splitting different layers (Cluster/Orchestrator/System/Application/etc.) into different dashboards. It's because your dashboard UI will become laggy when you're querying a huge metrics subset or huge time range (1 week or 1 month).</p>\n<h2 id=\"Ô∏è-monitors\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-monitors\" aria-label=\"Ô∏è monitors permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üñºÔ∏è Monitors</h2>\n<p>Before creating a monitor, it is important to consider the following:</p>\n<ul>\n<li><strong>Metric Selection</strong>: Identify the key metrics to monitor, such as CPU and memory usage, event drops, error rates, slow HTTP responses, and percentiles.</li>\n<li><strong>Threshold Configuration</strong>: Calculate and set appropriate thresholds, taking into account factors such as minimum and maximum values, averages, sums, and historical trends.</li>\n<li><strong>Metric Labeling</strong>: Tag or label metrics effectively to organize and categorize them.</li>\n<li><strong>Troubleshooting Runbook</strong>: Develop a comprehensive runbook that outlines troubleshooting steps and links to relevant logs for quick issue resolution.</li>\n<li><strong>Alert Notifications</strong>: Configure alert notifications through channels such as Slack or PagerDuty to ensure timely awareness and response.</li>\n</ul>\n<p>The importance of labels or tags is particularly important when creating standardized alerts for core infrastructure components. For example, let's look at how to set up an alert to detect failed pods in a specific namespace.</p>\n<ol>\n<li><strong>Identify the Namespace</strong>: Identify the namespace that you want to monitor.</li>\n<li><strong>Select the Metric</strong>: Select the metric that you want to monitor, such as the number of failed pods.</li>\n<li><strong>Set a Threshold</strong>: Set a threshold for the metric. For example, you might set a threshold of 1 failed pod per minute.</li>\n<li><strong>Tag or Label the Metric</strong>: Tag or label the metric with the namespace name.</li>\n<li><strong>Create a Troubleshooting Runbook</strong>: Create a troubleshooting runbook that outlines the steps to take if the alert is triggered.</li>\n<li><strong>Configure Alert Notifications</strong>: Configure alert notifications to be sent to a channel such as Slack or PagerDuty.</li>\n</ol>\n<p>By following these steps, you can create a monitor that will help you to detect and troubleshoot failed pods in a specific namespace.</p>\n<h3 id=\"-metrics-to-check\" style=\"position:relative;\"><a href=\"#-metrics-to-check\" aria-label=\" metrics to check permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìâ Metrics to Check</h3>\n<ul>\n<li><code class=\"language-text\">kubernetes_state.pod.status</code> with <code class=\"language-text\">phase:failed</code></li>\n</ul>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeTNQgP/xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAR/9oACAEBAAE/IcdQ5//aAAwDAQACAAMAAAAQG+//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPxBX/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QR//EABwQAQABBAMAAAAAAAAAAAAAAAEAEBGBoSExQf/aAAgBAQABPxB4VdzOoNvBxAIXBgDoKf/Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Failed Pods Alert\" title=\"\" src=\"/static/f3948c6d9f476152f7f79e18af6757a9/7bf67/monitor1.jpg\" srcset=\"/static/f3948c6d9f476152f7f79e18af6757a9/651be/monitor1.jpg 170w,\n/static/f3948c6d9f476152f7f79e18af6757a9/d30a3/monitor1.jpg 340w,\n/static/f3948c6d9f476152f7f79e18af6757a9/7bf67/monitor1.jpg 680w,\n/static/f3948c6d9f476152f7f79e18af6757a9/4b190/monitor1.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Sum by: <code class=\"language-text\">kubernetes_cluster</code>, <code class=\"language-text\">cluster_env</code>, and <code class=\"language-text\">namespace</code>‚Ää‚Äî‚Ääthe idea is when a namespace in the cluster has so many failed pods, on-call engineers need to quickly investigate the root cause.</p>\n<h3 id=\"-set-alert-and-warning-thresholds\" style=\"position:relative;\"><a href=\"#-set-alert-and-warning-thresholds\" aria-label=\" set alert and warning thresholds permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üö® Set Alert and Warning Thresholds</h3>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 34.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAcmAFn//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABPyFv/9oADAMBAAIAAwAAABCIH//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABcQAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQEAAT8Q1pRKn//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alert Thresholds\" title=\"\" src=\"/static/f82bdec1be8c1997fabb5ac4994f56ee/7bf67/monitor2.jpg\" srcset=\"/static/f82bdec1be8c1997fabb5ac4994f56ee/651be/monitor2.jpg 170w,\n/static/f82bdec1be8c1997fabb5ac4994f56ee/d30a3/monitor2.jpg 340w,\n/static/f82bdec1be8c1997fabb5ac4994f56ee/7bf67/monitor2.jpg 680w,\n/static/f82bdec1be8c1997fabb5ac4994f56ee/4b190/monitor2.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Metrics tagging/labeling: as above I have defined a list of tags in sum by, Datadog allows us to define alert messages with those variables:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 35.29411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAcmprEBH/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFRABAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQEAAT8hj//aAAwDAQACAAMAAAAQg/8A/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QZ//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/ECf/xAAZEAEAAgMAAAAAAAAAAAAAAAABABExgZH/2gAIAQEAAT8QbpELyzb2f//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alert Message\" title=\"\" src=\"/static/4ac040a125103007fcce0a97f73548a7/7bf67/monitor3.jpg\" srcset=\"/static/4ac040a125103007fcce0a97f73548a7/651be/monitor3.jpg 170w,\n/static/4ac040a125103007fcce0a97f73548a7/d30a3/monitor3.jpg 340w,\n/static/4ac040a125103007fcce0a97f73548a7/7bf67/monitor3.jpg 680w,\n/static/4ac040a125103007fcce0a97f73548a7/4b190/monitor3.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Then you can see the alert message as below:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 28.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAByZAD/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQIf/aAAgBAQABPyFzT//aAAwDAQACAAMAAAAQi+//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEAAgMAAAAAAAAAAAAAAAABACERUWH/2gAIAQEAAT8QariiXuHU/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alert Message Example\" title=\"\" src=\"/static/5b387fe194793d4a8f9adf910a8cddfe/7bf67/monitor4.jpg\" srcset=\"/static/5b387fe194793d4a8f9adf910a8cddfe/651be/monitor4.jpg 170w,\n/static/5b387fe194793d4a8f9adf910a8cddfe/d30a3/monitor4.jpg 340w,\n/static/5b387fe194793d4a8f9adf910a8cddfe/7bf67/monitor4.jpg 680w,\n/static/5b387fe194793d4a8f9adf910a8cddfe/4b190/monitor4.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>@slack-k8s-{{cluster_env.name}}-alerts: We can simply diversify the alerts from the different environment (dev, stage, or prd) to different Slack channels (k8s-dev-alerts or k8s-stg-alerts or k8s-prd-alerts) and only trigger PagerDuty to on-call (@pagerduty-de-infra) if failure happens in a production environment.</p>\n<p>An example alert to Slack will look like this:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 84.70588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAQFAgMG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAGswstc1AFz08UKIH//xAAdEAABAwUBAAAAAAAAAAAAAAADAAIEAQUQETM0/9oACAEBAAEFAt5FFcQZwVC1RPNcOa//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAaEAACAwEBAAAAAAAAAAAAAAABAgAQERJx/9oACAEBAAY/ArDdAbAS27SRfa//xAAeEAAABgIDAAAAAAAAAAAAAAAAARARITFBsWGB8P/aAAgBAQABPyGk2OkIOUwYSkBoTc2PHwn/2gAMAwEAAgADAAAAEFvnAv/EABcRAAMBAAAAAAAAAAAAAAAAAAABMRD/2gAIAQMBAT8QtY9//8QAFREBAQAAAAAAAAAAAAAAAAAAIDH/2gAIAQIBAT8Qg//EAB4QAQEBAAEEAwAAAAAAAAAAAAERACEQQVGhcbHB/9oACAEBAAE/ELbVXk1cWquNmDElIp+YMR4dHa5i8CfLd6X2b2nR/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Slack Alert\" title=\"\" src=\"/static/a2b856c9c69ed7e622d81039d8260c10/7bf67/slack.jpg\" srcset=\"/static/a2b856c9c69ed7e622d81039d8260c10/651be/slack.jpg 170w,\n/static/a2b856c9c69ed7e622d81039d8260c10/d30a3/slack.jpg 340w,\n/static/a2b856c9c69ed7e622d81039d8260c10/7bf67/slack.jpg 680w,\n/static/a2b856c9c69ed7e622d81039d8260c10/4b190/slack.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-clean-up-resources\" style=\"position:relative;\"><a href=\"#-clean-up-resources\" aria-label=\" clean up resources permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üß∏ Clean Up Resources</h2>\n<p>After verifying that the resources were deployed successfully, run <code class=\"language-text\">terraform destroy</code> to destroy them.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform destroy</code></pre></div>\n<h2 id=\"-summary\" style=\"position:relative;\"><a href=\"#-summary\" aria-label=\" summary permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì¶ Summary</h2>\n<p>The fusion of Terraform and Datadog offers a powerful solution for automating Kubernetes monitoring and observability. This dynamic duo allows you to effortlessly manage your infrastructure as code, ensuring that your K8s environment remains finely tuned and well-monitored. With Terraform's declarative approach and Datadog's robust monitoring capabilities, you can easily adapt and scale your Kubernetes infrastructure while gaining valuable insights into its performance. Embracing this combination empowers organizations to streamline operations, enhance efficiency, and proactively address potential issues, making it an essential toolkit for modern Kubernetes management and observability.\n<br></p>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/aws-eks-audit-logs-with-falco/","title":"Monitoring AWS EKS Audit Logs with Falco","date":"2024-10-19 20:44:00"},"excerpt":"üîç Detecting Threats in AWS EKS Audit Logs with Falco üìë Introduction AWS EKS Audit Logs provide a detailed record of all activity on your‚Ä¶","html":"<blockquote>\n<p><strong>üîç Detecting Threats in AWS EKS Audit Logs with Falco</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìë Introduction</h2>\n<p>AWS EKS Audit Logs provide a detailed record of all activity on your EKS cluster, including user actions, API calls, and system events. This information can be used to track changes to your cluster, detect suspicious activity, and troubleshoot problems.</p>\n<p><a href=\"https://github.com/falcosecurity/falco\" target=\"_blank\" rel=\"noopener noreferrer\">Falco</a> is a Kubernetes threat detection engine that can be used to monitor AWS EKS Audit Logs for suspicious activity. Falco uses a <a href=\"https://github.com/falcosecurity/rules/tree/main/rules\" target=\"_blank\" rel=\"noopener noreferrer\">set of rules</a> to detect events that may indicate a security breach or attack. For example, Falco can detect events such as:</p>\n<ul>\n<li>Containers running with elevated privileges</li>\n<li>Containers accessing sensitive files or resources</li>\n<li>Containers communicating with known malicious IP addresses</li>\n</ul>\n<p>By monitoring <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EKS Audit Logs</a> with Falco, you can improve the security of your Kubernetes clusters and detect threats early.</p>\n<p>In this blog post, we will show you how to configure Falco to monitor AWS EKS Audit Logs. We will also discuss some of the benefits of using Falco to monitor EKS Audit Logs.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 36.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAACDUlEQVR42mOwKOzllIwsEuENyBaWis0W1o2qEGT4/5+RgYEBhBkYNp0oYdh6YjfjlhMbgXgzw9aTGxm2nNjDsPlkPFgeqHZ/fT3H/1AV0X8eKuwMokE1pWrxrf8M0rue6SR3fZCObLjGE1opKmqfxSNeP02MYe+l+0xHb/3nOXD1H8Pey/+B+C/D8bv/GfZcPPyfgYEJZOad6hinHzWBn34WOIYx6BbmWhgU5VUZlRbkG5bkFhmXl+TGz18vALZ90U5uoGvuM2w7+T/kzM1fmvsu/GbbevIn466z/xm2nDz0PzSUGaTsbn2szc8Kn7u/8x39GCpP++fWnQ17VHM29GzNmdCrVadDj1YdnCkJUii56QwX49YTDxm2n/mvte/Cv+abj/67H7/2l2Hn+f9MW04c+Zdrxvc/Xp7jYXWUy8/aoCe/C50CGdL2e2bk7g++VXgw/Fj+gZCz2fsCdmeunyrLIF7MLVo/X4Jxy8n7DFtP/Zffc+532sW7f/QPXPzFsP0syMDDq6AuvF8d7fCz2O3dj1ybEIbUPW45BYeC7pccCj9dfDjsUu6BwCP1u5ZJgRSKg7y859J9hkM3/nPsv/KXde+l/6x7L/5lOHobGJYXDv2HRtz9+niLH/WhZ34XOnswoINVq/4z16+6wgYX2HKikGHL8d0MoFjeDIxlIA3lx8JiOXTVKmZoymAAAPgm+4ttz4gCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Falco Monitoring\" title=\"\" src=\"/static/6b26c20fde210a0ab7fd79618a35d4f0/c5bb3/falco.png\" srcset=\"/static/6b26c20fde210a0ab7fd79618a35d4f0/04472/falco.png 170w,\n/static/6b26c20fde210a0ab7fd79618a35d4f0/9f933/falco.png 340w,\n/static/6b26c20fde210a0ab7fd79618a35d4f0/c5bb3/falco.png 680w,\n/static/6b26c20fde210a0ab7fd79618a35d4f0/5a190/falco.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"Ô∏è-falco-what-is-it-and-how-it-works\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-falco-what-is-it-and-how-it-works\" aria-label=\"Ô∏è falco what is it and how it works permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Falco: What is it and How it Works</h2>\n<p>Falco is a Kubernetes threat detection engine. Falco supports Kubernetes <a href=\"https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#audit-backends\" target=\"_blank\" rel=\"noopener noreferrer\">Audit Events</a> to track the changes defined in k8s audit rules made to your cluster.</p>\n<p>Unfortunately, AWS EKS is a managed Kubernetes service, and it only can send audit logs to CloudWatch. This means there is no direct way for Falco to inspect the EKS audit events. We need to implement a solution to ship audit logs from CloudWatch to Falco.</p>\n<p>There are three solutions:</p>\n<ol>\n<li><a href=\"https://github.com/sysdiglabs/ekscloudwatch\" target=\"_blank\" rel=\"noopener noreferrer\">EKS CloudWatch</a></li>\n<li><a href=\"https://github.com/xebia/falco-eks-audit-bridge\" target=\"_blank\" rel=\"noopener noreferrer\">Falco EKS Audit Bridge</a> (Not recommended due to complexity and additional setup requirements like S3 bucket and AWS Kinesis Firehose service)</li>\n<li><a href=\"https://github.com/falcosecurity/plugins/tree/master/plugins/k8saudit-eks#kubernetes-audit-events-plugin-for-eks\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Audit Events Plugin for EKS</a>: This plugin supports consuming Kubernetes Audit Events stored in CloudWatch Logs for the EKS Clusters.</li>\n</ol>\n<h2 id=\"-prerequisites\" style=\"position:relative;\"><a href=\"#-prerequisites\" aria-label=\" prerequisites permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Prerequisites</h2>\n<p><strong>üîß Enable Audit in EKS Cluster</strong>\nEnsure that audit logging is enabled in your EKS cluster:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 21.764705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVR42l1OCQ6DIBD0//9UBOSsXFGcsqRY200mcxBmd1LGQMgNUm1gXGAVArz5eeWQnEGuS9dcSmhrYZzrsB9+grJJaY1lYZgZg/MvlJyRCCk1Tsi3zl0PH2LsupSCfQ9gbanSBpNpF3rvUWvFdV0YQ963BfhG94QQW8n+k9Hf4zio0MJah/M8W1h7EYE8XU88sufbfzYK3yyXNgWEnXsaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Audit\" title=\"\" src=\"/static/c09294aae650fe17226120f00ff83bd5/c5bb3/audit-enabled.png\" srcset=\"/static/c09294aae650fe17226120f00ff83bd5/04472/audit-enabled.png 170w,\n/static/c09294aae650fe17226120f00ff83bd5/9f933/audit-enabled.png 340w,\n/static/c09294aae650fe17226120f00ff83bd5/c5bb3/audit-enabled.png 680w,\n/static/c09294aae650fe17226120f00ff83bd5/5a190/audit-enabled.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p><strong>üîê Enable IAM Roles for Service Accounts (IRSA)</strong></p>\n<p><a href=\"https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html\" target=\"_blank\" rel=\"noopener noreferrer\">Enable IAM Roles for Service Accounts (IRSA)</a> on the EKS cluster if you have not enabled it yet:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 78.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABu0lEQVR42p2U3Y6CQAyF5/3fxZt9FO+8WMAfFEYUARF/6fI1WzKadTdZkpNGpj1zelp0dduJLxtJi0aqppWqqmS/38tut5OyLKUoCvHejxE0TSOn00mOx+MIfvM473OJ40jW61SSOFaiLMskz3PZbrca0zQdztcaV6uVbDYbjfP5XJbLpYKavu/FcTMJ3ICix+Mh/32UkPbqun56eT6f5XK5KDm43+9P78i53W6K76Kx3iEb0EKSJNqiwdQS+U03XI7PvIujSD4XC/GTiaQfH5INHTpa7bpuBEpe2+4DBaaad9FAiH/F4F82eHw4HMRxEBa8EoUwot8eFw+Tnc1mOlGGwpQBvqGeyaKaKU+nU7UH3y0XVW3b6jkeO9sndisEh5hOhBwCigB+4iNkwOy6Xq/iMJkdAqFCBmB7yIUUopY8fOMMZQAB8EDqSOZWDGYf7VYDl9jgrNXwDDuePMRkWqI18Nfivg7RhgWHLjbSacWk4w2wfQthSokhqGe4dOvwCE9o10w3kGjfMYu/GJaYXGrMd/vuiXjv8IEiCFGLJ+9ALsQ2kPCDQCk5ujZMFNifw0/AHzyGiHV6l/MFRnPMxdpZnAYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"IRSA\" title=\"\" src=\"/static/141cc86bea8fc0c7b02045c5644df6c7/c5bb3/irsa.png\" srcset=\"/static/141cc86bea8fc0c7b02045c5644df6c7/04472/irsa.png 170w,\n/static/141cc86bea8fc0c7b02045c5644df6c7/9f933/irsa.png 340w,\n/static/141cc86bea8fc0c7b02045c5644df6c7/c5bb3/irsa.png 680w,\n/static/141cc86bea8fc0c7b02045c5644df6c7/5a190/irsa.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-install-falco-server\" style=\"position:relative;\"><a href=\"#-install-falco-server\" aria-label=\" install falco server permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Install Falco Server</h2>\n<p>The deployment of Falco in a Kubernetes cluster is managed through a Helm chart. This chart handles all the Kubernetes objects needed by Falco to be seamlessly integrated into your environment.</p>\n<p>Based on the configuration in the <code class=\"language-text\">values.yaml</code> file, the chart will render and install the required Kubernetes objects. Keep in mind that Falco can be deployed in your cluster using either a DaemonSet or a Deployment.</p>\n<h3 id=\"Ô∏è-kernel-version-check\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-kernel-version-check\" aria-label=\"Ô∏è kernel version check permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ö†Ô∏è Kernel Version Check</h3>\n<p>Before installing Falco in a Kubernetes cluster, ensure that the kernel version used in the nodes is supported by the community. Also, before reporting any issues with Falco (e.g., missing kernel image, <code class=\"language-text\">CrashLoopBackOff</code>), make sure to read about the driver section and adjust your setup as required.</p>\n<h3 id=\"-adding-falcosecurity-repository\" style=\"position:relative;\"><a href=\"#-adding-falcosecurity-repository\" aria-label=\" adding falcosecurity repository permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì• Adding FalcoSecurity Repository</h3>\n<p>Before installing the chart, add the FalcoSecurity charts repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">helm repo <span class=\"token function\">add</span> falcosecurity https://falcosecurity.github.io/charts\nhelm repo update</code></pre></div>\n<h2 id=\"-adding-falco-security-repository\" style=\"position:relative;\"><a href=\"#-adding-falco-security-repository\" aria-label=\" adding falco security repository permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì• Adding Falco Security Repository</h2>\n<p>Before installing the chart, add the Falco Security charts repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">helm repo <span class=\"token function\">add</span> falcosecurity https://falcosecurity.github.io/charts\nhelm repo update</code></pre></div>\n<h2 id=\"-installing-the-chart\" style=\"position:relative;\"><a href=\"#-installing-the-chart\" aria-label=\" installing the chart permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Installing the Chart</h2>\n<p>To install the chart with the release name <code class=\"language-text\">falco</code> in namespace <code class=\"language-text\">falco</code>, run:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">helm <span class=\"token function\">install</span> falco falcosecurity/falco <span class=\"token parameter variable\">--namespace</span> falco <span class=\"token punctuation\">\\</span>\n--create-namespace --values-k8saudit.yaml</code></pre></div>\n<h3 id=\"code-classlanguage-textvalues-k8saudityamlcode-configuration\" style=\"position:relative;\"><a href=\"#code-classlanguage-textvalues-k8saudityamlcode-configuration\" aria-label=\"code classlanguage textvalues k8saudityamlcode configuration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><code class=\"language-text\">values-k8saudit.yaml</code> Configuration</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># -- Disable the drivers since we want to deploy only the k8saudit plugin.</span>\n<span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token comment\"># -- Disable the collectors, no syscall events to enrich with metadata.</span>\n<span class=\"token key atrule\">collectors</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token comment\"># -- Deploy Falco as a deployment. One instance of Falco is enough. Anyway the number of replicas is configurable.</span>\n<span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> deployment\n    <span class=\"token key atrule\">deployment</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n<span class=\"token key atrule\">falcoctl</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">artifact</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">follow</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">artifact</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">resolveDeps</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n                <span class=\"token key atrule\">refs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">-</span>rules<span class=\"token punctuation\">:</span><span class=\"token number\">0.6</span><span class=\"token punctuation\">]</span>\n            <span class=\"token key atrule\">follow</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">refs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">-</span>rules<span class=\"token punctuation\">:</span><span class=\"token number\">0.6</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> k8saudit<span class=\"token punctuation\">-</span>webhook\n        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9765</span>\n                <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30007</span>\n                <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n\n<span class=\"token key atrule\">falco</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">rules_file</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> /etc/falco/k8s_audit_rules.yaml\n        <span class=\"token punctuation\">-</span> /etc/falco/rules.d\n    <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> k8saudit\n            <span class=\"token key atrule\">library_path</span><span class=\"token punctuation\">:</span> libk8saudit.so\n            <span class=\"token key atrule\">init_config</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n            <span class=\"token key atrule\">open_params</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://:9765/k8s-audit\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> json\n            <span class=\"token key atrule\">library_path</span><span class=\"token punctuation\">:</span> libjson.so\n            <span class=\"token key atrule\">init_config</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">load_plugins</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">]</span></code></pre></div>\n<p>For more details, refer to the <a href=\"https://github.com/falcosecurity/charts/tree/master/charts/falco\" target=\"_blank\" rel=\"noopener noreferrer\">Falco Helm Chart documentation</a>.</p>\n<p>After a few minutes, Falco instances should be running on all your nodes. The status of Falco pods can be inspected through <code class=\"language-text\">kubectl</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kubectl get pods <span class=\"token parameter variable\">-n</span> falco <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>If everything went smoothly, you should observe an output similar to the following, indicating that all Falco instances are up and running in your cluster.</p>\n<p>Helm will also expose a service with the Helm application name prefix. It is <code class=\"language-text\">falco</code> in this deployment.</p>\n<h3 id=\"-eks-cloudwatch-forward-eks-cloudwatch-k8s-audit-events-to-sysdig\" style=\"position:relative;\"><a href=\"#-eks-cloudwatch-forward-eks-cloudwatch-k8s-audit-events-to-sysdig\" aria-label=\" eks cloudwatch forward eks cloudwatch k8s audit events to sysdig permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì° EKS CloudWatch: Forward EKS CloudWatch k8s Audit Events to Sysdig</h3>\n<p>The following instructions show how to deploy a simple application that reads EKS Kubernetes audit logs and forwards them to the Sysdig Secure agent. The steps below show an example configuration implemented with the AWS console, but the same can be done with scripts, API calls, or Infrastructure-as-Code configurations.</p>\n<p>These instructions have been tested with <code class=\"language-text\">eks.5</code> on Kubernetes <code class=\"language-text\">v1.14</code>.</p>\n<h4 id=\"Ô∏è-eks-setup-enable-cloudwatch-audit-logs\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-eks-setup-enable-cloudwatch-audit-logs\" aria-label=\"Ô∏è eks setup enable cloudwatch audit logs permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è EKS Setup: Enable CloudWatch Audit Logs</h4>\n<p>Your EKS cluster needs to be configured to forward audit logs to CloudWatch, which is disabled by default.</p>\n<ol>\n<li>Open the EKS dashboard from the <a href=\"https://aws.amazon.com/console/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS console</a>.</li>\n<li>Select your cluster > Logging > Update and enable Audit.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 60.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABIElEQVR42p2S2W6DMBBF+f/va6pGSVhih802ixeQgOTW47Sob6lj6YCE0fXMGSeV7HATA1g7gLcduBhxKhVYLcHKCmnBwasGsh8guv4liep7nC8pjqczCsbw+XXElZfQ1mLUGsM4hrex5h9YJF0IvATyosDH4YBbWcJNE6xzT6zzP79GG4OEUpVSqOoajHOkWQYpJdZ1xbIsUYQK6UEBeZ7D+BPu93sAj0c0zneTUJmj99Q0rW/Nhr1t296C9CQknDwKqYIrbWzAEDaOkRxShbX3l6bZ3u4vb1VIyUJIFFfmW9f7ZJ2bni4jFt2Mn0DhHTaY5zlsPLxIInbtgWWrIFUXpkQfp2ne79/ir09UIDlkUiMrrtB+QLT+eoyplAK/AeoTodd8VxyQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Audit\" title=\"\" src=\"/static/5a501609e9082a97414b7c2bc66c0273/c5bb3/audit-enable.png\" srcset=\"/static/5a501609e9082a97414b7c2bc66c0273/04472/audit-enable.png 170w,\n/static/5a501609e9082a97414b7c2bc66c0273/9f933/audit-enable.png 340w,\n/static/5a501609e9082a97414b7c2bc66c0273/c5bb3/audit-enable.png 680w,\n/static/5a501609e9082a97414b7c2bc66c0273/5a190/audit-enable.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h4 id=\"-eks-setup-configure-the-vpc-endpoint\" style=\"position:relative;\"><a href=\"#-eks-setup-configure-the-vpc-endpoint\" aria-label=\" eks setup configure the vpc endpoint permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê EKS Setup: Configure the VPC Endpoint</h4>\n<p>Your VPC needs an endpoint for the service <code class=\"language-text\">com.amazonaws.&lt;your-region>.logs</code>, accessible from all the EKS security groups.</p>\n<ol>\n<li>Open the VPC dashboard from the <a href=\"https://aws.amazon.com/console/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS console</a>.</li>\n<li>Select <strong>Endpoints</strong> > <strong>Create Endpoints</strong>.</li>\n<li>Select <strong>Find service by name</strong>, enter <code class=\"language-text\">com.amazonaws.&lt;your-region>.logs</code> and click \"Verify\".</li>\n<li>Under VPC, select your cluster's VPC.</li>\n<li>Select all security groups.</li>\n</ol>\n<h4 id=\"Ô∏è-eks-setup-configure-ec2-instance-profiles-and-roles\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-eks-setup-configure-ec2-instance-profiles-and-roles\" aria-label=\"Ô∏è eks setup configure ec2 instance profiles and roles permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è EKS Setup: Configure EC2 Instance Profiles and Roles</h4>\n<p>The EC2 instances that make up your EKS cluster must have the necessary permission to read CloudWatch logs. Usually, they all use the same IAM Role, so that is the one to configure.</p>\n<ol>\n<li>Open the EC2 dashboard from the <a href=\"https://aws.amazon.com/console/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS console</a>.</li>\n<li>Select the AWS EC2 instances that are configured as cluster nodes.</li>\n<li>Select the associated IAM Role, which should be the same for all nodes.</li>\n<li>Find the policy <code class=\"language-text\">CloudWatchReadOnlyAccess</code> and attach it.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 36.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABSUlEQVR42l1QCY7kIAzM//+30oy2002aHEA65HIgF6kx7M6hsVQyGGNXVdb3FkUhMAwD9n3HFYAQLlzXN2L8PH/G754YWWsHvOUSWmnM0wjvHZxbsCwLZpphbQdjDF6vF7quS1lrjbZt0/0n4ls2zQQpcrz/zSFKDdkYyNpAaQPxeKCuawghcL/foZRKn/I8x+12Q1mWkFKmHJfExdnJErdJQZoRD7PgoQl68DjOMzXFzeu6Jpxci9H3PZqm+UJVVWnYOI7IDvbLDzUK1UPwwGdLoPVAYDMjI2ttkk9E2NjjwH61zDIOafg9It5fvDgNpO1Exz69VxP+lIS3mtDRgWkNEJVGwfLNQFCWYGnj+gWpWPazxl02uBUVnk2L0Z0YfYiSA3bWHVmRPzD7HdsRcEbm64bFuf/MkBDr67anunOeswctji369+cD1xcV33FYKMQAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"policy\" title=\"\" src=\"/static/bb67def59e5fb74c6a74a4afb162d237/c5bb3/policy.png\" srcset=\"/static/bb67def59e5fb74c6a74a4afb162d237/04472/policy.png 170w,\n/static/bb67def59e5fb74c6a74a4afb162d237/9f933/policy.png 340w,\n/static/bb67def59e5fb74c6a74a4afb162d237/c5bb3/policy.png 680w,\n/static/bb67def59e5fb74c6a74a4afb162d237/5a190/policy.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Configure IAM role and policy for¬†IRSA:\nCreate a policy called ekscloudwatch-eks-cw-policy then create a role with a Trust Relationship for and attach the policy above which is called ekscloudwatch-eks-cw-role in this deployment</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token title important\"><span class=\"token punctuation\">##</span> üõ†Ô∏è IAM Policy for CloudWatch Logs Access</span>\n\nTo allow your EKS cluster to read CloudWatch logs, create the following IAM policy:\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"logs:List<span class=\"token italic\"><span class=\"token punctuation\">*</span><span class=\"token content\">\",\n                \"logs:Get</span><span class=\"token punctuation\">*</span></span>\",\n                \"logs:FilterLogEvents\",\n                \"logs:Describe<span class=\"token italic\"><span class=\"token punctuation\">*</span><span class=\"token content\">\",\n                \"cloudwatch:List</span><span class=\"token punctuation\">*</span></span>\",\n                \"cloudwatch:Get<span class=\"token italic\"><span class=\"token punctuation\">*</span><span class=\"token content\">\",\n                \"cloudwatch:Describe</span><span class=\"token punctuation\">*</span></span>\"\n            ],\n            \"Resource\": \"arn:aws:logs:<span class=\"token italic\"><span class=\"token punctuation\">*</span><span class=\"token content\">:</span><span class=\"token punctuation\">*</span></span>:log-group:/aws/eks/*\"\n        }\n    ]\n}</code></pre></div>\n<h2 id=\"-iam-role-for-service-account\" style=\"position:relative;\"><a href=\"#-iam-role-for-service-account\" aria-label=\" iam role for service account permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê IAM Role for Service Account</h2>\n<p>Edit the following trust relationship for the IAM role <code class=\"language-text\">ekscloudwatch-eks-cw-role</code> to allow the service account in the <code class=\"language-text\">falco</code> namespace to assume the role:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Federated\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:iam::12345678910:oidc-provider/oidc.eks.eu-west-1.amazonaws.com/id/1847B92748AB2A2XYZ\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRoleWithWebIdentity\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Condition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"StringEquals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"oidc.eks.eu-west-1.amazonaws.com/id/1847B92748AB2A2XYZ:sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"system:serviceaccount:falco:ekscloudwatch\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"-kubernetes-configuration\" style=\"position:relative;\"><a href=\"#-kubernetes-configuration\" aria-label=\" kubernetes configuration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìÑ Kubernetes Configuration</h2>\n<p>Edit the following Kubernetes resources to configure the service account, config map, and deployment for forwarding EKS CloudWatch logs to Falco.</p>\n<h3 id=\"service-account\" style=\"position:relative;\"><a href=\"#service-account\" aria-label=\"service account permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Service Account</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> falco\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"arn:aws:iam::12345678910:role/ekscloudwatch-eks-cw-role\"</span></code></pre></div>\n<h3 id=\"configmap\" style=\"position:relative;\"><a href=\"#configmap\" aria-label=\"configmap permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ConfigMap</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch<span class=\"token punctuation\">-</span>config\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> falco\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">endpoint</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://falco-k8saudit-webhook:9765/k8s-audit\"</span>\n  <span class=\"token key atrule\">cw_polling</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5m\"</span>\n  <span class=\"token key atrule\">cw_filter</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'{ $.sourceIPs[0] != \"::1\" &amp;&amp; $.sourceIPs[0] != \"127.0.0.1\" }'</span>\n  <span class=\"token key atrule\">cluster_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-eks-cluster\"</span>\n  <span class=\"token key atrule\">aws_region</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"eu-west-1\"</span></code></pre></div>\n<h3 id=\"deployment\" style=\"position:relative;\"><a href=\"#deployment\" aria-label=\"deployment permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deployment</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> eks<span class=\"token punctuation\">-</span>cloudwatch\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> falco\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">minReadySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> eks<span class=\"token punctuation\">-</span>cloudwatch\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> eks<span class=\"token punctuation\">-</span>cloudwatch\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> ekscloudwatch\n      <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">fsGroup</span><span class=\"token punctuation\">:</span> <span class=\"token number\">65534</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> sysdiglabs/k8sauditlogforwarder<span class=\"token punctuation\">:</span>ekscloudwatch<span class=\"token punctuation\">-</span><span class=\"token number\">0.3</span>\n          <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Always\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> eks<span class=\"token punctuation\">-</span>cloudwatch<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ENDPOINT\n              <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">configMapKeyRef</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch<span class=\"token punctuation\">-</span>config\n                  <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> endpoint\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CLUSTER_NAME\n              <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">configMapKeyRef</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch<span class=\"token punctuation\">-</span>config\n                  <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> cluster_name\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AWS_REGION\n              <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">configMapKeyRef</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch<span class=\"token punctuation\">-</span>config\n                  <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> aws_region\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CW_POLLING\n              <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">configMapKeyRef</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch<span class=\"token punctuation\">-</span>config\n                  <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> cw_polling\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CW_FILTER\n              <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">configMapKeyRef</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ekscloudwatch<span class=\"token punctuation\">-</span>config\n                  <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> cw_filter</code></pre></div>\n<ol>\n<li>Edit the value of <code class=\"language-text\">eks.amazonaws.com/role-arn</code> in the ServiceAccount with your role ARN:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"arn:aws:iam::12345678910:role/ekscloudwatch-eks-cw-role\"</span></code></pre></div>\n<ol start=\"2\">\n<li>Edit <code class=\"language-text\">cluster_name: \"my-eks-cluster\"</code> with your cluster name in the ConfigMap.</li>\n<li>Edit <code class=\"language-text\">endpoint: \"http://falco-k8saudit-webhook:9765/k8s-audit\"</code> if you installed Falco with a different name than <code class=\"language-text\">falco</code>.</li>\n<li>Don't forget to set your region <code class=\"language-text\">aws_region</code>. If you don't set it, <code class=\"language-text\">ekscloudwatch</code> will call EC2 IMDSv1 to get the region name.</li>\n</ol>\n<p>Deploy <code class=\"language-text\">ekscloudwatch</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kubectl apply <span class=\"token parameter variable\">-f</span> <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>You can get details of the rules at: <a href=\"https://github.com/falcosecurity/rules/tree/main/rules\" target=\"_blank\" rel=\"noopener noreferrer\">Falco Security Rules</a>.</p>\n<h2 id=\"kubernetes-audit-events-plugin-for-eks\" style=\"position:relative;\"><a href=\"#kubernetes-audit-events-plugin-for-eks\" aria-label=\"kubernetes audit events plugin for eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes Audit Events Plugin for EKS</h2>\n<p>This plugin extends Falco to support Kubernetes Audit Events from AWS EKS clusters as a new data source. For more details about what Audit logs are, see the <a href=\"https://github.com/falcosecurity/plugins/blob/main/plugins/k8saudit/README.md\" target=\"_blank\" rel=\"noopener noreferrer\">README of k8saudit plugin</a>.</p>\n<h3 id=\"functionality\" style=\"position:relative;\"><a href=\"#functionality\" aria-label=\"functionality permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Functionality</h3>\n<p>This plugin supports consuming Kubernetes Audit Events stored in CloudWatch Logs for the EKS Clusters. See the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS official documentation</a> for details.</p>\n<h3 id=\"capabilities\" style=\"position:relative;\"><a href=\"#capabilities\" aria-label=\"capabilities permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Capabilities</h3>\n<p>The <code class=\"language-text\">k8saudit-eks</code> uses the field extraction methods of the <code class=\"language-text\">k8saudit</code> plugin as the format for the Audit Logs is the same.</p>\n<h3 id=\"event-source\" style=\"position:relative;\"><a href=\"#event-source\" aria-label=\"event source permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Event Source</h3>\n<p>The event source for Kubernetes Audit Events from EKS is <code class=\"language-text\">k8s_audit</code>. It allows using the same rules as the <code class=\"language-text\">k8saudit</code> plugin.</p>\n<h3 id=\"configuration\" style=\"position:relative;\"><a href=\"#configuration\" aria-label=\"configuration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Configuration</h3>\n<p>Here's an example of the configuration in <code class=\"language-text\">falco.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> k8saudit<span class=\"token punctuation\">-</span>eks\n    <span class=\"token key atrule\">library_path</span><span class=\"token punctuation\">:</span> libk8saudit<span class=\"token punctuation\">-</span>eks.so\n    <span class=\"token key atrule\">init_config</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"eu-west-1\"</span>\n      <span class=\"token key atrule\">profile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"default\"</span>\n      <span class=\"token key atrule\">shift</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token key atrule\">polling_interval</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token key atrule\">use_async</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n      <span class=\"token key atrule\">buffer_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500</span>\n    <span class=\"token key atrule\">open_params</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-cluster\"</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> json\n    <span class=\"token key atrule\">library_path</span><span class=\"token punctuation\">:</span> libjson.so\n    <span class=\"token key atrule\">init_config</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n<span class=\"token key atrule\">load_plugins</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">-</span>eks<span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">]</span></code></pre></div>\n<h2 id=\"Ô∏è-initialization-config\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-initialization-config\" aria-label=\"Ô∏è initialization config permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚öôÔ∏è Initialization Config</h2>\n<ul>\n<li><strong>profile</strong>: The Profile to use to create the session, env var <code class=\"language-text\">AWS_PROFILE</code> if present.</li>\n<li><strong>region</strong>: The Region of your EKS cluster, env var <code class=\"language-text\">AWS_REGION</code> is used if present.</li>\n<li><strong>use_async</strong>: If true, then async extraction optimization is enabled (Default: true).</li>\n<li><strong>polling_interval</strong>: Polling Interval in seconds (default: 5s).</li>\n<li><strong>shift</strong>: Time shift in past in seconds (default: 1s).</li>\n<li><strong>buffer_size</strong>: Buffer Size (default: 200).</li>\n</ul>\n<h2 id=\"-open-parameters\" style=\"position:relative;\"><a href=\"#-open-parameters\" aria-label=\" open parameters permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîß Open Parameters</h2>\n<p>A string which contains the name of your EKS Cluster (required).</p>\n<h2 id=\"-rules\" style=\"position:relative;\"><a href=\"#-rules\" aria-label=\" rules permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìú Rules</h2>\n<p>The <code class=\"language-text\">k8saudit-eks</code> plugin ships with no default rule for test purposes. You can use the same rules as those for the <code class=\"language-text\">k8saudit</code> plugin. See <a href=\"https://github.com/falcosecurity/plugins/tree/master/plugins/k8saudit\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>To test if it works, you can use this example rule:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">required_engine_version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">15</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">required_plugin_versions</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> k8saudit<span class=\"token punctuation\">-</span>eks\n        <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> 0.2.0\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> Dummy rule\n    <span class=\"token key atrule\">desc</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n        Dummy rule</span>\n    <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n        ka.verb in (get,create,delete,update)</span>\n    <span class=\"token key atrule\">output</span><span class=\"token punctuation\">:</span> user=%ka.user.name verb=%ka.verb target=%ka.target.name target.namespace=%ka.target.namespace resource=%ka.target.resource\n    <span class=\"token key atrule\">priority</span><span class=\"token punctuation\">:</span> WARNING\n    <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> k8s_audit\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">]</span></code></pre></div>\n<h2 id=\"-aws-iam-policy-permissions\" style=\"position:relative;\"><a href=\"#-aws-iam-policy-permissions\" aria-label=\" aws iam policy permissions permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê AWS IAM Policy Permissions</h2>\n<p>This plugin retrieves Kubernetes audit events from Amazon CloudWatch Logs and therefore needs appropriate permissions to perform these actions. If you use a profile or associate a role to the service account in Kubernetes with an OIDC provider, you need to grant it permissions.</p>\n<p>Here is an AWS IAM policy document that satisfies the requirements:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ReadAccessToCloudWatchLogs\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"logs:Describe*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"logs:FilterLogEvents\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"logs:Get*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"logs:List*\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"arn:aws:logs:${REGION}:${ACCOUNT_ID}:log-group:/aws/eks/${CLUSTER_NAME}/cluster:*\"</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Replace the placeholders <code class=\"language-text\">REGION</code>, <code class=\"language-text\">ACCOUNT_ID</code>, and <code class=\"language-text\">CLUSTER_NAME</code> with appropriate values.</p>\n<h2 id=\"Ô∏è-running-locally\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-running-locally\" aria-label=\"Ô∏è running locally permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üñ•Ô∏è Running Locally</h2>\n<p>This plugin requires Falco with version >= 0.35.0.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">falco <span class=\"token parameter variable\">-c</span> falco.yaml <span class=\"token parameter variable\">-r</span> rules/k8s_audit_rules.yaml\n<span class=\"token number\">17</span>:48:41.067076000: Warning <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span>eks:certificate-controller <span class=\"token assign-left variable\">verb</span><span class=\"token operator\">=</span>get <span class=\"token assign-left variable\">target</span><span class=\"token operator\">=</span>eks-certificates-controller <span class=\"token assign-left variable\">target.namespace</span><span class=\"token operator\">=</span>kube-system <span class=\"token assign-left variable\">resource</span><span class=\"token operator\">=</span>configmapsEvents detected: <span class=\"token number\">1</span>\nRule counts by severity:\n     WARNING: <span class=\"token number\">1</span>\nTriggered rules by rule name:\n     Dummy rule: <span class=\"token number\">1</span>\nSyscall event drop monitoring:\n     - event drop detected: <span class=\"token number\">0</span> occurrences\n     - num <span class=\"token builtin class-name\">times</span> actions taken: <span class=\"token number\">0</span></code></pre></div>\n<p>For more details, refer to the <a href=\"https://falco.org/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">Falco documentation</a>.</p>\n<h2 id=\"running-in-eks\" style=\"position:relative;\"><a href=\"#running-in-eks\" aria-label=\"running in eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Running in EKS</h2>\n<p>When running Falco with the <code class=\"language-text\">k8saudit-eks</code> plugin in a Kubernetes cluster, you can't have more than one pod at once. The plugin pulls the logs from CloudWatch Logs, and having multiple instances will lead to multiple gatherings of the same logs and the duplication of alerts.</p>\n<p>You can use the official Falco Helm chart to deploy it with the <code class=\"language-text\">k8saudit-eks</code> plugin as a single replica deployment. You can also use it to associate the IAM role you created (see <a href=\"https://github.com/falcosecurity/plugins/tree/master/plugins/k8saudit-eks#aws-iam-policy-permissions\" target=\"_blank\" rel=\"noopener noreferrer\">AWS IAM Policy Permissions</a>).</p>\n<h3 id=\"example-code-classlanguage-textvaluesyamlcode\" style=\"position:relative;\"><a href=\"#example-code-classlanguage-textvaluesyamlcode\" aria-label=\"example code classlanguage textvaluesyamlcode permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Example <code class=\"language-text\">values.yaml</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">tty</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">kubernetes</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span> <span class=\"token comment\"># Disable the collection of k8s metadata</span>\n<span class=\"token key atrule\">falco</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">rules_file</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> /etc/falco/k8s_audit_rules.yaml <span class=\"token comment\"># Rules to use</span>\n        <span class=\"token punctuation\">-</span> /etc/falco/rules.d\n    <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> k8saudit<span class=\"token punctuation\">-</span>eks\n            <span class=\"token key atrule\">library_path</span><span class=\"token punctuation\">:</span> libk8saudit<span class=\"token punctuation\">-</span>eks.so\n            <span class=\"token key atrule\">init_config</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>REGION<span class=\"token punctuation\">}</span> <span class=\"token comment\"># Replace with your region</span>\n                <span class=\"token key atrule\">shift</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n                <span class=\"token key atrule\">polling_interval</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n                <span class=\"token key atrule\">use_async</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n                <span class=\"token key atrule\">buffer_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500</span>\n            <span class=\"token key atrule\">open_params</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>CLUSTER_NAME<span class=\"token punctuation\">}</span> <span class=\"token comment\"># Replace with your cluster name</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> json\n            <span class=\"token key atrule\">library_path</span><span class=\"token punctuation\">:</span> libjson.so\n            <span class=\"token key atrule\">init_config</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">load_plugins</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">-</span>eks<span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">]</span> <span class=\"token comment\"># Plugins to load</span>\n<span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span> <span class=\"token comment\"># Disable the collection of syscalls</span>\n<span class=\"token key atrule\">collectors</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span> <span class=\"token comment\"># Disable the collection of container metadata</span>\n<span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> deployment\n    <span class=\"token key atrule\">deployment</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token comment\"># Single replica deployment to avoid duplication of alerts</span>\n<span class=\"token key atrule\">falcoctl</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Use falcoctl to install automatically the plugin and the rules</span>\n    <span class=\"token key atrule\">indexes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> falcosecurity\n        <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//falcosecurity.github.io/falcoctl/index.yaml\n    <span class=\"token key atrule\">artifact</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">follow</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">artifact</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">allowedTypes</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> plugin\n                <span class=\"token punctuation\">-</span> rulesfile\n            <span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">resolveDeps</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n                <span class=\"token key atrule\">refs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">-</span>rules<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> k8saudit<span class=\"token punctuation\">-</span>eks<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n            <span class=\"token key atrule\">follow</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">refs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>k8saudit<span class=\"token punctuation\">-</span>rules<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token key atrule\">serviceAccount</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>ACCOUNT_ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>role/$<span class=\"token punctuation\">{</span>ROLE<span class=\"token punctuation\">}</span> <span class=\"token comment\"># If you use an OIDC provider, you can attach a role to the service account</span></code></pre></div>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìù Conclusion</h2>\n<p>To enhance your <a href=\"https://sysdig.com/solutions/container-and-kubernetes-security/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes security strategy</a>, it is important to be attentive to new features and improvements, incorporating those that will let you gain visibility into suspicious events or misconfigurations like Kubernetes audit log events.</p>\n<p>The information gathered in these logs can be very useful to understand what is going on in our cluster and can even be required for compliance purposes. Tuning the rules with care and using less verbose mode when required can also help us lower costs when using a SaaS centralized logging solution.</p>\n<p>But what really makes a difference here is the use of Falco as a threat detection engine. Choosing it to be your webhook backend is the first step towards enforcing <a href=\"https://sysdig.com/s-kubernetes-security-guide/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes security best practices</a>, detecting misuse, and filling the gap between what you think the cluster is running and what's actually running.</p>\n<p>For more details, refer to the <a href=\"https://falco.org/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">Falco documentation</a>.</p>\n<p>If you would like to find out more about Falco:</p>\n<ul>\n<li>Get started in <a href=\"http://falco.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Falco.org</a></li>\n<li>Check out the <a href=\"https://github.com/falcosecurity/falco\" target=\"_blank\" rel=\"noopener noreferrer\">Falco project in GitHub</a>.</li>\n<li>Get involved in the <a href=\"https://falco.org/community\" target=\"_blank\" rel=\"noopener noreferrer\">Falco community</a>.</li>\n<li>Meet the maintainers on the <a href=\"https://kubernetes.slack.com/?redir=%2Farchives%2FCMWH3EH32\" target=\"_blank\" rel=\"noopener noreferrer\">Falco Slack</a>.</li>\n<li>Follow @falco_org on <a href=\"https://twitter.com/falco_org\" target=\"_blank\" rel=\"noopener noreferrer\">X/Twitter</a>.</li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}