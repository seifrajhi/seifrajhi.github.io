{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/k8s-dynamic-resource-allocation-dra/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Dynamic Resource Allocation (DRA) in Kubernetes</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìö Introduction</h2>\n<p>Dynamic Resource Allocation (DRA) is a new API for requesting resources in Kubernetes, introduced to enable networking technologies. This blog post explores the concept of DRA, its importance, and how it enhances resource management in Kubernetes.</p>\n<h2 id=\"what-is-dynamic-resource-allocation-dra\" style=\"position:relative;\"><a href=\"#what-is-dynamic-resource-allocation-dra\" aria-label=\"what is dynamic resource allocation dra permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>What is Dynamic Resource Allocation (DRA)?</h2>\n<p>Dynamic Resource Allocation (DRA) is a new API for requesting resources in Kubernetes, allowing for more flexible and efficient allocation of resources such as GPUs or network devices to workloads.</p>\n<h2 id=\"why-is-there-a-need-for-device-plugins-in-kubernetes\" style=\"position:relative;\"><a href=\"#why-is-there-a-need-for-device-plugins-in-kubernetes\" aria-label=\"why is there a need for device plugins in kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Why is there a need for Device Plugins in Kubernetes?</h2>\n<p>Device Plugins are needed in Kubernetes because Kubernetes does not natively support specialized hardware like GPUs or network interfaces. Device Plugins help to utilize these resources within Kubernetes workloads.</p>\n<h2 id=\"limitations-of-the-device-plugin-framework\" style=\"position:relative;\"><a href=\"#limitations-of-the-device-plugin-framework\" aria-label=\"limitations of the device plugin framework permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Limitations of the Device Plugin Framework</h2>\n<p>The Device Plugin framework has limitations such as not supporting shared resources, difficulty in handling unlimited resources, and a lack of support for advanced configurations for different instances of the same resource.</p>\n<h2 id=\"how-dra-solves-device-plugin-framework-issues\" style=\"position:relative;\"><a href=\"#how-dra-solves-device-plugin-framework-issues\" aria-label=\"how dra solves device plugin framework issues permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>How DRA Solves Device Plugin Framework Issues</h2>\n<p>DRA solves the issues with the Device Plugin framework by providing a more flexible and vendor-controlled approach to resource allocation, allowing for shared resources, no requirement for pre-defining resource limits, and advanced configurations for each resource instance.</p>\n<h2 id=\"-storage-options-in-kubernetes\" style=\"position:relative;\"><a href=\"#-storage-options-in-kubernetes\" aria-label=\" storage options in kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üíæ Storage Options in Kubernetes</h2>\n<p>Storage options in Kubernetes include scratch space for temporary data and persistent storage solutions like NFS mounts and CSI (Container Storage Interface).</p>\n<h2 id=\"-device-plugins-and-their-constraints\" style=\"position:relative;\"><a href=\"#-device-plugins-and-their-constraints\" aria-label=\" device plugins and their constraints permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîå Device Plugins and Their Constraints</h2>\n<p>Device plugins are necessary for utilizing specialized hardware within Kubernetes, but they have constraints that DRA aims to overcome.</p>\n<h2 id=\"-key-concepts-in-dra\" style=\"position:relative;\"><a href=\"#-key-concepts-in-dra\" aria-label=\" key concepts in dra permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Key Concepts in DRA</h2>\n<p>The Array API introduces concepts like <strong>DeviceClass</strong>, <strong>ResourceClaim</strong>, <strong>ResourceClaimTemplates</strong>, and <strong>ResourceSlice</strong>, providing more control and flexibility.</p>\n<h3 id=\"deviceclass\" style=\"position:relative;\"><a href=\"#deviceclass\" aria-label=\"deviceclass permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>DeviceClass</h3>\n<p>A <code class=\"language-text\">DeviceClass</code> defines the characteristics of a device. It specifies the driver and parameters for a device, providing a structured way to request resources. Here is an example of a <code class=\"language-text\">DeviceClass</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> resource.k8s.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> DeviceClass\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> device.com\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selectors</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cel</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">expression</span><span class=\"token punctuation\">:</span> device.driver == \"device.com\"</code></pre></div>\n<h3 id=\"resourceclaim\" style=\"position:relative;\"><a href=\"#resourceclaim\" aria-label=\"resourceclaim permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ResourceClaim</h3>\n<p>A <code class=\"language-text\">ResourceClaim</code> is analogous to a Persistent Volume Claim (PVC) but for device resources. It is a request for a specific type of resource and is used to allocate resources to a pod. Here is an example of a <code class=\"language-text\">ResourceClaim</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> resource.k8s.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ResourceClaim\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> claim1\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">devices</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gpu\n      <span class=\"token key atrule\">deviceClassName</span><span class=\"token punctuation\">:</span> device.com</code></pre></div>\n<h3 id=\"resourceclaimtemplate\" style=\"position:relative;\"><a href=\"#resourceclaimtemplate\" aria-label=\"resourceclaimtemplate permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ResourceClaimTemplate</h3>\n<p>A <code class=\"language-text\">ResourceClaimTemplate</code> is used to generate <code class=\"language-text\">ResourceClaim</code> objects. When a pod references a <code class=\"language-text\">ResourceClaimTemplate</code>, a new <code class=\"language-text\">ResourceClaim</code> is generated for each entry in the pod spec's <code class=\"language-text\">resourceClaims</code> section. Here is an example of a <code class=\"language-text\">ResourceClaimTemplate</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> resource.k8s.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ResourceClaimTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> claim1\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">devices</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gpu\n        <span class=\"token key atrule\">deviceClassName</span><span class=\"token punctuation\">:</span> device.com</code></pre></div>\n<h3 id=\"resourceslice\" style=\"position:relative;\"><a href=\"#resourceslice\" aria-label=\"resourceslice permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ResourceSlice</h3>\n<p>A <code class=\"language-text\">ResourceSlice</code> represents a slice of resources available on a node. It is used to manage and allocate resources to <code class=\"language-text\">ResourceClaims</code>. Here is an example of a <code class=\"language-text\">ResourceSlice</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> resource.k8s.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ResourceSlice\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> slice1\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">devices</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">basic</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">attributes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">family</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">string</span><span class=\"token punctuation\">:</span> Arc\n        <span class=\"token key atrule\">model</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">string</span><span class=\"token punctuation\">:</span> A770\n      <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 16288Mi\n        <span class=\"token key atrule\">millicores</span><span class=\"token punctuation\">:</span> 1k\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 0000<span class=\"token punctuation\">-</span>03<span class=\"token punctuation\">-</span>00<span class=\"token punctuation\">-</span>0<span class=\"token punctuation\">-</span><span class=\"token number\">0x56a0</span>\n  <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> device.com\n  <span class=\"token key atrule\">nodeName</span><span class=\"token punctuation\">:</span> node1\n  <span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">generation</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pool1\n    <span class=\"token key atrule\">resourceSliceCount</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></code></pre></div>\n<p>Here is an example of a pod specification that uses Dynamic Resource Allocation (DRA):</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>claim\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> with<span class=\"token punctuation\">-</span>resource\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> xxxxx\n  <span class=\"token key atrule\">resourceClaims</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> resource\n    <span class=\"token key atrule\">resourceClaimName</span><span class=\"token punctuation\">:</span> zzzz</code></pre></div>\n<p>In this example:</p>\n<ul>\n<li>The pod is named <code class=\"language-text\">test-claim</code>.</li>\n<li>It has a single container named <code class=\"language-text\">with-resource</code> that uses the specified image.</li>\n<li>The pod references a <code class=\"language-text\">ResourceClaim</code> named <code class=\"language-text\">zzzz</code> through the <code class=\"language-text\">resourceClaims</code> field, ensuring that the required resources are allocated and available for the pod.</li>\n</ul>\n<h2 id=\"-allocation-process-in-dra\" style=\"position:relative;\"><a href=\"#-allocation-process-in-dra\" aria-label=\" allocation process in dra permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìù Allocation Process in DRA</h2>\n<p>The allocation process in DRA can occur immediately or be delayed until a pod referencing the resource claim is created, influencing pod scheduling.</p>\n<h2 id=\"Ô∏è-implementing-a-dra-driver\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-implementing-a-dra-driver\" aria-label=\"Ô∏è implementing a dra driver permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Implementing a DRA Driver</h2>\n<p>Implementing a DRA driver involves defining a name, CRDs, coordination mechanisms, and providing implementations for the controller and node plugin.</p>\n<h2 id=\"resource-drivers\" style=\"position:relative;\"><a href=\"#resource-drivers\" aria-label=\"resource drivers permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Resource Drivers</h2>\n<p>In the context of Dynamic Resource Allocation (DRA) in Kubernetes, a <strong>resource driver</strong> is a component that manages the allocation and deallocation of specific types of resources, such as GPUs, network devices, or other specialized hardware. The resource driver is responsible for:</p>\n<ol>\n<li><strong>Discovery</strong>: Identifying and reporting the available resources on each node in the Kubernetes cluster.</li>\n<li><strong>Allocation</strong>: Handling requests for resources from pods and allocating the appropriate resources to meet those requests.</li>\n<li><strong>Preparation</strong>: Preparing the allocated resources for use by the pods, which may involve configuring the hardware or setting up necessary software components.</li>\n<li><strong>Unpreparation</strong>: Cleaning up and releasing the resources when they are no longer needed by the pods.</li>\n</ol>\n<p>The resource driver typically consists of two main components:</p>\n<ol>\n<li><strong>Controller</strong>: A centralized component that coordinates with the Kubernetes scheduler to decide which nodes can service incoming resource claims. It handles the creation and management of <code class=\"language-text\">ResourceClaim</code> and <code class=\"language-text\">ResourceSlice</code> objects.</li>\n<li><strong>Node Plugin</strong>: A daemon running on each node that interacts with the hardware to perform discovery, allocation, preparation, and unpreparation of resources. It reports the available resources to the controller and ensures that the resources are correctly configured for use by the pods.</li>\n</ol>\n<p>The resource driver uses Custom Resource Definitions (CRDs) such as <code class=\"language-text\">ResourceClass</code>, <code class=\"language-text\">ResourceClaim</code>, <code class=\"language-text\">ResourceClaimTemplate</code>, and <code class=\"language-text\">ResourceSlice</code> to define and manage the resources within the Kubernetes cluster. These CRDs provide a standardized way to request, allocate, and manage resources, enabling more flexible and efficient resource management.</p>\n<h2 id=\"-container-device-interface-cdi\" style=\"position:relative;\"><a href=\"#-container-device-interface-cdi\" aria-label=\" container device interface cdi permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîó Container Device Interface (CDI)</h2>\n<p><strong>CDI (Container Device Interface)</strong> is a specification for exposing devices to containers, which is utilized by container runtimes like containerd and CRI-O. It introduces an abstract notion of a device as a resource. Such devices are uniquely specified by a fully-qualified name that is constructed from a vendor ID, a device class, and a name that is unique per vendor ID-device class pair.</p>\n<h2 id=\"requirements\" style=\"position:relative;\"><a href=\"#requirements\" aria-label=\"requirements permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Requirements</h2>\n<ul>\n<li>Kubernetes 1.31+, with <code class=\"language-text\">DynamicResourceAllocation</code> feature-flag enabled, and other cluster parameters</li>\n<li>Container runtime needs to support CDI:\n<ul>\n<li>CRI-O v1.23.0 or newer</li>\n<li>Containerd v1.7 or newer</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"enable-cdi-in-containerd\" style=\"position:relative;\"><a href=\"#enable-cdi-in-containerd\" aria-label=\"enable cdi in containerd permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Enable CDI in Containerd</h3>\n<p>Containerd has CDI enabled by default since version 2.0. For older versions (1.7 and above) CDI has to be enabled in Containerd config by enabling <code class=\"language-text\">enable_cdi</code> and <code class=\"language-text\">cdi_specs_dir</code>. Example <code class=\"language-text\">/etc/containerd/config.toml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token key property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key property\">enable_cdi</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token key property\">cdi_specs_dir</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/etc/cdi\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/var/run/cdi\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h2 id=\"limitations\" style=\"position:relative;\"><a href=\"#limitations\" aria-label=\"limitations permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Limitations</h2>\n<ul>\n<li>Currently max 640 GPUs can be requested for one resource claim (10 PCIe devices, each with 64 SR-IOV VFs = 640 VFs on the same node).</li>\n<li>v0.6.0 only supports K8s v1.31 which does not have partitionable devices support, therefore this release does not support dynamic GPU SR-IOV configuration.</li>\n<li>v0.6.0 does not support classic DRA and only relies on Structured Parameters DRA.</li>\n<li>v0.6.0 drops Alertmanager web-hook used for (experimental) GPU health management support.</li>\n</ul>\n<h2 id=\"enabling-dynamic-resource-allocation\" style=\"position:relative;\"><a href=\"#enabling-dynamic-resource-allocation\" aria-label=\"enabling dynamic resource allocation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Enabling Dynamic Resource Allocation</h2>\n<p>Dynamic resource allocation is an alpha feature and only enabled when the <code class=\"language-text\">DynamicResourceAllocation</code> feature gate and the <code class=\"language-text\">resource.k8s.io/v1alpha3</code> API group are enabled. For details on that, see the <code class=\"language-text\">--feature-gates</code> and <code class=\"language-text\">--runtime-config</code> kube-apiserver parameters. kube-scheduler, kube-controller-manager, and kubelet also need the feature gate.</p>\n<p>When a resource driver uses a control plane controller, then the <code class=\"language-text\">DRAControlPlaneController</code> feature gate has to be enabled in addition to <code class=\"language-text\">DynamicResourceAllocation</code>.</p>\n<p>A quick check whether a Kubernetes cluster supports the feature is to list <code class=\"language-text\">DeviceClass</code> objects with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get deviceclasses</code></pre></div>\n<p>If your cluster supports dynamic resource allocation, the response is either a list of <code class=\"language-text\">DeviceClass</code> objects or:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">No resources found</code></pre></div>\n<p>If not supported, this error is printed instead:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">error: the server doesn't have a resource <span class=\"token builtin class-name\">type</span> <span class=\"token string\">\"deviceclasses\"</span></code></pre></div>\n<p>A control plane controller is supported when it is possible to create a <code class=\"language-text\">ResourceClaim</code> where the <code class=\"language-text\">spec.controller</code> field is set. When the <code class=\"language-text\">DRAControlPlaneController</code> feature is disabled, that field automatically gets cleared when storing the <code class=\"language-text\">ResourceClaim</code>.</p>\n<p>The default configuration of kube-scheduler enables the \"DynamicResources\" plugin if and only if the feature gate is enabled and when using the v1 configuration API. Custom configurations may have to be modified to include it.</p>\n<p>In addition to enabling the feature in the cluster, a resource driver also has to be installed. Please refer to the driver's documentation for details.</p>\n<h3 id=\"scheduling-details\" style=\"position:relative;\"><a href=\"#scheduling-details\" aria-label=\"scheduling details permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Scheduling Details</h3>\n<p>When using a control plane controller, the resource driver handles the allocation of resources in cooperation with the Kubernetes scheduler. The scheduler checks all <code class=\"language-text\">ResourceClaims</code> needed by a pod and creates a <code class=\"language-text\">PodSchedulingContext</code> object, informing the resource drivers about nodes that are considered suitable for the pod. The resource drivers respond by excluding nodes that don't have enough resources left. Once the scheduler has this information, it selects a node and stores the choice in the <code class=\"language-text\">PodSchedulingContext</code> object. The resource drivers then allocate the resources, and the pod gets scheduled. Without a control plane controller, the scheduler uses structured parameters to allocate resources directly from <code class=\"language-text\">ResourceSlice</code> objects, tracking which resources have been allocated and selecting from the remaining resources.</p>\n<h3 id=\"monitoring-resources\" style=\"position:relative;\"><a href=\"#monitoring-resources\" aria-label=\"monitoring resources permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Monitoring Resources</h3>\n<p>The kubelet provides a gRPC service to enable the discovery of dynamic resources for running pods. This service allows resource drivers to report the availability and status of resources on each node. The gRPC endpoints provide detailed information about the resources allocated to each pod, helping administrators monitor and manage resource usage effectively. This monitoring capability is crucial for ensuring that resources are being used efficiently and for troubleshooting any issues that may arise with resource allocation.</p>\n<h3 id=\"pre-scheduled-pods\" style=\"position:relative;\"><a href=\"#pre-scheduled-pods\" aria-label=\"pre scheduled pods permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Pre-scheduled Pods</h3>\n<p>When a pod is created with the <code class=\"language-text\">spec.nodeName</code> field already set, the scheduler is bypassed. If the required <code class=\"language-text\">ResourceClaims</code> for the pod do not exist, are not allocated, or are not reserved, the kubelet will fail to run the pod and periodically re-check until the requirements are fulfilled. This situation can occur due to version skew, configuration issues, or feature gate settings. The kube-controller-manager detects such scenarios and attempts to make the pod runnable by triggering the allocation and reservation of the required <code class=\"language-text\">ResourceClaims</code>. However, it is generally better to avoid bypassing the scheduler to prevent resource blocking and ensure efficient resource allocation.</p>\n<h2 id=\"-references\" style=\"position:relative;\"><a href=\"#-references\" aria-label=\" references permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîó References</h2>\n<ul>\n<li><a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a></li>\n<li><a href=\"https://kubernetes-csi.github.io/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">Container Storage Interface (CSI)</a></li>\n<li><a href=\"https://github.com/container-orchestrated-devices/container-device-interface\" target=\"_blank\" rel=\"noopener noreferrer\">Container Device Interface (CDI)</a></li>\n</ul>","timeToRead":7,"rawMarkdownBody":"> **Dynamic Resource Allocation (DRA) in Kubernetes**\n\n## üìö Introduction\n\nDynamic Resource Allocation (DRA) is a new API for requesting resources in Kubernetes, introduced to enable networking technologies. This blog post explores the concept of DRA, its importance, and how it enhances resource management in Kubernetes.\n\n\n## What is Dynamic Resource Allocation (DRA)?\n\nDynamic Resource Allocation (DRA) is a new API for requesting resources in Kubernetes, allowing for more flexible and efficient allocation of resources such as GPUs or network devices to workloads.\n\n## Why is there a need for Device Plugins in Kubernetes?\n\nDevice Plugins are needed in Kubernetes because Kubernetes does not natively support specialized hardware like GPUs or network interfaces. Device Plugins help to utilize these resources within Kubernetes workloads.\n\n## Limitations of the Device Plugin Framework\n\nThe Device Plugin framework has limitations such as not supporting shared resources, difficulty in handling unlimited resources, and a lack of support for advanced configurations for different instances of the same resource.\n\n## How DRA Solves Device Plugin Framework Issues\n\nDRA solves the issues with the Device Plugin framework by providing a more flexible and vendor-controlled approach to resource allocation, allowing for shared resources, no requirement for pre-defining resource limits, and advanced configurations for each resource instance.\n\n## üíæ Storage Options in Kubernetes\n\nStorage options in Kubernetes include scratch space for temporary data and persistent storage solutions like NFS mounts and CSI (Container Storage Interface).\n\n## üîå Device Plugins and Their Constraints\n\nDevice plugins are necessary for utilizing specialized hardware within Kubernetes, but they have constraints that DRA aims to overcome.\n\n## üîÑ Key Concepts in DRA\n\nThe Array API introduces concepts like **DeviceClass**, **ResourceClaim**, **ResourceClaimTemplates**, and **ResourceSlice**, providing more control and flexibility.\n\n### DeviceClass\n\nA `DeviceClass` defines the characteristics of a device. It specifies the driver and parameters for a device, providing a structured way to request resources. Here is an example of a `DeviceClass`:\n\n```yaml\napiVersion: resource.k8s.io/v1alpha3\nkind: DeviceClass\nmetadata:\n  name: device.com\nspec:\n  selectors:\n  - cel:\n      expression: device.driver == \"device.com\"\n```\n\n### ResourceClaim\n\nA `ResourceClaim` is analogous to a Persistent Volume Claim (PVC) but for device resources. It is a request for a specific type of resource and is used to allocate resources to a pod. Here is an example of a `ResourceClaim`:\n\n```yaml\napiVersion: resource.k8s.io/v1alpha3\nkind: ResourceClaim\nmetadata:\n  name: claim1\nspec:\n  devices:\n    requests:\n    - name: gpu\n      deviceClassName: device.com\n```\n\n### ResourceClaimTemplate\n\nA `ResourceClaimTemplate` is used to generate `ResourceClaim` objects. When a pod references a `ResourceClaimTemplate`, a new `ResourceClaim` is generated for each entry in the pod spec's `resourceClaims` section. Here is an example of a `ResourceClaimTemplate`:\n\n```yaml\napiVersion: resource.k8s.io/v1alpha3\nkind: ResourceClaimTemplate\nmetadata:\n  name: claim1\nspec:\n  spec:\n    devices:\n      requests:\n      - name: gpu\n        deviceClassName: device.com\n```\n\n### ResourceSlice\n\nA `ResourceSlice` represents a slice of resources available on a node. It is used to manage and allocate resources to `ResourceClaims`. Here is an example of a `ResourceSlice`:\n\n```yaml\napiVersion: resource.k8s.io/v1alpha3\nkind: ResourceSlice\nmetadata:\n  name: slice1\nspec:\n  devices:\n  - basic:\n      attributes:\n        family:\n          string: Arc\n        model:\n          string: A770\n      capacity:\n        memory: 16288Mi\n        millicores: 1k\n    name: 0000-03-00-0-0x56a0\n  driver: device.com\n  nodeName: node1\n  pool:\n    generation: 0\n    name: pool1\n    resourceSliceCount: 1\n```\n\nHere is an example of a pod specification that uses Dynamic Resource Allocation (DRA):\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: test-claim\nspec:\n  restartPolicy: Never\n  containers:\n  - name: with-resource\n    image: xxxxx\n  resourceClaims:\n  - name: resource\n    resourceClaimName: zzzz\n```\n\nIn this example:\n\n- The pod is named `test-claim`.\n- It has a single container named `with-resource` that uses the specified image.\n- The pod references a `ResourceClaim` named `zzzz` through the `resourceClaims` field, ensuring that the required resources are allocated and available for the pod.\n\n## üìù Allocation Process in DRA\n\nThe allocation process in DRA can occur immediately or be delayed until a pod referencing the resource claim is created, influencing pod scheduling.\n\n## üõ†Ô∏è Implementing a DRA Driver\n\nImplementing a DRA driver involves defining a name, CRDs, coordination mechanisms, and providing implementations for the controller and node plugin.\n\n## Resource Drivers\n\nIn the context of Dynamic Resource Allocation (DRA) in Kubernetes, a **resource driver** is a component that manages the allocation and deallocation of specific types of resources, such as GPUs, network devices, or other specialized hardware. The resource driver is responsible for:\n\n1. **Discovery**: Identifying and reporting the available resources on each node in the Kubernetes cluster.\n2. **Allocation**: Handling requests for resources from pods and allocating the appropriate resources to meet those requests.\n3. **Preparation**: Preparing the allocated resources for use by the pods, which may involve configuring the hardware or setting up necessary software components.\n4. **Unpreparation**: Cleaning up and releasing the resources when they are no longer needed by the pods.\n\nThe resource driver typically consists of two main components:\n\n1. **Controller**: A centralized component that coordinates with the Kubernetes scheduler to decide which nodes can service incoming resource claims. It handles the creation and management of `ResourceClaim` and `ResourceSlice` objects.\n2. **Node Plugin**: A daemon running on each node that interacts with the hardware to perform discovery, allocation, preparation, and unpreparation of resources. It reports the available resources to the controller and ensures that the resources are correctly configured for use by the pods.\n\nThe resource driver uses Custom Resource Definitions (CRDs) such as `ResourceClass`, `ResourceClaim`, `ResourceClaimTemplate`, and `ResourceSlice` to define and manage the resources within the Kubernetes cluster. These CRDs provide a standardized way to request, allocate, and manage resources, enabling more flexible and efficient resource management.\n\n## üîó Container Device Interface (CDI)\n\n**CDI (Container Device Interface)** is a specification for exposing devices to containers, which is utilized by container runtimes like containerd and CRI-O. It introduces an abstract notion of a device as a resource. Such devices are uniquely specified by a fully-qualified name that is constructed from a vendor ID, a device class, and a name that is unique per vendor ID-device class pair.\n\n## Requirements\n\n- Kubernetes 1.31+, with `DynamicResourceAllocation` feature-flag enabled, and other cluster parameters\n- Container runtime needs to support CDI:\n  - CRI-O v1.23.0 or newer\n  - Containerd v1.7 or newer\n\n### Enable CDI in Containerd\n\nContainerd has CDI enabled by default since version 2.0. For older versions (1.7 and above) CDI has to be enabled in Containerd config by enabling `enable_cdi` and `cdi_specs_dir`. Example `/etc/containerd/config.toml`:\n\n```toml\nversion = 2\n[plugins]\n  [plugins.\"io.containerd.grpc.v1.cri\"]\n    enable_cdi = true\n    cdi_specs_dir = [\"/etc/cdi\", \"/var/run/cdi\"]\n```\n\n## Limitations\n\n- Currently max 640 GPUs can be requested for one resource claim (10 PCIe devices, each with 64 SR-IOV VFs = 640 VFs on the same node).\n- v0.6.0 only supports K8s v1.31 which does not have partitionable devices support, therefore this release does not support dynamic GPU SR-IOV configuration.\n- v0.6.0 does not support classic DRA and only relies on Structured Parameters DRA.\n- v0.6.0 drops Alertmanager web-hook used for (experimental) GPU health management support.\n\n## Enabling Dynamic Resource Allocation\n\nDynamic resource allocation is an alpha feature and only enabled when the `DynamicResourceAllocation` feature gate and the `resource.k8s.io/v1alpha3` API group are enabled. For details on that, see the `--feature-gates` and `--runtime-config` kube-apiserver parameters. kube-scheduler, kube-controller-manager, and kubelet also need the feature gate.\n\nWhen a resource driver uses a control plane controller, then the `DRAControlPlaneController` feature gate has to be enabled in addition to `DynamicResourceAllocation`.\n\nA quick check whether a Kubernetes cluster supports the feature is to list `DeviceClass` objects with:\n\n```bash\nkubectl get deviceclasses\n```\n\nIf your cluster supports dynamic resource allocation, the response is either a list of `DeviceClass` objects or:\n\n```shell\nNo resources found\n```\n\nIf not supported, this error is printed instead:\n\n```shell\nerror: the server doesn't have a resource type \"deviceclasses\"\n```\n\nA control plane controller is supported when it is possible to create a `ResourceClaim` where the `spec.controller` field is set. When the `DRAControlPlaneController` feature is disabled, that field automatically gets cleared when storing the `ResourceClaim`.\n\nThe default configuration of kube-scheduler enables the \"DynamicResources\" plugin if and only if the feature gate is enabled and when using the v1 configuration API. Custom configurations may have to be modified to include it.\n\nIn addition to enabling the feature in the cluster, a resource driver also has to be installed. Please refer to the driver's documentation for details.\n\n### Scheduling Details\n\nWhen using a control plane controller, the resource driver handles the allocation of resources in cooperation with the Kubernetes scheduler. The scheduler checks all `ResourceClaims` needed by a pod and creates a `PodSchedulingContext` object, informing the resource drivers about nodes that are considered suitable for the pod. The resource drivers respond by excluding nodes that don't have enough resources left. Once the scheduler has this information, it selects a node and stores the choice in the `PodSchedulingContext` object. The resource drivers then allocate the resources, and the pod gets scheduled. Without a control plane controller, the scheduler uses structured parameters to allocate resources directly from `ResourceSlice` objects, tracking which resources have been allocated and selecting from the remaining resources.\n\n### Monitoring Resources\n\nThe kubelet provides a gRPC service to enable the discovery of dynamic resources for running pods. This service allows resource drivers to report the availability and status of resources on each node. The gRPC endpoints provide detailed information about the resources allocated to each pod, helping administrators monitor and manage resource usage effectively. This monitoring capability is crucial for ensuring that resources are being used efficiently and for troubleshooting any issues that may arise with resource allocation.\n\n### Pre-scheduled Pods\n\nWhen a pod is created with the `spec.nodeName` field already set, the scheduler is bypassed. If the required `ResourceClaims` for the pod do not exist, are not allocated, or are not reserved, the kubelet will fail to run the pod and periodically re-check until the requirements are fulfilled. This situation can occur due to version skew, configuration issues, or feature gate settings. The kube-controller-manager detects such scenarios and attempts to make the pod runnable by triggering the allocation and reservation of the required `ResourceClaims`. However, it is generally better to avoid bypassing the scheduler to prevent resource blocking and ensure efficient resource allocation.\n\n## üîó References\n\n- [Kubernetes](https://kubernetes.io/)\n- [Container Storage Interface (CSI)](https://kubernetes-csi.github.io/docs/)\n- [Container Device Interface (CDI)](https://github.com/container-orchestrated-devices/container-device-interface)\n","wordCount":{"words":1425},"frontmatter":{"id":"756800f3b0431ff2663d7cef","path":"/blog/k8s-dynamic-resource-allocation-dra/","humanDate":"Nov 2, 2024","fullDate":"2024-11-02","title":"Dynamic Resource Allocation in Kubernetes","keywords":["Dynamic Resource Allocation","Kubernetes","k8s","Resource Management"],"excerpt":"An in-depth look at Dynamic Resource Allocation (DRA) in Kubernetes and its importance in modern environments","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAADEUlEQVR42i2R7VMSBgCH/UPq5vfdbcOzdvuwtFvl9WJlt3RZtyGkcqS5EqUhkoA2SPIFeTFwgoqHb3k6RRQlQBBwlkOdZClRt9s8P+xudy3r2zPc+geee37PL+uj0A5HQ5vk/+znvGeOK95pRNOj3PSNIPM4UM3aMARtmAJd/BR8gDusY3BWwWy4geBSHeHFKhJxCbvJSvZTIrKyQymOBDfIabNwrKOLAmMnl6wdlLnMVDrbkNo0yAe0NPY3onc3YJ1U8qNVTPdgBRb7t/Q5rzDiKia9Kub9SzFZ/xmGkxTENiiOriD57QnCyUHKBsxU9LYitWuROZvQDB0AFaitUkYX7jI+Y2d1XUM6JWPvZQ1/7Uh5u1P2AbiYAS6ucvFpgpPGOQp1Dm54XdSMP6R2uI2WCSMysw7DmBbTozu45zX4l/VEf9XROrKOP2zm79R1/tn+YPh5pmHeShJln5tzH6s5XtnD3a0wLQkvludT1CwYyM6xoXbZiO/1EEi28+SFBmX/OML2N0z6unn7qow3B8Ds4DY5S1tc9YTwfSdi9NQZ7pg6kXgHaI57UCQM5AYEfKL6mgazmu4FHZGt+zz0OTnR6KFQPYnDN8XedhX7B5OzAy8QxLbRGsyMXbiA3NrDpe9VXFWq0GQMv4ldI9+fzw/Ttyk+dxa9Q4b/mQmJeRhxq50xVzv65sek41W8z1hmHc68nJd52VZ+g67bt7j8eI0jdUucvr+CasPFlzN5SJZvcs+pR3A0l3r1NYZ/cVKoHMTp62THUsqMIJfX/aW8+7OcrEPhNKc9UYzVtdT3OiiJrnGqPYpwNE7tqpkz80Xo1jt48KiNy6KLmIbqsfmdSDsdxDbvkeyvZKW6kN1gBfuvMw0PRV5xdjyAvk5J1cQkJaE1jjVFELoj1Cx3UeQvxfLMibavhYKir+hyy7HM9aBw9LKW0rJuFBESnmA3VP4/8HAkzcmJEE1yFeL5BYq8CQTVIUrsUW7FrBTPibA/H6KuQ85nOZ/SbK7G4u1G3WdhM63hqaIEz/Ev+GPqOu9+F/MvbVZawIwkxMcAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/f9c464255bb43abf243e234b9fbffa4c/befd1/image.png","srcSet":"/static/f9c464255bb43abf243e234b9fbffa4c/3ee9e/image.png 750w,\n/static/f9c464255bb43abf243e234b9fbffa4c/faa1e/image.png 1080w,\n/static/f9c464255bb43abf243e234b9fbffa4c/70643/image.png 1366w,\n/static/f9c464255bb43abf243e234b9fbffa4c/befd1/image.png 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/f9c464255bb43abf243e234b9fbffa4c/b5c20/image.webp 750w,\n/static/f9c464255bb43abf243e234b9fbffa4c/faf10/image.webp 1080w,\n/static/f9c464255bb43abf243e234b9fbffa4c/7effd/image.webp 1366w,\n/static/f9c464255bb43abf243e234b9fbffa4c/a1f10/image.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5708333333333333}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/integrating-dapr-with-aws-eks/","title":"Speed Up Microservices Development with Dapr on AWS EKS","date":"2024-11-02 18:30:00"},"excerpt":"Use Dapr to Build Distributed Applications Easily on Kubernetes üé© üê≥ Introduction Building distributed applications means creating software‚Ä¶","html":"<blockquote>\n<p><strong>Use Dapr to Build Distributed Applications Easily on Kubernetes üé©</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üê≥ Introduction</h2>\n<p><a href=\"https://en.wikipedia.org/wiki/Distributed_computing\" target=\"_blank\" rel=\"noopener noreferrer\">Building distributed</a> applications means creating software that runs on multiple computers within a network, working together to achieve a common goal. This involves coordinating various components or modules that might be spread across different infrastructures.</p>\n<p>Organizations often opt for distributed applications for two main reasons. First, they allow multiple development teams to work independently while contributing to a larger system. Second, they enable the integration of components built with different programming languages, enhancing interoperability.</p>\n<p>This flexibility is important in today's diverse tech landscape, where different teams might prefer different tools and languages.</p>\n<p>However, developing distributed applications comes with several challenges. Ensuring that numerous components work together fluently requires careful attention to resiliency (the ability to recover from failures), <a href=\"https://en.wikipedia.org/wiki/Observability_(software)\" target=\"_blank\" rel=\"noopener noreferrer\">observability</a> (monitoring the system's health), security, and scalability across various services and runtimes.</p>\n<p>Additionally, these applications often interact with <a href=\"https://en.wikipedia.org/wiki/Message_broker\" target=\"_blank\" rel=\"noopener noreferrer\">message brokers</a> (like <a href=\"https://kafka.apache.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Kafka</a> or <a href=\"https://www.rabbitmq.com/\" target=\"_blank\" rel=\"noopener noreferrer\">RabbitMQ</a>), <a href=\"https://en.wikipedia.org/wiki/Data_store\" target=\"_blank\" rel=\"noopener noreferrer\">data stores</a> (like databases), and external services (like third-party APIs), necessitating a thorough understanding of specific APIs and SDKs, which adds to the complexity. The need for robust error handling, efficient load balancing, and seamless service discovery further complicates the development process.</p>\n<p>In this blog, we will explore how the open-source <a href=\"https://dapr.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr</a> (Distributed Application Runtime) can assist us in building reliable and secure distributed applications. Dapr provides a set of building blocks for common microservice patterns, such as service invocation (calling services), state management (handling data), and <a href=\"https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern\" target=\"_blank\" rel=\"noopener noreferrer\">pub/sub messaging</a> (publish/subscribe communication), which can significantly reduce the development effort.</p>\n<p>By using Dapr‚Äôs built-in best practices and patterns, we will also highlight common use cases for Dapr on <a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EKS</a> (Elastic Kubernetes Service), demonstrating how it can simplify and enhance your microservices architecture. This approach not only speeds up development but also ensures that your applications are scalable and maintainable.</p>\n<blockquote>\n<p>For more on Dapr, <a href=\"https://seifrajhi.github.io/blog/dapr-kubernetes-event-driven-runtime-part1/\" target=\"_blank\" rel=\"noopener noreferrer\">check out Part 1 of our series</a>. You can also learn more about <a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a>, <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EKS</a>, and <a href=\"https://martinfowler.com/articles/microservices.html\" target=\"_blank\" rel=\"noopener noreferrer\">microservices architecture</a> to deepen your understanding of the concepts discussed in this post.</p>\n</blockquote>\n<h2 id=\"-what-is-dapr-and-why-do-we-need-it\" style=\"position:relative;\"><a href=\"#-what-is-dapr-and-why-do-we-need-it\" aria-label=\" what is dapr and why do we need it permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ What is Dapr and Why Do We Need It?</h2>\n<p><a href=\"https://dapr.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr</a> (Distributed Application Runtime) is an open-source project designed to simplify the development of microservices. It provides a set of building blocks that address common challenges in building distributed applications, such as service-to-service communication, state management, and pub/sub messaging.</p>\n<h3 id=\"-main-features-of-dapr\" style=\"position:relative;\"><a href=\"#-main-features-of-dapr\" aria-label=\" main features of dapr permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåü Main Features of Dapr</h3>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 87.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACJ0lEQVR42qVUiW7bMAzN///YgAFZVrSZsWFxUtf3bUk+dPmNspP1StF2I0wIMsQn8vFRGzy1eaZvhp0tuQHt8FnbvAR0NpoGMd+hEodlrwsBE3GYrIdKOFTEYIV6H9Bai6YmsCRAUhzRjw0MZTvFHYSXov+VQx1q2BPDzOTbgK5MY4FhlCiKCmlWgrF++a+1Xg5WosXvOkIytcg1RyY7KGuuAVKQmbF/ULgLJLzYYndUKDpXkoWUCjPdVkqOXXsPr4vgiQQejyH05MKJ75V755sLdb204IPGMUiRlh0macC6DkmSoK7rhQ7OGIosh5zkB5pCqIwCHsIQXIgFoCgK7Pd7pGm63D6OI+I4RlWVa8jZrwK6LIeugshPmKoAZmTUnBTb7ZaySlFOBt8ahdtO4zutN63C7ryf7CPsZqmdslnkwUsMwQ3G8BZa1KibFr7vo64qDMriVHN4YYqQDajUjIIuca4c4IXDC5mCygyp3AMBMMHPWbumSBizdrOnM0kUEofTC/m+aIozow0FakhuwO81RGDQZwpKK8pWkO46DGUJwcUz/ua3m7Iuoh6Q/WxR+4IA1DKGKokw/biD9A+wZ11+aPSGgcDyDFESomXtmrlTPF2W5zmORx9RFP0V+1XAp/VrKs9xpkiDiibBqhBakWR0QntGspnQ9zTPSr3i7hWHj4/DWrvVJUb+FX3n/AsBls+5+cxrczGXSVU1NCnNQsc/P1//Y38ApwIud6qWge0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Dapr Features\" title=\"\" src=\"/static/431aa822010d0663494c4f4905da03db/c5bb3/image.png\" srcset=\"/static/431aa822010d0663494c4f4905da03db/04472/image.png 170w,\n/static/431aa822010d0663494c4f4905da03db/9f933/image.png 340w,\n/static/431aa822010d0663494c4f4905da03db/c5bb3/image.png 680w,\n/static/431aa822010d0663494c4f4905da03db/b12f7/image.png 1020w,\n/static/431aa822010d0663494c4f4905da03db/b5a09/image.png 1360w,\n/static/431aa822010d0663494c4f4905da03db/016a8/image.png 1576w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<ol>\n<li>\n<p><strong>Service Invocation</strong>:</p>\n<ul>\n<li>Dapr makes it easy for microservices to communicate with each other. Instead of writing custom code to handle HTTP or gRPC calls, you can use Dapr's <a href=\"https://docs.dapr.io/developing-applications/building-blocks/service-invocation/\" target=\"_blank\" rel=\"noopener noreferrer\">Service Invocation</a> API. This API abstracts the complexity and provides built-in retries, timeouts, and error handling. The <a href=\"https://docs.dapr.io/concepts/components-concept/#middleware\" target=\"_blank\" rel=\"noopener noreferrer\">middleware components</a> are used with the service invocation building block.</li>\n</ul>\n</li>\n<li>\n<p><strong>State Management</strong>:</p>\n<ul>\n<li>Managing state in a distributed system can be complex. Dapr provides a <a href=\"https://docs.dapr.io/developing-applications/building-blocks/state-management/\" target=\"_blank\" rel=\"noopener noreferrer\">State Management API</a> that allows you to store and retrieve state across different services. This API supports various state stores like Redis, DynamoDB, and Cosmos DB, making it flexible and easy to use.</li>\n</ul>\n</li>\n<li>\n<p><strong>Publish/Subscribe Messaging</strong>:</p>\n<ul>\n<li>For event-driven architectures, Dapr offers a <a href=\"https://docs.dapr.io/developing-applications/building-blocks/pubsub/\" target=\"_blank\" rel=\"noopener noreferrer\">Pub/Sub API</a>. This allows services to publish events and other services to subscribe to them, enabling asynchronous communication. You can integrate with message brokers like AWS SNS, SQS, and Kafka without changing your application code.</li>\n</ul>\n</li>\n<li>\n<p><strong>Bindings</strong>:</p>\n<ul>\n<li>Dapr supports input and output bindings to interact with external systems. This means you can easily connect to databases, message queues, and other services using Dapr's <a href=\"https://docs.dapr.io/developing-applications/building-blocks/bindings/\" target=\"_blank\" rel=\"noopener noreferrer\">Binding API</a>.</li>\n</ul>\n</li>\n<li>\n<p><strong>Workflow</strong>:</p>\n<ul>\n<li>Dapr provides a built-in <a href=\"https://docs.dapr.io/developing-applications/building-blocks/workflow/\" target=\"_blank\" rel=\"noopener noreferrer\">workflow</a> feature to orchestrate logic across various microservices.</li>\n</ul>\n</li>\n<li>\n<p><strong>Actors</strong>:</p>\n<ul>\n<li>Dapr supports the actor model, allowing you to encapsulate code and data in reusable actor objects, which is a common microservices design pattern.</li>\n</ul>\n</li>\n<li>\n<p><strong>Secrets Management</strong>:</p>\n<ul>\n<li>Security is a critical aspect of any distributed system. Dapr includes features like mutual TLS (mTLS) for secure service-to-service communication and <a href=\"https://docs.dapr.io/developing-applications/building-blocks/secrets/\" target=\"_blank\" rel=\"noopener noreferrer\">secret management</a> to handle sensitive information like API keys and database credentials.</li>\n</ul>\n</li>\n<li>\n<p><strong>Configuration</strong>:</p>\n<ul>\n<li>Dapr provides a <a href=\"https://docs.dapr.io/developing-applications/building-blocks/configuration/\" target=\"_blank\" rel=\"noopener noreferrer\">Configuration API</a> to manage and be notified of application configuration changes.</li>\n</ul>\n</li>\n<li>\n<p><strong>Distributed Lock</strong>:</p>\n<ul>\n<li>Dapr offers a <a href=\"https://docs.dapr.io/developing-applications/building-blocks/distributed-lock/\" target=\"_blank\" rel=\"noopener noreferrer\">Distributed Lock API</a> to provide mutually exclusive access to shared resources from an application.</li>\n</ul>\n</li>\n<li>\n<p><strong>Cryptography</strong>:</p>\n<ul>\n<li>Dapr includes a <a href=\"https://docs.dapr.io/developing-applications/building-blocks/cryptography/\" target=\"_blank\" rel=\"noopener noreferrer\">Cryptography API</a> to perform cryptographic operations without exposing keys to your application.</li>\n</ul>\n</li>\n<li>\n<p><strong>Jobs</strong>:</p>\n<ul>\n<li>Dapr provides a <a href=\"https://docs.dapr.io/developing-applications/building-blocks/jobs/\" target=\"_blank\" rel=\"noopener noreferrer\">Jobs API</a> to manage the scheduling and orchestration of jobs.</li>\n</ul>\n</li>\n</ol>\n<p>By leveraging these features, Dapr simplifies the development of distributed applications, allowing developers to focus on writing business logic rather than dealing with the complexities of distributed systems. This leads to faster development cycles, more reliable applications, and easier maintenance.</p>\n<h3 id=\"-why-do-we-need-dapr\" style=\"position:relative;\"><a href=\"#-why-do-we-need-dapr\" aria-label=\" why do we need dapr permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ùì Why Do We Need Dapr?</h3>\n<p>Developing distributed applications involves several challenges:</p>\n<ul>\n<li><strong>Complex Communication</strong>: Ensuring reliable communication between services can be difficult, especially when dealing with different protocols and error handling.</li>\n<li><strong>State Management</strong>: Keeping track of state across multiple services requires a consistent and reliable approach.</li>\n<li><strong>Event-Driven Architecture</strong>: Implementing pub/sub messaging patterns can be complex and requires integration with various message brokers.</li>\n<li><strong>External Integrations</strong>: Connecting to external systems like databases and third-party APIs often involves writing boilerplate code.</li>\n<li><strong>Observability</strong>: Monitoring and diagnosing issues in a distributed system requires comprehensive logging, metrics, and tracing.</li>\n<li><strong>Security</strong>: Ensuring secure communication and managing secrets are essential for protecting your application.</li>\n<li><strong>Isolation</strong>: Dapr namespacing provides isolation and multi-tenancy across many capabilities, giving greater security. Typically applications and components are deployed to namespaces to provide isolation in a given environment, such as Kubernetes.</li>\n</ul>\n<p>Dapr addresses these challenges by providing a set of standardized APIs and components that simplify the development process. By using Dapr, developers can focus on writing business logic instead of dealing with the complexities of distributed systems. This leads to faster development cycles, more reliable applications, and easier maintenance.</p>\n<p>For more details, <a href=\"https://docs.dapr.io/concepts/overview/\" target=\"_blank\" rel=\"noopener noreferrer\">check the official documentation</a>.</p>\n<h2 id=\"Ô∏è-how-to-invoke-services-using-middleware-component\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-how-to-invoke-services-using-middleware-component\" aria-label=\"Ô∏è how to invoke services using middleware component permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è How-To: Invoke Services Using Middleware Component</h2>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 41.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABTUlEQVR42oWR0U7DMAxF+/+fxQsCCU2IMcokurHCuqZJbDftWrFOFzcdKzzxcNRrO07s26SVDjUHBG7i90dPtGipQ6A5N9VnxrgZNdU41h0S8TWIvEIg7yHMV83EkKqJes7RpBUfYRR+hLTWIDGFRZq+4Hm1wj7f4bUk3NkeD67Dyh2xyz3uTYuF77FwPXJj8VgF3NIZa99iWzoseMCNO2EvJyTOELJNhizbgJxFoeNv9aVc1/tUTBmQuYAPnnJGp3mvCMtC+6zgoPGax8eOKKhHEr0JAcYYLJ+WWKcpvK0QhNQfRrCt+kPq1xgTRARS7CHZG2o9xyzRGo5ndOVap2GZ/DkcCpSmBGkjC0/NVj3Ui8c4EnUN1iHmmGNPkFZ/iq7jrJputeAk4i1FYs40cBVdc5Hqwq+cqzyC1wnPwxnD6cLXMOsLf+r/MJ79BvpIX27QAG8wAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Service Invocation\" title=\"\" src=\"/static/afef9946acc68e0741d2eb46d7692117/c5bb3/image-1.png\" srcset=\"/static/afef9946acc68e0741d2eb46d7692117/04472/image-1.png 170w,\n/static/afef9946acc68e0741d2eb46d7692117/9f933/image-1.png 340w,\n/static/afef9946acc68e0741d2eb46d7692117/c5bb3/image-1.png 680w,\n/static/afef9946acc68e0741d2eb46d7692117/b12f7/image-1.png 1020w,\n/static/afef9946acc68e0741d2eb46d7692117/b5a09/image-1.png 1360w,\n/static/afef9946acc68e0741d2eb46d7692117/5ba90/image-1.png 1604w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>In this section, we'll demonstrate how to deploy services with unique application IDs, allowing other services to discover and call endpoints using Dapr's service invocation over HTTP.</p>\n<h3 id=\"-step-1-choose-an-id-for-your-service\" style=\"position:relative;\"><a href=\"#-step-1-choose-an-id-for-your-service\" aria-label=\" step 1 choose an id for your service permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üÜî Step 1: Choose an ID for Your Service</h3>\n<p>Dapr allows you to assign a global, unique ID for your app. This ID encapsulates the state for your application, regardless of the number of instances it may have.</p>\n<h3 id=\"Ô∏è-step-2-set-an-app-id-when-deploying-to-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-step-2-set-an-app-id-when-deploying-to-kubernetes\" aria-label=\"Ô∏è step 2 set an app id when deploying to kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Step 2: Set an App-ID When Deploying to Kubernetes</h3>\n<p>In Kubernetes, set the <code class=\"language-text\">dapr.io/app-id</code> annotation on your pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n            <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">dapr.io/enabled</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n                <span class=\"token key atrule\">dapr.io/app-id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"order-processor\"</span>\n                <span class=\"token key atrule\">dapr.io/app-port</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"6001\"</span>\n                <span class=\"token key atrule\">dapr.io/app-protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http\"</span>  <span class=\"token comment\"># Use \"https\" if your app uses TLS</span></code></pre></div>\n<h3 id=\"-step-3-invoke-the-service\" style=\"position:relative;\"><a href=\"#-step-3-invoke-the-service\" aria-label=\" step 3 invoke the service permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì° Step 3: Invoke the Service</h3>\n<p>To invoke an application using Dapr, you can use the invoke API on any Dapr instance. The sidecar programming model encourages each application to interact with its own instance of Dapr. The Dapr sidecars discover and communicate with one another.</p>\n<p>Below is an example in Python that leverages Dapr SDKs for service invocation:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random\n<span class=\"token keyword\">from</span> time <span class=\"token keyword\">import</span> sleep\n<span class=\"token keyword\">import</span> logging\n<span class=\"token keyword\">import</span> requests\n<span class=\"token keyword\">import</span> json\n\nbase_url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:3500/v1.0/invoke/order-processor/method\"</span>\nheaders <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">}</span>\n\nlogging<span class=\"token punctuation\">.</span>basicConfig<span class=\"token punctuation\">(</span>level<span class=\"token operator\">=</span>logging<span class=\"token punctuation\">.</span>INFO<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        sleep<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n        order_id <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n        order <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'orderId'</span><span class=\"token punctuation\">:</span> order_id<span class=\"token punctuation\">,</span> <span class=\"token string\">'item'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'laptop'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'quantity'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span>\n        \n        <span class=\"token comment\"># Invoke a service</span>\n        result <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>\n                url<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>base_url<span class=\"token punctuation\">}</span></span><span class=\"token string\">/orders'</span></span><span class=\"token punctuation\">,</span>\n                data<span class=\"token operator\">=</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                headers<span class=\"token operator\">=</span>headers\n        <span class=\"token punctuation\">)</span>\n        \n        logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Order requested: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>order_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n        logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Result: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>result<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"-additional-url-formats\" style=\"position:relative;\"><a href=\"#-additional-url-formats\" aria-label=\" additional url formats permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê Additional URL Formats</h3>\n<p>To invoke a <code class=\"language-text\">GET</code> endpoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> http://localhost:3500/v1.0/invoke/order-processor/method/orders/100</code></pre></div>\n<p>Dapr provides multiple ways to call the service invocation API:</p>\n<ul>\n<li>Change the address in the URL to <code class=\"language-text\">localhost:&lt;dapr-http-port></code>.</li>\n<li>Add a <code class=\"language-text\">dapr-app-id</code> header to specify the ID of the target service, or alternatively pass the ID via HTTP Basic Auth: <code class=\"language-text\">http://dapr-app-id:&lt;service-id>@localhost:3500/path</code>.</li>\n</ul>\n<p>For example, the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> http://localhost:3500/v1.0/invoke/order-processor/method/orders/100</code></pre></div>\n<p>is equivalent to:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'dapr-app-id: order-processor'</span> <span class=\"token string\">'http://localhost:3500/orders/100'</span> <span class=\"token parameter variable\">-X</span> GET</code></pre></div>\n<p>or:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token string\">'http://dapr-app-id:order-processor@localhost:3500/orders/100'</span> <span class=\"token parameter variable\">-X</span> GET</code></pre></div>\n<p>Using CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr invoke --app-id order-processor <span class=\"token parameter variable\">--method</span> orders/100</code></pre></div>\n<h3 id=\"-including-a-query-string-in-the-url\" style=\"position:relative;\"><a href=\"#-including-a-query-string-in-the-url\" aria-label=\" including a query string in the url permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Including a Query String in the URL</h3>\n<p>You can append a query string or a fragment to the end of the URL, and Dapr will pass it through unchanged. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token string\">'http://dapr-app-id:order-processor@localhost:3500/orders/100?basket=1234&amp;key=abc'</span> <span class=\"token parameter variable\">-X</span> GET</code></pre></div>\n<h3 id=\"Ô∏è-using-namespaces\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-using-namespaces\" aria-label=\"Ô∏è using namespaces permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üè∑Ô∏è Using Namespaces</h3>\n<p>When running on namespace-supported platforms, include the namespace of the target app in the app ID. For example, use <code class=\"language-text\">order-processor.production</code>.</p>\n<p>Invoking the service with a namespace would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> http://localhost:3500/v1.0/invoke/order-processor.production/method/orders/100 <span class=\"token parameter variable\">-X</span> GET</code></pre></div>\n<p>This example demonstrates how to use Dapr's service invocation to call services securely and efficiently within a Kubernetes environment. For more details, check the <a href=\"https://docs.dapr.io/developing-applications/building-blocks/service-invocation/\" target=\"_blank\" rel=\"noopener noreferrer\">official Dapr documentation</a>. Let me know if you need any further details or adjustments!</p>\n<h2 id=\"demo-set-up-an-aws-eks-cluster-and-app-test\" style=\"position:relative;\"><a href=\"#demo-set-up-an-aws-eks-cluster-and-app-test\" aria-label=\"demo set up an aws eks cluster and app test permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Demo: Set Up an AWS EKS Cluster and App test</h2>\n<p>In this section, we'll walk you through setting up an Elastic Kubernetes Service (EKS) cluster and deploying a sample application to test Dapr integration.</p>\n<h3 id=\"-prerequisites\" style=\"position:relative;\"><a href=\"#-prerequisites\" aria-label=\" prerequisites permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Prerequisites</h3>\n<p>Before you begin, ensure you have the following installed:</p>\n<ul>\n<li><code class=\"language-text\">kubectl</code></li>\n<li><code class=\"language-text\">AWS CLI</code></li>\n<li><code class=\"language-text\">eksctl</code></li>\n<li>An existing VPC and subnets</li>\n</ul>\n<h3 id=\"-authenticating-to-aws\" style=\"position:relative;\"><a href=\"#-authenticating-to-aws\" aria-label=\" authenticating to aws permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Authenticating to AWS</h3>\n<p>To interact with AWS services like DynamoDB from your EKS pods, you need to ensure that your pods have the necessary permissions. This can be achieved using IAM Roles for Service Accounts (IRSA) or a pod identity agent.</p>\n<h4 id=\"using-iam-roles-for-service-accounts-irsa\" style=\"position:relative;\"><a href=\"#using-iam-roles-for-service-accounts-irsa\" aria-label=\"using iam roles for service accounts irsa permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Using IAM Roles for Service Accounts (IRSA)</h4>\n<ol>\n<li>\n<p><strong>Create an IAM Role</strong>: Create an IAM role with the necessary permissions for accessing AWS services. Attach the required policies to this role.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws iam create-role --role-name EKS-DynamoDB-Role --assume-role-policy-document file://trust-policy.json\naws iam attach-role-policy --role-name EKS-DynamoDB-Role --policy-arn arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess</code></pre></div>\n<p>The <code class=\"language-text\">trust-policy.json</code> should contain the trust relationship allowing EKS to assume this role:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Service\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eks.amazonaws.com\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><strong>Associate the IAM Role with a Kubernetes Service Account</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">eksctl create iamserviceaccount <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--name</span> my-service-account <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--namespace</span> default <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--cluster</span> my-cluster <span class=\"token punctuation\">\\</span>\n  --attach-role-arn arn:aws:iam::<span class=\"token operator\">&lt;</span>AWS_ACCOUNT_ID<span class=\"token operator\">></span>:role/EKS-DynamoDB-Role <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--approve</span></code></pre></div>\n</li>\n<li>\n<p><strong>Update Your Pod Specification</strong>: Update your pod specification to use the service account:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>pod\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>service<span class=\"token punctuation\">-</span>account\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>image</code></pre></div>\n</li>\n</ol>\n<h4 id=\"using-a-pod-identity-agent\" style=\"position:relative;\"><a href=\"#using-a-pod-identity-agent\" aria-label=\"using a pod identity agent permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Using a Pod Identity Agent</h4>\n<ol>\n<li>\n<p><strong>Deploy the Pod Identity Agent</strong>: Follow the installation instructions to deploy the agent to your EKS cluster.</p>\n</li>\n<li>\n<p><strong>Annotate Your Pods</strong>: Annotate your pods with the IAM role to be assumed:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>pod\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">iam.amazonaws.com/role</span><span class=\"token punctuation\">:</span> EKS<span class=\"token punctuation\">-</span>DynamoDB<span class=\"token punctuation\">-</span>Role\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>image</code></pre></div>\n</li>\n</ol>\n<p>By following these steps, you can ensure that your EKS pods have the necessary permissions to interact with AWS services securely.</p>\n<h3 id=\"Ô∏è-step-1-deploy-an-eks-cluster\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-step-1-deploy-an-eks-cluster\" aria-label=\"Ô∏è step 1 deploy an eks cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Step 1: Deploy an EKS Cluster</h3>\n<ol>\n<li>\n<p><strong>Log into AWS</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws configure</code></pre></div>\n</li>\n<li>\n<p><strong>Create an EKS Cluster</strong>:</p>\n<p>To create an EKS cluster, use the following command. You can specify a specific version of Kubernetes using the <code class=\"language-text\">--version</code> flag (1.13.x or newer version required).</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">eksctl create cluster <span class=\"token parameter variable\">--name</span> dapre-eks-demo <span class=\"token parameter variable\">--region</span> eu-west-1 <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.30</span> --vpc-private-subnets subnet-12345,subnet-67890 --without-nodegroup</code></pre></div>\n<p>Adjust the <code class=\"language-text\">--vpc-private-subnets</code> values to meet your requirements. You can also specify public subnets by changing <code class=\"language-text\">--vpc-private-subnets</code> to <code class=\"language-text\">--vpc-public-subnets</code>.</p>\n</li>\n<li>\n<p><strong>Verify <code class=\"language-text\">kubectl</code> Context</strong>:\nEnsure your <code class=\"language-text\">kubectl</code> context is set to the new EKS cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl config current-context</code></pre></div>\n</li>\n<li>\n<p><strong>Update Security Group Rules</strong>:\nAllow the EKS cluster to communicate with the Dapr sidecar by creating an inbound rule for port <code class=\"language-text\">4000</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws ec2 authorize-security-group-ingress <span class=\"token parameter variable\">--region</span> eu-west-1 <span class=\"token punctuation\">\\</span>\n--group-id sg-0123456789abcdef0 <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--protocol</span> tcp <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--port</span> <span class=\"token number\">4000</span> <span class=\"token punctuation\">\\</span>\n--source-group sg-0123456789abcdef0</code></pre></div>\n</li>\n</ol>\n<h3 id=\"step-2-deploy-sample-applications\" style=\"position:relative;\"><a href=\"#step-2-deploy-sample-applications\" aria-label=\"step 2 deploy sample applications permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 2: Deploy Sample Applications</h3>\n<p>First, we need to clone the repo that has the code snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone https://github.com/dapr/quickstarts.git\n<span class=\"token builtin class-name\">cd</span> quickstarts/tutorials/hello-kubernetes</code></pre></div>\n<p>Then, we need to set up Dapr dev mode on our Kubernetes cluster.</p>\n<p>Follow the steps below to deploy Dapr to Kubernetes using the <code class=\"language-text\">--dev</code> flag.</p>\n<blockquote>\n<p><strong>Note</strong>: Any previous Dapr installations in the Kubernetes cluster need to be uninstalled first. You can use <code class=\"language-text\">dapr uninstall -k</code> to remove Dapr.</p>\n</blockquote>\n<p>With the <code class=\"language-text\">dapr init -k --dev</code> command, the CLI will also install the <code class=\"language-text\">Redis</code> and <code class=\"language-text\">Zipkin</code> containers <code class=\"language-text\">dapr-dev-redis</code> and <code class=\"language-text\">dapr-dev-zipkin</code> in the <code class=\"language-text\">default</code> namespace apart from the Dapr control plane in the <code class=\"language-text\">dapr-system</code> namespace.</p>\n<p>The <code class=\"language-text\">statestore</code>, <code class=\"language-text\">pubsub</code>, and <code class=\"language-text\">appconfig</code> default components and configuration are applied in the default Kubernetes namespace if they do not exist.</p>\n<p>You can use <code class=\"language-text\">dapr components -k</code> and <code class=\"language-text\">dapr configurations -k</code> to see these.</p>\n<p>For more details, check the <a href=\"https://docs.dapr.io/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">official Dapr documentation</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr init <span class=\"token parameter variable\">-k</span> <span class=\"token parameter variable\">--dev</span>\nExpected output <span class=\"token keyword\">in</span> a fresh Kubernetes cluster without Dapr installed:\n\n‚åõ  Making the jump to hyperspace<span class=\"token punctuation\">..</span>.\n‚ÑπÔ∏è  Note: To <span class=\"token function\">install</span> Dapr using Helm, see here: https://docs.dapr.io/getting-started/install-dapr-kubernetes/<span class=\"token comment\">#install-with-helm-advanced</span>\n\n‚ÑπÔ∏è  Container images will be pulled from Docker Hub\n‚úÖ  Deploying the Dapr control plane with latest version to your cluster<span class=\"token punctuation\">..</span>.\n‚úÖ  Deploying the Dapr dashboard with latest version to your cluster<span class=\"token punctuation\">..</span>.\n‚úÖ  Deploying the Dapr Redis with <span class=\"token number\">17.14</span>.5 version to your cluster<span class=\"token punctuation\">..</span>.\n‚úÖ  Deploying the Dapr Zipkin with latest version to your cluster<span class=\"token punctuation\">..</span>.\n‚ÑπÔ∏è  Applying <span class=\"token string\">\"statestore\"</span> component to Kubernetes <span class=\"token string\">\"default\"</span> namespace.\n‚ÑπÔ∏è  Applying <span class=\"token string\">\"pubsub\"</span> component to Kubernetes <span class=\"token string\">\"default\"</span> namespace.\n‚ÑπÔ∏è  Applying <span class=\"token string\">\"appconfig\"</span> zipkin configuration to Kubernetes <span class=\"token string\">\"default\"</span> namespace.\n‚úÖ  Success<span class=\"token operator\">!</span> Dapr has been installed to namespace dapr-system. To verify, run `dapr status -k' <span class=\"token keyword\">in</span> your terminal. To get started, go here: https://aka.ms/dapr-getting-started</code></pre></div>\n<p><strong>üêç Deploy the Python App</strong></p>\n<p>Next, we deploy the Python app. This is a basic Python app that posts JSON messages to <code class=\"language-text\">localhost:3500</code>, the default listening port for Dapr. You can invoke the Node.js application's <code class=\"language-text\">neworder</code> endpoint by posting to <code class=\"language-text\">v1.0/invoke/nodeapp/method/neworder</code>. The message contains some data with an <code class=\"language-text\">orderId</code> that increments once per second:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> requests\n\nn <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\ndapr_url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:3500/v1.0/invoke/nodeapp/method/neworder\"</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    n <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    message <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"orderId\"</span><span class=\"token punctuation\">:</span> n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        response <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>dapr_url<span class=\"token punctuation\">,</span> json<span class=\"token operator\">=</span>message<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>To deploy the Python app to the Kubernetes cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> ./deploy/python.yaml</code></pre></div>\n<p><strong>üü¢ Deploy the Node.js App</strong></p>\n<p>To deploy the Node.js app to Kubernetes, use the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> ./deploy/node.yaml</code></pre></div>\n<p>This will deploy the Node.js app to Kubernetes. The Dapr control plane will automatically inject the Dapr sidecar to the Pod. If you take a look at the <code class=\"language-text\">node.yaml</code> file, you will see how Dapr is enabled for that deployment:</p>\n<ul>\n<li><code class=\"language-text\">dapr.io/enabled: true</code> - This tells the Dapr control plane to inject a sidecar to this deployment.</li>\n<li><code class=\"language-text\">dapr.io/app-id: nodeapp</code> - This assigns a unique ID or name to the Dapr application, so it can be sent messages to and communicated with by other Dapr apps.</li>\n<li><code class=\"language-text\">dapr.io/enable-api-logging: \"true\"</code> - This is added to <code class=\"language-text\">node.yaml</code> file by default to see the API logs.</li>\n</ul>\n<p>You'll also see the container image that you're deploying. If you want to update the code and deploy a new image, see the <strong>Next Steps</strong> section.</p>\n<p><strong>üîÑ Accessing the Kubernetes Service</strong></p>\n<p>There are several different ways to access a Kubernetes service depending on which platform you are using. Port forwarding is one consistent way to access a service, whether it is hosted locally or on a cloud Kubernetes provider like AKS.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl port-forward service/nodeapp <span class=\"token number\">8080</span>:80</code></pre></div>\n<p>This will make your service available on <code class=\"language-text\">http://localhost:8080</code>.</p>\n<p><strong>Configure the Redis Statestore Component</strong></p>\n<p>Apply the <code class=\"language-text\">redis.yaml</code> file and observe that your state store was successfully configured!</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> ./deploy/redis.yaml</code></pre></div>\n<p><strong>üìú Viewing Logs</strong></p>\n<p>Now that the Node.js and Python applications are deployed, watch messages come through:</p>\n<p><strong>Node.js App Logs</strong></p>\n<p>Get the logs of the Node.js app:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl logs <span class=\"token parameter variable\">--selector</span><span class=\"token operator\">=</span>app<span class=\"token operator\">=</span>node <span class=\"token parameter variable\">-c</span> <span class=\"token function\">node</span> <span class=\"token parameter variable\">--tail</span><span class=\"token operator\">=</span>-1</code></pre></div>\n<p>If all went well, you should see logs like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Got a new order<span class=\"token operator\">!</span> Order ID: <span class=\"token number\">1</span>\nSuccessfully persisted state <span class=\"token keyword\">for</span> Order ID: <span class=\"token number\">1</span>\nGot a new order<span class=\"token operator\">!</span> Order ID: <span class=\"token number\">2</span>\nSuccessfully persisted state <span class=\"token keyword\">for</span> Order ID: <span class=\"token number\">2</span>\nGot a new order<span class=\"token operator\">!</span> Order ID: <span class=\"token number\">3</span>\nSuccessfully persisted state <span class=\"token keyword\">for</span> Order ID: <span class=\"token number\">3</span></code></pre></div>\n<p><strong>API Call Logs</strong></p>\n<p>Observe API call logs:</p>\n<p><strong>Node.js App API Logs</strong></p>\n<p>Get the API call logs of the Node.js app:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl logs <span class=\"token parameter variable\">--selector</span><span class=\"token operator\">=</span>app<span class=\"token operator\">=</span>node <span class=\"token parameter variable\">-c</span> daprd <span class=\"token parameter variable\">--tail</span><span class=\"token operator\">=</span>-1</code></pre></div>\n<p>When save state API calls are made, you should see logs similar to this:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2024-11-02T22:46:09.82121774Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">method</span><span class=\"token operator\">=</span><span class=\"token string\">\"POST /v1.0/state/statestore\"</span> <span class=\"token assign-left variable\">app_id</span><span class=\"token operator\">=</span>nodeapp <span class=\"token assign-left variable\">instance</span><span class=\"token operator\">=</span>nodeapp-7dd6648dd4-7hpmh <span class=\"token assign-left variable\">scope</span><span class=\"token operator\">=</span>dapr.runtime.http-info <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>log <span class=\"token assign-left variable\">ver</span><span class=\"token operator\">=</span><span class=\"token number\">1.7</span>.2\n<span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2024-11-02T22:46:10.828764787Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">method</span><span class=\"token operator\">=</span><span class=\"token string\">\"POST /v1.0/state/statestore\"</span> <span class=\"token assign-left variable\">app_id</span><span class=\"token operator\">=</span>nodeapp <span class=\"token assign-left variable\">instance</span><span class=\"token operator\">=</span>nodeapp-7dd6648dd4-7hpmh <span class=\"token assign-left variable\">scope</span><span class=\"token operator\">=</span>dapr.runtime.http-info <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>log <span class=\"token assign-left variable\">ver</span><span class=\"token operator\">=</span><span class=\"token number\">1.7</span>.2</code></pre></div>\n<p><strong>Python App API Logs</strong></p>\n<p>Get the API call logs of the Python app:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl logs <span class=\"token parameter variable\">--selector</span><span class=\"token operator\">=</span>app<span class=\"token operator\">=</span>python <span class=\"token parameter variable\">-c</span> daprd <span class=\"token parameter variable\">--tail</span><span class=\"token operator\">=</span>-1</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2024-11-02T02:47:49.972688145Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">method</span><span class=\"token operator\">=</span><span class=\"token string\">\"POST /neworder\"</span> <span class=\"token assign-left variable\">app_id</span><span class=\"token operator\">=</span>pythonapp <span class=\"token assign-left variable\">instance</span><span class=\"token operator\">=</span>pythonapp-545df48d55-jvj52 <span class=\"token assign-left variable\">scope</span><span class=\"token operator\">=</span>dapr.runtime.http-info <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>log <span class=\"token assign-left variable\">ver</span><span class=\"token operator\">=</span><span class=\"token number\">1.7</span>.2\n<span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2024-11-02T02:47:50.984994545Z\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">method</span><span class=\"token operator\">=</span><span class=\"token string\">\"POST /neworder\"</span> <span class=\"token assign-left variable\">app_id</span><span class=\"token operator\">=</span>pythonapp <span class=\"token assign-left variable\">instance</span><span class=\"token operator\">=</span>pythonapp-545df48d55-jvj52 <span class=\"token assign-left variable\">scope</span><span class=\"token operator\">=</span>dapr.runtime.http-info <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>log <span class=\"token assign-left variable\">ver</span><span class=\"token operator\">=</span><span class=\"token number\">1.7</span>.2</code></pre></div>\n<p><strong>‚úÖ Confirm Successful Persistence</strong></p>\n<p>Call the Node.js app's order endpoint to get the latest order. Grab the external IP address that you saved before, append <code class=\"language-text\">/order</code>, and perform a GET request against it (enter it into your browser, use Postman, or curl it!):</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token variable\">$NODE_APP</span>/order\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"orderID\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"42\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>You should see the latest JSON in response!</p>\n<p>This will spin down each resource defined by the <code class=\"language-text\">.yaml</code> files in the <code class=\"language-text\">deploy</code> directory, including the state component.</p>\n<blockquote>\n<p><strong>Note</strong>: This will also delete the state store component. If the <code class=\"language-text\">--dev</code> flag was used for Dapr init, and you want to use the <code class=\"language-text\">dapr-dev-redis</code> deployment as state store, replace the <code class=\"language-text\">redisHost</code> value inside <code class=\"language-text\">./deploy/redis.yaml</code> with <code class=\"language-text\">dapr-dev-redis-master:6379</code> and also the <code class=\"language-text\">secretKeyRef</code>, <code class=\"language-text\">name</code> with <code class=\"language-text\">dapr-dev-redis</code>. Then run the command <code class=\"language-text\">kubectl apply -f ./deploy/redis.yaml</code>, to apply the file again. This will create a <code class=\"language-text\">statestore</code> Dapr component pointing to <code class=\"language-text\">dapr-dev-redis</code> deployment.</p>\n</blockquote>\n<p>For more details, check the <a href=\"https://docs.dapr.io/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">official Dapr documentation</a>.</p>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèÅ Conclusion</h2>\n<p>In this blog post, we explored how Dapr can significantly simplify the development and management of distributed applications on AWS EKS. By leveraging Dapr's building blocks, such as service invocation, state management, and pub/sub messaging, developers can focus more on business logic and less on the complexities of distributed systems.</p>\n<p>We demonstrated how to set up an AWS EKS cluster, deploy sample applications, and integrate Dapr to enhance microservices architecture. This approach not only accelerates development but also ensures that your applications are scalable, secure, and maintainable.</p>\n<p>Dapr's open-source nature and extensive documentation make it an excellent choice for organizations looking to streamline their microservices development on Kubernetes. Whether you are just starting with microservices or looking to optimize your existing architecture, Dapr provides the tools and best practices to help you succeed.</p>\n<p>For more information and detailed guides, be sure to check out the <a href=\"https://docs.dapr.io/\" target=\"_blank\" rel=\"noopener noreferrer\">official Dapr documentation</a>.</p>\n<p>Happy coding! üöÄ</p>\n<br>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/topology-aware-routing-kubernetes/","title":"Improve Network Performance with Topology Aware Routing in Amazon EKS ‚úí","date":"2024-11-01 20:00:00"},"excerpt":"How Topology Aware Routing Can Reduce Costs and Improve Network Performance üöÄ üîñ Introduction  As Kubernetes clusters are increasingly‚Ä¶","html":"<blockquote>\n<p><strong>How Topology Aware Routing Can Reduce Costs and Improve Network Performance üöÄ</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîñ Introduction</h2>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 54.70588235294118%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABr0lEQVR42o2S227TQBRF+8H8CuITeIRf4KG8I4RQUSu7IfGl8TX22PF17Ngzi7EbIQIpqqytsUfb65wzs2+0UmitL3Qye4PSDLNaNc6a0Xy307NXnaWv6OYCaB6MDnLG7RRihlxBatZo1PjtvPoWj34NsBuM2aximPF6zdefT9x+37DZhwRVRyLVCju2it4UXd6V+guo1GKCth/5cJvRdiPSmNwBLHfDvfUFe3uHk2a4cnEqPn0bud/K60B9BkopyXJB17Z4YYwVJLhBwFMSs4szdkmO7e9p294UN+dpjmSer428HLCBFqKgKATTNFEdS0ohyA8Zwuzn2QGRZZRFwTBI8vxAHIUGOF0HLhDbtrEsi7JJyGqHvMhwXI+d46xK0hRRhxStj+d5PD5uOJ1O63Tqj3v4PXLTNFRVZeKgOFalGb2mqWvTmaCujvRdS1UWSNNhWZZEUXQBeiE2pto8s49itmHKxnf54T5gOT7bIMb29si+/6erF4HPN66J+gnX/BfIkTfv3vP242fCCdxmWmOl9StzqM6hTU3G/F4Rj3D3JHhIjibYpkA//xe2AH8BO5FQ9eUzMXAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/9e0ee14cda75263528143430f4303c82/c5bb3/image.png\" srcset=\"/static/9e0ee14cda75263528143430f4303c82/04472/image.png 170w,\n/static/9e0ee14cda75263528143430f4303c82/9f933/image.png 340w,\n/static/9e0ee14cda75263528143430f4303c82/c5bb3/image.png 680w,\n/static/9e0ee14cda75263528143430f4303c82/b12f7/image.png 1020w,\n/static/9e0ee14cda75263528143430f4303c82/b5a09/image.png 1360w,\n/static/9e0ee14cda75263528143430f4303c82/b5c8e/image.png 2194w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>As Kubernetes clusters are increasingly deployed in multi-zone environments, it becomes important to keep network traffic within the zone where it originated. <a href=\"https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/\" target=\"_blank\" rel=\"noopener noreferrer\">Topology Aware Routing</a> (TAR) is a feature in Kubernetes that adjusts routing behavior to prefer keeping traffic in the zone it originated from.</p>\n<p>This can help reduce costs or improve network performance by minimizing inter-zone traffic and ensuring that traffic reaches its destination with minimal delay.</p>\n<p>In this blog post, we will learn about the concept of Kubernetes topology aware routing and discuss its benefits in terms of reducing latency and optimizing network traffic flow.</p>\n<p>We will also show you how to enable Topology Aware Routing for a Service and minimize the performance impact of overlay networking. In this blog post, we will refer to Topology Aware Routing as TAR.</p>\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>Prior to Kubernetes 1.27, this feature was known as Topology Aware Hints.</p>\n</div>\n<br>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHEaGJJCv/EABYQAQEBAAAAAAAAAAAAAAAAAAEAEP/aAAgBAQABBQIMYmb/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAADAAMAAAAAAAAAAAAAAAAAAREhMVH/2gAIAQEAAT8hoh8Io7HybH//2gAMAwEAAgADAAAAEL/v/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAERIUH/2gAIAQMBAT8Q2BKj/8QAFhEBAQEAAAAAAAAAAAAAAAAAABFB/9oACAECAQE/EMV//8QAGRABAQEBAQEAAAAAAAAAAAAAAQARITFh/9oACAEBAAE/EMHQuXg58iWBkjBfJDYyVrf/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"topology-aware-routing-cover\" title=\"\" src=\"/static/22d537a84aef2176b19b1d7ab3202478/7bf67/topology-aware-routing.jpg\" srcset=\"/static/22d537a84aef2176b19b1d7ab3202478/651be/topology-aware-routing.jpg 170w,\n/static/22d537a84aef2176b19b1d7ab3202478/d30a3/topology-aware-routing.jpg 340w,\n/static/22d537a84aef2176b19b1d7ab3202478/7bf67/topology-aware-routing.jpg 680w,\n/static/22d537a84aef2176b19b1d7ab3202478/990cb/topology-aware-routing.jpg 1020w,\n/static/22d537a84aef2176b19b1d7ab3202478/e5166/topology-aware-routing.jpg 1200w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-impact-of-tar-on-network-traffic-in-amazoneks\" style=\"position:relative;\"><a href=\"#-impact-of-tar-on-network-traffic-in-amazoneks\" aria-label=\" impact of tar on network traffic in amazoneks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê Impact of TAR on Network Traffic in Amazon¬†EKS</h2>\n<p>A best practice for architecting resilient systems in AWS is to leverage multiple Availability Zones (AZs). AWS Regions are composed of multiple AZs designed to be independent of each other and are separated by a meaningful physical distance to avoid correlated failure scenarios.</p>\n<p>AWS EKS makes it possible for customers to run their mission-critical workloads across multiple distinct AZs, providing increased availability by combining Amazon's global infrastructure with Kubernetes constructs such as pod topology spread constraints. However, when architecting workloads in this manner, there are considerations in terms of both latency and cost to consider. Pods within the same Amazon EKS cluster can easily communicate using a Kubernetes Cluster IP Service, which routes traffic to its associated pods even if they are in different AZs.</p>\n<p>Although this is a convenient way to take advantage of multiple AZs, some customers may want to bias traffic routing to pods in the same AZ as the originator. Keeping traffic in the same AZ benefits latency-sensitive workloads for low latency and can reduce inter-AZ data transfer costs.</p>\n<p>TAR is a feature that reached beta status in Kubernetes version 1.23 and became available in Amazon EKS version 1.24. It's intended to provide a mechanism that attempts to keep traffic closer to its origin within the same AZ or in another location.</p>\n<h2 id=\"Ô∏è-services-in-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-services-in-kubernetes\" aria-label=\"Ô∏è services in kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Services in Kubernetes</h2>\n<p>Let's begin by explaining how a Kubernetes Service operates before exploring TAR.</p>\n<p>When you create a Service, you define a selector to target specific pods. Kubernetes generates an Endpoints object, which maintains the IP addresses of the relevant pods. Subsequently, the Kubernetes controller assigns a Cluster IP to the Service‚Ää-‚Ääa virtual IP accessible only within the worker nodes of the Kubernetes cluster.</p>\n<p>The kube-proxy DaemonSet instance, running on each node, establishes a set of <a href=\"https://kubernetes.io/docs/reference/networking/virtual-ips/#proxy-modes\" target=\"_blank\" rel=\"noopener noreferrer\">iptables rules</a> (or IP Virtual Server (IPVS) virtual servers, if enabled). When traffic is directed at the Cluster IP (or enters the cluster via NodePort), either iptables or IPVS routes the packet to a pod based on its load balancing algorithm.</p>\n<p>By default, kube-proxy adds all pods from an Endpoints object to each node's iptables or IPVS, without considering factors like the availability zones (AZs) where the pods reside or the originating traffic zone.</p>\n<p>Consequently, packets are routed indiscriminately across AZs, potentially introducing latency and incurring inter-AZ data traffic costs.</p>\n<h2 id=\"-understanding-tar-functionality\" style=\"position:relative;\"><a href=\"#-understanding-tar-functionality\" aria-label=\" understanding tar functionality permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Understanding TAR Functionality</h2>\n<p>TAR offers a different way to route traffic by sending some endpoints to kube-proxy. It relies on the EndpointSlices controller, which is more flexible than the Endpoints controller. Endpoints in the Endpoints controller only have pod IP addresses and ports, but EndpointSlices can include hints. Hints are extra labels on each endpoint.</p>\n<p>TAR adds a hint about which zone the endpoint is in. When a hint is added, kube-proxy filters the endpoints based on these hints. Usually, it picks endpoints in the same zone. When traffic reaches kube-proxy, it is directed only to pods in the same zone, avoiding traffic costs.</p>\n<h3 id=\"hands-on-example\" style=\"position:relative;\"><a href=\"#hands-on-example\" aria-label=\"hands on example permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Hands-on example</h3>\n<p>In this walkthrough, you'll deploy an EKS cluster using Terraform. You can design your infrastructures as templates and use Terraform to provision, manage, and destroy them. Besides the cluster itself, Terraform also deploys the AWS Distro for <a href=\"https://aws-otel.github.io/\" target=\"_blank\" rel=\"noopener noreferrer\">OpenTelemetry (ADOT) Operator</a> via its <a href=\"https://github.com/aws-ia/terraform-aws-eks-blueprints-addons\" target=\"_blank\" rel=\"noopener noreferrer\">EKS Blueprints add-ons</a>. The ADOT Operator enables a simplified experience for instrumenting your applications running on Amazon EKS to capture metrics and tracing data.</p>\n<p>We'll use the ADOT Operator and AWS X-Ray to visualize the requests between workloads running on the Amazon EKS cluster. After the EKS cluster and its related infrastructure are created, we deploy the containers sample application, which shows traffic between separate front-end and back-end components. This allows us to explore how different configurations of the EKS worker nodes and pods affect TAR.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 41.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbUlEQVR42m1Sy04DMQzki/kUfoB/4MSBA0c4IYEEQqpAQBF0u9Cm227edpLBSbU8JCKtHK+t8cw4B/jn5FLgIsF6D04JRfLfp+bMjNEY6EBQ210ZtUVKaXXw3ZQLsnwpZxBFbEaHq+cBxgdEyfeDpE8iM0nd4/59hNIGNsQ2kph/AKcjP2GshQsRyyG0qCUvJTewLAOddxiMR7+TunOVWZMQK6CWCZEsXu4sLk822A0OgQKUcZgtt8IwIgQHJYyOzhQeOgsmh9ERHnuDxVrhqd+VxcACKZK7rhcGG1ycdjg6vEG/2MJHJywDZl1lSsLCik8Gx+cd5v2IGGyT/Lr2sFZjqXRZmSzsBVDoNhkpZWlkYUsIMWJwAXM1QouHVmRJM0gGJfHPhwCS/rX2mH8q2Eh7yfSPh3Wr1ZdRJF+/6OZhBZg2XWOMAR8bg9s30+7Eew//LKX2T6+jbpp5z5yFyW+w6VlN9fYqmFtF7qsvCgNrrVuCBAkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"architecture\" title=\"\" src=\"/static/5f9bc54493477318b0f91ac674514614/c5bb3/architecture.png\" srcset=\"/static/5f9bc54493477318b0f91ac674514614/04472/architecture.png 170w,\n/static/5f9bc54493477318b0f91ac674514614/9f933/architecture.png 340w,\n/static/5f9bc54493477318b0f91ac674514614/c5bb3/architecture.png 680w,\n/static/5f9bc54493477318b0f91ac674514614/bcb8c/architecture.png 879w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Prerequisites</h3>\n<p>For this demo, you need the following:</p>\n<ul>\n<li>Basic understanding of Linux operating systems and Kubernetes.</li>\n<li>An AWS account.</li>\n<li>Administrator or equivalent access to deploy the required resources.</li>\n<li><a href=\"https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Command Line Interface (AWS CLI)</a> installed and configured.</li>\n<li><a href=\"https://learn.hashicorp.com/tutorials/terraform/install-cli\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform CLI</a> installed.</li>\n<li><a href=\"https://git-scm.com/book/en/v2/Getting-Started-Installing-Git\" target=\"_blank\" rel=\"noopener noreferrer\">Git CLI</a> installed.</li>\n<li><a href=\"https://kubernetes.io/docs/tasks/tools/install-kubectl/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl</a> and <a href=\"https://helm.sh/docs/intro/install/\" target=\"_blank\" rel=\"noopener noreferrer\">helm client</a> installed.</li>\n</ul>\n<h3 id=\"deploy-ekscluster\" style=\"position:relative;\"><a href=\"#deploy-ekscluster\" aria-label=\"deploy ekscluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy EKS¬†Cluster</h3>\n<p>We prepared a Terraform template to deploy Amazon EKS cluster and ADOT Operator. Start by cloning the sample source code repository from GitHub.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/seifrajhi/topology-aware-routing-tf\n<span class=\"token builtin class-name\">cd</span> topology-aware-routing-tf/terraform</code></pre></div>\n<p>Run the following command to deploy the cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_REGION</span><span class=\"token operator\">=</span><span class=\"token string\">\"eu-west-1\"</span>\nterraform init\nterraform plan\nterraform apply -auto-approve</code></pre></div>\n<p>Once the Terraform has completed, then you can set up kubectl by running this command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws eks <span class=\"token parameter variable\">--region</span> <span class=\"token variable\">$AWS_REGION</span> update-kubeconfig <span class=\"token parameter variable\">--name</span> tar-demo-cluster</code></pre></div>\n<h3 id=\"deploy-the-demoapp\" style=\"position:relative;\"><a href=\"#deploy-the-demoapp\" aria-label=\"deploy the demoapp permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy the Demo¬†App</h3>\n<p>Run the following command to deploy the sample application:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> <span class=\"token punctuation\">..</span>/kubernetes\nkubectl apply --server-side <span class=\"token parameter variable\">-f</span> common.yaml\nkubectl apply --server-side <span class=\"token parameter variable\">-f</span> simple.yaml</code></pre></div>\n<p>Get the endpoint for UI component by running the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get svc ui-lb <span class=\"token parameter variable\">-n</span> ui <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>.status.loadBalancer.ingress<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>.hostname<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can access the demo application by accessing this link. This displays an example online shopping site.</p>\n<h3 id=\"run-initial-loadtesting\" style=\"position:relative;\"><a href=\"#run-initial-loadtesting\" aria-label=\"run initial loadtesting permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Run Initial Load¬†Testing</h3>\n<p>Now we have deployed the EKS cluster and demo application, we can run a load test to simulate traffic and see how traffic between front-end and back-end is routed.</p>\n<p>We'll use <a href=\"https://github.com/rakyll/hey\" target=\"_blank\" rel=\"noopener noreferrer\">hey</a> to generate traffic, which is a small application that can send HTTP requests.</p>\n<p>Before you test TAR, you may want to know how traffic has been routed without TAR for comparison. You can determine this by performing a load test against this application, and traffic shows on AWS X-Ray service graph.</p>\n<p>Run load test against UI load balancer. Run the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">UI_ENDPOINT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl get svc ui-lb <span class=\"token parameter variable\">-n</span> ui <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'{.status.loadBalancer.ingress[0].hostname}'</span><span class=\"token variable\">)</span></span>\nkubectl run load-generator <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--image</span><span class=\"token operator\">=</span>williamyeh/hey:latest <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>Never -- <span class=\"token parameter variable\">-c</span> <span class=\"token number\">10</span> <span class=\"token parameter variable\">-q</span> <span class=\"token number\">5</span> <span class=\"token parameter variable\">-z</span> 60m http://<span class=\"token variable\">$UI_ENDPOINT</span>/home</code></pre></div>\n<h3 id=\"enable-tar-and-re-run-loadtesting\" style=\"position:relative;\"><a href=\"#enable-tar-and-re-run-loadtesting\" aria-label=\"enable tar and re run loadtesting permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Enable TAR and Re-run Load¬†Testing</h3>\n<p>Enabling TAR is easy: simply set the <code class=\"language-text\">service.kubernetes.io/topology-mode</code> annotation to <code class=\"language-text\">Auto</code> on a Service. The EndpointSlice controller will try to assign hints to each endpoint in an EndpointSlice to steer traffic to Pods within a given zone. It's important to understand the <a href=\"https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/#safeguards\" target=\"_blank\" rel=\"noopener noreferrer\">safeguards</a> and <a href=\"https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/#constraints\" target=\"_blank\" rel=\"noopener noreferrer\">constraints</a> implemented by the EndpointSlice controller and the kube-proxy, especially if routing isn't working as you expect.</p>\n<blockquote>\n<p><strong>Note:</strong> Prior to Kubernetes 1.27, this behavior was controlled using the <code class=\"language-text\">service.kubernetes.io/topology-aware-hints</code> annotation.</p>\n</blockquote>\n<p>Now let's enable TAR and re-run the load test to see if that improves traffic routing. Run the following command to enable TAR on the catalog Service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl <span class=\"token parameter variable\">-n</span> catalog annotate svc catalog service.kubernetes.io/topology-mode<span class=\"token operator\">=</span>Auto</code></pre></div>\n<p>You can run the following command to check if hints are set:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get endpointslices <span class=\"token parameter variable\">-l</span> kubernetes.io/service-name<span class=\"token operator\">=</span>catalog <span class=\"token parameter variable\">-n</span> catalog <span class=\"token parameter variable\">-o</span> yaml</code></pre></div>\n<p>You'll get results similar to the following example. If you see hints and a corresponding AZ name, then the TAR is enabled and was successfully activated.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">addressType</span><span class=\"token punctuation\">:</span> IPv4\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> discovery.k8s.io/v1\n<span class=\"token key atrule\">endpoints</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> 10.0.10.100\n  <span class=\"token key atrule\">conditions</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ready</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">serving</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">terminating</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">hints</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">forZones</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> eu<span class=\"token punctuation\">-</span>west<span class=\"token punctuation\">-</span>1a</code></pre></div>\n<p>The control plane is very conservative about TAR decisions. If you run into issues, such as errors in the Service events or you find that hints are not populating on the EndpointSlice, then you should double-check that your topology labels have been applied and that Nodes are reporting values for allocatable CPU.</p>\n<p>Re-run the load test with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">UI_ENDPOINT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl get svc ui-lb <span class=\"token parameter variable\">-n</span> ui <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'{.status.loadBalancer.ingress[0].hostname}'</span><span class=\"token variable\">)</span></span>\nkubectl run load-generator <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--image</span><span class=\"token operator\">=</span>williamyeh/hey:latest <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>Never -- <span class=\"token parameter variable\">-c</span> <span class=\"token number\">10</span> <span class=\"token parameter variable\">-q</span> <span class=\"token number\">5</span> <span class=\"token parameter variable\">-z</span> 60m http://<span class=\"token variable\">$UI_ENDPOINT</span>/home</code></pre></div>\n<p>Now you know that each UI pod only talks to one catalog pod. You can also find that UI pod always talks to catalog pod that resides on the same AZ. No inter-AZ data traffic cost is incurred in this scenario.</p>\n<h2 id=\"-endnotes\" style=\"position:relative;\"><a href=\"#-endnotes\" aria-label=\" endnotes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîö End¬†Notes</h2>\n<p>Topology Aware Routing is a useful feature in Kubernetes that helps manage traffic flow by keeping it within the same zone where it originated. While it may not be suitable for every workload, it can be beneficial in environments with evenly distributed zonal traffic.</p>\n<p>In this blog post, we explored TAR and its effects on network traffic routing in Amazon EKS. We also provided a walkthrough on how to enable TAR for a Service and minimize the performance impact of overlay networking.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next talk.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this talk feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}