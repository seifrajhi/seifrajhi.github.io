{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/eks-and-aws-secrets-manager/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Enhance security and simplify secrets management for K8s apps</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üóØ Introduction</h2>\n<p>Managing secrets like API keys and database passwords securely is important to keep the applications running in Kubernetes secure.</p>\n<p>And if you're using Amazon EKS Elastic Kubernetes Service for your Kubernetes applications, AWS KMS with AWS Secrets Manager can help you handle these secrets safely and easily.</p>\n<h2 id=\"Ô∏è-using-aws-secrets-manager-with-amazoneks\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-using-aws-secrets-manager-with-amazoneks\" aria-label=\"Ô∏è using aws secrets manager with amazoneks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>„äôÔ∏è Using AWS Secrets Manager with Amazon¬†EKS</h2>\n<p><a href=\"https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Secrets Manager</a> can be integrated with EKS using the <a href=\"https://github.com/aws/secrets-store-csi-driver-provider-aws\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Secrets and Configuration Provider ASCP</a> for the <a href=\"https://secrets-store-csi-driver.sigs.k8s.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Secrets Store CSI Driver</a>.</p>\n<p><strong>Benefits:</strong></p>\n<ul>\n<li>Centralized secret management</li>\n<li>Fine-grained access control</li>\n<li>Seamless integration with EKS</li>\n<li>Ability to mount secrets as volumes in pods</li>\n<li>Option to sync with native Kubernetes secrets</li>\n</ul>\n<p><strong>Implementation steps:</strong></p>\n<ol>\n<li>Create secrets in AWS Secrets Manager</li>\n<li>Create an IAM policy for secret retrieval</li>\n<li>Use <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html\" target=\"_blank\" rel=\"noopener noreferrer\">IAM Roles for Service Accounts (IRSA)</a> to limit secret access</li>\n<li>Deploy a SecretProviderClass custom resource</li>\n<li>Configure pods to mount volumes based on the SecretProviderClass</li>\n<li>Sync mounted secrets to native Kubernetes secrets</li>\n<li>Set up environment variables in pods using specific secret keys</li>\n</ol>\n<h2 id=\"encrypting-kubernetes-secrets-in-amazoneks\" style=\"position:relative;\"><a href=\"#encrypting-kubernetes-secrets-in-amazoneks\" aria-label=\"encrypting kubernetes secrets in amazoneks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Encrypting Kubernetes Secrets in Amazon¬†EKS</h2>\n<p>Amazon EKS clusters (version 1.13+) support encrypting <a href=\"https://kubernetes.io/docs/concepts/configuration/secret/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes secrets</a> using <a href=\"https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Key Management Service (KMS) Customer Managed Keys (CMK)</a>. This provides stronger security than the default Base64 encoding.\nKey points:</p>\n<ul>\n<li>No changes are required in how secrets are used.</li>\n<li>Encryption provider support must be enabled during EKS cluster creation</li>\n<li>Each secret write generates a unique Data Encryption Key (DEK).</li>\n<li>The DEK is encrypted with the CMK and stored in etcd.</li>\n<li>Decryption occurs when pods access the secret.</li>\n</ul>\n<h2 id=\"eks-secrets-and-secrets-manager-hands-onguide\" style=\"position:relative;\"><a href=\"#eks-secrets-and-secrets-manager-hands-onguide\" aria-label=\"eks secrets and secrets manager hands onguide permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>EKS Secrets and Secrets Manager hands-on¬†guide</h2>\n<p>Let us start by provisioning our EKS cluster using Terraform the IAC tool.</p>\n<p>First, clone the repo:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">git</span> clone https://github.com/seifrajhi/eks-secrets-manager-kms-demo.git</code></pre></div>\n<p>Then run the following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">cd</span> eks-secrets-manager-kms-demo/eks-tf\n$ terraform init\n$ terraform plan\n$ terraform apply --auto-approve</code></pre></div>\n<p>This will provision the EKS cluster and VPC with the needed add-ons.</p>\n<h2 id=\"deploy-theapp\" style=\"position:relative;\"><a href=\"#deploy-theapp\" aria-label=\"deploy theapp permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy the¬†app</h2>\n<p>To deploy the app, clone the repo:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">git</span> clone https://github.com/seifrajhi/eks-secrets-manager-kms-demo.git</code></pre></div>\n<p>For the deployment of our demo application, we have created the Helm chart and uploaded it to the <a href=\"https://github.com/seifrajhi/eks-secrets-manager-kms-demo/tree/main/helm-charts\" target=\"_blank\" rel=\"noopener noreferrer\">Git Repository</a>.</p>\n<p>Install the Helm chart:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> eks-secrets-manager-kms-demo/helm-charts\nhelm <span class=\"token function\">install</span> demo <span class=\"token builtin class-name\">.</span>\nNAME: demo\nLAST DEPLOYED: Sat Oct <span class=\"token number\">11</span> <span class=\"token number\">18</span>:42:20 <span class=\"token number\">2024</span>\nNAMESPACE: default\nSTATUS: deployed\nREVISION: <span class=\"token number\">1</span></code></pre></div>\n<h3 id=\"deploy-amazon-ebs-csidriver\" style=\"position:relative;\"><a href=\"#deploy-amazon-ebs-csidriver\" aria-label=\"deploy amazon ebs csidriver permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy Amazon EBS CSI¬†Driver</h3>\n<p><a href=\"https://github.com/container-storage-interface/spec/blob/master/spec.md\" target=\"_blank\" rel=\"noopener noreferrer\">The Container Storage Interface (CSI)</a> is a standard for exposing arbitrary block and file storage systems to containerized workloads on Container Orchestration Systems (COs) like Kubernetes.\nUsing CSI third-party storage providers can write and deploy plugins exposing new storage systems in Kubernetes without ever having to touch the core Kubernetes code.</p>\n<p><a href=\"https://github.com/kubernetes-sigs/aws-ebs-csi-driver\" target=\"_blank\" rel=\"noopener noreferrer\">The Amazon Elastic Block Store (Amazon EBS) Container Storage Interface (CSI) driver</a> provides a CSI interface that allows Amazon Elastic Kubernetes Service (Amazon EKS) clusters to manage the lifecycle of Amazon EBS volumes for persistent volumes.</p>\n<p>EBS was installed as part of the cluster add-ons.</p>\n<h3 id=\"define-storage-class\" style=\"position:relative;\"><a href=\"#define-storage-class\" aria-label=\"define storage class permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Define Storage Class</h3>\n<p><a href=\"https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/\" target=\"_blank\" rel=\"noopener noreferrer\">Dynamic Volume Provisioning</a> allows storage volumes to be created on-demand.</p>\n<p><a href=\"https://kubernetes.io/docs/concepts/storage/storage-classes/\" target=\"_blank\" rel=\"noopener noreferrer\">StorageClass</a> should be pre-created to define which provisioner should be used and what parameters should be passed when dynamic provisioning is invoked.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> StorageClass\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> storage.k8s.io/v1\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">-</span>gp3\n<span class=\"token key atrule\">provisioner</span><span class=\"token punctuation\">:</span> ebs.csi.aws.com <span class=\"token comment\"># &lt;--  Amazon EBS CSI driver</span>\n<span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> gp3\n  <span class=\"token key atrule\">encrypted</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span> \n<span class=\"token key atrule\">volumeBindingMode</span><span class=\"token punctuation\">:</span> WaitForFirstConsumer\n<span class=\"token key atrule\">reclaimPolicy</span><span class=\"token punctuation\">:</span> Delete\n<span class=\"token key atrule\">mountOptions</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> debug</code></pre></div>\n<p>Create storageclass <code class=\"language-text\">mysql-gp3</code> by running the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> sc-gp3-mysql.yaml</code></pre></div>\n<h3 id=\"deploy-statefulset-workload\" style=\"position:relative;\"><a href=\"#deploy-statefulset-workload\" aria-label=\"deploy statefulset workload permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deploy StatefulSet workload</h3>\n<p>We are going to deploy a MYSQL database using StatefulSet.</p>\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>The MySQL deployment consists of a ConfigMap, two Services, a Kubernetes secret for the root password and a StatefulSet.</p>\n</div>\n<p>The <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/\" target=\"_blank\" rel=\"noopener noreferrer\">ConfigMap</a> allows you to decouple configuration artifacts and secrets from image content to keep containerized applications portable.</p>\n<p>The ConfigMap stores <code class=\"language-text\">source.cnf</code>, <code class=\"language-text\">replica.cnf</code> and passes them when initializing leader and follower pods defined in StatefulSet:</p>\n<ul>\n<li><strong>source.cnf:</strong> is for the MySQL leader pod which has binary log option (log-bin) to provides a record of the data changes to be sent to follower servers.</li>\n<li><strong>replica.cnf:</strong> is for follower pods which have super-read-only option.</li>\n</ul>\n<p><code class=\"language-text\">mysql-cm.yaml</code> manifest:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">-</span>config\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> workshop\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mysql\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">source.cnf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    # Apply this config only on the leader.\n    [mysqld]\n    log-bin</span>\n  <span class=\"token key atrule\">replica.cnf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    # Apply this config only on followers.\n    [mysqld]\n    # super-read-only</span></code></pre></div>\n<p>Then run:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create <span class=\"token parameter variable\">-f</span> mysql-cm.yaml</code></pre></div>\n<p>StatefulSet requires a <a href=\"https://kubernetes.io/docs/concepts/services-networking/service/#headless-services\" target=\"_blank\" rel=\"noopener noreferrer\">Headless Service</a> to control the domain of its Pods, directly reach each Pod with stable DNS entries.</p>\n<blockquote>\n<p>The Headless Service provides a home for the DNS entries that the StatefulSet controller creates for each Pod that's part of the set. By specifying \"None\" for the clusterIP, you can create Headless Service.</p>\n<p>Because the Headless Service is named mysql, the Pods are accessible by resolving¬†<strong><code class=\"language-text\">.mysql</code></strong> from within any other Pod in the same Kubernetes cluster and namespace.</p>\n</blockquote>\n<p>You can see the <code class=\"language-text\">mysql service</code> is for DNS resolution so that when pods are placed by StatefulSet controller, pods can be resolved using pod-name.mysql.</p>\n<p>The Client Service <code class=\"language-text\">mysql-read</code> is a normal client Service with its own cluster IP that distributes connections across all MySQL Pods that report being Ready.</p>\n<p>Create service <strong>mysql</strong> and <strong>mysql-read</strong> by running the following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">git</span> clone https://github.com/seifrajhi/eks-secrets-manager-kms-demo.git\n$ <span class=\"token builtin class-name\">cd</span> eks-secrets-manager-kms-demo/demo-app\n$ kubectl create <span class=\"token parameter variable\">-f</span> mysql-svc.yaml</code></pre></div>\n<p>StatefulSet consists of <strong>serviceName</strong>, <strong>replicas</strong>, <strong>template</strong> and <strong>volumeClaimTemplates</strong>:</p>\n<ul>\n<li>serviceName is \"mysql\", headless service we created in previous section.</li>\n<li>replicas is 2, the desired number of pod.</li>\n<li>template is the configuration of pod.</li>\n<li>volumeClaimTemplates is to claim volume for pod based on storageClassName gp3.</li>\n</ul>\n<p>Run the following command under demo-app directory:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply <span class=\"token parameter variable\">-f</span> statefulset.yaml</code></pre></div>\n<p><strong>Populate database:</strong></p>\n<p>We are creating the database qa and products table in below command and inserting a products into the table. Later we will see how this data will show up in our application which is accessing this database.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl <span class=\"token parameter variable\">-n</span> workshop run mysql-client <span class=\"token parameter variable\">--image</span><span class=\"token operator\">=</span>mysql:5.7 <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>Never --<span class=\"token punctuation\">\\</span>\n  mysql <span class=\"token parameter variable\">-uroot</span> <span class=\"token parameter variable\">-pdemo_ascp</span> <span class=\"token parameter variable\">-h</span> mysql-0.mysql.workshop <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\nCREATE DATABASE qa;\nCREATE TABLE qa.products (prodId VARCHAR(120), prodName VARCHAR(120));\nINSERT INTO qa.products (prodId,prodName) VALUES ('999','Mountain Bike');\nEOF</span></code></pre></div>\n<h2 id=\"kubernetes-secrets-encryption-using-aws-kms\" style=\"position:relative;\"><a href=\"#kubernetes-secrets-encryption-using-aws-kms\" aria-label=\"kubernetes secrets encryption using aws kms permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes secrets encryption using AWS KMS</h2>\n<p>When we deployed the MySQL database, and the kubernetes secret <code class=\"language-text\">mysql-secret</code> to hold the <strong>password</strong> for the database, the EKS control plane created a <a href=\"https://docs.aws.amazon.com/sns/latest/dg/sns-server-side-encryption.html#sse-key-terms\" target=\"_blank\" rel=\"noopener noreferrer\">Data Encryption Key (DEK)</a> to encrypt the secret, saved the encrypted secret to etcd and used <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/\" target=\"_blank\" rel=\"noopener noreferrer\">kms:encrypt</a> to encrypt DEK and cached the encrypted DEK.</p>\n<p>Let's use the Kubernetes secret <code class=\"language-text\">mysql-secret</code> created while deploying the MySQL StatefulSet in the prodcatalog service to connect to the MYSQL database and show how EKS uses KMS to decrypt the Kubernetes secret <code class=\"language-text\">mysql-secret</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">cd</span> helm-charts\n$ helm upgrade --reuse-values <span class=\"token parameter variable\">-f</span> values-k8s-secret.yaml demo <span class=\"token builtin class-name\">.</span>\n\nRelease <span class=\"token string\">\"demo\"</span> has been upgraded. Happy Helming<span class=\"token operator\">!</span>\nNAME: demo\nLAST DEPLOYED: Sat Oct <span class=\"token number\">11</span> <span class=\"token number\">19</span>:20:20 <span class=\"token number\">2024</span>\nNAMESPACE: default\nSTATUS: deployed\nREVISION: <span class=\"token number\">3</span></code></pre></div>\n<p><strong>Validate Kubernetes Encryption using KMS:</strong></p>\n<p>Now let's validate that AWS KMS was used when we create and use the kubernetes secret.</p>\n<p>Log into console and navigate to <code class=\"language-text\">EKS ‚Üí Cluster ‚Üí Overview,</code> you will see the Secrets encryption as shown below:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 10.588235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAQklEQVR42nXJQQ6AIAwEQP7/0V5sGgVa2C5GjxrjXKeoqohsakjmx5wzE4u35PsBlO4eEeuH7s1qHA5row+cjyJ5AcHjdOJhUX2xAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/63bafc0f58504402037c01232ad633af/c5bb3/kms-eks.png\" srcset=\"/static/63bafc0f58504402037c01232ad633af/04472/kms-eks.png 170w,\n/static/63bafc0f58504402037c01232ad633af/9f933/kms-eks.png 340w,\n/static/63bafc0f58504402037c01232ad633af/c5bb3/kms-eks.png 680w,\n/static/63bafc0f58504402037c01232ad633af/b12f7/kms-eks.png 1020w,\n/static/63bafc0f58504402037c01232ad633af/b5a09/kms-eks.png 1360w,\n/static/63bafc0f58504402037c01232ad633af/29007/kms-eks.png 1600w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>The EKS cluster was created with KMS encryption enabled and that is why your Secrets encryption is enabled.</p>\n<p><em>Make a note of the KMS key ID.</em></p>\n<p>A <strong>cloudtrail Decrypt</strong> event corresponding to this KMS key ID should be available with sourceIpAddress as <code class=\"language-text\">eks.amazonaws.com</code>.</p>\n<p>If you go to <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html\" target=\"_blank\" rel=\"noopener noreferrer\">CloudTrail</a> you should see a record available if you search for the Event types Encrypt and Decrypt.</p>\n<h3 id=\"mount-secrets-from-aws-secretsmanager\" style=\"position:relative;\"><a href=\"#mount-secrets-from-aws-secretsmanager\" aria-label=\"mount secrets from aws secretsmanager permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Mount secrets from AWS Secrets¬†Manager</h3>\n<p>We have the MYSQL StatefulSet deployed and now we are going to save the password for the MYSQL database in AWS Secrets Manager and sync the secrets manager secret to a Native Kubernertes secret using the <a href=\"https://secrets-store-csi-driver.sigs.k8s.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Secrets Store CSI driver</a>.</p>\n<p>The Kubernetes secret created by the CSI driver will be used in the <strong>productcatalog</strong> service to connect to the MYSQL Database.</p>\n<p><strong>Install CSI Driver:</strong></p>\n<p>Prepare your cluster by installing Secrets Store CSI Secret driver and AWS Secrets and Configuration Provider (ASCP).</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm repo <span class=\"token function\">add</span> secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts</code></pre></div>\n<p>Then install the CSI driver:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ helm <span class=\"token function\">install</span> <span class=\"token parameter variable\">-n</span> kube-system csi-secrets-store <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--set</span> <span class=\"token assign-left variable\">syncSecret.enabled</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--set</span> <span class=\"token assign-left variable\">enableSecretRotation</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\nsecrets-store-csi-driver/secrets-store-csi-driver</code></pre></div>\n<p>Then install AWS Secrets and Configuration <a href=\"https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html\" target=\"_blank\" rel=\"noopener noreferrer\">Provider ASCP</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm repo <span class=\"token function\">add</span> aws-secrets-manager https://aws.github.io/secrets-store-csi-driver-provider-aws\nhelm <span class=\"token function\">install</span> <span class=\"token parameter variable\">-n</span> kube-system secrets-provider-aws aws-secrets-manager/secrets-store-csi-driver-provider-aws</code></pre></div>\n<p><strong>Prepare Secret and IAM access:</strong></p>\n<p>Next step, create a test secret in AWS Secrets Manager:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ aws secretsmanager create-secret <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> DBSecret_eksdemo <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--description</span> <span class=\"token string\">\"MYSQL DB Secret.\"</span> <span class=\"token punctuation\">\\</span>\n--secret-string <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>username<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>root<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>password<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>demo_ascp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span></code></pre></div>\n<p>After that, create an IAM policy with permissions to access the secrets manager secret:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IAM_POLICY_ARN_SECRET</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws iam <span class=\"token punctuation\">\\</span>\ncreate-policy <span class=\"token parameter variable\">--query</span> Policy.Arn <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--output</span> text --policy-name DBSecret_eksdemo_secrets_policy<span class=\"token punctuation\">\\</span>\n--policy-document <span class=\"token string\">'{\n\"Version\": \"2012-10-17\",\n\"Statement\": [ {\n\"Effect\": \"Allow\",\n\"Action\": [\"secretsmanager:GetSecretValue\", \"secretsmanager:DescribeSecret\"],\n\"Resource\": [\"'</span>\"$SECRET_ARN<span class=\"token string\">\"'\"</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>'<span class=\"token variable\">)</span></span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$IAM_POLICY_ARN_SECRET</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> 00_iam_policy_arn_dbsecret</code></pre></div>\n<p>Next, create an IAM Service Account IRSA to access the secrets manager secret:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ eksctl create iamserviceaccount <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> <span class=\"token string\">\"catalog-deployment-sa\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--cluster</span> <span class=\"token string\">\"demo-eks-secrets-kms-bottlerocket\"</span> <span class=\"token punctuation\">\\</span>\n--attach-policy-arn <span class=\"token string\">\"<span class=\"token variable\">$IAM_POLICY_ARN_SECRET</span>\"</span> <span class=\"token parameter variable\">--approve</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--namespace</span> workshop <span class=\"token punctuation\">\\</span>\n--override-existing-serviceaccounts</code></pre></div>\n<p><strong>Sync with Native Kubernetes Secrets:</strong></p>\n<p>When all is ready, we can create a SecretProviderClass custom resource and use jmesPath field in the spec file.</p>\n<blockquote>\n<p>Use of <a href=\"https://jmespath.org/\" target=\"_blank\" rel=\"noopener noreferrer\">jmesPath</a> allows extracting specific key-value from a JSON-formatted secret. It is a provider-specific feature from ASCP.</p>\n</blockquote>\n<p><a href=\"https://secrets-store-csi-driver.sigs.k8s.io/topics/sync-as-kubernetes-secret\" target=\"_blank\" rel=\"noopener noreferrer\">secretObjects</a> spec section allows specifying the Kubernetes native secret structure synced from the objects: extracted from the JSON formatted secret using jmesPath.</p>\n<p>The feature is provided by the standard <a href=\"https://secrets-store-csi-driver.sigs.k8s.io/topics/sync-as-kubernetes-secret.html\" target=\"_blank\" rel=\"noopener noreferrer\">Secret Store CSI Driver</a>.</p>\n<p><code class=\"language-text\">SecretProviderClass.yaml</code> template:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> secrets<span class=\"token punctuation\">-</span>store.csi.x<span class=\"token punctuation\">-</span>k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> SecretProviderClass\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> catalog<span class=\"token punctuation\">-</span>deployment<span class=\"token punctuation\">-</span>spc<span class=\"token punctuation\">-</span>k8s<span class=\"token punctuation\">-</span>secrets\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> workshop\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span> \n    <span class=\"token key atrule\">objects</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      - objectName: \"DBSecret_eksworkshop\"\n        objectType: \"secretsmanager\"\n        jmesPath:\n          - path: username\n            objectAlias: dbusername\n          - path: password\n            objectAlias: dbpassword</span>\n  <span class=\"token key atrule\">secretObjects</span><span class=\"token punctuation\">:</span>                \n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">-</span>secret<span class=\"token punctuation\">-</span>from<span class=\"token punctuation\">-</span>secrets<span class=\"token punctuation\">-</span>manager\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque\n      <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">objectName</span><span class=\"token punctuation\">:</span> dbusername\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> db_username\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">objectName</span><span class=\"token punctuation\">:</span> dbpassword\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> db_password</code></pre></div>\n<p>After, run the command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> SecretProviderClass.yaml</code></pre></div>\n<p><strong>Create Pod Mount Secrets Volumes and set up environment variables:</strong></p>\n<p>Now let us Configure productcatalog service pod to mount volumes for individually extracted key-value pairs from the secrets. Once the pod is created with secrets volume mounts, the Secrets Store CSI Driver then creates and syncs Kubernetes secret object mysql-secret-from-secrets-manager¬†.\nThe pod then be able to populate Environment variables from the Kubernetes secret.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">cd</span> helm-charts\n$ helm upgrade --reuse-values <span class=\"token parameter variable\">-f</span> values-secrets-manager.yaml demo <span class=\"token builtin class-name\">.</span>\n\nRelease <span class=\"token string\">\"demo\"</span> has been upgraded. Happy Helming<span class=\"token operator\">!</span>\nNAME: demo\nLAST DEPLOYED: Sat Oct <span class=\"token number\">11</span> <span class=\"token number\">20</span>:11:20 <span class=\"token number\">2024</span>\nNAMESPACE: default\nSTATUS: deployed\nREVISION: <span class=\"token number\">5</span></code></pre></div>\n<p><strong>üéâ Verify the result:</strong></p>\n<p>Get a shell prompt within the product catalog pod by running the following commands. Verify the secret mounted as separate files for each extracted key-value pair and corresponding environment variables set as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">PROD_CATALOG</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl get pods <span class=\"token parameter variable\">-n</span> workshop <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>prodcatalog <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'{.items[].metadata.name}'</span><span class=\"token variable\">)</span></span>\nkubectl <span class=\"token parameter variable\">-n</span> workshop <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> <span class=\"token variable\">${PROD_CATALOG}</span> <span class=\"token parameter variable\">-c</span> prodcatalog <span class=\"token function\">bash</span></code></pre></div>\n<p>Wait for the root shell prompt within the pod.\nRun the following set of commands and watch the output in the pod's shell:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token string\">'# '</span>\n<span class=\"token builtin class-name\">cd</span> /mnt/secrets\n<span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token comment\">#--- List mounted secrets</span>\n<span class=\"token function\">cat</span> dbusername<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span>\n<span class=\"token function\">cat</span> dbpassword<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span>\n<span class=\"token function\">cat</span> DBSecret_eksworkshop<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span>\n<span class=\"token function\">env</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> MYSQL <span class=\"token comment\">#-- Display the MYSQL_ROOT_PASSWORD ENV variables set from the secret value</span></code></pre></div>\n<p>The output shows the information as displayed below:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># cd /mnt/secrets</span>\n<span class=\"token comment\"># ls -l #--- List mounted secrets</span>\ntotal <span class=\"token number\">12</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">41</span> Oct <span class=\"token number\">11</span> <span class=\"token number\">21</span>:42 DBSecret_eksworkshop\n-rw-r--r-- <span class=\"token number\">1</span> root root  <span class=\"token number\">8</span> Oct <span class=\"token number\">11</span> <span class=\"token number\">21</span>:42 dbpassword\n-rw-r--r-- <span class=\"token number\">1</span> root root  <span class=\"token number\">4</span> Oct <span class=\"token number\">11</span> <span class=\"token number\">21</span>:42 dbusername\n<span class=\"token comment\"># </span>\n<span class=\"token comment\"># cat dbusername; echo</span>\nroot\n<span class=\"token comment\"># cat dbpassword; echo</span>\ndemo_ascp\n<span class=\"token comment\"># cat DBSecret_eksworkshop; echo</span>\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"username\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"root\"</span>,<span class=\"token string\">\"password\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"demo_ascp\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token comment\"># </span>\n<span class=\"token comment\"># env | grep MYSQL #-- Display the MYSQL_ROOT_PASSWORD ENV variables set from the secret value</span>\n<span class=\"token assign-left variable\">MYSQL_ROOT_PASSWORD</span><span class=\"token operator\">=</span>demo_ascp\n<span class=\"token assign-left variable\">MYSQL_READ_PORT_3306_TCP_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span>\n<span class=\"token assign-left variable\">MYSQL_READ_PORT_3306_TCP_PROTO</span><span class=\"token operator\">=</span>tcp\n<span class=\"token assign-left variable\">MYSQL_READ_PORT_3306_TCP</span><span class=\"token operator\">=</span>tcp://10.100.88.165:3306\n<span class=\"token assign-left variable\">MYSQL_READ_SERVICE_HOST</span><span class=\"token operator\">=</span><span class=\"token number\">10.100</span>.88.165\n<span class=\"token assign-left variable\">MYSQL_READ_SERVICE_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span>\n<span class=\"token assign-left variable\">MYSQL_READ_SERVICE_PORT_MYSQL</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span>\n<span class=\"token assign-left variable\">MYSQL_READ_PORT_3306_TCP_ADDR</span><span class=\"token operator\">=</span><span class=\"token number\">10.100</span>.88.165\n<span class=\"token assign-left variable\">MYSQL_READ_PORT</span><span class=\"token operator\">=</span>tcp://10.100.88.165:3306</code></pre></div>\n<p>Notice under the path <code class=\"language-text\">/mnt/secrets</code> key-values pairs extracted in separate files based on jmesPath specification. Files <code class=\"language-text\">dbusername</code> and <code class=\"language-text\">dbpassword</code> contains extracted values from the JSON formatted secret <code class=\"language-text\">DBSecret_eksworkshop</code></p>\n<p>The Environment variable <strong>MYSQL_ROOT_PASSWORD</strong> is set up correctly.</p>\n<p>The ENV var mapped from the Kubernetes secrets object <code class=\"language-text\">mysql-secret-from-secrets-manager</code> created automatically by the CSI driver.\nConfirm the presence of Kubernetes secrets. It was created automatically by the CSI driver during pod deployment.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl describe secrets mysql-secret-from-secrets-manager <span class=\"token parameter variable\">-n</span> workshop\nName: mysql-secret-from-secrets-manager\nNamespace: workshop\nLabels: secrets-store.csi.k8s.io/managed<span class=\"token operator\">=</span>true\nAnnotations: <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nType: Opaque\nDatadb_password: <span class=\"token number\">8</span> bytes\ndb_username: <span class=\"token number\">4</span> bytes</code></pre></div>\n<h2 id=\"-key-takeaways\" style=\"position:relative;\"><a href=\"#-key-takeaways\" aria-label=\" key takeaways permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üí¨ Key Takeaways</h2>\n<p>Using AWS Secrets Manager with Amazon EKS makes handling secrets in Kubernetes much safer and easier.</p>\n<p>It helps keep your sensitive information secure and makes managing secrets simpler.</p>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ üáµüá∏</em></strong></p>\n<p><br><br></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/security/how-to-use-aws-secrets-configuration-provider-with-kubernetes-secrets-store-csi-driver/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/security/how-to-use-aws-secrets-configuration-provider-with-kubernetes-secrets-store-csi-driver/</a></li>\n<li><a href=\"https://catalog.workshops.aws/eks-immersionday/en-US/secrets-manager\" target=\"_blank\" rel=\"noopener noreferrer\">https://catalog.workshops.aws/eks-immersionday/en-US/secrets-manager</a></li>\n<li><a href=\"https://aws.github.io/aws-eks-best-practices/security/docs/data/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.github.io/aws-eks-best-practices/security/docs/data/</a></li>\n<li>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/CXbFkpugxyQ?rel=0\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n</li>\n</ul>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":10,"rawMarkdownBody":"\n> **Enhance security and simplify secrets management for K8s apps**\n\n## üóØ Introduction\n\nManaging secrets like API keys and database passwords securely is important to keep the applications running in Kubernetes secure.\n\nAnd if you're using Amazon EKS Elastic Kubernetes Service for your Kubernetes applications, AWS KMS with AWS Secrets Manager can help you handle these secrets safely and easily.\n\n## „äôÔ∏è Using AWS Secrets Manager with Amazon¬†EKS\n\n[AWS Secrets Manager](https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html) can be integrated with EKS using the [AWS Secrets and Configuration Provider ASCP](https://github.com/aws/secrets-store-csi-driver-provider-aws) for the [Kubernetes Secrets Store CSI Driver](https://secrets-store-csi-driver.sigs.k8s.io/).\n\n**Benefits:**\n\n- Centralized secret management\n- Fine-grained access control\n- Seamless integration with EKS\n- Ability to mount secrets as volumes in pods\n- Option to sync with native Kubernetes secrets\n\n\n\n**Implementation steps:**\n\n1. Create secrets in AWS Secrets Manager\n2. Create an IAM policy for secret retrieval\n3. Use [IAM Roles for Service Accounts (IRSA)](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html) to limit secret access\n4. Deploy a SecretProviderClass custom resource\n5. Configure pods to mount volumes based on the SecretProviderClass\n6. Sync mounted secrets to native Kubernetes secrets\n7. Set up environment variables in pods using specific secret keys\n\n\n\n## Encrypting Kubernetes Secrets in Amazon¬†EKS\n\nAmazon EKS clusters (version 1.13+) support encrypting [Kubernetes secrets](https://kubernetes.io/docs/concepts/configuration/secret/) using [AWS Key Management Service (KMS) Customer Managed Keys (CMK)](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html). This provides stronger security than the default Base64 encoding.\nKey points:\n\n- No changes are required in how secrets are used.\n- Encryption provider support must be enabled during EKS cluster creation\n- Each secret write generates a unique Data Encryption Key (DEK).\n- The DEK is encrypted with the CMK and stored in etcd.\n- Decryption occurs when pods access the secret.\n\n## EKS Secrets and Secrets Manager hands-on¬†guide\n\nLet us start by provisioning our EKS cluster using Terraform the IAC tool.\n\nFirst, clone the repo:\n\n```shell\n$ git clone https://github.com/seifrajhi/eks-secrets-manager-kms-demo.git\n```\n\nThen run the following commands:\n\n```shell\n$ cd eks-secrets-manager-kms-demo/eks-tf\n$ terraform init\n$ terraform plan\n$ terraform apply --auto-approve\n```\n\nThis will provision the EKS cluster and VPC with the needed add-ons.\n\n## Deploy the¬†app\n\nTo deploy the app, clone the repo:\n\n```shell\n$ git clone https://github.com/seifrajhi/eks-secrets-manager-kms-demo.git\n```\n\nFor the deployment of our demo application, we have created the Helm chart and uploaded it to the [Git Repository](https://github.com/seifrajhi/eks-secrets-manager-kms-demo/tree/main/helm-charts).\n\nInstall the Helm chart:\n\n```shell\ncd eks-secrets-manager-kms-demo/helm-charts\nhelm install demo .\nNAME: demo\nLAST DEPLOYED: Sat Oct 11 18:42:20 2024\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\n```\n\n### Deploy Amazon EBS CSI¬†Driver\n\n[The Container Storage Interface (CSI)](https://github.com/container-storage-interface/spec/blob/master/spec.md) is a standard for exposing arbitrary block and file storage systems to containerized workloads on Container Orchestration Systems (COs) like Kubernetes.\nUsing CSI third-party storage providers can write and deploy plugins exposing new storage systems in Kubernetes without ever having to touch the core Kubernetes code.\n\n[The Amazon Elastic Block Store (Amazon EBS) Container Storage Interface (CSI) driver](https://github.com/kubernetes-sigs/aws-ebs-csi-driver) provides a CSI interface that allows Amazon Elastic Kubernetes Service (Amazon EKS) clusters to manage the lifecycle of Amazon EBS volumes for persistent volumes.\n\nEBS was installed as part of the cluster add-ons.\n\n### Define Storage Class\n\n[Dynamic Volume Provisioning](https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/) allows storage volumes to be created on-demand.\n\n[StorageClass](https://kubernetes.io/docs/concepts/storage/storage-classes/) should be pre-created to define which provisioner should be used and what parameters should be passed when dynamic provisioning is invoked.\n\n```yaml\nkind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: mysql-gp3\nprovisioner: ebs.csi.aws.com # <--  Amazon EBS CSI driver\nparameters:\n  type: gp3\n  encrypted: 'true' \nvolumeBindingMode: WaitForFirstConsumer\nreclaimPolicy: Delete\nmountOptions:\n- debug\n```\n\nCreate storageclass `mysql-gp3` by running the following command:\n\n```shell\nkubectl create -f sc-gp3-mysql.yaml\n```\n\n### Deploy StatefulSet workload\n\nWe are going to deploy a MYSQL database using StatefulSet.\n\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>The MySQL deployment consists of a ConfigMap, two Services, a Kubernetes secret for the root password and a StatefulSet.</p>\n</div>\n\nThe [ConfigMap](https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/) allows you to decouple configuration artifacts and secrets from image content to keep containerized applications portable. \n\nThe ConfigMap stores `source.cnf`, `replica.cnf` and passes them when initializing leader and follower pods defined in StatefulSet:\n\n* **source.cnf:** is for the MySQL leader pod which has binary log option (log-bin) to provides a record of the data changes to be sent to follower servers.\n* **replica.cnf:** is for follower pods which have super-read-only option.\n\n`mysql-cm.yaml` manifest:\n\n```Yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql-config\n  namespace: workshop\n  labels:\n    app: mysql\ndata:\n  source.cnf: |\n    # Apply this config only on the leader.\n    [mysqld]\n    log-bin\n  replica.cnf: |\n    # Apply this config only on followers.\n    [mysqld]\n    # super-read-only\n```\n\nThen run:\n```shell\nkubectl create -f mysql-cm.yaml\n```\n\nStatefulSet requires a [Headless Service](https://kubernetes.io/docs/concepts/services-networking/service/#headless-services) to control the domain of its Pods, directly reach each Pod with stable DNS entries.\n\n> The Headless Service provides a home for the DNS entries that the StatefulSet controller creates for each Pod that's part of the set. By specifying \"None\" for the clusterIP, you can create Headless Service.\n>\n> Because the Headless Service is named mysql, the Pods are accessible by resolving¬†**`.mysql`** from within any other Pod in the same Kubernetes cluster and namespace.\n\nYou can see the `mysql service` is for DNS resolution so that when pods are placed by StatefulSet controller, pods can be resolved using pod-name.mysql.\n\nThe Client Service `mysql-read` is a normal client Service with its own cluster IP that distributes connections across all MySQL Pods that report being Ready.\n\nCreate service **mysql** and **mysql-read** by running the following commands:\n\n```Shell\n$ git clone https://github.com/seifrajhi/eks-secrets-manager-kms-demo.git\n$ cd eks-secrets-manager-kms-demo/demo-app\n$ kubectl create -f mysql-svc.yaml\n```\n\nStatefulSet consists of **serviceName**, **replicas**, **template** and **volumeClaimTemplates**:\n\n- serviceName is \"mysql\", headless service we created in previous section.\n- replicas is 2, the desired number of pod.\n- template is the configuration of pod.\n- volumeClaimTemplates is to claim volume for pod based on storageClassName gp3.\n\nRun the following command under demo-app directory:\n\n```shell\n$ kubectl apply -f statefulset.yaml\n```\n\n**Populate database:**\n\nWe are creating the database qa and products table in below command and inserting a products into the table. Later we will see how this data will show up in our application which is accessing this database.\n\n```shell\n$ kubectl -n workshop run mysql-client --image=mysql:5.7 -i --rm --restart=Never --\\\n  mysql -uroot -pdemo_ascp -h mysql-0.mysql.workshop <<EOF\nCREATE DATABASE qa;\nCREATE TABLE qa.products (prodId VARCHAR(120), prodName VARCHAR(120));\nINSERT INTO qa.products (prodId,prodName) VALUES ('999','Mountain Bike');\nEOF\n```\n\n## Kubernetes secrets encryption using AWS KMS\n\nWhen we deployed the MySQL database, and the kubernetes secret `mysql-secret` to hold the **password** for the database, the EKS control plane created a [Data Encryption Key (DEK)](https://docs.aws.amazon.com/sns/latest/dg/sns-server-side-encryption.html#sse-key-terms) to encrypt the secret, saved the encrypted secret to etcd and used [kms:encrypt](https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/) to encrypt DEK and cached the encrypted DEK.\n\nLet's use the Kubernetes secret `mysql-secret` created while deploying the MySQL StatefulSet in the prodcatalog service to connect to the MYSQL database and show how EKS uses KMS to decrypt the Kubernetes secret `mysql-secret`.\n\n```Shell\n$ cd helm-charts\n$ helm upgrade --reuse-values -f values-k8s-secret.yaml demo .\n\nRelease \"demo\" has been upgraded. Happy Helming!\nNAME: demo\nLAST DEPLOYED: Sat Oct 11 19:20:20 2024\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 3\n```\n\n**Validate Kubernetes Encryption using KMS:**\n\nNow let's validate that AWS KMS was used when we create and use the kubernetes secret.\n\nLog into console and navigate to `EKS ‚Üí Cluster ‚Üí Overview,` you will see the Secrets encryption as shown below:\n\n![alt text](kms-eks.png)\n\nThe EKS cluster was created with KMS encryption enabled and that is why your Secrets encryption is enabled.\n\n_Make a note of the KMS key ID._\n\nA **cloudtrail Decrypt** event corresponding to this KMS key ID should be available with sourceIpAddress as `eks.amazonaws.com`.\n\nIf you go to [CloudTrail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html) you should see a record available if you search for the Event types Encrypt and Decrypt.\n\n### Mount secrets from AWS Secrets¬†Manager\n\nWe have the MYSQL StatefulSet deployed and now we are going to save the password for the MYSQL database in AWS Secrets Manager and sync the secrets manager secret to a Native Kubernertes secret using the [Secrets Store CSI driver](https://secrets-store-csi-driver.sigs.k8s.io/).\n\nThe Kubernetes secret created by the CSI driver will be used in the **productcatalog** service to connect to the MYSQL Database.\n\n**Install CSI Driver:**\n\nPrepare your cluster by installing Secrets Store CSI Secret driver and AWS Secrets and Configuration Provider (ASCP).\n\n```shell\nhelm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts\n```\n\nThen install the CSI driver:\n\n```shell\n$ helm install -n kube-system csi-secrets-store \\\n--set syncSecret.enabled=true \\\n--set enableSecretRotation=true \\\nsecrets-store-csi-driver/secrets-store-csi-driver\n```\n\nThen install AWS Secrets and Configuration [Provider ASCP](https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html):\n\n```shell\nhelm repo add aws-secrets-manager https://aws.github.io/secrets-store-csi-driver-provider-aws\nhelm install -n kube-system secrets-provider-aws aws-secrets-manager/secrets-store-csi-driver-provider-aws\n```\n\n**Prepare Secret and IAM access:**\n\nNext step, create a test secret in AWS Secrets Manager:\n\n```Shell\n$ aws secretsmanager create-secret \\\n--name DBSecret_eksdemo \\\n--description \"MYSQL DB Secret.\" \\\n--secret-string \"{\\\"username\\\":\\\"root\\\",\\\"password\\\":\\\"demo_ascp\\\"}\"\n```\n\nAfter that, create an IAM policy with permissions to access the secrets manager secret:\n\n```Shell\nexport IAM_POLICY_ARN_SECRET=$(aws iam \\\ncreate-policy --query Policy.Arn \\\n--output text --policy-name DBSecret_eksdemo_secrets_policy\\\n--policy-document '{\n\"Version\": \"2012-10-17\",\n\"Statement\": [ {\n\"Effect\": \"Allow\",\n\"Action\": [\"secretsmanager:GetSecretValue\", \"secretsmanager:DescribeSecret\"],\n\"Resource\": [\"'\"$SECRET_ARN\"'\" ]\n} ]\n}')\n\necho $IAM_POLICY_ARN_SECRET | tee -a 00_iam_policy_arn_dbsecret\n```\nNext, create an IAM Service Account IRSA to access the secrets manager secret:\n\n```shell\n$ eksctl create iamserviceaccount \\\n--name \"catalog-deployment-sa\" \\\n--cluster \"demo-eks-secrets-kms-bottlerocket\" \\\n--attach-policy-arn \"$IAM_POLICY_ARN_SECRET\" --approve \\\n--namespace workshop \\\n--override-existing-serviceaccounts\n```\n\n**Sync with Native Kubernetes Secrets:**\n\nWhen all is ready, we can create a SecretProviderClass custom resource and use jmesPath field in the spec file.\n\n> Use of [jmesPath](https://jmespath.org/) allows extracting specific key-value from a JSON-formatted secret. It is a provider-specific feature from ASCP.\n\n[secretObjects](https://secrets-store-csi-driver.sigs.k8s.io/topics/sync-as-kubernetes-secret) spec section allows specifying the Kubernetes native secret structure synced from the objects: extracted from the JSON formatted secret using jmesPath.\n\nThe feature is provided by the standard [Secret Store CSI Driver](https://secrets-store-csi-driver.sigs.k8s.io/topics/sync-as-kubernetes-secret.html).\n\n`SecretProviderClass.yaml` template:\n\n```yaml\napiVersion: secrets-store.csi.x-k8s.io/v1\nkind: SecretProviderClass\nmetadata:\n  name: catalog-deployment-spc-k8s-secrets\n  namespace: workshop\nspec:\n  provider: aws\n  parameters: \n    objects: |\n      - objectName: \"DBSecret_eksworkshop\"\n        objectType: \"secretsmanager\"\n        jmesPath:\n          - path: username\n            objectAlias: dbusername\n          - path: password\n            objectAlias: dbpassword\n  secretObjects:                \n    - secretName: mysql-secret-from-secrets-manager\n      type: Opaque\n      data:\n        - objectName: dbusername\n          key: db_username\n        - objectName: dbpassword\n          key: db_password\n```\n\nAfter, run the command:\n\n```Shell\nkubectl apply -f SecretProviderClass.yaml\n```\n\n**Create Pod Mount Secrets Volumes and set up environment variables:**\n\nNow let us Configure productcatalog service pod to mount volumes for individually extracted key-value pairs from the secrets. Once the pod is created with secrets volume mounts, the Secrets Store CSI Driver then creates and syncs Kubernetes secret object mysql-secret-from-secrets-manager¬†.\nThe pod then be able to populate Environment variables from the Kubernetes secret.\n\n```Shell\n$ cd helm-charts\n$ helm upgrade --reuse-values -f values-secrets-manager.yaml demo .\n\nRelease \"demo\" has been upgraded. Happy Helming!\nNAME: demo\nLAST DEPLOYED: Sat Oct 11 20:11:20 2024\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 5\n```\n\n**üéâ Verify the result:**\n\nGet a shell prompt within the product catalog pod by running the following commands. Verify the secret mounted as separate files for each extracted key-value pair and corresponding environment variables set as well.\n\n```Shell\nexport PROD_CATALOG=$(kubectl get pods -n workshop -l app=prodcatalog -o jsonpath='{.items[].metadata.name}')\nkubectl -n workshop exec -it ${PROD_CATALOG} -c prodcatalog bash\n```\n\nWait for the root shell prompt within the pod.\nRun the following set of commands and watch the output in the pod's shell:\n\n```Shell\nexport PS1='# '\ncd /mnt/secrets\nls -l #--- List mounted secrets\ncat dbusername; echo\ncat dbpassword; echo\ncat DBSecret_eksworkshop; echo\nenv | grep MYSQL #-- Display the MYSQL_ROOT_PASSWORD ENV variables set from the secret value\n```\n\nThe output shows the information as displayed below:\n\n```Shell\n# cd /mnt/secrets\n# ls -l #--- List mounted secrets\ntotal 12\n-rw-r--r-- 1 root root 41 Oct 11 21:42 DBSecret_eksworkshop\n-rw-r--r-- 1 root root  8 Oct 11 21:42 dbpassword\n-rw-r--r-- 1 root root  4 Oct 11 21:42 dbusername\n# \n# cat dbusername; echo\nroot\n# cat dbpassword; echo\ndemo_ascp\n# cat DBSecret_eksworkshop; echo\n{\"username\":\"root\",\"password\":\"demo_ascp\"}\n# \n# env | grep MYSQL #-- Display the MYSQL_ROOT_PASSWORD ENV variables set from the secret value\nMYSQL_ROOT_PASSWORD=demo_ascp\nMYSQL_READ_PORT_3306_TCP_PORT=3306\nMYSQL_READ_PORT_3306_TCP_PROTO=tcp\nMYSQL_READ_PORT_3306_TCP=tcp://10.100.88.165:3306\nMYSQL_READ_SERVICE_HOST=10.100.88.165\nMYSQL_READ_SERVICE_PORT=3306\nMYSQL_READ_SERVICE_PORT_MYSQL=3306\nMYSQL_READ_PORT_3306_TCP_ADDR=10.100.88.165\nMYSQL_READ_PORT=tcp://10.100.88.165:3306\n```\n\nNotice under the path `/mnt/secrets` key-values pairs extracted in separate files based on jmesPath specification. Files `dbusername` and `dbpassword` contains extracted values from the JSON formatted secret `DBSecret_eksworkshop`\n\nThe Environment variable **MYSQL_ROOT_PASSWORD** is set up correctly. \n\nThe ENV var mapped from the Kubernetes secrets object `mysql-secret-from-secrets-manager` created automatically by the CSI driver.\nConfirm the presence of Kubernetes secrets. It was created automatically by the CSI driver during pod deployment.\n\n```shell\n$ kubectl describe secrets mysql-secret-from-secrets-manager -n workshop\nName: mysql-secret-from-secrets-manager\nNamespace: workshop\nLabels: secrets-store.csi.k8s.io/managed=true\nAnnotations: <none>\nType: Opaque\nDatadb_password: 8 bytes\ndb_username: 4 bytes\n```\n\n## üí¨ Key Takeaways\n\nUsing AWS Secrets Manager with Amazon EKS makes handling secrets in Kubernetes much safer and easier.\n\nIt helps keep your sensitive information secure and makes managing secrets simpler.\n\n**_Until next time, „Å§„Å•„Åè üéâ üáµüá∏_**\n\n<br><br>\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  _**Until next time üéâ**_\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**References:**\n\n- https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html\n- https://aws.amazon.com/blogs/security/how-to-use-aws-secrets-configuration-provider-with-kubernetes-secrets-store-csi-driver/\n- https://catalog.workshops.aws/eks-immersionday/en-US/secrets-manager\n- https://aws.github.io/aws-eks-best-practices/security/docs/data/\n- https://youtu.be/CXbFkpugxyQ\n  \n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1510},"frontmatter":{"id":"01db2ca13390cc995caca166","path":"/blog/eks-and-aws-secrets-manager/","humanDate":"Oct 13, 2024","fullDate":"2024-10-13","title":"Manage secrets in AWS EKS with AWS Secrets Manager securely","keywords":["EKS","AWS","Secrets Manager","Terraform","Security"],"excerpt":"EKS, AWS, Secrets Manager, Kubernetes, Security","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC4ElEQVR42iWS+08TeRTFh5dFWqBE3KjL7mp0QUWsPOLb0FArLwVXCZFKJFERZqaDtWp0UVe3uFVAWS2sSkzcJcijIuKD17QVatT/apOPl/GHk5t7594z53vPVTZ1v+Pk8BcqH37E+2iJ+r8/UhGao6o/ZqGy17Ty3T3zHB9c5rehJO77Jicl7pVazYMEtQ8T5OmTOLVJlPzgNAeloWZACOVj9UCCXbdnOXTPtEiq+mKU/zlHmWDP3QX2/7VAxZ059vUsUC59bulz3fpArjrxnTDbiLIvbNLy7DMHw4sWcdWDOJ7+hPWjhsdLVIuCY4+WaXv+ld1CfLgvzuHeOG6ZOzGYpPSPWewd45ZKxWFMYuuKku6fIHMFUlyJNnUcmz5OZucYmeoYWZLbBVmSr8AhNbvE1YJsbdxSZyncYLyjJJjEFVimKJDgl6DJrxdNNuuzFOuLVizU5tmmzrNVYrG2QJkap1CdtfISzaRYXSRPi5KrR2WH+isK9LcU+GcoNEy2X1oWohilWgyXtigDMXaqMXbIUKkQlalJIU/gktpm9QMF6gw/CZzGa2wtEZQs/xvs8syMzil+1N4LmUmhHqdI/8R6UVgkCrZocxY2Cio6X1GpTVGiL7FWm8ahyfO7prG1vSCl+gbKxvbfOXK5AXfoijj1L4r2kkO+MCONZxlrVtl7LkK6OipLH+Hnjmd4LtygTr3OViNCjgjJMabJbH1CSv1dUqu7Ucp8XtqvrSPwopZ1LT2kn+rlTE0X/x9rAJ+P5tNhVjX1kN/Sy84LEeq02xww+qgNhvhBzFvlGyS18RZpx2+S4vGjrDkfoeaSF1d3GHv7BBnSVHf0OslyN189jXhP92ETJ50do7KOf/D6Q9QH73Di2k1Wtw6LMiFrCpEmTqcH3sgditWO9lHrjnL8UbL9U+R3/MemtgHBY9Z0vsQpxjnFwZWzKDKG5SKGcLQ+RakLkeoJkHb2KRlX54Vwhm82j+rSUKKl1AAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/ff6d20c44d5aeda3f918a6e6c9dcc495/47056/eks-secrets-manager.png","srcSet":"/static/ff6d20c44d5aeda3f918a6e6c9dcc495/0dee1/eks-secrets-manager.png 750w,\n/static/ff6d20c44d5aeda3f918a6e6c9dcc495/8beaa/eks-secrets-manager.png 1080w,\n/static/ff6d20c44d5aeda3f918a6e6c9dcc495/a4198/eks-secrets-manager.png 1366w,\n/static/ff6d20c44d5aeda3f918a6e6c9dcc495/47056/eks-secrets-manager.png 1600w","sizes":"100vw"},"sources":[{"srcSet":"/static/ff6d20c44d5aeda3f918a6e6c9dcc495/a66aa/eks-secrets-manager.webp 750w,\n/static/ff6d20c44d5aeda3f918a6e6c9dcc495/65dd5/eks-secrets-manager.webp 1080w,\n/static/ff6d20c44d5aeda3f918a6e6c9dcc495/f9724/eks-secrets-manager.webp 1366w,\n/static/ff6d20c44d5aeda3f918a6e6c9dcc495/2bf2f/eks-secrets-manager.webp 1600w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.563125}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/aws-tagging-resources-best-practices/","title":"Tagging AWS resources the right way using Terraform","date":"2024-10-13 15:34:00"},"excerpt":"Better organization and cost tracking with consistent tagging üîñ  Introduction Keeping your AWS resources organized and tracking costs can‚Ä¶"},"nextThought":{"frontmatter":{"path":"/blog/kubernetes-os-choice/","title":"Choosing the right Linux Operating System for your Kubernetes cluster","date":"2024-10-10 13:34:00"},"excerpt":"How to select the optimal OS for running your Kubernetes clusters üìö Introduction Selecting the most suitable Linux OS is important for‚Ä¶"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}