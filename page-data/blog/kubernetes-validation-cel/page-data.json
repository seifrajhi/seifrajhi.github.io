{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/kubernetes-validation-cel/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Simplify Complex Validations with CEL and Kyverno Policies ☯</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🔆 Introduction</h2>\n<p>Kubernetes is extensible and allows users to create <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Resources (CR)</a> and <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Resource Definitions (CRD)</a> that define the structure and meta-attributes of future resources. However, creating complex validation webhooks for each CRD can be an operational and development overhead.</p>\n<p>Kubernetes now provides a solution in the form of the <a href=\"https://kubernetes.io/docs/reference/using-api/cel/\" target=\"_blank\" rel=\"noopener noreferrer\">Common Expression Language (CEL)</a>. CEL is a simple yet powerful language that allows you to define complex validation rules directly in the Kubernetes API server. With CEL, you can introduce complex validations without creating your own validating webhooks in code.</p>\n<p><a href=\"https://kyverno.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kyverno</a> is a Kubernetes-native policy engine that allows you to define policies as code. With Kyverno, you can enforce best practices, security standards, and compliance requirements.</p>\n<p>By using CEL expressions in Kyverno policies, you can simplify your validation rules and make them more expressive.</p>\n<p>In this blog post, we'll explore how to use CEL expressions in Kyverno policies to simplify your Kubernetes validation rules. We'll walk through examples of using CEL expressions in Kyverno policies to enforce policies for your Kubernetes resources.</p>\n<p>So, if you're looking to simplify your Kubernetes validation rules and make them more expressive, read on to learn how to use CEL expressions in Kyverno policies.</p>\n<h2 id=\"cel-and-validation-in-kubernetes\" style=\"position:relative;\"><a href=\"#cel-and-validation-in-kubernetes\" aria-label=\"cel and validation in kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>CEL and Validation in Kubernetes</h2>\n<p>Kubernetes Custom Resource Definitions (CRDs) support validation through <a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema\" target=\"_blank\" rel=\"noopener noreferrer\">structural schemas</a>, <a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation\" target=\"_blank\" rel=\"noopener noreferrer\">OpenAPI v3 validation rules</a>, <a href=\"https://thenewstack.io/developer-guardrails-with-custom-kubernetes-resource-validators/\" target=\"_blank\" rel=\"noopener noreferrer\">custom validators</a>, and <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">admission webhooks</a>.</p>\n<p>CRD structural schemas provide type checking, while OpenAPI v3 validation rules offer regex, range, and size limits. Custom validators can be written in various languages, and admission webhooks are used for more complex validation scenarios.</p>\n<p>To address the need for self-contained validation, Kubernetes introduced Common Expression Language (CEL) into CRDs. CEL is a lightweight, safe, and easy-to-use expression language that supports pre-parsing and type checking at CRD registration time. This allows syntax and type errors to be caught before the CRD is deployed, improving cluster operability and reducing the need for webhooks. CEL is chosen for its simplicity, flexibility, and ability to express validation rules in a declarative manner. This choice aligns with Kubernetes' goal of providing a simple and consistent validation framework for CRDs.</p>\n<hr>\n<h3 id=\"a-deep-dive-into-cel\" style=\"position:relative;\"><a href=\"#a-deep-dive-into-cel\" aria-label=\"a deep dive into cel permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>A Deep Dive into CEL</h3>\n<p>Kubernetes CRDs support validation through CEL to ensure the correctness and consistency of custom resources. This feature, introduced in Kubernetes 1.25, allows developers to define validation rules using CEL expressions, which are declarative and lightweight. CEL validation rules are scoped to the location of the <code class=\"language-text\">x-kubernetes-validations</code> extension in the CRD schema, and the <code class=\"language-text\">self</code> variable in the CEL expression is bound to the scoped value. All validation rules are scoped to the current object, and cross-object or stateful validation rules are not supported.</p>\n<p>For example, a validation rule using <code class=\"language-text\">x-kubernetes-validations</code> could be:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">openAPIV3Schema</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n  <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n      <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> string\n          <span class=\"token key atrule\">x-kubernetes-validations</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"self.cpu in ['1', '2', '4']\"</span>\n            <span class=\"token key atrule\">message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CPU should be one of 1, 2, or 4.\"</span>\n        <span class=\"token key atrule\">required</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> cpu</code></pre></div>\n<p><a href=\"https://github.com/kubernetes/kubernetes/issues/121164\" target=\"_blank\" rel=\"noopener noreferrer\">CEL validation rules support a wide range of use cases, and they were promoted to GA in Kubernetes 1.29</a>. This feature has been adopted by many Kubernetes ecosystem projects and is widely used in the Kubernetes community. CEL validation rules provide a lightweight and self-contained validation mechanism that reduces the need for admission webhooks and simplifies the development and operability of CRDs. They also allow users to define complex validation rules in a declarative manner, improving the readability and maintainability of the CRD schema.</p>\n<hr>\n<h3 id=\"kyverno-a-policy-engine-for-k8s-resource-validation\" style=\"position:relative;\"><a href=\"#kyverno-a-policy-engine-for-k8s-resource-validation\" aria-label=\"kyverno a policy engine for k8s resource validation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kyverno: A Policy Engine for k8s Resource Validation</h3>\n<p>Kyverno is a policy engine for Kubernetes that enables resource validation, change, and creation based on defined policies. It uses CEL expressions for validation, reducing the need for admission webhooks. <a href=\"https://kyverno.io/policies/\" target=\"_blank\" rel=\"noopener noreferrer\">Kyverno policies</a> consist of Match, Exclude, Validate, Mutate, Generate, and Verify Images clauses, allowing users to define complex validation rules in a declarative manner.</p>\n<p>Kyverno policies provide a lightweight and self-contained validation mechanism that reduces the need for admission webhooks and simplifies the development and operability of CRDs. They also allow users to define complex validation rules in a declarative manner, improving the readability and maintainability of the CRD schema.</p>\n<h4 id=\"using-cel-expressions-in-kyverno-policies\" style=\"position:relative;\"><a href=\"#using-cel-expressions-in-kyverno-policies\" aria-label=\"using cel expressions in kyverno policies permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Using CEL Expressions in Kyverno Policies</h4>\n<p>CEL expressions in Kyverno policies are used in the validate section. The <code class=\"language-text\">message</code> field is used to display an error message when the expression evaluates to false. The <code class=\"language-text\">validationFailureAction</code> field is used to enforce the validation failure action when the expression evaluates to false.</p>\n<p>CEL expressions in Kyverno policies can be used to validate various aspects of Kubernetes resources, such as resource limits, labels, and annotations. Kyverno also supports the automatic generation of policy rules for higher-level controllers, such as Deployments, DaemonSets, StatefulSets, and CronJobs.</p>\n<p>To create a Kyverno policy that disallows CPU requests without a value, use the following example:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kyverno.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterPolicy\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> disallow<span class=\"token punctuation\">-</span>cpu<span class=\"token punctuation\">-</span>requests<span class=\"token punctuation\">-</span>without<span class=\"token punctuation\">-</span>value\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">validationFailureAction</span><span class=\"token punctuation\">:</span> Enforce\n  <span class=\"token key atrule\">background</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> disallow<span class=\"token punctuation\">-</span>cpu<span class=\"token punctuation\">-</span>requests<span class=\"token punctuation\">-</span>without<span class=\"token punctuation\">-</span>value\n    <span class=\"token key atrule\">match</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">any</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">kinds</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> Pod \n    <span class=\"token key atrule\">validate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">cel</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">expressions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CPU requests must have a value\"</span>\n            <span class=\"token key atrule\">expression</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"object.spec.containers.all(container, has(container.resources.requests.cpu))\"</span></code></pre></div>\n<p>Now, let's try deploying a pod without CPU requests:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cpu<span class=\"token punctuation\">-</span>pod\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cpu<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"256Mi\"</span></code></pre></div>\n<p>We can see that our policy is enforced. Great!</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply <span class=\"token parameter variable\">-f</span> pod.yaml\nError from server: error when creating <span class=\"token string\">\"pod.yaml\"</span><span class=\"token builtin class-name\">:</span> admission webhook <span class=\"token string\">\"validate.kyverno.svc-fail\"</span> denied the request: \n\nresource Pod/default/cpu-pod was blocked due to the following policies \n\ndisallow-cpu-requests-without-value:\n  disallow-cpu-requests-without-value: CPU requests must have a value</code></pre></div>\n<p>Some other useful variables that we can use in CEL expressions are:</p>\n<ul>\n<li><code class=\"language-text\">oldObject</code>: The existing object. The value is null for CREATE requests.</li>\n<li><code class=\"language-text\">authorizer</code>: It can be used to perform authorization checks.</li>\n<li><code class=\"language-text\">authorizer.requestResource</code>: A shortcut for an authorization check configured with the request resource (group, resource, (subresource), namespace, name).</li>\n</ul>\n<h4 id=\"cel-preconditions-in-kyverno-policies\" style=\"position:relative;\"><a href=\"#cel-preconditions-in-kyverno-policies\" aria-label=\"cel preconditions in kyverno policies permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>CEL Preconditions in Kyverno Policies</h4>\n<p>The below policy ensures the <code class=\"language-text\">hostPort</code> field is set to a value between 5000 and 6000 for pods whose <code class=\"language-text\">metadata.name</code> is set to nginx:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: disallow-host-port-range\nspec:\n  validationFailureAction: Enforce\n  background: false\n  rules:\n    - name: host-port-range\n      match:\n        any:\n        - resources:\n            kinds:\n              - Pod\n      celPreconditions:\n          - name: \"first match condition in CEL\"\n            expression: \"object.metadata.name.matches('nginx')\"\n      validate:\n        cel:\n          expressions:\n          - expression: \"object.spec.containers.all(container, !has(container.ports) || container.ports.all(port, !has(port.hostPort) || (port.hostPort >= 5000 &amp;&amp; port.hostPort &lt;= 6000)))\"\n            message: \"The only permitted hostPorts are in the range 5000-6000.\"\nEOF</span></code></pre></div>\n<p><code class=\"language-text\">spec.rules.celPreconditions</code> are CEL expressions. All celPreconditions must be evaluated to true for the resource to be evaluated. Therefore, any Pod with nginx in its <code class=\"language-text\">metadata.name</code> will be evaluated.</p>\n<p>Let's try deploying an Apache server with <code class=\"language-text\">hostPort</code> set to 80:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: apache\nspec:\n  containers:\n  - name: apache-server\n    image: httpd\n    ports:\n    - containerPort: 8080\n      hostPort: 80\nEOF</span></code></pre></div>\n<p>You'll see that it's successfully created because the validation rule wasn't applied to the new Pod as it doesn't satisfy the celPreconditions. That's exactly what we need.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Pod/apache created</code></pre></div>\n<p>Let's try deploying an Nginx server with <code class=\"language-text\">hostPort</code> set to 80:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  containers:\n  - name: nginx-server\n    image: nginx\n    ports:\n    - containerPort: 8080\n      hostPort: 80\nEOF</span></code></pre></div>\n<p>Since the new Pod satisfies the celPreconditions, the validation rule will be applied. As a result, the creation of the Pod will be blocked as it violates the rule.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Error from server: error when creating <span class=\"token string\">\"STDIN\"</span><span class=\"token builtin class-name\">:</span> admission webhook <span class=\"token string\">\"validate.kyverno.svc-fail\"</span> denied the request:\nresource Pod/default/nginx was blocked due to the following policies\n\ndisallow-host-port-range:\n  host-port-range: The only permitted hostPorts are <span class=\"token keyword\">in</span> the range <span class=\"token number\">5000</span>-6000.</code></pre></div>\n<h2 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Summary</h2>\n<p>The blog provides a good understanding of the Common Expression Language (CEL) and its application in Kubernetes <code class=\"language-text\">ValidatingAdmissionPolicies</code>. It shows the significance of CEL in validating Custom Resource Definitions (CRDs) and its integration into Kyverno policies for resource validation. The post covers the features introduced in Kubernetes ValidatingAdmissionPolicies and demonstrates the use of CEL expressions in Kyverno policies to validate resources. It also emphasizes the benefits of using CEL for in-process validation, reducing the reliance on admission webhooks, and simplifying the development and operability of CRDs.</p>\n<br>\n<p><strong><em>Until next time, つづく 🎉</em></strong></p>\n<blockquote>\n<p>💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  <em><strong>Until next time 🎉</strong></em></p>\n</blockquote>\n<p>🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>♻️ LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">Saifeddine Rajhi</a></p>\n<p><strong>♻️ X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">@rajhisaifeddine</a></p>\n<p><strong>The end ✌🏻</strong></p>\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n<p><strong>📅 Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":6,"rawMarkdownBody":"\n> **Simplify Complex Validations with CEL and Kyverno Policies ☯**\n\n## 🔆 Introduction\n\nKubernetes is extensible and allows users to create [Custom Resources (CR)](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources) and [Custom Resource Definitions (CRD)](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions) that define the structure and meta-attributes of future resources. However, creating complex validation webhooks for each CRD can be an operational and development overhead.\n\nKubernetes now provides a solution in the form of the [Common Expression Language (CEL)](https://kubernetes.io/docs/reference/using-api/cel/). CEL is a simple yet powerful language that allows you to define complex validation rules directly in the Kubernetes API server. With CEL, you can introduce complex validations without creating your own validating webhooks in code.\n\n[Kyverno](https://kyverno.io/) is a Kubernetes-native policy engine that allows you to define policies as code. With Kyverno, you can enforce best practices, security standards, and compliance requirements.\n\nBy using CEL expressions in Kyverno policies, you can simplify your validation rules and make them more expressive.\n\nIn this blog post, we'll explore how to use CEL expressions in Kyverno policies to simplify your Kubernetes validation rules. We'll walk through examples of using CEL expressions in Kyverno policies to enforce policies for your Kubernetes resources.\n\nSo, if you're looking to simplify your Kubernetes validation rules and make them more expressive, read on to learn how to use CEL expressions in Kyverno policies.\n\n## CEL and Validation in Kubernetes\n\nKubernetes Custom Resource Definitions (CRDs) support validation through [structural schemas](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema), [OpenAPI v3 validation rules](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation), [custom validators](https://thenewstack.io/developer-guardrails-with-custom-kubernetes-resource-validators/), and [admission webhooks](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/).\n\nCRD structural schemas provide type checking, while OpenAPI v3 validation rules offer regex, range, and size limits. Custom validators can be written in various languages, and admission webhooks are used for more complex validation scenarios.\n\nTo address the need for self-contained validation, Kubernetes introduced Common Expression Language (CEL) into CRDs. CEL is a lightweight, safe, and easy-to-use expression language that supports pre-parsing and type checking at CRD registration time. This allows syntax and type errors to be caught before the CRD is deployed, improving cluster operability and reducing the need for webhooks. CEL is chosen for its simplicity, flexibility, and ability to express validation rules in a declarative manner. This choice aligns with Kubernetes' goal of providing a simple and consistent validation framework for CRDs.\n\n---\n\n### A Deep Dive into CEL\n\nKubernetes CRDs support validation through CEL to ensure the correctness and consistency of custom resources. This feature, introduced in Kubernetes 1.25, allows developers to define validation rules using CEL expressions, which are declarative and lightweight. CEL validation rules are scoped to the location of the `x-kubernetes-validations` extension in the CRD schema, and the `self` variable in the CEL expression is bound to the scoped value. All validation rules are scoped to the current object, and cross-object or stateful validation rules are not supported.\n\nFor example, a validation rule using `x-kubernetes-validations` could be:\n\n```yaml\nopenAPIV3Schema:\n  type: object\n  properties:\n    spec:\n      type: object\n      properties:\n        cpu:\n          type: string\n          x-kubernetes-validations:\n          - rule: \"self.cpu in ['1', '2', '4']\"\n            message: \"CPU should be one of 1, 2, or 4.\"\n        required:\n          - cpu\n```\n\n[CEL validation rules support a wide range of use cases, and they were promoted to GA in Kubernetes 1.29](https://github.com/kubernetes/kubernetes/issues/121164). This feature has been adopted by many Kubernetes ecosystem projects and is widely used in the Kubernetes community. CEL validation rules provide a lightweight and self-contained validation mechanism that reduces the need for admission webhooks and simplifies the development and operability of CRDs. They also allow users to define complex validation rules in a declarative manner, improving the readability and maintainability of the CRD schema.\n\n---\n\n### Kyverno: A Policy Engine for k8s Resource Validation\n\nKyverno is a policy engine for Kubernetes that enables resource validation, change, and creation based on defined policies. It uses CEL expressions for validation, reducing the need for admission webhooks. [Kyverno policies](https://kyverno.io/policies/) consist of Match, Exclude, Validate, Mutate, Generate, and Verify Images clauses, allowing users to define complex validation rules in a declarative manner.\n\nKyverno policies provide a lightweight and self-contained validation mechanism that reduces the need for admission webhooks and simplifies the development and operability of CRDs. They also allow users to define complex validation rules in a declarative manner, improving the readability and maintainability of the CRD schema.\n\n#### Using CEL Expressions in Kyverno Policies\n\nCEL expressions in Kyverno policies are used in the validate section. The `message` field is used to display an error message when the expression evaluates to false. The `validationFailureAction` field is used to enforce the validation failure action when the expression evaluates to false.\n\nCEL expressions in Kyverno policies can be used to validate various aspects of Kubernetes resources, such as resource limits, labels, and annotations. Kyverno also supports the automatic generation of policy rules for higher-level controllers, such as Deployments, DaemonSets, StatefulSets, and CronJobs.\n\nTo create a Kyverno policy that disallows CPU requests without a value, use the following example:\n\n```yaml\napiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: disallow-cpu-requests-without-value\nspec:\n  validationFailureAction: Enforce\n  background: false\n  rules:\n  - name: disallow-cpu-requests-without-value\n    match:\n      any:\n      - resources:\n          kinds:\n            - Pod \n    validate:\n      cel:\n        expressions:\n          - message: \"CPU requests must have a value\"\n            expression: \"object.spec.containers.all(container, has(container.resources.requests.cpu))\"\n```\n\nNow, let's try deploying a pod without CPU requests:\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: cpu-pod\nspec:\n  containers:\n  - name: cpu-container\n    image: nginx\n    resources:\n      requests:\n        memory: \"256Mi\"\n```\n\nWe can see that our policy is enforced. Great!\n\n```shell\n$ kubectl apply -f pod.yaml\nError from server: error when creating \"pod.yaml\": admission webhook \"validate.kyverno.svc-fail\" denied the request: \n\nresource Pod/default/cpu-pod was blocked due to the following policies \n\ndisallow-cpu-requests-without-value:\n  disallow-cpu-requests-without-value: CPU requests must have a value\n```\n\nSome other useful variables that we can use in CEL expressions are:\n- `oldObject`: The existing object. The value is null for CREATE requests.\n- `authorizer`: It can be used to perform authorization checks.\n- `authorizer.requestResource`: A shortcut for an authorization check configured with the request resource (group, resource, (subresource), namespace, name).\n\n#### CEL Preconditions in Kyverno Policies\n\nThe below policy ensures the `hostPort` field is set to a value between 5000 and 6000 for pods whose `metadata.name` is set to nginx:\n\n```shell\nkubectl apply -f - <<EOF\napiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: disallow-host-port-range\nspec:\n  validationFailureAction: Enforce\n  background: false\n  rules:\n    - name: host-port-range\n      match:\n        any:\n        - resources:\n            kinds:\n              - Pod\n      celPreconditions:\n          - name: \"first match condition in CEL\"\n            expression: \"object.metadata.name.matches('nginx')\"\n      validate:\n        cel:\n          expressions:\n          - expression: \"object.spec.containers.all(container, !has(container.ports) || container.ports.all(port, !has(port.hostPort) || (port.hostPort >= 5000 && port.hostPort <= 6000)))\"\n            message: \"The only permitted hostPorts are in the range 5000-6000.\"\nEOF\n```\n\n`spec.rules.celPreconditions` are CEL expressions. All celPreconditions must be evaluated to true for the resource to be evaluated. Therefore, any Pod with nginx in its `metadata.name` will be evaluated.\n\nLet's try deploying an Apache server with `hostPort` set to 80:\n\n```shell\nkubectl apply -f - <<EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: apache\nspec:\n  containers:\n  - name: apache-server\n    image: httpd\n    ports:\n    - containerPort: 8080\n      hostPort: 80\nEOF\n```\n\nYou'll see that it's successfully created because the validation rule wasn't applied to the new Pod as it doesn't satisfy the celPreconditions. That's exactly what we need.\n\n```shell\nPod/apache created\n```\n\nLet's try deploying an Nginx server with `hostPort` set to 80:\n\n```shell\nkubectl apply -f - <<EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  containers:\n  - name: nginx-server\n    image: nginx\n    ports:\n    - containerPort: 8080\n      hostPort: 80\nEOF\n```\n\nSince the new Pod satisfies the celPreconditions, the validation rule will be applied. As a result, the creation of the Pod will be blocked as it violates the rule.\n\n```shell\nError from server: error when creating \"STDIN\": admission webhook \"validate.kyverno.svc-fail\" denied the request:\nresource Pod/default/nginx was blocked due to the following policies\n\ndisallow-host-port-range:\n  host-port-range: The only permitted hostPorts are in the range 5000-6000.\n```\n\n## Summary\n\nThe blog provides a good understanding of the Common Expression Language (CEL) and its application in Kubernetes `ValidatingAdmissionPolicies`. It shows the significance of CEL in validating Custom Resource Definitions (CRDs) and its integration into Kyverno policies for resource validation. The post covers the features introduced in Kubernetes ValidatingAdmissionPolicies and demonstrates the use of CEL expressions in Kyverno policies to validate resources. It also emphasizes the benefits of using CEL for in-process validation, reducing the reliance on admission webhooks, and simplifying the development and operability of CRDs.\n\n<br>\n\n**_Until next time, つづく 🎉_**\n\n> 💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  _**Until next time 🎉**_\n\n🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**♻️ LinkedIn:** [Saifeddine Rajhi](https://www.linkedin.com/in/rajhi-saif/)\n\n**♻️ X/Twitter:** [@rajhisaifeddine](https://x.com/rajhisaifeddine)\n\n**The end ✌🏻**\n\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n\n**📅 Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1092},"frontmatter":{"id":"42117c92c5c55eee1f154725","path":"/blog/kubernetes-validation-cel/","humanDate":"Oct 31, 2024","fullDate":"2024-10-31","title":"Introducing Kubernetes Validation with Common Expression Language (CEL) ☯","keywords":["Kubernetes","Validation","Common Expression Language","k8s","Kyverno","DevOps"],"excerpt":"Simplify complex validations in Kubernetes with Common Expression Language (CEL) and Kyverno policies.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACkUlEQVR42m2Sy2sTURTG578QFIXuxIX+AS4EUXTrQsGF4Ma1jzYNqY9E6COapLEYLfYBCtKmSqNYhEJqfbRiq2gLWpVULNHaqM1jMm0ynWTu/Ly5k0AVD5y5M/ec+33f/eZo2WyW9vZ2+vr6iEQiBAIBQuEwPp+PeDxO4PJl/H4/nZ2deL1e1RcOR0in09TCceTDLslcV99aKrVIR0cHwWCQUChELBZTAL29vSrbZS2ReMjQ8AieVi/NLS2cPXuOiYmkAhDlFXh7FF4fhtIXtEQiQTQaxX/pklLY3d2Nx+NhdHSU/v4BWjyt9MaucTPaRU80xOTTZ3R1BYkP33UVLt+H53vgxW5YvIpmFIvohkHZNCkWDfRCgXw+j2GsyTVHqZjjyfwqp+98Z+pjTiLY6HpR1VRUdZg7Du+kyo0MmiU9KEjA1LcMtm1RqXniKG5KFpwZMWlqK3Iwuk6TT6fl3jpmvclRBtI44HqY+bFC8uUc0zNzvJiZxyyXqQq3Iblgsa05y/UnZe6/2aAnWWLruSxTqYorzq6zO+4qhI2W/pVn8n2aV9OzzC5lyRfXsIXLdvFBiQMRnbF5i4lPFom3G+wP63Q9Lqm6VRUICdZIq1JFW/28wO+czs+lrxQyK+S/p6njcWOyzI7WHINTJo/mLG49N9nuyTI4bap6RSpsOKSmRwg0Z3lRmikZfy2D/AGs/lCAQriwJwYMdl3IsTdYYOf5PKduG2rfFps9dKN2Rqu9fDCWODTTTGhxqD6sjmKrRaHkSA9NroyXuflUToLZ8EvwbwhJoq1VTU7OtqHFd7Hl4T5SElwVHaEahPhbhf2fvc2hFI5lpmgaP8KxWR+WqNYHwb1SzeyKNL+R4j9X3Qz4B7vxQ/0znVJ5AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/c19e116a1529d75f25062c583d9ee222/023c9/kubernetes-cel-cover.png","srcSet":"/static/c19e116a1529d75f25062c583d9ee222/13c38/kubernetes-cel-cover.png 750w,\n/static/c19e116a1529d75f25062c583d9ee222/207e6/kubernetes-cel-cover.png 1080w,\n/static/c19e116a1529d75f25062c583d9ee222/08dcc/kubernetes-cel-cover.png 1366w,\n/static/c19e116a1529d75f25062c583d9ee222/023c9/kubernetes-cel-cover.png 1433w","sizes":"100vw"},"sources":[{"srcSet":"/static/c19e116a1529d75f25062c583d9ee222/d3491/kubernetes-cel-cover.webp 750w,\n/static/c19e116a1529d75f25062c583d9ee222/ae79a/kubernetes-cel-cover.webp 1080w,\n/static/c19e116a1529d75f25062c583d9ee222/e0434/kubernetes-cel-cover.webp 1366w,\n/static/c19e116a1529d75f25062c583d9ee222/c94a2/kubernetes-cel-cover.webp 1433w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6203768318213537}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/kubernetes-opa-gatekeeper-policy-as-code/","title":"Securing Your Kubernetes Cluster with OPA Gatekeeper: The Power of Policy-as-Code 🛡️","date":"2024-10-31 20:00:00"},"excerpt":"Building a Fortress in Kubernetes: How OPA Gatekeeper and Policy-as-Code Keep Your Cluster Safe 🛡️ Introduction As organizations adopt…"},"nextThought":{"frontmatter":{"path":"/blog/werf-ci-cd-cncf/","title":"Werf: Pioneering the Future of CI/CD - A Close Look at the CNCF's Noteworthy Addition to the DevOps Landscape 🚀","date":"2024-10-31 19:00:00"},"excerpt":"An Insight into the Rising Star of the CNCF Project 🚀 🗃 Introduction Welcome to this blog post, where we explore the fascinating world of…"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}