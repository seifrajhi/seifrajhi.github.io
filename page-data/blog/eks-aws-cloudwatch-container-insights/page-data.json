{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/eks-aws-cloudwatch-container-insights/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Proactive EKS cluster monitoring</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîñ Introduction</h2>\n<p><a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a> on AWS is a great managed container orchestration platform, but it can be difficult to monitor. <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS CloudWatch Container Insights</a> makes it easy to collect, aggregate, and summarize metrics and logs from your EKS cluster. This data can be used to identify performance bottlenecks, troubleshoot problems, and ensure that your cluster is running smoothly.</p>\n<p>In this blog post, we will explore AWS CloudWatch Container Insights and show you how to use it to gain insight into your EKS cluster. By the end of this blog post, you will have a comprehensive understanding of how to use CloudWatch Container Insights to monitor your EKS cluster. You will be able to collect metrics and logs, create dashboards and alarms, and troubleshoot problems. This will help you to keep your cluster running smoothly and avoid downtime.</p>\n<p>So what are you waiting for? Start reading today!</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 5.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAL0lEQVR42mNgwAFUzP7xyVr9l5Iy+S8roPlfnl//v4K02T8ZOdv/ksJW/3lx6QMAwg0LLHUaEagAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Monitoring\" title=\"\" src=\"/static/201da0cff341d7b74e255a314ac9c455/c5bb3/separe.png\" srcset=\"/static/201da0cff341d7b74e255a314ac9c455/04472/separe.png 170w,\n/static/201da0cff341d7b74e255a314ac9c455/9f933/separe.png 340w,\n/static/201da0cff341d7b74e255a314ac9c455/c5bb3/separe.png 680w,\n/static/201da0cff341d7b74e255a314ac9c455/8c557/separe.png 700w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<br>\n<div style=\"width:100%;height:0;padding-bottom:99%;position:relative;\"><iframe src=\"https://giphy.com/embed/htwABV5tJsqDm\" width=\"100%\" height=\"100%\" style=\"position:absolute\" frameborder=\"0\" class=\"giphy-embed\" allowfullscreen></iframe></div>\n<h2 id=\"-explore-aws-cloudwatch-container-insights\" style=\"position:relative;\"><a href=\"#-explore-aws-cloudwatch-container-insights\" aria-label=\" explore aws cloudwatch container insights permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåü Explore AWS CloudWatch Container Insights</h2>\n<p><strong>CloudWatch Container Insights</strong> is a feature-rich service that offers comprehensive monitoring for containerized applications and microservices.</p>\n<p>Available for <a href=\"https://aws.amazon.com/ecs/\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon ECS</a>, <a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon EKS</a>, and <a href=\"https://aws.amazon.com/ec2/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes on Amazon EC2</a>, it automatically collects metrics, including CPU, memory, disk, and network usage, while providing diagnostic data for issue resolution.</p>\n<p>The service employs performance log events with structured JSON schema, generating aggregated metrics at various levels for easy visualization.</p>\n<p>Container Insights supports encryption with <a href=\"https://aws.amazon.com/kms/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS KMS</a> key and uses a containerized CloudWatch agent for efficient performance data collection in Amazon EKS and Kubernetes environments.</p>\n<h2 id=\"Ô∏è-configuring-container-insights-on-amazon-eks-and-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-configuring-container-insights-on-amazon-eks-and-kubernetes\" aria-label=\"Ô∏è configuring container insights on amazon eks and kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚öôÔ∏è Configuring Container Insights on Amazon EKS and Kubernetes</h2>\n<p>To set up <strong>Container Insights</strong> on Amazon EKS or Kubernetes, you need to meet certain prerequisites. The support for Container Insights begins with Amazon EKS versions 1.23 and later, while the quick start method is available from versions 1.24 and later.</p>\n<h3 id=\"Ô∏è-setup-process\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-setup-process\" aria-label=\"Ô∏è setup process permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Setup Process</h3>\n<p>The setup process involves the following steps:</p>\n<ol>\n<li><strong>Verify Prerequisites</strong>: Ensure compatibility and smooth installation.</li>\n<li><strong>Install and Configure</strong>:\n<ul>\n<li>Install and configure the <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html\" target=\"_blank\" rel=\"noopener noreferrer\">CloudWatch agent</a> or the <a href=\"https://aws.amazon.com/otel/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Distro for OpenTelemetry</a> as a DaemonSet on your cluster. This will enable the transmission of metrics to CloudWatch.</li>\n</ul>\n</li>\n<li><strong>Implement Logging</strong>:\n<ul>\n<li>Implement <a href=\"https://fluentbit.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Fluent Bit</a> or <a href=\"https://www.fluentd.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Fluentd</a> to send logs to CloudWatch Logs for centralized log monitoring.</li>\n</ul>\n</li>\n</ol>\n<p>You have the option to perform these steps together as part of the quick start setup when using the CloudWatch agent, or you can choose to perform them separately.</p>\n<h3 id=\"-optional-steps\" style=\"position:relative;\"><a href=\"#-optional-steps\" aria-label=\" optional steps permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîß Optional Steps</h3>\n<p>Additionally, there are optional steps you may consider:</p>\n<ul>\n<li><strong>EKS Control Plane Logging</strong>: Set up Amazon EKS control plane logging for further insights into the cluster.</li>\n<li><strong>StatsD Endpoint</strong>: Enable the CloudWatch agent as a StatsD endpoint on the cluster, allowing you to send StatsD metrics to CloudWatch.</li>\n<li><strong>App Mesh Logging</strong>: If using <a href=\"https://aws.amazon.com/app-mesh/\" target=\"_blank\" rel=\"noopener noreferrer\">App Mesh</a>, enable App Mesh Envoy Access Logs for enhanced monitoring.</li>\n</ul>\n<h3 id=\"-prerequisites\" style=\"position:relative;\"><a href=\"#-prerequisites\" aria-label=\" prerequisites permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Prerequisites</h3>\n<p>Before installing Container Insights on Amazon EKS or Kubernetes, ensure the following prerequisites are met:</p>\n<ul>\n<li><strong>Functional Cluster</strong>: You have a fully operational Amazon EKS or Kubernetes cluster with attached nodes in a supported Region. Check the list of <a href=\"https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/\" target=\"_blank\" rel=\"noopener noreferrer\">supported Regions</a>.</li>\n<li><strong>kubectl Installed</strong>: Ensure that you have <a href=\"https://kubernetes.io/docs/tasks/tools/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl</a> installed and running on your system.</li>\n</ul>\n<p>Additional prerequisites for Kubernetes running on AWS (not using Amazon EKS):</p>\n<ul>\n<li><strong>Role-Based Access Control (RBAC)</strong>: Make sure your Kubernetes cluster has enabled RBAC for authorization.</li>\n<li><strong>Webhook Authorization Mode</strong>: Ensure that the kubelet has enabled Webhook authorization mode.</li>\n<li><strong>Docker Container Runtime</strong>.</li>\n</ul>\n<h3 id=\"-iam-permissions\" style=\"position:relative;\"><a href=\"#-iam-permissions\" aria-label=\" iam permissions permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîë IAM Permissions</h3>\n<p>To enable your Amazon EKS worker nodes to send metrics and logs to CloudWatch, you need to grant IAM permissions. There are two methods to do this:</p>\n<ol>\n<li><strong>Attach a Policy to the IAM Role</strong>: Attach a policy to the IAM role of your worker nodes. This applies to both Amazon EKS clusters and other Kubernetes clusters.</li>\n<li><strong>Use an IAM Role for Service Accounts</strong>: Use an IAM role for service accounts for the cluster and attach the policy to this role. This method is exclusive to Amazon EKS clusters.</li>\n</ol>\n<p>The first option grants CloudWatch permissions for the entire node, while the second option gives CloudWatch access only to the appropriate daemonset pods.</p>\n<h3 id=\"Ô∏è-using-iam-service-account-role-on-amazon-eks\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-using-iam-service-account-role-on-amazon-eks\" aria-label=\"Ô∏è using iam service account role on amazon eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Using IAM Service Account Role on Amazon EKS</h3>\n<p>If you choose to use an IAM service account role on an Amazon EKS cluster:</p>\n<ol>\n<li><strong>Enable IAM Roles for Service Accounts</strong>: Enable IAM roles for service accounts on your cluster.</li>\n<li><strong>Configure the Service Account</strong>: Configure the service account to use an IAM role.</li>\n<li><strong>Attach Policies</strong>: When creating the role, attach the <code class=\"language-text\">CloudWatchAgentServerPolicy</code> IAM policy in addition to any other policies you create for the role. Ensure the Kubernetes Service Account associated with this role is created in the <code class=\"language-text\">amazon-cloudwatch</code> namespace, where the CloudWatch and Fluent Bit daemonsets will be deployed in the subsequent steps.</li>\n<li><strong>Associate IAM Role</strong>: Finally, associate the IAM role with the service account in your cluster.</li>\n</ol>\n<p>Following these prerequisites will ensure a successful installation and setup of Container Insights on your Amazon EKS or Kubernetes cluster.</p>\n<h2 id=\"cloudwatch-container-insights-for-amazon-eks-clusters\" style=\"position:relative;\"><a href=\"#cloudwatch-container-insights-for-amazon-eks-clusters\" aria-label=\"cloudwatch container insights for amazon eks clusters permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>CloudWatch Container Insights for Amazon EKS Clusters</h2>\n<p>Monitoring performance metrics is always a challenge for containerized applications and microservices. When using Amazon EKS, you can use CloudWatch Container Insights for collecting, aggregating, and summarizing metrics and logs from your Kubernetes clusters.</p>\n<p>Amazon CloudWatch is a monitoring service that monitors your AWS resources and applications in real-time. You can create custom dashboards to display custom metrics that you define. Also, you can create alarms that watch those metrics and send notifications when a threshold is reached.</p>\n<p>CloudWatch Container Insights is a feature in CloudWatch that allows you to monitor your containerized applications. You can use Container Insights when using ECS (Elastic Container Service), EKS (Elastic Kubernetes Service), Kubernetes on EC2 and Fargate. CloudWatch automatically watches CPU, Memory, Disk, and Network metrics. With Container Insights, you can also collect diagnostic information from containers such as container failures, the total number of container restarts, and many more from your Kubernetes clusters.</p>\n<p>To enable Container Insights on your EKS Clusters, you need to set up CloudWatch agent as a daemonset on your cluster to send metrics to Cloudwatch, and you need to deploy FluentD as a daemonset to send logs to CloudWatch Logs.</p>\n<p>We have an example EKS Cluster set up with three EC2 Worker Nodes.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 34.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7UlEQVR42nWRS07EMAyGc3wOw5oDsOMCaGDDYjpVM83LeTnJVIU/rVrNBstyPyV2/NsV31+X4Tb6EKxzjgjwnztPt3mYlLUfr+7thT7fhZGjVHrWepJ3Oc/Uk/yz05P7EJGADtSfi2KUd58yl1Jqra0hblB36Iy4W618AEJMSWhjAr45cdkze0HK3cDMjMvt2QY+gfdi8rG2R+k922MzXFtHIcZlWZCEPaAG5xCdmQEYHtLQQFxNGQz/zGl0/HvYNMmUEmBd1/NQKezKAgZ3zQ26mtA+2ZA19XjOic13tVB4DAnu/8J7gCKVGJPmP+h5j+wimln0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/1dce639329a8efba907e13c97a5fcb6f/c5bb3/eks-nodes.png\" srcset=\"/static/1dce639329a8efba907e13c97a5fcb6f/04472/eks-nodes.png 170w,\n/static/1dce639329a8efba907e13c97a5fcb6f/9f933/eks-nodes.png 340w,\n/static/1dce639329a8efba907e13c97a5fcb6f/c5bb3/eks-nodes.png 680w,\n/static/1dce639329a8efba907e13c97a5fcb6f/5a190/eks-nodes.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>We will attach an IAM Policy to nodes' IAM Role for enabling the Worker Nodes to send metric data to CloudWatch.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 27.647058823529413%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVR42mWP60rEMBCF8/5vID6F+Et8ghUEf7vadm0u26S59WKaSbJ16OJC2Y/DMHPIhDPEi+/gFaNtXddCCMYYVs651horjjHGdV0ve9BAkZfD5+vbsfrhvVKq76WU0zTlnEspKSUA2J7uSPkSoCxQyOPzx8PTe8PNupYIgFo2Qgi3ZhxH/PHfDMZNbeeZ9GTWVNBTyyU9K37urTWbdlQbXdddR+fs4J3RPVlsW1F1FPMXH09yNkMsd+AtTdPgMp5wdbDBFCT9OusnPUQ7Rkg55fvdgrGNMZj85uAyAPwBgTtUKITGUqMAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"M\" title=\"\" src=\"/static/7f3e084e7b7fc880f9c1acc7eea1dc57/c5bb3/policy.png\" srcset=\"/static/7f3e084e7b7fc880f9c1acc7eea1dc57/04472/policy.png 170w,\n/static/7f3e084e7b7fc880f9c1acc7eea1dc57/9f933/policy.png 340w,\n/static/7f3e084e7b7fc880f9c1acc7eea1dc57/c5bb3/policy.png 680w,\n/static/7f3e084e7b7fc880f9c1acc7eea1dc57/5a190/policy.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://www.xenonstack.com/blog/generative-ai-platform\">Default Policies on Worker Node IAM Role</a></div>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 12.941176470588234%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAcElEQVR42mWLUQqAIBBEvf8B60MhFLO2bFNDS1Joq6/oMczOwCwbweJip5d5DiGklLz3T/tgH95ALqVkTdNy0UnVk4wxAEBvMMLwQwihlNJac85pSYGtiLAm63fcjlLKWU7SfX845xAx5xxjpFprvQDpUaa5KZYL3QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"M\" title=\"\" src=\"/static/acce2b847c56e63777cc2a62499662e7/c5bb3/agent-policy.png\" srcset=\"/static/acce2b847c56e63777cc2a62499662e7/04472/agent-policy.png 170w,\n/static/acce2b847c56e63777cc2a62499662e7/9f933/agent-policy.png 340w,\n/static/acce2b847c56e63777cc2a62499662e7/c5bb3/agent-policy.png 680w,\n/static/acce2b847c56e63777cc2a62499662e7/5a190/agent-policy.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://www.xenonstack.com/blog/generative-ai-platform\">CloudWatch agent policy</a></div>\n<h3 id=\"instructions-for-the-quick-start-setup-of-container-insights-on-amazon-eks-and-kubernetes\" style=\"position:relative;\"><a href=\"#instructions-for-the-quick-start-setup-of-container-insights-on-amazon-eks-and-kubernetes\" aria-label=\"instructions for the quick start setup of container insights on amazon eks and kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Instructions for the Quick Start setup of Container Insights on Amazon EKS and Kubernetes</h3>\n<p>To quickly set up Container Insights, you can follow the instructions provided in this section. There are two configurations available for Fluent Bit: an optimized version and a version similar to Fluentd. The Quick Start configuration utilizes the optimized version. For more details about the Fluentd-compatible setup, refer to the guide on setting up Fluent Bit as a DaemonSet to send logs to CloudWatch Logs.</p>\n<p>To deploy Container Insights using the Quick Start method, execute the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">ClusterName</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>my-cluster-name<span class=\"token operator\">></span>\n<span class=\"token assign-left variable\">RegionName</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>my-cluster-region<span class=\"token operator\">></span>\n<span class=\"token assign-left variable\">FluentBitHttpPort</span><span class=\"token operator\">=</span><span class=\"token string\">'2020'</span>\n<span class=\"token assign-left variable\">FluentBitReadFromHead</span><span class=\"token operator\">=</span><span class=\"token string\">'Off'</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">${FluentBitReadFromHead}</span> <span class=\"token operator\">=</span> <span class=\"token string\">'On'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token assign-left variable\">FluentBitReadFromTail</span><span class=\"token operator\">=</span><span class=\"token string\">'Off'</span> <span class=\"token operator\">||</span> <span class=\"token assign-left variable\">FluentBitReadFromTail</span><span class=\"token operator\">=</span><span class=\"token string\">'On'</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token variable\">${FluentBitHttpPort}</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token assign-left variable\">FluentBitHttpServer</span><span class=\"token operator\">=</span><span class=\"token string\">'Off'</span> <span class=\"token operator\">||</span> <span class=\"token assign-left variable\">FluentBitHttpServer</span><span class=\"token operator\">=</span><span class=\"token string\">'On'</span>\n<span class=\"token function\">curl</span> https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/{{cluster_name}}/'</span><span class=\"token variable\">${ClusterName}</span><span class=\"token string\">'/;s/{{region_name}}/'</span><span class=\"token variable\">${RegionName}</span><span class=\"token string\">'/;s/{{http_server_toggle}}/\"'</span><span class=\"token variable\">${FluentBitHttpServer}</span><span class=\"token string\">'\"/;s/{{http_server_port}}/\"'</span><span class=\"token variable\">${FluentBitHttpPort}</span><span class=\"token string\">'\"/;s/{{read_from_head}}/\"'</span><span class=\"token variable\">${FluentBitReadFromHead}</span><span class=\"token string\">'\"/;s/{{read_from_tail}}/\"'</span><span class=\"token variable\">${FluentBitReadFromTail}</span><span class=\"token string\">'\"/'</span> <span class=\"token operator\">|</span> kubectl apply <span class=\"token parameter variable\">-f</span> -</code></pre></div>\n<p>Replace <code class=\"language-text\">&lt;my-cluster-name></code> with the name of your Amazon EKS or Kubernetes cluster, and <code class=\"language-text\">&lt;my-cluster-region></code> with the name of the Region where the logs are published. It is recommended to use the same Region where your cluster is deployed to minimize AWS outbound data transfer costs.</p>\n<p>Now, go to the CloudWatch dashboard under <strong>Insights</strong>, click on <strong>Container Insights</strong>.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 502px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 242.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAwABQDASIAAhEBAxEB/8QAGQABAQEAAwAAAAAAAAAAAAAAAgABAwQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAfbZRWwVxsVR105XZJ//xAAbEAEAAQUBAAAAAAAAAAAAAAABEAACERJBIf/aAAgBAQABBQJDJ5HY7HckLdtaq00R/8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEg/9oACAEDAQE/AYY//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwFf/8QAGxAAAQQDAAAAAAAAAAAAAAAAAAEQITEgMOH/2gAIAQEABj8ClEI0dLesf//EAB8QAAEEAQUBAAAAAAAAAAAAAAEAEBEhMUFRYXGxkf/aAAgBAQABPyE+x7QAIAAcMefiIOhhDtTr8ckZGEGCH1hsKVsruwGaUptv/9oADAMBAAIAAwAAABAzBgAUz//EABcRAAMBAAAAAAAAAAAAAAAAABARIFH/2gAIAQMBAT8QhMH/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EF//xAAhEAEAAgIBBAMBAAAAAAAAAAABESEAQRAxUWHRgaGx8P/aAAgBAQABPxCRvMSxnPCQBBgJMAXrKCZHZ/jiNKNGBJmV9sgwA/P95qRG+n6ykEemzwoBwaoZMFBFujhNTHhPWEKwas9cf//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CloudWatch Insights\" title=\"\" src=\"/static/35d2da97df42d604da367f8eb1de8fb0/6f76c/insights.jpg\" srcset=\"/static/35d2da97df42d604da367f8eb1de8fb0/651be/insights.jpg 170w,\n/static/35d2da97df42d604da367f8eb1de8fb0/d30a3/insights.jpg 340w,\n/static/35d2da97df42d604da367f8eb1de8fb0/6f76c/insights.jpg 502w\" sizes=\"(max-width: 502px) 100vw, 502px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>From the drop-down, select <strong>Performance monitoring</strong> and under <strong>Select clusters</strong>, choose your EKS cluster. You will see a dashboard like this, displaying metrics such as CPU, memory utilization, and various network statistics across the EKS cluster.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 48.8235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3KFQf//EABYQAAMAAAAAAAAAAAAAAAAAAAERIP/aAAgBAQABBQJCv//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAIDAQAAAAAAAAAAAAAAAAABEBEhQf/aAAgBAQABPyHS2tKRSH2f/9oADAMBAAIAAwAAABC0D//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EKf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAACAgIDAAAAAAAAAAAAAAABIQAREEExUZH/2gAIAQEAAT8QYAGzi2PTCDioRtpZ71j/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Cluster Statistics\" title=\"\" src=\"/static/d9cc51a21fa50eff22f53589804933ee/7bf67/statistics.jpg\" srcset=\"/static/d9cc51a21fa50eff22f53589804933ee/651be/statistics.jpg 170w,\n/static/d9cc51a21fa50eff22f53589804933ee/d30a3/statistics.jpg 340w,\n/static/d9cc51a21fa50eff22f53589804933ee/7bf67/statistics.jpg 680w,\n/static/d9cc51a21fa50eff22f53589804933ee/4b190/statistics.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>From the drop-down, you can even select the metrics at the <strong>pod level</strong>:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvElEQVR42m1T2ZKbQAzk//8xm9jY3NccMFymt1tep/KQqVIxCKnVUossfzzxLAoMk0NMCT4EVFWFPH+gbjvEJcF5j6quEecZPkazfhzR9T3mZTEL9E3OIYu8XADObUV++8I4TljXFTpbWvB83DFOExYm6bRNzZiBMZvFJYGRhMVvG7KFrHR2vrhhhN73fX/7mBTIfCYz+V7nRfal2cp4EZE//WDIlzVNg5bUXYhWsee9qGprYWBbYtez0OS8tViVlY1I7V/XhX+PAYY4Y509muppM7CZBMfEwkCP42CbJa0h0wUbi5ZFbt8+5wNsgOt+4LU4+L61qud54mDSRHZqRaEzRfG0zdo+4Tln+/Y/hlJQyupF7MRS1RNBP8rpqdmq/XcXyeYqoeSXKV75mdbhz+2G2/3OWQ2mmGOSElVMbaY1GSMlmbKy9PatP3cVNcCOINq7rusMSEJ4HwxwpKW0/hVHigpAzHTXmoipAOXzFDZTq1JWw9cRo5EAn/no2bJYpHi2SsfO+IHxnOfrZbEpaUcvK2YzLLkKSti2nWwm/Pr6DS28LS8LFvyulZEoml/DPyjE8F4zdqiOFKfnNwD8UGwlJDqlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Pod Level Metrics\" title=\"\" src=\"/static/d15a8051da20929823ecc31c9c7ae675/c5bb3/podlevel.png\" srcset=\"/static/d15a8051da20929823ecc31c9c7ae675/04472/podlevel.png 170w,\n/static/d15a8051da20929823ecc31c9c7ae675/9f933/podlevel.png 340w,\n/static/d15a8051da20929823ecc31c9c7ae675/c5bb3/podlevel.png 680w,\n/static/d15a8051da20929823ecc31c9c7ae675/5a190/podlevel.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Or even at the <strong>EKS node level</strong>:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzElEQVR42nVT2ZKjMAzk/79varfmSjKEhNPGxlwhgd5uZ5jdlxXlsmWJllqSk/M5Q1GWmOYZvuuQF0XUy6pGYwyu1yts69APY7yX/cK7ujEw1mIYx7i6vofzHskwDNi2DZIwBIw0StZtRQgB6+MR9fl2I+hfXyUwTVP0l5/kRp/EewfLSMY0EVDnpmnQdR6hf+paIXTwzEDntm0jmKCXZcFM8D1okmVnpGkKR1odKZ9OR9R1Hc91XeF4PKCqKuoBl0tG+wklqYvmnu0uEVCO67p+U+4iUEz/foPKIdvG77bMkWbUWY55nn4A9z0CKn1rRMuwRgENszNshnUW/Q9l2kg5MNiTsiXl/2TYsHYlKdWsm+dP5XcnLQO1rsU1z5+6bVExmHT5ezZiVFP+WSpDIuMXa1jVbASdAtuvbuqsMRJNRd73+/1O+suzy1wC0q7/IqAy02qdIxUXZ0u7dMOsBCJgBdBYaEzUVS0B6K4n2J5MstyXOAYySByB8rzAg/PnfRdthjXUyEgM6z2OEx5sjmzya52PY7Qwe9bQ4uPzgIzTr66maYaXX7+h+6/0jLf3D7y+veNwPDGLHml8WRVfRYfs8nxFeVFxdk1k9AezY0tMnzyFPwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Node Level Metrics\" title=\"\" src=\"/static/5c9e0ca355ec6491a457440b5e5f8d08/c5bb3/nodelevel.png\" srcset=\"/static/5c9e0ca355ec6491a457440b5e5f8d08/04472/nodelevel.png 170w,\n/static/5c9e0ca355ec6491a457440b5e5f8d08/9f933/nodelevel.png 340w,\n/static/5c9e0ca355ec6491a457440b5e5f8d08/c5bb3/nodelevel.png 680w,\n/static/5c9e0ca355ec6491a457440b5e5f8d08/5a190/nodelevel.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"Ô∏è-wrap-up\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-wrap-up\" aria-label=\"Ô∏è wrap up permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úçÔ∏è Wrap Up</h2>\n<p><strong>Container Insights</strong> is a great CloudWatch feature that offers comprehensive monitoring capabilities for ECS clusters, EKS clusters, Kubernetes clusters running on EC2 instances, and Fargate. With Container Insights, you gain access to detailed performance metrics from various components within your cluster.</p>\n<p>For those operating Kubernetes clusters on AWS, whether using EKS or running clusters on EC2 instances, and currently lacking an APM (Application Performance Monitoring) solution for cluster metrics, CloudWatch Container Insights presents a quick and effective method to monitor your cluster's performance. By leveraging Container Insights, you can proactively monitor and optimize the performance of your containerized applications, ensuring smooth operations and efficient resource utilization.</p>\n<div style=\"width:100%;height:0;padding-bottom:100%;position:relative;\"><iframe src=\"https://giphy.com/embed/BDGZ5LdDUkHCS8kS8R\" width=\"100%\" height=\"100%\" style=\"position:absolute\" frameborder=\"0\" class=\"giphy-embed\" allowfullscreen></iframe></div>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":6,"rawMarkdownBody":"\n> **Proactive EKS cluster monitoring**\n\n## üîñ Introduction\n\n[Kubernetes](https://kubernetes.io/) on AWS is a great managed container orchestration platform, but it can be difficult to monitor. [AWS CloudWatch Container Insights](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html) makes it easy to collect, aggregate, and summarize metrics and logs from your EKS cluster. This data can be used to identify performance bottlenecks, troubleshoot problems, and ensure that your cluster is running smoothly.\n\nIn this blog post, we will explore AWS CloudWatch Container Insights and show you how to use it to gain insight into your EKS cluster. By the end of this blog post, you will have a comprehensive understanding of how to use CloudWatch Container Insights to monitor your EKS cluster. You will be able to collect metrics and logs, create dashboards and alarms, and troubleshoot problems. This will help you to keep your cluster running smoothly and avoid downtime.\n\nSo what are you waiting for? Start reading today!\n\n![Monitoring](./separe.png)\n\n<br>\n\nhttps://giphy.com/gifs/surveillance-proper-htwABV5tJsqDm\n\n## üåü Explore AWS CloudWatch Container Insights\n\n**CloudWatch Container Insights** is a feature-rich service that offers comprehensive monitoring for containerized applications and microservices.\n\nAvailable for [Amazon ECS](https://aws.amazon.com/ecs/), [Amazon EKS](https://aws.amazon.com/eks/), and [Kubernetes on Amazon EC2](https://aws.amazon.com/ec2/), it automatically collects metrics, including CPU, memory, disk, and network usage, while providing diagnostic data for issue resolution.\n\nThe service employs performance log events with structured JSON schema, generating aggregated metrics at various levels for easy visualization.\n\nContainer Insights supports encryption with [AWS KMS](https://aws.amazon.com/kms/) key and uses a containerized CloudWatch agent for efficient performance data collection in Amazon EKS and Kubernetes environments.\n\n## ‚öôÔ∏è Configuring Container Insights on Amazon EKS and Kubernetes\n\nTo set up **Container Insights** on Amazon EKS or Kubernetes, you need to meet certain prerequisites. The support for Container Insights begins with Amazon EKS versions 1.23 and later, while the quick start method is available from versions 1.24 and later.\n\n### üõ†Ô∏è Setup Process\n\nThe setup process involves the following steps:\n\n1. **Verify Prerequisites**: Ensure compatibility and smooth installation.\n2. **Install and Configure**: \n    - Install and configure the [CloudWatch agent](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html) or the [AWS Distro for OpenTelemetry](https://aws.amazon.com/otel/) as a DaemonSet on your cluster. This will enable the transmission of metrics to CloudWatch.\n3. **Implement Logging**:\n    - Implement [Fluent Bit](https://fluentbit.io/) or [Fluentd](https://www.fluentd.org/) to send logs to CloudWatch Logs for centralized log monitoring.\n\nYou have the option to perform these steps together as part of the quick start setup when using the CloudWatch agent, or you can choose to perform them separately.\n\n### üîß Optional Steps\n\nAdditionally, there are optional steps you may consider:\n\n- **EKS Control Plane Logging**: Set up Amazon EKS control plane logging for further insights into the cluster.\n- **StatsD Endpoint**: Enable the CloudWatch agent as a StatsD endpoint on the cluster, allowing you to send StatsD metrics to CloudWatch.\n- **App Mesh Logging**: If using [App Mesh](https://aws.amazon.com/app-mesh/), enable App Mesh Envoy Access Logs for enhanced monitoring.\n\n### üìã Prerequisites\n\nBefore installing Container Insights on Amazon EKS or Kubernetes, ensure the following prerequisites are met:\n\n- **Functional Cluster**: You have a fully operational Amazon EKS or Kubernetes cluster with attached nodes in a supported Region. Check the list of [supported Regions](https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/).\n- **kubectl Installed**: Ensure that you have [kubectl](https://kubernetes.io/docs/tasks/tools/) installed and running on your system.\n\nAdditional prerequisites for Kubernetes running on AWS (not using Amazon EKS):\n\n- **Role-Based Access Control (RBAC)**: Make sure your Kubernetes cluster has enabled RBAC for authorization.\n- **Webhook Authorization Mode**: Ensure that the kubelet has enabled Webhook authorization mode.\n- **Docker Container Runtime**.\n\n### üîë IAM Permissions\n\nTo enable your Amazon EKS worker nodes to send metrics and logs to CloudWatch, you need to grant IAM permissions. There are two methods to do this:\n\n1. **Attach a Policy to the IAM Role**: Attach a policy to the IAM role of your worker nodes. This applies to both Amazon EKS clusters and other Kubernetes clusters.\n2. **Use an IAM Role for Service Accounts**: Use an IAM role for service accounts for the cluster and attach the policy to this role. This method is exclusive to Amazon EKS clusters.\n\nThe first option grants CloudWatch permissions for the entire node, while the second option gives CloudWatch access only to the appropriate daemonset pods.\n\n### üõ°Ô∏è Using IAM Service Account Role on Amazon EKS\n\nIf you choose to use an IAM service account role on an Amazon EKS cluster:\n\n1. **Enable IAM Roles for Service Accounts**: Enable IAM roles for service accounts on your cluster.\n2. **Configure the Service Account**: Configure the service account to use an IAM role.\n3. **Attach Policies**: When creating the role, attach the `CloudWatchAgentServerPolicy` IAM policy in addition to any other policies you create for the role. Ensure the Kubernetes Service Account associated with this role is created in the `amazon-cloudwatch` namespace, where the CloudWatch and Fluent Bit daemonsets will be deployed in the subsequent steps.\n4. **Associate IAM Role**: Finally, associate the IAM role with the service account in your cluster.\n\nFollowing these prerequisites will ensure a successful installation and setup of Container Insights on your Amazon EKS or Kubernetes cluster.\n\n## CloudWatch Container Insights for Amazon EKS Clusters\n\nMonitoring performance metrics is always a challenge for containerized applications and microservices. When using Amazon EKS, you can use CloudWatch Container Insights for collecting, aggregating, and summarizing metrics and logs from your Kubernetes clusters.\n\nAmazon CloudWatch is a monitoring service that monitors your AWS resources and applications in real-time. You can create custom dashboards to display custom metrics that you define. Also, you can create alarms that watch those metrics and send notifications when a threshold is reached.\n\nCloudWatch Container Insights is a feature in CloudWatch that allows you to monitor your containerized applications. You can use Container Insights when using ECS (Elastic Container Service), EKS (Elastic Kubernetes Service), Kubernetes on EC2 and Fargate. CloudWatch automatically watches CPU, Memory, Disk, and Network metrics. With Container Insights, you can also collect diagnostic information from containers such as container failures, the total number of container restarts, and many more from your Kubernetes clusters.\n\nTo enable Container Insights on your EKS Clusters, you need to set up CloudWatch agent as a daemonset on your cluster to send metrics to Cloudwatch, and you need to deploy FluentD as a daemonset to send logs to CloudWatch Logs.\n\nWe have an example EKS Cluster set up with three EC2 Worker Nodes.\n\n![Alt text](./eks-nodes.png)\n\nWe will attach an IAM Policy to nodes' IAM Role for enabling the Worker Nodes to send metric data to CloudWatch.\n\n![M](./policy.png \"\")\n<div class=\"image-title\"><a href=\"https://www.xenonstack.com/blog/generative-ai-platform\">Default Policies on Worker Node IAM Role</a></div>\n\n![M](./agent-policy.png \"\")\n<div class=\"image-title\"><a href=\"https://www.xenonstack.com/blog/generative-ai-platform\">CloudWatch agent policy</a></div>\n\n### Instructions for the Quick Start setup of Container Insights on Amazon EKS and Kubernetes\n\nTo quickly set up Container Insights, you can follow the instructions provided in this section. There are two configurations available for Fluent Bit: an optimized version and a version similar to Fluentd. The Quick Start configuration utilizes the optimized version. For more details about the Fluentd-compatible setup, refer to the guide on setting up Fluent Bit as a DaemonSet to send logs to CloudWatch Logs.\n\nTo deploy Container Insights using the Quick Start method, execute the following command:\n\n```bash\nClusterName=<my-cluster-name>\nRegionName=<my-cluster-region>\nFluentBitHttpPort='2020'\nFluentBitReadFromHead='Off'\n[[ ${FluentBitReadFromHead} = 'On' ]] && FluentBitReadFromTail='Off' || FluentBitReadFromTail='On'\n[[ -z ${FluentBitHttpPort} ]] && FluentBitHttpServer='Off' || FluentBitHttpServer='On'\ncurl https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml | sed 's/{{cluster_name}}/'${ClusterName}'/;s/{{region_name}}/'${RegionName}'/;s/{{http_server_toggle}}/\"'${FluentBitHttpServer}'\"/;s/{{http_server_port}}/\"'${FluentBitHttpPort}'\"/;s/{{read_from_head}}/\"'${FluentBitReadFromHead}'\"/;s/{{read_from_tail}}/\"'${FluentBitReadFromTail}'\"/' | kubectl apply -f -\n```\n\nReplace `<my-cluster-name>` with the name of your Amazon EKS or Kubernetes cluster, and `<my-cluster-region>` with the name of the Region where the logs are published. It is recommended to use the same Region where your cluster is deployed to minimize AWS outbound data transfer costs.\n\nNow, go to the CloudWatch dashboard under **Insights**, click on **Container Insights**.\n\n![CloudWatch Insights](./insights.jpg)\n\nFrom the drop-down, select **Performance monitoring** and under **Select clusters**, choose your EKS cluster. You will see a dashboard like this, displaying metrics such as CPU, memory utilization, and various network statistics across the EKS cluster.\n\n![Cluster Statistics](./statistics.jpg)\n\nFrom the drop-down, you can even select the metrics at the **pod level**:\n\n![Pod Level Metrics](./podlevel.png)\n\nOr even at the **EKS node level**:\n\n![Node Level Metrics](./nodelevel.png)\n\n## ‚úçÔ∏è Wrap Up\n\n**Container Insights** is a great CloudWatch feature that offers comprehensive monitoring capabilities for ECS clusters, EKS clusters, Kubernetes clusters running on EC2 instances, and Fargate. With Container Insights, you gain access to detailed performance metrics from various components within your cluster.\n\nFor those operating Kubernetes clusters on AWS, whether using EKS or running clusters on EC2 instances, and currently lacking an APM (Application Performance Monitoring) solution for cluster metrics, CloudWatch Container Insights presents a quick and effective method to monitor your cluster's performance. By leveraging Container Insights, you can proactively monitor and optimize the performance of your containerized applications, ensuring smooth operations and efficient resource utilization.\n\nhttps://giphy.com/gifs/Everdale-supercell-everdale-bigs-the-builder-BDGZ5LdDUkHCS8kS8R\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  _**Until next time üéâ**_\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1429},"frontmatter":{"id":"4cceff9727f6b5d0adec095d","path":"/blog/eks-aws-cloudwatch-container-insights/","humanDate":"Oct 18, 2024","fullDate":"2024-10-18","title":"Casting light on EKS: exploring AWS CloudWatch Container Insights for kubernetes cluster metrics and logs aggregation","keywords":["AWS EKS","CloudWatch","Container Insights","Kubernetes","Metrics"],"excerpt":"Explore how AWS CloudWatch Container Insights can help you monitor EKS cluster metrics and logs, providing proactive insights for better cluster management.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFA//EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAFJibuPkcj/xAAcEAACAQUBAAAAAAAAAAAAAAABAgMAERIhIjH/2gAIAQEAAQUCVumcCknjVT7gLFd//8QAFxEBAAMAAAAAAAAAAAAAAAAAAAECEf/aAAgBAwEBPwGKsf/EABcRAQADAAAAAAAAAAAAAAAAAAABAhH/2gAIAQIBAT8BmzX/xAAbEAABBAMAAAAAAAAAAAAAAAABAAIRISBBcf/aAAgBAQAGPwKICaNwrN8w/8QAHBABAQACAgMAAAAAAAAAAAAAAQARYTFBUXGB/9oACAEBAAE/IRViG4wcPLqDD9mJfePpvMv/2gAMAwEAAgADAAAAEJP/AP/EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EKD/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxBCf//EABwQAQACAgMBAAAAAAAAAAAAAAEAESExgaGxwf/aAAgBAQABPxA1BatRK/6SmRBf2PXLQnyI7dB6gMVEZYIjLif/2Q=="},"images":{"fallback":{"src":"/static/51f6090bcc50fdab3c88f628a7157c9b/3b307/monitoring-cover.jpg","srcSet":"/static/51f6090bcc50fdab3c88f628a7157c9b/7284f/monitoring-cover.jpg 750w,\n/static/51f6090bcc50fdab3c88f628a7157c9b/3b307/monitoring-cover.jpg 800w","sizes":"100vw"},"sources":[{"srcSet":"/static/51f6090bcc50fdab3c88f628a7157c9b/57584/monitoring-cover.webp 750w,\n/static/51f6090bcc50fdab3c88f628a7157c9b/89c0d/monitoring-cover.webp 800w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.66625}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/kubeconfig-eks-authentication-guide-under-the-hood/","title":"Discover Kubeconfig: A guide to EKS authentication with AWS ü§î","date":"2024-10-19 10:36:00"},"excerpt":"AWS EKS-Kubeconfig Connection üêã üìå Introduction One of the key challenges of using EKS is authentication. EKS uses IAM to provide‚Ä¶","html":"<blockquote>\n<p><strong>AWS EKS-Kubeconfig Connection üêã</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>One of the key challenges of using EKS is authentication. EKS uses IAM to provide authentication to your K8s cluster. However, IAM tokens can be difficult to manage and use.</p>\n<p><a href=\"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubeconfig</a> is a configuration file that stores information about K8s clusters, including their API server endpoints, certificates, and authentication information. Kubeconfig can be used to authenticate with EKS clusters, making it a more convenient and secure option than IAM tokens. This blog post will discuss how to use kubeconfig to authenticate with EKS clusters. We will also cover the basics of kubeconfig and how it works.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAByUlEQVR42j2SzWsTQRiH+1940ZOnHAShCBUqIviFWqj1A9Go4MF6LOhFPYlaUAy9KEIrSsWD4AceFJFeJNaLpgXTNNvE7G66rJI0Zpu1bjbZ3dnH2Vl04B3mfX8zDy/vbwaEEEDMN6PHfKlLEMbEcYyIIoRIIpS5UOc4jpTW6/WpWza6ufo/Ou5vkjWQXJ564zJ6s0H23hoT0206GxFOO6KyElL4KqjVBIsLIUvFQD0yVy0yO/ay6+AJjpy8wObMEE+evUiBditg7HaT1589Pi37nMu1eF/wlOj7IcWihmFYsuOYbjdS9ZpRZ/vwIY6eucj5S5fZNnSAmdnnKbBs9Ri50eDdF48PCx6n7zZ5Of9HSgFLpRLVakUCDep1E9PUU6BuMrz/OGPZccYnrrFv9CyP/gGT7fFcl2OTDtncOlefbqg5BUGA67oSYpLP59E0TebpnL5L4JbMTgZ3j7Dn8Ck2bR3k/vRsCozCENu2efuxyqu5FcoV2YU0IgxDBfZ9H8dx8DxP5YmBbWedydwDFXemHnLl+i0Ki8UUmLis6zpGTcMyK2jlZfr9gKSeQNNfAJF0PVLOCwXudFx+/GzQaLZYa/0iFkJpfwGFMd7jLUDIiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Kubeconfig Diagram\" title=\"\" src=\"/static/4f530c98ecd2cb014bb56234dd64c4a3/c5bb3/Kubeconfig.png\" srcset=\"/static/4f530c98ecd2cb014bb56234dd64c4a3/04472/Kubeconfig.png 170w,\n/static/4f530c98ecd2cb014bb56234dd64c4a3/9f933/Kubeconfig.png 340w,\n/static/4f530c98ecd2cb014bb56234dd64c4a3/c5bb3/Kubeconfig.png 680w,\n/static/4f530c98ecd2cb014bb56234dd64c4a3/2c288/Kubeconfig.png 684w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"Ô∏è-kubeconfig-a-manual-creation-guide-and-its-interplay-with-code-classlanguage-textaws-eks-get-tokencode\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-kubeconfig-a-manual-creation-guide-and-its-interplay-with-code-classlanguage-textaws-eks-get-tokencode\" aria-label=\"Ô∏è kubeconfig a manual creation guide and its interplay with code classlanguage textaws eks get tokencode permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ò∏Ô∏è Kubeconfig: A Manual Creation Guide and its Interplay with <code class=\"language-text\">aws eks get-token</code></h2>\n<p><a href=\"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubeconfig</a> serves as the backbone for <a href=\"https://kubernetes.io/docs/reference/kubectl/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl</a>, empowering it to locate the necessary details for cluster selection and communication with the API Server.</p>\n<p>By default, <code class=\"language-text\">kubectl</code> searches for a file named <code class=\"language-text\">config</code> within the <code class=\"language-text\">$HOME/.kube</code> directory, allowing seamless access to Kubernetes resources. In this article, we'll take a hands-on approach and walk you through the manual creation of <code class=\"language-text\">kubeconfig</code>. As we progress, we'll unravel the inner workings of this vital configuration file, exploring its synergy with <code class=\"language-text\">aws eks get-token</code>.</p>\n<p>By the end, you'll have a comprehensive understanding of how these components collaboratively enable secure and efficient interactions with AWS EKS clusters.</p>\n<h3 id=\"-prerequisites-for-this-blog\" style=\"position:relative;\"><a href=\"#-prerequisites-for-this-blog\" aria-label=\" prerequisites for this blog permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìú Prerequisites for this Blog</h3>\n<ul>\n<li>Basic familiarity with Kubernetes concepts and operations.</li>\n<li>Understanding of Amazon Web Services (AWS) and Elastic Kubernetes Service (EKS).</li>\n<li>Familiarity with the <code class=\"language-text\">kubectl</code> command-line tool.</li>\n<li>A functional AWS EKS Kubernetes cluster, to experiment with <code class=\"language-text\">kubeconfig</code> and <code class=\"language-text\">aws eks get-token</code>.</li>\n</ul>\n<h2 id=\"Ô∏è-hands-on-lab\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-hands-on-lab\" aria-label=\"Ô∏è hands on lab permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Hands-on Lab</h2>\n<p>In this part, we'll walk through each step, from creating the <code class=\"language-text\">kubeconfig</code> file to leveraging <code class=\"language-text\">aws eks get-token</code>, all while exploring the vital components that facilitate secure authentication and communication with your Kubernetes cluster.</p>\n<h3 id=\"step-1-remove-existing-kubeconfig-folder-Ô∏è\" style=\"position:relative;\"><a href=\"#step-1-remove-existing-kubeconfig-folder-%EF%B8%8F\" aria-label=\"step 1 remove existing kubeconfig folder Ô∏è permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 1: Remove Existing Kubeconfig Folder ‚öôÔ∏è</h3>\n<p>Delete the existing <code class=\"language-text\">~/.kube</code> folder created by <code class=\"language-text\">eksctl</code> to ensure a clean slate for <code class=\"language-text\">kubeconfig</code> setup.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-r</span> ~/.kube</code></pre></div>\n<h3 id=\"step-2-set-environment-variables-\" style=\"position:relative;\"><a href=\"#step-2-set-environment-variables-\" aria-label=\"step 2 set environment variables  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 2: Set Environment Variables üåç</h3>\n<p>Define <code class=\"language-text\">region</code>, <code class=\"language-text\">cluster_name</code>, and <code class=\"language-text\">account_id</code> as environment variables to simplify subsequent commands.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">region_code</span><span class=\"token operator\">=</span><span class=\"token string\">\"eu-west-1\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">cluster_name</span><span class=\"token operator\">=</span><span class=\"token string\">\"poc-cluster\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">account_id</span><span class=\"token operator\">=</span><span class=\"token string\">\"account_id\"</span></code></pre></div>\n<h3 id=\"step-3-retrieve-cluster-endpoint-\" style=\"position:relative;\"><a href=\"#step-3-retrieve-cluster-endpoint-\" aria-label=\"step 3 retrieve cluster endpoint  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 3: Retrieve Cluster Endpoint üîó</h3>\n<p>Obtain the cluster endpoint URL required for communication with the Kubernetes API server.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">cluster_endpoint</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws eks describe-cluster <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--region</span> $region_code <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> $cluster_name <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"cluster.endpoint\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--output</span> text<span class=\"token variable\">)</span></span></code></pre></div>\n<h3 id=\"step-4-get-certificate-authority-data-\" style=\"position:relative;\"><a href=\"#step-4-get-certificate-authority-data-\" aria-label=\"step 4 get certificate authority data  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 4: Get Certificate Authority Data üîê</h3>\n<p>Acquire the base64-encoded Certificate Authority (CA) Certificate data, essential for secure communication with the cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">certificate_data</span><span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>aws eks describe-cluster <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--region</span> <span class=\"token variable\">$region_code</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> <span class=\"token variable\">$cluster_name</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"cluster.certificateAuthority.data\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--output</span>\naws eks describe-cluster <span class=\"token parameter variable\">--name</span> <span class=\"token variable\">$cluster_name</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"cluster.certificateAuthority.data\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--output</span> text <span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span> <span class=\"token operator\">></span> eks.crt</code></pre></div>\n<p>Additionally, you can inspect the certificate details using OpenSSL to verify its authenticity:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">openssl x509 <span class=\"token parameter variable\">-in</span> eks.crt <span class=\"token parameter variable\">-text</span> <span class=\"token parameter variable\">-noout</span></code></pre></div>\n<p>Here, the <code class=\"language-text\">Issuer: CN=kubernetes</code> and <code class=\"language-text\">Subject: CN=kubernetes</code> indicate a self-signed certificate issued by EKS.</p>\n<h3 id=\"step-5-create-kubeconfig-directory-\" style=\"position:relative;\"><a href=\"#step-5-create-kubeconfig-directory-\" aria-label=\"step 5 create kubeconfig directory  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 5: Create Kubeconfig Directory üìÇ</h3>\n<p>Prepare the necessary <code class=\"language-text\">~/.kube</code> directory to store the <code class=\"language-text\">kubeconfig</code> file and other Kubernetes configuration files.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> ~/.kube</code></pre></div>\n<h3 id=\"step-6-create-kubeconfig-file-\" style=\"position:relative;\"><a href=\"#step-6-create-kubeconfig-file-\" aria-label=\"step 6 create kubeconfig file  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 6. Create Kubeconfig File üìù</h3>\n<p>Generate a configuration file using the following command, which creates the file <code class=\"language-text\">~/.kube/config</code> and automatically fills in all the necessary fields.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">''</span> KUBECONFIG <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: <span class=\"token variable\">$certificate_data</span>\n    server: <span class=\"token variable\">$cluster_endpoint</span>\n  name: arn:aws:eks:<span class=\"token variable\">$region_code</span>:<span class=\"token variable\">$account_id</span>:cluster/<span class=\"token variable\">$cluster_name</span>\ncontexts:\n- context:\n    cluster: arn:aws:eks:<span class=\"token variable\">$region_code</span>:<span class=\"token variable\">$account_id</span>:cluster/<span class=\"token variable\">$cluster_name</span>\n    user: arn:aws:eks:<span class=\"token variable\">$region_code</span>:<span class=\"token variable\">$account_id</span>:cluster/<span class=\"token variable\">$cluster_name</span>\n  name: arn:aws:eks:<span class=\"token variable\">$region_code</span>:<span class=\"token variable\">$account_id</span>:cluster/<span class=\"token variable\">$cluster_name</span>\ncurrent-context: arn:aws:eks:<span class=\"token variable\">$region_code</span>:<span class=\"token variable\">$account_id</span>:cluster/<span class=\"token variable\">$cluster_name</span>\nkind: Config\npreferences: {}\nusers:\n- name: arn:aws:eks:<span class=\"token variable\">$region_code</span>:<span class=\"token variable\">$account_id</span>:cluster/<span class=\"token variable\">$cluster_name</span>\n  user:\n    exec:\n      apiVersion: client.authentication.k8s.io/v1beta1\n      command: aws\n      args:\n        - --region\n        - <span class=\"token variable\">$region_code</span>\n        - eks\n        - get-token\n        - --cluster-name\n        - <span class=\"token variable\">$cluster_name</span>\n        # - \"-r\"\n        # - \"arn:aws:iam::<span class=\"token variable\">$account_id</span>:role/my-role\"\n      # env:\n        # - name: \"AWS_PROFILE\"\n        #   value: \"aws-profile\"\nEOF</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${KUBECONFIG}</span>\"</span> <span class=\"token operator\">></span> ~/.kube/config</code></pre></div>\n<p>The client token, essential for authentication, will be obtained using the AWS CLI.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws eks get-token --cluster-name <span class=\"token variable\">$cluster_name</span></code></pre></div>\n<p>This command provides an <code class=\"language-text\">ExecCredential</code> object containing the required token for authentication.</p>\n<p>The token generated by <code class=\"language-text\">aws eks get-token</code> is a JSON Web Token (JWT) that follows a specific format. Each token begins with the prefix <code class=\"language-text\">k8s-aws-v1.</code>, followed by a base64-encoded string containing JSON data. When decoded, the token should resemble the following structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"kind\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ExecCredential\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"apiVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"client.authentication.k8s.io/v1beta1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"expirationTimestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-08-06T12:09:00Z\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"token\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"base64_encoded_jwt_token_here\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With the configuration file created and the client token obtained, our kubeconfig setup is complete.</p>\n<h3 id=\"step-7-verify-cluster-access-\" style=\"position:relative;\"><a href=\"#step-7-verify-cluster-access-\" aria-label=\"step 7 verify cluster access  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 7. Verify Cluster Access üßë‚Äçüíª</h3>\n<p>Now that our kubeconfig is set up and the client token is obtained, let's validate the cluster access and ensure that everything is functioning correctly. We'll use the <code class=\"language-text\">kubectl</code> command-line tool to interact with the cluster.</p>\n<p>First, check the services available in the cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get svc</code></pre></div>\n<p>Next, verify the list of nodes in the cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get nodes</code></pre></div>\n<p>These commands will provide an overview of the services and nodes within the cluster, confirming successful access and interaction with your AWS EKS cluster. If everything is configured properly, you should see a list of services and nodes, indicating that you have established a successful connection to the Kubernetes cluster on AWS EKS.</p>\n<h3 id=\"step-8-understanding-the-mechanism-‚ìúÔ∏è\" style=\"position:relative;\"><a href=\"#step-8-understanding-the-mechanism-%E2%93%9C%EF%B8%8F\" aria-label=\"step 8 understanding the mechanism ‚ìúÔ∏è permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Step 8. Understanding the Mechanism ‚ìÇÔ∏è</h3>\n<p>Now that we have the IAM user details and the kubeconfig set up, let's explore how the Kubernetes cluster verifies RBAC permissions for these users. Kubernetes checks the IAM user or role credentials obtained earlier against its Role-Based Access Control (RBAC) system.</p>\n<p>To confirm the IAM users or roles added to the cluster's RBAC permissions, we'll examine the <code class=\"language-text\">aws-auth</code> ConfigMap. The ConfigMap stores the mappings between IAM entities and their corresponding Kubernetes roles and groups, defining the access levels for AWS users within the cluster.</p>\n<p>To view the contents of the <code class=\"language-text\">aws-auth</code> ConfigMap, run the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl describe configmap aws-auth <span class=\"token parameter variable\">-n</span> kube-system</code></pre></div>\n<p>This command will display detailed information about the <code class=\"language-text\">aws-auth</code> ConfigMap, shedding light on the IAM users and roles granted permissions in the Kubernetes cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span>         aws<span class=\"token punctuation\">-</span>auth\n<span class=\"token key atrule\">Namespace</span><span class=\"token punctuation\">:</span>    kube<span class=\"token punctuation\">-</span>system\n<span class=\"token key atrule\">Labels</span><span class=\"token punctuation\">:</span>       &lt;none<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">Annotations</span><span class=\"token punctuation\">:</span>  &lt;none<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">API Version</span><span class=\"token punctuation\">:</span>  v1\n<span class=\"token key atrule\">Kind</span><span class=\"token punctuation\">:</span>         ConfigMap\n<span class=\"token key atrule\">Data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">mapRoles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">rolearn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>123456789012<span class=\"token punctuation\">:</span>role/MyEKSWorkerRole\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> system<span class=\"token punctuation\">:</span>node<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>EC2PrivateDNSName<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> system<span class=\"token punctuation\">:</span>bootstrappers\n        <span class=\"token punctuation\">-</span> system<span class=\"token punctuation\">:</span>nodes\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">rolearn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>123456789012<span class=\"token punctuation\">:</span>user/xxxx\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"system:node:{{EC2PrivateDNSName}}\"</span>\n      <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> system<span class=\"token punctuation\">:</span>masters</code></pre></div>\n<p>In our exploration, we encountered an intriguing situation where a specific IAM entity had the ability to access the Amazon EKS cluster despite not having a corresponding entry in the <code class=\"language-text\">aws-auth</code> ConfigMap. This enigma led us to uncover an interesting mechanism provided by AWS.</p>\n<p>When you create an Amazon EKS cluster, the AWS Identity and Access Management (IAM) entity user or role, such as a federated user that creates the cluster, is automatically granted <code class=\"language-text\">system:masters</code> permissions in the cluster's role-based access control (RBAC) configuration in the Amazon EKS control plane. This IAM entity doesn't appear in any visible configuration, so make sure to keep track of which IAM entity originally created the cluster.</p>\n<p>However, this automated privilege assignment applies only to the IAM entity that initiated the cluster creation process. For additional users or roles requiring access, corresponding entries must be explicitly defined in the <code class=\"language-text\">aws-auth</code> ConfigMap.</p>\n<p>In our scenario, we observed that the identity of the user who obtained the token via the <code class=\"language-text\">kubectl</code> command (using <code class=\"language-text\">aws eks get-token</code> specified in the kubeconfig) did not have visible RBAC entries in the <code class=\"language-text\">aws-auth</code> ConfigMap. Nonetheless, AWS documentation clarified that this user had already been granted <code class=\"language-text\">system:masters</code> permissions by default, albeit in a concealed manner.</p>\n<h2 id=\"Ô∏è-conclusion\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-conclusion\" aria-label=\"Ô∏è conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üíÅüèª‚Äç‚ôÇÔ∏è Conclusion</h2>\n<p>This phenomenon highlights a control aspect that we must relinquish when using managed Kubernetes platforms like EKS. Understanding this behavior is essential for assessing the security posture of your Kubernetes cluster, even when certain aspects may not be immediately apparent in the configuration.</p>\n<p>By exploring these intricacies, we gain valuable insights into the underlying mechanics of <a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EKS</a>, which enables us to make informed decisions to enhance the security and management of our Kubernetes clusters.</p>\n<p>We hope that you have found this blog post helpful. If you have any other tips or tricks that you would like to share, please leave a comment below.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/instance-security-imdsv1-vs-v2/","title":"AWS Security: A Comparative Analysis of Instance Metadata Service v1 vs. IMDS v2, Kubernetes Pods, and Docker Container","date":"2024-10-18 19:36:00"},"excerpt":"Securing Your AWS Environment üìå Introduction In this blog post, we will dive into the security aspects of AWS, specifically focusing on the‚Ä¶","html":"<blockquote>\n<p><strong>Securing Your AWS Environment</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>In this blog post, we will dive into the security aspects of AWS, specifically focusing on the Instance Metadata Service (IMDS) v1 and v2, as well as the security considerations for running applications within Kubernetes Pods and Docker containers.</p>\n<div style=\"width:100%;height:0;padding-bottom:56%;position:relative;\"><iframe src=\"https://giphy.com/embed/JykvbWfXtAHSM\" width=\"100%\" height=\"100%\" style=\"position:absolute\" frameborder=\"0\" class=\"giphy-embed\" allowfullscreen></iframe></div>\n<h2 id=\"-understanding-aws-instance-metadata-service-imds\" style=\"position:relative;\"><a href=\"#-understanding-aws-instance-metadata-service-imds\" aria-label=\" understanding aws instance metadata service imds permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Understanding AWS Instance Metadata Service (IMDS)</h2>\n<p>Instance metadata (IMDS), also known as the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">Instance Metadata Service</a>, contains important information about an EC2 instance within the Amazon Web Services (AWS) environment. This data includes details such as the Amazon Machine Image (AMI) used to launch the instance, its IP address, hostname, and other essential parameters. Additionally, users have the option to include User Data in the Instance Metadata, enabling them to store custom parameters that can be retrieved from within the instance.</p>\n<p>Throughout its development, AWS implemented different access models for IMDS. Initially, a request/response access model allowed access to IMDS by making a simple HTTP request from the host. However, to enhance security, a session-oriented system was later introduced, requiring a token for access. This update led to the introduction of IMDSv2, marked by the implementation of a token-based authentication mechanism.</p>\n<p>To strengthen security and defend against potential vulnerabilities like open <a href=\"https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/\" target=\"_blank\" rel=\"noopener noreferrer\">firewalls, reverse proxies, and Server-Side Request Forgery (SSRF)</a>, AWS made significant enhancements to the EC2 Instance Metadata Service. These improvements are aimed at bolstering defense-in-depth strategies, providing a more robust and secure environment for EC2 instances.</p>\n<p>For more details, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h3 id=\"-an-example-of-working-with-imdsv1\" style=\"position:relative;\"><a href=\"#-an-example-of-working-with-imdsv1\" aria-label=\" an example of working with imdsv1 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê An Example of Working with IMDSv1</h3>\n<p>For example, let's start an EC2 instance and add some value to User Data:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 616px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 122.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTklEQVR42u1U0Y6EIAzc///OWxEEQQQKinKDug+XrK73eMlNGgSboUNLeXgfns+GsbblnLVcWJrzco28oZTyIIqMczBnIOf5E0CLMTrvK9mHgLCci7ZljTQDTdhhmnPd6NwgboscozZGdJILwUUH4VobSLuITETOuV02Sak6WckYBSCVCdP64eBb5EDUis6YwXvvQsBhRkxouj453Ou6PlJK4Kc0YY15giMv6yulpzgih/BsGqQM4hlSJ/veT2DDfWZ7zio5xiSVQs7XUqBki1lVnRnqECg653cyZm4cnbUj0j5EHKbcRK0zygPZsK+GCTPmOzjqTFFrjTL1fR2ttWXXf4l5zzYuyc//twQjYQe5/B7/5L9GRmMs29V4c49Kgevt7UTvVjL6GC2iVK96QOMxwViX1dRg7dZpJy8JyHgI6EDEe4JP2C0ERLjoqm+Iy4NjBJtKRAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"IMDS Example\" title=\"\" src=\"/static/c702021c6a3b6714ad765c45b32fab61/40040/imds.png\" srcset=\"/static/c702021c6a3b6714ad765c45b32fab61/04472/imds.png 170w,\n/static/c702021c6a3b6714ad765c45b32fab61/9f933/imds.png 340w,\n/static/c702021c6a3b6714ad765c45b32fab61/40040/imds.png 616w\" sizes=\"(max-width: 616px) 100vw, 616px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Now, try curling the address <code class=\"language-text\">169.254.169.254</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://169.254.169.254/latest/user-data\nsomedata: somevalue</code></pre></div>\n<p>Or get the metadata of the instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data\nami-id\nami-launch-index\nami-manifest-path\nblock-device-mapping/\nevents/\n<span class=\"token function\">hostname</span>\nidentity-credentials/\ninstance-action\ninstance-id\ninstance-life-cycle\ninstance-type\nlocal-hostname\nlocal-ipv4\nmac\nmetrics/\nnetwork/\nplacement/\nprofile\npublic-hostname\npublic-ipv4\npublic-keys/\nreservation-id\nsecurity-groups\nservices/</code></pre></div>\n<h3 id=\"-accessing-imds-from-a-docker-container\" style=\"position:relative;\"><a href=\"#-accessing-imds-from-a-docker-container\" aria-label=\" accessing imds from a docker container permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üê≥ Accessing IMDS from a Docker Container</h3>\n<p>Run the same request from a Docker container:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-172-31-30-97:/<span class=\"token comment\"># docker run -ti alpine/curl curl http://169.254.169.254/latest/meta-data/</span>\nUnable to <span class=\"token function\">find</span> image <span class=\"token string\">'alpine/curl:latest'</span> locally\nlatest: Pulling from alpine/curl\n59bf1c3509f3: Pull complete\nda353f38084f: Pull complete\n05df90dbd213: Pull complete\nDigest: sha256:81372de8c566f2d731bde924bed45230018e6d7c21d051c15e283eb8e06dfa2d\nStatus: Downloaded newer image <span class=\"token keyword\">for</span> alpine/curl:latest\nami-id\nami-launch-index\nami-manifest-path\nblock-device-mapping/\nevents/\n<span class=\"token function\">hostname</span></code></pre></div>\n<h3 id=\"Ô∏è-accessing-imds-from-a-kubernetes-pod\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-accessing-imds-from-a-kubernetes-pod\" aria-label=\"Ô∏è accessing imds from a kubernetes pod permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚ò∏Ô∏è Accessing IMDS from a Kubernetes Pod</h3>\n<p>In the case of Kubernetes, any Pod can also get this data. To check, let's create a pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>imds\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>imds\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alpine/curl<span class=\"token punctuation\">:</span>latest\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> sleep\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3600\"</span>\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n    <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Always</code></pre></div>\n<p>Apply it now:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl apply <span class=\"token parameter variable\">-f</span> pod-imds.yaml</code></pre></div>\n<p>And run the same request with curl from this Pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-ti</span> test-imds -- <span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data/\nami-id\nami-launch-index\nami-manifest-path\nautoscaling/\nblock-device-mapping/\nevents/\n<span class=\"token function\">hostname</span>\niam/\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>For more information, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h2 id=\"-imds-security-credentials-the-issue\" style=\"position:relative;\"><a href=\"#-imds-security-credentials-the-issue\" aria-label=\" imds security credentials the issue permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîí IMDS Security Credentials: The Issue</h2>\n<p>Among other data, IMDS can return the Access/Secret keys and token used to access the Instance IAM Role.</p>\n<h3 id=\"-lets-get-security-credentials\" style=\"position:relative;\"><a href=\"#-lets-get-security-credentials\" aria-label=\" lets get security credentials permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîë Let's Get Security Credentials</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T12:48:33Z\"</span>,\n    <span class=\"token string\">\"Type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AWS-HMAC\"</span>,\n    <span class=\"token string\">\"AccessKeyId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"******BND\"</span>,\n    <span class=\"token string\">\"SecretAccessKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"******8Bx\"</span>,\n    <span class=\"token string\">\"Token\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"******GaQ=\"</span>,\n    <span class=\"token string\">\"Expiration\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T18:51:13Z\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>By utilizing the Access and Secret keys, we gain full permission to perform actions that are allowed for the instance. For instance, if the IAM role associated with the instance possesses AdminAccess permissions, we can inherit these extensive rights.</p>\n<h3 id=\"-verify-and-attach-a-new-role\" style=\"position:relative;\"><a href=\"#-verify-and-attach-a-new-role\" aria-label=\" verify and attach a new role permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Verify and Attach a New Role</h3>\n<p>To verify this, let's proceed by attaching a new role that grants access to S3 buckets to the instance.</p>\n<h4 id=\"-check-the-role-in-the-metadata\" style=\"position:relative;\"><a href=\"#-check-the-role-in-the-metadata\" aria-label=\" check the role in the metadata permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìã Check the Role in the Metadata</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T13:34:51Z\"</span>,\n    <span class=\"token string\">\"InstanceProfileArn\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::********:instance-profile/IMDSTestS3ReadOnlyAccess\"</span>,\n    <span class=\"token string\">\"InstanceProfileId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AIPAXPNJUS3H7XEB7UT24\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"-get-the-keys-and-token\" style=\"position:relative;\"><a href=\"#-get-the-keys-and-token\" aria-label=\" get the keys and token permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Get the Keys and Token</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/security-credentials/IMDSTestS3ReadOnlyAccess</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T13:35:16Z\"</span>,\n    <span class=\"token string\">\"Type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AWS-HMAC\"</span>,\n    <span class=\"token string\">\"AccessKeyId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*******PJ\"</span>,\n    <span class=\"token string\">\"SecretAccessKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*******2n\"</span>,\n    <span class=\"token string\">\"Token\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*******4a\"</span>,\n    <span class=\"token string\">\"Expiration\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-12-12T20:09:51Z\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Add them to our working machine in <code class=\"language-text\">~/.aws/credentials</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">testimds</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">aws_access_key_id</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">*******PJ</span>\n<span class=\"token key attr-name\">aws_secret_access_key</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">*******2n</span>\n<span class=\"token key attr-name\">aws_session_token</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">*******4a</span></code></pre></div>\n<p>And create a profile in the <code class=\"language-text\">~/.aws/config</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">profile testimds</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">region</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">eu-west-1</span>\n<span class=\"token key attr-name\">output</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">json</span></code></pre></div>\n<h4 id=\"-check-the-access-now\" style=\"position:relative;\"><a href=\"#-check-the-access-now\" aria-label=\" check the access now permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚úÖ Check the Access Now</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> testimds s3 <span class=\"token function\">ls</span>\n<span class=\"token number\">2023</span>-12-12 <span class=\"token number\">14</span>:20:01 imdsbucket-test</code></pre></div>\n<p>Access permissions to IMDS can lead to potential security risks. To mitigate these risks, there are two primary options: completely disabling IMDS or transitioning to IMDS version 2.</p>\n<h3 id=\"-disabling-imds\" style=\"position:relative;\"><a href=\"#-disabling-imds\" aria-label=\" disabling imds permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üö´ Disabling IMDS</h3>\n<p>Disabling IMDS can be achieved for EC2 instances using the AWS CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> prod ec2 modify-instance-metadata-options --instance-id i-1d4c0e351255ba2b4 --http-endpoint disabled\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-1d4c0e351255ba2b4\"</span>,\n    <span class=\"token string\">\"InstanceMetadataOptions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"State\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pending\"</span>,\n        <span class=\"token string\">\"HttpTokens\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"optional\"</span>,\n        <span class=\"token string\">\"HttpPutResponseHopLimit\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n        <span class=\"token string\">\"HttpEndpoint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>,\n        <span class=\"token string\">\"HttpProtocolIpv6\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>,\n        <span class=\"token string\">\"InstanceMetadataTags\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"Ô∏è-modifying-instance-metadata-options-via-aws-console\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-modifying-instance-metadata-options-via-aws-console\" aria-label=\"Ô∏è modifying instance metadata options via aws console permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Modifying Instance Metadata Options via AWS Console</h2>\n<p>You can also modify the instance metadata options through the AWS Console:</p>\n<ol>\n<li>Navigate to <strong>EC2</strong>.</li>\n<li>Go to <strong>Instance Settings</strong>.</li>\n<li>Select <strong>Modify instance metadata options</strong>.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 510px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 98.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAACB0lEQVR42o2U/Y7aMBDE8/5P0z8q9REqVafeSW0RulIohRBIQnL4OwkJ/dkmCJW7o9ZiTOKZnR2vSbTWQqmDlFLpgxCuaU5hDMOQF0Wappss83E94pMsS6qq3ld1Ue7LfZUXpRCy7bqmbZu2kVdDyFdGMl8sZvPfyz+r+WI5ff6ZlyX5ie0u18Y2ZyIftmmYob5IS4wxq3W6TjeE1ia+JpTWSpuqfnk5CKa65lsyIxAOwD1g6FBbFKW1DrLTOHhurAWCCjSDZMWe4/HY9/0Z3HUdxNB23XEYen5GCgRoY+C9OMIMTUSeZbMJQ3d5sd3u1ptsuVojnnfOOTKHxNKnlkpIRRqSAzyDqQ3TR7eLLNvBxWaKh6XwmSn8wAcJLHjgXDMaZi1ldD56FliF/mM/UANrHObk4wzdtSkefHp7ANbWwm6dI4xz/4KHcdyCUQDAZ3b+K64vO+9kRqhvWmPoFmZWGIQMwhgLdVKWe3zGi1swm7AHl2KrMGMYqzhLpXyH4Sp13YLxz4XG5DiJ2Hz9KBtX3zWs7RTczqqgnAyhBOMfWnunZhSFlhaIvDTW/x4V/HVo7njPRLiYtIwJNd7PTFfhk2847rcPf1voIl/UOzVjCzBua+j8nEPyXa6UVkpJiYEQvQ0ehlWaTqbT59kv/iRm88W3H5OHx6fPj98fJrMPHz99+fr0F5dPgrnKkjGcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Modify Instance Metadata Options\" title=\"\" src=\"/static/5e46b45e92c1014defc134c093a1fdf5/0abdd/metadata.png\" srcset=\"/static/5e46b45e92c1014defc134c093a1fdf5/04472/metadata.png 170w,\n/static/5e46b45e92c1014defc134c093a1fdf5/9f933/metadata.png 340w,\n/static/5e46b45e92c1014defc134c093a1fdf5/0abdd/metadata.png 510w\" sizes=\"(max-width: 510px) 100vw, 510px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Now, when requesting metadata, you will encounter a <code class=\"language-text\">403 - Forbidden</code> error:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"iso-8859-1\"</span>?<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html PUBLIC <span class=\"token string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span>\n<span class=\"token string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html <span class=\"token assign-left variable\">xmlns</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://www.w3.org/1999/xhtml\"</span> xml:lang<span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span> <span class=\"token assign-left variable\">lang</span><span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">403</span> - Forbidden<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></code></pre></div>\n<h2 id=\"-transitioning-to-imdsv2\" style=\"position:relative;\"><a href=\"#-transitioning-to-imdsv2\" aria-label=\" transitioning to imdsv2 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Transitioning to IMDSv2</h2>\n<p>To enhance security, consider transitioning from IMDSv1 to IMDSv2. By disabling IMDSv1 and exclusively utilizing IMDSv2, you can ensure improved protection through the mandatory use of tokens. To achieve this, add the <code class=\"language-text\">--http-tokens</code> parameter when accessing the IMDS:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ aws <span class=\"token parameter variable\">--profile</span> internal ec2 modify-instance-metadata-options --instance-id i-1d4c0e351255ba2b4 --http-endpoint enabled --http-tokens required\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-1d4c0e351255ba2b4\"</span>,\n    <span class=\"token string\">\"InstanceMetadataOptions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"State\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pending\"</span>,\n        <span class=\"token string\">\"HttpTokens\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"required\"</span>,\n        <span class=\"token string\">\"HttpPutResponseHopLimit\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n        <span class=\"token string\">\"HttpEndpoint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"enabled\"</span>,\n        <span class=\"token string\">\"HttpProtocolIpv6\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>,\n        <span class=\"token string\">\"InstanceMetadataTags\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"disabled\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, you will encounter a <code class=\"language-text\">401 - Unauthorized</code> error:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"iso-8859-1\"</span>?<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html PUBLIC <span class=\"token string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span>\n<span class=\"token string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html <span class=\"token assign-left variable\">xmlns</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://www.w3.org/1999/xhtml\"</span> xml:lang<span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span> <span class=\"token assign-left variable\">lang</span><span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">401</span> - Unauthorized<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></code></pre></div>\n<p>By introducing the token, all functionalities will continue to operate smoothly. Now, let's proceed to obtain the token:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">TOKEN</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> PUT <span class=\"token string\">\"http://169.254.169.254/latest/api/token\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-aws-ec2-metadata-token-ttl-seconds: 21600\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$TOKEN</span>\"</span></code></pre></div>\n<p>Subsequently, execute the curl command once more, this time including the <code class=\"language-text\">X-aws-ec2-metadata-token</code> header:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@ip-172-31-30-97:/<span class=\"token comment\"># curl -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/iam/info</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,\n    <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-08-06T13:34:51Z\"</span>,\n    <span class=\"token string\">\"InstanceProfileArn\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::******799:instance-profile/IMDSTestS3ReadOnlyAccess\"</span>,\n    <span class=\"token string\">\"InstanceProfileId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"XXXXXXXXXXXXXXXXXXXXXXXXXX\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"-using-terraform-modules\" style=\"position:relative;\"><a href=\"#-using-terraform-modules\" aria-label=\" using terraform modules permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì¶ Using Terraform Modules</h2>\n<p>When employing Terraform modules to establish Node Groups, it's essential to carefully consider the provided choices. For instance, the module <a href=\"https://registry.terraform.io/modules/cloudposse/eks-node-group/aws/latest\" target=\"_blank\" rel=\"noopener noreferrer\">cloudposse/terraform-aws-eks-node-group</a> enables IMDSv2 by default. Refer to the <a href=\"https://github.com/cloudposse/terraform-aws-eks-node-group/blob/main/docs/migration-v1-v2.md#behavior-changes\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Behavior changes</strong></a> section for further details.</p>\n<p>For more information, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h2 id=\"-working-with-imdsv2-and-docker-integration\" style=\"position:relative;\"><a href=\"#-working-with-imdsv2-and-docker-integration\" aria-label=\" working with imdsv2 and docker integration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üê≥ Working with IMDSv2 and Docker Integration</h2>\n<p>When employing containers alongside IMDSv2 activation, complications might arise when attempting to obtain the token. For instance:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 21.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtUlEQVR42n2P2w6CQAxEF9gb1wWWq6IE1Pj//4cZW1GfjA8n07TTTCsWb7amNci1hktYFXIVIJUCGZHrgJSgHvcLzYQoTABndv3UKflEndltHjzm0WM5NDh1BY6VQpdL9IXEVGtMfuc6xhhLhd5JDE59YR8rh4qhyrbL1OI+d7idO6xjiZkuXgcLn0ao4ghtJlHG4SskiQTi8Dc8Ez5JHqWlV42Cs5pSou+LbLIB8V7gmpf+8QQp91nSSvfkMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/c5bb3/docker.png\" srcset=\"/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/04472/docker.png 170w,\n/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/9f933/docker.png 340w,\n/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/c5bb3/docker.png 680w,\n/static/eae8f4ddcf9ddba0b31a18ac08c3bd36/5a190/docker.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>To mitigate this issue, introduce a parameter named <code class=\"language-text\">http-put-response-hop-limit</code>, assigning it a value exceeding 1. This precaution is necessary due to an additional network hop introduced by containerized calls when relaying a request from a client to IMDS. The initial hop originates from the host, while the subsequent one emerges from a container residing on the same host.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> internal ec2 modify-instance-metadata-options --http-endpoint enabled --http-tokens required --http-put-response-hop-limit <span class=\"token number\">2</span> --instance-id i-1c3c0e351255ba1c3\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-1c3c0e351255ba1c3\"</span>,\n    <span class=\"token string\">\"InstanceMetadataOptions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"State\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pending\"</span>,\n        <span class=\"token string\">\"HttpTokens\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"required\"</span>,\n        <span class=\"token string\">\"HttpPutResponseHopLimit\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,\n        <span class=\"token string\">\"HttpEndpoint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"enabled\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And run again:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeElEQVR42o2SW4+CMBCFp1CQqwWsFEVRl/WyPpjs//9rkrPTortqYrIPX6YlM2dOh6FdFV4r7SP1feShj0R6SAOBnEl8QuwxHDO+u/ON6IWESaUA6Ty5bhqN7UJjt5yj1QrrWYididCoAPNcYsHRTAMnqiaeo4ieycPRAK11dD11UxzaHJe+wLKMuFiiZhZFgIaxcZb60Jk/fuMGtumKsXk2X7GoEzQqHayzz3WNfWecw7ZiZ9mY2JYBlizS6YmjZscVixsluYHERPCTxTgWJ9gUk6Ge+phlNomx50Q6QVswCgfOiRXLbrN182XSG/dvZAoaOkNoSoF2LlArnklCqDJCEXNMx8KQXfy68f4EXqFW03A5Er7PhP1G4Lgl9GuBc0/4+iC+C5hCcEPihowmLGf2j74RXM1p2Hdc3I+cWGSzEOhXhMOGYMrxiXn4zFuHKpaDfVbJTCOCiu1eCZ4Vn6Pn4vsOvhNzgqn0hseFjR+G/B+BR+xi/wB/st/4Aks5eAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/8dfbb46836edf17adef133e5d7a3733e/c5bb3/docker2.png\" srcset=\"/static/8dfbb46836edf17adef133e5d7a3733e/04472/docker2.png 170w,\n/static/8dfbb46836edf17adef133e5d7a3733e/9f933/docker2.png 340w,\n/static/8dfbb46836edf17adef133e5d7a3733e/c5bb3/docker2.png 680w,\n/static/8dfbb46836edf17adef133e5d7a3733e/5a190/docker2.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-recommendations\" style=\"position:relative;\"><a href=\"#-recommendations\" aria-label=\" recommendations permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Recommendations</h2>\n<p>Below are other key steps and measures to enhance security and optimize the usage of AWS EKS cluster:</p>\n<h3 id=\"-update-the-aws-node-daemonset-to-utilize-irsa\" style=\"position:relative;\"><a href=\"#-update-the-aws-node-daemonset-to-utilize-irsa\" aria-label=\" update the aws node daemonset to utilize irsa permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìà Update the aws-node Daemonset to Utilize IRSA</h3>\n<p>Currently, the aws-node daemonset employs an EC2 instance-assigned role for IP assignment to pods. This role includes various AWS managed policies, e.g., <code class=\"language-text\">AmazonEKS_CNI_Policy</code> and <code class=\"language-text\">EC2ContainerRegistryReadOnly</code>, posing a security risk. To mitigate this, consider updating the aws-node daemonset to use IRSA, following the script in the repository for this guide, to update the aws-node daemonset to use IRSA.</p>\n<h3 id=\"-limit-access-to-the-worker-nodes-instance-profile\" style=\"position:relative;\"><a href=\"#-limit-access-to-the-worker-nodes-instance-profile\" aria-label=\" limit access to the worker nodes instance profile permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîí Limit Access to the Worker Node's Instance Profile</h3>\n<p>When you use IRSA, it updates the credential chain of the pod to use the IRSA token. However, the pod can still inherit the rights of the instance profile assigned to the worker node. When using IRSA, it is strongly recommended that you block access to instance metadata to minimize the blast radius of a breach.</p>\n<p>You can block access to instance metadata by requiring the instance to use IMDSv2 only and updating the hop count to 1 as in the example below. You can also include these settings in the node group's launch template. Do not disable instance metadata as this will prevent components like the node termination handler and other things that rely on instance metadata from working properly.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws ec2 modify-instance-metadata-options --instance-id <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span> --http-tokens required --http-put-response-hop-limit <span class=\"token number\">1</span></code></pre></div>\n<p>If you are using Terraform to create launch templates for use with Managed Node Groups, add the metadata block to configure the hop count as seen in this code snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_launch_template\"</span></span> <span class=\"token string\">\"foo\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"foo\"</span>\n  ...\n  <span class=\"token keyword\">metadata_options</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">http_endpoint</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"enabled\"</span>\n    <span class=\"token property\">http_tokens</span>                 <span class=\"token punctuation\">=</span> <span class=\"token string\">\"required\"</span>\n    <span class=\"token property\">http_put_response_hop_limit</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">1</span>\n    <span class=\"token property\">instance_metadata_tags</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"enabled\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can also block a pod's access to EC2 metadata by manipulating iptables on the node. For further information about this method, see <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html\" target=\"_blank\" rel=\"noopener noreferrer\">Limiting access to the instance metadata service</a>.</p>\n<h3 id=\"-update-the-aws-sdk-version\" style=\"position:relative;\"><a href=\"#-update-the-aws-sdk-version\" aria-label=\" update the aws sdk version permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Update the AWS SDK Version</h3>\n<p>If you have an application that is using an older version of the AWS SDK that doesn't support IRSA, you should update the SDK version.</p>\n<h3 id=\"-scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name\" style=\"position:relative;\"><a href=\"#-scope-the-iam-role-trust-policy-for-irsa-to-the-service-account-name\" aria-label=\" scope the iam role trust policy for irsa to the service account name permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîê Scope the IAM Role Trust Policy for IRSA to the Service Account Name</h3>\n<p>The trust policy can be scoped to a Namespace or a specific service account within a Namespace. When using IRSA, it's best to make the role trust policy as explicit as possible by including the service account name. This will effectively prevent other Pods within the same Namespace from assuming the role. The CLI <code class=\"language-text\">eksctl</code> will do this automatically when you use it to create service accounts/IAM roles. See <a href=\"https://eksctl.io/usage/iamserviceaccounts/\" target=\"_blank\" rel=\"noopener noreferrer\">eksctl documentation</a> for further information.</p>\n<h3 id=\"Ô∏è-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-use-imdsv2-and-increase-the-hop-limit-on-ec2-instances-to-2\" aria-label=\"Ô∏è use imdsv2 and increase the hop limit on ec2 instances to 2 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Use IMDSv2 and Increase the Hop Limit on EC2 Instances to 2</h3>\n<p>IMDSv2 requires you to use a PUT request to get a session token. The initial PUT request has to include a TTL for the session token. Newer versions of the AWS SDKs will handle this and the renewal of said token automatically. It's also important to be aware that the default hop limit on EC2 instances is intentionally set to 1 to prevent IP forwarding. As a consequence, Pods that request a session token that are run on EC2 instances may eventually time out and fallback to using the IMDSv1 data flow. EKS adds support for IMDSv2 by enabling both v1 and v2 and changing the hop limit to 2 on nodes provisioned by <code class=\"language-text\">eksctl</code> or with the official CloudFormation templates.</p>\n<p>For more information, refer to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Documentation on IMDS</a>.</p>\n<h2 id=\"Ô∏è-conclusion\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-conclusion\" aria-label=\"Ô∏è conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚≠êÔ∏è Conclusion</h2>\n<p>In this blog post, we have conducted a comprehensive analysis of the security considerations of AWS Instance Metadata Service (IMDS) v1 and IMDS v2, as well as their interactions with Kubernetes Pods and Docker Containers. By understanding the strengths and limitations of each version, and by incorporating best practices such as using <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html\" target=\"_blank\" rel=\"noopener noreferrer\">IAM Roles for Service Accounts (IRSA)</a>, restricting access to instance profiles, and leveraging IMDSv2, you can effectively secure your AWS environment and ensure its robust security posture. Protecting your assets and data is essential, and this comparative exploration provides you with the insights you need to navigate the complexities of securing your AWS infrastructure.</p>\n<p>We hope that you have found this blog post helpful. If you have any other tips or tricks that you would like to share, please leave a comment below. üí¨</p>\n<p>üîó <strong>Useful Links:</strong></p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Instance Metadata Service</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/security/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Security Blog</a></li>\n<li><a href=\"https://kubernetes.io/docs/home/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Documentation</a></li>\n<li><a href=\"https://docs.docker.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Docker Documentation</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}