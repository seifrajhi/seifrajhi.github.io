{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/datadog-mkat-kubernetes-security/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Enhancing Security in Managed Kubernetes üõ°Ô∏è</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>At KubeCon EU 2023, Datadog released the <a href=\"https://github.com/DataDog/managed-kubernetes-auditing-toolkit\" target=\"_blank\" rel=\"noopener noreferrer\">Managed Kubernetes Auditing Toolkit (MKAT)</a>, a comprehensive solution designed to identify common security issues within managed Kubernetes environments. Initially focused on Amazon EKS, MKAT is a versatile tool that will be expanded to support other managed Kubernetes environments in the future. This all-in-one auditing toolkit offers features such as identifying trust relationships between K8s service accounts and AWS IAM roles, finding hardcoded AWS credentials in K8s resources, and testing if pods can access the AWS Instance Metadata Service (IMDS). With easy installation via Homebrew or pre-compiled binary, MKAT provides a valuable resource for enhancing the security of Kubernetes clusters. In this blog post, we will explore the key features of MKAT, its benefits for users, and how it can help improve the overall security of managed Kubernetes environments.</p>\n<h3 id=\"Ô∏è-mkat-the-all-in-one-auditing-toolkit-for-kubernetes-security\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-mkat-the-all-in-one-auditing-toolkit-for-kubernetes-security\" aria-label=\"Ô∏è mkat the all in one auditing toolkit for kubernetes security permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è MKAT: The All-in-One Auditing Toolkit for Kubernetes Security</h3>\n<p>MKAT is an all-in-one auditing toolkit for identifying common security issues within managed Kubernetes environments. It is currently focused on Amazon EKS and will be extended to other managed Kubernetes environments in the future. The tool provides a range of features, including:</p>\n<ul>\n<li>üîé <a href=\"https://github.com/DataDog/managed-kubernetes-auditing-toolkit#identify-trust-relationships-between-k8s-service-accounts-and-aws-iam-roles\" target=\"_blank\" rel=\"noopener noreferrer\">Identify trust relationships between K8s service accounts and AWS IAM roles</a> - Supports both IAM Roles for Service Accounts (IRSA), and <a href=\"https://aws.amazon.com/blogs/aws/amazon-eks-pod-identity-simplifies-iam-permissions-for-applications-on-amazon-eks-clusters/\" target=\"_blank\" rel=\"noopener noreferrer\">Pod Identity</a>, released on November 26, 2023.</li>\n<li>üîë <a href=\"https://github.com/DataDog/managed-kubernetes-auditing-toolkit#find-hardcoded-aws-credentials-in-k8s-resources\" target=\"_blank\" rel=\"noopener noreferrer\">Find hardcoded AWS credentials in K8s resources</a>.</li>\n<li>üíÄ <a href=\"https://github.com/DataDog/managed-kubernetes-auditing-toolkit?tab=readme-ov-file#test-if-pods-can-access-the-aws-instance-metadata-service-imds\" target=\"_blank\" rel=\"noopener noreferrer\">Test if pods can access the AWS Instance Metadata Service (IMDS)</a>.</li>\n</ul>\n<p>For more details, visit the <a href=\"https://github.com/DataDog/managed-kubernetes-auditing-toolkit\" target=\"_blank\" rel=\"noopener noreferrer\">official MKAT documentation</a>.</p>\n<h2 id=\"-installation-and-setup\" style=\"position:relative;\"><a href=\"#-installation-and-setup\" aria-label=\" installation and setup permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Installation and Setup</h2>\n<p>To install and set up the Managed Kubernetes Auditing Toolkit (MKAT), follow these steps:</p>\n<ol>\n<li>\n<p><strong>Add the MKAT Homebrew Tap:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">brew tap datadog/mkat https://github.com/datadog/managed-kubernetes-auditing-toolkit</code></pre></div>\n</li>\n<li>\n<p><strong>Install MKAT:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">brew <span class=\"token function\">install</span> datadog/mkat/managed-kubernetes-auditing-toolkit</code></pre></div>\n</li>\n<li>\n<p><strong>Check the Installed MKAT Version:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">mkat version</code></pre></div>\n</li>\n</ol>\n<p>Alternatively, you can use a pre-compiled binary for installation. After installation, ensure that you are authenticated against your cluster and to AWS, as MKAT uses your current AWS and <code class=\"language-text\">kubectl</code> authentication contexts.</p>\n<h2 id=\"-practical-usage-of-mkat\" style=\"position:relative;\"><a href=\"#-practical-usage-of-mkat\" aria-label=\" practical usage of mkat permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Practical Usage of MKAT</h2>\n<h3 id=\"analyzing-role-relationships\" style=\"position:relative;\"><a href=\"#analyzing-role-relationships\" aria-label=\"analyzing role relationships permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Analyzing Role Relationships</h3>\n<p>Running <code class=\"language-text\">mkat eks find-role-relationships</code> will analyze your Kubernetes service accounts and the trust policy of IAM roles in your AWS account, then output a summary of which Kubernetes workload can assume AWS roles.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 112.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsTAAALEwEAmpwYAAACyElEQVR42o1U/U/aUBTt/5/sB83cfpnGjG2amCjIMNvAZBqjMQwEWkGlH9AvKFSgtH0t/YAd+pShQ7eTy8t9tPe9e889t8w0wWw2cxPAWfxDsew/AxPHcRRFWLvdrmEYeDUMQ2wXb8TTKR5Tg0+NbpkgCIrF4vHx8cnJyenpaaFQKJVKnudNJhN/Mgl9n5XkFCt9um5/bsgpbu7s3CrbXOtcMebBLMueJ7i4uDg7O6vVaoQQ3/c93w88r95W94VuWjQOBGOf78DSkrHHd4tan0lyeVJVnGC2VPRzmz04K4KxBQvTJbxIGH6maSqKout6p9PRNG00Gi0H4OzmvXU7cJojtzl0eIvAbofOiHjzYNScyWS+JsjlchzH0bbZtu0RIojS+yt+vSq945S1srDByu9YZaOu3/QH8+BerydJUisBHGThOA4aRu8Ho43esG6O66ZFrWFa131r6BJmZTEIcBKgYf+o+SWAS/QMRyA1rBBTuEAQgIvXghfIsM1Ulc9KvQP0uamnhe7ejTL0Jsz/aDhdlzar/J5g7N5pX27U3Ts9VZcHxGcQgk4vyyFp/JQeB50hYVnTTGtMghAcuInZno8BeBAJenufYDweU8LQKvio+YnanhGGxxCJqqrtdluWcYemqlq/byKeZmMSTxm7qk2oabZHHd12GYRls1moAzrJ5Y4ODw/h4yAMlkuIrio75cabX823FXG9zK+V+PUrAbZWET/UJMayLFEUpQTiI2jy83ujSBjY5Xu3ajpXpl0x7WSF79R6FrOypL+nZXXNdIBeCaa8P7rT5cbO+wyS8DGpVCrlcvny8hJ6Wo4Hoz8l/UjsFmTzR6v3XTLy7f43yRhRkaDafD6PDxBWTBXP82CLatv3PIzqTrW5yckfG+oW29q+lrfryhYn910PIplC/V4CSAL3PDbpT4IkjEgUu1jD+MEPwiiOfwNvqgR+WgDoBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"mkat\" title=\"\" src=\"/static/b367d1857c84c640d6fb559377dbc3cd/c5bb3/mkat.png\" srcset=\"/static/b367d1857c84c640d6fb559377dbc3cd/04472/mkat.png 170w,\n/static/b367d1857c84c640d6fb559377dbc3cd/9f933/mkat.png 340w,\n/static/b367d1857c84c640d6fb559377dbc3cd/c5bb3/mkat.png 680w,\n/static/b367d1857c84c640d6fb559377dbc3cd/b12f7/mkat.png 1020w,\n/static/b367d1857c84c640d6fb559377dbc3cd/f43e4/mkat.png 1120w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>MKAT works by analyzing both the IAM roles in the AWS account and the K8s service accounts in the cluster, and then matching them together based on these two mechanisms.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ mkat eks find-role-relationships\n _ __ ___   <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> __   __ _  <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_\n <span class=\"token operator\">|</span> '_ <span class=\"token variable\"><span class=\"token variable\">`</span> _ <span class=\"token punctuation\">\\</span>  <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>/ /  / _<span class=\"token variable\">`</span></span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> __<span class=\"token operator\">|</span>\n <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>   <span class=\"token operator\">&lt;</span>  <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_\n <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span><span class=\"token punctuation\">\\</span>_<span class=\"token punctuation\">\\</span>  <span class=\"token punctuation\">\\</span>__,_<span class=\"token operator\">|</span>  <span class=\"token punctuation\">\\</span>__<span class=\"token operator\">|</span>\n\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:05:59 Connected to EKS cluster mkat-cluster\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:05:59 Retrieving cluster information\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:06:00 Listing K8s <span class=\"token function\">service</span> accounts <span class=\"token keyword\">in</span> all namespaces\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:06:02 Listing roles <span class=\"token keyword\">in</span> the AWS account\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:06:03 Found <span class=\"token number\">286</span> IAM roles <span class=\"token keyword\">in</span> the AWS account\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:06:03 Analyzing IAM Roles For Service Accounts <span class=\"token punctuation\">(</span>IRSA<span class=\"token punctuation\">)</span> configuration\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:06:03 Analyzing Pod Identity configuration of your cluster\n<span class=\"token number\">2023</span>/11/28 <span class=\"token number\">21</span>:06:04 Analyzing namespace microservices <span class=\"token function\">which</span> has <span class=\"token number\">1</span> Pod Identity associations\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n<span class=\"token operator\">|</span> NAMESPACE        <span class=\"token operator\">|</span> SERVICE ACCOUNT           <span class=\"token operator\">|</span> POD                               <span class=\"token operator\">|</span> ASSUMABLE ROLE              <span class=\"token operator\">|</span> MECHANISM                      <span class=\"token operator\">|</span>\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n<span class=\"token operator\">|</span> microservices    <span class=\"token operator\">|</span> inventory-service-sa      <span class=\"token operator\">|</span> inventory-service                 <span class=\"token operator\">|</span> inventory-service-role      <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span>                           <span class=\"token operator\">|</span>                                   <span class=\"token operator\">|</span> s3-backup-role              <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span> rate-limiter-sa           <span class=\"token operator\">|</span> rate-limiter-1                    <span class=\"token operator\">|</span> rate-limiter-role           <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span>                           <span class=\"token operator\">|</span>                                   <span class=\"token operator\">|</span> webserver-role              <span class=\"token operator\">|</span> Pod Identity                   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span>                           <span class=\"token operator\">|</span> rate-limiter-2                    <span class=\"token operator\">|</span> rate-limiter-role           <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span>                           <span class=\"token operator\">|</span>                                   <span class=\"token operator\">|</span> webserver-role              <span class=\"token operator\">|</span> Pod Identity                   <span class=\"token operator\">|</span>\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n<span class=\"token operator\">|</span> default          <span class=\"token operator\">|</span> vulnerable-application-sa <span class=\"token operator\">|</span> vulnerable-application            <span class=\"token operator\">|</span> vulnerable-application-role <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span> webserver-sa              <span class=\"token operator\">|</span> webserver                         <span class=\"token operator\">|</span> webserver-role              <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n<span class=\"token operator\">|</span> external-secrets <span class=\"token operator\">|</span> external-secrets-sa       <span class=\"token operator\">|</span> external-secrets-66cfb84c9b-kldt9 <span class=\"token operator\">|</span> ExternalSecretsRole         <span class=\"token operator\">|</span> IAM Roles <span class=\"token keyword\">for</span> Service Accounts <span class=\"token operator\">|</span>\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+</code></pre></div>\n<h3 id=\"identifying-hardcoded-aws-access-keys\" style=\"position:relative;\"><a href=\"#identifying-hardcoded-aws-access-keys\" aria-label=\"identifying hardcoded aws access keys permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Identifying Hardcoded AWS Access Keys</h3>\n<p>MKAT can also identify hardcoded AWS access keys in the definition of Kubernetes ConfigMaps, Secrets, and Pods, with minimal false positives.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ mkat eks find-secrets\n                  _              _\n  _ __ ___   <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> __   __ _  <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_\n <span class=\"token operator\">|</span> '_ <span class=\"token variable\"><span class=\"token variable\">`</span> _ <span class=\"token punctuation\">\\</span>  <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>/ /  / _<span class=\"token variable\">`</span></span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> __<span class=\"token operator\">|</span>\n <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>   <span class=\"token operator\">&lt;</span>  <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_\n <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span><span class=\"token punctuation\">\\</span>_<span class=\"token punctuation\">\\</span>  <span class=\"token punctuation\">\\</span>__,_<span class=\"token operator\">|</span>  <span class=\"token punctuation\">\\</span>__<span class=\"token operator\">|</span>\n\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Connected to EKS cluster mkat-cluster\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Searching <span class=\"token keyword\">for</span> AWS secrets <span class=\"token keyword\">in</span> ConfigMaps<span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Analyzing <span class=\"token number\">10</span> ConfigMaps<span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Searching <span class=\"token keyword\">for</span> AWS secrets <span class=\"token keyword\">in</span> Secrets<span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Analyzing <span class=\"token number\">45</span> Secrets<span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Searching <span class=\"token keyword\">for</span> AWS secrets <span class=\"token keyword\">in</span> Pod definitions<span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Analyzing <span class=\"token number\">8</span> Pod definitions<span class=\"token punctuation\">..</span>.\n+-----------+--------+-----------------------------------------+------------------------------------------+\n<span class=\"token operator\">|</span> NAMESPACE <span class=\"token operator\">|</span> TYPE   <span class=\"token operator\">|</span> NAME                                    <span class=\"token operator\">|</span> VALUE                                    <span class=\"token operator\">|</span>\n+-----------+--------+-----------------------------------------+------------------------------------------+\n<span class=\"token operator\">|</span> default   <span class=\"token operator\">|</span> Secret <span class=\"token operator\">|</span> kafka-proxy-aws <span class=\"token punctuation\">(</span>aws access key<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> XXXXXXXXXXXXXXXXXXXX                     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> default   <span class=\"token operator\">|</span> Secret <span class=\"token operator\">|</span> kafka-proxy-aws <span class=\"token punctuation\">(</span>aws secret<span class=\"token punctuation\">)</span>    <span class=\"token operator\">|</span> XXXXXXXX/XXCAXXXXXXXXXqEPXX+XXX/XXXXXXXX <span class=\"token operator\">|</span>\n+-----------+--------+-----------------------------------------+------------------------------------------+</code></pre></div>\n<h3 id=\"validating-imds-access\" style=\"position:relative;\"><a href=\"#validating-imds-access\" aria-label=\"validating imds access permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Validating IMDS Access</h3>\n<p>Finally, you can use MKAT to validate that you properly blocked pod access to the IMDS:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ mkat eks test-imds-access\n                  _              _\n  _ __ ___   <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> __   __ _  <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_\n <span class=\"token operator\">|</span> '_ <span class=\"token variable\"><span class=\"token variable\">`</span> _ <span class=\"token punctuation\">\\</span>  <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>/ /  / _<span class=\"token variable\">`</span></span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> __<span class=\"token operator\">|</span>\n <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>   <span class=\"token operator\">&lt;</span>  <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_\n <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>_<span class=\"token operator\">|</span><span class=\"token punctuation\">\\</span>_<span class=\"token punctuation\">\\</span>  <span class=\"token punctuation\">\\</span>__,_<span class=\"token operator\">|</span>  <span class=\"token punctuation\">\\</span>__<span class=\"token operator\">|</span>\n\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Connected to EKS cluster mkat-cluster\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:19 Testing <span class=\"token keyword\">if</span> IMDSv1 and IMDSv2 are accessible from pods by creating a pod that attempts to access it\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:23 IMDSv2 is accessible: any pod can retrieve credentials <span class=\"token keyword\">for</span> the AWS role eksctl-mkat-cluster-nodegroup-ng-NodeInstanceRole-AXWUFF35602Z\n<span class=\"token number\">2023</span>/04/12 <span class=\"token number\">21</span>:56:23 IMDSv1 is not accessible to pods <span class=\"token keyword\">in</span> your cluster: able to establish a network connection to the IMDS, but no credentials were returned</code></pre></div>\n<h2 id=\"-comparison-with-other-tools\" style=\"position:relative;\"><a href=\"#-comparison-with-other-tools\" aria-label=\" comparison with other tools permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Comparison with Other Tools</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>Tool</strong></th>\n<th align=\"center\"><strong>Description</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/aquasecurity/kube-bench\" target=\"_blank\" rel=\"noopener noreferrer\">kube-bench</a></td>\n<td align=\"center\">kube-bench is a general-purpose auditing tool for Kubernetes cluster, checking for compliance against the CIS benchmarks.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/cyberark/KubiScan\" target=\"_blank\" rel=\"noopener noreferrer\">kubiscan</a></td>\n<td align=\"center\">kubiscan focuses on identifying dangerous in-cluster RBAC permissions.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/inguardians/peirates\" target=\"_blank\" rel=\"noopener noreferrer\">peirates</a></td>\n<td align=\"center\">peirates is a generic Kubernetes penetration testing tool. Although it has a <code class=\"language-text\">get-aws-token</code> command that retrieves node credentials from the IMDS, it is not specific to managed K8s environments.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/brompwnie/botb\" target=\"_blank\" rel=\"noopener noreferrer\">botb</a></td>\n<td align=\"center\">botb is a generic Kubernetes penetration testing tool. It also has a command to retrieve node credentials from the IMDS, but it is not specific to managed K8s environments.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/PaloAltoNetworks/rbac-police\" target=\"_blank\" rel=\"noopener noreferrer\">rbac-police</a></td>\n<td align=\"center\">rbac-police focuses on identifying in-cluster RBAC relationships.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/quarkslab/kdigger\" target=\"_blank\" rel=\"noopener noreferrer\">kdigger</a></td>\n<td align=\"center\">kdigger is a general-purpose context discovery tool for Kubernetes penetration testing. It does not attempt to be specific to managed K8s environments.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/4ARMED/kubeletmein\" target=\"_blank\" rel=\"noopener noreferrer\">kubeletmein</a></td>\n<td align=\"center\">kubeletmein <em>is</em> specific to managed K8s environments. It's a utility to generate a kubeconfig file using the node's IAM credentials, to then use it in a compromised pod.</td>\n</tr>\n<tr>\n<td align=\"center\"><a href=\"https://github.com/aws-samples/hardeneks\" target=\"_blank\" rel=\"noopener noreferrer\">hardeneks</a></td>\n<td align=\"center\">hardeneks <em>is</em> specific to managed K8s environments, but only for EKS. It identifies issues and lack of best practices inside of the cluster, and does not focus on cluster to cloud pivots.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèÅ Conclusion</h2>\n<p>In conclusion, MKAT is a valuable tool for enhancing security in managed Kubernetes environments. It provides a comprehensive set of audits that can help identify and remediate common security risks. MKAT is easy to use and can be integrated into your existing security workflows. Additionally, MKAT is open source and free to use. If you are responsible for securing a managed Kubernetes environment, I encourage you to give MKAT a try.</p>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<p><br><br></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":5,"rawMarkdownBody":"\n> **Enhancing Security in Managed Kubernetes üõ°Ô∏è**\n\n## üìå Introduction\n\nAt KubeCon EU 2023, Datadog released the [Managed Kubernetes Auditing Toolkit (MKAT)](https://github.com/DataDog/managed-kubernetes-auditing-toolkit), a comprehensive solution designed to identify common security issues within managed Kubernetes environments. Initially focused on Amazon EKS, MKAT is a versatile tool that will be expanded to support other managed Kubernetes environments in the future. This all-in-one auditing toolkit offers features such as identifying trust relationships between K8s service accounts and AWS IAM roles, finding hardcoded AWS credentials in K8s resources, and testing if pods can access the AWS Instance Metadata Service (IMDS). With easy installation via Homebrew or pre-compiled binary, MKAT provides a valuable resource for enhancing the security of Kubernetes clusters. In this blog post, we will explore the key features of MKAT, its benefits for users, and how it can help improve the overall security of managed Kubernetes environments.\n\n### üõ†Ô∏è MKAT: The All-in-One Auditing Toolkit for Kubernetes Security\n\nMKAT is an all-in-one auditing toolkit for identifying common security issues within managed Kubernetes environments. It is currently focused on Amazon EKS and will be extended to other managed Kubernetes environments in the future. The tool provides a range of features, including:\n\n- üîé [Identify trust relationships between K8s service accounts and AWS IAM roles](https://github.com/DataDog/managed-kubernetes-auditing-toolkit#identify-trust-relationships-between-k8s-service-accounts-and-aws-iam-roles) - Supports both IAM Roles for Service Accounts (IRSA), and [Pod Identity](https://aws.amazon.com/blogs/aws/amazon-eks-pod-identity-simplifies-iam-permissions-for-applications-on-amazon-eks-clusters/), released on November 26, 2023.\n- üîë [Find hardcoded AWS credentials in K8s resources](https://github.com/DataDog/managed-kubernetes-auditing-toolkit#find-hardcoded-aws-credentials-in-k8s-resources).\n- üíÄ [Test if pods can access the AWS Instance Metadata Service (IMDS)](https://github.com/DataDog/managed-kubernetes-auditing-toolkit?tab=readme-ov-file#test-if-pods-can-access-the-aws-instance-metadata-service-imds).\n\nFor more details, visit the [official MKAT documentation](https://github.com/DataDog/managed-kubernetes-auditing-toolkit).\n\n## üöÄ Installation and Setup\n\nTo install and set up the Managed Kubernetes Auditing Toolkit (MKAT), follow these steps:\n\n1. **Add the MKAT Homebrew Tap:**\n    ```sh\n    brew tap datadog/mkat https://github.com/datadog/managed-kubernetes-auditing-toolkit\n    ```\n\n2. **Install MKAT:**\n    ```sh\n    brew install datadog/mkat/managed-kubernetes-auditing-toolkit\n    ```\n\n3. **Check the Installed MKAT Version:**\n    ```sh\n    mkat version\n    ```\n\nAlternatively, you can use a pre-compiled binary for installation. After installation, ensure that you are authenticated against your cluster and to AWS, as MKAT uses your current AWS and `kubectl` authentication contexts.\n\n## üîç Practical Usage of MKAT\n\n### Analyzing Role Relationships\n\nRunning `mkat eks find-role-relationships` will analyze your Kubernetes service accounts and the trust policy of IAM roles in your AWS account, then output a summary of which Kubernetes workload can assume AWS roles.\n\n![mkat](./mkat.png)\n\nMKAT works by analyzing both the IAM roles in the AWS account and the K8s service accounts in the cluster, and then matching them together based on these two mechanisms.\n\n```sh\n$ mkat eks find-role-relationships\n _ __ ___   | | __   __ _  | |_\n | '_ ` _ \\  | |/ /  / _` | | __|\n | | | | | | |   <  | (_| | | |_\n |_| |_| |_| |_|\\_\\  \\__,_|  \\__|\n\n2023/11/28 21:05:59 Connected to EKS cluster mkat-cluster\n2023/11/28 21:05:59 Retrieving cluster information\n2023/11/28 21:06:00 Listing K8s service accounts in all namespaces\n2023/11/28 21:06:02 Listing roles in the AWS account\n2023/11/28 21:06:03 Found 286 IAM roles in the AWS account\n2023/11/28 21:06:03 Analyzing IAM Roles For Service Accounts (IRSA) configuration\n2023/11/28 21:06:03 Analyzing Pod Identity configuration of your cluster\n2023/11/28 21:06:04 Analyzing namespace microservices which has 1 Pod Identity associations\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n| NAMESPACE        | SERVICE ACCOUNT           | POD                               | ASSUMABLE ROLE              | MECHANISM                      |\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n| microservices    | inventory-service-sa      | inventory-service                 | inventory-service-role      | IAM Roles for Service Accounts |\n|                  |                           |                                   | s3-backup-role              | IAM Roles for Service Accounts |\n|                  | rate-limiter-sa           | rate-limiter-1                    | rate-limiter-role           | IAM Roles for Service Accounts |\n|                  |                           |                                   | webserver-role              | Pod Identity                   |\n|                  |                           | rate-limiter-2                    | rate-limiter-role           | IAM Roles for Service Accounts |\n|                  |                           |                                   | webserver-role              | Pod Identity                   |\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n| default          | vulnerable-application-sa | vulnerable-application            | vulnerable-application-role | IAM Roles for Service Accounts |\n|                  | webserver-sa              | webserver                         | webserver-role              | IAM Roles for Service Accounts |\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n| external-secrets | external-secrets-sa       | external-secrets-66cfb84c9b-kldt9 | ExternalSecretsRole         | IAM Roles for Service Accounts |\n+------------------+---------------------------+-----------------------------------+-----------------------------+--------------------------------+\n```\n\n### Identifying Hardcoded AWS Access Keys\n\nMKAT can also identify hardcoded AWS access keys in the definition of Kubernetes ConfigMaps, Secrets, and Pods, with minimal false positives.\n\n```sh\n$ mkat eks find-secrets\n                  _              _\n  _ __ ___   | | __   __ _  | |_\n | '_ ` _ \\  | |/ /  / _` | | __|\n | | | | | | |   <  | (_| | | |_\n |_| |_| |_| |_|\\_\\  \\__,_|  \\__|\n\n2023/04/12 21:56:19 Connected to EKS cluster mkat-cluster\n2023/04/12 21:56:19 Searching for AWS secrets in ConfigMaps...\n2023/04/12 21:56:19 Analyzing 10 ConfigMaps...\n2023/04/12 21:56:19 Searching for AWS secrets in Secrets...\n2023/04/12 21:56:19 Analyzing 45 Secrets...\n2023/04/12 21:56:19 Searching for AWS secrets in Pod definitions...\n2023/04/12 21:56:19 Analyzing 8 Pod definitions...\n+-----------+--------+-----------------------------------------+------------------------------------------+\n| NAMESPACE | TYPE   | NAME                                    | VALUE                                    |\n+-----------+--------+-----------------------------------------+------------------------------------------+\n| default   | Secret | kafka-proxy-aws (aws access key) | XXXXXXXXXXXXXXXXXXXX                     |\n| default   | Secret | kafka-proxy-aws (aws secret)    | XXXXXXXX/XXCAXXXXXXXXXqEPXX+XXX/XXXXXXXX |\n+-----------+--------+-----------------------------------------+------------------------------------------+\n```\n\n### Validating IMDS Access\n\nFinally, you can use MKAT to validate that you properly blocked pod access to the IMDS:\n\n```sh\n$ mkat eks test-imds-access\n                  _              _\n  _ __ ___   | | __   __ _  | |_\n | '_ ` _ \\  | |/ /  / _` | | __|\n | | | | | | |   <  | (_| | | |_\n |_| |_| |_| |_|\\_\\  \\__,_|  \\__|\n\n2023/04/12 21:56:19 Connected to EKS cluster mkat-cluster\n2023/04/12 21:56:19 Testing if IMDSv1 and IMDSv2 are accessible from pods by creating a pod that attempts to access it\n2023/04/12 21:56:23 IMDSv2 is accessible: any pod can retrieve credentials for the AWS role eksctl-mkat-cluster-nodegroup-ng-NodeInstanceRole-AXWUFF35602Z\n2023/04/12 21:56:23 IMDSv1 is not accessible to pods in your cluster: able to establish a network connection to the IMDS, but no credentials were returned\n```\n\n## üîÑ Comparison with Other Tools\n\n| **Tool** | **Description** |\n|:---:|:---:|\n| [kube-bench](https://github.com/aquasecurity/kube-bench) | kube-bench is a general-purpose auditing tool for Kubernetes cluster, checking for compliance against the CIS benchmarks. |\n| [kubiscan](https://github.com/cyberark/KubiScan) | kubiscan focuses on identifying dangerous in-cluster RBAC permissions. |\n| [peirates](https://github.com/inguardians/peirates) | peirates is a generic Kubernetes penetration testing tool. Although it has a `get-aws-token` command that retrieves node credentials from the IMDS, it is not specific to managed K8s environments. |\n| [botb](https://github.com/brompwnie/botb) | botb is a generic Kubernetes penetration testing tool. It also has a command to retrieve node credentials from the IMDS, but it is not specific to managed K8s environments. |\n| [rbac-police](https://github.com/PaloAltoNetworks/rbac-police) | rbac-police focuses on identifying in-cluster RBAC relationships. |\n| [kdigger](https://github.com/quarkslab/kdigger) | kdigger is a general-purpose context discovery tool for Kubernetes penetration testing. It does not attempt to be specific to managed K8s environments. |\n| [kubeletmein](https://github.com/4ARMED/kubeletmein) | kubeletmein _is_ specific to managed K8s environments. It's a utility to generate a kubeconfig file using the node's IAM credentials, to then use it in a compromised pod. |\n| [hardeneks](https://github.com/aws-samples/hardeneks) | hardeneks _is_ specific to managed K8s environments, but only for EKS. It identifies issues and lack of best practices inside of the cluster, and does not focus on cluster to cloud pivots. |\n\n## üèÅ Conclusion\n\nIn conclusion, MKAT is a valuable tool for enhancing security in managed Kubernetes environments. It provides a comprehensive set of audits that can help identify and remediate common security risks. MKAT is easy to use and can be integrated into your existing security workflows. Additionally, MKAT is open source and free to use. If you are responsible for securing a managed Kubernetes environment, I encourage you to give MKAT a try.\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n\n<br><br>\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":744},"frontmatter":{"id":"0f34df281fa7fd233ea0ec11","path":"/blog/datadog-mkat-kubernetes-security/","humanDate":"Oct 21, 2024","fullDate":"2024-10-21","title":"Introducing MKAT: The Managed Kubernetes Auditing Toolkit from DataDog üõ°Ô∏è","keywords":["MKAT","DataDog","Kubernetes Security","Auditing"],"excerpt":"Discover MKAT, the Managed Kubernetes Auditing Toolkit from DataDog. Learn how this powerful tool enhances security and compliance in your Kubernetes environments.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEz0lEQVR42gHEBDv7AAcUHgsdKA4hLg8kMxMqOhkzRR8+USZLXy1YbjNjejdnfjRhdy1WbCRHXBw5SxUvPxAmNQ0fLQoaJgcXIwAOEygWIDMTLDoZNkYjRlkwXHJAdYxRkKZcn7NXkaFWjp5en7NZm7FKhp05bYIqUmcePU8UKzsOIzEMGCUAHixKM0BnJUJUMFxxPnWMV5mubLPHcbjIPUlJMCgjHBEMWYeQgM7ecbnKYqq9TYugNGJ5IENWM1ZnFxorACErSC9DbDVWY2Sfs1+kuXrC04LL2o3b6zZISSsjHwsFA2aYoJTi8YTN2n7I1m62yE+QpUZ2i0xmhBAUIgAjIEElNVgzVmFxtMR/wtKJ0+KW3+2KwcpYeYQ/YHUVIisyOjmVzNSb5PCM1OGBy9p5wM9ThptIYoQNEh4APiFNWCFkM09fYqKzgMDPneDul9XieZidlr3Nm7W7f1xGPhwMg4h/uPj/lNzok9nmgMTTQX6ON151HRQrAAg0NhpKWDlGXHx3pnm1yKTj7Y23vrLj6oqxu8nDtbR8VaV9YbvX2Lvy+abo85/g7nS+y0lvhk5GcxQWIQAFJCUAOi4hQktPkp2GqLGg092OpaeLv8iurZ99bmKFbVfPrYrc//+98Paw7feb3Op4tsI+cH0sXG8MERQANA47SStiLlNgb2JUjW9WgJebxPT3zertejoxRDw2UUs/fCkYysvLwv//rur1mdvlX7nJKnyLI1tlHhAkACcaOlpmmTdoeUE3OmZORn+6xs/19MSCfEoBATo2NEhLSE4KC7tiVtPc1Lv3/p7l8GO0wEFbeUgvZhYSHwACIB4AQjgKLztDaW2LqKV5y9iqYl1zEgxWBwVpbXJ3hIlfCwpxCQCtSTjF8PCe6fNeusMkYGsYRVEJDg8ABBUZARgYDy02VGFbZWJgcUdQZw8MKwIDOwAAUSwwTjM2TAYEQywuZgUAr4mHet7qSqiwG1tgEUdKCQoPAAsgIAolHhczOhxCQSAAAEQDChgAASUDATkDAi0DAiwBAUIJBjEUFC0AAIImJV24wTmTmxdJTxI/RAkNEQACExYADwsQJCsOSUgKAAAhKi9yq7IvLC0oAAAiBAQuBQM3AAAmFBVGW11GAAA/aW4vjZQRPUQMOj8HCg4AAhMXABQSDyIqE1FVD0BDPZWcnfL/VXiCCQAAIgkJLQ4NIQAAP0lMleHrHQ8RIBkZKH+GE1JbEUpPBgkRAAMeIwEkJQ4lLxdYYCFibT57iXfL2liUpAUAABgDAyAHCBcAADtSWXXX5CYXFiceIjZ3hxhPXBRFTwcTHwAIIywGJS0PIi8jRlQoR1c7antiuslKg5cLAAMWBgYcAgUXAAAvOkFlmpxVPjE4dnw+d4oiQVEXMT8JGigACRomCBgkECEuIjtKJ0lZNmd3U6e2OWJ3AwAADwcJFwgJFQMGFwEDQzAqRWttLGl0OHGCI0NSGS89DBwpAAsXIw4bKBQmMyFATSpOXjRmdkaRoyY9TwIAAAsJCw8ICw8CBQwAAA0bHythax08RDZvgSdLWRw2QxEiLwATJDAYKzccNEIlR1YuV2c0ZXc5d4oTIi0CAAEHBgkKBwoLAQUGAQMDBggxancaO0EvXW4tVWYhP00XLDlnA5GgPDEwqgAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/44502cc7402cf803917a9330e54145ad/ccc41/mkat-cover.png","srcSet":"/static/44502cc7402cf803917a9330e54145ad/ccc41/mkat-cover.png 512w","sizes":"100vw"},"sources":[{"srcSet":"/static/44502cc7402cf803917a9330e54145ad/d689f/mkat-cover.webp 512w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/monitoring-coredns-dns-performance/","title":"Everything You Need to Know About Monitoring CoreDNS for DNS Performance","date":"2024-10-21 22:22:00"},"excerpt":"üìö Introduction Running DNS-intensive workloads can sometimes lead to intermittent CoreDNS failures caused by DNS throttling. These issues‚Ä¶","html":"<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìö Introduction</h2>\n<p>Running DNS-intensive workloads can sometimes lead to intermittent <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#coredns\" target=\"_blank\" rel=\"noopener noreferrer\">CoreDNS</a> failures caused by DNS throttling. These issues can have a significant impact on your applications.</p>\n<p>Such disruptions can hinder the reliability and performance of your services, making it mandatory to have a monitoring solution in place. AWS offers a suite of open-source tools‚Ää‚Äî‚Ää<a href=\"https://aws.amazon.com/cloudwatch/\" target=\"_blank\" rel=\"noopener noreferrer\">CloudWatch</a>, <a href=\"https://www.fluentd.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Fluentd</a>, and <a href=\"https://grafana.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Grafana</a>‚Ää‚Äî‚Ääthat can be integrated to monitor CoreDNS.</p>\n<h2 id=\"-introduction-to-kubernetes-dns\" style=\"position:relative;\"><a href=\"#-introduction-to-kubernetes-dns\" aria-label=\" introduction to kubernetes dns permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üß© Introduction to Kubernetes DNS</h2>\n<p>Kubernetes relies on <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#introduction\" target=\"_blank\" rel=\"noopener noreferrer\">DNS</a> for service discovery within clusters. When applications running in pods need to communicate with each other, they often refer to services by their domain names rather than IP addresses.</p>\n<p>This is where Kubernetes DNS comes into play. It ensures that these domain names are resolved to the correct IP addresses, allowing pods and services to communicate.</p>\n<p>In Kubernetes, each pod is assigned a temporary IP address. However, these IP addresses are dynamic and can change over time, making it challenging for applications to keep track of them. Kubernetes addresses this challenge by assigning fully qualified domain names (<a href=\"https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#dns-records\" target=\"_blank\" rel=\"noopener noreferrer\">FQDNs</a>) to pods and services.</p>\n<p>CoreDNS, the default DNS provider in Kubernetes, is responsible for handling DNS queries within the cluster. It maps these FQDNs to the corresponding IP addresses, enabling communication between pods and services.</p>\n<h2 id=\"Ô∏è-coredns-in-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-coredns-in-kubernetes\" aria-label=\"Ô∏è coredns in kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è CoreDNS in Kubernetes</h2>\n<p>CoreDNS plays an important role in providing DNS services within Kubernetes clusters. As the default DNS provider since Kubernetes v1.13, CoreDNS simplifies cluster networking by enabling clients to access services using DNS names rather than IP addresses. It resolves domain name requests and facilitates service discovery within the cluster.</p>\n<h3 id=\"Ô∏è-how-coredns-operates\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-how-coredns-operates\" aria-label=\"Ô∏è how coredns operates permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚öôÔ∏è How CoreDNS Operates</h3>\n<p>CoreDNS operates as a resolver and forwarder for DNS requests within Kubernetes clusters. When a pod needs to communicate with another service, it sends a DNS query to CoreDNS, specifying the domain name of the target service. CoreDNS then resolves this query by mapping the domain name to the corresponding IP address using its internal records.</p>\n<p>For external domain names that CoreDNS is not authoritative for, it forwards the DNS query to public resolvers or upstream DNS servers for resolution.</p>\n<p>To enhance performance and reduce latency, CoreDNS can cache DNS responses for frequently accessed domain names. This caching mechanism improves the responsiveness of DNS queries and reduces the load on upstream DNS servers.</p>\n<p>CoreDNS achieves this functionality through its modular architecture and extensible plugin system, allowing operators to customize and optimize DNS resolution according to their specific requirements.</p>\n<h2 id=\"-mitigating-coredns-throttling-in-amazon-eks\" style=\"position:relative;\"><a href=\"#-mitigating-coredns-throttling-in-amazon-eks\" aria-label=\" mitigating coredns throttling in amazon eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Mitigating CoreDNS Throttling in Amazon EKS</h2>\n<p>In Amazon EKS clusters, CoreDNS and DNS throttling issues can be challenging to identify and troubleshoot. While many users focus on monitoring CoreDNS logs and metrics, they often overlook the hard limit of 1024 <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html#vpc-dns-limits\" target=\"_blank\" rel=\"noopener noreferrer\">packets per second (PPS)</a> enforced at the Elastic Network Interface (ENI) level. Understanding how this limit can lead to throttling issues requires insight into the typical DNS resolution flow of a Kubernetes pod.</p>\n<p>In a Kubernetes environment, pods must resolve domain names for both internal and external services to enable communication. This resolution process involves routing DNS queries through the worker node's ENI, particularly when resolving external endpoints. Even for internal endpoints, if the CoreDNS pod is not co-located with the querying pod, DNS packets still traverse the worker node's ENI.</p>\n<p>Consider a scenario where there is a sudden surge in DNS queries, causing the PPS to approach the hard limit of 1024. This situation can result in DNS throttling, impacting all microservices running on the affected worker node. Unfortunately, troubleshooting such issues can be hard because the focus tends to be on CoreDNS pods rather than ENI metrics.</p>\n<p>To mitigate DNS throttling issues in EKS clusters, it is important to monitor packet drops occurring at the ENI level continuously. This monitoring allows for early detection and prevention of potential outages. In this blog post, we introduce a solution that leverages network performance metrics to identify DNS throttling issues effectively.</p>\n<h3 id=\"Ô∏è-solution\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-solution\" aria-label=\"Ô∏è solution permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ°Ô∏è Solution</h3>\n<p>An easy way to identify the DNS throttling issues in worker nodes is by capturing the <code class=\"language-text\">linklocal_allowance_exceeded</code> metric provided by the Elastic Network Adapter (ENA) driver and other metrics as well.</p>\n<p>The <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/metrics-collected-by-CloudWatch-agent.html#linux-metrics-enabled-by-CloudWatch-agent\" target=\"_blank\" rel=\"noopener noreferrer\"><code class=\"language-text\">linklocal_allowance_exceeded</code></a> metric indicates the number of packets dropped because the PPS of the traffic to local proxy services exceeded the maximum for the network interface. This impacts traffic to the DNS service, the Instance Metadata Service, and the Amazon Time Sync Service.</p>\n<p>Instead of tracking this event in real-time, we can stream this metric to <a href=\"https://aws.amazon.com/prometheus/\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon Managed Service for Prometheus</a> and visualize it in <a href=\"https://aws.amazon.com/grafana/\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon Managed Grafana</a>.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 581px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 77.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB7k1C6hn/xAAaEAACAgMAAAAAAAAAAAAAAAAAAQISESEx/9oACAEBAAEFAuF1YztpOR//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAcEAABAwUAAAAAAAAAAAAAAAARABBBAQISIVH/2gAIAQEABj8CCxlhtCtscb//xAAbEAACAwADAAAAAAAAAAAAAAABEQAQITFBcf/aAAgBAQABPyEIBAPvwdHFPSyGzD0e1f/aAAwDAQACAAMAAAAQ89//xAAWEQEBAQAAAAAAAAAAAAAAAAABEEH/2gAIAQMBAT8QA2f/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAADAQADAQAAAAAAAAAAAAABESEAEDFxUf/aAAgBAQABPxAggtIU3EoRYEUveLazKQX07xkhA0nupv/Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"adot\" title=\"\" src=\"/static/9c0e9af412476642f6bdb554799934fd/f0d01/adot.jpg\" srcset=\"/static/9c0e9af412476642f6bdb554799934fd/651be/adot.jpg 170w,\n/static/9c0e9af412476642f6bdb554799934fd/d30a3/adot.jpg 340w,\n/static/9c0e9af412476642f6bdb554799934fd/f0d01/adot.jpg 581w\" sizes=\"(max-width: 581px) 100vw, 581px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"Ô∏è-hands-on-collect-and-visualize-coredns-metrics-in-aws-eks\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-hands-on-collect-and-visualize-coredns-metrics-in-aws-eks\" aria-label=\"Ô∏è hands on collect and visualize coredns metrics in aws eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Hands-on: Collect and Visualize CoreDNS Metrics in AWS EKS</h2>\n<h3 id=\"-coredns-prometheus-plugin\" style=\"position:relative;\"><a href=\"#-coredns-prometheus-plugin\" aria-label=\" coredns prometheus plugin permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìä CoreDNS Prometheus Plugin</h3>\n<p>The <a href=\"https://coredns.io/plugins/metrics/\" target=\"_blank\" rel=\"noopener noreferrer\">CoreDNS Prometheus plugin</a> exposes metrics in the <a href=\"https://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md\" target=\"_blank\" rel=\"noopener noreferrer\">OpenMetrics</a> format, a text-based standard that evolved from the <a href=\"https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format\" target=\"_blank\" rel=\"noopener noreferrer\">Prometheus format</a>. In a Kubernetes cluster, the plugin is enabled by default, so you can begin monitoring <a href=\"https://www.datadoghq.com/blog/coredns-metrics\" target=\"_blank\" rel=\"noopener noreferrer\">many key metrics</a> as soon as you launch your cluster.</p>\n<p>By default, the Prometheus plugin writes metrics to a <code class=\"language-text\">/metrics</code> endpoint on port <code class=\"language-text\">9153</code> on each CoreDNS pod.</p>\n<h3 id=\"Ô∏è-create-an-amazon-managed-service-for-prometheus-workspace-and-managed-service-for-grafana\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-create-an-amazon-managed-service-for-prometheus-workspace-and-managed-service-for-grafana\" aria-label=\"Ô∏è create an amazon managed service for prometheus workspace and managed service for grafana permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèóÔ∏è Create an Amazon Managed Service for Prometheus Workspace and Managed Service for Grafana</h3>\n<p>In this step, we will create a workspace for Amazon Managed Service for Prometheus and Managed Service for Grafana. The configuration in these files creates:</p>\n<ul>\n<li>AMP workspace</li>\n<li>AMP alert manager definition</li>\n</ul>\n<h4 id=\"code-classlanguage-textmaintfcode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textmaintfcode\" aria-label=\"code classlanguage textmaintfcode permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><code class=\"language-text\">main.tf</code></h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">module<span class=\"token type variable\"> \"prometheus\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-aws-modules/managed-service-prometheus/aws\"</span>\n\n    <span class=\"token property\">workspace_alias</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"demo-coredns\"</span>\n\n    <span class=\"token property\">alert_manager_definition</span> <span class=\"token punctuation\">=</span> <span class=\"token heredoc string\">&lt;&lt;-EOT\n    alertmanager_config: |\n        route:\n            receiver: 'default'\n        receivers:\n            - name: 'default'\n    EOT</span>\n\n    <span class=\"token property\">rule_group_namespaces</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"code-classlanguage-textversionstfcode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textversionstfcode\" aria-label=\"code classlanguage textversionstfcode permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><code class=\"language-text\">versions.tf</code></h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">required_version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 1.3\"</span>\n\n    <span class=\"token keyword\">required_providers</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">aws</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"hashicorp/aws\"</span>\n            <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 5.32\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To run the Terraform code, execute:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># terraform init</span>\n<span class=\"token comment\"># terraform plan</span>\n<span class=\"token comment\"># terraform apply</span></code></pre></div>\n<h3 id=\"Ô∏è-create-a-default-grafana-workspace\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-create-a-default-grafana-workspace\" aria-label=\"Ô∏è create a default grafana workspace permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üñ•Ô∏è Create a Default Grafana Workspace</h3>\n<p>The below configuration files will create a default Grafana workspace using defaults provided by the module.</p>\n<h4 id=\"code-classlanguage-textmaintfcode-1\" style=\"position:relative;\"><a href=\"#code-classlanguage-textmaintfcode-1\" aria-label=\"code classlanguage textmaintfcode 1 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><code class=\"language-text\">main.tf</code></h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"aws\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">region</span> <span class=\"token punctuation\">=</span> local.region\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data <span class=\"token type variable\">\"aws_availability_zones\"</span></span> <span class=\"token string\">\"available\"</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">locals</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">region</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"eu-west-1\"</span>\n    <span class=\"token property\">name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"amg-ex-<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">path</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">cwd</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"_\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"AWS Managed Grafana service for <span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">name</span><span class=\"token punctuation\">}</span></span>\"</span>\n\n    <span class=\"token property\">vpc_cidr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"10.0.0.0/16\"</span>\n    <span class=\"token property\">azs</span>      <span class=\"token punctuation\">=</span> slice(data.aws_availability_zones.available.names, <span class=\"token number\">0</span>, <span class=\"token number\">3</span>)\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"managed_grafana\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-aws-modules/managed-service-grafana/aws\"</span>\n\n    <span class=\"token property\">name</span>                      <span class=\"token punctuation\">=</span> local.name\n    <span class=\"token property\">associate_license</span>         <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token property\">description</span>               <span class=\"token punctuation\">=</span> local.description\n    <span class=\"token property\">account_access_type</span>       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"CURRENT_ACCOUNT\"</span>\n    <span class=\"token property\">authentication_providers</span>  <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"AWS_SSO\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token property\">permission_type</span>           <span class=\"token punctuation\">=</span> <span class=\"token string\">\"SERVICE_MANAGED\"</span>\n    <span class=\"token property\">data_sources</span>              <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CLOUDWATCH\"</span>, <span class=\"token string\">\"PROMETHEUS\"</span>, <span class=\"token string\">\"XRAY\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token property\">notification_destinations</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"SNS\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token property\">stack_set_name</span>            <span class=\"token punctuation\">=</span> local.name\n    <span class=\"token property\">grafana_version</span>           <span class=\"token punctuation\">=</span> <span class=\"token string\">\"9.4\"</span>\n\n    <span class=\"token property\">configuration</span> <span class=\"token punctuation\">=</span> jsonencode(<span class=\"token punctuation\">{</span>\n        <span class=\"token property\">unifiedAlerting</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">enabled</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token property\">plugins</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">pluginAdminEnabled</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>)\n\n    <span class=\"token property\">vpc_configuration</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">subnet_ids</span> <span class=\"token punctuation\">=</span> module.vpc.private_subnets\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token property\">security_group_rules</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">egress_postgresql</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow egress to PostgreSQL\"</span>\n            <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">5432</span>\n            <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">5432</span>\n            <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n            <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> module.vpc.private_subnets_cidr_blocks\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token property\">workspace_api_keys</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">viewer</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">key_name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"viewer\"</span>\n            <span class=\"token property\">key_role</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"VIEWER\"</span>\n            <span class=\"token property\">seconds_to_live</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">3600</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token property\">editor</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">key_name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"editor\"</span>\n            <span class=\"token property\">key_role</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"EDITOR\"</span>\n            <span class=\"token property\">seconds_to_live</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">3600</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token property\">admin</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">key_name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"admin\"</span>\n            <span class=\"token property\">key_role</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ADMIN\"</span>\n            <span class=\"token property\">seconds_to_live</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">3600</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token property\">create_iam_role</span>                <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token property\">iam_role_name</span>                  <span class=\"token punctuation\">=</span> local.name\n    <span class=\"token property\">use_iam_role_name_prefix</span>       <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token property\">iam_role_description</span>           <span class=\"token punctuation\">=</span> local.description\n    <span class=\"token property\">iam_role_path</span>                  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"/grafana/\"</span>\n    <span class=\"token property\">iam_role_force_detach_policies</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token property\">iam_role_max_session_duration</span>  <span class=\"token punctuation\">=</span> <span class=\"token number\">7200</span>\n    <span class=\"token property\">iam_role_tags</span>                  <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">role</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> local.tags\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"managed_grafana_default\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-aws-modules/managed-service-grafana/aws\"</span>\n\n    <span class=\"token property\">name</span>              <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">name</span><span class=\"token punctuation\">}</span></span>-default\"</span>\n    <span class=\"token property\">associate_license</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\n\n    <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> local.tags\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"managed_grafana_disabled\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-aws-modules/managed-service-grafana/aws\"</span>\n\n    <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> local.name\n    <span class=\"token property\">create</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"vpc\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-aws-modules/vpc/aws\"</span>\n    <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"~> 5.0\"</span>\n\n    <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> local.name\n    <span class=\"token property\">cidr</span> <span class=\"token punctuation\">=</span> local.vpc_cidr\n\n    <span class=\"token property\">azs</span>             <span class=\"token punctuation\">=</span> local.azs\n    <span class=\"token property\">private_subnets</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>for k, v in local.azs : cidrsubnet(local.vpc_cidr, <span class=\"token number\">4</span>, k)<span class=\"token punctuation\">]</span>\n    <span class=\"token property\">public_subnets</span>  <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>for k, v in local.azs : cidrsubnet(local.vpc_cidr, <span class=\"token number\">8</span>, k + <span class=\"token number\">48</span>)<span class=\"token punctuation\">]</span>\n\n    <span class=\"token property\">enable_nat_gateway</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span> \n    <span class=\"token property\">single_nat_gateway</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n    <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> local.tags\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"versionstf\" style=\"position:relative;\"><a href=\"#versionstf\" aria-label=\"versionstf permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>versions.tf</h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">required_version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 1.0\"</span>\n\n    <span class=\"token keyword\">required_providers</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">aws</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"hashicorp/aws\"</span>\n            <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 5.0\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To run this code, execute:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># terraform init</span>\n<span class=\"token comment\"># terraform plan</span>\n<span class=\"token comment\"># terraform apply</span></code></pre></div>\n<h3 id=\"-deploying-prometheus-ethtool-exporter\" style=\"position:relative;\"><a href=\"#-deploying-prometheus-ethtool-exporter\" aria-label=\" deploying prometheus ethtool exporter permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Deploying Prometheus Ethtool Exporter</h3>\n<p><a href=\"https://linux.die.net/man/8/ethtool\" target=\"_blank\" rel=\"noopener noreferrer\">Ethtool</a> is a Linux tool for configuring and gathering information about Ethernet devices on worker nodes. We will use ethtool's output to detect packet loss and convert it to Prometheus format with a Prometheus ethtool exporter utility.</p>\n<p>Deploy the exporter using:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kubectl apply <span class=\"token parameter variable\">-f</span> https://raw.githubusercontent.com/Showmax/prometheus-ethtool-exporter/master/deploy/k8s-daemonset.yaml</code></pre></div>\n<h3 id=\"-deploy-adot-collector-to-scrape-ethtool-metrics\" style=\"position:relative;\"><a href=\"#-deploy-adot-collector-to-scrape-ethtool-metrics\" aria-label=\" deploy adot collector to scrape ethtool metrics permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì¶ Deploy ADOT Collector to Scrape Ethtool Metrics</h3>\n<p>In this step, we will deploy the ADOT collector and configure it to ingest metrics to Amazon Managed Service for Prometheus. We will use the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/opentelemetry.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon EKS add-on for ADOT operator</a> to send the metrics <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/metrics-collected-by-CloudWatch-agent.html#linux-metrics-enabled-by-CloudWatch-agent\" target=\"_blank\" rel=\"noopener noreferrer\">linklocal_allowance_exceeded</a> to Amazon Managed Service for Prometheus for monitoring CoreDNS.</p>\n<h4 id=\"create-an-iam-role-and-amazon-eks-service-account\" style=\"position:relative;\"><a href=\"#create-an-iam-role-and-amazon-eks-service-account\" aria-label=\"create an iam role and amazon eks service account permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Create an IAM Role and Amazon EKS Service Account</h4>\n<p>We will deploy the ADOT collector to run under the identity of a Kubernetes <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/\" target=\"_blank\" rel=\"noopener noreferrer\">service account</a> <code class=\"language-text\">adot-collector</code>. <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html\" target=\"_blank\" rel=\"noopener noreferrer\">IAM roles for service accounts (IRSA)</a> let you associate the <code class=\"language-text\">AmazonPrometheusRemoteWriteAccess</code> role with a Kubernetes service account, thereby providing IAM permissions to any pod utilizing the service account to ingest the metrics to Amazon Managed Service for Prometheus.</p>\n<p>You need <code class=\"language-text\">kubectl</code> and <code class=\"language-text\">eksctl</code> CLI tools to run the script. They must be configured to access your Amazon EKS cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">eksctl create iamserviceaccount <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> adot-collector <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--namespace</span> default <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--region</span> eu-west-1 <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--cluster</span> coredns-monitoring-demo <span class=\"token punctuation\">\\</span>\n--attach-policy-arn arn:aws:iam::aws:policy/AmazonPrometheusRemoteWriteAccess <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--approve</span> <span class=\"token punctuation\">\\</span>\n--override-existing-serviceaccounts</code></pre></div>\n<h4 id=\"install-adot-add-on\" style=\"position:relative;\"><a href=\"#install-adot-add-on\" aria-label=\"install adot add on permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Install ADOT Add-on</h4>\n<p>You can check the list of add-ons enabled for different versions of Amazon EKS using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">aws eks describe-addon-versions --addon-name adot --kubernetes-version <span class=\"token number\">1.28</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--query</span> <span class=\"token string\">\"addons[].addonVersions[].[addonVersion, compatibilities[].defaultVersion]\"</span> <span class=\"token parameter variable\">--output</span> text</code></pre></div>\n<p>Run the following command to install the ADOT add-on, replacing the <code class=\"language-text\">--addon-version</code> flag based on your Amazon EKS cluster version as shown in the step above.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">aws eks create-addon --addon-name adot --addon-version v0.66.0-eksbuild.1 --cluster-name coredns-monitoring-demo</code></pre></div>\n<p>Verify that the ADOT add-on is ready using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kubectl get po <span class=\"token parameter variable\">-n</span> opentelemetry-operator-system</code></pre></div>\n<p>The following procedure uses an example YAML file with <code class=\"language-text\">deployment</code> as the mode value. This is the default mode and deploys the ADOT Collector similarly to a standalone application. This configuration receives OTLP metrics from the sample application and Amazon Managed Service for Prometheus metrics scraped from pods on the cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-o</span> collector-config-amp.yaml https://raw.githubusercontent.com/aws-observability/aws-otel-community/master/sample-configs/operator/collector-config-amp.yaml</code></pre></div>\n<p>In <code class=\"language-text\">collector-config-amp.yaml</code>, replace the following with your own values:</p>\n<ul>\n<li><code class=\"language-text\">mode: deployment</code></li>\n<li><code class=\"language-text\">serviceAccount: adot-collector</code></li>\n<li><code class=\"language-text\">endpoint: \"\"</code></li>\n<li><code class=\"language-text\">region: \"\"</code></li>\n<li><code class=\"language-text\">name: adot-collector</code></li>\n</ul>\n<p>Apply the configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">kubectl apply <span class=\"token parameter variable\">-f</span> collector-config-amp.yaml</code></pre></div>\n<p>Once the ADOT collector is deployed, the metrics will be stored successfully in Amazon Prometheus.</p>\n<h3 id=\"-visualize-ethtool-metrics-in-amazon-managed-grafana\" style=\"position:relative;\"><a href=\"#-visualize-ethtool-metrics-in-amazon-managed-grafana\" aria-label=\" visualize ethtool metrics in amazon managed grafana permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìà Visualize Ethtool Metrics in Amazon Managed Grafana</h3>\n<p>Configure the Amazon Managed Service for Prometheus workspace as a datasource inside the Amazon Managed Grafana console.</p>\n<p>Let's explore the metrics in Amazon Managed Grafana now: Click the explore button, and search for <code class=\"language-text\">ethtool</code>.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABM0lEQVR42n2R62rEIBCFfY1kc9NoVqNJ1Gwubrq9wkILpX2M/u37/+lJU7awlMKHzIye8YwS37aytkoarS0XNWV7yqqCVt/BBaSVVI1U7brq4f71M5w/SLzLGdd1MyQJjaIsirMkZWnG410RxfmfYCvNSggJTlfSKj1QbhhvANqr2opKs1KVXLFS5oXIcsABYih3CQWEMVEwJXVfCrNhmt40vu0G66auG5ybtvgn9bM2TqkO4xDBRFbwam8w8Aa2+8Ox7wOCTbPiJ3SxdkTR+xndV3Gel3ACkxcxGu1lC7jQeVHBJNxivQJPsz5YQX/FJZcuvEsTKBOY9h/wIyRJKV4PHpAAXOJ8WJancTqhI0xt9StwHpeT43Jn3TiH0zTfgHFaHh7Pzy9vp1vol634J4chfAEw0VZKqythQAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"apm\" title=\"\" src=\"/static/8073f7721006157bf3b6efc69fec4184/c5bb3/apm.png\" srcset=\"/static/8073f7721006157bf3b6efc69fec4184/04472/apm.png 170w,\n/static/8073f7721006157bf3b6efc69fec4184/9f933/apm.png 340w,\n/static/8073f7721006157bf3b6efc69fec4184/c5bb3/apm.png 680w,\n/static/8073f7721006157bf3b6efc69fec4184/b12f7/apm.png 1020w,\n/static/8073f7721006157bf3b6efc69fec4184/b5a09/apm.png 1360w,\n/static/8073f7721006157bf3b6efc69fec4184/07a9c/apm.png 1440w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Let's build a dashboard for the linklocal_allowance_exceeded metric by using the query</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">rate<span class=\"token punctuation\">(</span>node_net_ethtool<span class=\"token punctuation\">{</span>device<span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span>,type<span class=\"token operator\">=</span><span class=\"token string\">\"linklocal_allo\nwance_exceeded\"</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">[</span>30s<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA60lEQVR42p2S7WrFIAyGvYWdLzVqYqL2lLL92P3f3FLbHko7tjF4CMmL+SDRJCwe6HJ1bxd74Hrzh9C69OhYh7c7GOtxDoAOuJAjVbV7xUd+8fBoVHKRZ3vCfieuxKwtjfvhxa/JfaT/JgNKQIHEkKTDm88nca+IBTQsLUuLmh/JK4FgtVnxXYSdvjqR5s6Sa0iSaFAiFvX9tlVQG/puw+xDlAUNy/AesZrn9MnlWYZJ6khUWptqHdVHqpgby5N4YBmXui9UhMCmjR8yTHPhpAejkFiB7Xi9YQ9PH+GuYwctiWX5A8tt7Z+3/QUylUjr5daDMgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"result\" title=\"\" src=\"/static/65e84ae8ccc9fd90579aa4af904c0687/c5bb3/result.png\" srcset=\"/static/65e84ae8ccc9fd90579aa4af904c0687/04472/result.png 170w,\n/static/65e84ae8ccc9fd90579aa4af904c0687/9f933/result.png 340w,\n/static/65e84ae8ccc9fd90579aa4af904c0687/c5bb3/result.png 680w,\n/static/65e84ae8ccc9fd90579aa4af904c0687/b12f7/result.png 1020w,\n/static/65e84ae8ccc9fd90579aa4af904c0687/b5a09/result.png 1360w,\n/static/65e84ae8ccc9fd90579aa4af904c0687/07a9c/result.png 1440w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>We can see that there were no packets dropped as the value is zero. You can further extend this by configuring alerts in the alert manager in Amazon Managed Service for Prometheus to send notifications.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Conclusion</h2>\n<p>In this post, we showed how to monitor and create alerts for CoreDNS throttling issues using AWS Distro for OpenTelemetry (ADOT), Amazon Managed Service for Prometheus, and Amazon Managed Grafana. By monitoring the coreDNS metrics, customers can proactively detect packet drops and take preventive actions.</p>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://www.datadoghq.com/blog/coredns-monitoring-tools/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.datadoghq.com/blog/coredns-monitoring-tools/</a></li>\n<li><a href=\"https://cilium.io/blog/2019/12/18/how-to-debug-dns-issues-in-k8s/\" target=\"_blank\" rel=\"noopener noreferrer\">https://cilium.io/blog/2019/12/18/how-to-debug-dns-issues-in-k8s/</a></li>\n<li><a href=\"https://sysdig.com/blog/how-to-monitor-coredns/\" target=\"_blank\" rel=\"noopener noreferrer\">https://sysdig.com/blog/how-to-monitor-coredns/</a></li>\n<li><a href=\"https://www.datadoghq.com/blog/coredns-metrics/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.datadoghq.com/blog/coredns-metrics/</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/mt/monitoring-coredns-for-dns-throttling-issues-using-aws-open-source-monitoring-services/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/mt/monitoring-coredns-for-dns-throttling-issues-using-aws-open-source-monitoring-services/</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/kubernetes-probes/","title":"Understanding Kubernetes Probes: Better Apps Health Checks üåÅ","date":"2024-10-21 22:16:00"},"excerpt":"Guide to Liveness, Readiness, and Startup Probes¬†‚ôªÔ∏è üìå Introduction Kubernetes offers a feature called probes, which play an important role‚Ä¶","html":"<blockquote>\n<p><strong>Guide to Liveness, Readiness, and Startup Probes¬†‚ôªÔ∏è</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>Kubernetes offers a feature called <strong>probes</strong>, which play an important role in ensuring the health of applications running within its environment. These probes, categorized into <strong>liveness</strong>, <strong>readiness</strong>, and <strong>startup</strong>, enable Kubernetes to monitor the state of applications and take appropriate actions to maintain their optimal functioning.</p>\n<p>In this blog post, we will explore the significance of these probes in enhancing the self-healing capabilities of Kubernetes and providing a comprehensive understanding of how they work. We will explore each probe type, their specific purposes, and how they contribute to the overall resilience of containerized applications.</p>\n<p>üì¢ <strong>Announcement:</strong> I have just launched a <a href=\"https://github.com/seifrajhi/Kubernetes-practical-exercises-Hands-on\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub repository</a> dedicated to gathering resources, exercises, and labs to aid in learning Kubernetes from the ground up. This repository aims to provide practical exercises that guide users in deploying, managing, and scaling containerized applications using Kubernetes. Your feedback and contributions are welcomed to enhance and improve the learning experience. üéâ</p>\n<h3 id=\"-health-check\" style=\"position:relative;\"><a href=\"#-health-check\" aria-label=\" health check permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>ü©∫ Health Check</h3>\n<p>Health checks are a simple way to let the system know whether an instance of your app is working. If the instance of your app is not working, the other services should not access it or send requests to it. Instead, requests should be sent to another instance that is ready, or you should retry sending requests.</p>\n<p>The system should be able to bring your app to a healthy state. By default, Kubernetes will start sending traffic to the pod when all the containers inside the pod have started. Kubernetes will restart containers when they crash. This default behavior should be enough to get started. Making deployments more robust becomes relatively straightforward as Kubernetes helps create custom health checks.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBElEQVR42mNggIL///8zQmme0nnv+tMmvblRu+htGQOZgBFKcwZlze9oWvP//5azf//nz/ny1yW0JJUcA5mgtJV3Yu/suhX//qw7+e9/6YIfH00dIrqB4kpo6og20FZciMG8d8v/8tS+R+cn7fgfDhTzYGBg00QOFlK8LAbEWatCGZhBHDkGBkGgXdlAJrOYmJiSjIyMNJp6ogw1YGJiARrClMPAxJrKxsumDhRzMDc3P+3h4dEJUhAaGspMqktFgDgCyjYBBQXQMD5TU1NhUlyIDPiA2BvKtgZibXINYkQy0AfKtkAykIncdMkJxOFQtisQa5DrQmRNoLCLB2I/UCwTqxsA0GRCeCiQqZEAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Health Check\" title=\"\" src=\"/static/a107dd01a3f6b16ead22747d73e508d8/c5bb3/check.png\" srcset=\"/static/a107dd01a3f6b16ead22747d73e508d8/04472/check.png 170w,\n/static/a107dd01a3f6b16ead22747d73e508d8/9f933/check.png 340w,\n/static/a107dd01a3f6b16ead22747d73e508d8/c5bb3/check.png 680w,\n/static/a107dd01a3f6b16ead22747d73e508d8/b12f7/check.png 1020w,\n/static/a107dd01a3f6b16ead22747d73e508d8/78797/check.png 1125w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-kubernetes-probes\" style=\"position:relative;\"><a href=\"#-kubernetes-probes\" aria-label=\" kubernetes probes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Kubernetes Probes</h2>\n<p><a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes probes</a> are a mechanism for providing the Kubernetes control plane with information about the internal state of your applications. They let your cluster identify running pods that are in an unhealthy state. Probes are kubelet's answer to the health checks, and there are three handlers:</p>\n<ul>\n<li><strong>ExecAction</strong>: Command execution check. If the command's exit status is 0, it is considered a success.</li>\n<li><strong>TCPSocketAction</strong>: TCP check to determine if the port is open. If open, it is considered a success.</li>\n<li><strong>HTTPGetAction</strong>: HTTP check to determine if the status code is equal to or above 200 and below 400.</li>\n</ul>\n<p>Each type of probe has common configurable fields:</p>\n<ul>\n<li><code class=\"language-text\">initialDelaySeconds</code>: Probes start running after <code class=\"language-text\">initialDelaySeconds</code> after the container is started (default: 0).</li>\n<li><code class=\"language-text\">periodSeconds</code>: How often the probe should run (default: 10).</li>\n<li><code class=\"language-text\">timeoutSeconds</code>: Probe timeout (default: 1).</li>\n<li><code class=\"language-text\">successThreshold</code>: Required number of successful probes to mark the container healthy/ready (default: 1).</li>\n<li><code class=\"language-text\">failureThreshold</code>: When a probe fails, it will try <code class=\"language-text\">failureThreshold</code> times before deeming unhealthy/not ready (default: 3).</li>\n</ul>\n<p>These parameters need to be configured per your application's spec.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 164.7058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAIAAABWXBxEAAAACXBIWXMAAAsTAAALEwEAmpwYAAADfElEQVR42pVVSW/TQBTuD0ScEAfEBS4ckECckBASXCoQUA5UXMqJpSwREodWalXSIgSlpW1Kq7bZ6jVx7Hi349hxFjt89qTOQlKRF8WyZ+Z775v3vjcz0z2zMAyT5+BgEATdCTaDP6ZVVWUYplAoVCoVnudzuVy1Wm02m7Zt12q1EY9DYM/zBEEQRREwwzDgiOO4Smxw4ThOp9OZCE4YttvtkWkSeRLzmWSfQCIIIWKaJt5d1wWL/4qMFfV6HS946rouy9V8PiuKFbiYAkyIuK7PcBVFUTE4FTgAutkwPOVbVcjVHDeYCtwJulp+vrB2gdu5j5ydl7ARcDemrVFv+R9X2MycXXPOA5O5BIxU67qBX5XPaKro1N1m028PWKvVIpAILEmS7/v4JmAIS1EUSRKFSCMSaKuqBkPZLMvCC2bJyggMbbEs68WGTzhCqazITFmWgcE4XJOYg1KNwFgBPSZgFBbMMUhRFEghMlzTNI0YCIvdhbH1wKQrgCFgMmE7DsdzsqKYlknRpzRDYTtjEoYGKJVKjUbjLNs9qTdaHcs0dE2vu/UgDDA+0l69PRMNogei5Mcrthnl2Ubh65HAlLPvdmeXswue7xKniYvenkE72XMcN1jMlG6nfr/cYDappXtfLs6uXhWMIpHQUGRkBQkDbcQHc8u2vbpzxAip/dIBLZZFKpV5vnr8Gq0OasgfykDU3ksYkkkSBjB6EFxKPO/alqqiqIqp2qZWAzuUEAvgog9GDbF6kDYSCxKyYWFclMQ9Nl2U97vhZG1DAyTbnVh6u5z+4iebPpIyTPrh0uW59RsVg42Wddqk1EMnSb8x4qHFjHDzw9b8evGQ23yavr6wdbdUpVVFUyF3UcTOhyKDvBmbpuuo7tZhLpXhd4u8rqi0mK2onOc2klOhHzlpSWQCu/UbjaosS0LZszRVgcaQUNVGDSwb2h4s9cRjSK55aUrP80qxdDC/cef9zmPXd2L5heeeJLGDT3+EWx9/vfrObtMrD5YvPUlfo6Rj32s5dQcbJnUZpR1JxfPaTX/lgH20fvp5h5Lk8lr+zZ6wipKjz1iWgShGwWAL6cBruVwuFosnJ8cFTjCNqDHarU5ybyFGcirNjFxrST6CnuEaaXUHmmG8SAavxQgUhpAXWPCxoYT/3qFjIoM5+gTdAgx0jkSQT/R8v+3GRp7K/gJgnFJ9rKlisgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Container Lifecycle\" title=\"\" src=\"/static/4f3c5dd0465d349251cd40ec2b78ea24/c5bb3/container-lifecycle.png\" srcset=\"/static/4f3c5dd0465d349251cd40ec2b78ea24/04472/container-lifecycle.png 170w,\n/static/4f3c5dd0465d349251cd40ec2b78ea24/9f933/container-lifecycle.png 340w,\n/static/4f3c5dd0465d349251cd40ec2b78ea24/c5bb3/container-lifecycle.png 680w,\n/static/4f3c5dd0465d349251cd40ec2b78ea24/b12f7/container-lifecycle.png 1020w,\n/static/4f3c5dd0465d349251cd40ec2b78ea24/1ff84/container-lifecycle.png 1040w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-kubernetes-probe-types\" style=\"position:relative;\"><a href=\"#-kubernetes-probe-types\" aria-label=\" kubernetes probe types permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Kubernetes Probe Types</h2>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnElEQVR42rXSP0gCcRQH8J96FBUWYlu0NDREi4P9oT9EBQ2BSzQ3NFZQRFvgYFFDUCIhImIqqMmZaRBUGATRYkNQQ1BDQ4M0FF3Rn99xvb4/vUGsqKUHn3t37x7v97sfx4ioYjf3fD7pfaTx1Tt180jRUNPu7x8KmXOuKUqxVk5VVZFVKsYVmJgYOLKQPwtlXyh18vw2tpLnnIgvLy3yRCLBI5EId7lchRwMBnk8HueBQICHw2HudrvF/VsymaRQKHSJ/uLACa9yETgk2si+azN+hdQPop3MNkVjMfL5fBSNRsnv9xfkcjlKp9OEYSTLshikxdDn8XiuGWOFgdLFzeva0Hw+Y5+6lfdPn1L4mi3UkSn5BzJkYB2M7D/CIC4Wi6XOZDINSpLUBu3QbbVazeKd0+k0YnVDqdIB39VEVEATNEAjtEBV6aLDs3utjrljs16rhxqohcrvdiqKndAD7WAHW2nD8PRB02gCv4Y4fMYGoAMc0AtS+cBqaNZXbtR3agXzL8clGL+cob79QeiDfujSd2Ar62M/PP9PfAKEhSGZl/X1KgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Probes\" title=\"\" src=\"/static/5ddefe574031c4f67ddfd4d8dd2fdf3f/c5bb3/probes.png\" srcset=\"/static/5ddefe574031c4f67ddfd4d8dd2fdf3f/04472/probes.png 170w,\n/static/5ddefe574031c4f67ddfd4d8dd2fdf3f/9f933/probes.png 340w,\n/static/5ddefe574031c4f67ddfd4d8dd2fdf3f/c5bb3/probes.png 680w,\n/static/5ddefe574031c4f67ddfd4d8dd2fdf3f/b12f7/probes.png 1020w,\n/static/5ddefe574031c4f67ddfd4d8dd2fdf3f/a3a5c/probes.png 1277w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Kubernetes has three basic probe types:</p>\n<ul>\n<li><strong>Liveness Probes</strong>: They detect whether a pod is healthy by running a command or making a network request inside the container. Containers that fail the check are restarted.</li>\n<li><strong>Readiness Probes</strong>: They identify when a container is able to handle external traffic received from a service. Containers don't become part of their services until they pass a readiness probe.</li>\n<li><strong>Startup Probes</strong>: They provide a way to defer the execution of liveness and readiness probes until a container indicates it's able to handle them. Kubernetes won't direct the other probe types to a container if it has a startup probe that hasn't yet succeeded.</li>\n</ul>\n<h2 id=\"-sequence-of-health-probes\" style=\"position:relative;\"><a href=\"#-sequence-of-health-probes\" aria-label=\" sequence of health probes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Sequence of Health Probes</h2>\n<p>This diagram effectively illustrates the workflow of Kubernetes health probes and their impact on a container's lifecycle.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA60lEQVR42lVRWVLFMAzLOXivS5pm715g5nH/ewnLUKZ8aOKJI1lWzLPpQDyeLZq2F1jYYcTgvIJ12w2o04LRR7gxwIekdcoVMRX01qkG+cYKiU0fIqwb4WPSkw8o1PWDkuZlE6xIZVJQeN0OvF5fWNYNlzHjRKjUGdO8qlipE7IQeJdLRZZz20/sxynEXd306tr+idDx+f4JnzLMtS7BmiuSRHd03w9OyRzACHzMMqTC/a4fxAQFQyw6yHBvEoir5kPW93zfHo2CcTACDmaPw69aV/75iP9gbvdPocBxfkgsizjJGgFdXf079xuMc6odiE1p8wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"sequence\" title=\"\" src=\"/static/e7212ecf5e1f077c3b494db8230064a8/c5bb3/sequence.png\" srcset=\"/static/e7212ecf5e1f077c3b494db8230064a8/04472/sequence.png 170w,\n/static/e7212ecf5e1f077c3b494db8230064a8/9f933/sequence.png 340w,\n/static/e7212ecf5e1f077c3b494db8230064a8/c5bb3/sequence.png 680w,\n/static/e7212ecf5e1f077c3b494db8230064a8/b12f7/sequence.png 1020w,\n/static/e7212ecf5e1f077c3b494db8230064a8/b5a09/sequence.png 1360w,\n/static/e7212ecf5e1f077c3b494db8230064a8/07a9c/sequence.png 1440w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>The process begins with the deployment of the container in Kubernetes. After the container starts, the <strong>startup probe</strong> checks if the application within the container is ready to run. If the startup probe succeeds, it proceeds to the <strong>readiness probe</strong>. If the startup probe fails, Kubernetes restarts the container.</p>\n<p>When the startup probe is successful, the readiness probe is executed. This probe determines if the container is ready to serve traffic. If the readiness probe is successful, Kubernetes initiates the <strong>liveness probe</strong> to continually monitor the container's health. If the readiness probe fails, traffic to the container is stopped. Kubernetes will retry the readiness probe until it succeeds or the failure threshold is exceeded. If the failure threshold is exceeded, Kubernetes restarts the container.</p>\n<p>Once the startup probe and the readiness probes are successful, Kubernetes continuously checks the health of the container during its runtime. If the liveness probe is successful, it will continue to monitor at defined intervals. If the liveness probe fails, Kubernetes will restart the container. After restarting the container, the process begins again with the startup probe.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4UlEQVR42j2Q207DMBBEg5rSCrWU0Ljk5txJwBS1ap54yv//FXOoQ6TRrCfj2V0Hwf0LsyyzXdfZqqrqPM/fxR9lWbq+743qF/0/Nk3zlqZpbK3thC+4KIoelu/ZZwUrDjI+qX7wdUyAzK80Q8fngWeDh2ZAjSPp6780HW5JkjgMdV1XCrpqoh/pkwK/1T0zxuyYEg+X0Zhe2tX7P/1A93Uxj+O4ZwKYC2piAMZpmtbzPIfOuce2bQ/o4tPyBABdOdv/UL1bMQxDLNNA94WFNIqiwxLAmwlnpmIDWJtd0Mj4BbcpJoNUpIoDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"sequencev2\" title=\"\" src=\"/static/73953e1f7518a255aba9cc4ed146e32f/c5bb3/sequencev2.png\" srcset=\"/static/73953e1f7518a255aba9cc4ed146e32f/04472/sequencev2.png 170w,\n/static/73953e1f7518a255aba9cc4ed146e32f/9f933/sequencev2.png 340w,\n/static/73953e1f7518a255aba9cc4ed146e32f/c5bb3/sequencev2.png 680w,\n/static/73953e1f7518a255aba9cc4ed146e32f/f1901/sequencev2.png 942w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"-startup-probes\" style=\"position:relative;\"><a href=\"#-startup-probes\" aria-label=\" startup probes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Startup Probes</h3>\n<p>Startup probes should be used when the application in your container could take a significant amount of time to reach its normal operating state. Applications that would crash or throw an error if they handled a liveness or readiness probe during startup need to be protected by a startup probe. This ensures the container doesn't enter a restart loop due to failing healthiness checks before it's finished launching.</p>\n<h4 id=\"creating-a-startup-probe\" style=\"position:relative;\"><a href=\"#creating-a-startup-probe\" aria-label=\"creating a startup probe permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Creating a Startup Probe</h4>\n<p>Startup probes are created by adding a <code class=\"language-text\">startupProbe</code> field within the <code class=\"language-text\">spec.containers</code> portion of a pod's manifest.</p>\n<p><strong>Exec Probe:</strong></p>\n<p>Exec probe runs a command inside the container as a health check; the command's exit code determines the success.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">startupProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> cat\n            <span class=\"token punctuation\">-</span> /etc/nginx/nginx.conf</code></pre></div>\n<p><strong>TCP Probe:</strong></p>\n<p>TCP probe checks if the specified port is open or not; an open port points to success.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">startupProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p><strong>HTTP Probe:</strong></p>\n<p>HTTP probe sends an HTTP GET request with defined parameters. HTTP Probe has additional options to configure.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">startupProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n        <span class=\"token key atrule\">httpHeaders</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Host\n                <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> myapplication1.com\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<h3 id=\"-readiness-probes\" style=\"position:relative;\"><a href=\"#-readiness-probes\" aria-label=\" readiness probes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üü¢ Readiness Probes</h3>\n<p>Similar to other probes, it checks to ensure the container is ready to accept traffic. Unlike the liveness probe which checks to see if things remain ship-shape, the readiness probe makes sure things are in a state that traffic can start flowing. This is at the pod level. Meaning all of the containers must be in a ready state prior to anything being passed to the service. The startup probe, while also similar, is at the application level. It would be active prior to any liveness or readiness probes.</p>\n<h4 id=\"creating-a-readiness-probe\" style=\"position:relative;\"><a href=\"#creating-a-readiness-probe\" aria-label=\"creating a readiness probe permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Creating a Readiness Probe</h4>\n<p>Readiness probes are created by adding a <code class=\"language-text\">readinessProbe</code> field within the <code class=\"language-text\">spec.containers</code> portion of a pod's manifest.</p>\n<p><strong>Exec Probe:</strong></p>\n<p>Exec action has only one field, and that is command. Exit status of the command is checked, and the status of zero (0) means it is healthy, and another value means it is unhealthy.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> cat\n            <span class=\"token punctuation\">-</span> /etc/nginx/nginx.conf</code></pre></div>\n<p><strong>TCP Probe:</strong></p>\n<p>We need to define host and port parameters, host parameter defaults to the cluster-internal pod IP.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p><strong>HTTP Probe:</strong></p>\n<p>HTTP Probe has additional options to configure.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n        <span class=\"token key atrule\">httpHeaders</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Host\n                <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> myapplication1.com\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<h3 id=\"-liveness-probes\" style=\"position:relative;\"><a href=\"#-liveness-probes\" aria-label=\" liveness probes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üî¥ Liveness Probes</h3>\n<p>Liveness probes enhance Kubernetes' ability to manage workloads on your behalf. Without probes, you need to manually monitor your pods to distinguish which application instances are healthy and which are not. This becomes time-consuming and error-prone when you're working with hundreds or thousands of pods.</p>\n<p>Allowing unhealthy pods to continue without detection degrades your service's stability over time. Pods that are silently failing as they age, perhaps due to race conditions, deadlocks, or corrupted caches, will gradually reduce your service's capacity to handle new requests. Eventually, your entire pod fleet could be affected, even though all the containers report as running.</p>\n<h4 id=\"creating-a-liveness-probe\" style=\"position:relative;\"><a href=\"#creating-a-liveness-probe\" aria-label=\"creating a liveness probe permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Creating a Liveness Probe</h4>\n<p>Liveness probes are defined by a pod's <code class=\"language-text\">spec.containers.livenessProbe</code> field. There are three types of actions kubelet performs on a pod, which are:</p>\n<ul>\n<li>Executes a command inside the container</li>\n<li>Checks for a state of a particular port on the container</li>\n<li>Performs a GET request on container's IP</li>\n</ul>\n<p><strong>Define a Liveness Command:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> sh\n            <span class=\"token punctuation\">-</span> /tmp/status_check.sh\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span></code></pre></div>\n<p><strong>Define a Liveness HTTP Request:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /health\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></code></pre></div>\n<p><strong>Define a TCP Liveness Probe:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">15</span>\n    <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span></code></pre></div>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèÅ Conclusion</h2>\n<p>Kubernetes probes are essential for ensuring the health and resilience of your applications. They provide a more streamlined, data-driven approach to monitoring, which facilitates informed decision-making and responsive adjustments to changes in your application's usage patterns. By using health checks, you can improve your application availability, reduce your maintenance burden, and make certain that your application is not only running but also accessible to your users.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}