{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/manage-kubernetes-with-iac/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>How to automate, secure, and scale your Kubernetes infra</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🗯 Introduction</h2>\n<p>Kubernetes is probably the most well-known solution for deploying and managing large-scale containerized applications. But, it can be complex to deploy and manage across different environments and infras.</p>\n<p>This is where IaC tools come in. Integrating tools like ArgoCD, Terraform, and Vault can make Kubernetes management more automated, secure, and scalable.\nIn this blog post, we'll explore how using IaC tools can help you manage Kubernetes infrastructure more efficiently.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.35294117647059%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACIklEQVR42pWT208TQRTG+av9E/RNH3w0PihPEIIiEgsxUVEilEuTQqCU0m5LaXfb2e1eujt7/zm7i4AKD57kmzOZyzfnfOfMAo9axqi7Qavxhn5rGe1smU7zLUI/Ic0gTZIHby38vZDneQnbttF1g1DGZFle7qWKScqQMAzxfb/0jxIWJIX1RJ/V5jobrS1qnc+stz/RHDTJ44ysCE2ZbTsY+oThcFg+/CBhHMcEQYCwBNfWGCdycRWELxD2FMsymIgB8/kc27FUpD6BH1TiZNm/hFLKMg0xMclvUqwir/xOzeDV0xZRLKl/G7D4ok0cpX+cK67dEpqmiee5eIGlNlKUkspnxEp8d+5w+LPPl489pWPCVddmu9ZX+kqSUGnpeyRReC9CxSxMlepgxvfakPpXA8f2kKHEUylOhanmc5JUlsdnKuU0CzAcSaOrs9O8KKFNvbsIkzSkd+7w+tkFSy81hGEWdb0tVuHyG6lMIfAdF80M2Do12DwZsXl8zW5XVIRpknN5ZqFd6ujWCMOdoc88jts9xpaLFSTIOMFTLTSTKdemKpYXYrqSyWTKTEyIpLxLeTqWPH9yysZiX73qs7SrsXY04H3jipW9Div7GleWz6FmsbzXY3VfoX7J4o82pyOn6tGs0DxXhGqII4mmdVQqBpkqQhJF5U+4j+Jc0R7FPPuNNC3Xqs9QybKwfW7w4ahfYu2gy7uDXhlN2V95zv/aL+tTjy4DzU0vAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Alt text\" title=\"\" src=\"/static/c9a934fda62b5401b12bd1321cc934e6/c5bb3/iac-tools.png\" srcset=\"/static/c9a934fda62b5401b12bd1321cc934e6/04472/iac-tools.png 170w,\n/static/c9a934fda62b5401b12bd1321cc934e6/9f933/iac-tools.png 340w,\n/static/c9a934fda62b5401b12bd1321cc934e6/c5bb3/iac-tools.png 680w,\n/static/c9a934fda62b5401b12bd1321cc934e6/5a190/iac-tools.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"kubernetes-management-with-iac-a-technical-deep-dive\" style=\"position:relative;\"><a href=\"#kubernetes-management-with-iac-a-technical-deep-dive\" aria-label=\"kubernetes management with iac a technical deep dive permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes Management with IaC: A Technical Deep Dive</h2>\n<p>Managing a Kubernetes cluster efficiently requires a clear automation strategy.</p>\n<h3 id=\"1-setting-up-your-iac-foundation\" style=\"position:relative;\"><a href=\"#1-setting-up-your-iac-foundation\" aria-label=\"1 setting up your iac foundation permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>1. Setting Up Your IaC Foundation</h3>\n<p>Start by creating a Git repository to store all your IaC configurations:</p>\n<ul>\n<li>Use separate directories for Terraform, Kubernetes manifests, and Helm charts.</li>\n<li>Implement a branching strategy (e.g., <a href=\"https://nvie.com/posts/a-successful-git-branching-model/\" target=\"_blank\" rel=\"noopener noreferrer\">GitFlow</a>) for managing changes. GitFlow helps in organizing your work with feature branches, release branches, and hotfixes.</li>\n<li>Set up pre-commit hooks to enforce code quality and formatting using tools like <a href=\"https://pre-commit.com/\" target=\"_blank\" rel=\"noopener noreferrer\">pre-commit</a>.</li>\n</ul>\n<h3 id=\"2-automating-cluster-provisioning-with-terraform\" style=\"position:relative;\"><a href=\"#2-automating-cluster-provisioning-with-terraform\" aria-label=\"2 automating cluster provisioning with terraform permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>2. Automating Cluster Provisioning with Terraform</h3>\n<p>Terraform is key for creating and managing your Kubernetes infrastructure:</p>\n<ul>\n<li>Define your cluster using <a href=\"https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform's Kubernetes provider</a>.</li>\n<li>Use <a href=\"https://www.terraform.io/docs/language/modules/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform modules</a> to create reusable components (e.g., VPCs, subnets).</li>\n<li>Implement <a href=\"https://www.terraform.io/docs/language/state/workspaces.html\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform workspaces</a> for managing multiple environments (dev, staging, prod).</li>\n</ul>\n<p>Example Terraform code snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"aws\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">region</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"eu-west-1\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"eks_cluster\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">source</span>       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"./modules/eks\"</span>\n  <span class=\"token property\">cluster_name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my-cluster\"</span>\n  <span class=\"token property\">vpc_id</span>       <span class=\"token punctuation\">=</span> module.vpc.vpc_id\n  <span class=\"token property\">subnet_ids</span>   <span class=\"token punctuation\">=</span> module.vpc.private_subnets\n  <span class=\"token property\">node_groups</span>  <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">example</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">desired_capacity</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n      <span class=\"token property\">max_size</span>         <span class=\"token punctuation\">=</span> <span class=\"token number\">3</span>\n      <span class=\"token property\">min_size</span>         <span class=\"token punctuation\">=</span> <span class=\"token number\">1</span>\n      <span class=\"token property\">instance_type</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"t2.medium\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"3-enhancing-terraform-workflows\" style=\"position:relative;\"><a href=\"#3-enhancing-terraform-workflows\" aria-label=\"3 enhancing terraform workflows permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>3. Enhancing Terraform Workflows</h3>\n<h4 id=\"terraform-cloud\" style=\"position:relative;\"><a href=\"#terraform-cloud\" aria-label=\"terraform cloud permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Terraform Cloud:</strong></h4>\n<p>Terraform Cloud provides remote state management, version control, and a collaborative environment for Terraform runs. To use Terraform Cloud:</p>\n<ol>\n<li>Sign up and create an organization on <a href=\"https://app.terraform.io/signup\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform Cloud</a>.</li>\n<li>Create a workspace for your project.</li>\n</ol>\n<p>Configure the remote backend in your Terraform configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">backend<span class=\"token type variable\"> \"remote\" </span></span><span class=\"token punctuation\">{</span>\n        <span class=\"token property\">organization</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my-org\"</span>\n        <span class=\"token keyword\">workspaces</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my-workspace\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"atlantis\" style=\"position:relative;\"><a href=\"#atlantis\" aria-label=\"atlantis permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Atlantis:</strong></h4>\n<p><a href=\"https://www.runatlantis.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Atlantis</a> is an open-source tool for automating Terraform workflows through pull requests.</p>\n<p>To set up Atlantis:</p>\n<ol>\n<li>Deploy Atlantis in your Kubernetes cluster.</li>\n<li>Configure repository settings to trigger Atlantis on pull requests.</li>\n<li>Define the workflow in the <code class=\"language-text\">atlantis.yaml</code> file:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n<span class=\"token key atrule\">projects</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>terraform<span class=\"token punctuation\">-</span>project\n        <span class=\"token key atrule\">dir</span><span class=\"token punctuation\">:</span> .\n        <span class=\"token key atrule\">workspace</span><span class=\"token punctuation\">:</span> default\n        <span class=\"token key atrule\">autoplan</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">when_modified</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"*.tf\"</span><span class=\"token punctuation\">]</span>\n            <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<h4 id=\"terramate\" style=\"position:relative;\"><a href=\"#terramate\" aria-label=\"terramate permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Terramate:</strong></h4>\n<p><a href=\"https://terramate.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terramate</a> enhances Terraform's capabilities by providing a framework for managing configurations at scale. It allows for better modularization and automation.</p>\n<ol>\n<li>Install Terramate by following the <a href=\"https://terramate.io/docs/install\" target=\"_blank\" rel=\"noopener noreferrer\">installation guide</a>.</li>\n<li>Define stack configurations in your project:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token comment\"># terramate.hcl</span>\n<span class=\"token keyword\">terramate</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># Define global settings</span>\n<span class=\"token punctuation\">}</span>\nstack <span class=\"token string\">\"prod\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># Define stack-specific settings</span>\n    <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"./stacks/prod\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"4-streamlining-application-deployment-with-helm-and-helmfile\" style=\"position:relative;\"><a href=\"#4-streamlining-application-deployment-with-helm-and-helmfile\" aria-label=\"4 streamlining application deployment with helm and helmfile permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>4. Streamlining Application Deployment with Helm and Helmfile</h3>\n<p>Helm simplifies package management for Kubernetes:</p>\n<ul>\n<li>Create Helm charts for your applications.</li>\n<li>Use <a href=\"https://github.com/helmfile/helmfile\" target=\"_blank\" rel=\"noopener noreferrer\">Helmfile</a> to manage multiple Helm releases.</li>\n</ul>\n<p>Example of helmfile:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">repositories</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> prometheus<span class=\"token punctuation\">-</span>community\n        <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//prometheus<span class=\"token punctuation\">-</span>community.github.io/helm<span class=\"token punctuation\">-</span>charts\n\n<span class=\"token key atrule\">releases</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n        <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span> ./charts/my<span class=\"token punctuation\">-</span>app\n        <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ./values/my<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>values.yaml\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> prometheus\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> monitoring\n        <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span> prometheus<span class=\"token punctuation\">-</span>community/prometheus\n        <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> 15.0.0\n        <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ./values/prometheus<span class=\"token punctuation\">-</span>values.yaml</code></pre></div>\n<h3 id=\"5-customizing-deployments-with-kustomize\" style=\"position:relative;\"><a href=\"#5-customizing-deployments-with-kustomize\" aria-label=\"5 customizing deployments with kustomize permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>5. Customizing Deployments with Kustomize</h3>\n<p><a href=\"https://kustomize.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kustomize</a> allows for environment-specific customizations:</p>\n<ul>\n<li>Create a base configuration for your applications.</li>\n<li>Use overlays to customize for different environments.</li>\n</ul>\n<p>Example Kustomize structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">├── base\n│   ├── deployment.yaml\n│   ├── service.yaml\n│   └── kustomization.yaml\n└── overlays\n        ├── dev\n        │   ├── cpu_limit.yaml\n        │   └── kustomization.yaml\n        └── prod\n                ├── replica_count.yaml\n                └── kustomization.yaml</code></pre></div>\n<h3 id=\"5-implementing-gitops-with-argocd\" style=\"position:relative;\"><a href=\"#5-implementing-gitops-with-argocd\" aria-label=\"5 implementing gitops with argocd permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>5. Implementing GitOps with ArgoCD</h3>\n<p>ArgoCD enables continuous deployment from Git repositories:</p>\n<ul>\n<li><strong>Install ArgoCD</strong> in your cluster. Follow the <a href=\"https://argo-cd.readthedocs.io/en/stable/getting_started/\" target=\"_blank\" rel=\"noopener noreferrer\">official installation guide</a>.</li>\n<li><strong>Define your applications</strong> using ArgoCD custom resources.</li>\n<li><strong>Set up automated sync policies</strong> for continuous deployment.</li>\n</ul>\n<p>Example ArgoCD Application manifest:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Application\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> argocd\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">project</span><span class=\"token punctuation\">:</span> default\n    <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">repoURL</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/myorg/my<span class=\"token punctuation\">-</span>app.git\n        <span class=\"token key atrule\">targetRevision</span><span class=\"token punctuation\">:</span> HEAD\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> kustomize/overlays/prod\n    <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//kubernetes.default.svc\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">syncPolicy</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">automated</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">prune</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n            <span class=\"token key atrule\">selfHeal</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<h3 id=\"6-securing-secrets-with-hashicorp-vault\" style=\"position:relative;\"><a href=\"#6-securing-secrets-with-hashicorp-vault\" aria-label=\"6 securing secrets with hashicorp vault permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>6. Securing Secrets with HashiCorp Vault</h3>\n<p>Vault provides secure secret management:</p>\n<ul>\n<li><strong>Deploy Vault</strong> using the <a href=\"https://www.vaultproject.io/docs/platform/k8s/helm\" target=\"_blank\" rel=\"noopener noreferrer\">official Helm chart</a>.</li>\n<li><strong>Configure Vault</strong> to use Kubernetes authentication.</li>\n<li><strong>Use the Vault Secrets Operator</strong> to inject secrets into your pods.</li>\n</ul>\n<p>Example Vault SecretStore resource:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> secrets<span class=\"token punctuation\">-</span>store.csi.x<span class=\"token punctuation\">-</span>k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> SecretProviderClass\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> vault<span class=\"token punctuation\">-</span>database\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span> vault\n    <span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">vaultAddress</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://vault:8200\"</span>\n        <span class=\"token key atrule\">roleName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"database-role\"</span>\n        <span class=\"token key atrule\">objects</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            - objectName: \"db-password\"\n                secretPath: \"secret/data/myapp/database\"\n                secretKey: \"password\"</span>\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n        <span class=\"token key atrule\">audience</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"vault\"</span></code></pre></div>\n<h3 id=\"7-automating-cluster-add-ons\" style=\"position:relative;\"><a href=\"#7-automating-cluster-add-ons\" aria-label=\"7 automating cluster add ons permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>7. Automating Cluster Add-ons</h3>\n<p>Use a combination of Helm and ArgoCD to manage cluster add-ons:</p>\n<ul>\n<li>Create an \"add-ons\" repository with Helm charts for common tools (e.g., <a href=\"https://prometheus.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Prometheus</a>, <a href=\"https://grafana.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Grafana</a>, <a href=\"https://cert-manager.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Cert-Manager</a>).</li>\n<li>Use ArgoCD to deploy and manage these add-ons.</li>\n</ul>\n<h3 id=\"8-implementing-policy-enforcement-with-opa-gatekeeper\" style=\"position:relative;\"><a href=\"#8-implementing-policy-enforcement-with-opa-gatekeeper\" aria-label=\"8 implementing policy enforcement with opa gatekeeper permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>8. Implementing Policy Enforcement with OPA Gatekeeper</h3>\n<p>Automate policy enforcement across your cluster:</p>\n<ul>\n<li>Install <a href=\"https://github.com/open-policy-agent/gatekeeper\" target=\"_blank\" rel=\"noopener noreferrer\">OPA Gatekeeper</a> using Helm. Follow the <a href=\"https://open-policy-agent.github.io/gatekeeper/website/docs/install/\" target=\"_blank\" rel=\"noopener noreferrer\">installation guide</a>.</li>\n<li>Define custom policies using the <a href=\"https://www.openpolicyagent.org/docs/latest/policy-language/\" target=\"_blank\" rel=\"noopener noreferrer\">Rego language</a>.</li>\n<li>Use Gatekeeper constraints to enforce these policies.</li>\n</ul>\n<p>Example Gatekeeper constraint:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> constraints.gatekeeper.sh/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> K8sRequiredLabels\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> require<span class=\"token punctuation\">-</span>team<span class=\"token punctuation\">-</span>label\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">match</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">kinds</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span>\n                <span class=\"token key atrule\">kinds</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Namespace\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"team\"</span>\n                <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-team\"</span></code></pre></div>\n<h3 id=\"9-automating-backup-and-restore-with-velero\" style=\"position:relative;\"><a href=\"#9-automating-backup-and-restore-with-velero\" aria-label=\"9 automating backup and restore with velero permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>9. Automating Backup and Restore with Velero</h3>\n<p>Implement automated backup and restore processes:</p>\n<ul>\n<li>Install <a href=\"https://velero.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Velero</a> using Helm. Follow the <a href=\"https://velero.io/docs/v1.7/basic-install/\" target=\"_blank\" rel=\"noopener noreferrer\">installation guide</a>.</li>\n<li>Set up scheduled backups using Velero's schedule CRD.</li>\n<li>Automate restore processes for disaster recovery.</li>\n</ul>\n<p>Example Velero schedule:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> velero.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Schedule\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> daily<span class=\"token punctuation\">-</span>backup\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0 1 * * *\"</span>\n    <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">includedNamespaces</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"*\"</span>\n        <span class=\"token key atrule\">excludedNamespaces</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"velero\"</span>\n        <span class=\"token key atrule\">ttl</span><span class=\"token punctuation\">:</span> 720h0m0s</code></pre></div>\n<p>By implementing these automation strategies, you'll create a scalable and easily manageable Kubernetes environment. This approach reduces manual work, increases consistency, and improves overall cluster security and reliability.</p>\n<h2 id=\"-key-takeaways\" style=\"position:relative;\"><a href=\"#-key-takeaways\" aria-label=\" key takeaways permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>💬 Key Takeaways</h2>\n<p>Automating Kubernetes infrastructure with IaC and tools like Terraform, Helm, ArgoCD, and Vault enhances efficiency, security, and scalability. Integrating CI/CD, service mesh, monitoring, and policy enforcement tools ensures resilient Kubernetes environments, driving operational excellence and innovation.</p>\n<p><strong>🔖 References:🖌️</strong></p>\n<ul>\n<li><a href=\"https://www.paloaltonetworks.com/cyberpedia/kubernetes-infrastructure-as-code\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.paloaltonetworks.com/cyberpedia/kubernetes-infrastructure-as-code</a></li>\n<li><a href=\"https://www.adaptavist.com/blog/kubernetes--automation-and-configuration-explained\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.adaptavist.com/blog/kubernetes--automation-and-configuration-explained</a></li>\n<li><a href=\"https://www.fairwinds.com/blog/deep-dive-how-to-improve-kubernetes-management-with-iac-tools\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.fairwinds.com/blog/deep-dive-how-to-improve-kubernetes-management-with-iac-tools</a></li>\n<li><a href=\"https://vzilla.co.uk/vzilla-blog/using-terraform-iac-to-automate-your-kubernetes-clusters-and-apps\" target=\"_blank\" rel=\"noopener noreferrer\">https://vzilla.co.uk/vzilla-blog/using-terraform-iac-to-automate-your-kubernetes-clusters-and-apps</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, つづく 🎉</em></strong></p>\n<blockquote>\n<p>💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  <em><strong>Until next time 🎉</strong></em></p>\n</blockquote>\n<p>🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>♻️ LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>♻️ X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ✌🏻</strong></p>\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n<p><strong>📅 Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":4,"rawMarkdownBody":"\n> **How to automate, secure, and scale your Kubernetes infra**\n\n## 🗯 Introduction\n\nKubernetes is probably the most well-known solution for deploying and managing large-scale containerized applications. But, it can be complex to deploy and manage across different environments and infras.\n\nThis is where IaC tools come in. Integrating tools like ArgoCD, Terraform, and Vault can make Kubernetes management more automated, secure, and scalable.\nIn this blog post, we'll explore how using IaC tools can help you manage Kubernetes infrastructure more efficiently.\n\n![Alt text](./iac-tools.png)\n\n## Kubernetes Management with IaC: A Technical Deep Dive\n\nManaging a Kubernetes cluster efficiently requires a clear automation strategy.\n\n### 1. Setting Up Your IaC Foundation\n\nStart by creating a Git repository to store all your IaC configurations:\n\n- Use separate directories for Terraform, Kubernetes manifests, and Helm charts.\n- Implement a branching strategy (e.g., [GitFlow](https://nvie.com/posts/a-successful-git-branching-model/)) for managing changes. GitFlow helps in organizing your work with feature branches, release branches, and hotfixes.\n- Set up pre-commit hooks to enforce code quality and formatting using tools like [pre-commit](https://pre-commit.com/).\n\n### 2. Automating Cluster Provisioning with Terraform\n\nTerraform is key for creating and managing your Kubernetes infrastructure:\n\n- Define your cluster using [Terraform's Kubernetes provider](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs).\n- Use [Terraform modules](https://www.terraform.io/docs/language/modules/index.html) to create reusable components (e.g., VPCs, subnets).\n- Implement [Terraform workspaces](https://www.terraform.io/docs/language/state/workspaces.html) for managing multiple environments (dev, staging, prod).\n\nExample Terraform code snippet:\n\n```hcl\nprovider \"aws\" {\n  region = \"eu-west-1\"\n}\n\nmodule \"eks_cluster\" {\n  source       = \"./modules/eks\"\n  cluster_name = \"my-cluster\"\n  vpc_id       = module.vpc.vpc_id\n  subnet_ids   = module.vpc.private_subnets\n  node_groups  = {\n    example = {\n      desired_capacity = 2\n      max_size         = 3\n      min_size         = 1\n      instance_type    = \"t2.medium\"\n    }\n  }\n}\n```\n\n### 3. Enhancing Terraform Workflows\n\n#### **Terraform Cloud:**\n\nTerraform Cloud provides remote state management, version control, and a collaborative environment for Terraform runs. To use Terraform Cloud:\n\n1. Sign up and create an organization on [Terraform Cloud](https://app.terraform.io/signup).\n2. Create a workspace for your project.\n\nConfigure the remote backend in your Terraform configuration:\n\n```hcl\nterraform {\n    backend \"remote\" {\n        organization = \"my-org\"\n        workspaces {\n            name = \"my-workspace\"\n        }\n    }\n}\n```\n\n#### **Atlantis:**\n\n[Atlantis](https://www.runatlantis.io/) is an open-source tool for automating Terraform workflows through pull requests. \n\nTo set up Atlantis:\n\n1. Deploy Atlantis in your Kubernetes cluster.\n2. Configure repository settings to trigger Atlantis on pull requests.\n3. Define the workflow in the `atlantis.yaml` file:\n\n```yaml\nversion: 3\nprojects:\n    - name: my-terraform-project\n        dir: .\n        workspace: default\n        autoplan:\n            when_modified: [\"*.tf\"]\n            enabled: true\n```\n\n#### **Terramate:**\n\n[Terramate](https://terramate.io/) enhances Terraform's capabilities by providing a framework for managing configurations at scale. It allows for better modularization and automation.\n\n1. Install Terramate by following the [installation guide](https://terramate.io/docs/install).\n2. Define stack configurations in your project:\n\n```hcl\n# terramate.hcl\nterramate {\n    # Define global settings\n}\nstack \"prod\" {\n    # Define stack-specific settings\n    source = \"./stacks/prod\"\n}\n```\n\n### 4. Streamlining Application Deployment with Helm and Helmfile\n\nHelm simplifies package management for Kubernetes:\n\n- Create Helm charts for your applications.\n- Use [Helmfile](https://github.com/helmfile/helmfile) to manage multiple Helm releases.\n\nExample of helmfile:\n\n```yaml\nrepositories:\n    - name: prometheus-community\n        url: https://prometheus-community.github.io/helm-charts\n\nreleases:\n    - name: my-app\n        namespace: default\n        chart: ./charts/my-app\n        values:\n            - ./values/my-app-values.yaml\n    - name: prometheus\n        namespace: monitoring\n        chart: prometheus-community/prometheus\n        version: 15.0.0\n        values:\n            - ./values/prometheus-values.yaml\n```\n\n### 5. Customizing Deployments with Kustomize\n\n[Kustomize](https://kustomize.io/) allows for environment-specific customizations:\n\n- Create a base configuration for your applications.\n- Use overlays to customize for different environments.\n\nExample Kustomize structure:\n\n```shell\n├── base\n│   ├── deployment.yaml\n│   ├── service.yaml\n│   └── kustomization.yaml\n└── overlays\n        ├── dev\n        │   ├── cpu_limit.yaml\n        │   └── kustomization.yaml\n        └── prod\n                ├── replica_count.yaml\n                └── kustomization.yaml\n```\n\n### 5. Implementing GitOps with ArgoCD\n\nArgoCD enables continuous deployment from Git repositories:\n\n- **Install ArgoCD** in your cluster. Follow the [official installation guide](https://argo-cd.readthedocs.io/en/stable/getting_started/).\n- **Define your applications** using ArgoCD custom resources.\n- **Set up automated sync policies** for continuous deployment.\n\nExample ArgoCD Application manifest:\n\n```yaml\napiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n    name: my-app\n    namespace: argocd\nspec:\n    project: default\n    source:\n        repoURL: https://github.com/myorg/my-app.git\n        targetRevision: HEAD\n        path: kustomize/overlays/prod\n    destination:\n        server: https://kubernetes.default.svc\n        namespace: my-app\n    syncPolicy:\n        automated:\n            prune: true\n            selfHeal: true\n```\n\n### 6. Securing Secrets with HashiCorp Vault\n\nVault provides secure secret management:\n\n- **Deploy Vault** using the [official Helm chart](https://www.vaultproject.io/docs/platform/k8s/helm).\n- **Configure Vault** to use Kubernetes authentication.\n- **Use the Vault Secrets Operator** to inject secrets into your pods.\n\nExample Vault SecretStore resource:\n\n```yaml\napiVersion: secrets-store.csi.x-k8s.io/v1\nkind: SecretProviderClass\nmetadata:\n    name: vault-database\nspec:\n    provider: vault\n    parameters:\n        vaultAddress: \"http://vault:8200\"\n        roleName: \"database-role\"\n        objects: |\n            - objectName: \"db-password\"\n                secretPath: \"secret/data/myapp/database\"\n                secretKey: \"password\"\n        namespace: my-app\n        audience: \"vault\"\n```\n### 7. Automating Cluster Add-ons\n\nUse a combination of Helm and ArgoCD to manage cluster add-ons:\n\n- Create an \"add-ons\" repository with Helm charts for common tools (e.g., [Prometheus](https://prometheus.io/), [Grafana](https://grafana.com/), [Cert-Manager](https://cert-manager.io/)).\n- Use ArgoCD to deploy and manage these add-ons.\n\n### 8. Implementing Policy Enforcement with OPA Gatekeeper\n\nAutomate policy enforcement across your cluster:\n\n- Install [OPA Gatekeeper](https://github.com/open-policy-agent/gatekeeper) using Helm. Follow the [installation guide](https://open-policy-agent.github.io/gatekeeper/website/docs/install/).\n- Define custom policies using the [Rego language](https://www.openpolicyagent.org/docs/latest/policy-language/).\n- Use Gatekeeper constraints to enforce these policies.\n\nExample Gatekeeper constraint:\n\n```yaml\napiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sRequiredLabels\nmetadata:\n    name: require-team-label\nspec:\n    match:\n        kinds:\n            - apiGroups: [\"\"]\n                kinds: [\"Namespace\"]\n    parameters:\n        labels:\n            - key: \"team\"\n                value: \"my-team\"\n```\n\n### 9. Automating Backup and Restore with Velero\n\nImplement automated backup and restore processes:\n\n- Install [Velero](https://velero.io/) using Helm. Follow the [installation guide](https://velero.io/docs/v1.7/basic-install/).\n- Set up scheduled backups using Velero's schedule CRD.\n- Automate restore processes for disaster recovery.\n\nExample Velero schedule:\n\n```yaml\napiVersion: velero.io/v1\nkind: Schedule\nmetadata:\n    name: daily-backup\nspec:\n    schedule: \"0 1 * * *\"\n    template:\n        includedNamespaces:\n            - \"*\"\n        excludedNamespaces:\n            - \"velero\"\n        ttl: 720h0m0s\n```\n\nBy implementing these automation strategies, you'll create a scalable and easily manageable Kubernetes environment. This approach reduces manual work, increases consistency, and improves overall cluster security and reliability.\n\n## 💬 Key Takeaways\n\nAutomating Kubernetes infrastructure with IaC and tools like Terraform, Helm, ArgoCD, and Vault enhances efficiency, security, and scalability. Integrating CI/CD, service mesh, monitoring, and policy enforcement tools ensures resilient Kubernetes environments, driving operational excellence and innovation.\n\n**🔖 References:🖌️**\n\n- https://www.paloaltonetworks.com/cyberpedia/kubernetes-infrastructure-as-code\n- https://www.adaptavist.com/blog/kubernetes--automation-and-configuration-explained\n- https://www.fairwinds.com/blog/deep-dive-how-to-improve-kubernetes-management-with-iac-tools\n- https://vzilla.co.uk/vzilla-blog/using-terraform-iac-to-automate-your-kubernetes-clusters-and-apps\n\n<br>\n\n**_Until next time, つづく 🎉_**\n\n> 💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  _**Until next time 🎉**_\n\n🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**♻️ LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**♻️ X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ✌🏻**\n\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n\n**📅 Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":735},"frontmatter":{"id":"62fb863dd33a272655bf1cce","path":"/blog/manage-kubernetes-with-iac/","humanDate":"Oct 17, 2024","fullDate":"2024-10-17","title":"Simplify Kubernetes management with Infrastructure as Code (IaC) tools","keywords":["Kubernetes","Infrastructure as Code","IaC tools","Automation","Security","Scalability"],"excerpt":"Simplify Kubernetes management using Infrastructure as Code (IaC) tools, focusing on automation, security, and scalability for your Kubernetes infrastructure.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACyklEQVR42jWT3W/aVhjG+Rcn7aLa1Sbtequ0y2mapmpdW61d1K2L2nTtsrZkYYYUDBgHCB+hggScxoUEspDyIQIOJoEYYjCE/mY89eLROefi/M7zvs97XOJeg4BSJ7Lf5NYTD8/WvIQiUV7+7cEvBoklUgQlGTEYIh6Pk0qlSCaT+Hw+yuUy4/HY0WQyYTqd4nLnaoTeNljbbXJfSLKZ2SUYloln8kSTGfZKR4j2A7lsjmw2i6IoFAoFEltb1Ot1LMtiNBo5wPl8juuL7x/yyXdP+OzbJe4u/8maP8y6148QiPBaTuD2Blh1/0O+oCBv2k5FkWAwSCAQIJFIIAgCkiQ554Vj1z3/Ljcep7nrTeONbiPvlNjaUQln3xHOKOTelmwVKR5WUN8VqVQqHBwcoKqq47DRaKBpmqPBYIDrYfI9N4UikYqBP1Pi55UXPN+I8Njt4/bSCqsemeVnAr6NDUJSBMF277X7t76+TqfTYTabOb27vr529i6/2uK2VOZ1oYu43yN5fIZS66I2+8TVPquhQyL5Pt0zA73bp9YxGRqXDIdDTNN0Avm4Oj3cPNT4NXHCo1SDlUwP5eQc5VhnLd2kUL1AfHPKQdOiqm5zVMzT0Od0dANzZDigRRgL2CKchUtX2r78x26bO1KD1YiClGuh/NtH3m/zKqXzzdMevjcGg+EV1VMDj3iML1Kn1bVh4ysbOnZKXWgysXClqj2e5jX+ymi4pQQvYlVKnTGx4jmf/njKLxs6nz/QiCoGw6sJr3xlhPB7GprJ1PofaFlTG3jNfLaYw70OX4s1HqRbpMqXyJkTClKMFbntgOL7A75aPuM38ZxDu6+lmklLN2nburi0h9maOGUPDRNtNMYlqGfcTza5E2+RPjLYVu1fI+2QP9H5yaPz5ZLGDy91O4wR2fIFfWPxK8ZUmnY4owkf5jPa7R6Pfo8RPT3nP92M7wQhtaDTAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/80222f08bc6e74c9709dee604824f2a8/4f3db/k8s-iac-cover.png","srcSet":"/static/80222f08bc6e74c9709dee604824f2a8/e9e03/k8s-iac-cover.png 750w,\n/static/80222f08bc6e74c9709dee604824f2a8/4f3db/k8s-iac-cover.png 800w","sizes":"100vw"},"sources":[{"srcSet":"/static/80222f08bc6e74c9709dee604824f2a8/4e44c/k8s-iac-cover.webp 750w,\n/static/80222f08bc6e74c9709dee604824f2a8/f4cfb/k8s-iac-cover.webp 800w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.535}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/aws-eks-pod-identity/","title":"Easy AWS permissions for your EKS workloads","date":"2024-10-17 11:34:00"},"excerpt":"EKS Pod Identity - An easy way to grant AWS access 🗯 Introduction Running applications on Kubernetes is great, but sometimes they need to…","html":"<blockquote>\n<p><strong>EKS Pod Identity - An easy way to grant AWS access</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>🗯 Introduction</h2>\n<p>Running applications on Kubernetes is great, but sometimes they need to talk to other AWS services like S3 or DynamoDB. In the past, setting up the right permissions for your Kubernetes apps to access these AWS services was a bit of a headache. You had to jump through hoops and follow complex instructions 😕.</p>\n<p>But now, there's a new feature called EKS Pod Identity that makes granting AWS permissions to your Kubernetes apps a breeze 🤩. With just a few clicks (or commands), you can give your apps the AWS access they need, without any complicated setup.</p>\n<p>EKS Pod Identity is a part of Amazon's Elastic Kubernetes Service (EKS), and it's designed to make your life as a Kubernetes user much easier. It's a simple, straightforward way to manage AWS permissions for your Kubernetes workloads, saving you time and effort.</p>\n<p><em>In this blog post, we'll explore what EKS Pod Identity is, how it works, and why you should consider using it for your Kubernetes applications running on EKS.</em></p>\n<h2 id=\"grant-aws-permissions-to-your-k8s-apps\" style=\"position:relative;\"><a href=\"#grant-aws-permissions-to-your-k8s-apps\" aria-label=\"grant aws permissions to your k8s apps permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Grant AWS permissions to your K8S apps</h2>\n<p>When you're running Kubernetes apps on Amazon EKS (Elastic Kubernetes Service), you have two main options to give them the ability to access other AWS services like <a href=\"https://aws.amazon.com/s3/\" target=\"_blank\" rel=\"noopener noreferrer\">S3</a> or <a href=\"https://aws.amazon.com/dynamodb/\" target=\"_blank\" rel=\"noopener noreferrer\">DynamoDB</a>:</p>\n<p><strong>IAM Roles for Service Accounts (IRSA)</strong></p>\n<p>This method allows associating IAM roles with Kubernetes service accounts. It supports various Kubernetes environments on AWS like <a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"noopener noreferrer\">EKS</a>, <a href=\"https://aws.amazon.com/eks/eks-anywhere/\" target=\"_blank\" rel=\"noopener noreferrer\">EKS Anywhere</a>, OpenShift, and self-managed clusters. IRSA uses core AWS services like IAM and doesn't directly depend on the EKS service.</p>\n<p><strong>EKS Pod Identity</strong></p>\n<p>This EKS-specific feature simplifies how cluster admins can configure IAM permissions for Kubernetes apps. It allows directly mapping an IAM role to a Kubernetes service account through EKS APIs. Pods under the associated service account can automatically obtain temporary AWS credentials.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.94117647058824%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACq0lEQVR42l1SX0hTYRQ/29zc1nVz167b6LLpuLF5Q5yM6Q1nX+Ucl1qLFheyWYLKRGNiGURBXIIwIcP2IiWWIASyngzyKfAl6qWH8kFK8KGBif0DS59v37neQXjg43zf+c73O7/vnB94Qkm3T4hyPC+yvCixIl2khdQGmps9ICo22DerIAjV1FsCgYCH53mW4zif3+93AigWCBK7bNxDRu5qJeqKPdg3b+eVkkNUSjZMCpK+WlYuujAuchxDCKlC0H0QsLIs66LenOqItshyUytW9Xq9h2DjFrjxoAGY0G8R0lDuSvVfpkwglreG++dq/H5wGkxNslLgxiaXjsVCIXxnWl+G6p89UtvuGSUKQbBDxUoKpU5t7XhX+mt3em1bFBlQNXPw/HQtAiolTb8fKG7L12Z+l3vVj/V5yhRj6wkyVT6deo0FYHJxR8KHcMCQMW1FVR1lmEwq7tz9736MK+o2k767EVcMAmgjV6YSY9l7HXRrh8LMr83m4VUP9gMgZlVHCLP66naEnuudwbgP45fUT5mx2d2dgYmyoIMqJQv2M0ZbguehmT9vBp/sLejoydH3RzVNM4HRw5U+Yv8ynA09CHobbsaJD8i8/cJgke+f+pFRrr9zYI5q/IjnJQfPA3tx/OXJ9PBinIZcYACZRFG0YdWK16vRh2yu6KoMBb95IMf2X5fM+uR7H241ForrVA7MYaqxRqqxIyiNwYXuxtGlAS9IVEpUNjgUeuegdwHMi0QidQiYm+s8O/Qi1YaI4XC4Bm482/ubL26mMCBJkkMQQK987nHs89Xnp6Yx3ibrmjPpwtV7DRZVVfVvZx61v+2ZPTGBe5FQZSgT3+TOOx/8kH7q9ORLbraw7ILcsqtpPNEeU7N0OJoZGRrsnOgre1xMlOHcCbenEvsHW3OzogTqwTcAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/9223607412755730771f944ca89ad799/c5bb3/irsa-vs-podid.png\" srcset=\"/static/9223607412755730771f944ca89ad799/04472/irsa-vs-podid.png 170w,\n/static/9223607412755730771f944ca89ad799/9f933/irsa-vs-podid.png 340w,\n/static/9223607412755730771f944ca89ad799/c5bb3/irsa-vs-podid.png 680w,\n/static/9223607412755730771f944ca89ad799/5a190/irsa-vs-podid.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Both options achieve the same goal - granting your Kubernetes workloads on EKS the necessary AWS permissions.</p>\n<p>However, EKS Pod Identity is a more EKS-specific and simplified approach, while IRSA is a more general solution that works across different Kubernetes environments on AWS.</p>\n<table>\n<thead>\n<tr>\n<th>Feature</th>\n<th>EKS Pod Identity</th>\n<th>IRSA</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Role Extensibility</strong></td>\n<td>No need to update the role's trust policy for each new cluster.</td>\n<td>Need to update role's trust policy with new EKS cluster OIDC provider endpoint.</td>\n</tr>\n<tr>\n<td><strong>Cluster Scalability</strong></td>\n<td>No need to setup IAM OIDC provider.</td>\n<td>Need to setup IAM OIDC provider. Default global limit of 100 OIDC providers for AWS account applies.</td>\n</tr>\n<tr>\n<td><strong>Role Scalability</strong></td>\n<td>No need to define trust relationship between IAM role and service account in the trust policy.</td>\n<td>Need to define trust relationship between IAM role and service account in the trust policy. Max of 8 trust relationships within a single trust policy applies due to limit on trust policy size.</td>\n</tr>\n<tr>\n<td><strong>Role Reusability</strong></td>\n<td>AWS STS temporary credentials supplied by EKS Pod Identity include role session tags, such as cluster name, namespace, service account name.</td>\n<td>AWS STS session tags are not supported. You can reuse a role between clusters but every pod receives all of the permissions of the role.</td>\n</tr>\n<tr>\n<td><strong>Environments Supported</strong></td>\n<td>Only available on Amazon EKS.</td>\n<td>IRSA can be used with Amazon EKS, Amazon EKS Anywhere, Red Hat OpenShift Service on AWS, and self-managed Kubernetes clusters on Amazon EC2 instances.</td>\n</tr>\n<tr>\n<td><strong>EKS Versions Supported</strong></td>\n<td>EKS Kubernetes versions 1.24 or later.</td>\n<td>All of the supported EKS cluster versions.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"pod-identity-hands-on\" style=\"position:relative;\"><a href=\"#pod-identity-hands-on\" aria-label=\"pod identity hands on permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Pod Identity hands-on</h2>\n<ul>\n<li><strong>Deploy the cluster:</strong></li>\n</ul>\n<p>Execute the following commands to provision the EKS Cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone https://github.com/seifrajhi/aws-eks-terraform.git\n<span class=\"token builtin class-name\">cd</span> aws-eks-terraform\nterraform init \nterraform plan \nterraform auto-approve</code></pre></div>\n<ul>\n<li><strong>Deploy Pod Identity agent:</strong></li>\n</ul>\n<p>To use EKS Pod Identity in your cluster, the EKS Pod Identity Agent addon must be installed on your EKS cluster.</p>\n<p>Let's install it using the below command.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws eks create-addon --cluster-name eks-pod-identity-demo --addon-name eks-pod-identity-agent\naws eks <span class=\"token function\">wait</span> addon-active --cluster-name eks-pod-identity-demo --addon-name eks-pod-identity-agent</code></pre></div>\n<p>Go to EKS Console and view the <code class=\"language-text\">eks-pod-identity-agent</code> under the <strong>Add-on</strong> tab.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDUlEQVR42j1Q2W4CMQzM//9VUV/6AlSoi0TD8cAewF7EyebybjplgdHIsi2PnYmoLtfj8URac4jl189psToslvJjef78buv21jRt1ymimXelur5HB0QiOu16bSMzR64zma+zYr29bXb3jXRmcN6bYXjTWquNIdLzInG91UVZKTOMkdvd6braajJTSiCUWutpfCLGqBQh4g7gnBN13aCVUmIXKJM+O6Q4QgmEgAmfXvAhwOCv3Eu5L6tKayMG6xRpTPPI6k7UKSTpKQ5938cQpmmay7K64BjOooNdAkYg/r/M3LTtuSjyPMd/WAfLAxEhwutMYx6Vc7N58X4V9qG21iHCDz8wu+UX3iWi8/4P5pyPQuv8GscAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"alt text\" title=\"\" src=\"/static/ade60ca3a154876d05609ad6bfc4b330/c5bb3/eks_addon.png\" srcset=\"/static/ade60ca3a154876d05609ad6bfc4b330/04472/eks_addon.png 170w,\n/static/ade60ca3a154876d05609ad6bfc4b330/9f933/eks_addon.png 340w,\n/static/ade60ca3a154876d05609ad6bfc4b330/c5bb3/eks_addon.png 680w,\n/static/ade60ca3a154876d05609ad6bfc4b330/5a190/eks_addon.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>You can also take a look at what has been created in your EKS cluster by the new addon:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl <span class=\"token parameter variable\">-n</span> kube-system get daemonset eks-pod-identity-agent\n\n<span class=\"token comment\"># Or </span>\n\n$ kubectl <span class=\"token parameter variable\">-n</span> kube-system get pods <span class=\"token parameter variable\">-l</span> app.kubernetes.io/name<span class=\"token operator\">=</span>eks-pod-identity-agent</code></pre></div>\n<ul>\n<li><strong>Deploy the sample app:</strong></li>\n</ul>\n<p>Below is the manifest we will be using:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>ns\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>sa\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>ns\n<span class=\"token punctuation\">---</span> \n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>ns\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n     <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>sa\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>app\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> amazon/aws<span class=\"token punctuation\">-</span>cli<span class=\"token punctuation\">:</span>latest\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'36000'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never</code></pre></div>\n<p>Run the below command to deploy the app:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl  apply <span class=\"token parameter variable\">-f</span> manifests.yaml</code></pre></div>\n<ul>\n<li><strong>Configure Amazon EKS Pod Identity:</strong></li>\n</ul>\n<p>Create a trust policy and configure the principal to <code class=\"language-text\">pods.eks.amazonaws.com</code>.</p>\n<p><strong>IAM_ROLE_TRUST_POLICY.json:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">\n<span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"Service\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pods.eks.amazonaws.com\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"sts:TagSession\"</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using the above trust policy, create the IAM role.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws iam create-role <span class=\"token punctuation\">\\</span>\n        --role-name eks-pod-s3-readonly-access <span class=\"token punctuation\">\\</span>\n        <span class=\"token parameter variable\">--description</span>  <span class=\"token string\">\"allow EKS pods readonly acces to S3\"</span> <span class=\"token punctuation\">\\</span>\n        --assume-role-policy-document file://IAM_ROLE_TRUST_POLICY.json <span class=\"token punctuation\">\\</span>\n        <span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\n        <span class=\"token parameter variable\">--query</span> <span class=\"token string\">'Role.Arn'</span></code></pre></div>\n<p>Then create the IAM Policy for S3 to list buckets and get Objects.</p>\n<p><strong>IAM_POLICY.json:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"s3:ListAllMyBuckets\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"s3:GetObject\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"s3:GetObjectTagging\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><strong>Create the IAM Policy:</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws iam create-policy --policy-name eks-pod-s3-readonly-access-policy --policy-document file://IAM_POLICY.json <span class=\"token parameter variable\">--output</span> text <span class=\"token parameter variable\">--query</span> Policy.Arn</code></pre></div>\n<ul>\n<li><strong>Attach the policy to the IAM Role:</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws iam attach-role-policy --role-name eks-pod-s3-readonly-access <span class=\"token punctuation\">\\</span>\n  --policy-arn eks-pod-s3-readonly-access-policy</code></pre></div>\n<p><strong>Create Pod Identity association:</strong></p>\n<p>Create the EKS Pod Identity association for the Service account demo-sa in Namespace demo-ns for the IAM Role <code class=\"language-text\">eks-pod-s3-readonly-access</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IAM_ROLE_ARN</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws iam get-role --role-name eks-pod-s3-readonly-access <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.Role.Arn'</span><span class=\"token variable\">)</span></span>\n\n$ aws eks create-pod-identity-association <span class=\"token punctuation\">\\</span>\n  --cluster-name eks-pod-identity-demo <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--namespace</span> demo-ns<span class=\"token punctuation\">\\</span>\n  --service-account demo-sa <span class=\"token punctuation\">\\</span>\n  --role-arn <span class=\"token variable\">$IAM_ROLE_ARN</span></code></pre></div>\n<p>We can get the list of current EKS Pod Identity associations using the below command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws eks list-pod-identity-associations --cluster-name eks-pod-identity-demo</code></pre></div>\n<ul>\n<li><strong>Test AWS EKS Pod Identity:</strong></li>\n</ul>\n<p>Run the below command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl <span class=\"token parameter variable\">-n</span> demo-ns <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> demo-app -- aws s3 <span class=\"token function\">ls</span></code></pre></div>\n<p>The App can list of S3 Buckets 🎉.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Conclusion</h2>\n<p>EKS Pod Identity is a great solution that lets you easily give your Kubernetes apps running on Amazon EKS the AWS permissions they need.</p>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>References</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/pod-identities.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.aws.amazon.com/eks/latest/userguide/pod-identities.html</a></li>\n<li><a href=\"https://securitylabs.datadoghq.com/articles/eks-pod-identity-deep-dive/\" target=\"_blank\" rel=\"noopener noreferrer\">https://securitylabs.datadoghq.com/articles/eks-pod-identity-deep-dive/</a></li>\n<li><a href=\"https://medium.com/@phanindra.sangers/eks-pod-identites-ca88c9cadac6\" target=\"_blank\" rel=\"noopener noreferrer\">https://medium.com/@phanindra.sangers/eks-pod-identites-ca88c9cadac6</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/containers/amazon-eks-pod-identity-a-new-way-for-applications-on-eks-to-obtain-iam-credentials/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/containers/amazon-eks-pod-identity-a-new-way-for-applications-on-eks-to-obtain-iam-credentials/</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, つづく 🎉</em></strong></p>\n<blockquote>\n<p>💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  <em><strong>Until next time 🎉</strong></em></p>\n</blockquote>\n<p>🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>♻️ LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>♻️ X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ✌🏻</strong></p>\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n<p><strong>📅 Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/aws-x-ray-distributed-tracing/","title":"Enabling distributed tracing for containerized apps with AWS X-Ray","date":"2024-10-16 21:00:00"},"excerpt":"End-to-end performance visibility of containerized Workloads on AWS🔥 📌 Introduction AWS X-Ray is a distributed tracing service that…","html":"<blockquote>\n<p><strong>End-to-end performance visibility of containerized Workloads on AWS🔥</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>📌 Introduction</h2>\n<p><a href=\"https://docs.aws.amazon.com/xray/latest/devguide/aws-xray.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS X-Ray</a> is a distributed tracing service that provides deep insights into how containerized applications perform on AWS. </p>\n<p>By instrumenting your containers with the X-Ray SDK and deploying the X-Ray daemon, you can gain end-to-end visibility into requests flowing through your containerized services running on ECS or EKS.</p>\n<blockquote>\n<p>X-Ray creates detailed trace maps that show how requests are processed across multiple components, helping you identify performance bottlenecks, debug issues, and optimize your containerized applications.</p>\n</blockquote>\n<p>In this post, we'll explore how to enable X-Ray tracing for containers on ECS and EKS, the key concepts and components involved, and best practices for instrumenting and deploying your containerized workloads with X-Ray.</p>\n<h2 id=\"tracing-with-awsx-ray\" style=\"position:relative;\"><a href=\"#tracing-with-awsx-ray\" aria-label=\"tracing with awsx ray permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Tracing with AWS X-Ray</h2>\n<p><a href=\"https://docs.aws.amazon.com/xray/latest/devguide/aws-xray.html\" target=\"_blank\" rel=\"noopener noreferrer\">X-Ray</a> creates detailed trace maps that show how requests are processed across multiple components, helping you identify performance bottlenecks, debug issues, and optimize your containerized applications. It integrates seamlessly with other AWS services like API Gateway, Lambda, EKS, ECS, and more to provide a comprehensive view of your distributed architecture.</p>\n<p><img src=\"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3peeq41tyum7hx5ljt7a.png\" alt=\"Image description\" loading=\"lazy\">\n          </p>\n<h3 id=\"instrumenting-containerized-applications-with-aws-x-ray\" style=\"position:relative;\"><a href=\"#instrumenting-containerized-applications-with-aws-x-ray\" aria-label=\"instrumenting containerized applications with aws x ray permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Instrumenting Containerized Applications with AWS X-Ray</h3>\n<p>Instrumenting your containerized application for X-Ray tracing involves sending trace data for incoming and outbound requests, along with metadata about each request.</p>\n<p>This is done by integrating the X-Ray SDK into your application code. Many instrumentation scenarios require only configuration changes, such as instrumenting all incoming HTTP requests and downstream calls to AWS services.</p>\n<p>There are several SDKs, agents, and tools that can be used to instrument your application for X-Ray tracing, depending on the language and framework you are using.</p>\n<p>Once instrumented, your application will send trace data to the X-Ray daemon, which collects and processes the data before sending it to the X-Ray service.</p>\n<h2 id=\"hands-on-example\" style=\"position:relative;\"><a href=\"#hands-on-example\" aria-label=\"hands on example permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Hands-On example</h2>\n<p>The first step is to install x-ray in our cluster. Let's use the <a href=\"https://github.com/okgolove/helm-charts/tree/master/charts/aws-xray\" target=\"_blank\" rel=\"noopener noreferrer\">okgolove/aws-xray</a> Helm chart.\nAdd the okgolove Helm repository.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ helm repo <span class=\"token function\">add</span> okgolove https://okgolove.github.io/helm-charts/</code></pre></div>\n<p>Create a <code class=\"language-text\">xray-values.yaml</code> file, see the default values in values.yaml:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">serviceAccount</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span> \n    <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>&lt;ACCOUNT_ID<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>role/XRayAccessRole\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws<span class=\"token punctuation\">-</span>xray\n<span class=\"token key atrule\">xray</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> eu<span class=\"token punctuation\">-</span>west<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">loglevel</span><span class=\"token punctuation\">:</span> pro</code></pre></div>\n<p>In order for the X-Ray daemon to communicate with the service, we should to create a Kubernetes service account and attach an AWS Identity and Access Management (IAM) role and policy with necessary permissions.</p>\n<p>For this, we will use eksctl</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">eksctl create iamserviceaccount <span class=\"token parameter variable\">--name</span> aws-xray <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--namespace</span> xray --role-name XRayAccessRole <span class=\"token parameter variable\">--cluster</span> aws-xray <span class=\"token punctuation\">\\</span> \n--attach-policy-arn arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--approve</span> --override-existing-serviceaccounts</code></pre></div>\n<p>Install the chart into the cluster, this will create a DaemonSet and a Service:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ helm <span class=\"token parameter variable\">-n</span> xray <span class=\"token function\">install</span> aws-xray okgolove/aws-xray <span class=\"token parameter variable\">-f</span> xray-values.yaml</code></pre></div>\n<p>This will deploy the X-Ray DaemonSet to the EKS cluster. The X-Ray daemon will be deployed to each worker node in the EKS cluster.\nFor reference, see the example implementation used in this module.</p>\n<h3 id=\"checking-x-ray-inaction\" style=\"position:relative;\"><a href=\"#checking-x-ray-inaction\" aria-label=\"checking x ray inaction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Checking X-Ray in action</h3>\n<p>The AWS X-Ray SDKs are used to instrument your microservices. When using the DaemonSet in the example implementation, you need to configure it to point to <code class=\"language-text\">aws-xray.xray:2000</code>.</p>\n<p>The following showcases how to configure the X-Ray SDK for Go. This is merely an example and not a required step in the workshop.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">func <span class=\"token function-name function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  xray.Configure<span class=\"token punctuation\">(</span>xray.Config<span class=\"token punctuation\">{</span>\n      DaemonAddr:     <span class=\"token string\">\"aws-xray.xray:2000\"</span>,\n      LogLevel:       <span class=\"token string\">\"info\"</span>,\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We now have the foundation in place to deploy microservices, which are instrumented with X-Ray SDKs, to the EKS cluster.</p>\n<p>In this step, we are going to deploy example front-end and back-end  microservices to the cluster.</p>\n<blockquote>\n<p>The example services are already instrumented using the X-Ray SDK for Go. Currently, X-Ray has SDKs for Go, Python, Node.js, Ruby, .NET and Java.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clome https://github.com/seifrajhi/aws-xray-eks-containers-tracing.git\n<span class=\"token builtin class-name\">cd</span> aws-xray-eks-containers-tracing/\nkubeclt apply <span class=\"token parameter variable\">-f</span> backend/x-ray-sample-back-k8s.yml\nkubectl apply <span class=\"token parameter variable\">-f</span> frontend/x-ray-sample-front-k8s.yml</code></pre></div>\n<p>To review the status of the deployments, you can run:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl describe deployments x-ray-sample-front-k8s x-ray-sample-back-k8s</code></pre></div>\n<p>For the status of the services, run the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl describe services x-ray-sample-front-k8s x-ray-sample-back-k8s</code></pre></div>\n<p>Once the front-end service is deployed, run the following command to get the Elastic Load Balancer (ELB) endpoint and open it in a browser.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get <span class=\"token function\">service</span> x-ray-sample-front-k8s <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>After your ELB is deployed and available, open up the endpoint returned by the previous command in your browser and allow it to remain open. The front-end application makes a new request to the /api endpoint once per second, which in turn calls the back-end service.\nThe JSON document displayed in the browser is the result of the request made to the back-end service.</p>\n<p>We now have the example microservices deployed, so we are going to investigate our Service Graph and Traces in X-Ray section of the AWS Management Console.</p>\n<p>The Service map in the console provides a visual representation of the steps identified by X-Ray for a particular trace. Each resource that sends data to X-Ray within the same context appears as a service in the graph.</p>\n<p>Next, go to the traces section in the AWS Management Console to view the execution times for the segments in the requests. At the top of the page, we can see the URL for the ELB endpoint and the corresponding traces below.</p>\n<p><img src=\"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9mdd2ry811mz9kn200s4.png\" alt=\"Image description\" loading=\"lazy\">\n          </p>\n<p>If you click on the link on the left in the Trace list section you will see the overall execution time for the request (0.5ms for the x-ray-sample-front-k8s which wraps other segments and subsegments), as well as a breakdown of the individual segments in the request.</p>\n<p>In this visualization, you can see the front-end and back-end segments and a subsegment named x-ray-sample-back-k8s-gen In the back-end service source code, we instrumented a subsegment that surrounds a random number generator.</p>\n<p>In the Go example, the main segment is initialized in the xray.Handler helper, which in turn sets all necessary information in the http.Request context struct, so that it can be used when initializing the subsegment.</p>\n<p><img src=\"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p8pyq9snjctsuib6cerm.png\" alt=\"Image description\" loading=\"lazy\">\n          </p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Conclusion</h2>\n<p>AWS X-Ray provides valuable end-to-end visibility into containerized applications on ECS and EKS, enabling teams to optimize performance, identify issues, and deliver reliable services. By instrumenting containers with the X-Ray SDK and deploying the daemon, developers can easily trace requests across microservices and AWS resources. The intuitive X-Ray console allows quick analysis of trace data for comprehensive insights.\nAs containerized architectures grow in complexity, X-Ray is a must-have tool for maintaining high-quality, performant applications on AWS.</p>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/xray/latest/devguide/aws-xray.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.aws.amazon.com/xray/latest/devguide/aws-xray.html</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/compute/application-tracing-on-kubernetes-with-aws-x-ray/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/compute/application-tracing-on-kubernetes-with-aws-x-ray/</a></li>\n<li><a href=\"https://aws-observability.github.io/observability-best-practices/guides/containers/aws-native/eks/container-tracing-with-aws-xray/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws-observability.github.io/observability-best-practices/guides/containers/aws-native/eks/container-tracing-with-aws-xray/</a></li>\n<li><a href=\"https://archive.eksworkshop.com/intermediate/245_x-ray/\" target=\"_blank\" rel=\"noopener noreferrer\">https://archive.eksworkshop.com/intermediate/245_x-ray/</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, つづく 🎉</em></strong></p>\n<blockquote>\n<p>💡 Thank you for Reading !! 🙌🏻😁📃, see you in the next blog.🤘  <em><strong>Until next time 🎉</strong></em></p>\n</blockquote>\n<p>🚀 Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>♻️ LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>♻️ X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ✌🏻</strong></p>\n<h1 align=\"center\">🔰 Keep Learning !! Keep Sharing !! 🔰</h1>\n<p><strong>📅 Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}