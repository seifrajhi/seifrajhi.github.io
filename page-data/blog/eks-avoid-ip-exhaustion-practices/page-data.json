{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/eks-avoid-ip-exhaustion-practices/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Avoid IP Exhaustion Problem with few practices</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üï∏ Introduction</h2>\n<p>Each Amazon EC2 instance supports a maximum number of elastic network interfaces and a maximum number of IP addresses that can be assigned to each network interface. Each node requires one IP address for each network interface. All other available IP addresses can be assigned to Pods.</p>\n<p>Each Pod requires its own IP address. As a result, you might have nodes that have available compute and memory resources, but can't accommodate additional Pods because the node has run out of IP addresses to assign to Pods. This issue is exacerbated by the limited number of IPv4 addresses available in VPCs.</p>\n<p>In this blog post, we will explore a few solutions to this problem and how to significantly increase the number of IP addresses that nodes can assign to Pods.</p>\n<h3 id=\"eks-vpc-cni-basics\" style=\"position:relative;\"><a href=\"#eks-vpc-cni-basics\" aria-label=\"eks vpc cni basics permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>EKS VPC CNI Basics</h3>\n<p>Pods are the smallest deployable units of computing that can be created and managed in Kubernetes. A pod requires a unique IP address to communicate in the Kubernetes cluster (host networking pods being an exception).</p>\n<p><a href=\"https://docs.aws.amazon.com/eks/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon Elastic Kubernetes Services (EKS)</a> by default runs the <a href=\"https://github.com/aws/amazon-vpc-cni-k8s\" target=\"_blank\" rel=\"noopener noreferrer\">VPC Container Networking Interface (CNI) Plugin</a> to assign IP addresses to a pod by managing network interfaces and IP addresses on EC2 instances.</p>\n<p>The VPC CNI plugin integrates directly with EC2 networking to provide high performance, low latency container networking in Kubernetes clusters running on AWS. This plugin assigns an IP address from the cluster's VPC to each pod.</p>\n<p>By default, the number of IP addresses available to assign to pods is based on the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI\" target=\"_blank\" rel=\"noopener noreferrer\">maximum number</a> of elastic network interfaces and secondary IPs per interface that can be attached to an EC2 instance type.</p>\n<p>When the <a href=\"https://github.com/aws/amazon-vpc-cni-k8s\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon VPC Container Network Interface (CNI) plugin</a> assigns IPv4 addresses to Pods, it allocates them from the VPC CIDR range assigned to the cluster.</p>\n<p>While it makes Pods first-class citizens within the VPC network, it often leads to exhaustion of the limited number of IPv4 addresses available in the VPCs. The long-term solution for addressing this issue is the adoption of IPv6; however, many customers aren't ready to make these types of decisions at the organization level.</p>\n<p>When an instance is created, EC2 creates and attaches a primary ENI associated with a primary subnet. The primary subnet may be public or private. The Pods that run in hostNetwork mode use the primary IP address assigned to the node primary ENI and share the same network namespace as the host.</p>\n<p>The CNI plugin manages <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html\" target=\"_blank\" rel=\"noopener noreferrer\">Elastic Network Interfaces (ENI)</a> on the node. When a node is provisioned, the CNI plugin automatically allocates a pool of slots (IPs or Prefixes) from the node's subnet to the primary ENI. This pool is known as the warm pool, and its size is determined by the node's instance type.</p>\n<p>Depending on CNI settings, a slot may be an IP address or a prefix. When a slot on an ENI has been assigned, the CNI may attach additional ENIs with a warm pool of slots to the nodes.</p>\n<p>These additional ENIs are called Secondary ENIs. Each ENI can only support a certain number of slots, based on instance type. The CNI attaches more ENIs to instances based on the number of slots needed, which usually corresponds to the number of Pods.</p>\n<p>This process continues until the node can no longer support additional ENIs. The CNI also pre-allocates \"warm\" ENIs and slots for faster Pod startup. Note each instance type has a maximum number of ENIs that may be attached. This is one constraint on Pod density (number of Pods per node), in addition to compute resources.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkElEQVR42mNgaL09nQEIhEXFW6SlpR+IiIis////P5OKioqoqqrqZjMzs3OGhobXxcXFG4DijPX19SyCgoKTlZSUngrw8c0FamUCYuYP7OzZnzk58xiABm4CGSgoLDoXaOB/ISGhM4sWLeJ2d3dX19LSumhtbf3e2Nj4F9DAadu2beMDGsgHNHCpvLz8bwEBgfVAraxAzPFOQKj6g5BQHQMD0FYGCADZLpebm8vOgARaW1vFOzs7eZHF0tLSWLu7uxVnzpzJyoADgA0FGiixatUqZhD7P9QioEYxoEYuZDGQN5OTk4WQ+Az/GRhYQJgBZsC9e/fS7ty9s+H+/fvdHh4eYFdeu3bN586dO+uBeO769etlYYYB1RQC1a8H4nKYY+AAaAsLiH778u3Et8/efnv36t0RYJiBXXTx4sWs69evfwEafHfDhg3qMAOfPXu29O3bt/+fP3++HskcRhTvSk2WEhZuF3YS7xZXRFYEinEQRnbE/v37WYARxI49DOsZIIp7GSwYOhmOAnEKijiJAAB9Uq3P4H+V6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Warm Pool\" title=\"\" src=\"/static/191eaf733938e9a7cb706de71dbff78f/c5bb3/warm.png\" srcset=\"/static/191eaf733938e9a7cb706de71dbff78f/04472/warm.png 170w,\n/static/191eaf733938e9a7cb706de71dbff78f/9f933/warm.png 340w,\n/static/191eaf733938e9a7cb706de71dbff78f/c5bb3/warm.png 680w,\n/static/191eaf733938e9a7cb706de71dbff78f/5a190/warm.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"-ec2-instance-limits\" style=\"position:relative;\"><a href=\"#-ec2-instance-limits\" aria-label=\" ec2 instance limits permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìä EC2 Instance Limits</h3>\n<p>The maximum number of network interfaces, and the maximum number of slots that you can use varies by the type of EC2 Instance.</p>\n<p>Since each Pod consumes an IP address on a slot, the number of Pods you can run on a particular EC2 Instance depends on how many ENIs can be attached to it and how many slots each ENI supports. We suggest setting the maximum Pods per <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/pod-configuration.html\" target=\"_blank\" rel=\"noopener noreferrer\">EKS user guide</a> to avoid exhaustion of the instance's CPU and memory resources. Pods using hostNetwork are excluded from this calculation. You may consider using a script called <a href=\"https://github.com/awslabs/amazon-eks-ami/blob/master/files/max-pods-calculator.sh\" target=\"_blank\" rel=\"noopener noreferrer\">max-pod-calculator.sh</a> to calculate EKS's recommended maximum Pods for a given instance type.</p>\n<h3 id=\"-consider-another-cni\" style=\"position:relative;\"><a href=\"#-consider-another-cni\" aria-label=\" consider another cni permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîÑ Consider Another CNI?</h3>\n<p>You can disable native AWS IPs provisioning by using another CNI. IPv4 management will work in the following way:</p>\n<ul>\n<li>IP addresses of pods are scoped to the internal network.</li>\n<li>Pods are not directly reachable from outside the cluster.</li>\n<li>Every pod uses the primary node ENI.</li>\n</ul>\n<p>However, there are many benefits you lose by dropping the VPC CNI:</p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html\" target=\"_blank\" rel=\"noopener noreferrer\">Security group for pods</a></li>\n<li>Pod identification in <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html\" target=\"_blank\" rel=\"noopener noreferrer\">VPC flow logs</a></li>\n<li><a href=\"https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.6/deploy/pod_readiness_gate/\" target=\"_blank\" rel=\"noopener noreferrer\">Pod readiness gate</a> with load balancer controller</li>\n<li>Simpler networking: no overlay network, you use the network provided by Amazon VPC</li>\n</ul>\n<p>We will focus in this article on keeping the usage of VPC CNI.</p>\n<h2 id=\"optimize-ip-address-utilization\" style=\"position:relative;\"><a href=\"#optimize-ip-address-utilization\" aria-label=\"optimize ip address utilization permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Optimize IP Address Utilization</h2>\n<p>When designing your AWS networking architecture, it is important to optimize Amazon EKS IP consumption at the VPC and at the node level. This will help you mitigate IP exhaustion issues and increase the pod density per node. In this section, we will discuss techniques that can help you achieve these goals.</p>\n<h3 id=\"optimize-node-level-ip-consumption\" style=\"position:relative;\"><a href=\"#optimize-node-level-ip-consumption\" aria-label=\"optimize node level ip consumption permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Optimize Node-Level IP Consumption</h3>\n<p><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html\" target=\"_blank\" rel=\"noopener noreferrer\">Prefix delegation</a> is a feature that allocates a prefix (/28 for IPv4 and /80 for IPv6) instead of a secondary IP in the ENIs subnet. The total number of prefixes and private IP addresses will be less than the limit on private IPs allowed by your instance. Setting or resetting of <code class=\"language-text\">ENABLE_PREFIX_DELEGATION</code> while pods are running or if ENIs are attached is supported and the new pods allocated will get IPs based on the mode of IPAMD but the max pods of kubelet should be updated which would need either kubelet restart or node recycle.</p>\n<p>Setting <code class=\"language-text\">ENABLE_PREFIX_DELEGATION</code> to true will not increase the density of branch ENI pods. The limit on the number of branch <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html#supported-instance-types\" target=\"_blank\" rel=\"noopener noreferrer\">network interfaces per instance type will remain the same</a>. Each branch network will be allocated a primary IP and this IP will be allocated for the branch ENI pods.</p>\n<p>Please refer to the <a href=\"https://github.com/aws/amazon-vpc-cni-k8s#vpc-cni-feature-matrix\" target=\"_blank\" rel=\"noopener noreferrer\">VPC CNI Feature Matrix section</a> below for additional information around using Prefix delegation with Custom Networking and Security Groups Per Pod features.</p>\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>It is highly recommended that you create new node groups to increase the number of available IP addresses rather than doing rolling replacement of existing worker nodes. Cordon and drain all the existing nodes to safely evict all of your existing Pods. To prevent service disruptions, we suggest implementing <a href=\"https://kubernetes.io/docs/tasks/run-application/configure-pdb\">Pod Disruption Budgets</a> on your production clusters for critical workloads. Pods on new nodes will be assigned an IP from a prefix assigned to an ENI.</p>\n</div>\n<h3 id=\"-custom-networking\" style=\"position:relative;\"><a href=\"#-custom-networking\" aria-label=\" custom networking permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê Custom Networking</h3>\n<p><code class=\"language-text\">AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true</code></p>\n<p>Custom networking provides a solution to the IP exhaustion issue by assigning the Pod IPs from secondary VPC address spaces (e.g., CIDR). When custom networking is enabled in VPC CNI, it creates secondary ENIs in the subnet defined under a custom resource named ENIConfig that includes an alternate subnet CIDR range created from a secondary VPC CIDR. The VPC CNI assigns Pods IP addresses from the CIDR range defined in the ENIConfig custom resource.</p>\n<p>The diagram below shows an overview of the solution:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFUlEQVR42mNggABGMFnPwGc6xdVu497DQfM3LrEunF0vlNSZLVWyaopE17blylHTKgQ9Jqqwe0z0YLevD+WRrJfkguuFgSdPX6x5+uL11mevP2SA+Auq45TPdmfZXbp0x+vomqUaLQVVksfWz9S9tGN9wP+Juew+kWdE0qoOSv4PZWD2menDxSCux82gG6QExiD2x0+f/4PA87efFwDNY2NI28T1eaJz7q85AfUMof/ZGBj+M/2fZj391TTLUJCFPu1vNjo0fCsGsUM7yvmBFDNDzCIxhgwgZqhnYnjx8vX/Hz9+/r9858liBhUPPoak/7z3p8YkPpwV281g9Zp3QnerztvZkf0Wq/x1GXrCZX2an/R7VD9UBhno1+nHi+Hlm/cezrl55/6Sy9dux4H4h6MYBF/3hPq9PbTG+n+oFs82j1z2N/2+QXd7zG0YljII+mSddY7KXq8L9DIb2EBxPTEGH0sNMJYwEEUxPL7engNE/5lkX/h7ptt8EPtRr4XQ31nOB/8vsFJm6J0tFDjh0x3H+l9WILno+mg+IMXEMDOUn2GxBx/YtatWrWIGYWAwMmrVA8MQCB7OTLS5NzcrDMQ+O7te5cbyhlgQu6N8N79P/dOUiR4T2UEuDK2358HwMgqoZ2DR63blDl1Vz5aWlsaa1GnFmzbTmAuIWesnevBlTQnl+f+/nqkU6FUQWxIoBzUQhhkAoaXRiUUKpQwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Custom Networking with Internal SNAT\" title=\"\" src=\"/static/96ea621963d34c752beb018db323eed5/c5bb3/custom.png\" srcset=\"/static/96ea621963d34c752beb018db323eed5/04472/custom.png 170w,\n/static/96ea621963d34c752beb018db323eed5/9f933/custom.png 340w,\n/static/96ea621963d34c752beb018db323eed5/c5bb3/custom.png 680w,\n/static/96ea621963d34c752beb018db323eed5/5a190/custom.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\">Custom networking with internal SNAT</div>\n<p>We create dedicated subnets for the pods. These ones should not be routable from outside the VPC (we can call these subnets internal). New subnets can have any CIDR block, but a good choice is to use <a href=\"https://en.wikipedia.org/wiki/Carrier-grade_NAT\" target=\"_blank\" rel=\"noopener noreferrer\">CG-NAT space</a> because companies don't usually use these ranges for private networks.</p>\n<p>Use custom networking to use the new subnets for pods ENIs (more information on <a href=\"https://aws.github.io/aws-eks-best-practices/networking/custom-networking/#example-configuration\" target=\"_blank\" rel=\"noopener noreferrer\">EKS best practices guide</a>). Internal SNAT is enabled by default when using custom networking (see <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS documentation</a>).</p>\n<p>With this configuration:</p>\n<ul>\n<li>Network flow from pod to pod will not be NAT-ed. You will see pods IPs in the VPC flow logs.</li>\n<li>Network flow from a load balancer in the same VPC to any pod is possible without any NAT.</li>\n<li>Network flow from a pod to an address IP not associated with a pod is NAT-ed through the primary node ENI.</li>\n<li>Ingress traffic from outside the VPC to the pods should pass through a load balancer (a.k.a layer 4 proxy) located in non-internal subnets.</li>\n<li>You can create as many subnets with overlapping CIDR in different VPCs as you want.</li>\n</ul>\n<h3 id=\"vpc-cni-tweaking\" style=\"position:relative;\"><a href=\"#vpc-cni-tweaking\" aria-label=\"vpc cni tweaking permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>VPC CNI Tweaking</h3>\n<p>With the default configuration, the VPC CNI keeps an entire ENI (and associated IPs) in the warm pool. This may consume a large number of IPs, especially on larger instance types. If your cluster subnet has a limited number of IP addresses available, scrutinize these VPC CNI configuration environment variables:</p>\n<ul>\n<li><code class=\"language-text\">WARM_IP_TARGET</code></li>\n<li><code class=\"language-text\">MINIMUM_IP_TARGET</code></li>\n<li><code class=\"language-text\">WARM_ENI_TARGET</code></li>\n</ul>\n<p>You can configure the value of <code class=\"language-text\">MINIMUM_IP_TARGET</code> to closely match the number of Pods you expect to run on your nodes. Doing so will ensure that as Pods get created, the CNI can assign IP addresses from the warm pool without calling the EC2 API.</p>\n<blockquote>\n<p><strong>Note:</strong> Setting the value of <code class=\"language-text\">WARM_IP_TARGET</code> too low will cause additional calls to the EC2 API, which might cause throttling of the requests. For large clusters, use it along with <code class=\"language-text\">MINIMUM_IP_TARGET</code> to avoid throttling of the requests.</p>\n</blockquote>\n<p>To configure these options, you can download the <a href=\"https://github.com/aws/amazon-vpc-cni-k8s/releases\" target=\"_blank\" rel=\"noopener noreferrer\">aws-k8s-cni.yaml</a> manifest and set the environment variables. Ensure the version of the configuration value matches the installed VPC CNI version.</p>\n<h3 id=\"-adopt-ipv6\" style=\"position:relative;\"><a href=\"#-adopt-ipv6\" aria-label=\" adopt ipv6 permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê Adopt IPv6</h3>\n<p>Adopting IPv6 is the easiest way to work around the <a href=\"https://tools.ietf.org/html/rfc1918\" target=\"_blank\" rel=\"noopener noreferrer\">RFC1918</a> limitations. We strongly recommend you consider adopting IPv6 as your first option when choosing a network architecture. IPv6 provides a significantly larger total IP address space, allowing cluster administrators to focus on migrating and scaling applications without devoting effort towards working around IPv4 limits.</p>\n<p>Amazon EKS clusters support both IPv4 and IPv6. By default, EKS clusters use IPv4 address space. Specifying an IPv6-based address space at cluster creation time will enable the use of IPv6. In an IPv6 EKS cluster, Pods and services receive IPv6 addresses while maintaining the ability for legacy IPv4 endpoints to connect to services running on IPv6 clusters and vice versa. All the pod-to-pod communication within a cluster always occurs over IPv6. Within a VPC (/56), the IPv6 CIDR block size for IPv6 subnets is fixed at /64. This provides 2‚Å∂‚Å¥ (approximately 18 quintillion) IPv6 addresses, allowing you to scale your deployments on EKS.</p>\n<p>For detailed information, please see the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/cni-ipv6.html\" target=\"_blank\" rel=\"noopener noreferrer\">Running IPv6 EKS Clusters</a> section and for hands-on experience, please see the <a href=\"https://eksworkshop.com/beginner/170_ipv6/\" target=\"_blank\" rel=\"noopener noreferrer\">Understanding IPv6 on Amazon EKS</a> section of the Get hands-on with IPv6 workshop.</p>\n<p><img src=\"/122ab66ed95c184d7d525fedd0b02a7b/ipv6.gif\" alt=\"IPv6\" loading=\"lazy\">\n          </p>\n<h2 id=\"-conclusion\" style=\"position:relative;\"><a href=\"#-conclusion\" aria-label=\" conclusion permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèÅ Conclusion</h2>\n<p>In this blog, we discussed strategies to tackle IPv4 address exhaustion in Amazon EKS clusters. We explored the use of custom networking, minimizing private address space consumption, optimizing IP address utilization, and considering the adoption of IPv6 as long-term solutions. These approaches can effectively mitigate the challenges posed by IPv4 address exhaustion in Amazon EKS clusters, ensuring efficient address allocation and usage.</p>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/containers/automating-custom-networking-to-solve-ipv4-exhaustion-in-amazon-eks\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/containers/automating-custom-networking-to-solve-ipv4-exhaustion-in-amazon-eks</a></li>\n<li><a href=\"https://aws.github.io/aws-eks-best-practices/networking/vpc-cni\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.github.io/aws-eks-best-practices/networking/vpc-cni</a></li>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html</a></li>\n<li><a href=\"https://medium.com/ekino-france/kubernetes-addressing-private-ipv4-shortage-5-strategies-for-amazon-eks-1dc3df270ed8\" target=\"_blank\" rel=\"noopener noreferrer\">https://medium.com/ekino-france/kubernetes-addressing-private-ipv4-shortage-5-strategies-for-amazon-eks-1dc3df270ed8</a></li>\n</ul>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":8,"rawMarkdownBody":"\n> **Avoid IP Exhaustion Problem with few practices**\n\n## üï∏ Introduction\n\nEach Amazon EC2 instance supports a maximum number of elastic network interfaces and a maximum number of IP addresses that can be assigned to each network interface. Each node requires one IP address for each network interface. All other available IP addresses can be assigned to Pods.\n\nEach Pod requires its own IP address. As a result, you might have nodes that have available compute and memory resources, but can't accommodate additional Pods because the node has run out of IP addresses to assign to Pods. This issue is exacerbated by the limited number of IPv4 addresses available in VPCs.\n\nIn this blog post, we will explore a few solutions to this problem and how to significantly increase the number of IP addresses that nodes can assign to Pods.\n\n### EKS VPC CNI Basics\n\nPods are the smallest deployable units of computing that can be created and managed in Kubernetes. A pod requires a unique IP address to communicate in the Kubernetes cluster (host networking pods being an exception).\n\n[Amazon Elastic Kubernetes Services (EKS)](https://docs.aws.amazon.com/eks/index.html) by default runs the [VPC Container Networking Interface (CNI) Plugin](https://github.com/aws/amazon-vpc-cni-k8s) to assign IP addresses to a pod by managing network interfaces and IP addresses on EC2 instances.\n\nThe VPC CNI plugin integrates directly with EC2 networking to provide high performance, low latency container networking in Kubernetes clusters running on AWS. This plugin assigns an IP address from the cluster's VPC to each pod.\n\nBy default, the number of IP addresses available to assign to pods is based on the [maximum number](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI) of elastic network interfaces and secondary IPs per interface that can be attached to an EC2 instance type.\n\nWhen the [Amazon VPC Container Network Interface (CNI) plugin](https://github.com/aws/amazon-vpc-cni-k8s) assigns IPv4 addresses to Pods, it allocates them from the VPC CIDR range assigned to the cluster.\n\nWhile it makes Pods first-class citizens within the VPC network, it often leads to exhaustion of the limited number of IPv4 addresses available in the VPCs. The long-term solution for addressing this issue is the adoption of IPv6; however, many customers aren't ready to make these types of decisions at the organization level.\n\nWhen an instance is created, EC2 creates and attaches a primary ENI associated with a primary subnet. The primary subnet may be public or private. The Pods that run in hostNetwork mode use the primary IP address assigned to the node primary ENI and share the same network namespace as the host.\n\nThe CNI plugin manages [Elastic Network Interfaces (ENI)](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html) on the node. When a node is provisioned, the CNI plugin automatically allocates a pool of slots (IPs or Prefixes) from the node's subnet to the primary ENI. This pool is known as the warm pool, and its size is determined by the node's instance type.\n\nDepending on CNI settings, a slot may be an IP address or a prefix. When a slot on an ENI has been assigned, the CNI may attach additional ENIs with a warm pool of slots to the nodes.\n\nThese additional ENIs are called Secondary ENIs. Each ENI can only support a certain number of slots, based on instance type. The CNI attaches more ENIs to instances based on the number of slots needed, which usually corresponds to the number of Pods.\n\nThis process continues until the node can no longer support additional ENIs. The CNI also pre-allocates \"warm\" ENIs and slots for faster Pod startup. Note each instance type has a maximum number of ENIs that may be attached. This is one constraint on Pod density (number of Pods per node), in addition to compute resources.\n\n![Warm Pool](warm.png)\n### üìä EC2 Instance Limits\n\nThe maximum number of network interfaces, and the maximum number of slots that you can use varies by the type of EC2 Instance.\n\nSince each Pod consumes an IP address on a slot, the number of Pods you can run on a particular EC2 Instance depends on how many ENIs can be attached to it and how many slots each ENI supports. We suggest setting the maximum Pods per [EKS user guide](https://docs.aws.amazon.com/eks/latest/userguide/pod-configuration.html) to avoid exhaustion of the instance's CPU and memory resources. Pods using hostNetwork are excluded from this calculation. You may consider using a script called [max-pod-calculator.sh](https://github.com/awslabs/amazon-eks-ami/blob/master/files/max-pods-calculator.sh) to calculate EKS's recommended maximum Pods for a given instance type.\n\n### üîÑ Consider Another CNI?\n\nYou can disable native AWS IPs provisioning by using another CNI. IPv4 management will work in the following way:\n- IP addresses of pods are scoped to the internal network.\n- Pods are not directly reachable from outside the cluster.\n- Every pod uses the primary node ENI.\n\nHowever, there are many benefits you lose by dropping the VPC CNI:\n- [Security group for pods](https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html)\n- Pod identification in [VPC flow logs](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html)\n- [Pod readiness gate](https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.6/deploy/pod_readiness_gate/) with load balancer controller\n- Simpler networking: no overlay network, you use the network provided by Amazon VPC\n\nWe will focus in this article on keeping the usage of VPC CNI.\n\n## Optimize IP Address Utilization\n\nWhen designing your AWS networking architecture, it is important to optimize Amazon EKS IP consumption at the VPC and at the node level. This will help you mitigate IP exhaustion issues and increase the pod density per node. In this section, we will discuss techniques that can help you achieve these goals.\n\n### Optimize Node-Level IP Consumption\n\n[Prefix delegation](https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html) is a feature that allocates a prefix (/28 for IPv4 and /80 for IPv6) instead of a secondary IP in the ENIs subnet. The total number of prefixes and private IP addresses will be less than the limit on private IPs allowed by your instance. Setting or resetting of `ENABLE_PREFIX_DELEGATION` while pods are running or if ENIs are attached is supported and the new pods allocated will get IPs based on the mode of IPAMD but the max pods of kubelet should be updated which would need either kubelet restart or node recycle.\n\nSetting `ENABLE_PREFIX_DELEGATION` to true will not increase the density of branch ENI pods. The limit on the number of branch [network interfaces per instance type will remain the same](https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html#supported-instance-types). Each branch network will be allocated a primary IP and this IP will be allocated for the branch ENI pods.\n\nPlease refer to the [VPC CNI Feature Matrix section](https://github.com/aws/amazon-vpc-cni-k8s#vpc-cni-feature-matrix) below for additional information around using Prefix delegation with Custom Networking and Security Groups Per Pod features.\n\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>It is highly recommended that you create new node groups to increase the number of available IP addresses rather than doing rolling replacement of existing worker nodes. Cordon and drain all the existing nodes to safely evict all of your existing Pods. To prevent service disruptions, we suggest implementing <a href=\"https://kubernetes.io/docs/tasks/run-application/configure-pdb\">Pod Disruption Budgets</a> on your production clusters for critical workloads. Pods on new nodes will be assigned an IP from a prefix assigned to an ENI.</p>\n</div>\n\n### üåê Custom Networking\n\n`AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true`\n\nCustom networking provides a solution to the IP exhaustion issue by assigning the Pod IPs from secondary VPC address spaces (e.g., CIDR). When custom networking is enabled in VPC CNI, it creates secondary ENIs in the subnet defined under a custom resource named ENIConfig that includes an alternate subnet CIDR range created from a secondary VPC CIDR. The VPC CNI assigns Pods IP addresses from the CIDR range defined in the ENIConfig custom resource.\n\nThe diagram below shows an overview of the solution:\n\n![Custom Networking with Internal SNAT](./custom.png \"Custom Networking with Internal SNAT\")\n<div class=\"image-title\">Custom networking with internal SNAT</div>\n\nWe create dedicated subnets for the pods. These ones should not be routable from outside the VPC (we can call these subnets internal). New subnets can have any CIDR block, but a good choice is to use [CG-NAT space](https://en.wikipedia.org/wiki/Carrier-grade_NAT) because companies don't usually use these ranges for private networks.\n\nUse custom networking to use the new subnets for pods ENIs (more information on [EKS best practices guide](https://aws.github.io/aws-eks-best-practices/networking/custom-networking/#example-configuration)). Internal SNAT is enabled by default when using custom networking (see [AWS documentation](https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html)).\n\nWith this configuration:\n\n- Network flow from pod to pod will not be NAT-ed. You will see pods IPs in the VPC flow logs.\n- Network flow from a load balancer in the same VPC to any pod is possible without any NAT.\n- Network flow from a pod to an address IP not associated with a pod is NAT-ed through the primary node ENI.\n- Ingress traffic from outside the VPC to the pods should pass through a load balancer (a.k.a layer 4 proxy) located in non-internal subnets.\n- You can create as many subnets with overlapping CIDR in different VPCs as you want.\n  \n### VPC CNI Tweaking\n\nWith the default configuration, the VPC CNI keeps an entire ENI (and associated IPs) in the warm pool. This may consume a large number of IPs, especially on larger instance types. If your cluster subnet has a limited number of IP addresses available, scrutinize these VPC CNI configuration environment variables:\n\n- `WARM_IP_TARGET`\n- `MINIMUM_IP_TARGET`\n- `WARM_ENI_TARGET`\n\nYou can configure the value of `MINIMUM_IP_TARGET` to closely match the number of Pods you expect to run on your nodes. Doing so will ensure that as Pods get created, the CNI can assign IP addresses from the warm pool without calling the EC2 API.\n\n> **Note:** Setting the value of `WARM_IP_TARGET` too low will cause additional calls to the EC2 API, which might cause throttling of the requests. For large clusters, use it along with `MINIMUM_IP_TARGET` to avoid throttling of the requests.\n\nTo configure these options, you can download the [aws-k8s-cni.yaml](https://github.com/aws/amazon-vpc-cni-k8s/releases) manifest and set the environment variables. Ensure the version of the configuration value matches the installed VPC CNI version.\n\n### üåê Adopt IPv6\n\nAdopting IPv6 is the easiest way to work around the [RFC1918](https://tools.ietf.org/html/rfc1918) limitations. We strongly recommend you consider adopting IPv6 as your first option when choosing a network architecture. IPv6 provides a significantly larger total IP address space, allowing cluster administrators to focus on migrating and scaling applications without devoting effort towards working around IPv4 limits.\n\nAmazon EKS clusters support both IPv4 and IPv6. By default, EKS clusters use IPv4 address space. Specifying an IPv6-based address space at cluster creation time will enable the use of IPv6. In an IPv6 EKS cluster, Pods and services receive IPv6 addresses while maintaining the ability for legacy IPv4 endpoints to connect to services running on IPv6 clusters and vice versa. All the pod-to-pod communication within a cluster always occurs over IPv6. Within a VPC (/56), the IPv6 CIDR block size for IPv6 subnets is fixed at /64. This provides 2‚Å∂‚Å¥ (approximately 18 quintillion) IPv6 addresses, allowing you to scale your deployments on EKS.\n\nFor detailed information, please see the [Running IPv6 EKS Clusters](https://docs.aws.amazon.com/eks/latest/userguide/cni-ipv6.html) section and for hands-on experience, please see the [Understanding IPv6 on Amazon EKS](https://eksworkshop.com/beginner/170_ipv6/) section of the Get hands-on with IPv6 workshop.\n\n![IPv6](./ipv6.gif)\n\n## üèÅ Conclusion\n\nIn this blog, we discussed strategies to tackle IPv4 address exhaustion in Amazon EKS clusters. We explored the use of custom networking, minimizing private address space consumption, optimizing IP address utilization, and considering the adoption of IPv6 as long-term solutions. These approaches can effectively mitigate the challenges posed by IPv4 address exhaustion in Amazon EKS clusters, ensuring efficient address allocation and usage.\n\n**References:**\n\n- https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/\n- https://aws.amazon.com/blogs/containers/automating-custom-networking-to-solve-ipv4-exhaustion-in-amazon-eks\n- https://aws.github.io/aws-eks-best-practices/networking/vpc-cni\n- https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html\n- https://medium.com/ekino-france/kubernetes-addressing-private-ipv4-shortage-5-strategies-for-amazon-eks-1dc3df270ed8\n\n<br>\n\n**_Until next time, „Å§„Å•„Åè üéâ_**\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  _**Until next time üéâ**_\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1827},"frontmatter":{"id":"b28f8f9f08afb7f2eb636dd9","path":"/blog/eks-avoid-ip-exhaustion-practices/","humanDate":"Oct 20, 2024","fullDate":"2024-10-20","title":"Tackling IPv4 Address Exhaustion in Amazon EKS Clusters","keywords":["AWS EKS","IPv4 exhaustion","Cloud networking","Kubernetes","Best practices"],"excerpt":"Discover effective practices to avoid IPv4 address exhaustion in Amazon EKS clusters.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHUlEQVR42oWSvWtTURiHT5LrvbFJyW2aNLV+FBGhQh0qojVpLRHbJEaapgkI+YBUCAnoIOiikk3pYJMlH4UudZBAEgRNoWRxytDo5uAfoIuDa0G3x3tvSGil4PBw7nnveX/nd973FSaTCQOzhFnDZDIzjJ2A2Ww2+Dc2+BYmi6UvIgRCo39AOnZQkiRkWTZWHT1u0fIG4kcvEYaQtpGnfahTPi3BZgjrifoaCARot9vs7OxQLBZZW1sjm81SKpWGBo5eLk5NzuLId1FffmMu9J6F9c+MT93u/zQEgxQKBTKZDKlUCr/fTy6XIxgM4nK5cDgcjI6OYrPZUBQF4Xp9iHvzN9YbWVxn77AQ/8K93CHK2BLPnj7iw8c2lUqFer1OuVym0Wiwvb1Ns9lkd3eXVqtFp9Oh1+vh8/kQ7iIoc0k8E17GPDcZcVxi+eEvzlzOcP3ajPa8HIlEgnQ6zcbGBvl8nmQySSQSYXFx0ShBNBpldXUVVVU1wTcgz65z/mKMiQsBrfgqy6nvnJvJYpWF5qxBt9tlb2/PcKM7qdVqVKtVDg4O2N/fN56tl0evo3BvgZr9hOK5yoh7Fntwk+n7b3FOLmG3SczPe/F6vYTDYVZWVojH44a7WCxmuAqFQse6L07feozzxU+cz3+gPvnK+Ks/WO8WtKaIYWP+x3AG+3uBxe7BHt7C8eAd0sQVYyb12RzMm87AxUkMxGTFzl8DYUHBbV94RAAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png","srcSet":"/static/bf08e50f4212e5674c7df214e1b033c7/ad69c/ip-eks-cover.png 750w,\n/static/bf08e50f4212e5674c7df214e1b033c7/1c373/ip-eks-cover.png 800w","sizes":"100vw"},"sources":[{"srcSet":"/static/bf08e50f4212e5674c7df214e1b033c7/58527/ip-eks-cover.webp 750w,\n/static/bf08e50f4212e5674c7df214e1b033c7/5ceac/ip-eks-cover.webp 800w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.48125000000000007}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/dapr-kubernetes-event-driven-runtime-part1/","title":"Dapr: A portable, Event-Driven runtime for building distributed applications; Part1","date":"2024-10-20 22:06:00"},"excerpt":"A Beginner's Guide üìó Distributed applications are becoming increasingly popular, as they offer a number of advantages over traditional‚Ä¶","html":"<blockquote>\n<p><strong>A Beginner's Guide üìó</strong></p>\n</blockquote>\n<p>Distributed applications are becoming increasingly popular, as they offer a number of advantages over traditional monolithic applications. However, building and running distributed applications can be complex and challenging.</p>\n<p><a href=\"https://docs.dapr.io/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr</a> is a portable, event-driven runtime that makes it easy to build and run distributed applications across the cloud and edge. It provides a set of building blocks that developers can use to easily build and run microservices, event-driven applications, and stateful applications.</p>\n<p>In this blog post, we will introduce Dapr and discuss its benefits and features. We will also show you how to get started with Dapr by building a simple microservices application.</p>\n<h2 id=\"what-is-dapr\" style=\"position:relative;\"><a href=\"#what-is-dapr\" aria-label=\"what is dapr permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>What is Dapr?</h2>\n<p><a href=\"https://docs.dapr.io/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr</a> is a portable, event-driven runtime that makes it easy for any developer to build resilient, stateless, and stateful applications that run on the cloud and edge and embraces the diversity of languages and developer frameworks. Leveraging the benefits of a sidecar architecture, Dapr helps you tackle the challenges that come with building microservices and keeps your code platform agnostic.</p>\n<h3 id=\"introduction-to-the-distributed-application-runtime\" style=\"position:relative;\"><a href=\"#introduction-to-the-distributed-application-runtime\" aria-label=\"introduction to the distributed application runtime permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Introduction to the Distributed Application Runtime</h3>\n<p>Dapr is a portable, event-driven runtime that makes it easy for any developer to build resilient, stateless, and stateful applications that run on the cloud and edge and embraces the diversity of languages and developer frameworks.</p>\n<h3 id=\"any-language-any-framework-anywhere\" style=\"position:relative;\"><a href=\"#any-language-any-framework-anywhere\" aria-label=\"any language any framework anywhere permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Any Language, Any Framework, Anywhere</h3>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 48.8235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLUlEQVR42jWSS2gTQRjH9yBIwcehhx5KEUXwQS8t6LF6tiCiBym5qAdLBaGHFhTx0oIHD/VgkEoOtVQvLa2P2EcS4pKqpDHQNLG0hrax2zw2dje7Mzs7O7NvZxP95uOb+R4/+PMxnOd5ruu2ous6jhNk7DKaZlrEadWCltOcYjEYwBhzlFJd1xFCBiGImoQSjJFpWTu7u8K+sLdTocS0WZFQg5gI6YRSVVUty9Y0jWMvRVEOJUnR9CI0gY5EqUopaSiSjo2NNIAAs0GhDiqStr0tKCrieZ4hhBDObhoT4vv/3fM0g0mgvmvajqUalu16vs/8nzHpTG8At/LknvEqo0bW/kS+VyOpUji+9XIpN7mUnf6UmZxLTc0nZhYS03PLM7PRyJvZL6k0QyDUuGyuVi5J92KIGxc6JorHn2bahmPHBt8dDYXbbj07NfC8q3+088rd9su323uunzzfd+Ti1dDIGIMBhJysGBTRoYX9E4/XTo997XwU7xqJnnv49sz9192D4d47Ly4NjPfcHL3QP9x97cHZvlBH742hJxMBDCDnOLbvOdlccX7lxyJfWOQ3llP5+GohmlyPfdt8n1j/zOeS6a0oX/iYzK2sFj4k8/lfZUYFsmVsAWqbbB22phwUkI5Miut1EagNIApQLDVkdiDRAaZ2WbUMDIlhsB0DADgZUYUw3jX1xu/iZk0UMdZVoLEfYmkNGx5iTCt1pV6vSSr6eQCr1aoky2zbGOO/izHuVWmm7x8AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"dapr\" title=\"\" src=\"/static/caaacddf29da2b8effa217adcaa7d4bb/c5bb3/dapr.png\" srcset=\"/static/caaacddf29da2b8effa217adcaa7d4bb/04472/dapr.png 170w,\n/static/caaacddf29da2b8effa217adcaa7d4bb/9f933/dapr.png 340w,\n/static/caaacddf29da2b8effa217adcaa7d4bb/c5bb3/dapr.png 680w,\n/static/caaacddf29da2b8effa217adcaa7d4bb/5a190/dapr.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>With the current wave of cloud adoption, web + database application architectures (such as classic 3-tier designs) are trending more toward microservice application architectures, which are inherently distributed. You shouldn't have to become a distributed systems expert just to create microservices applications.</p>\n<p>This is where Dapr comes in. Dapr codifies the best practices for building microservice applications into open, independent APIs called <a href=\"https://docs.dapr.io/concepts/overview/#microservice-building-blocks-for-cloud-and-edge\" target=\"_blank\" rel=\"noopener noreferrer\">building blocks</a>.</p>\n<h3 id=\"daprs-building-blocks\" style=\"position:relative;\"><a href=\"#daprs-building-blocks\" aria-label=\"daprs building blocks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Dapr's Building Blocks</h3>\n<ul>\n<li>Enable you to build portable applications using the language and framework of your choice.</li>\n<li>Are completely independent.</li>\n<li>Have no limit to how many you use in your application.</li>\n</ul>\n<p>Using Dapr, you can incrementally migrate your existing applications to a microservices architecture, thereby adopting cloud-native patterns such as scale out/in, resiliency, and independent deployments.</p>\n<p>Dapr is platform agnostic, meaning you can run your applications:</p>\n<ul>\n<li>Locally</li>\n<li>On any Kubernetes cluster</li>\n<li>On virtual or physical machines</li>\n<li>In other hosting environments that Dapr integrates with.</li>\n</ul>\n<p>This enables you to build microservice applications that can run on the cloud and edge.</p>\n<h3 id=\"hosting-environments\" style=\"position:relative;\"><a href=\"#hosting-environments\" aria-label=\"hosting environments permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Hosting Environments</h3>\n<p>Dapr can be hosted in multiple environments, including:</p>\n<ul>\n<li>Self-hosted on a Windows/Linux/macOS machine for local development.</li>\n<li>On Kubernetes or clusters of physical or virtual machines in production.</li>\n</ul>\n<h4 id=\"self-hosted-local-development\" style=\"position:relative;\"><a href=\"#self-hosted-local-development\" aria-label=\"self hosted local development permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Self-Hosted Local Development</h4>\n<p>In <a href=\"https://docs.dapr.io/operations/hosting/self-hosted/self-hosted-overview/\" target=\"_blank\" rel=\"noopener noreferrer\">self-hosted mode</a>, Dapr runs as a separate sidecar process, which your service code can call via HTTP or gRPC. Each running service has a Dapr runtime process (or sidecar) configured to use state stores, pub/sub, binding components, and other building blocks.</p>\n<p>You can use the <a href=\"https://github.com/dapr/cli#launch-dapr-and-your-app\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr CLI</a> to run a Dapr-enabled application on your local machine. In the following diagram, Dapr's local development environment gets configured with the CLI init command. Try this out with <a href=\"https://docs.dapr.io/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">the getting started samples</a>.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3ZRAf//EABcQAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQEAAQUCpRaj/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhABAAMAAwAAAAAAAAAAAAAAAQARIRAxcf/aAAgBAQABPyE0+wSuNEpXUo5f/9oADAMBAAIAAwAAABBYz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQACAgIDAAAAAAAAAAAAAAEAESExQVFhgZH/2gAIAQEAAT8QVBLqkN6sFpvyQexzHNjbbDW37Mhvuf/Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"example\" title=\"\" src=\"/static/200455aca73b826a56c3691eb7e7ab2a/7bf67/example.jpg\" srcset=\"/static/200455aca73b826a56c3691eb7e7ab2a/651be/example.jpg 170w,\n/static/200455aca73b826a56c3691eb7e7ab2a/d30a3/example.jpg 340w,\n/static/200455aca73b826a56c3691eb7e7ab2a/7bf67/example.jpg 680w,\n/static/200455aca73b826a56c3691eb7e7ab2a/4b190/example.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h4 id=\"kubernetes\" style=\"position:relative;\"><a href=\"#kubernetes\" aria-label=\"kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Kubernetes</h4>\n<p>Kubernetes can be used for either:</p>\n<ul>\n<li><strong>Local development</strong> (for example, with <a href=\"https://minikube.sigs.k8s.io/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">minikube</a> and <a href=\"https://k3s.io/\" target=\"_blank\" rel=\"noopener noreferrer\">k3S</a>)</li>\n<li><strong>Production</strong> (see <a href=\"https://docs.dapr.io/operations/hosting/kubernetes/\" target=\"_blank\" rel=\"noopener noreferrer\">production hosting</a>)</li>\n</ul>\n<p>In container hosting environments such as Kubernetes, Dapr runs as a sidecar container with the application container in the same pod. Dapr's <code class=\"language-text\">dapr-sidecar-injector</code> and <code class=\"language-text\">dapr-operator</code> control plane services provide first-class integration to:</p>\n<ul>\n<li>Launch Dapr as a sidecar container in the same pod as the service container</li>\n<li>Provide notifications of Dapr component updates provisioned in the cluster</li>\n</ul>\n<p>The <code class=\"language-text\">dapr-sentry</code> service is a certificate authority that enables mutual TLS between Dapr sidecar instances for secure data encryption, as well as providing identity via Spiffe. For more information on the Sentry service, <a href=\"https://docs.dapr.io/concepts/security-concept/#dapr-to-dapr-communication\" target=\"_blank\" rel=\"noopener noreferrer\">read the security overview</a>.</p>\n<p>Deploying and running a Dapr-enabled application into your Kubernetes cluster is as simple as adding a few annotations to the deployment schemes.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7klEQVR42l2R22rcMBCG/bR9pT5GodCUEnKTvUhpaFi2m81u9hDZXtnWWdbBsg62a6eFQn/+i5lffMMwyqY/Gsd3T//JdN734V8/TrBqHzcNAARWIhvGKb1Ts+cipCkOi+dcx+lhdwUApmnJh3mWCXWt7lcXCKExKivF9LhD293z02ZXwnqe7sLg4uiHpVDW+2Hs0xjHJcHCU6qRsBBWfd9n3MTHDc5z6qx5K8XLUVjTzQ+67fKr3p95DEFwu92zClvWBoSUta4oCmNMJkz49BWsN9R1fv3MPn8rKLXW9k2jv/8kN3d5CPOq9svt9WlLlI2E6jWWoCillFk/TJzK4/Gc58Da7nA4n06vgmBMakyJYBpjtN+/HF8vrk81doio+4pRIY3WmUtTZ4NzPqUU40AIJ4TkTDWYwGtlrI8xcs4R4qaLRWXntYXu2bsW2HUhpfmWU0xD6v2rDB/u6OpNT2My9u8/WevTMBLhCdZMu6Is27ZdYIxoDmBV80uhSSNPtf54C1YPwGinlG+lVaozer76hLln3AIkqrpxzmVU9YdLudkd14fqx8Eg1mkXlfbgqhruEe9PBQNXOWNYhrzUDVa/YM2FWGAusNKt7XolWecsF5JSTigjhCLCjGAjh1ZgwqRslRSmoeYGtRUmnLHfpLxl97+GXnkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"k8s\" title=\"\" src=\"/static/6ec20cc311f84b150d3050ac84958f56/c5bb3/k8s.png\" srcset=\"/static/6ec20cc311f84b150d3050ac84958f56/04472/k8s.png 170w,\n/static/6ec20cc311f84b150d3050ac84958f56/9f933/k8s.png 340w,\n/static/6ec20cc311f84b150d3050ac84958f56/c5bb3/k8s.png 680w,\n/static/6ec20cc311f84b150d3050ac84958f56/5a190/k8s.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"hands-on-and-getting-started\" style=\"position:relative;\"><a href=\"#hands-on-and-getting-started\" aria-label=\"hands on and getting started permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Hands-On and Getting Started</h2>\n<p>The project is surprisingly easy to get up and running regardless of your developer background and language of choice. I was able to follow the <a href=\"https://docs.dapr.io/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">getting started guides</a> and run various quickstarts in no time on my macOS. Here are roughly the steps I followed:</p>\n<h3 id=\"install-dapr-cli-Ô∏è\" style=\"position:relative;\"><a href=\"#install-dapr-cli-%EF%B8%8F\" aria-label=\"install dapr cli Ô∏è permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Install Dapr CLI üõ†Ô∏è</h3>\n<p>Dapr CLI is the main tool for performing Dapr-related tasks such as running an application with Dapr, viewing logs, running the Dapr dashboard, or deploying to Kubernetes.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">brew <span class=\"token function\">install</span> dapr/tap/dapr-cli</code></pre></div>\n<p>With the CLI installed, we have a few different options for installing and running Dapr. I'll start from the least demanding and flexible option and progress from there.</p>\n<p><strong>Option 1: Install Dapr without Docker:</strong></p>\n<p>This is the lightest but not the most useful way to run Dapr.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr init <span class=\"token parameter variable\">--slim</span></code></pre></div>\n<p>In this slim mode, only <code class=\"language-text\">daprd</code> and <code class=\"language-text\">placement</code> binaries are installed on the machine, which is sufficient for running Dapr sidecars locally.</p>\n<h3 id=\"Ô∏è-run-a-dapr-sidecar\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-run-a-dapr-sidecar\" aria-label=\"Ô∏è run a dapr sidecar permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Run a Dapr Sidecar</h3>\n<p>The following command will start a Dapr sidecar called <code class=\"language-text\">no-app</code> listening on HTTP port 3500 and a random gRPC port.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr run --app-id no-app --dapr-http-port <span class=\"token number\">3500</span></code></pre></div>\n<p>Congratulations, you have your first Dapr sidecar running. You can see the sidecar instance through this command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr list</code></pre></div>\n<p>Or query its health status:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-i</span> http://localhost:3500/v1.0/healthz</code></pre></div>\n<p>Dapr sidecars are supposed to run next to an application and not on their own. Let's stop this instance and run it with an application.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr stop --app-id no-app</code></pre></div>\n<h3 id=\"-run-a-simple-app-with-a-dapr-sidecar\" style=\"position:relative;\"><a href=\"#-run-a-simple-app-with-a-dapr-sidecar\" aria-label=\" run a simple app with a dapr sidecar permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Run a Simple App with a Dapr Sidecar</h3>\n<p>For more details, refer to the <a href=\"https://docs.dapr.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr documentation</a>.</p>\n<p>For this demonstration, we will use a <a href=\"https://github.com/dapr/samples/tree/master/hello-dapr-slim\" target=\"_blank\" rel=\"noopener noreferrer\">simple NodeJS application</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone https://github.com/dapr/samples.git\n<span class=\"token builtin class-name\">cd</span> samples/hello-dapr-slim\n<span class=\"token function\">npm</span> <span class=\"token function\">install</span></code></pre></div>\n<p>This is a Hello World the Dapr way and here is the gist of it:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/neworder'</span><span class=\"token punctuation\">,</span> bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> \n    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">;</span> \n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got a new order! Order ID: \"</span> <span class=\"token operator\">+</span> orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>For more examples and detailed guides, check out the <a href=\"https://github.com/dapr/samples\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr Samples Repository</a>.</p>\n<p>The application has one <code class=\"language-text\">/neworder</code> endpoint listening on port 3000. We can run this application and the sidecar with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr run --app-id nodeapp --app-port <span class=\"token number\">3000</span> --dapr-http-port <span class=\"token number\">3500</span> <span class=\"token function\">node</span> app.js</code></pre></div>\n<p>The command starts the NodeJS application on port 3000 and Dapr HTTP endpoint on 3500. Once you see in the logs that the app has started successfully, we can interact with it. Instead of hitting the <code class=\"language-text\">/neworder</code> endpoint directly on port 3000, we will interact with the application through the sidecar using the Dapr CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr invoke <span class=\"token parameter variable\">--verb</span> POST --app-id nodeapp <span class=\"token parameter variable\">--method</span> neworder <span class=\"token parameter variable\">--data</span> <span class=\"token string\">'{\"data\": { \"orderId\": \"41\" } }'</span></code></pre></div>\n<p>For more information on Dapr CLI commands, refer to the <a href=\"https://docs.dapr.io/reference/cli/dapr-cli-overview/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr CLI documentation</a>.</p>\n<p>You can also use a curl command to achieve the same result:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-XPOST</span> <span class=\"token parameter variable\">-d</span> @sample.json <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type:application/json\"</span> http://localhost:3500/v1.0/invoke/nodeapp/method/neworder</code></pre></div>\n<p>This command uses Dapr's service invocation API to interact with the application. Here is a visual representation of what just happened:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABnUlEQVR42nVRTS8DQRie+qhIE3FAnMXFUeLgD/SAi4OTUImTgzghvdWVODjgLwjBgaNE41JZqe8GKbKltbq73dndUf3Ynenr3bYiEd7kmWfeyeSZZ56XAIAvGo02eUzqhftGj9OKMiRc5xr7UwAhIUvMNKVMJiMZhiG5rvuNGOf8Xtf1RfJXfQtSXZ8U2LwXQGhFAK0EYOULwJgNxSIe/JTrLaZpbhJFUfrwtZlkMtkWiUSaEjsRfyy201oTpqHVExXI3IXjD99wMn/JD29zHKDCHZfzz3yem/YHNyxWqguuE9u2N72GMTbqiaxH1e6DB9aBWx9AbnrlxACycCv6157AF07A9tkbMCMLOWpC4TMPz+l3eHzNVh1Sig41TeunlIZlWW5HkUDL4ERv18BIT81hYXz5CB3OXLmdS3eCzF6K/XPNS0GgQ2FZlkjJsnhJyWVPEH+68Ts+P6I5GAwGqoKcTh6nXBjbUsTUXhZCu1m4VmrZiQr8nSFyA+K/KQ8Lp5jA+2cATtwDTj1ecpy4g8DpVrlcLks45aSqquEvYFmDJ1VslScAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Invoking an endpoint through Dapr sidecar\" title=\"\" src=\"/static/492fde26f0f51f028a477293e667a12a/c5bb3/dapr-invoke.png\" srcset=\"/static/492fde26f0f51f028a477293e667a12a/04472/dapr-invoke.png 170w,\n/static/492fde26f0f51f028a477293e667a12a/9f933/dapr-invoke.png 340w,\n/static/492fde26f0f51f028a477293e667a12a/c5bb3/dapr-invoke.png 680w,\n/static/492fde26f0f51f028a477293e667a12a/5a190/dapr-invoke.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>With Dapr on the request path, we get benefits such as resiliency policies (retries, timeouts, circuit breakers), observability enhancements (metrics, tracing, logs), and security enhancements (mTLS, <a href=\"https://docs.dapr.io/operations/configuration/invoke-allowlist/\" target=\"_blank\" rel=\"noopener noreferrer\">allow lists</a>). You can explore metadata, metrics endpoints, <a href=\"https://docs.dapr.io/operations/configuration/configuration-overview/\" target=\"_blank\" rel=\"noopener noreferrer\">configuration options</a>, or see your microservice in the Dapr dashboard:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr dashboard</code></pre></div>\n<p>The slim mode we are running is good for the Hello World scenario but not ideal for local development as it lacks state store, pub/sub, and metric server. Let's stop the nodeapp and remove the slim Dapr binary:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr stop --app-id nodeapp\ndapr uninstall</code></pre></div>\n<p>Note that this command will not remove the default configuration and component specification files usually located in the <code class=\"language-text\">~/.dapr</code> folder. If you follow other tutorials and change those files, they will remain and get applied with every <code class=\"language-text\">dapr run</code> command in the future (unless overridden). Keep this in mind to avoid confusion.</p>\n<h3 id=\"option-2-install-dapr-with-docker-\" style=\"position:relative;\"><a href=\"#option-2-install-dapr-with-docker-\" aria-label=\"option 2 install dapr with docker  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Option 2: Install Dapr with Docker üê≥</strong></h3>\n<p>This is the preferred way for running <a href=\"https://docs.dapr.io/getting-started/install-dapr-selfhost/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr locally</a> for development purposes, but it requires Docker. Let's set it up:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr init</code></pre></div>\n<p>The command will download and run 3 containers:</p>\n<ul>\n<li><strong>Dapr placement container</strong>: Used with actors (I wish this was an optional feature).</li>\n<li><strong>Zipkin</strong>: For collecting tracing information from our sidecars.</li>\n<li><strong>Redis</strong>: A single node Redis container used for state store, pub/sub, and distributed-lock implementations.</li>\n</ul>\n<p>You can verify when these containers are running and you are ready to go:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> <span class=\"token function\">ps</span></code></pre></div>\n<h3 id=\"run-the-quickstarts-\" style=\"position:relative;\"><a href=\"#run-the-quickstarts-\" aria-label=\"run the quickstarts  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Run the Quickstarts üöÄ</strong></h3>\n<p>My next step from here was to try out the <a href=\"https://docs.dapr.io/getting-started/quickstarts/\" target=\"_blank\" rel=\"noopener noreferrer\">quickstarts</a> that demonstrate the building blocks for service invocation, pub/sub, state store, bindings, etc. The awesome thing about these quickstarts is that they demonstrate the same example in multiple ways:</p>\n<ul>\n<li>With Dapr SDK and without any dependency on Dapr SDK (i.e., using HTTP only).</li>\n<li>In multiple languages: Java, JavaScript, .NET, Go, Python, etc.</li>\n</ul>\n<p>You can mix and match different languages and interaction methods (SDK or native) for the same example, which demonstrates Dapr's polyglot nature.</p>\n<h3 id=\"option-3-install-dapr-on-kubernetes-Ô∏è\" style=\"position:relative;\"><a href=\"#option-3-install-dapr-on-kubernetes-%EF%B8%8F\" aria-label=\"option 3 install dapr on kubernetes Ô∏è permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Option 3: Install Dapr on Kubernetes ‚ò∏Ô∏è</strong></h3>\n<p>If you have come this far, you should have a good high-level understanding of what Dapr can do for you. The next step would be to deploy Dapr on Kubernetes where most of the Dapr functionalities are available and closest to a production deployment. For this purpose, I used <a href=\"https://minikube.sigs.k8s.io/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">minikube</a> locally with default settings and no custom tuning.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dapr init <span class=\"token parameter variable\">--kubernetes</span> <span class=\"token parameter variable\">--wait</span></code></pre></div>\n<p>If successful, this command will start the following pods in the <code class=\"language-text\">dapr-system</code> namespace:</p>\n<ul>\n<li><strong>dapr-operator</strong>: Manages all components for state store, pub/sub, configuration, etc.</li>\n<li><strong>dapr-sidecar-injector</strong>: Injects Dapr sidecars into annotated deployment pods.</li>\n<li><strong>dapr-placement</strong>: Required with actors only.</li>\n<li><strong>dapr-sentry</strong>: Manages mTLS between services and acts as a certificate authority.</li>\n<li><strong>dapr-dashboard</strong>: A simple web app to explore what is running within a Dapr cluster.</li>\n</ul>\n<p>These Pods collectively represent the <a href=\"https://docs.dapr.io/concepts/dapr-services/\" target=\"_blank\" rel=\"noopener noreferrer\">Dapr control plane.</a></p>\n<h3 id=\"injecting-a-sidecar-Ô∏è\" style=\"position:relative;\"><a href=\"#injecting-a-sidecar-%EF%B8%8F\" aria-label=\"injecting a sidecar Ô∏è permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Injecting a Sidecar üõ†Ô∏è</strong></h3>\n<p>From here on, adding a Dapr sidecar to an application (this would be Dapr dataplane) is as easy as adding the <a href=\"https://docs.dapr.io/reference/arguments-annotations-overview/\" target=\"_blank\" rel=\"noopener noreferrer\">following annotations</a> to your Kubernetes Deployments:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dapr.io/enabled</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token key atrule\">dapr.io/app-id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nodeapp\"</span>\n    <span class=\"token key atrule\">dapr.io/app-port</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3000\"</span></code></pre></div>\n<p>The <code class=\"language-text\">dapr-sidecar-injector</code> service watches for new Pods with the <code class=\"language-text\">dapr.io/enabled</code> annotation and injects a container with the <code class=\"language-text\">daprd</code> process within the pod. It also adds <code class=\"language-text\">DAPR_HTTP_PORT</code> and <code class=\"language-text\">DAPR_GRPC_PORT</code> environment variables to your container so that it can easily communicate with Dapr without hard-coding Dapr port values.</p>\n<p>To deploy a complete application on Kubernetes, I suggest this <a href=\"https://github.com/dapr/quickstarts/tree/master/tutorials/hello-kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">step-by-step example</a>. It has provider and consumer services and it worked the first time for me.</p>\n<h3 id=\"transparent-vs-explicit-proxy-\" style=\"position:relative;\"><a href=\"#transparent-vs-explicit-proxy-\" aria-label=\"transparent vs explicit proxy  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Transparent vs Explicit Proxy üîç</strong></h3>\n<p>Notice that Dapr sidecar injection is less intrusive than a typical service mesh with a transparent sidecar such as Istio's Envoy. To inject a transparent proxy, typically the Pods also get injected with an init-container that runs at the start of the Pod and re-configures the Pod's networking rules so that all ingress and egress traffic of your application container goes through the sidecar. With Dapr, that is not the case. There is a sidecar injected, but your application is in control of when and how to interact with Dapr over its well-defined explicit (non-transparent) APIs.</p>\n<p>Transparent service mesh proxies operate at lower network layers typically used by operations teams, whereas Dapr provides application layer primitives needed by developers. If you are interested in this topic, here is a good <a href=\"https://docs.dapr.io/concepts/service-mesh/\" target=\"_blank\" rel=\"noopener noreferrer\">explanation of the differences and overlaps of Dapr with service meshes</a>.</p>\n<h2 id=\"summary-\" style=\"position:relative;\"><a href=\"#summary-\" aria-label=\"summary  permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><strong>Summary üìù</strong></h2>\n<p>Dapr emerges as a versatile and event-driven runtime, providing a beginner-friendly solution for constructing distributed applications. With its portable nature and emphasis on simplifying development complexities, Dapr empowers newcomers to seamlessly navigate the intricacies of building distributed systems. As a beginner's guide, this post sheds light on Dapr's fundamental features, offering a gateway for developers to embark on their journey into the realm of distributed application development.</p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <em><strong>Until next time üéâ</strong></em></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/k8s-wasm-runtimes-part1/","title":"Wasm and Kubernetes: A new era of cloud-native application deployment; Part1","date":"2024-10-20 21:36:00"},"excerpt":"Wasm on K8s: everything you need to know üê≥ üìå Introduction WebAssembly (Wasm) and Kubernetes (K8s) are two of the most transformative‚Ä¶","html":"<blockquote>\n<p><strong>Wasm on K8s: everything you need to know üê≥</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìå Introduction</h2>\n<p>WebAssembly (<a href=\"https://webassembly.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Wasm</a>) and Kubernetes (<a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">K8s</a>) are two of the most transformative technologies in cloud computing today. Wasm is a portable, lightweight bytecode format that enables developers to run code written in any language on the web. Kubernetes is a container orchestration platform that automates many of the tasks involved in deploying and managing containerized applications.</p>\n<p>Together, Wasm and K8s have the potential to revolutionize cloud-native application development. Wasm can be used to create portable, scalable, and secure applications that can run on any platform, including Kubernetes clusters. K8s can be used to manage and deploy Wasm applications at scale, making it easy to build and maintain complex cloud-native applications.</p>\n<p>In this blog post, we will explore the connection between Wasm and K8s and discuss their potential to usher in a new era of cloud-native application development. We will also discuss some of the challenges and opportunities that lie ahead for this emerging technology stack.</p>\n<h3 id=\"-webassembly-basics\" style=\"position:relative;\"><a href=\"#-webassembly-basics\" aria-label=\" webassembly basics permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üåê WebAssembly Basics</h3>\n<p>WebAssembly is a revolutionary new technology that is changing the way web applications are developed. It is a low-level binary format that can compile a variety of programming languages, including C, C++, and Rust. This allows developers to create web applications that are much faster and more efficient than those written in JavaScript alone.</p>\n<p>WebAssembly has three main advantages: <strong>speed</strong>, <strong>security</strong>, and <strong>support</strong>.</p>\n<ul>\n<li><strong>Speed</strong>: WebAssembly programs run at near-native speeds, which means that they can be just as fast as desktop applications.</li>\n<li><strong>Security</strong>: WebAssembly programs run in a memory-safe sandbox, which makes them more secure than JavaScript programs.</li>\n<li><strong>Support</strong>: WebAssembly is supported by all major browsers, so developers can be confident that their applications will work for all users.</li>\n</ul>\n<p>WebAssembly is already being used to create a wide variety of web applications, including games, video editing software, and even machine learning applications. As the technology continues to mature, it is likely to have an even greater impact on the web development landscape.</p>\n<h3 id=\"-docker-vs-wasm\" style=\"position:relative;\"><a href=\"#-docker-vs-wasm\" aria-label=\" docker vs wasm permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üêã Docker Vs WASM</h3>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkUlEQVR42i2OSUwTYRiG5+rFoCePHiQaMCbIwUTASDwYY2LiggchGpeLS/RAQSLuRkBEVJREsMgUEwotSIulhdKF0jZdWKbYbabLdEpbxMJUwBtM/8//Ryd58n7z5s2TnzJ5WZtlNgo489a5GDK6Agj/YyJ5s5cD80yEG7FaC972jhQ4/CnOl9gAD7ea97BZNBsRkSucRR5uJc8k/sCUT7BRjmA6b/cvgzP4C1xsDqYXMjhFcASziPRuNgsGO1OsxixEsxBLrkGIz6EfURFC8RyQDPMi7tdhJpzJU3pHQOodnIb+US9oLSHo7DPBsNEPKv08+qK0gc4WRFosY+z24ndmFt0aT0ODMYFeWpPwfCoDT80CyCaScGc8BV2WoES9MQbQCVUCLmgScMMgwJWxJFzTC3BRy6PjKgEeTbBoUqMpceo1JXd1YbRXEYejg3F09nsSzmNOjghQqozDvr4YPDP4EdVqCKAyBQ+n+3moHsIiLCF5RsmjIzQPD3QsMowOH7Zh7mk5VChfhKLPPDrUk4BTAynY381DsVyAA3L84rEAou53cdLuqhWoqBWhvG4NKmQYnJX1ItpVJcLlFh6tLrmLNlbdRZeaebQTd+W1IqpsWIcy2TocqyMpwo5zK1D/iZOogcmI1Eyntl4pElJjx5zU+IGRnnQyUouC32yiUxKtiyJnyHeQQO4mOo338c3GjnmJ8LjTJ7V9TW4104tbxEU5ZsLRpXQO4rEM8rgY8HoWtuHCi2g58xu8TCT3UWfdQyA36diQ8G/r9m1v+dhPRBxO7KKGjPOFKgtT3d6rvt0uH5S1YVq7+ut7hkzX1VamRmWZK6X+f+RWm5gaWmO9+qKDfvi6W1lHtu/7vt0kDuL6C2p/EG7vocIcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"wasm-vs-docker\" title=\"\" src=\"/static/93c92163a0baaa2389b0523a5aef1f56/c5bb3/wasm-vs-docker.png\" srcset=\"/static/93c92163a0baaa2389b0523a5aef1f56/04472/wasm-vs-docker.png 170w,\n/static/93c92163a0baaa2389b0523a5aef1f56/9f933/wasm-vs-docker.png 340w,\n/static/93c92163a0baaa2389b0523a5aef1f56/c5bb3/wasm-vs-docker.png 680w,\n/static/93c92163a0baaa2389b0523a5aef1f56/5a190/wasm-vs-docker.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Docker packages a program and its dependencies in a single image and then runs it as a container. A Docker container runs as a full file system (utilities, binaries, etc.), appearing to be a complete operating system for the application. Additionally, you need to create an image according to the right system architecture (e.g., Intel, ARM, etc.). For example, if someone has a Raspberry Pi OS running a Docker image, then you need to create an image for a C/C++ application based on a Linux image and compile it for the ARM processor system architecture. If not done, the container won't run as expected.</p>\n<p>On the other hand, a WASM module/binary is a precompiled C/C++ application that can run swiftly on a WASM runtime. It doesn't rely on or is coupled with the host OS or system architecture as it doesn't contain a precompiled file system or low-level OS primitives similar to Docker. Every directory and system resource is attached to the WASM module during runtime facilitated by <a href=\"https://wasi.dev/\" target=\"_blank\" rel=\"noopener noreferrer\">WASI</a>.</p>\n<h3 id=\"Ô∏è-docker-vs-wasm-performance\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-docker-vs-wasm-performance\" aria-label=\"Ô∏è docker vs wasm performance permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚öñÔ∏è Docker vs WASM Performance</h3>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 43.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVElEQVR42lWR6arCUAyE+/7P0jfQ+qf/BBUUilj3uqN131rLyBeIlxs4NE1yJjNzgvf7rfv9rtFopOPxqKIo9Hg8dD6fVZal8jzXYDDQ6XSy/9vtpsvl8q9HjajX6woA5IzHYxt0QHLq6/VaaZpa35c74OFwMECWE1EUKXi9XtrtdtZYLpcG5pcYnE6nWiwWpgCW3ns+n1qtVppMJtput38Mq6qyTTDYbDb6fD5iCTJgtN/vbRHyqANEjznYz2Yzu080Gg0FDGRZpuFw+JPNRb4sgzGAzPHvDLGGZfP5/CfZGCKn1+spSRJ1Oh2TDgiMuMBBmueAub+Ao4r5HyAFmPnBk+v1aoPkMMBHcg7yYORLYY+3RK1WU8BrwQBj/VEIas4SEM+ZQy4g5NSZJeI4VgBIv983uu1220AxmlfFW/Jut2tf7HG29FqtlprNplkG6zAM9QWYcp/FXl6ZXwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"compare-performance\" title=\"\" src=\"/static/81d20f6e29ec6c5d3bddf48b3ab7e72c/c5bb3/compare-performance.png\" srcset=\"/static/81d20f6e29ec6c5d3bddf48b3ab7e72c/04472/compare-performance.png 170w,\n/static/81d20f6e29ec6c5d3bddf48b3ab7e72c/9f933/compare-performance.png 340w,\n/static/81d20f6e29ec6c5d3bddf48b3ab7e72c/c5bb3/compare-performance.png 680w,\n/static/81d20f6e29ec6c5d3bddf48b3ab7e72c/5a190/compare-performance.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>WASM provides near-native speed performance, quicker startup time, and high security, allowing C/C++/Rust/Go code to run in the browser and even outside the browser. Docker, on the other hand, provides runtime isolation and better portability.</p>\n<div class=\"note\">\n    <p><strong>üîµ Note:</strong></p>\n    <p>The key is that Wasm binaries don't rely on host OS or processor architectures like Docker containers. Instead, all the resources the Wasm module needs (such as environment variables and system resources) are provisioned to the Wasm module by the runtime through the WASI standard. This means Wasm modules are not coupled to the OS or underlying computer. It's an ideal mechanism for highly portable web-based application development.</p>\n</div>\n<h2 id=\"webassembly-on-kubernetes\" style=\"position:relative;\"><a href=\"#webassembly-on-kubernetes\" aria-label=\"webassembly on kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>WebAssembly on Kubernetes</h2>\n<p>Kubernetes needs two things to be able to run WebAssembly workloads:</p>\n<ol>\n<li><strong>Worker nodes bootstrapped with a WebAssembly runtime.</strong></li>\n<li><strong>RuntimeClass objects mapping to nodes with a WebAssembly runtime.</strong></li>\n</ol>\n<p>We'll explain all of the following in more detail:</p>\n<ol>\n<li><strong>Worker node configuration with containerd and runwasi</strong></li>\n<li><strong>Bootstrapping Kubernetes workers with Wasm runtimes</strong></li>\n<li><strong>Using labels to target workloads</strong></li>\n<li><strong>RuntimeClasses and Wasm</strong></li>\n<li><strong>Wasm apps in Kubernetes Pods</strong></li>\n</ol>\n<h3 id=\"Ô∏è-containerd-and-runwasi\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-containerd-and-runwasi\" aria-label=\"Ô∏è containerd and runwasi permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚öôÔ∏è containerd and runwasi</h3>\n<p>Most Kubernetes clusters use <a href=\"https://containerd.io/\" target=\"_blank\" rel=\"noopener noreferrer\">containerd</a> as the high-level runtime. It runs on every node and manages container lifecycle events such as create, start, stop, and delete. However, containerd only manages these events; it actually uses a low-level container runtime called <code class=\"language-text\">runc</code> to perform the actual work. A shim process sits between containerd and the low-level runtime and performs important tasks such as abstracting the low-level runtime.</p>\n<p>The architecture is shown below:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAABA//EABYBAQEBAAAAAAAAAAAAAAAAAAQCA//aAAwDAQACEAMQAAABEg3RZDWUaf/EABoQAQEAAgMAAAAAAAAAAAAAAAECAAMRITL/2gAIAQEAAQUC1iZbVFHDD0uV6//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/AVn/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPwGH/8QAGhABAAEFAAAAAAAAAAAAAAAAAQACEBEhof/aAAgBAQAGPwIQm6eTDC//xAAcEAACAgIDAAAAAAAAAAAAAAABIQARMUFRgZH/2gAIAQEAAT8hZa0smKwjSo4U4KI1CaPISu+IdlP/2gAMAwEAAgADAAAAENTv/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERMf/aAAgBAwEBPxCDgsP/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREx/9oACAECAQE/EFSo9P/EABoQAQADAQEBAAAAAAAAAAAAAAEAETFRQSH/2gAIAQEAAT8QvExaEDyUkhYQpxGo7lpAHgbPicH3iMhq3hU//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"containerd-wasm\" title=\"\" src=\"/static/e6b38c010a7af6b060106bcb176d33af/7bf67/containerd-wasm.jpg\" srcset=\"/static/e6b38c010a7af6b060106bcb176d33af/651be/containerd-wasm.jpg 170w,\n/static/e6b38c010a7af6b060106bcb176d33af/d30a3/containerd-wasm.jpg 340w,\n/static/e6b38c010a7af6b060106bcb176d33af/7bf67/containerd-wasm.jpg 680w,\n/static/e6b38c010a7af6b060106bcb176d33af/4b190/containerd-wasm.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p><a href=\"https://github.com/containerd/runwasi\" target=\"_blank\" rel=\"noopener noreferrer\">runwasi</a> is a containerd project that lets you swap out container runtimes for WebAssembly runtimes. It operates as a shim layer between containerd and low-level Wasm runtimes and enables WebAssembly workloads to seamlessly run on Kubernetes clusters. The architecture is shown below:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQD/8QAFgEBAQEAAAAAAAAAAAAAAAAABAEC/9oADAMBAAIQAxAAAAGXefVR4xm//8QAGhAAAQUBAAAAAAAAAAAAAAAAAgABAxIyMf/aAAgBAQABBQKIXR2JjGpBl+Sb/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BZ//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABwQAAEDBQAAAAAAAAAAAAAAAAABAhEhMWFxgf/aAAgBAQAGPwJrslYvAqDdnRT/xAAZEAACAwEAAAAAAAAAAAAAAAAAAREhMUH/2gAIAQEAAT8hSi7BUZamCgmXUORrBi//2gAMAwEAAgADAAAAEGgf/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAB/9oACAEDAQE/EMYjF//EABcRAQEBAQAAAAAAAAAAAAAAAAEAESH/2gAIAQIBAT8QDey3/8QAGxABAAMAAwEAAAAAAAAAAAAAAQARQSExYVH/2gAIAQEAAT8QGCPeBLPNnInx6uJ2lpj08VbCNl1z2Mq/cKn/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"runwasi\" title=\"\" src=\"/static/e437674d03204e7e170d877f86a5c578/7bf67/runwasi.jpg\" srcset=\"/static/e437674d03204e7e170d877f86a5c578/651be/runwasi.jpg 170w,\n/static/e437674d03204e7e170d877f86a5c578/d30a3/runwasi.jpg 340w,\n/static/e437674d03204e7e170d877f86a5c578/7bf67/runwasi.jpg 680w,\n/static/e437674d03204e7e170d877f86a5c578/4b190/runwasi.jpg 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Everything from containerd and below is opaque to Kubernetes‚Ää‚Äî‚ÄäKubernetes schedules work tasks to nodes and doesn't care if it's a traditional OCI container or a WebAssembly workload.</p>\n<h2 id=\"Ô∏è-bootstrapping-kubernetes-workers-with-wasm-runtimes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-bootstrapping-kubernetes-workers-with-wasm-runtimes\" aria-label=\"Ô∏è bootstrapping kubernetes workers with wasm runtimes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Bootstrapping Kubernetes workers with Wasm runtimes</h2>\n<p>For a Kubernetes worker to execute WebAssembly workloads, it needs bootstrapping with a Wasm runtime. This is a two-step process:</p>\n<ol>\n<li><strong>Install the Wasm runtime</strong></li>\n<li><strong>Register the Wasm runtime with containerd</strong></li>\n</ol>\n<p>In most cases, your Kubernetes distro will provide a CLI or UI that automates these steps. However, we'll explain what's happening behind the scenes.</p>\n<p>Wasm runtimes are binary executables that should be installed on worker nodes in a path that's visible to containerd. They should also be named according to the containerd binary runtime naming convention. The following list shows the <code class=\"language-text\">wasmtime</code> and <code class=\"language-text\">spin</code> runtime binaries named appropriately and installed into the <code class=\"language-text\">/bin</code> directory:</p>\n<ul>\n<li><code class=\"language-text\">wasmtime</code>: <code class=\"language-text\">/bin/containerd-shim-wasmtime-v1</code></li>\n<li><code class=\"language-text\">spin</code>: <code class=\"language-text\">/bin/containerd-shim-spin-v1</code></li>\n</ul>\n<p>Once installed, runtimes need registering with containerd. This is done by adding them to the containerd config file, which is usually located at <code class=\"language-text\">/etc/containerd/config.toml</code>.</p>\n<p>The following extract shows how to register the <code class=\"language-text\">wasmtime</code> and <code class=\"language-text\">spin</code> runtimes in the containerd <code class=\"language-text\">config.toml</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.cri.containerd.runtimes.wasmtime</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key property\">runtime_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"io.containerd.wasmtime.v1\"</span>\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.cri.containerd.runtimes.spin</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key property\">runtime_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"io.containerd.spin.v1\"</span></code></pre></div>\n<p>Once the Wasm runtimes are installed and registered, the final node configuration step is to label the nodes.</p>\n<h3 id=\"Ô∏è-using-labels-to-target-workloads\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-using-labels-to-target-workloads\" aria-label=\"Ô∏è using labels to target workloads permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üè∑Ô∏è Using Labels to Target Workloads</h3>\n<p>If all of your cluster nodes have the same runtimes, you do not need to label them. However, if you have subsets of nodes with Wasm runtimes, you need to label them so that <a href=\"https://kubernetes.io/docs/concepts/containers/runtime-class/\" target=\"_blank\" rel=\"noopener noreferrer\">RuntimeClass</a> objects can target them.</p>\n<p>The following diagram shows a cluster with 6 nodes. Two have <code class=\"language-text\">runc</code>, 4 have <code class=\"language-text\">wasmtime</code>, and 2 have <code class=\"language-text\">spin</code>. See how the labels make it obvious which nodes have which runtimes.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 23.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPElEQVR42gExAc7+AIxh/Ydl+4dt+4V1+oF594GC93qF9p+q+MPK+r/K+rjJ+Xer8G+v72+472y+7mrE7GjL62XS62PZ6WDe5wCSZ/6Uc/+KcPuGdfuPiP+EhfuLk/PIy+LJzueOq/XEzua/zuCAuO+kyurS3uiJzuuJ0enQ4uaj4Olg3ugA0snvv7vVwLf0x776wcDVvr/ow8b/7vbw1+jqs8j56e/24fDnstb24u359vbvvubxzOr3+PTx3fHxauHqANnX6La4vsa/8NPN+ra2vMXG4bq98dze183V27nK89LV2dnc2bDQ7eXw/Ofu7MTq89Ht+eru8N7y8m7i6gCvkP6xmv2hjfufkvywqvyho/uPl/OgrO+bre+LqfOWteybve2Euu+Xy/Sh1vWJ0fCJ1u+c4/OR5PBl3+dd9up+o8MzugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"labels\" title=\"\" src=\"/static/a1f4df8f6bf0d2034451ca55dda3cb2c/c5bb3/labels.png\" srcset=\"/static/a1f4df8f6bf0d2034451ca55dda3cb2c/04472/labels.png 170w,\n/static/a1f4df8f6bf0d2034451ca55dda3cb2c/9f933/labels.png 340w,\n/static/a1f4df8f6bf0d2034451ca55dda3cb2c/c5bb3/labels.png 680w,\n/static/a1f4df8f6bf0d2034451ca55dda3cb2c/898f6/labels.png 798w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>Be sure to use meaningful labels and avoid reserved namespaces such as <code class=\"language-text\">kubernetes.io</code> and <code class=\"language-text\">k8s.io</code>.</p>\n<p>The following command applies the <code class=\"language-text\">wasmtime-enabled=yes</code> label to a node called <code class=\"language-text\">wrkr3</code>. RuntimeClasses can use this label to send Wasm workloads to the node.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl label nodes wrkr3 wasmtime-enabled<span class=\"token operator\">=</span>yes</code></pre></div>\n<p>The output of the next command shows the label was correctly applied.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl get nodes --show-labels\nNAME     STATUS    ROLES    AGE     VERSION        LABELS\nwrkr1    Ready     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>   5d      v1.25.1\nwrkr2    Ready     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>   5d      v1.25.1\nwrkr3    Ready     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>   2m      v1.25.1        wasmtime-enabled<span class=\"token operator\">=</span>yes</code></pre></div>\n<p>With Wasm runtimes installed, registered with containerd, and labels applied, a node is ready to execute Wasm tasks. The next step is to create a <a href=\"https://kubernetes.io/docs/concepts/containers/runtime-class/\" target=\"_blank\" rel=\"noopener noreferrer\">RuntimeClass</a> that sends Wasm workloads to the node(s).</p>\n<h2 id=\"Ô∏è-runtimeclasses-and-wasm\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-runtimeclasses-and-wasm\" aria-label=\"Ô∏è runtimeclasses and wasm permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üè∑Ô∏è RuntimeClasses and Wasm</h2>\n<p><a href=\"https://kubernetes.io/docs/concepts/containers/runtime-class/\" target=\"_blank\" rel=\"noopener noreferrer\">RuntimeClasses</a> allow Kubernetes to schedule Pods to specific nodes and target specific runtimes. They have three important properties:</p>\n<ul>\n<li><strong>metadata.name</strong></li>\n<li><strong>scheduling.nodeSelector</strong></li>\n<li><strong>handler</strong></li>\n</ul>\n<p>The <strong>name</strong> is how you tell other objects, such as Pods, to use it. The <strong>nodeSelector</strong> tells Kubernetes which nodes to schedule work to. The <strong>handler</strong> tells containerd which runtime to use.</p>\n<p>The following <code class=\"language-text\">RuntimeClass</code> is called <code class=\"language-text\">wasm1</code>. The <code class=\"language-text\">scheduling.nodeSelector</code> property sends work to nodes with the <code class=\"language-text\">wasmtime-enabled=yes</code> label, and the <code class=\"language-text\">handler</code> property ensures the <code class=\"language-text\">wasmtime</code> runtime will execute the work.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> node.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> RuntimeClass\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"wasm1\"</span>\n<span class=\"token key atrule\">scheduling</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">wasmtime-enabled</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"yes\"</span>\n<span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"wasmtime\"</span></code></pre></div>\n<p>The following diagram shows three worker nodes. One of them is running the <code class=\"language-text\">wasmtime</code> and <code class=\"language-text\">spin</code> runtimes and is labelled appropriately. The Pod and RuntimeClass on the left target work against the <code class=\"language-text\">wasmtime</code> runtime. The Pod and RuntimeClass on the right target work against the <code class=\"language-text\">spin</code> runtime.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkElEQVR42iWP7U8ScQCA+ffcmp9cH1Jx1korBRPTMRQVjfKtxJmCLJfIfEtBERPEqTiXgq2ByFDg4BDuheNefgd3wB0vl6s/4NnzPLIPjdLWdBWO89FwEUerFyfV3Y3y5r7Q84kbWCyovuUVq+yQk71Ns3G8AIMSRNfM3/l9nG9JoLLhBtFuBCUxwtKBihhGHxAMrru9QreeGzByquX82xUwccTBJH4JhwMYFMQyvgPGj+XlSUw22sjNK4XjzYr7R+lgm3MfFk+9lRljqW+a6/9nVq6yKhuwBgrrEdYSoVcg2o4zI6FMcwKXDTXwtrlyjmDRTD5HCABIoijZDgWl/n82221hR36ycBYgJMgBnq/URLHmTlMtCewxu2xbZEgqlGfi9VqhUmEkCbi9ZeVHTm3m+1e47lUw6eFTBO6D76IIksCzKRQ9Q8i2JC4bfyI5TRxF/iawP1kkCOhUvZJ2eEqvhouK6dwbA/HCzOoO81dp2HUfuiGwKzgZxtMnFCOHcNlEkzQhr829L3wZpGd0xMJcaXZemPpa2N67HdUva3RLW8chjYPReOgh98OYF9VcoLo70BXNPYujssmm+q5B8mxU9yzVQQXV20VqdcC+DzK5yK+EN4D4Mexu2w96HUTrOtR2hJniBWuKNWWY9sdnQ6sUCTI7dlc8hpoNvLqPJXNiSSxfI2QomznznsdiEAzdJzGmw57uvaRjyezumgeCsyqUks02S/5TymJ1+i5jS59rA+/o4E0+S/CBRO7g/Hpn0xFNYnAa90XJDgfW4wPXEcRqcvpukspHeOqpNN7Kqp+HB19nxvqqWrWg0wuTC4LOyHdqA4qpiNbGj7iKKhfb6aY6L+iXnmT72lXbWUSeyv4Fm1z3mAbH0KIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"nodes\" title=\"\" src=\"/static/0265c0c10560eeea44387ae859d9595c/c5bb3/nodes.png\" srcset=\"/static/0265c0c10560eeea44387ae859d9595c/04472/nodes.png 170w,\n/static/0265c0c10560eeea44387ae859d9595c/9f933/nodes.png 340w,\n/static/0265c0c10560eeea44387ae859d9595c/c5bb3/nodes.png 680w,\n/static/0265c0c10560eeea44387ae859d9595c/5a190/nodes.png 800w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<p>With worker nodes configured and RuntimeClasses in place, the last thing to do is bind Pods to the correct RuntimeClass.</p>\n<h3 id=\"wasm-apps-in-kubernetes-pods\" style=\"position:relative;\"><a href=\"#wasm-apps-in-kubernetes-pods\" aria-label=\"wasm apps in kubernetes pods permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Wasm apps in Kubernetes Pods</h3>\n<p>The following YAML snippet targets the Pod at the wasm1 RuntimeClass. This will ensure the Pod gets assigned to a node and runtime specified in the wasm1 RuntimeClass.\nIn the real world, the Pod template will be embedded inside a higher order object such as a Deployment.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> wasm<span class=\"token punctuation\">-</span>test\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">runtimeClassName</span><span class=\"token punctuation\">:</span> wasm1    &lt;&lt;&lt;&lt;==== Use this RuntimeClass\n  <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ctr<span class=\"token punctuation\">-</span>wasm\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> &lt;OCI image with Wasm module<span class=\"token punctuation\">></span>\n    <span class=\"token punctuation\">...</span></code></pre></div>\n<p>This Pod can be posted to the Kubernetes API server where it will use the wasm1 RuntimeClass to ensure it executes on the correct node with the correct runtime (handler).\nNotice how the Pod template defines a container even though it's deploying a Wasm app. This is because Kubernetes Pods were designed with containers in mind. For Wasm to work on Kubernetes, <strong>Wasm apps have to be packaged inside of OCI container images.</strong></p>\n<h2 id=\"-deploying-a-wasm-app\" style=\"position:relative;\"><a href=\"#-deploying-a-wasm-app\" aria-label=\" deploying a wasm app permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Deploying a Wasm App</h2>\n<p>You'll need Docker Desktop and K3d to follow along, and the remainder of the article assumes you have these installed. You'll complete the following steps:</p>\n<ol>\n<li><strong>Build a K3d cluster</strong></li>\n<li><strong>Verify the runtime configuration</strong></li>\n<li><strong>Configure node labels</strong></li>\n<li><strong>Create a RuntimeClass</strong></li>\n<li><strong>Deploy an app</strong></li>\n<li><strong>Test the app</strong></li>\n<li><strong>Scale the app</strong></li>\n<li><strong>Inspect the containerd processes</strong></li>\n</ol>\n<h3 id=\"Ô∏è-build-a-k3d-kubernetes-cluster\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-build-a-k3d-kubernetes-cluster\" aria-label=\"Ô∏è build a k3d kubernetes cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèóÔ∏è Build a K3d Kubernetes Cluster</h3>\n<p>Run the following command to create a 3-node K3d Kubernetes cluster. You'll need Docker Desktop installed and running, but you do not need the Docker Desktop Kubernetes cluster running.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ k3d cluster create wasm-cluster <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--image</span> ghcr.io/deislabs/containerd-wasm-shims/examples/k3d:v0.5.1 <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"8081:80@loadbalancer\"</span> <span class=\"token parameter variable\">--agents</span> <span class=\"token number\">2</span></code></pre></div>\n<p>Verify the cluster is up and running.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl get nodes\nNAME                        STATUS   ROLES                  AGE   VERSION\nk3d-wasm-cluster-server-0   Ready    control-plane,master   2m    v1.24.6+k3s1\nk3d-wasm-cluster-agent-0    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m    v1.24.6+k3s1\nk3d-wasm-cluster-agent-1    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m    v1.24.6+k3s1</code></pre></div>\n<p>The command to build the cluster used <a href=\"https://github.com/deislabs/containerd-wasm-shims/pkgs/container/containerd-wasm-shims%2Fexamples%2Fk3d\" target=\"_blank\" rel=\"noopener noreferrer\">an image</a> with the <a href=\"https://github.com/fermyon/spin\" target=\"_blank\" rel=\"noopener noreferrer\">spin</a> and <a href=\"https://github.com/deislabs/spiderlightning\" target=\"_blank\" rel=\"noopener noreferrer\">slight</a> Wasm runtimes pre-installed. These are vital to running WebAssembly apps on Kubernetes.</p>\n<h3 id=\"-verify-the-runtime-configuration\" style=\"position:relative;\"><a href=\"#-verify-the-runtime-configuration\" aria-label=\" verify the runtime configuration permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Verify the Runtime Configuration</h3>\n<p>Use <code class=\"language-text\">docker exec</code> to log on to the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> node.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ <span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> k3d-wasm-cluster-agent-0 ash</code></pre></div>\n<p>Run all of the following commands from inside the exec session.</p>\n<p>Check the <code class=\"language-text\">/bin</code> directory for containerd shims named according to <a href=\"https://github.com/containerd/containerd/blob/main/core/runtime/v2/README.md\" target=\"_blank\" rel=\"noopener noreferrer\">the containerd shim naming convention</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ <span class=\"token function\">ls</span> /bin <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> containerd-\ncontainerd-shim-runc-v2\ncontainerd-shim-slight-v1\ncontainerd-shim-spin-v1</code></pre></div>\n<p>You can see the <a href=\"https://github.com/opencontainers/runc\" target=\"_blank\" rel=\"noopener noreferrer\">runc</a>, <a href=\"https://github.com/deislabs/spiderlightning\" target=\"_blank\" rel=\"noopener noreferrer\">slight</a>, and <a href=\"https://www.fermyon.com/spin\" target=\"_blank\" rel=\"noopener noreferrer\">spin</a> shims. <code class=\"language-text\">runc</code> is the default low-level runtime for running containers on Kubernetes and is present on all worker nodes running containerd. <code class=\"language-text\">spin</code> and <code class=\"language-text\">slight</code> are Wasm runtimes for running WebAssembly apps on Kubernetes.</p>\n<p>With the shims installed correctly, run a <code class=\"language-text\">ps</code> command to verify containerd is running.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># ps</span>\nPID     <span class=\"token environment constant\">USER</span>     COMMAND\n<span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span>\n     <span class=\"token number\">58</span>   <span class=\"token number\">0</span>        containerd <span class=\"token parameter variable\">-c</span> /var/lib/rancher/k3s/agent/etc/containerd/config.toml<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>The output is trimmed, but it shows the containerd process is running. The <code class=\"language-text\">-c</code> flag is used to pass containerd a custom location for the <a href=\"https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md\" target=\"_blank\" rel=\"noopener noreferrer\">config.toml</a> file.</p>\n<p>List the contents of this <code class=\"language-text\">config.toml</code> to see the registered runtimes.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ <span class=\"token function\">cat</span> /var/lib/rancher/k3s/agent/etc/containerd/config.toml\n<span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span>\n<span class=\"token punctuation\">[</span>plugins.cri.containerd.runtimes.runc<span class=\"token punctuation\">]</span>\n    runtime_type <span class=\"token operator\">=</span> <span class=\"token string\">\"io.containerd.runc.v2\"</span>\n<span class=\"token punctuation\">[</span>plugins.cri.containerd.runtimes.spin<span class=\"token punctuation\">]</span>\n    runtime_type <span class=\"token operator\">=</span> <span class=\"token string\">\"io.containerd.spin.v1\"</span>\n<span class=\"token punctuation\">[</span>plugins.cri.containerd.runtimes.slight<span class=\"token punctuation\">]</span>\n    runtime_type <span class=\"token operator\">=</span> <span class=\"token string\">\"io.containerd.slight.v1\"</span></code></pre></div>\n<p><code class=\"language-text\">runc</code>, <code class=\"language-text\">spin</code>, and <code class=\"language-text\">slight</code> are all installed and registered with containerd.</p>\n<p>You can repeat these steps for the other two nodes and will get similar results as all three are running containerd and are configured with the <code class=\"language-text\">spin</code> and <code class=\"language-text\">slight</code> Wasm runtimes.</p>\n<p>The next step is to label your nodes.</p>\n<h3 id=\"Ô∏è-configure-node-labels\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-configure-node-labels\" aria-label=\"Ô∏è configure node labels permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üè∑Ô∏è Configure Node Labels</h3>\n<p>We'll add a custom label to a single worker node and use it in a future step to force Wasm apps onto just that node. Run the following command to add the <code class=\"language-text\">spin=yes</code> label to the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> worker node.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl label nodes k3d-wasm-cluster-agent-0 <span class=\"token assign-left variable\">spin</span><span class=\"token operator\">=</span>yes</code></pre></div>\n<p>Verify the operation. Your output will be longer, but only the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> should be displayed.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get nodes --show-labels <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> spin\nNAME                        STATUS   ROLES     <span class=\"token punctuation\">..</span>.  LABELS\nk3d-wasm-cluster-agent-0    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>    <span class=\"token punctuation\">..</span>.  beta.kubernetes<span class=\"token punctuation\">..</span>., <span class=\"token assign-left variable\">spin</span><span class=\"token operator\">=</span>yes</code></pre></div>\n<p>At this point, <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> is the only node with the <code class=\"language-text\">spin=yes</code> label. In the next step, you'll create a RuntimeClass that targets this node.</p>\n<h3 id=\"-create-a-runtimeclass\" style=\"position:relative;\"><a href=\"#-create-a-runtimeclass\" aria-label=\" create a runtimeclass permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèÉ Create a RuntimeClass</h3>\n<p>The following YAML defines a RuntimeClass called <code class=\"language-text\">spin-test</code>. It selects nodes with the <code class=\"language-text\">spin=yes</code> label and specifies the <code class=\"language-text\">spin</code> runtime as the handler.</p>\n<p>Copy and paste the whole block into your terminal to deploy it.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> - <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\napiVersion: node.k8s.io/v1\nkind: RuntimeClass\nmetadata:\n    name: spin-test\nhandler: spin\nscheduling:\n    nodeSelector:\n        spin: \"yes\"\nEOF</span></code></pre></div>\n<p>The following command verifies the RuntimeClass was created and is available.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get runtimeclass\nNAME         HANDLER   AGE\nspin-test    spin      10s</code></pre></div>\n<p>At this point, you have a 3-node Kubernetes cluster, and all three nodes have the <code class=\"language-text\">spin</code> runtime installed. You also have a RuntimeClass that can be used to schedule tasks against the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> node. This means you're ready to run WebAssembly apps on Kubernetes!</p>\n<p>In the next step, you'll deploy a Kubernetes app.</p>\n<h3 id=\"Ô∏è-deploy-an-app\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-deploy-an-app\" aria-label=\"Ô∏è deploy an app permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèóÔ∏è Deploy an App</h3>\n<p>You can find the app code here: <a href=\"https://github.com/spinkube/containerd-shim-spin\" target=\"_blank\" rel=\"noopener noreferrer\">containerd-wasm-shims</a>.</p>\n<p>The following YAML snippet is from the <a href=\"https://github.com/nigelpoulton/spin1/blob/main/app.yml\" target=\"_blank\" rel=\"noopener noreferrer\">app</a> you're about to deploy. The only bit we're interested in is the <code class=\"language-text\">spec.template.spec.runtimeClassName = spin-test</code> field. This tells Kubernetes to use the <code class=\"language-text\">spin-test</code> RuntimeClass you created in the previous step. This will schedule the app to the correct node and ensure it executes with the appropriate handler (runtime).</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> wasm<span class=\"token punctuation\">-</span>spin\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">...</span>\n        <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">runtimeClassName</span><span class=\"token punctuation\">:</span> spin<span class=\"token punctuation\">-</span>test     &lt;&lt;==== Targets the RuntimeClass\n            containers<span class=\"token punctuation\">:</span></code></pre></div>\n<p>Deploy it with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> https://raw.githubusercontent.com/seifrajhi/wasm-k8s/main/wasp-app.yaml</code></pre></div>\n<p>Verify the app was deployed. It might take a few seconds for it to enter the ready state and it will only work if you followed all previous steps.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get deploy\nNAME          READY   UP-TO-DATE   AVAILABLE   AGE\nwasm-spin     <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           14s</code></pre></div>\n<p>Verify it's running on the correct node:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get pods <span class=\"token parameter variable\">-o</span> wide\nNAME                         READY   STATUS    AGE   NODE\nwasm-spin-74cff79dcb-npwwj   <span class=\"token number\">1</span>/1     Running   86s   k3d-wasm-cluster-agent-0</code></pre></div>\n<p>It's running on the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> worker node that has the label and handler specified in the RuntimeClass. Test the app is working by pointing your browser to <a href=\"http://localhost:8081/spin/hello\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:8081/spin/hello</a> or by running the following curl command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-v</span> http://127.0.0.1:8081/spin/hello\n<span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span>\nHello world from Spin<span class=\"token operator\">!</span></code></pre></div>\n<p>Congratulations, the application is successfully deployed to the worker node specified in the RuntimeClass. In the next step, you'll scale the app to prove that all replicas get scheduled to the same node.</p>\n<h3 id=\"-scale-the-app\" style=\"position:relative;\"><a href=\"#-scale-the-app\" aria-label=\" scale the app permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìà Scale the App</h3>\n<p>Increase the number of replicas from 1 to 3:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl scale <span class=\"token parameter variable\">--replicas</span> <span class=\"token number\">3</span> deploy/wasm-spin\ndeployment.apps/wasm-spin scaled</code></pre></div>\n<p>Verify all three Pods are running on the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> node:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get pods <span class=\"token parameter variable\">-o</span> wide\nNAME                         READY   STATUS     AGE     NODE\nwasm-spin-74cff79dcb-npwwj   <span class=\"token number\">1</span>/1     Running    3m32s   k3d-wasm-cluster-agent-0\nwasm-spin-74cff79dcb-vsz7t   <span class=\"token number\">1</span>/1     Running    7s      k3d-wasm-cluster-agent-0\nwasm-spin-74cff79dcb-q4vxr   <span class=\"token number\">1</span>/1     Running    7s      k3d-wasm-cluster-agent-0</code></pre></div>\n<p>The RuntimeClass is doing its job of ensuring the Wasm workloads run on the correct node.</p>\n<h3 id=\"-inspect-the-containerd-processes\" style=\"position:relative;\"><a href=\"#-inspect-the-containerd-processes\" aria-label=\" inspect the containerd processes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîç Inspect the containerd Processes</h3>\n<p>Exec onto the <code class=\"language-text\">k3d-wasm-cluster-agent-0</code> node:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> k3d-wasm-cluster-agent-0 ash</code></pre></div>\n<p>Run the following commands from inside the exec session:</p>\n<p>List running spin processes:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># ps | grep spin</span>\nPID    <span class=\"token environment constant\">USER</span>  COMMAND\n<span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span>\n<span class=\"token number\">1764</span>  <span class=\"token number\">0</span>     <span class=\"token punctuation\">{</span>containerd-shim<span class=\"token punctuation\">}</span><span class=\"token punctuation\">..</span>./bin/containerd-shim-spin-v1 <span class=\"token parameter variable\">-namespace</span> k8s.io <span class=\"token parameter variable\">-id</span> <span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2015</span>  <span class=\"token number\">0</span>     <span class=\"token punctuation\">{</span>containerd-shim<span class=\"token punctuation\">}</span><span class=\"token punctuation\">..</span>./bin/containerd-shim-spin-v1 <span class=\"token parameter variable\">-namespace</span> k8s.io <span class=\"token parameter variable\">-id</span> <span class=\"token punctuation\">..</span>.\n<span class=\"token number\">2017</span>  <span class=\"token number\">0</span>     <span class=\"token punctuation\">{</span>containerd-shim<span class=\"token punctuation\">}</span><span class=\"token punctuation\">..</span>./bin/containerd-shim-spin-v1 <span class=\"token parameter variable\">-namespace</span> k8s.io <span class=\"token parameter variable\">-id</span> <span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>The output is trimmed, but you can see three <code class=\"language-text\">containerd-shim-spin-v1</code> processes. This is one shim process for each of the three replicas.</p>\n<p>The long hex ID attached to each of the three shim processes is the ID of the associated container task. This is because containerd runs each Wasm task inside its own container.</p>\n<p>Run the following command to list containers on the host. Notice how some of the container task IDs match with the hex IDs associated with the spin shim processes from the previous command. The PID also matches the PID of the spin shim processes.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ ctr task <span class=\"token function\">ls</span>\nTASK                                                                PID     STATUS\n3f083847f6818c3f76ff0e9927b3a81f84f4bf1415a32e09f2a37ed2a528aed1    <span class=\"token number\">2015</span>    RUNNING\nf8166727d7d10220e55aa82d6185a0c7b9b7e66a4db77cc5ca4973f1c8909f85    <span class=\"token number\">2017</span>    RUNNING\n78c8b0b17213d895f4758288500dc4e1e88d7aa7181fe6b9d69268dffafbd95b    <span class=\"token number\">1764</span>    RUNNING\n<span class=\"token operator\">&lt;</span>/Snip<span class=\"token operator\">></span></code></pre></div>\n<p>The output is trimmed to only show the Wasm containers.</p>\n<p>You can see more detailed info with the info command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ ctr containers info 3f083847f6<span class=\"token punctuation\">..</span>.a37ed2a528aed1\n<span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span>\n        <span class=\"token string\">\"Runtime\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"io.containerd.spin.v1\"</span>,\n                <span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span>\n                <span class=\"token string\">\"annotations\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"io.kubernetes.cri.container-name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"spin-hello\"</span>,\n                        <span class=\"token string\">\"io.kubernetes.cri.container-type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"container\"</span>,\n                        <span class=\"token string\">\"io.kubernetes.cri.image-name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ghcr.io/deislabs/containerd-wasm-shims/examples/spin-rust-hello:v0.5.1\"</span>,\n                        <span class=\"token string\">\"io.kubernetes.cri.sandbox-id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3f083847f6818c3f76ff0e9927b3a81f84f4bf1415a32e09f2a37ed2a528aed1\"</span>,\n                        <span class=\"token string\">\"io.kubernetes.cri.sandbox-name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"wasm-spin-5bd4bd7b9-kqgjt\"</span>,\n                        <span class=\"token string\">\"io.kubernetes.cri.sandbox-namespace\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"default\"</span>\n                        <span class=\"token operator\">&lt;</span>Snip<span class=\"token operator\">></span></code></pre></div>\n<p>If you examine the output of the previous command, you'll see typical container constructs such as namespaces and cgroups. The WebAssembly app is executing inside the normal WebAssembly sandbox, which, in turn, is executing inside a minimal container.</p>\n<h2 id=\"-summary\" style=\"position:relative;\"><a href=\"#-summary\" aria-label=\" summary permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üçâ Summary</h2>\n<p>WebAssembly is a new technology that is changing the way cloud-native applications are developed and deployed. It is now possible to run WebAssembly applications on Kubernetes, which means that developers can take advantage of the performance, security, and portability of WebAssembly while also benefiting from the scalability and manageability of Kubernetes.</p>\n<p>To run WebAssembly applications on Kubernetes, you need to bootstrap Kubernetes worker nodes with a WebAssembly runtime and use RuntimeClasses to map WebAssembly applications to the appropriate nodes. This is a relatively new process, but it is becoming increasingly popular as WebAssembly matures and becomes more widely adopted.\n<br></p>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}