{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/data-on-kubernetes-ai-ml-5/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p><strong>Using Kubernetes to deploy and scale AI/ML models efficiently üìà</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üìö Introduction</h2>\n<p>Welcome back to our 'Data on Kubernetes' series. In this fifth part, we're focusing on AI and machine learning (ML). We'll discuss how Kubernetes is transforming the use of <a href=\"https://ai.engineering.columbia.edu/ai-vs-machine-learning/\" target=\"_blank\" rel=\"noopener noreferrer\">AI/ML</a> software.</p>\n<p>The more we rely on <a href=\"https://ai.engineering.columbia.edu/ai-vs-machine-learning/\" target=\"_blank\" rel=\"noopener noreferrer\">AI/ML</a>, the more complex it becomes to manage these systems. Kubernetes offers a helping hand with features that allow AI/ML software to automatically adjust their size, update without stopping, and repair themselves. This keeps AI/ML systems always on and working smoothly.</p>\n<p>In this blog, we'll discover the tools <a href=\"https://www.ray.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Ray</a> and <a href=\"https://pytorch.org/\" target=\"_blank\" rel=\"noopener noreferrer\">PyTorch</a>, and their integration with Kubernetes to simplify the process, all within the AWS cloud ecosystem.</p>\n<h2 id=\"-kubernetes-making-aiml-easier\" style=\"position:relative;\"><a href=\"#-kubernetes-making-aiml-easier\" aria-label=\" kubernetes making aiml easier permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Kubernetes: Making AI/ML Easier</h2>\n<p>When we use AI and ML, things can get pretty tricky. It's exciting but can also be a bit overwhelming with all the pieces you need to keep track of and there's a lot to manage. That's exactly why Kubernetes comes in‚Ää‚Äî‚Ääit's like having a smart assistant that helps keep everything in order.</p>\n<p>Kubernetes is great because it can fix itself. If something goes wrong with an AI program, Kubernetes doesn't wait around; it jumps right in to fix the problem.</p>\n<p>This means if an AI program stops working, Kubernetes doesn't just stand by. It jumps into action, fixing things up or starting fresh so that there's no downtime. This means you can rely on your AI and ML to work non-stop.</p>\n<p>But that's not all. Kubernetes is also smart about using resources. Sometimes AI needs more resources to work on big tasks, and sometimes it needs less.</p>\n<p>Kubernetes is smart enough to adjust on the fly, giving them more resources when they're busy and scaling back when they're not. This way, you're not wasting any energy or money, and everything runs super efficiently.</p>\n<h3 id=\"Ô∏è-ray-and-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-ray-and-kubernetes\" aria-label=\"Ô∏è ray and kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Ray and Kubernetes</h3>\n<p>When working with AI and ML tasks, we require tools that can manage extensive workloads efficiently.</p>\n<p><a href=\"https://www.ray.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Ray</a> is such a tool, designed for <a href=\"https://www.python.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Python</a>, a widely-used programming language. It simplifies the execution of large-scale projects on multiple computers simultaneously.</p>\n<p>Ray serves as a comprehensive toolkit for deep learning, an AI branch that equips computers with cognitive abilities.</p>\n<p><a href=\"https://ray-project.github.io/q4-2021-docs-hackathon/0.4/ray-overview/what-and-why-ray/\" target=\"_blank\" rel=\"noopener noreferrer\">Developed by experts at UC Berkeley</a>, Ray's objective is to streamline large computing projects. It consists of Ray Core, the primary component for distributing tasks across computers, and Ray Ecosystem, a suite of specialized tools for various purposes, including project optimization and decision-making algorithms.</p>\n<p>While similar to Dask, a tool for executing Python code concurrently in different locations and processing multiple data-related tasks simultaneously, Ray stands out.</p>\n<p>It doesn't merely replicate existing tools like NumPy and Pandas; it's engineered to be versatile, catering to a wide array of projects beyond data science. Its adaptability has led major projects such as spaCy, Hugging Face, and XGBoost to incorporate Ray, enhancing their efficiency and intelligence.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 38.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACiElEQVR42jWNa0hTcRjG/0Rk60ZgWrpVNAXXEiqOSK3LiEqjDGJS9CGx9sFKmjQlqFGNxgwNUUaSac7Qpc7j5mWZ7qpubmM3d8s8m1vokTPmTAzTrTT1dFb5wI/39jy8AACwm82+eZzDKaMTPYkggWArk8mkMCBGWnY6mQJRqQfoSUk7iP0Wgu3xDKCcILwUklDIIwt5D1Po/24JAF9dLR73OGQ2j89qnp4mcV04GQD2zkk5tSGoO8UCd3Ey5WVLetozGEodxxNPJydcID7ermV9OFi5n52q0qhNGq2hY/DrEs8686sUYFgoUuFcYDAbbZlQO5rGEkqv5tziHjXKS3het+J5LBrT+GbnB8XukL7Iht85n3P5EiNlzxlWXj2Ne6WOPOoNcFDLo67eNq5UUNNcDv4qW7QLHLueBAr79hHTZhqNlih4VVeuUqp7IohzyhWYCrfYglNdI2OFxp5GgVfxrmTvxbJkCIK2xeMYDERNgizkWv69t0DtCMBqO9I+6PC3Km1+WO0ISrWjwQ6dHZG2Gv1wtcorVwzZ5Z+sPrnK7JWp9Hat0uTS9Bs9HR8NLqlixN3ZZ/JKldYJucLgrgG+uXX8c3h5fWxmBf8SWcE9odiaA12KIdjSmiG48EPinotpXOhvJ7qwaguEoyYEi1qC84uW4NyyNfANj2OZmF0LfMdxJ7roB2/ggYw49TIlrbq1jypVas9ZzOaqim59bqYKG8gaCj9BqwsKawXiG6VNkSp+E/JULBbr2jq7X0j6LZTmLvVhSY8u4z2Rb4B7D4EN8fn8TfGqNRjoky6zoMCE5ZGGoxKS/ucDWfOR3LOPh08WvV6svC8KcRrrRHIYhovjfvx/bkN/AMWvUIIkJ3LDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"ray\" title=\"\" src=\"/static/4abe3f459ce22fb22fa13e41f0905d5f/c5bb3/ray.png\" srcset=\"/static/4abe3f459ce22fb22fa13e41f0905d5f/04472/ray.png 170w,\n/static/4abe3f459ce22fb22fa13e41f0905d5f/9f933/ray.png 340w,\n/static/4abe3f459ce22fb22fa13e41f0905d5f/c5bb3/ray.png 680w,\n/static/4abe3f459ce22fb22fa13e41f0905d5f/b12f7/ray.png 1020w,\n/static/4abe3f459ce22fb22fa13e41f0905d5f/b5a09/ray.png 1360w,\n/static/4abe3f459ce22fb22fa13e41f0905d5f/2cefc/ray.png 1400w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://medium.com/pytorch/getting-started-with-distributed-machine-learning-with-pytorch-and-ray-fd83c98fdead\">Source</a></div>\n<p>The diagram above shows that at a high level, the Ray ecosystem consists of:</p>\n<ul>\n<li>The core Ray system</li>\n<li>Scalable libraries for machine learning (both native and third party)</li>\n<li>Tools for <a href=\"https://medium.com/distributed-computing-with-ray/how-to-scale-python-on-every-major-cloud-provider-12b3bde01208\" target=\"_blank\" rel=\"noopener noreferrer\">launching clusters on any cluster or cloud provider</a></li>\n</ul>\n<p>KubeRay amplifies Ray's capabilities by integrating it with Kubernetes, a platform that orchestrates numerous computers working in unison. This integration combines Ray's user-friendly Python interface with Kubernetes' robust and dependable framework.</p>\n<p>The result is a great system capable of developing, operating, and maintaining large-scale projects easily. It's akin to an advanced system that scales with your requirements, self-repairs, and autonomously performs maintenance and updates.</p>\n<p>The use of Kubernetes is advantageous for Ray. It acts as a command center for computers, ensuring smooth operation and task management. Kubernetes excels with both tools, adeptly managing numerous tasks without confusion.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfElEQVR42lVR2VLcMBD0/39RXvLKoykCbAxsFvbyWpLlS7Zl6+qMZHKgqi71HN010mTOOTjn8ef23mNdV3DGIIRIYJxj0QvVwmfvP2itUV6vqOs6abNARsQ+sfGYY+0AwRlu1wu6tkm1kOpfMc0aH6cLJBmGEJCxyaEcDW6jxW3yqChms8dp9BQ7yhtwTXnKsdlB6ACeeITF6ijuNBZ6VTzZmUSv+194ez+BLcDhdMaxrFAqCyFbiKZDLSXemwln0aBkAiWvcRMSh97A0rP5oDGYAMQJi87hWS7YNSseG4vnWqc4ZzPu9iXhisdK4UEa5HzBPdcJOeGpMTRTwMN+BG83nr31Dk8tmSaQYefxc6AmpvD9xyu+5QXuiRcKKKj3RXkUVN/1HlFrLH1VxaHUuP1h3G7cTgTFsEpCDxJVH5AfDYLROO5KTKrHy2XF4dKjbQQGpZJB1MUTefTKIvkf3hk4a7AYj27a+NjP6Va0iHE2MGaFpcn+atIwG/8NhIhlZU3+KBUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"kuberay\" title=\"\" src=\"/static/a78dd992dd6340928c4606a616df4d61/c5bb3/kuberay.png\" srcset=\"/static/a78dd992dd6340928c4606a616df4d61/04472/kuberay.png 170w,\n/static/a78dd992dd6340928c4606a616df4d61/9f933/kuberay.png 340w,\n/static/a78dd992dd6340928c4606a616df4d61/c5bb3/kuberay.png 680w,\n/static/a78dd992dd6340928c4606a616df4d61/b12f7/kuberay.png 1020w,\n/static/a78dd992dd6340928c4606a616df4d61/b5a09/kuberay.png 1360w,\n/static/a78dd992dd6340928c4606a616df4d61/29007/kuberay.png 1600w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://docs.ray.io/en/latest/cluster/kubernetes/index.html\">Source</a></div>\n<h3 id=\"-pytorch-and-kubernetes\" style=\"position:relative;\"><a href=\"#-pytorch-and-kubernetes\" aria-label=\" pytorch and kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üî• PyTorch and Kubernetes</h3>\n<p><a href=\"https://pytorch.org/\" target=\"_blank\" rel=\"noopener noreferrer\">PyTorch</a> is an open-source machine learning library for Python, widely used for applications such as natural language processing, computer vision, and deep learning.</p>\n<p>What makes PyTorch special is its ease of use, flexibility, and dynamic computational graph, which allows for quick prototyping and experimentation. Researchers like it because it's designed to work well with Python and makes deep learning straightforward.</p>\n<h4 id=\"pytorch-and-tensorflow\" style=\"position:relative;\"><a href=\"#pytorch-and-tensorflow\" aria-label=\"pytorch and tensorflow permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>PyTorch and TensorFlow</h4>\n<p><a href=\"https://pytorch.org/\" target=\"_blank\" rel=\"noopener noreferrer\">PyTorch</a> and <a href=\"https://www.tensorflow.org/\" target=\"_blank\" rel=\"noopener noreferrer\">TensorFlow</a> are both strong in deep learning, but they're good at different things. TensorFlow, made by Google, is great for getting big machine learning models ready for use and for training them on many computers at once.</p>\n<p>PyTorch is more about being easy to work with and changing things as you go, which is really helpful when you're still figuring things out.</p>\n<h4 id=\"pytorch-with-ray-and-kuberay\" style=\"position:relative;\"><a href=\"#pytorch-with-ray-and-kuberay\" aria-label=\"pytorch with ray and kuberay permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>PyTorch with Ray and KubeRay</h4>\n<p>When PyTorch works together with Ray or KubeRay, it gets even better at deep learning jobs. Ray and KubeRay help spread out the work over many computers, making things faster and more reliable.</p>\n<p>This integration facilitates the distribution of computational tasks across multiple nodes, enabling faster processing times and resilience against individual node failures.</p>\n<p>They also make better use of cloud services, saving money. This combination means developers can spend more time being creative with their machine learning models, while the tough tech stuff is taken care of.</p>\n<h4 id=\"pytorch-meets-kubernetes\" style=\"position:relative;\"><a href=\"#pytorch-meets-kubernetes\" aria-label=\"pytorch meets kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>PyTorch meets Kubernetes</h4>\n<p>By using PyTorch with Kubernetes (also known as k8s), you get all the perks of Kubernetes' smart way of managing containers. Kubernetes helps set up, grow, and manage containers over lots of computers.</p>\n<p>This means PyTorch applications can handle big, complicated jobs better, grow more easily, and keep running smoothly. Developers can then put more energy into making their models, without worrying too much about the tech behind it.</p>\n<h2 id=\"Ô∏è-hands-on-ray-on-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-hands-on-ray-on-kubernetes\" aria-label=\"Ô∏è hands on ray on kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üõ†Ô∏è Hands-on: Ray on Kubernetes</h2>\n<p>Our setup consists of a Kubernetes cluster in Amazon EKS, which hosts our AI applications. The recommended method for installing Ray onto a Kubernetes cluster is through KubeRay, a Kubernetes Operator. The KubeRay Operator allows you to create and manage Ray clusters in a Kubernetes-native way by defining clusters as a custom resource called a RayCluster.</p>\n<p>The installation of KubeRay Operator involves deploying the operator and the CRDs for RayCluster, RayJob, and RayService as documented <a href=\"https://docs.ray.io/en/latest/cluster/kubernetes/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>This RayCluster resource describes the desired state of a Ray cluster. The KubeRay Operator manages the cluster lifecycle, autoscaling, and monitoring functions.</p>\n<p>Hence, we use the KubeRay Operator for our Ray cluster installation.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 63.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeUlEQVR42o2SiW7CQAxE8/9/iBQgQuIIRw4ICWkSu35ujQiiUleabuNjPDsmUdWH4esV0zQ98Z4LjOPooIbzG+8T+zPpP06e57perzXLMl2tVno4HPR0Onn8er3q44EulRmhTfNEVVVa17XebjdlOPGyLLVtW+26zuOQXS4XPZ/PfxOSoCBNUwdKIC6KwklEZKaaAeAlPiekCTXDMDhQhwrUMIj/qUENT91ut7rb7Tz/UeH9fvcnoQqypmncK4gAJPv93uuowZq+79WWEyp/CPlAGdODBKAKFRDQyE3d+5k92QomJgAmQogamgHfx+PRgQ3UhSUM4SUBo5LECqYwF1UsAKLYOhYwKIZByGEoQ/CPm/yTED/YcBDi1XK59C3TgG/c5FGFOnKLxUI3m40T0hOEo5GJkYr91sQIxbwUa3LYZDE1nuO2p4mRCj1GIqZajND7sc8V8gyeB2JjgYgHiFETi8Iq7uhNrKAwSypgwY94z8f3K4gbV/kNppPvlhafGiUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"kuberay operator\" title=\"\" src=\"/static/0fe3a262cf7937c74bc1df905770e678/c5bb3/kuberay-op.png\" srcset=\"/static/0fe3a262cf7937c74bc1df905770e678/04472/kuberay-op.png 170w,\n/static/0fe3a262cf7937c74bc1df905770e678/9f933/kuberay-op.png 340w,\n/static/0fe3a262cf7937c74bc1df905770e678/c5bb3/kuberay-op.png 680w,\n/static/0fe3a262cf7937c74bc1df905770e678/b12f7/kuberay-op.png 1020w,\n/static/0fe3a262cf7937c74bc1df905770e678/c61d0/kuberay-op.png 1145w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://medium.com/sage-ai/demystifying-the-process-of-building-a-ray-cluster-110c67914a99\">Source</a></div>\n<p>KubeRay Operator managing the Ray Cluster lifecycle. Now let us deploy the infrastructure. Start by cloning the repo and change the working directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone https://github.com/seifrajhi/data-on-eks\n<span class=\"token builtin class-name\">cd</span> data-on-eks/ai-ml/ray/terraform</code></pre></div>\n<p>Next, we can use the shell script <code class=\"language-text\">install.sh</code> to run the <code class=\"language-text\">terraform init</code> and <code class=\"language-text\">apply</code> commands.</p>\n<p>Update <code class=\"language-text\">variables.tf</code> to change the region. Also, we can update any other input variables or make any other changes to the terraform template.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">./install.sh</code></pre></div>\n<p>And now, we can run the PyTorch benchmark.</p>\n<p>We deploy a Ray Cluster with its own configuration for Karpenter workers. Different jobs can have different requirements for Ray Cluster such as a different version of Ray libraries or EC2 instance configuration such as making use of Spot market or GPU instances.</p>\n<p>To deploy the Ray cluster run below commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> examples/pytorch\nterraform init\nterraform plan\nterraform apply -auto-approve</code></pre></div>\n<p>Once running, we can forward the port for the server:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl port-forward service/pytorch-kuberay-head-svc <span class=\"token parameter variable\">-n</span> pytorch <span class=\"token number\">8266</span>:8265</code></pre></div>\n<p>We can then submit the job for PyTorch benchmark workload:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">python job/pytorch_submit.py</code></pre></div>\n<p>You can open <a href=\"http://localhost:8266\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:8266</a> to monitor the progress of the PyTorch benchmark.</p>\n<p>The <code class=\"language-text\">pytorch_submit.py</code> script is a benchmarking for evaluating the performance of training and tuning a PyTorch model on a distributed system using Ray.</p>\n<p>It measures the time taken to train a model and to find the best hyperparameters through tuning, providing insights into the efficiency of distributed machine learning workflows.</p>\n<h2 id=\"-key-takeaways\" style=\"position:relative;\"><a href=\"#-key-takeaways\" aria-label=\" key takeaways permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üîö Key Takeaways</h2>\n<p>Kubernetes makes working with AI/ML simpler. It scales AI/ML models easily and keeps them running smoothly. With Kubernetes, Ray, and PyTorch work better in the cloud, making AI/ML systems more reliable and easier to manage.</p>\n<br>\n<br>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìªüß° References:</strong></p>\n<ul>\n<li><a href=\"https://docs.ray.io/en/latest/cluster/kubernetes/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.ray.io/en/latest/cluster/kubernetes/index.html</a></li>\n<li><a href=\"https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/\" target=\"_blank\" rel=\"noopener noreferrer\">https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/</a></li>\n<li><a href=\"https://aws.amazon.com/blogs/opensource/scaling-ai-and-machine-learning-workloads-with-ray-on-aws\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws.amazon.com/blogs/opensource/scaling-ai-and-machine-learning-workloads-with-ray-on-aws</a></li>\n<li><a href=\"https://cloud.google.com/blog/products/containers-kubernetes/use-ray-on-kubernetes-with-kuberay\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/blog/products/containers-kubernetes/use-ray-on-kubernetes-with-kuberay</a></li>\n</ul>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>","timeToRead":6,"rawMarkdownBody":"\n> **Using Kubernetes to deploy and scale AI/ML models efficiently üìà**\n\n## üìö Introduction\n\nWelcome back to our 'Data on Kubernetes' series. In this fifth part, we're focusing on AI and machine learning (ML). We'll discuss how Kubernetes is transforming the use of [AI/ML](https://ai.engineering.columbia.edu/ai-vs-machine-learning/) software.\n\nThe more we rely on [AI/ML](https://ai.engineering.columbia.edu/ai-vs-machine-learning/), the more complex it becomes to manage these systems. Kubernetes offers a helping hand with features that allow AI/ML software to automatically adjust their size, update without stopping, and repair themselves. This keeps AI/ML systems always on and working smoothly.\n\nIn this blog, we'll discover the tools [Ray](https://www.ray.io/) and [PyTorch](https://pytorch.org/), and their integration with Kubernetes to simplify the process, all within the AWS cloud ecosystem.\n\n## üöÄ Kubernetes: Making AI/ML Easier\n\nWhen we use AI and ML, things can get pretty tricky. It's exciting but can also be a bit overwhelming with all the pieces you need to keep track of and there's a lot to manage. That's exactly why Kubernetes comes in‚Ää‚Äî‚Ääit's like having a smart assistant that helps keep everything in order.\n\nKubernetes is great because it can fix itself. If something goes wrong with an AI program, Kubernetes doesn't wait around; it jumps right in to fix the problem.\n\nThis means if an AI program stops working, Kubernetes doesn't just stand by. It jumps into action, fixing things up or starting fresh so that there's no downtime. This means you can rely on your AI and ML to work non-stop.\n\nBut that's not all. Kubernetes is also smart about using resources. Sometimes AI needs more resources to work on big tasks, and sometimes it needs less.\n\nKubernetes is smart enough to adjust on the fly, giving them more resources when they're busy and scaling back when they're not. This way, you're not wasting any energy or money, and everything runs super efficiently.\n\n### üõ†Ô∏è Ray and Kubernetes\n\nWhen working with AI and ML tasks, we require tools that can manage extensive workloads efficiently.\n\n[Ray](https://www.ray.io/) is such a tool, designed for [Python](https://www.python.org/), a widely-used programming language. It simplifies the execution of large-scale projects on multiple computers simultaneously.\n\nRay serves as a comprehensive toolkit for deep learning, an AI branch that equips computers with cognitive abilities.\n\n[Developed by experts at UC Berkeley](https://ray-project.github.io/q4-2021-docs-hackathon/0.4/ray-overview/what-and-why-ray/), Ray's objective is to streamline large computing projects. It consists of Ray Core, the primary component for distributing tasks across computers, and Ray Ecosystem, a suite of specialized tools for various purposes, including project optimization and decision-making algorithms.\n\nWhile similar to Dask, a tool for executing Python code concurrently in different locations and processing multiple data-related tasks simultaneously, Ray stands out.\n\nIt doesn't merely replicate existing tools like NumPy and Pandas; it's engineered to be versatile, catering to a wide array of projects beyond data science. Its adaptability has led major projects such as spaCy, Hugging Face, and XGBoost to incorporate Ray, enhancing their efficiency and intelligence.\n\n![ray](./ray.png)\n<div class=\"image-title\"><a href=\"https://medium.com/pytorch/getting-started-with-distributed-machine-learning-with-pytorch-and-ray-fd83c98fdead\">Source</a></div>\n\nThe diagram above shows that at a high level, the Ray ecosystem consists of:\n\n- The core Ray system\n- Scalable libraries for machine learning (both native and third party)\n- Tools for [launching clusters on any cluster or cloud provider](https://medium.com/distributed-computing-with-ray/how-to-scale-python-on-every-major-cloud-provider-12b3bde01208)\n\nKubeRay amplifies Ray's capabilities by integrating it with Kubernetes, a platform that orchestrates numerous computers working in unison. This integration combines Ray's user-friendly Python interface with Kubernetes' robust and dependable framework.\n\nThe result is a great system capable of developing, operating, and maintaining large-scale projects easily. It's akin to an advanced system that scales with your requirements, self-repairs, and autonomously performs maintenance and updates.\n\nThe use of Kubernetes is advantageous for Ray. It acts as a command center for computers, ensuring smooth operation and task management. Kubernetes excels with both tools, adeptly managing numerous tasks without confusion.\n\n![kuberay](./kuberay.png)\n<div class=\"image-title\"><a href=\"https://docs.ray.io/en/latest/cluster/kubernetes/index.html\">Source</a></div>\n\n### üî• PyTorch and Kubernetes\n\n[PyTorch](https://pytorch.org/) is an open-source machine learning library for Python, widely used for applications such as natural language processing, computer vision, and deep learning.\n\nWhat makes PyTorch special is its ease of use, flexibility, and dynamic computational graph, which allows for quick prototyping and experimentation. Researchers like it because it's designed to work well with Python and makes deep learning straightforward.\n\n#### PyTorch and TensorFlow\n\n[PyTorch](https://pytorch.org/) and [TensorFlow](https://www.tensorflow.org/) are both strong in deep learning, but they're good at different things. TensorFlow, made by Google, is great for getting big machine learning models ready for use and for training them on many computers at once.\n\nPyTorch is more about being easy to work with and changing things as you go, which is really helpful when you're still figuring things out.\n\n#### PyTorch with Ray and KubeRay\n\nWhen PyTorch works together with Ray or KubeRay, it gets even better at deep learning jobs. Ray and KubeRay help spread out the work over many computers, making things faster and more reliable.\n\nThis integration facilitates the distribution of computational tasks across multiple nodes, enabling faster processing times and resilience against individual node failures.\n\nThey also make better use of cloud services, saving money. This combination means developers can spend more time being creative with their machine learning models, while the tough tech stuff is taken care of.\n\n#### PyTorch meets Kubernetes\n\nBy using PyTorch with Kubernetes (also known as k8s), you get all the perks of Kubernetes' smart way of managing containers. Kubernetes helps set up, grow, and manage containers over lots of computers.\n\nThis means PyTorch applications can handle big, complicated jobs better, grow more easily, and keep running smoothly. Developers can then put more energy into making their models, without worrying too much about the tech behind it.\n\n## üõ†Ô∏è Hands-on: Ray on Kubernetes\n\nOur setup consists of a Kubernetes cluster in Amazon EKS, which hosts our AI applications. The recommended method for installing Ray onto a Kubernetes cluster is through KubeRay, a Kubernetes Operator. The KubeRay Operator allows you to create and manage Ray clusters in a Kubernetes-native way by defining clusters as a custom resource called a RayCluster.\n\nThe installation of KubeRay Operator involves deploying the operator and the CRDs for RayCluster, RayJob, and RayService as documented [here](https://docs.ray.io/en/latest/cluster/kubernetes/index.html).\n\nThis RayCluster resource describes the desired state of a Ray cluster. The KubeRay Operator manages the cluster lifecycle, autoscaling, and monitoring functions.\n\nHence, we use the KubeRay Operator for our Ray cluster installation.\n\n![kuberay operator](./kuberay-op.png)\n<div class=\"image-title\"><a href=\"https://medium.com/sage-ai/demystifying-the-process-of-building-a-ray-cluster-110c67914a99\">Source</a></div>\n\nKubeRay Operator managing the Ray Cluster lifecycle. Now let us deploy the infrastructure. Start by cloning the repo and change the working directory.\n\n```shell\ngit clone https://github.com/seifrajhi/data-on-eks\ncd data-on-eks/ai-ml/ray/terraform\n```\n\nNext, we can use the shell script `install.sh` to run the `terraform init` and `apply` commands.\n\nUpdate `variables.tf` to change the region. Also, we can update any other input variables or make any other changes to the terraform template.\n\n```shell\n./install.sh\n```\n\nAnd now, we can run the PyTorch benchmark.\n\nWe deploy a Ray Cluster with its own configuration for Karpenter workers. Different jobs can have different requirements for Ray Cluster such as a different version of Ray libraries or EC2 instance configuration such as making use of Spot market or GPU instances.\n\nTo deploy the Ray cluster run below commands:\n\n```shell\ncd examples/pytorch\nterraform init\nterraform plan\nterraform apply -auto-approve\n```\n\nOnce running, we can forward the port for the server:\n\n```shell\nkubectl port-forward service/pytorch-kuberay-head-svc -n pytorch 8266:8265\n```\n\nWe can then submit the job for PyTorch benchmark workload:\n\n```shell\npython job/pytorch_submit.py\n```\n\nYou can open [http://localhost:8266](http://localhost:8266) to monitor the progress of the PyTorch benchmark.\n\nThe `pytorch_submit.py` script is a benchmarking for evaluating the performance of training and tuning a PyTorch model on a distributed system using Ray.\n\nIt measures the time taken to train a model and to find the best hyperparameters through tuning, providing insights into the efficiency of distributed machine learning workflows.\n\n## üîö Key Takeaways\n\nKubernetes makes working with AI/ML simpler. It scales AI/ML models easily and keeps them running smoothly. With Kubernetes, Ray, and PyTorch work better in the cloud, making AI/ML systems more reliable and easier to manage.\n\n<br>\n<br>\n\n> üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  **_Until next time üéâ_**\n\n\nüöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:\n\n**‚ôªÔ∏è LinkedIn:** https://www.linkedin.com/in/rajhi-saif/\n\n**‚ôªÔ∏è X/Twitter:** https://x.com/rajhisaifeddine\n\n**The end ‚úåüèª**\n\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n\n**üìªüß° References:**\n\n- https://docs.ray.io/en/latest/cluster/kubernetes/index.html\n- https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/\n- https://aws.amazon.com/blogs/opensource/scaling-ai-and-machine-learning-workloads-with-ray-on-aws\n- https://cloud.google.com/blog/products/containers-kubernetes/use-ray-on-kubernetes-with-kuberay\n\n**üìÖ Stay updated**\n\nSubscribe to our newsletter for more insights on AWS cloud computing and containers.\n","wordCount":{"words":1348},"frontmatter":{"id":"2c77221c9d5636c2ea28a663","path":"/blog/data-on-kubernetes-ai-ml-5/","humanDate":"Oct 25, 2024","fullDate":"2024-10-25","title":"Data on Kubernetes: Part 5‚Ää-‚ÄäMaking AI/ML simpler","keywords":["Kubernetes","AI/ML","EKS","Model Deployment","Scalability"],"excerpt":"Explore how Kubernetes simplifies the deployment and scaling of AI/ML models on EKS.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC5UlEQVR42g2Sa3MaBRSG+Ul+UdPxFqeaWm2bZDTtCG0DaZLlHtgCYWG5X8Ntl13uEEBImKRNqrYJCm0c/eTX/gQ/90887qcz884575z3OcekThdUxm/oX7ylPPyNeOOMROslcvOCaOtXop3XRLtXRHtXRIwq96+JDa6JH89Jj+fUL/+meP4XlVf/YB8uMHXP5wymJ2i9HjlFJVGuE8io+LN1vNkGQkzDkWxgj+l4Mg28GQ2xqBOqNZEaDcO8S+b0GHk6YPv4ElNRe8Hp7JxWZ0Sx3EbvTElme5RrQ+rtM4LxJkVtQlYbMZxdovYmVPpjSv0hzZMTEo06imHamox4pI4xFZQzqmqLTndCp39KsdYlEKtzmGlhe14ir/9CtNoztlMJl5sECwpSqY4jc0RWb1LqdBjMpjgKaTYKA0y51u9IaQ1PrMG+VGddKPDdfpY9uUpSaVPpDtEGI0L5GuGSSqnVMyJr3D+QeSLleZbOIdYqPNer2PRTTN7qGVapyKYvzheuFF/vxbj9VGJzXyZRaiKmFYObgjXWxpObIGYqPPDIfLonsuoKsh6OYEmG8WsVzNUZpp1ih5/EQx6EE3ySOeFWtMtdyx5fbuzy8T0rnz1yceuhD0/zP8KDD3z0pMiKkGLVc8TaQZUNKYU5LSGoeZ72DIYOpY+k19lOxlk12K1FSqzvurlnOeCHbR93bCG+soaxHf2Lvf6eb7wa39qNPnea7/1HbMkpHuei2Ap51nwtTMH+BeM3C5y5PGZJQgx4Mbvd3LU6uWOx8/lDJytbHlY2BW4/C7EVnPCjfcR9Ic+mI4AlFEFIpfArDcx5I3Lt4oaa8ZxCfIYzNiN2aLAKdTAH2my5qph9bczOBpYdnR3XkMf+K34Wr3HIL/Clp0TKxozy0rj4a/zqHJPcfYWoL7FnlwiRJbvBdwjJG+zxBfboEod4gzN+g8vQXPI7nOE/DP1P3NEF3sRbDhJLfPEl3pyhleb8Dz0ILAnLxu1pAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/11350ee12dbbab2a6cb82c52ec843057/c8e30/dok5.png","srcSet":"/static/11350ee12dbbab2a6cb82c52ec843057/f95e9/dok5.png 750w,\n/static/11350ee12dbbab2a6cb82c52ec843057/34087/dok5.png 1080w,\n/static/11350ee12dbbab2a6cb82c52ec843057/1c572/dok5.png 1366w,\n/static/11350ee12dbbab2a6cb82c52ec843057/c8e30/dok5.png 1600w","sizes":"100vw"},"sources":[{"srcSet":"/static/11350ee12dbbab2a6cb82c52ec843057/4e534/dok5.webp 750w,\n/static/11350ee12dbbab2a6cb82c52ec843057/e5dd4/dok5.webp 1080w,\n/static/11350ee12dbbab2a6cb82c52ec843057/1de46/dok5.webp 1366w,\n/static/11350ee12dbbab2a6cb82c52ec843057/289c2/dok5.webp 1600w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.565625}}},"coverCredits":"Photo by Saifeddine Rajhi"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/data-on-kubernetes-airflow-on-aws-3/","title":"Data on Kubernetes: Part 3‚Ää-‚ÄäManaging Workflows with Job Schedulers and Batch-Oriented Workflow Orchestrators","date":"2024-10-25 14:06:00"},"excerpt":"Automate and orchestrate data workflows in Kubernetes with Amazon managed Apache Airflow üî∑ Introduction Welcome back to this blog series on‚Ä¶","html":"<blockquote>\n<p><strong>Automate and orchestrate data workflows in Kubernetes with Amazon managed Apache Airflow</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üî∑ Introduction</h2>\n<p>Welcome back to this blog series on Data on Kubernetes! In this third part, we're going to focus on how to manage workflows effectively using job schedulers and orchestrators. We'll be looking at tools specifically designed for batch workloads, scientific computing, machine learning workflows, and parallel tasks.</p>\n<p>One of the tools we'll explore is <a href=\"https://docs.aws.amazon.com/mwaa/latest/userguide/what-is-mwaa.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon Managed Workflows for Apache Airflow MWAA</a>, a great service that helps manage data pipelines, machine learning workflows, and batch processing.</p>\n<h2 id=\"deep-dive-into-job-schedulers-and-workflow-orchestrators\" style=\"position:relative;\"><a href=\"#deep-dive-into-job-schedulers-and-workflow-orchestrators\" aria-label=\"deep dive into job schedulers and workflow orchestrators permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Deep Dive into Job Schedulers and Workflow Orchestrators</h2>\n<p>Nowadays, in the modern <a href=\"https://www.forbes.com/sites/googlecloud/2020/05/20/how-the-world-became-data-driven-and-whats-next/\" target=\"_blank\" rel=\"noopener noreferrer\">data-driven IT world</a>, the management and automation of data workflows are becoming more and more important. This is where Job Schedulers and Batch-Oriented Workflow Orchestrators come into play.</p>\n<p>These platforms are designed to manage and automate various data processes in a systematic and efficient manner. Consider the example of an ETL (Extract, Transform, Load) process, a common scenario in data workflows. In this process, data is extracted from various sources, transformed into a suitable format, and then loaded into a data warehouse for further analysis. Managing this process manually can be challenging and prone to errors.</p>\n<p>This is where Job Schedulers and Workflow Orchestrators prove their worth. They automate these tasks, ensuring that the ETL process runs smoothly and efficiently. Furthermore, they enhance the portability and scalability of our workflows, which is important when dealing with large volumes of data or complex machine learning models.</p>\n<p>Apart from ETL processes, there are other scenarios where Job Schedulers and Workflow Orchestrators can be beneficial. For instance, in machine learning pipelines, where data preprocessing, model training, model evaluation, and model deployment need to be executed in a specific order. Another example could be data synchronization tasks between different systems, which require precise timing and error handling.</p>\n<p>There are several tools available that can help manage these workflows. <a href=\"https://airflow.apache.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Apache Airflow</a> is a platform designed to programmatically author, schedule, and monitor workflows. <a href=\"https://www.kubeflow.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubeflow</a> is a Kubernetes-native platform for developing, orchestrating, deploying, and running scalable and portable machine learning workloads. <a href=\"https://argoproj.github.io/workflows/\" target=\"_blank\" rel=\"noopener noreferrer\">Argo Workflows</a> is an open-source container-native workflow engine for orchestrating parallel jobs on Kubernetes.</p>\n<p>In this blog, we will focus specifically on <a href=\"https://docs.aws.amazon.com/mwaa/latest/userguide/what-is-mwaa.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Managed Workflows for Apache Airflow MWAA</a>. This service makes it easier to set up and operate end-to-end data pipelines in the cloud at scale. Airflow is an open-source workflow management platform. Workflows are defined with <a href=\"https://en.wikipedia.org/wiki/Directed_acyclic_graph\" target=\"_blank\" rel=\"noopener noreferrer\">DAGs</a>, Configuration as code written in Python.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.70588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAByklEQVR42o1T2Y6jMBDk/79xtTvKJFzmBh+A7ZpqkyjKwMO2ZNmioVxHk+FX7auFnif41UEvM4ZhwGY1rF6wco/Bf34Q48eenQCdRpU/oCcCOQtrLZahQ9fUmLgfgDEBxBjSO8s4IGzrEzC+m1LBe4xk5UNAeK6Y+jGddzKfhh4zL3RmgRl7DHWBua0JapEJk6au4fScALdtQ1EUsM5h33csywLVNFjXNfU2AlpaYbgE3JOZnGdhuW/IREZ+v2Ps20MyGSqlEtjbpvg+U3IM4ZB9UZmY3TYKC4MwxsATyBpNOSZZEQiQpPIiRz/nrkZPiZHhvYJ4WZIAvTNQVYGwGozjyIRHzEMLVebYmWrXdbjdbmgoe5HUVYmGPVU8mL45M4TQZyCHDDlGGj7RqyM18U4sEGAZofB875X0GfBXiUeaNjjKlos8pcpKacvI8JnRGgPViEy/MTwGKIFI7wS4chTqqkLJWTT0VU8j8rxA37WYuFRVppRbMhavp6bC978/GJqSgP6Cod/SsMpIhH39kBXY251Jcq3l+DC4tnyg+P5CQ09j2M+AVxUvvJI/SFIXoPvXXzKseON/Al6V+LpxqOdeoc7vHCeVPPwBb2j4HCTKM5sAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"DAG\" title=\"\" src=\"/static/3c64588cebd9c2c9bbdb7b2c0c2bee89/c5bb3/dag.png\" srcset=\"/static/3c64588cebd9c2c9bbdb7b2c0c2bee89/04472/dag.png 170w,\n/static/3c64588cebd9c2c9bbdb7b2c0c2bee89/9f933/dag.png 340w,\n/static/3c64588cebd9c2c9bbdb7b2c0c2bee89/c5bb3/dag.png 680w,\n/static/3c64588cebd9c2c9bbdb7b2c0c2bee89/0f67e/dag.png 921w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://medium.com/nerd-for-tech/airflow-mwaa-automating-etl-for-a-data-warehouse-f5e50d14713c\">source</a></div>\n<p>Apache Airflow at a high level has the following components talking to each other:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZElEQVR42oVSTU+DQBDl/x/1bn+BSRM1UdvooZd6s/Vi22hLPzBAoS1Q2E+es4sgVhPfZkIYZt/Me4OTJAdc31whSVIYlGWJ/6C1AmMFpBQYv4zgeRsoJfE+f4MjpcTGW8M8axjSNvHpO+cMORMQRDIaP8P72EAIjiD04ZhCwcXXhdKehqh16ncDIQS41D8qDaIogrPbx+h2LxHv4ubzw2Pfdq4xm01xd38LVUoc8wyrpYsw3kOQqn6/h8nkFZKarNdLOAXj8AMf2THDkYKxnEYPEVGDNEttLkkTRHFkyQ+HPVx3gYJLqyoMA2RUZzwMtwEcpb8H325Da7YqKxFGgjH8dFnGLy5VJbSVV0pVhKeb5UKRHAXd5MtfhFnBIWmqKdnh0zJ0qW1zS1iHVNpeODs/x0Wn03Stt1yHplyaM2oqMHwaYuHOafMcqxV52J6snqJHRg8Gg4pQaztpO0yV/uN3NaSftKG2+9pbGLMAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"AWS DAG\" title=\"\" src=\"/static/64140cea93542af0f952ab25119ad0a2/c5bb3/aws-dag.png\" srcset=\"/static/64140cea93542af0f952ab25119ad0a2/04472/aws-dag.png 170w,\n/static/64140cea93542af0f952ab25119ad0a2/9f933/aws-dag.png 340w,\n/static/64140cea93542af0f952ab25119ad0a2/c5bb3/aws-dag.png 680w,\n/static/64140cea93542af0f952ab25119ad0a2/1d69c/aws-dag.png 750w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\"><a href=\"https://aws.amazon.com/blogs/machine-learning/build-end-to-end-machine-learning-workflows-with-amazon-sagemaker-and-apache-airflow/\">source</a></div>\n<h2 id=\"main-concepts-of-apache-airflow\" style=\"position:relative;\"><a href=\"#main-concepts-of-apache-airflow\" aria-label=\"main concepts of apache airflow permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Main Concepts of Apache Airflow</h2>\n<p>Before starting this demo and the operation of MWAA, it's important to refresh briefly some key Airflow concepts. For more deep dive explanations, please refer to <a href=\"https://airflow.apache.org/docs/apache-airflow/stable/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Apache Airflow official documentation</a>.</p>\n<ul>\n<li>\n<p>üåê <strong>Webserver</strong>: This provides a control interface for users and maintainers. The Airflow UI is a Flask + Gunicorn setup that lists DAGs, their run history, schedule, and pause/start options. It's a central place from where we can manage the Airflow pipelines and also handles the APIs.</p>\n</li>\n<li>\n<p>üóÑÔ∏è <strong>Metadata Database</strong>: Airflow uses a database supported by the SQLAlchemy Library, such as PostgreSQL or MySQL. This database powers the UI and acts as the backend for the worker and scheduler. It stores configurations, such as variables, connections, user information, roles, and policies. It also stores DAG-related metadata such as schedule intervals, tasks, statistics from various runs, etc.</p>\n</li>\n<li>\n<p>üï∞Ô∏è <strong>Scheduler</strong>: This is a daemon, built using the Python daemon library. It schedules &#x26; delegates tasks on the worker node via the executor. It also takes care of other housekeeping tasks like concurrency checks, dependency checks, callbacks, retries, etc. The three main components of the scheduler are:</p>\n<ul>\n<li>SchedulerJob</li>\n<li>DagFileProcessor</li>\n<li>Executor</li>\n</ul>\n</li>\n<li>\n<p>üë∑ <strong>Worker</strong>: These are the workhorses of Airflow. They are the actual nodes where tasks are executed.</p>\n</li>\n<li>\n<p>üîß <strong>Executor</strong>: Executors are the \"workstations\" for \"tasks\". The Executor acts as a middleman to handle resource allocation and distribute task completion. Executors run inside the scheduler. There are many options available in Airflow for executors, including:</p>\n<ul>\n<li>Sequential Executor: Default executor, runs one task at a time.</li>\n<li>Debug Executor: A debug tool, runs tasks by queuing them.</li>\n<li>Local Executor: Runs multiple tasks concurrently on a single machine.</li>\n<li>Dask Executor: Executes tasks concurrently across multiple machines.</li>\n<li>Celery Executor: Scales out the number of workers in parallel.</li>\n<li>Kubernetes Executor: Runs each task in its own Kubernetes pod.</li>\n</ul>\n</li>\n<li>\n<p>üì® <strong>Message Broker (optional)</strong>: A message broker is needed in distributed setups, where the CeleryExecutor is used to manage communication between the Scheduler and the Workers. The message broker, such as RabbitMQ or Redis, helps to pass task information from the Scheduler to the Workers. For MWAA, the Celery Executor is used.</p>\n</li>\n</ul>\n<h3 id=\"sequence-of-actions\" style=\"position:relative;\"><a href=\"#sequence-of-actions\" aria-label=\"sequence of actions permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Sequence of Actions</h3>\n<ol>\n<li>The scheduler initiates DAGs based on triggers, which could be scheduled or external.</li>\n<li>The scheduler loads the tasks/steps within the DAG and determines the dependencies.</li>\n<li>Tasks that are ready to run are placed in the queue by the scheduler.</li>\n<li>Workers retrieve these tasks from the queue and execute them.</li>\n<li>Upon completion of a task, a worker updates the task's status.</li>\n<li>The overall status of the DAG is determined based on the statuses of the individual tasks.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 111.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE30lEQVR42j2V2W8bVRTG/cQz4pn/D/EvIJ6QQDwhlbbQAgKpCMrSJF1ok7bQNgmNsziL7dhZ7NjjZcbjmfHsm8d2fpyZ0Ix0fK/Gvt/5zrnf+Vy6vLwkj3dPkmVkswVdz2DpZItliZWzMkunW2yNzpjN5/i+h+u61+E4Dp7nFTilTABs2y6+CMOQ3aHGi/Mu1fGAF1qdpdomDySeKAccun0sy2LnsEZ/MEDp9egqCkN1SLVWYzqdUsrR9yoVKhKD4ZDycMRy84Rau81iNqPgLh/vqtBHOq1uv9gvLhfX7zVVvQLMS3CE3UQy5wwPdINnjQ6a7hHHIVEUXx1eLIp1PB5zZ22ZP442+Wb5F+48+o3fDze4/3qVmVRbWiQRs8Ul77oYZHOMIGPuwnwqPU0TgiC8ZpKzqHRP+fHVYz76/BM+/vJTHuyv09AU5kKu9Hx1jTvPV4kFdBqFWH5EmCRyMMG3IhI/FUAf0zIIBTgHvJwvcM0Jc2kJsr8UEjmjec7w1+MGd2rLhJ6FYZuYjkEc2qSRSxzZeIZNYMltTkzpU1daMyzeTywVZzKiqbZ4fPSGteN/6egKpTCwyeYRumey2t7haassUtmkYbQkayylSg+zvHZhFibEkwlRYLKYhwQirReDA27tPObG7iM2BnW55YlGlMX4scWT7jY/H71kqbnOsdmWm0gIU5sDtUFt1KQ6bHDe60orTAHTCRydt+oRT1qbPOtsceoIw/Goj+ebZLHDaNLHdFUBioRBBLMQNRpx6/ApNzaX+Hr7IX+ebxJ7gUjKx5+o7J3WuVev8sPBHtudtgDqfdRBm2G/xXDYRTVGAhgWB5gFRDOHqnnOVmufV61d3pzu0Ls4o6ec4eldVkTQH9y8x3tf/cRnr99SMg0Vc9xnrHUxxj00ayzl+9I2X27RJw4sZombDyVpYtPrnNA+r9FsHmIOWqxUj/jw7n3ev/0LX2xsUzL0IeNRD9saMNR6KCMNJw7Q5cYHSovt8ia16h76UCFyRPySwHXG5JVFvsGZaPLp4T4PK3scKxdXDDfWX/Do4QMpu03oW/iJAFo6ld0y+xLb5Q2qu/sEus1F+5hGfZ/j2h7di2YBmlcQuxqp3EPJEsDK3lvWXz9nJExV0VsQe9LDoCg5m7pFXM590qkjQBVOGod02g06AhiHExk5j0CAp6l3dSmmMcA2hwLYRzO0Qn9BYrGW67JdZrWzw99KhZXGBufjFpnvCDNLwCyZDo8sdWQw9CtAY6wSSZY0tkmiCYmszAOMSOfu0TNuvl3m9s4jvt19wq3KX1Qmp8hsMktDSRwVEstSsT5hmKU+pYlt4IYeUwGaSQZmURGzaUBX/K8+PmfvokpNPaPlKhjmmEhGMZW+TRNHzrhF2a6tCSHpoRcEIhVbMrgyiwNeNURrJ/ucqh0ysa5ZHDNPU2l8QuKGeGMRtPw2d23Pc4u9LeOoizpyuyvl1hXmbiFP01P5vvaS7w7X+EfmcpqKm4u1u56ARD6W5mOPAuI0JpHZnuVuI0++RlFU7AtAI8rwU/HBaEpPGO8oAzQxXV0sqrxb4ahWp95oytrg4KjOQNMlUYCqjaTn4gN+IBYXXAHmxpnNxQv/j9xGjYlHq92h3VVodxROzs5pXXQ5bbU5k7+GjtIr3mkCmLObTrNrR/8PKjNPvFSeA04AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Airflow\" title=\"\" src=\"/static/7d6f32586aff58da6a85271562123550/c5bb3/airflow.png\" srcset=\"/static/7d6f32586aff58da6a85271562123550/04472/airflow.png 170w,\n/static/7d6f32586aff58da6a85271562123550/9f933/airflow.png 340w,\n/static/7d6f32586aff58da6a85271562123550/c5bb3/airflow.png 680w,\n/static/7d6f32586aff58da6a85271562123550/b12f7/airflow.png 1020w,\n/static/7d6f32586aff58da6a85271562123550/6f2be/airflow.png 1029w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"-more-airflow-terminology\" style=\"position:relative;\"><a href=\"#-more-airflow-terminology\" aria-label=\" more airflow terminology permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üî• More Airflow Terminology</h3>\n<ul>\n<li><strong>Operators</strong>: They are the fundamental elements of a DAG. They outline the actual work that the DAG will carry out. The nature of the task is determined by the operators. They are represented by a Python class that serves as a task type template. They are idempotent.</li>\n<li>\n<ul>\n<li>BashOperator‚Ää-‚ÄäExecutes a bash command.</li>\n<li>PythonOperator‚Ää-‚ÄäRuns a Python function.</li>\n<li>SparkSubmitOperator‚Ää-‚ÄäExecutes spark-submit.</li>\n</ul>\n</li>\n<li><strong>Task</strong>: A task is an instance of an operator or sensor.</li>\n<li><strong>Plugins</strong>: They offer a convenient way to write, share, and activate custom runtime behavior.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">__init__.py\n                <span class=\"token operator\">|</span>-- airflow_plugin.py\nhooks/\n                <span class=\"token operator\">|</span>-- __init__.py\n                <span class=\"token operator\">|</span>-- airflow_hook.py\noperators/\n                <span class=\"token operator\">|</span>-- __init__.py\n                <span class=\"token operator\">|</span>-- airflow_operator.py\nsensors/\n                <span class=\"token operator\">|</span>-- __init__.py\n                <span class=\"token operator\">|</span>-- airflow_sensor.py</code></pre></div>\n<blockquote>\n<p>Note: In MWAA, we don't have direct access to the runtime where tasks are being processed. We can use <code class=\"language-text\">requirements.txt</code> to install available Python modules. For unavailable or custom modules, we can create a zip of the packages locally, upload it to S3, and use it as needed.</p>\n</blockquote>\n<ul>\n<li><strong>Hooks</strong>: Provide a way to connect your DAG to your environment. They serve as an interface for interacting with external systems. For example, we can establish an S3 connection and use S3 Hooks to retrieve the connection information and perform our task. There are various hooks available (HTTP, Hive, Slack, MySQL), and more are continuously being added by the community.</li>\n<li><strong>Sensors</strong>: They are special operators used to monitor (or poll) long-running tasks, files, database rows, S3 keys, other DAGs/tasks, etc.</li>\n<li><strong>XComs</strong>: XComs (cross-communication) are designed to facilitate communication between tasks. We use <code class=\"language-text\">xcom_push</code> and <code class=\"language-text\">xcom_pull</code> to store and retrieve variables, respectively.</li>\n</ul>\n<p>Tasks transition from one state to another during the execution of a DAG. Initially, the Airflow scheduler determines if it's time for a task to run and whether all other dependencies for the task have been met. At this point, the task enters the scheduled state. When a task is assigned to an executor, it enters the queued state. When the executor picks up the task and a worker begins executing the task, the task enters the <strong>running</strong> state.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe9NDQf/xAAWEAADAAAAAAAAAAAAAAAAAAAAASD/2gAIAQEAAQUCHP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAwEBAQAAAAAAAAAAAAAAAREhACBh/9oACAEBAAE/IXVoIYNKmHnH/9oADAMBAAIAAwAAABAwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAAIDAQAAAAAAAAAAAAAAAAERACExQf/aAAgBAQABPxBh2O7DDCDmt7FRDUexlw3tqAz/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"States\" title=\"\" src=\"/static/358174cd60668bd1771416ec0f939da5/7bf67/states.jpg\" srcset=\"/static/358174cd60668bd1771416ec0f939da5/651be/states.jpg 170w,\n/static/358174cd60668bd1771416ec0f939da5/d30a3/states.jpg 340w,\n/static/358174cd60668bd1771416ec0f939da5/7bf67/states.jpg 680w,\n/static/358174cd60668bd1771416ec0f939da5/990cb/states.jpg 1020w,\n/static/358174cd60668bd1771416ec0f939da5/c44b8/states.jpg 1360w,\n/static/358174cd60668bd1771416ec0f939da5/b17f8/states.jpg 1600w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h2 id=\"-demo-mwaa-airflow-dag-on-eks\" style=\"position:relative;\"><a href=\"#-demo-mwaa-airflow-dag-on-eks\" aria-label=\" demo mwaa airflow dag on eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Demo: MWAA Airflow DAG on EKS</h2>\n<p>A Directed Acyclic Graph (DAG) is a graphical representation of a workflow in Airflow. It organizes tasks in a manner that clearly illustrates the relationships and dependencies between each task. The context for executing tasks is contained within the DAGs. In MWAA, DAGs are stored in Amazon S3. When a new DAG file is introduced, it takes approximately one minute for Amazon MWAA to begin utilizing the new file.</p>\n<p>Amazon Managed Workflows for Apache Airflow MWAA is a managed service that simplifies the orchestration of Apache Airflow, making it more straightforward to establish and manage comprehensive data pipelines in the cloud at a large scale. With Managed Workflows, you have the ability to employ Airflow and Python to construct workflows, without the need to handle the underlying infrastructure required for scalability, availability, and security.</p>\n<h3 id=\"provision-the-infrastructure\" style=\"position:relative;\"><a href=\"#provision-the-infrastructure\" aria-label=\"provision the infrastructure permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Provision the Infrastructure</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/seifrajhi/data-on-eks.git\n<span class=\"token builtin class-name\">cd</span> data-on-eks/schedulers/terraform/managed-airflow-mwaa\n<span class=\"token function\">chmod</span> +x install.sh\n./install.sh</code></pre></div>\n<p>The following components are provisioned in your environment:</p>\n<ul>\n<li>A VPC with 3 Private Subnets and 3 Public Subnets.</li>\n<li>Internet gateway for Public Subnets and NAT Gateway for Private Subnets.</li>\n<li>EKS Cluster with one managed node group.</li>\n<li>K8S metrics server and cluster autoscaler.</li>\n<li>A MWAA environment in version 2.2.2.</li>\n<li>A S3 bucket with DAG code.</li>\n</ul>\n<p>After a few minutes, the script will finish and you can run the below commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws eks <span class=\"token parameter variable\">--region</span> eu-west-1 update-kubeconfig <span class=\"token parameter variable\">--name</span> managed-airflow-mwaa\nkubectl get namespaces</code></pre></div>\n<p>You should see output similar to the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">default           Active    8m\nemr-mwaa          Active    4m\nkube-node-lease   Active    9m\nkube-public       Active    9m\nkube-system       Active    9m\nmwaa              Active    3m</code></pre></div>\n<h3 id=\"log-into-apache-airflow-ui\" style=\"position:relative;\"><a href=\"#log-into-apache-airflow-ui\" aria-label=\"log into apache airflow ui permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Log into Apache Airflow UI</h3>\n<ol>\n<li>Open the Environments page on the Amazon MWAA console.</li>\n<li>Choose an environment.</li>\n<li>Under the Details section, click the link for the Airflow UI.</li>\n</ol>\n<h3 id=\"trigger-the-dag-workflow-to-execute-job-in-eks\" style=\"position:relative;\"><a href=\"#trigger-the-dag-workflow-to-execute-job-in-eks\" aria-label=\"trigger the dag workflow to execute job in eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Trigger the DAG Workflow to Execute Job in EKS</h3>\n<ol>\n<li>In the Airflow UI, enable the example DAG <code class=\"language-text\">kubernetes_pod_example</code> and then trigger it.</li>\n</ol>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 22.941176470588236%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAr0lEQVR42qWQSw7DIAxEc/97dlGlwQGCTfh4aqDbrGppNAPI1sPbeXoQnVMj996hquY6XfvK3fJTtdasd/Vvr/cBHyLIDs5H+EtwJUaIafpQvBgsGbVU1FpRhkpZXtfdAKmtYiNy4JQgnJDkRkg3sjBEBMzmvLIPHrv/gNyB6Ha4GIzIwZMBDToikxGOyYAi33l+8anGW9O2VtLbXIFq/0knZTKwObDbZS4Z/9aY9QWoC4fIGKiBiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"UI\" title=\"\" src=\"/static/5eac917d55b4aa9d8d88c469ca802548/c5bb3/ui.png\" srcset=\"/static/5eac917d55b4aa9d8d88c469ca802548/04472/ui.png 170w,\n/static/5eac917d55b4aa9d8d88c469ca802548/9f933/ui.png 340w,\n/static/5eac917d55b4aa9d8d88c469ca802548/c5bb3/ui.png 680w,\n/static/5eac917d55b4aa9d8d88c469ca802548/b12f7/ui.png 1020w,\n/static/5eac917d55b4aa9d8d88c469ca802548/b5a09/ui.png 1360w,\n/static/5eac917d55b4aa9d8d88c469ca802548/29007/ui.png 1600w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<h3 id=\"verify-that-the-pod-was-executed-successfully\" style=\"position:relative;\"><a href=\"#verify-that-the-pod-was-executed-successfully\" aria-label=\"verify that the pod was executed successfully permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Verify that the Pod was Executed Successfully</h3>\n<p>After it runs and completes successfully, use the following command to verify the pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get pods <span class=\"token parameter variable\">-n</span> mwaa</code></pre></div>\n<p>You should see output similar to the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">NAME                                             READY   STATUS      RESTARTS   AGE\nmwaa-pod-test.4bed823d645844bc8e6899fd858f119d   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          25s</code></pre></div>\n<h2 id=\"Ô∏è-key-takeaways\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-key-takeaways\" aria-label=\"Ô∏è key takeaways permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üóùÔ∏è Key Takeaways</h2>\n<p>Automating and organizing data tasks is very important for managing work and resources well in Kubernetes. This is where Job Schedulers are useful. They run jobs that are done either once or many times, making sure tasks are finished when needed. On the other hand, Batch-Oriented Workflow Orchestrators give more control. They allow for complex job scheduling, including the order of tasks and their dependencies.</p>\n<p><strong>Stay tuned for next blogs in this series üéâ</strong></p>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-eks-example.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-eks-example.html</a></li>\n<li><a href=\"https://medium.com/apache-airflow/what-we-learned-after-running-airflow-on-kubernetes-for-2-years-0537b157acfd\" target=\"_blank\" rel=\"noopener noreferrer\">https://medium.com/apache-airflow/what-we-learned-after-running-airflow-on-kubernetes-for-2-years-0537b157acfd</a></li>\n<li><a href=\"https://medium.com/@binayalenka/airflow-architecture-667f1cc613e8\" target=\"_blank\" rel=\"noopener noreferrer\">https://medium.com/@binayalenka/airflow-architecture-667f1cc613e8</a></li>\n<li><a href=\"https://awslabs.github.io/data-on-eks/docs/blueprints/job-schedulers/aws-managed-airflow\" target=\"_blank\" rel=\"noopener noreferrer\">https://awslabs.github.io/data-on-eks/docs/blueprints/job-schedulers/aws-managed-airflow</a></li>\n</ul>\n<p><strong>Thank You üñ§</strong></p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"},"nextThought":{"frontmatter":{"path":"/blog/data-on-kubernetes-cloudnativepg-ceph-2/","title":"Data on Kubernetes: Part 2‚Ää-‚ÄäDeploying Databases in K8s with PostgreSQL, CloudNative-PG, and Ceph Rook on Amazon¬†EKS","date":"2024-10-25 13:06:00"},"excerpt":"Data persistence: running PostgreSQL on Amazon¬†EKS üéÜ Introduction PostgreSQL, the well-known open-source relational database, is a popular‚Ä¶","html":"<blockquote>\n<p><strong>Data persistence: running PostgreSQL on Amazon¬†EKS</strong></p>\n</blockquote>\n<h2 id=\"-introduction\" style=\"position:relative;\"><a href=\"#-introduction\" aria-label=\" introduction permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üéÜ Introduction</h2>\n<p><a href=\"https://www.postgresql.org/\" target=\"_blank\" rel=\"noopener noreferrer\">PostgreSQL</a>, the well-known open-source <a href=\"https://en.wikipedia.org/wiki/Relational_database\" target=\"_blank\" rel=\"noopener noreferrer\">relational database</a>, is a popular choice for applications demanding scalability, reliability, and ease of management.</p>\n<p>But how can we deploy and run PostgreSQL in a Kubernetes environment to handle the stored data? ü§î</p>\n<p>In this blog post, we'll explore how to combine <a href=\"https://github.com/cloudnative-pg/cloudnative-pg\" target=\"_blank\" rel=\"noopener noreferrer\">CloudNative-PG</a> (a PostgreSQL operator) and <a href=\"https://rook.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Ceph Rook</a> (a storage orchestrator) to create a PostgreSQL cluster that scales easily, recovers from failures, and ensures data persistence‚Ää‚Äî‚Ääall within an <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon Elastic Kubernetes Service EKS cluster</a>.</p>\n<h2 id=\"-databases-on-k8seks\" style=\"position:relative;\"><a href=\"#-databases-on-k8seks\" aria-label=\" databases on k8seks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üí• Databases on K8S/EKS</h2>\n<p>Running databases and query engines on Kubernetes can offer benefits, but it's important to consider the trade-offs.</p>\n<h3 id=\"Ô∏è-benefits-of-running-databases-on-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-benefits-of-running-databases-on-kubernetes\" aria-label=\"Ô∏è benefits of running databases on kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚òëÔ∏è Benefits of Running Databases on Kubernetes</h3>\n<ul>\n<li><strong>Automated deployment</strong>: Kubernetes simplifies deploying databases by automating the process and it aligns with DevOps practices and infrastructure as code.</li>\n<li><strong>Scaling</strong>: Kubernetes allows automatic scaling based on workload demands.</li>\n<li><strong>Rolling updates</strong>: It supports seamless updates without downtime.</li>\n<li><strong>Self-healing</strong>: Kubernetes ensures high availability by automatically recovering from failures.</li>\n<li><strong>Portability</strong>: Kubernetes provides a consistent environment across different clusters and cloud providers.</li>\n<li><strong>Cost-effectiveness</strong>: Kubernetes optimizes resource utilization.</li>\n</ul>\n<h3 id=\"Ô∏è-challenges-and-considerations\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-challenges-and-considerations\" aria-label=\"Ô∏è challenges and considerations permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚òëÔ∏è Challenges and Considerations</h3>\n<ul>\n<li><strong>Statefulness</strong>: Databases are stateful, and managing state in a transient environment (like Kubernetes pods) can be complex.</li>\n<li><strong>Transient pods</strong>: Pods can restart or fail over, affecting database availability.</li>\n<li><strong>Abstractions</strong>: Containerization introduces abstractions that impact database-specific tasks (e.g., backups, scaling).</li>\n<li><strong>DIY on VM</strong>: Full control but more operational overhead.</li>\n<li><a href=\"https://cloud.google.com/blog/products/databases/to-run-or-not-to-run-a-database-on-kubernetes-what-to-consider\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes: Closer to full control, but still requires careful planning</a>.</li>\n</ul>\n<h3 id=\"Ô∏è-popular-databases-on-kubernetes\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-popular-databases-on-kubernetes\" aria-label=\"Ô∏è popular databases on kubernetes permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>‚òëÔ∏è Popular Databases on Kubernetes</h3>\n<ul>\n<li><strong>Apache Cassandra</strong>: Scalable, distributed NoSQL database.</li>\n<li><strong>PostgreSQL</strong>: Supports Kubernetes through operators (e.g., cnpg).</li>\n<li><strong>MySQL, MongoDB, and others</strong>.</li>\n</ul>\n<blockquote>\n<p><a href=\"https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">Many teams successfully run databases on Kubernetes in production, but it requires thoughtful planning and understanding of trade-offs</a>.</p>\n</blockquote>\n<h2 id=\"-deploying-cloudnative-pg-with-ceph-rook-on-aws-eks\" style=\"position:relative;\"><a href=\"#-deploying-cloudnative-pg-with-ceph-rook-on-aws-eks\" aria-label=\" deploying cloudnative pg with ceph rook on aws eks permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Deploying CloudNative-PG with Ceph Rook on AWS EKS</h2>\n<p><strong>CloudNativePG</strong> is an open-source <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/operator/\" target=\"_blank\" rel=\"noopener noreferrer\">Level 5 operator</a> designed to manage PostgreSQL workloads on any Kubernetes cluster. It simplifies the deployment, management, and recovery of PostgreSQL instances within Kubernetes. Here are some key features:</p>\n<ul>\n<li><strong>High availability</strong>: CloudNativePG covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication.</li>\n<li><strong>Automated failover</strong>: It automates tasks that a human operator would perform, including failover.</li>\n<li><strong>Data persistence</strong>: Unlike relying on stateful sets, CloudNativePG manages persistent volume claims for storing PGDATA.</li>\n<li><strong>Declarative configuration</strong>: It directly integrates with the Kubernetes API server, eliminating the need for an external failover management tool.</li>\n<li><strong>Cloud Native</strong>: Built on DevOps concepts like immutable infrastructure and declarative configuration, it leverages Kubernetes for self-healing, high availability, and more.</li>\n<li><strong>Security &#x26; TLS</strong>: Supports security contexts, encrypted TLS connections, and client authentication.</li>\n<li><strong>Monitoring</strong>: Includes a Prometheus exporter for metrics and transparent log integration.</li>\n<li><strong>Advanced architectures</strong>: Extend the architecture with PgBouncer or create disaster recovery clusters.</li>\n</ul>\n<blockquote>\n<p>CloudNativePG was originally developed by <a href=\"https://www.enterprisedb.com/\" target=\"_blank\" rel=\"noopener noreferrer\">EDB</a>, released under the Apache License 2.0, and submitted to CNCF Sandbox in April 2022.</p>\n</blockquote>\n<p><strong>Rook</strong> is an open-source cloud-native storage orchestrator designed for Kubernetes. Its purpose is to provide a platform, framework, and support for <a href=\"https://docs.ceph.com/en/latest/rados/\" target=\"_blank\" rel=\"noopener noreferrer\">Ceph storage</a> to seamlessly integrate with Kubernetes. Here are some key points about Rook:</p>\n<ul>\n<li><strong>Ceph integration</strong>: Rook enables Ceph, a distributed storage system that offers file, block, and object storage, to be deployed and managed within Kubernetes clusters.</li>\n<li><strong>Automation and management</strong>: Rook automates the deployment, configuration, provisioning, scaling, upgrading, and monitoring of Ceph. It ensures self-managing, self-scaling, and self-healing storage services.</li>\n<li><strong>Stability and compatibility</strong>: The status of the Ceph storage provider in Rook is stable. Upgrades between versions maintain backward compatibility.</li>\n<li><strong>CNCF project</strong>: Rook is hosted by the Cloud Native Computing Foundation (CNCF) as a graduated-level project.</li>\n</ul>\n<p>Now let's start the deployment process.</p>\n<h2 id=\"hands-on-demo\" style=\"position:relative;\"><a href=\"#hands-on-demo\" aria-label=\"hands on demo permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Hands-on Demo</h2>\n<p>First, you can get the code and clone the repo:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone git@github.com:seifrajhi/data-on-eks.git</code></pre></div>\n<p>After that, run the <code class=\"language-text\">deploy.sh</code> script which deploys an <strong>EKS cluster</strong> to the <code class=\"language-text\">eu-west-1</code> region.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> distributed-databases/cloudnative-postgres/\n\n<span class=\"token function\">chmod</span> +x install.sh\n\n./install.sh</code></pre></div>\n<p>Once the script ends, you can run the below command to update the local kubeconfig so we can access the Kubernetes cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws eks update-kubeconfig <span class=\"token parameter variable\">--name</span> cnpg-on-eks <span class=\"token parameter variable\">--region</span> eu-west-1</code></pre></div>\n<p>Next, you can verify if all the pods are running:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl get pods <span class=\"token parameter variable\">-n</span><span class=\"token operator\">=</span>cnpg-system\nNAME                                          READY   STATUS    RESTARTS   AGE\ncnpg-on-eks-cloudnative-pg-412d5a5fd8-amuz   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          11m</code></pre></div>\n<h3 id=\"Ô∏è-setup-rook-for-storage\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-setup-rook-for-storage\" aria-label=\"Ô∏è setup rook for storage permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèóÔ∏è Setup Rook for Storage</h3>\n<p>Rook has published the following Helm charts for the Ceph storage provider:</p>\n<ul>\n<li><a href=\"https://rook.io/docs/rook/latest-release/Helm-Charts/operator-chart/\" target=\"_blank\" rel=\"noopener noreferrer\">Rook Ceph Operator</a>: Starts the Ceph Operator, which will watch for Ceph CRs (custom resources).</li>\n<li><a href=\"https://rook.io/docs/rook/latest-release/Helm-Charts/ceph-cluster-chart/\" target=\"_blank\" rel=\"noopener noreferrer\">Rook Ceph Cluster</a>: Creates Ceph CRs that the operator will use to configure the cluster.</li>\n</ul>\n<h4 id=\"-rook-ceph-operator\" style=\"position:relative;\"><a href=\"#-rook-ceph-operator\" aria-label=\" rook ceph operator permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì¶ Rook Ceph Operator</h4>\n<p>Installs Rook to create, configure, and manage Ceph clusters on Kubernetes.</p>\n<p>This chart bootstraps a <a href=\"https://github.com/rook/rook\" target=\"_blank\" rel=\"noopener noreferrer\">rook-ceph-operator</a> deployment on a Kubernetes cluster using the Helm package manager.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm repo <span class=\"token function\">add</span> rook-release https://charts.rook.io/release\nhelm <span class=\"token function\">install</span> --create-namespace <span class=\"token parameter variable\">--namespace</span> rook-ceph rook-ceph rook-release/rook-ceph <span class=\"token parameter variable\">-f</span> values.yaml</code></pre></div>\n<p>For customized settings, you can check the <a href=\"https://github.com/rook/rook/tree/release-1.14/deploy/charts/rook-ceph/values.yaml\" target=\"_blank\" rel=\"noopener noreferrer\">values.yaml</a> file.</p>\n<h4 id=\"Ô∏è-ceph-cluster\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-ceph-cluster\" aria-label=\"Ô∏è ceph cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üèóÔ∏è Ceph Cluster</h4>\n<p>Creates Rook resources to configure a Ceph cluster using the Helm package manager.</p>\n<p>Before installing, review the <code class=\"language-text\">values.yaml</code> to confirm if the default settings need to be updated.</p>\n<ul>\n<li>If the operator was installed in a namespace other than <code class=\"language-text\">rook-ceph</code>, the namespace must be set in the <code class=\"language-text\">operatorNamespace</code> variable.</li>\n<li>Set the desired settings in the <code class=\"language-text\">cephClusterSpec</code>. <a href=\"https://github.com/rook/rook/tree/release-1.14/deploy/charts/rook-ceph-cluster/values.yaml\" target=\"_blank\" rel=\"noopener noreferrer\">The defaults</a> are only an example and not likely to apply to your cluster.</li>\n<li>The monitoring section should be removed from the <code class=\"language-text\">cephClusterSpec</code>, as it is specified separately in the Helm settings.</li>\n<li>The default values for <code class=\"language-text\">cephBlockPools</code>, <code class=\"language-text\">cephFileSystems</code>, and <code class=\"language-text\">CephObjectStores</code> will create one of each, and their corresponding storage classes.</li>\n</ul>\n<p>All Ceph components now have default values for the pod resources. The resources may need to be adjusted in production clusters depending on the load. The resources can also be disabled if Ceph should not be limited (e.g., test clusters).</p>\n<p>The below command assumes you have first created a customized <code class=\"language-text\">values.yaml</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm <span class=\"token function\">install</span> --create-namespace <span class=\"token parameter variable\">--namespace</span> rook-ceph rook-ceph-cluster <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--set</span> <span class=\"token assign-left variable\">operatorNamespace</span><span class=\"token operator\">=</span>rook-ceph rook-release/rook-ceph-cluster <span class=\"token parameter variable\">-f</span> values.yaml</code></pre></div>\n<h4 id=\"-provision-storage\" style=\"position:relative;\"><a href=\"#-provision-storage\" aria-label=\" provision storage permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üì¶ Provision Storage</h4>\n<p>Before Rook can provision storage, a <a href=\"https://kubernetes.io/docs/concepts/storage/storage-classes\" target=\"_blank\" rel=\"noopener noreferrer\">StorageClass</a> and <a href=\"https://rook.io/docs/rook/latest-release/CRDs/Block-Storage/ceph-block-pool-crd/\" target=\"_blank\" rel=\"noopener noreferrer\">CephBlockPool</a> CR need to be created. This will allow Kubernetes to interoperate with Rook when provisioning persistent volumes.</p>\n<p>Save this StorageClass definition as <strong>storageclass.yaml</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> ceph.rook.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CephBlockPool\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> replicapool\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph <span class=\"token comment\"># namespace:cluster</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">failureDomain</span><span class=\"token punctuation\">:</span> host\n  <span class=\"token key atrule\">replicated</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token key atrule\">requireSafeReplicaSize</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> storage.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> StorageClass\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph<span class=\"token punctuation\">-</span>block\n<span class=\"token key atrule\">provisioner</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph.rbd.csi.ceph.com <span class=\"token comment\"># csi-provisioner-name</span>\n<span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">clusterID</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph \n  <span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span> replicapool\n  <span class=\"token key atrule\">imageFormat</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span>\n  <span class=\"token key atrule\">imageFeatures</span><span class=\"token punctuation\">:</span> layering\n  <span class=\"token key atrule\">csi.storage.k8s.io/provisioner-secret-name</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>csi<span class=\"token punctuation\">-</span>rbd<span class=\"token punctuation\">-</span>provisioner\n  <span class=\"token key atrule\">csi.storage.k8s.io/provisioner-secret-namespace</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph <span class=\"token comment\"># namespace:cluster</span>\n  <span class=\"token key atrule\">csi.storage.k8s.io/controller-expand-secret-name</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>csi<span class=\"token punctuation\">-</span>rbd<span class=\"token punctuation\">-</span>provisioner\n  <span class=\"token key atrule\">csi.storage.k8s.io/controller-expand-secret-namespace</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph <span class=\"token comment\"># namespace:cluster</span>\n  <span class=\"token key atrule\">csi.storage.k8s.io/node-stage-secret-name</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>csi<span class=\"token punctuation\">-</span>rbd<span class=\"token punctuation\">-</span>node\n  <span class=\"token key atrule\">csi.storage.k8s.io/node-stage-secret-namespace</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph <span class=\"token comment\"># namespace:cluster</span>\n  <span class=\"token key atrule\">csi.storage.k8s.io/fstype</span><span class=\"token punctuation\">:</span> ext4\n<span class=\"token key atrule\">allowVolumeExpansion</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">reclaimPolicy</span><span class=\"token punctuation\">:</span> Delete</code></pre></div>\n<p>Then apply it</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> storageclass.yaml</code></pre></div>\n<h3 id=\"-deploy-a-postgresql-cluster\" style=\"position:relative;\"><a href=\"#-deploy-a-postgresql-cluster\" aria-label=\" deploy a postgresql cluster permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>üöÄ Deploy a PostgreSQL Cluster</h3>\n<p>As with any other deployment in Kubernetes, to deploy a PostgreSQL cluster you need to apply a configuration file that defines your desired Cluster. The CloudNativePG operator offers two types of bootstrapping a new database:</p>\n<ol>\n<li><strong>Bootstrap an empty cluster</strong></li>\n<li><strong>Bootstrap from another cluster</strong></li>\n</ol>\n<p>In this demo, we are going to create a new empty database cluster using <code class=\"language-text\">initdb</code> flags. We will use the template below by modifying the IAM role for IRSA configuration and the S3 bucket for the backup restore process and WAL archiving.</p>\n<p>The Terraform script has already created these resources. Use the Terraform output to extract these parameters:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">terraform output\ndemo_backup_irsa <span class=\"token operator\">=</span> <span class=\"token string\">\"arn:aws:iam::&lt;your_account_id>:role/cnpg-on-eks-prod-irsa\"</span>\ndemo_s3_bucket <span class=\"token operator\">=</span> <span class=\"token string\">\"xyz-cnpg-demo-bucket\"</span>\nconfigure_kubectl <span class=\"token operator\">=</span> <span class=\"token string\">\"aws eks --region eu-west-1 update-kubeconfig --name cnpg-on-eks\"</span></code></pre></div>\n<ul>\n<li><strong>IRSA Configuration</strong>: <code class=\"language-text\">arn:aws:iam::&lt;your_account_id>:role/cnpg-on-eks-prod-irsa</code></li>\n<li><strong>S3 Bucket</strong>: <code class=\"language-text\">xyz-cnpg-demo-bucket</code></li>\n</ul>\n<p>For more information on configuring IAM roles for service accounts (IRSA), refer to the <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS documentation</a>.</p>\n<p>For details on setting up S3 buckets for backups, check the <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS S3 documentation</a>.</p>\n<p>Now, we are ready to deploy a CloudNativePG database cluster.</p>\n<p><strong>demo-cnpg-cluster.yaml</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> postgresql.cnpg.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Cluster\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>cnpg\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> demo\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Cluster Demo for DoEKS\"</span>\n  <span class=\"token comment\"># Choose your PostGres Database Version</span>\n  <span class=\"token key atrule\">imageName</span><span class=\"token punctuation\">:</span> ghcr.io/cloudnative<span class=\"token punctuation\">-</span>pg/postgresql<span class=\"token punctuation\">:</span><span class=\"token number\">15.2</span>\n  <span class=\"token comment\"># Number of Replicas</span>\n  <span class=\"token key atrule\">instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">startDelay</span><span class=\"token punctuation\">:</span> <span class=\"token number\">300</span>\n  <span class=\"token key atrule\">stopDelay</span><span class=\"token punctuation\">:</span> <span class=\"token number\">300</span>\n  <span class=\"token key atrule\">replicationSlots</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">highAvailability</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">updateInterval</span><span class=\"token punctuation\">:</span> <span class=\"token number\">300</span>\n  <span class=\"token key atrule\">primaryUpdateStrategy</span><span class=\"token punctuation\">:</span> unsupervised\n  <span class=\"token key atrule\">serviceAccountTemplate</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># For backup and restore, we use IRSA for demo tool.</span>\n    <span class=\"token comment\"># You will find this IAM role on terraform outputs.</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>&lt;&lt;account_id<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>role/cnpg<span class=\"token punctuation\">-</span>on<span class=\"token punctuation\">-</span>eks<span class=\"token punctuation\">-</span>prod<span class=\"token punctuation\">-</span>irsa <span class=\"token comment\">#1</span>\n  <span class=\"token key atrule\">postgresql</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">shared_buffers</span><span class=\"token punctuation\">:</span> 256MB\n      <span class=\"token key atrule\">pg_stat_statements.max</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'10000'</span>\n      <span class=\"token key atrule\">pg_stat_statements.track</span><span class=\"token punctuation\">:</span> all\n      <span class=\"token key atrule\">auto_explain.log_min_duration</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'10s'</span>\n    <span class=\"token key atrule\">pg_hba</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># - hostssl app all all cert</span>\n      <span class=\"token punctuation\">-</span> host app app all password\n  <span class=\"token key atrule\">logLevel</span><span class=\"token punctuation\">:</span> debug\n  <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">storageClass</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph<span class=\"token punctuation\">-</span>block\n    <span class=\"token key atrule\">size</span><span class=\"token punctuation\">:</span> 1Gi\n  <span class=\"token key atrule\">walStorage</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">storageClass</span><span class=\"token punctuation\">:</span> rook<span class=\"token punctuation\">-</span>ceph<span class=\"token punctuation\">-</span>block\n    <span class=\"token key atrule\">size</span><span class=\"token punctuation\">:</span> 1Gi\n  <span class=\"token key atrule\">monitoring</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enablePodMonitor</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">bootstrap</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">initdb</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Deploying a new cluster</span>\n      <span class=\"token key atrule\">database</span><span class=\"token punctuation\">:</span> WorldDB\n      <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> app\n      <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">-</span>auth\n  <span class=\"token key atrule\">backup</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">barmanObjectStore</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># For backup, we S3 bucket to store data.</span>\n    <span class=\"token comment\"># On this Blueprint, we create an S3 check the terraform output for it.</span>\n      <span class=\"token key atrule\">destinationPath</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">:</span>//&lt;your<span class=\"token punctuation\">-</span>s3<span class=\"token punctuation\">-</span>demo<span class=\"token punctuation\">-</span>bucket<span class=\"token punctuation\">></span> <span class=\"token comment\">#2</span>\n      <span class=\"token key atrule\">s3Credentials</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">inheritFromIAMRole</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">wal</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">compression</span><span class=\"token punctuation\">:</span> gzip\n        <span class=\"token key atrule\">maxParallel</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span>\n    <span class=\"token key atrule\">retentionPolicy</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"30d\"</span>\n\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># m5large: m5xlarge 2vCPU, 8GI RAM</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"512Mi\"</span>\n      <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span>\n    <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1Gi\"</span>\n      <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span>\n\n  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enablePodAntiAffinity</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> failure<span class=\"token punctuation\">-</span>domain.beta.kubernetes.io/zone\n\n  <span class=\"token key atrule\">nodeMaintenanceWindow</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">inProgress</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">reusePVC</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>\n<p>Once updated, you can apply your template.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl apply <span class=\"token parameter variable\">-f</span> demo-cnpg-cluster.yaml</code></pre></div>\n<p>Now you can check Cluster status is by using cloudnative-pg kubectl plugin offered by the CloudNativePG community.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl cnpg status demo-cnpg\nCluster Summary\nName:               demo-cnpg\nNamespace:          demo\nSystem ID:          <span class=\"token number\">7214866198623563798</span>\nPostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:15.2\nPrimary instance:   demo-cnpg-1\nStatus:             Cluster <span class=\"token keyword\">in</span> healthy state\nInstances:          <span class=\"token number\">3</span>\nReady instances:    <span class=\"token number\">3</span>\nCurrent Write LSN:  <span class=\"token number\">0</span>/6000000 <span class=\"token punctuation\">(</span>Timeline: <span class=\"token number\">1</span> - WAL File: 000000010000000000000005<span class=\"token punctuation\">)</span>\nCertificates Status\nCertificate Name  Expiration Date                Days Left Until Expiration\n----------------  ---------------                --------------------------\ndemo-cnpg-ca           <span class=\"token number\">2024</span>-07-14 <span class=\"token number\">14</span>:40:27 +0000 UTC  <span class=\"token number\">89.96</span>\ndemo-cnpg-replication  <span class=\"token number\">2024</span>-07-14 <span class=\"token number\">14</span>:40:27 +0000 UTC  <span class=\"token number\">89.96</span>\ndemo-cnpg-server       <span class=\"token number\">2024</span>-07-14 <span class=\"token number\">14</span>:40:27 +0000 UTC  <span class=\"token number\">89.96</span>\n\nContinuous Backup status\nFirst Point of Recoverability:  Not Available\nWorking WAL archiving:          OK\nWALs waiting to be archived:    <span class=\"token number\">0</span>\nLast Archived WAL:              000000010000000000000005   @   <span class=\"token number\">2024</span>-07-01T14:52:09.24307Z\nLast Failed WAL:                -\n\nStreaming Replication status\nReplication Slots Enabled\nName    Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag  Flush Lag  Replay Lag  State      Sync State  Sync Priority  Replication Slot\n----    --------   ---------  ---------  ----------  ---------  ---------  ----------  -----      ----------  -------------  ----------------\ndemo-cnpg-2  <span class=\"token number\">0</span>/6000000  <span class=\"token number\">0</span>/6000000  <span class=\"token number\">0</span>/6000000  <span class=\"token number\">0</span>/6000000   00:00:00   00:00:00   00:00:00    streaming  async       <span class=\"token number\">0</span>              active\ndemo-cnpg-3  <span class=\"token number\">0</span>/6000000  <span class=\"token number\">0</span>/6000000  <span class=\"token number\">0</span>/6000000  <span class=\"token number\">0</span>/6000000   00:00:00   00:00:00   00:00:00    streaming  async       <span class=\"token number\">0</span>              active\n\nUnmanaged Replication Slot Status\nNo unmanaged replication slots found\n\nInstances status\nName    Database Size  Current LSN  Replication role  Status  QoS         Manager Version  Node\n----    -------------  -----------  ----------------  ------  ---         ---------------  ----\ndemo-cnpg-1  <span class=\"token number\">29</span> MB          <span class=\"token number\">0</span>/6000000    Primary           OK      BestEffort  <span class=\"token number\">1.19</span>.0           ip-10-1-10-111.eu-west-1.compute.internal\ndemo-cnpg-2  <span class=\"token number\">29</span> MB          <span class=\"token number\">0</span>/6000000    Standby <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span>   OK      BestEffort  <span class=\"token number\">1.19</span>.0           ip-10-1-12-144.eu-west-1.compute.internal\ndemo-cnpg-3  <span class=\"token number\">29</span> MB          <span class=\"token number\">0</span>/6000000    Standby <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span>   OK      BestEffort  <span class=\"token number\">1.19</span>.0           ip-10-1-11-78.eu-west-1.compute.internal</code></pre></div>\n<p>And there are more to discover like backup, monitoring, etc.</p>\n<h2 id=\"key-takeaways\" style=\"position:relative;\"><a href=\"#key-takeaways\" aria-label=\"key takeaways permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Key takeaways</h2>\n<p>When running PostgreSQL on Amazon EKS, it's important to ensure data persistence in Kubernetes. Tools like CloudNativePG help manage highly available PostgreSQL clusters with native streaming replication, ensuring data durability and seamless failover.</p>\n<p><strong>Stay tuned for next blogs in this¬†seriesüéâ</strong></p>\n<p><strong>References:</strong></p>\n<ul>\n<li><a href=\"https://dok.community/blog/the-future-of-data-on-kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">https://dok.community/blog/the-future-of-data-on-kubernetes</a></li>\n<li><a href=\"https://www.reddit.com/r/kubernetes/comments/1dp062w/are_you_running_stateful_data_workloads_or/?sort=old\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.reddit.com/r/kubernetes/comments/1dp062w/are_you_running_stateful_data_workloads_or/?sort=old</a></li>\n<li>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/99uSJXkKpeI?rel=0\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n</li>\n<li><a href=\"https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres\" target=\"_blank\" rel=\"noopener noreferrer\">https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres</a></li>\n<li><a href=\"https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">https://sealos.io/blog/to-run-or-not-to-run-a-database-on-kubernetes</a></li>\n<li><a href=\"https://rook.io/docs/rook/latest-release/Getting-Started/intro/\" target=\"_blank\" rel=\"noopener noreferrer\">https://rook.io/docs/rook/latest-release/Getting-Started/intro/</a></li>\n<li><a href=\"https://cloudnative-pg.io/documentation/1.22/\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloudnative-pg.io/documentation/1.22/</a></li>\n</ul>\n<p><strong>Thank You üñ§</strong></p>\n<br>\n<p><strong><em>Until next time, „Å§„Å•„Åè üéâ</em></strong></p>\n<blockquote>\n<p>üí° Thank you for Reading !! üôåüèªüòÅüìÉ, see you in the next blog.ü§ò  <strong><em>Until next time üéâ</em></strong></p>\n</blockquote>\n<p>üöÄ Thank you for sticking up till the end. If you have any questions/feedback regarding this blog feel free to connect with me:</p>\n<p><strong>‚ôªÔ∏è LinkedIn:</strong> <a href=\"https://www.linkedin.com/in/rajhi-saif/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.linkedin.com/in/rajhi-saif/</a></p>\n<p><strong>‚ôªÔ∏è X/Twitter:</strong> <a href=\"https://x.com/rajhisaifeddine\" target=\"_blank\" rel=\"noopener noreferrer\">https://x.com/rajhisaifeddine</a></p>\n<p><strong>The end ‚úåüèª</strong></p>\n<h1 align=\"center\">üî∞ Keep Learning !! Keep Sharing !! üî∞</h1>\n<p><strong>üìÖ Stay updated</strong></p>\n<p>Subscribe to our newsletter for more insights on AWS cloud computing and containers.</p>"}}},"staticQueryHashes":["1271460761","1321585977"],"slicesMap":{}}